[[> rsp:FormEntityRecord]]

{{#ifCond mode "!==" "new"}}
    {{#if node}}
        <bs-tab event-key="metadata" title="Metadata">
            <semantic-query query='SELECT ?entity ?entityFormRecordCreation ?actor ?actorFullName ?creationDateValue ?importFromExternalSource ?sourceURI WHERE {
                                    BIND(<{{node}}> AS ?entity)

                                    ?entity crm:P129i_is_subject_of ?entityFormRecord .
                                    ?entityFormRecord a crmdig:D1_Digital_Object .
                                    ?entityFormRecord crm:P2_has_type <http://www.researchspace.org/resource/system/vocab/resource_type/entity_form_record> . 
                                    ?entityFormRecord crmdig:L11i_was_output_of ?entityFormRecordCreation .
                                    ?entityFormRecordCreation crm:P2_has_type <http://www.researchspace.org/resource/system/vocab/resource_type/entity_form_record_creation> .

                                    ?entityFormRecordCreation crm:P14_carried_out_by ?actor .

                                    OPTIONAL {
                                        ?actor crm:P2_has_type <http://www.researchspace.org/resource/system/vocab/resource_type/user> .
                                        ?actor crm:P1_is_identified_by ?actorName .
                                        ?actorName a crm:E41_Appellation .
                                        ?actorName crm:P2_has_type <http://www.researchspace.org/resource/system/vocab/resource_type/primary_appellation> .
                                        ?actorName crm:P190_has_symbolic_content ?actorFullName .
                                    }

                                    ?entityFormRecordCreation crm:P4_has_time-span ?creationDate .
                                    ?creationDate crm:P82_at_some_time_within ?creationDateValue .

                                    OPTIONAL {
                                        ?entityFormRecordCreation crm:P134_continued ?importFromExternalSource .
                                        ?importFromExternalSource a crmdig:D12_Data_Transfer_Event .
                                        ?importFromExternalSource crm:P2_has_type <http://www.researchspace.org/resource/system/vocab/resource_type/import_from_external_source> .
                                        ?importFromExternalSource crmdig:L14_transferred ?sourceURI .
                                        ?sourceURI a crmdig:D1_Digital_Object .
                                        ?sourceURI crm:P2_has_type <http://www.researchspace.org/resource/system/vocab/digital_object_type/web_link> .
                                    }

                                } '
                                        
                            template='{{> template}}'>
                                
                            <template id='template'>
                                <div class="semantic-form-input-title">Record metadata</div>
                                <div class="table-expanded">
                                    <table class="table metadata-table">
                                        <tbody>
                                            <tr class="standard-row">
                                                <td class="table-title"><b>created</b></td>
                                                <td class="table-description">
                                                    {{dateTimeFormat bindings.0.creationDateValue.value "DD/MM/YYYY, h:mm a"}}
                                                </td>
                                            </tr>
                                            <tr class="standard-row">
                                                <td class="table-title"><b>created by</b></td>
                                                <td class="table-description">
                                                    <rs-icon icon-type="rounded" icon-name="account_box" class="table-icon" symbol="true"></rs-icon>
                                                    {{#if bindings.0.actorFullName.value}}
                                                        <semantic-link-container    uri="http://www.researchspace.org/resource/ThinkingFrames"
                                                                                    urlqueryparam-view='resource-editor' 
                                                                                    urlqueryparam-entity-type-config='http://www.researchspace.org/resource/system/resource_configurations_container/data/User'
                                                                                    urlqueryparam-resource-iri="{{bindings.0.actor.value}}"
                                                                                    urlqueryparam-mode='edit'>
                                                            <div style="text-decoration: underline; cursor: pointer;">{{bindings.0.actorFullName.value}}</div>
                                                        </semantic-link-container>
                                                    {{else}}
                                                        <mp-label iri='{{bindings.0.actor.value}}'></mp-label>
                                                    {{/if}}
                                                </td>
                                            </tr>
                                            {{#if bindings.0.importFromExternalSource.value}}
                                                <tr class="standard-row">
                                                    <td class="table-title"><b>imported from</b></td>
                                                    <td class="table-description">
                                                        <a class="text-link-action" target="_blank" href="{{bindings.0.sourceURI.value}}" title="{{bindings.0.sourceURI.value}}">{{bindings.0.sourceURI.value}}</a>
                                                    </td>
                                                </tr>
                                            {{/if}}
                                        </tbody>   
                                    </table>
                                </div>
                            </template>
            </semantic-query>

            [[#if imageOverlay]]
                <semantic-query  query='SELECT ?overlayImage ?modifiedByUser ?modifiedByUserFullName ?modifiedAtTime WHERE {
                                                    BIND(<{{node}}> AS ?overlayImage)

                                                    ?overlayImage a crmdig:D9_Data_Object .
                                                    ?overlayImage crmdig:L60i_is_documented_by ?digitizationProcess .
                                                    ?digitizationProcess a crmdig:D2_Digitization_Process .
                    
                                                    ?overlayImage <http://www.w3.org/ns/prov#generatedAtTime> ?modifiedAtTime .
                    
                                                    [[#if (hasPermission "forms:ldp:*")]]
                                                        ?overlayImage <http://www.w3.org/ns/prov#wasAttributedTo> ?modifiedByUser .
                                                    [[else]]
                                                        ?overlayImage <http://www.w3.org/ns/prov#wasAttributedTo> ?modifiedByUser .
                                                        FILTER(?modifiedByUser = <http://www.researchspace.org/resource/system/anonymousUser> )
                                                    [[/if]]

                                                    OPTIONAL {
                                                        ?modifiedByUser crm:P2_has_type <http://www.researchspace.org/resource/system/vocab/resource_type/user> .
                                                        ?modifiedByUser crm:P1_is_identified_by ?actorName .
                                                        ?actorName a crm:E41_Appellation .
                                                        ?actorName crm:P2_has_type <http://www.researchspace.org/resource/system/vocab/resource_type/primary_appellation> .
                                                        ?actorName crm:P190_has_symbolic_content ?modifiedByUserFullName .
                                                    }
                                                }'
                                            template='{{> template}}'
                                        >
                                            
                            <template id='template'>
                                <div>
                                    <div class="semantic-form-input-title">Image overlay metadata</div>
                                    <div class="table-expanded">
                                        <table class="table metadata-table">
                                            <tbody>
                                                <tr class="standard-row">
                                                    <td class="table-title"><b>created at</b></td>
                                                    <td class="table-description">
                                                        {{dateTimeFormat bindings.0.modifiedAtTime.value "DD/MM/YYYY, h:mm a"}}
                                                    </td>
                                                </tr>
                                                <tr class="standard-row">
                                                    <td class="table-title"><b>created by</b></td>
                                                    <td class="table-description">
                                                        <rs-icon icon-type="rounded" icon-name="account_box" class="table-icon" symbol="true"></rs-icon>
                                                        {{#if bindings.0.modifiedByUserFullName.value}}
                                                            <semantic-link-container    uri="http://www.researchspace.org/resource/ThinkingFrames"
                                                                                        urlqueryparam-view='resource-editor' 
                                                                                        urlqueryparam-entity-type-config='http://www.researchspace.org/resource/system/resource_configurations_container/data/User'
                                                                                        urlqueryparam-resource-iri="{{bindings.0.modifiedByUser.value}}"
                                                                                        urlqueryparam-mode='edit'>
                                                                <div style="text-decoration: underline; cursor: pointer;">{{bindings.0.modifiedByUserFullName.value}}</div>
                                                            </semantic-link-container>
                                                        {{else}}
                                                            <mp-label iri='{{bindings.0.modifiedByUser.value}}'></mp-label>
                                                        {{/if}}
                                                    </td>
                                                </tr>
                                            </tbody>   
                                        </table>
                                    </div>
                                </div>
                            </template>
                </semantic-query>
            [[/if]]
        </bs-tab>
    {{/if}}
{{/ifCond}}