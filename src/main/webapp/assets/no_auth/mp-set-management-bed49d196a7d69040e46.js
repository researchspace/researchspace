(window.webpackJsonp=window.webpackJsonp||[]).push([[212],{1285:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(11),i=r(1),a=r(1),s=r(7),o=r(34),l=r(56),d=r(162),p=r(116),u=r(1830),m=r(1214),c=r(327),h=r(1632),g=r(1633),S=r(1833),f=r(2253),v=r(2255),_=r(2256),y=r(2261);r(1427),t.CLASS_NAME="set-management";var C=function(e){function SetManagement(t,r){var n=e.call(this,t,r)||this;return n.cancellation=new o.Cancellation,n.onDragStart=function(){return n.setViewState({draggingItem:!0})},n.onDragEnd=function(){return n.setViewState({draggingItem:!1})},n.state=n.pendingState=f.ViewModel.loadState(n.props),n.model=new f.ViewModel({props:n.props,cancellation:n.cancellation,getState:function(){return n.pendingState},setState:function(e){return n.setViewState(e)},getContext:function(){return n.context.semanticContext},trigger:function(e,t){return n.trigger(e,t)}}),n}return n.__extends(SetManagement,e),SetManagement.prototype.getChildContext=function(){var t=e.prototype.getChildContext.call(this),r={"mp-set-management":{removeSet:this.model.removeSet,removeSetItem:this.model.removeSetItem,startRenamingSet:this.model.startRenamingSet,fetchSetItems:this.model.fetchSetItems}};return n.__assign(n.__assign({},t),r)},SetManagement.prototype.setState=function(t){e.prototype.setState.call(this,t)},SetManagement.prototype.setViewState=function(t){this.pendingState=n.__assign(n.__assign({},this.pendingState),t),e.prototype.setState.call(this,this.pendingState)},SetManagement.prototype.componentDidMount=function(){this.model.loadSets({keepItems:!1}),this.registerEventsListener()},SetManagement.prototype.registerEventsListener=function(){var e=this;this.cancellation.map(d.listen({eventType:d.BuiltInEvents.ComponentRefresh,target:this.props.id})).onValue((function(){e.setViewState({sets:void 0}),e.model.loadSets({keepItems:!1})}))},SetManagement.prototype.trigger=function(e,t){d.trigger({eventType:e,source:this.props.id,data:t})},SetManagement.prototype.componentWillUnmount=function(){this.cancellation.cancelAll()},SetManagement.prototype.render=function(){var e,r=s(((e={})[t.CLASS_NAME]=!0,e[t.CLASS_NAME+"--readonly"]=this.props.readonly,e[t.CLASS_NAME+"--list-view"]="list"===this.state.itemViewMode,e[t.CLASS_NAME+"--grid-view"]="grid"===this.state.itemViewMode,e[t.CLASS_NAME+"--only-opened-set"]=this.state.openedSet&&!f.ViewState.isSearchOpened(this.state),e)),n=this.renderView();return this.props.readonly?i.createElement("div",{className:r},i.createElement("div",{className:t.CLASS_NAME+"__children"},n)):this.renderDropArea(n,r)},SetManagement.prototype.renderDropArea=function(e,t){var r=this,n=f.ViewState.displayedSetIri(this.state);return i.createElement(h.DropArea,{className:t,shouldReactToDrag:function(){return!r.state.draggingItem},query:this.props.acceptResourceQuery,onDrop:function(e){r.model.onDropItemToSet(e,n)},dropMessage:n?i.createElement("span",null,'Drop items here to add to set "',i.createElement(m.ResourceLabel,{iri:n.value}),'"'):i.createElement("span",null,"Drop items here to add to the default set")},e)},SetManagement.prototype.renderView=function(){var e=this,r=this.props.readonly,n=this.state,s=n.itemViewMode,o=n.itemsOrdering,l=Boolean(this.state.openedSet),d=f.ViewState.isSearchOpened(this.state),p=f.ViewState.displayedSet(this.state),m=p&&p.items&&p.items.length>0,c=i.createElement("div",{className:t.CLASS_NAME+"__drop-area-children"},this.renderSearchAndFilters(),l?this.renderBackToContentsButton():void 0,d?this.renderSearchResults():l?this.renderOpenedSet():this.renderAllSets(),i.createElement(y.Footer,{baseClass:t.CLASS_NAME,readonly:r,itemViewMode:s,onModeChanged:this.model.setItemViewMode,canReorder:m,isReordering:Boolean(o),onPressReorder:function(){return e.setViewState({itemsOrdering:o?void 0:u.Ordering.empty})},onPressCreateNewSet:this.model.startCreatingNewSet,onPressReorderApply:this.model.applyItemsOrder}));return a.Children.toArray(c.props.children)},SetManagement.prototype.renderAllSets=function(){var e=this;if(this.state.loadingError)return i.createElement(p.ErrorNotification,{key:"sets-error",errorMessage:this.state.loadingError});var r=this.state,n=r.defaultSet,a=r.sets,s=r.itemsOrdering,o=a?a.filterNot((function(e){return e.iri.equals(n)})).map((function(r){return i.createElement(_.SetWithItems,{key:r.iri.value,baseClass:t.CLASS_NAME,set:r,showItems:!1,template:e.model.templateForKind,onOpen:function(t){return e.model.openAndLoadSet(t)},onDragStart:e.onDragStart,onDragEnd:e.onDragEnd,onEditCompleted:function(t){return e.model.onSetEditCompleted(r,t)}})})).toArray():[i.createElement(c.Spinner,{key:"sets-loading"})];return i.createElement("div",{key:"all-sets",className:t.CLASS_NAME+"__sets"},o,i.createElement(_.ItemsView,{key:"default-set-items",baseClass:t.CLASS_NAME,set:a?a.get(n.value):void 0,template:this.model.templateForKind,onDragStart:this.onDragStart,onDragEnd:this.onDragEnd,itemsOrdering:s,onOrderChanged:function(t){return e.setViewState({itemsOrdering:t})}}))},SetManagement.prototype.renderSearchAndFilters=function(){var e=this,r=this.state.search;return i.createElement(v.SearchAndFilters,{key:"search-and-filters",baseClass:t.CLASS_NAME,keywordFilter:this.props.keywordFilter,setIsOpen:Boolean(this.state.openedSet),minInputLength:this.model.minSearchTermLength(),filters:this.props.filters,searchText:r.searchText,filterValues:r.filterValues,onSearchTextChanged:function(t){e.model.onFilterChanged(!0,t,e.state.search.filterValues)},onFilterChanged:function(t){e.model.onFilterChanged(!1,e.state.search.searchText,t)}})},SetManagement.prototype.renderSearchResults=function(){return i.createElement("div",{key:"search-results",className:t.CLASS_NAME+"__search-results"},this.renderSearchResultsContent())},SetManagement.prototype.renderSearchResultsContent=function(){var e=this;return this.state.search.results?0===this.state.search.results.size?i.createElement("div",{className:t.CLASS_NAME+"__search-results-empty"},"No results found"):this.state.search.results.map((function(r){return i.createElement(_.SetWithItems,{key:r.iri.value,baseClass:t.CLASS_NAME,set:r,template:e.model.templateForKind,highlightedTerm:e.state.search.searchText,onOpen:function(t){return e.model.openAndLoadSet(t)},onDragStart:e.onDragStart,onDragEnd:e.onDragEnd,onEditCompleted:function(t){return e.model.onSetEditCompleted(r,t)}})})).toArray():this.state.search.error?i.createElement(p.ErrorNotification,{key:"search-error",errorMessage:this.state.search.error}):i.createElement(c.Spinner,{key:"search-loading"})},SetManagement.prototype.renderBackToContentsButton=function(){var e=this;return i.createElement("button",{className:t.CLASS_NAME+"__back-to-contents btn btn-success",onClick:function(){return e.setViewState({openedSet:void 0,search:{},itemsOrdering:void 0})}},i.createElement("span",{className:"fa fa-chevron-left"})," Back to contents")},SetManagement.prototype.renderOpenedSet=function(){var e=this,r=this.state,n=r.openedSet,a=r.itemsOrdering,s=r.sets,o=s?s.get(n.value):void 0;return i.createElement(_.OpenedSetView,{set:o,baseClass:t.CLASS_NAME,template:this.model.templateForKind,onDragStart:this.onDragStart,onDragEnd:this.onDragEnd,onEditCompleted:function(t){return e.model.onSetEditCompleted(o,t)},itemsOrdering:a,onOrderChanged:function(t){return e.setViewState({itemsOrdering:t})}})},SetManagement.defaultProps=S.ForAllProps,SetManagement.childContextTypes=n.__assign(n.__assign({},l.Component.childContextTypes),g.SetManagementContextTypes),SetManagement}(l.Component);t.SetManagement=C,t.default=C},1833:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(23);t.SetKind=n.Rdf.iri("http://www.researchspace.org/resource/system/Set");var i="\n  <div class='set-management__item-actions'>\n    <bs-dropdown-button pull-right=true bs-style='link' title=''\n                        id='set-actions-{{iri.value}}'>\n      <mp-set-management-action-remove-set-item>\n        <bs-menu-item event-key='remove'>Remove</bs-menu-item>\n      </mp-set-management-action-remove-set-item>\n    </bs-dropdown-button>\n  </div>\n",a="\n  <span style='display: flex;'>\n    <mp-label iri='{{iri.value}}' highlight='{{highlight}}'\n              highlight-props='{\"style\": {\"color\": \"#dc8a4b\"}}'\n              style='white-space: nowrap; overflow: hidden; text-overflow: ellipsis;'\n    ></mp-label>\n  </span>\n";t.GridTemplate="\n  <mp-resource-card iri='{{iri.value}}'>"+i+"</mp-resource-card>\n",t.SetListTemplate="\n  <div style='display: flex; align-items: center; justify-content: space-between;'>\n    <div style='overflow: hidden;'>\n      "+a+"\n    </div>\n    <div class='set-management__item-actions' style='margin-left: auto;'>\n      <bs-dropdown-button pull-right=true bs-style='link' title=''\n                          id='set-actions-{{iri.value}}'>\n        <mp-set-management-action-manage-set>\n          <bs-menu-item event-key='manage'>Manage set</bs-menu-item>\n        </mp-set-management-action-manage-set>\n        <mp-set-management-action-rename-set>\n          <bs-menu-item event-key='rename'>Rename set</bs-menu-item>\n        </mp-set-management-action-rename-set>\n        <mp-set-management-action-remove-set>\n          <bs-menu-item event-key='remove'>Remove set</bs-menu-item>\n        </mp-set-management-action-remove-set>\n      </bs-dropdown-button>\n    </div>\n  </div>\n",t.ItemListTemplate="\n  <div style='display: flex; align-items: center; justify-content: space-between;'>\n    <div style='overflow: hidden;'>\n      <mp-resource-link-container uri=\"{{iri.value}}\" draggable=false>\n        "+a+"\n      </mp-resource-link-container>\n    </div>\n    "+i+"\n  </div>\n",t.KeywordSearch={placeholder:"Search all...",placeholderInSet:"Search in the set...",queryPattern:'\n    ?itemHolder ?__preferredLabel__ ?itemLabel .\n    FILTER REGEX(STR(?itemLabel), "(.*?)?__token__", "i")'},t.MinSearchTermLength=3,t.SetItemsQuery="\nPREFIX ldp: <http://www.w3.org/ns/ldp#>\nPREFIX prov: <http://www.w3.org/ns/prov#>\nPREFIX platform: <http://www.researchspace.org/resource/system/>\nPREFIX bds: <http://www.bigdata.com/rdf/search#>\nSELECT ?item ?itemHolder ?parent ?kind WHERE {\n  {\n    FILTER(!(?__isSearch__)) .\n    ?__rootSet__ ldp:contains ?itemHolder .\n    BIND(?__rootSet__ as ?parent) .\n    OPTIONAL { ?itemHolder platform:setItem ?setItem }\n    BIND(COALESCE(?setItem, ?itemHolder) AS ?item) .\n  } UNION {\n    FILTER(?__isSearch__) .\n    ?__rootSet__ ldp:contains ?__setToSearch__ .\n    ?__setToSearch__ ldp:contains ?itemHolder.\n    BIND(?__setToSearch__ as ?parent) .\n    ?itemHolder platform:setItem ?item .\n    FILTER(?__filterPatterns__)\n  }\n\n  OPTIONAL {\n    ?itemHolder platform:setItemIndex ?i .\n  }\n  OPTIONAL {\n    ?itemHolder prov:generatedAtTime ?modificationDate .\n  }\n  BIND(COALESCE(?i, 0) AS ?index) .\n  OPTIONAL {\n    ?item a platform:Set .\n    BIND(platform:Set as ?type)\n  }\n  BIND(COALESCE(?type, platform:SetItem) AS ?kind) .\n} ORDER BY ?index DESC(?modificationDate)",t.SetItemsMetadataQuery="SELECT ?item WHERE {}",t.SetCountQuery="\nPREFIX ldp: <http://www.w3.org/ns/ldp#>\nSELECT ?set (COUNT(?item) as ?count) WHERE {\n  ?__rootSet__ ldp:contains ?set .\n  OPTIONAL { ?set ldp:contains ?item }\n} GROUP BY ?set",t.itemConfig=function itemConfig(e){switch(e.toString()){case t.SetKind.toString():return{isSet:!0,gridTemplate:t.SetListTemplate,listTemplate:t.SetListTemplate};case"<http://www.researchspace.org/resource/system/SetItem>":return{isSet:!1,gridTemplate:t.GridTemplate,listTemplate:t.ItemListTemplate};default:return}},t.AcceptResourceQuery="ASK {}",t.ForAllProps={setItemsQuery:t.SetItemsQuery,setItemsMetadataQuery:t.SetItemsMetadataQuery,setCountQuery:t.SetCountQuery,acceptResourceQuery:t.AcceptResourceQuery,keywordFilter:t.KeywordSearch,filters:[],defaultViewMode:"list",persistViewMode:!0}},2253:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n,i=r(11),a=r(43),s=r(19),o=r(23),l=r(1210),d=r(140),p=r(116),u=r(214),m=r(637),c=r(1833),h=r(2254),g=u.BrowserPersistence.adapter();!function(e){function displayedSetIri(e){return e.openedSet?e.openedSet:e.defaultSet?e.defaultSet:void 0}e.openedSet=function openedSet(e){return e.openedSet?e.sets.get(e.openedSet.value):void 0},e.displayedSetIri=displayedSetIri,e.displayedSet=function displayedSet(e){var t=displayedSetIri(e);return t&&e.sets?e.sets.get(t.value):void 0},e.isSearchOpened=function isSearchOpened(e){var t=e.search,r=t.quering,n=t.results,i=t.error;return r||n||i}}(n=t.ViewState||(t.ViewState={}));var S=function(){function ViewModel(e){!function bindAllMethods(e,t){for(var r in t.prototype)if(t.prototype.hasOwnProperty(r)){var n=t.prototype[r];"function"==typeof n&&(e[r]=n.bind(e))}}(this,ViewModel),this.props=e.props,this.getState=e.getState,this.setState=e.setState,this.getContext=e.getContext,this.trigger=e.trigger,this.cancellation=e.cancellation,this.loadingSets=this.cancellation.derive(),this.searching=this.cancellation.derive(),this.fetchingSetNameToRename=this.cancellation.derive()}return ViewModel.prototype.itemConfig=function(e){return this.props.itemConfig?this.props.itemConfig[e.toString()]:c.itemConfig(e)},ViewModel.prototype.templateForKind=function(e,t){var r=this.itemConfig(e),n=this.getState().itemViewMode;if("list"===n)return r&&r.listTemplate||(t?c.SetListTemplate:c.ItemListTemplate);if("grid"===n)return r&&r.gridTemplate||(t?c.SetListTemplate:c.GridTemplate);throw new Error("Unknown item view mode")},ViewModel.prototype.isSet=function(e){var t=this.itemConfig(e);return t&&t.isSet},ViewModel.prototype.minSearchTermLength=function(){var e=this.props.keywordFilter.minSearchTermLength;return void 0===e?c.MinSearchTermLength:e},ViewModel.prototype.rootSetIri=function(){return this.props.rootSetIri?s.constant(o.Rdf.iri(this.props.rootSetIri)):s.fromPromise(l.getUserSetRootContainerIri()).toProperty()},ViewModel.prototype.defaultSetIri=function(){return this.props.defaultSetIri?s.constant(o.Rdf.iri(this.props.defaultSetIri)):s.fromPromise(l.getUserDefaultSetIri()).toProperty()},ViewModel.localStorageId=function(e){var t=e.id;return"mp-set-management"+(t?"-"+t:"")},ViewModel.loadState=function(e){var t;if(e.persistViewMode){var r=g.get(ViewModel.localStorageId(e));"list"!==r.itemViewMode&&"grid"!==r.itemViewMode||(t=r.itemViewMode)}return{search:{},itemViewMode:t||e.defaultViewMode}},ViewModel.prototype.setItemViewMode=function(e){this.props.persistViewMode&&g.update(ViewModel.localStorageId(this.props),{itemViewMode:e}),this.setState({itemViewMode:e})},ViewModel.prototype.loadSets=function(e){var t=this,r=this.props,n=r.setItemsQuery,a=r.setItemsMetadataQuery,o=r.setCountQuery,l=this.getContext();this.loadingSets.cancelAll(),this.loadingSets=this.cancellation.derive(),this.setState({loadingSets:!0}),this.loadingSets.map(this.rootSetIri().flatMap((function(e){return s.combine([t.defaultSetIri(),h.searchForSetsAndItems({setItemsQuery:n,setItemsMetadataQuery:a,setCountQuery:o,context:l,rootSet:e,isSet:t.isSet})])}))).observe({value:function(r){var n=r[0],a=r[1],s=t.getState(),o=e.keepItems?function reuseOldSetItems(e,t){if(!t)return e;return e.map((function(e,r){var n=t.get(r);return n&&n.items&&!e.items?i.__assign(i.__assign({},e),{items:n.items,itemCount:n.itemCount}):e})).toOrderedMap()}(a,s.sets):a;o.has(n.value)||(console.warn("Default set "+n+" not found"),o=o.set(n.value,emptySet(n)));var l=s.openedSet&&o.has(s.openedSet.value)?s.openedSet:void 0;t.setState({loadingSets:!1,sets:o,defaultSet:n,openedSet:l});var d=l||n;t.loadSetItems(d,{forceReload:!e.keepItems}),d.equals(n)||t.loadSetItems(n,{forceReload:!e.keepItems})},error:function(e){return t.setState({loadingSets:!1,loadingError:e})}})},ViewModel.prototype.loadSetItems=function(e,t){var r=this;void 0===t&&(t={});var n=this.getState(),a=n.sets.get(e.value);a&&(a.items&&!t.forceReload||(this.setState({sets:n.sets.set(a.iri.value,i.__assign(i.__assign({},a),{isLoading:!0,loadingError:void 0}))}),this.loadingSets.map(h.fetchSetItems(this.props.setItemsQuery,this.props.setItemsMetadataQuery,this.getContext(),e,(function(e){return!r.isSet(e)}))).observe({value:function(t){return r.onSetItemsLoaded(e,t,void 0)},error:function(t){return r.onSetItemsLoaded(e,void 0,t)}})))},ViewModel.prototype.onSetItemsLoaded=function(e,t,r){var n=this.getState();this.setState({sets:n.sets.update(e.value,(function(n){var a=n.items,s=n.itemCount;return r||(s=(a=t.get(e.value)||[]).length),i.__assign(i.__assign({},n),{isLoading:!1,loadingError:r,items:a,itemCount:s})}))})},ViewModel.prototype.openAndLoadSet=function(e){var t=this.getState();t.openedSet&&t.openedSet.equals(e)||(this.loadSetItems(e),this.setState({openedSet:e,search:{},itemsOrdering:void 0}))},ViewModel.prototype.onDropItemToSet=function(e,t){var r=this;this.cancellation.map(l.getSetServiceForUser(this.getContext()).flatMap((function(r){return r.addToExistingSet(t,e)}))).observe({value:function(){t.equals(r.getState().defaultSet)?r.loadSets({keepItems:!1}):(r.trigger(m.SetManagementEvents.ItemAdded),r.loadSetItems(t,{forceReload:!0}))},error:function(e){p.addNotification({level:"error",message:"Error adding item to set"},e)}})},ViewModel.prototype.onFilterChanged=function(e,t,r){var n=this,a=this.cancellation.derive();this.searching.cancelAll(),this.searching=a;var o=this.getState(),l=i.__assign(i.__assign({},o.search),{searchText:t,filterValues:r}),d=t&&t.length>=this.minSearchTermLength(),p=r&&r.size>0;e&&d?(this.setState({search:i.__assign(i.__assign({},l),{quering:!0})}),a.map(s.later(300,{})).onValue((function(){n.startSearching(a,t,r)}))):d||p?(this.setState({search:i.__assign(i.__assign({},l),{quering:!0})}),this.startSearching(a,d?t:void 0,r)):(this.setState({search:i.__assign(i.__assign({},l),{quering:!1,results:void 0,error:void 0})}),this.trigger(m.SetManagementEvents.ItemsFiltered,{}))},ViewModel.prototype.startSearching=function(e,t,r){var n=this,a=this.props,s=a.setItemsQuery,o=a.setItemsMetadataQuery,l=a.setCountQuery,d=this.getState(),p=h.createFilterPatterns({setItemsQuery:this.props.setItemsQuery,searchPattern:this.props.keywordFilter.queryPattern,searchText:t,filterValues:r});e.map(this.rootSetIri().flatMap((function(e){return h.searchForSetsAndItems({setItemsQuery:s,setCountQuery:l,setItemsMetadataQuery:o,context:n.getContext(),rootSet:e,isSet:n.isSet,setToSearch:d.openedSet,filterPatterns:p})}))).map((function(e){return e.filter((function(e){return e.items&&e.items.length>0})).toMap()})).observe({value:function(e){n.setState({search:i.__assign(i.__assign({},d.search),{quering:!1,results:e})});var t=new Set;e.forEach((function(e){return e.items.forEach((function(e){var r=e.iri;return t.add(r.value)}))}));var r={iris:Array.from(t)};n.trigger(m.SetManagementEvents.ItemsFiltered,r)},error:function(e){return n.setState({search:i.__assign(i.__assign({},d.search),{quering:!1,error:e})})}})},ViewModel.prototype.startCreatingNewSet=function(){var e,t=i.__assign(i.__assign({},emptySet(o.Rdf.iri(""))),{editing:{type:h.EditType.Create,newName:"My New Set"}}),r=this.getState(),n=a.OrderedMap((e={},e[t.iri.value]=t,e)).concat(r.sets).toOrderedMap();this.setState({sets:n,openedSet:void 0,search:{}})},ViewModel.prototype.onSetEditCompleted=function(e,t){var r=this.getState(),n=e.editing;if(n&&n.type===h.EditType.Create)if(t)this.createNewSet(e.iri,t);else{var a=r.sets.delete(e.iri.value);this.setState({sets:a})}else if(n&&n.type===h.EditType.Rename)if(!n.fetchingName&&t&&t!==n.oldName)this.renameSet(e.iri,n.oldName,t);else{a=r.sets.update(e.iri.value,(function(e){return i.__assign(i.__assign({},e),{editing:void 0,newName:void 0})}));this.setState({sets:a})}},ViewModel.prototype.createNewSet=function(e,t){var r=this,n=this.getState().sets;this.setState({sets:n.update(e.value,(function(e){return i.__assign(i.__assign({},e),{editing:{type:h.EditType.ApplyingChanges}})}))}),this.cancellation.map(l.getSetServiceForUser(this.getContext()).flatMap((function(e){return e.createSet(t)}))).observe({value:function(){r.loadSets({keepItems:!0}),r.trigger(m.SetManagementEvents.SetAdded)},error:function(e){p.addNotification({level:"error",message:"Error creating new set '"+t},e)}})},ViewModel.prototype.renameSet=function(e,t,r){var n=this,a=this.getState().sets;this.setState({sets:a.update(e.value,(function(e){return i.__assign(i.__assign({},e),{editing:{type:h.EditType.ApplyingChanges}})}))}),this.cancellation.map(l.getSetServiceForUser(this.getContext()).flatMap((function(t){return t.renameResource(e,r)}))).observe({value:function(){n.loadSets({keepItems:!0}),n.trigger(m.SetManagementEvents.SetRenamed)},error:function(e){p.addNotification({level:"error",message:"Error renaming set '"+t+"' to '"+r+"'"},e)}})},ViewModel.prototype.removeSet=function(e){var t=this;this.cancellation.map(l.getSetServiceForUser(this.getContext()).flatMap((function(t){return t.deleteResource(e)}))).observe({value:function(){t.setState({openedSet:void 0}),t.loadSets({keepItems:!0}),t.trigger(m.SetManagementEvents.SetRemoved)},error:function(e){p.addNotification({level:"error",message:"Error removing set"},e)}})},ViewModel.prototype.removeSetItem=function(e,t){var r=this,n=e||this.getState().defaultSet;this.cancellation.map(l.getSetServiceForUser(this.getContext()).flatMap((function(){return new l.SetService(n.value).deleteResource(t)}))).observe({value:function(){e?r.loadSetItems(n,{forceReload:!0}):r.loadSets({keepItems:!1}),r.trigger(m.SetManagementEvents.ItemRemoved)},error:function(e){p.addNotification({level:"error",message:"Error removing set item"},e)}})},ViewModel.prototype.startRenamingSet=function(e){var t=this,r=this.getState();this.setState({search:{},sets:r.sets.update(e.value,(function(e){return!e||e.editing?e:i.__assign(i.__assign({},e),{editing:{type:h.EditType.Rename,fetchingName:!0}})}))});var n=this.getContext();this.fetchingSetNameToRename.cancelAll(),this.fetchingSetNameToRename=this.cancellation.derive(),this.fetchingSetNameToRename.map(d.getLabel(e,{context:n})).observe({value:function(r){var n=t.getState().sets;t.setState({sets:n.update(e.value,(function(e){if(!e||!e.editing)return e;var t=e.editing;return t.type===h.EditType.Rename&&t.fetchingName?i.__assign(i.__assign({},e),{editing:{type:h.EditType.Rename,oldName:r,newName:r}}):e}))})}})},ViewModel.prototype.applyItemsOrder=function(){var e=this,t=this.getState(),r=n.displayedSet(t);if(r){var s=t.itemsOrdering.apply(r.items);this.setState({itemsOrdering:void 0,sets:t.sets.update(r.iri.value,(function(e){return i.__assign(i.__assign({},e),{items:s,isLoading:!0})}))});var o=a.List(s.map((function(e){return{holder:e.itemHolder,item:e.iri}})));this.cancellation.map(l.getSetServiceForUser(this.getContext()).flatMap((function(e){return e.reorderItems(r.iri,o)}))).observe({value:function(){e.loadSetItems(r.iri,{forceReload:!0}),e.trigger(m.SetManagementEvents.ItemsReordered)},error:function(t){var n=e.getState().sets,a=n.get(r.iri.value);a&&a.isLoading&&e.setState({sets:n.set(a.iri.value,i.__assign(i.__assign({},a),{isLoading:!1}))}),p.addNotification({level:"error",message:"Error reordering set items"},t)}})}},ViewModel.prototype.fetchSetItems=function(e){var t=this;return h.fetchSetItems(this.props.setItemsQuery,this.props.setItemsMetadataQuery,this.getContext(),e,(function(e){return!t.isSet(e)})).map((function(t){return t.get(e.value)||[]}))},ViewModel}();function emptySet(e){return{iri:e,kind:c.SetKind,metadata:{}}}t.ViewModel=S,t.emptySet=emptySet},2254:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n,i,a,s,o,l=r(11),d=r(43),p=r(19),u=r(23),m=r(61),c=r(141),h=r(1833);function querySetItems(e,t,r,n,a){var s,o;try{var l=m.SparqlUtil.parseQuery(e),d=Boolean(a&&a.length>0);new m.PatternBinder(i.FilterPatterns,d?a:[]).sparqlQuery(l);var h=c.ConfigHolder.getUIConfig().labelPropertyPath;new m.PropertyPathBinder((s={},s[i.PreferredLabel]=h,s)).sparqlQuery(l);var g=m.SparqlClient.setBindings(l,((o={})[i.RootSet]=r,o[i.IsSearch]=u.Rdf.literal(d),o[i.SetToSearch]=n,o));return m.SparqlClient.select(g,{context:t})}catch(e){return console.error(e),p.constantError(e)}}function loadSetItemCounts(e,t,r){var n,i=m.SparqlUtil.parseQuery(e),a=m.SparqlClient.setBindings(i,((n={})[s.RootSet]=r,n));return m.SparqlClient.select(a,{context:t}).map((function(e){for(var t=e.results,r=new Map,n=0,i=t.bindings;n<i.length;n++){var a=i[n],s=a.set,o=a.count;if(s&&s.isIri()&&o&&o.isLiteral()){var l=Number(o.value);isNaN(l)||r.set(s.value,l)}}return r}))}function parseSetItems(e,t){for(var r=d.OrderedMap().asMutable(),n=0,i=e.results.bindings;n<i.length;n++){var a=i[n],s=a.item,o=a.kind,l=a.parent,p=a.itemHolder;if(s&&s.isIri()&&(p&&p.isIri()&&l&&l.isIri()&&t(o))){var u={iri:s,itemHolder:p,kind:o,metadata:{}},m=r.get(l.value)||d.OrderedMap();r.set(l.value,m.set(s.value,u))}}return r.asImmutable().map((function(e){return e.toArray()})).toOrderedMap()}function queryMetadata(e,t,r){var n=new Set,i=r.filter((function(e){var t=e.iri;return!n.has(t.value)&&(n.add(t.value),!0)})).map((function(e){var t,r=e.iri,n=e.kind;return(t={})[a.Item]=r,t[a.Kind]=n,t}));return 0===i.length?p.constant(new Map):m.SparqlClient.prepareQuery(e,i).flatMap((function(e){return m.SparqlClient.select(e,{context:t})})).map((function(e){for(var t=e.results,r=new Map,n=0,i=t.bindings;n<i.length;n++){var a=i[n],s=a.item;s&&s.isIri()&&r.set(s.value,a)}return r})).toProperty()}function mergeMetadata(e,t){return e.map((function(e){return l.__assign(l.__assign({},e),{metadata:t.get(e.iri.value)||{}})}))}!function(e){e[e.Create=1]="Create",e[e.Rename=2]="Rename",e[e.ApplyingChanges=3]="ApplyingChanges"}(t.EditType||(t.EditType={})),function(e){e.value=function value(e){return e.binding.value},e.label=function label(e){var t=e.binding.label;return t&&t.value}}(n=t.FilterValue||(t.FilterValue={})),function(e){e.RootSet="__rootSet__",e.IsSearch="__isSearch__",e.SetToSearch="__setToSearch__",e.FilterPatterns="__filterPatterns__",e.PreferredLabel="__preferredLabel__"}(i||(i={})),function(e){e.Item="item",e.Kind="kind"}(a||(a={})),function(e){e.RootSet="__rootSet__"}(s||(s={})),function(e){e.SelectedValue="__value__",e.InputText=/\?__token__/}(o||(o={})),t.searchForSetsAndItems=function searchForSetsAndItems(e){var t=e.setItemsQuery,r=e.setItemsMetadataQuery,n=e.setCountQuery,i=e.context,a=e.rootSet,s=e.isSet,o=e.setToSearch,m=e.filterPatterns,c=m&&m.length>0;return p.combine([querySetItems(t,i,a,o,m),c?p.constant(new Map):loadSetItemCounts(n,i,a)],(function(e,t){var n=function parseSets(e,t,r){for(var n=d.OrderedMap().asMutable(),i=0,a=e.results.bindings;i<a.length;i++){var s=a[i],o=s.item,l=s.kind,p=s.itemHolder;if(o&&o.isIri()&&t(l)){var u=r.get(o.value);n.set(o.value,{iri:o,kind:l,itemCount:u,itemHolder:p,metadata:{}})}}return n.asImmutable()}(e,s,t),a=parseSetItems(e,(function(e){return!s(e)})),o=a.reduce((function(e,t){return l.__spreadArrays(e,t)}),[]),p=a.map((function(e,t){return{iri:u.Rdf.iri(t),kind:h.SetKind}})),m=l.__spreadArrays(o,n.toArray(),p.toArray());return queryMetadata(r,i,m).map((function(e){return function combineItemsIntoSets(e,t,r){return d.OrderedMap().withMutations((function(n){e.forEach((function(e){var i=t.get(e.iri.value);n.set(e.iri.value,i?l.__assign(l.__assign({},e),{items:mergeMetadata(i,r)}):e)})),t.forEach((function(t,i){e.has(i)||n.set(i,{iri:u.Rdf.iri(i),kind:h.SetKind,items:mergeMetadata(t,r),itemCount:t.length,metadata:r.get(i)||{}})}))}))}(n,a,e)}))})).flatMap((function(e){return e})).toProperty()},t.fetchSetItems=function fetchSetItems(e,t,r,n,i,a,s){return querySetItems(e,r,n,a,s).map((function(e){return parseSetItems(e,i)})).flatMap((function(e){return queryMetadata(t,r,e.reduce((function(e,t){return l.__spreadArrays(e,t)}),[])).map((function(t){var r=new Map;return e.forEach((function(e,n){r.set(n,mergeMetadata(e,t))})),r}))}))},t.createFilterPatterns=function createFilterPatterns(e){var t=[],r=m.SparqlUtil.parseQuery(e.setItemsQuery);if(e.searchPattern&&e.searchText){var i=m.SparqlUtil.parsePatterns(e.searchPattern,r.prefixes),a=new m.TextBinder([{test:o.InputText,replace:e.searchText}]);i.forEach((function(e){return a.pattern(e)})),t.push.apply(t,i)}if(e.filterValues){var s=e.filterValues.map((function(e){var t,i=e.filter.queryPattern,a=m.SparqlUtil.parsePatterns(i,r.prefixes),s=new m.VariableBinder(((t={})[o.SelectedValue]=n.value(e),t));return a.forEach((function(e){return s.pattern(e)})),{type:"group",patterns:a}}));t.push({type:"union",patterns:s.toArray()})}return t}},2255:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(11),i=r(1),a=r(43),s=r(7),o=r(1601),l=function(e){function SearchAndFilters(){return null!==e&&e.apply(this,arguments)||this}return n.__extends(SearchAndFilters,e),SearchAndFilters.prototype.showAdditionalFilters=function(){return Boolean(this.props.filterValues)},SearchAndFilters.prototype.render=function(){var e,t=this,r=this.props,n=r.baseClass,a=r.minInputLength,o=r.searchText,l=r.filters;return i.createElement("div",{className:n+"__search-and-filters"},this.renderKeywordSearch(l.length>0),o&&o.length<a?i.createElement("div",{key:"search-message",className:n+"__search-message"},"Minimum length of search term is "+a+" characters."):void 0,i.createElement("div",{key:"filters-and-badges",className:s((e={},e[n+"__filters"]=!0,e[n+"__filters--hidden"]=!this.showAdditionalFilters(),e))},i.createElement("div",{key:"filters"},l.map((function(e,r){return t.renderFilter(e,r)})))))},SearchAndFilters.prototype.renderKeywordSearch=function(e){var t,r=this,n=this.props.baseClass,l=this.props.keywordFilter.placeholder,d=this.props.keywordFilter.placeholderInSet,p=void 0===d?l:d;return i.createElement("div",{key:"keyword-search",className:n+"__search"},i.createElement(o.ClearableInput,{className:n+"__search-input",value:this.props.searchText||"",placeholder:this.props.setIsOpen?p:l,onChange:function(e){return r.props.onSearchTextChanged(e.currentTarget.value)},onClear:function(){return r.props.onSearchTextChanged("")}}),i.createElement("button",{className:s((t={},t[n+"__show-filters"]=!0,t["btn btn-default"]=!0,t.active=this.showAdditionalFilters(),t)),"aria-pressed":this.showAdditionalFilters(),style:{display:e?void 0:"none"},onClick:function(){r.showAdditionalFilters()?r.props.onFilterChanged(void 0):r.props.onFilterChanged(a.List())}},i.createElement("span",{className:"fa fa-ellipsis-v",title:"Show additional filters"})))},SearchAndFilters.prototype.renderFilter=function(e,t){var r=this,n=this.props,s=n.baseClass,l=n.filterValues,d=void 0===l?a.List():l;return i.createElement("div",{key:t,className:s+"__filter"},i.createElement(o.AutoCompletionInput,{placeholder:e.placeholder,query:e.suggestionsQuery,defaultQuery:e.suggestionsQuery,minimumInput:this.props.minInputLength,value:d.filter((function(t){return t.filter===e})).map((function(e){return e.binding})).toArray(),multi:!0,actions:{onSelected:function(t){var n;if(t&&Array.isArray(t)){var i=(n=d.filter((function(t){return t.filter!==e})).toList()).push.apply(n,t.map((function(t){return{filter:e,binding:t}})));r.props.onFilterChanged(i)}}}}))},SearchAndFilters}(i.Component);t.SearchAndFilters=l},2256:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(11),i=r(1),a=r(20),s=r(2257),o=r(1830),l=r(328),d=r(116),p=r(327),u=r(630),m=r(2254),c=r(1633),h=function(e){function OpenedSetView(){return null!==e&&e.apply(this,arguments)||this}return n.__extends(OpenedSetView,e),OpenedSetView.prototype.getChildContext=function(){var e=this;return{"mp-set-management--set-view":{getCurrentSet:function(){return e.props.set.iri}}}},OpenedSetView.prototype.render=function(){var e=this.props.baseClass;return i.createElement("div",{className:e+"__opened-set"},i.createElement(S,n.__assign({},this.props,{className:e+"__open-set",icon:i.createElement("span",{className:"fa fa-folder-open"})})),i.createElement(v,n.__assign({key:"opened-set-items"},this.props)))},OpenedSetView.childContextTypes=c.SetViewContextTypes,OpenedSetView}(i.Component);t.OpenedSetView=h;var g=function(e){function SetWithItems(){var t=null!==e&&e.apply(this,arguments)||this;return t.handleOnClick=function(e){var r=a.findDOMNode(t).querySelector(".set-management__item-actions");r&&r.contains(e.target)||t.props.onOpen(t.props.set.iri)},t}return n.__extends(SetWithItems,e),SetWithItems.prototype.getChildContext=function(){var e=this;return{"mp-set-management--set-view":{getCurrentSet:function(){return e.props.set.iri}}}},SetWithItems.prototype.render=function(){var e=this.props,t=e.showItems,r=void 0===t||t,a=n.__rest(e,["showItems"]),s=a.baseClass,o=a.set,l=a.onEditCompleted;return i.createElement("li",{className:s+"__set"},i.createElement(S,n.__assign({},a,{className:s+"__set-caption",set:o,onCaptionClick:this.handleOnClick,onEditCompleted:l,icon:i.createElement("span",{className:r?"fa fa-folder-open":"fa fa-folder"})})),r?i.createElement(v,n.__assign({},a)):void 0)},SetWithItems.childContextTypes=c.SetViewContextTypes,SetWithItems}(i.Component);t.SetWithItems=g;var S=function(e){function SetCaption(){return null!==e&&e.apply(this,arguments)||this}return n.__extends(SetCaption,e),SetCaption.prototype.render=function(){var e=this.props,t=e.baseClass,r=e.className,n=e.set,a=e.icon,s=Boolean(n&&n.editing),o=i.createElement("div",{className:r,onClick:s?void 0:this.props.onCaptionClick},i.createElement("div",{className:t+"__set-icon"},a),this.renderName(n),n&&"number"==typeof n.itemCount?i.createElement("span",{className:t+"__set-item-count badge"},n.itemCount):void 0);return this.wrapDraggable(!s,o)},SetCaption.prototype.renderName=function(e){if(e){if(e.editing){var t=this.props.onEditCompleted;return i.createElement(f,{editing:e.editing,onEditCompleted:t})}var r=this.props.baseClass;return i.createElement(u.TemplateItem,{componentProps:{className:r+"__set-template"},template:{source:this.props.template(e.kind,!0),options:n.__assign(n.__assign({},e.metadata),{iri:e.iri,kind:e.kind,itemCount:e.itemCount,itemHolder:e.itemHolder})}})}return i.createElement(p.Spinner,null)},SetCaption.prototype.wrapDraggable=function(e,t){var r=this.props,n=r.set,a=r.onDragStart,s=r.onDragEnd;return n?e?i.createElement(l.Draggable,{iri:n.iri.value,onDragStart:a,onDragEnd:s},t):t:null},SetCaption}(i.Component),f=function(e){function EditableLabel(){var t=null!==e&&e.apply(this,arguments)||this;return t.onKeyDownWhileEditing=function(e){13===e.keyCode?(e.preventDefault(),t.props.onEditCompleted(e.currentTarget.value)):27===e.keyCode&&(e.preventDefault(),t.props.onEditCompleted(void 0))},t.onBlurWhileEditing=function(e){t.props.onEditCompleted(void 0)},t}return n.__extends(EditableLabel,e),EditableLabel.prototype.render=function(){var e=this.props,t=e.editing,r=(e.onEditCompleted,n.__rest(e,["editing","onEditCompleted"]));return t.type===m.EditType.ApplyingChanges||t.type===m.EditType.Rename&&t.fetchingName?i.createElement(p.Spinner,{spinnerDelay:0}):i.createElement("input",n.__assign({},r,{type:"text",autoFocus:!0,defaultValue:t.newName,ref:function(e){return e?e.setSelectionRange(0,e.value.length):null},onKeyDown:this.onKeyDownWhileEditing,onClick:function(e){return e.stopPropagation()},onBlur:this.onBlurWhileEditing}))},EditableLabel}(i.Component);t.EditableLabel=f;var v=function(e){function ItemsView(){return null!==e&&e.apply(this,arguments)||this}return n.__extends(ItemsView,e),ItemsView.prototype.getChildContext=function(){var e=this;return{"mp-set-management--set-view":{getCurrentSet:function(){return e.props.set.iri}}}},ItemsView.prototype.render=function(){return i.createElement("div",{className:this.props.baseClass+"__items-view"},this.renderItemsPane())},ItemsView.prototype.renderItemsPane=function(){var e=this,t=this.props,r=t.set,a=t.itemsOrdering,l=t.onOrderChanged;if(r&&r.loadingError)return[i.createElement(d.ErrorNotification,{key:"error",errorMessage:r.loadingError})];var u=r?r.items:void 0,m=u?u.map((function(t){return i.createElement(_,n.__assign({key:t.iri.value,item:t},e.props))})):void 0;return[!r||r.isLoading?i.createElement(p.Spinner,{key:"spinner"}):null,m?a?i.createElement(o.ReorderableList,{key:"items",className:this.props.baseClass+"__set-items",itemClass:this.props.baseClass+"__reordered-item",ordering:a,onOrderChanged:l},m):i.createElement(s.TransitionGroup,{key:"items",component:"ul",className:this.props.baseClass+"__set-items"},m.map((function(e){return i.createElement(s.CSSTransition,{key:e.key,classNames:"set-items-animation",timeout:{enter:800,exit:500}},e)}))):null]},ItemsView.childContextTypes=c.SetViewContextTypes,ItemsView}(i.Component);t.ItemsView=v;var _=function(e){function ItemView(){return null!==e&&e.apply(this,arguments)||this}return n.__extends(ItemView,e),ItemView.prototype.getChildContext=function(){var e=this;return{"mp-set-management--set-item-view":{getItem:function(){return e.props.item.itemHolder},getSetItemIri:function(){return e.props.item.iri}}}},ItemView.prototype.render=function(){var e=this.props,t=e.template,r=e.item,a=e.baseClass,s=e.onDragEnd,o=e.onDragStart,d=e.highlightedTerm;return i.createElement(l.Draggable,{key:r.iri.value,iri:r.iri.value,onDragStart:o,onDragEnd:s},i.createElement("li",{className:a+"__set-item",key:r.iri.value},i.createElement(u.TemplateItem,{template:{source:t(r.kind,!1),options:n.__assign(n.__assign({},r.metadata),{iri:r.iri,itemHolder:r.itemHolder,highlight:d})}})))},ItemView.childContextTypes=c.SetItemViewContextTypes,ItemView}(i.Component)},2261:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(11),i=r(1),a=r(7),s=function(e){function Footer(){return null!==e&&e.apply(this,arguments)||this}return n.__extends(Footer,e),Footer.prototype.render=function(){var e=this.props,t=e.baseClass,r=e.readonly,a=e.itemViewMode,s=e.onModeChanged,p=e.isReordering,u=e.canReorder;return i.createElement("div",{className:t+"__footer"},p&&u?i.createElement(l,n.__assign({},this.props)):null,i.createElement("div",{className:t+"__footer-buttons",role:"group"},i.createElement(d,{baseClass:t,mode:a,onModeChanged:s}),!r&&u?i.createElement(o,n.__assign({},this.props)):null,i.createElement("div",{className:t+"__footer-spacer"}),r?null:this.renderAddNewSetButton()))},Footer.prototype.renderAddNewSetButton=function(){return i.createElement("div",{className:"btn-group btn-group-xs",role:"group"},!this.props.readonly&&i.createElement("button",{type:"button",title:"Create new set",className:"btn btn-default",onClick:this.props.onPressCreateNewSet},i.createElement("i",{className:"fa fa-plus"}),"Â ",i.createElement("i",{className:"fa fa-folder fa-lg"})))},Footer}(i.Component);t.Footer=s;var o=function(e){function ReorderItemsButton(){return null!==e&&e.apply(this,arguments)||this}return n.__extends(ReorderItemsButton,e),ReorderItemsButton.prototype.render=function(){var e=this.props,t=e.baseClass,r=e.isReordering,n=e.onPressReorder;return i.createElement("div",{className:"btn-group btn-group-xs "+t+"__toggle-reorder-items",role:"group"},i.createElement("button",{type:"button",title:"Reorder items","aria-pressed":r,className:a({"btn btn-default":!0,active:r}),onClick:n},i.createElement("i",{className:"fa fa-lg fa-random"})))},ReorderItemsButton}(i.Component);t.ReorderItemsButton=o;var l=function(e){function ReorderConfirmation(){return null!==e&&e.apply(this,arguments)||this}return n.__extends(ReorderConfirmation,e),ReorderConfirmation.prototype.render=function(){var e=this.props,t=e.baseClass,r=e.onPressReorder,n=e.onPressReorderApply;return i.createElement("div",{className:t+"__footer-reorder-confirmation"},i.createElement("div",{className:t+"__footer-reorder-message"},"Drag items to reorder"),i.createElement("div",{className:t+"__footer-reorder-buttons"},i.createElement("button",{type:"button",title:"Cancel reordering items",className:"btn btn-xs btn-danger "+t+"__footer-reorder-cancel",onClick:r},"Cancel"),i.createElement("button",{type:"button",title:"Save items order",className:"btn btn-xs btn-success",onClick:n},"Save changes")))},ReorderConfirmation}(i.Component);t.ReorderConfirmation=l;var d=function(e){function ItemViewModeSwitch(){return null!==e&&e.apply(this,arguments)||this}return n.__extends(ItemViewModeSwitch,e),ItemViewModeSwitch.prototype.render=function(){var e=this.props.baseClass+"__item-view-mode btn-group btn-group-xs";return i.createElement("div",{className:e,role:"group"},this.renderModeButton("grid","Switch to grid view",i.createElement("span",{className:"fa fa-lg fa-th"})),this.renderModeButton("list","Switch to list view",i.createElement("span",{className:"fa fa-lg fa-th-list"})))},ItemViewModeSwitch.prototype.renderModeButton=function(e,t,r){var n=this,s=e===this.props.mode;return i.createElement("button",{key:e,type:"button",title:t,className:a({"btn btn-default":!0,active:s}),"aria-pressed":s,onClick:s?void 0:function(){return n.props.onModeChanged(e)}},r)},ItemViewModeSwitch}(i.Component);t.ItemViewModeSwitch=d}}]);
//# sourceMappingURL=mp-set-management-bed49d196a7d69040e46.js.map