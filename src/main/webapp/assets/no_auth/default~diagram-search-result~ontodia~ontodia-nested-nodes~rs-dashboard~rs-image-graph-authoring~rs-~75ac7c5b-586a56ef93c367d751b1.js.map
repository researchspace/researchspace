{"version":3,"sources":["webpack:///./src/main/web/ontodia/src/ontodia/viewUtils/events.ts","webpack:///./src/main/web/ontodia/src/ontodia/viewUtils/async.ts","webpack:///./src/main/web/ontodia/src/ontodia/diagram/elements.ts","webpack:///./src/main/web/ontodia/src/ontodia/diagram/geometry.ts","webpack:///./src/main/web/ontodia/src/ontodia/index.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/schema.ts","webpack:///./src/main/web/ontodia/src/ontodia/viewUtils/spinner.tsx","webpack:///./src/main/web/ontodia/src/ontodia/data/model.ts","webpack:///./src/main/web/ontodia/src/ontodia/viewUtils/collections.ts","webpack:///./src/main/web/ontodia/src/ontodia/diagram/view.ts","webpack:///./src/main/web/ontodia/src/ontodia/editor/authoringState.ts","webpack:///./src/main/web/ontodia/src/ontodia/diagram/commands.ts","webpack:///./src/main/web/ontodia/src/ontodia/diagram/paperArea.tsx","webpack:///./src/main/web/ontodia/src/ontodia/workspace/workspaceContext.ts","webpack:///./src/main/web/ontodia/src/ontodia/diagram/paper.tsx","webpack:///./src/main/web/ontodia/src/ontodia/diagram/history.ts","webpack:///./src/main/web/ontodia/src/ontodia/widgets/progressBar.tsx","webpack:///./src/main/web/ontodia/src/ontodia/widgets/listElementView.tsx","webpack:///./src/main/web/ontodia/src/ontodia/viewUtils/layout.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/utils.ts","webpack:///./src/main/web/ontodia/src/ontodia/viewUtils/react.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/sparql/blankNodes.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/sparql/sparqlModels.ts","webpack:///./src/main/web/ontodia/src/ontodia/editor/serializedDiagram.ts","webpack:///./src/main/web/ontodia/src/ontodia/editor/asyncModel.ts","webpack:///./src/main/web/ontodia/src/ontodia/workspace/draggableHandle.tsx","webpack:///./src/main/web/ontodia/src/ontodia/widgets/searchResults.tsx","webpack:///./src/main/web/ontodia/src/ontodia/customization/templates/index.ts","webpack:///./src/main/web/ontodia/src/ontodia/customization/templates/utils.ts","webpack:///./src/main/web/ontodia/src/ontodia/diagram/embeddedLayer.tsx","webpack:///./src/main/web/ontodia/src/ontodia/diagram/elementLayer.tsx","webpack:///./src/main/web/ontodia/src/ontodia/viewUtils/keyedObserver.ts","webpack:///./src/main/web/ontodia/src/ontodia/customization/defaultLinkStyles.ts","webpack:///./src/main/web/ontodia/src/ontodia/diagram/linkLayer.tsx","webpack:///./src/main/web/ontodia/src/ontodia/viewUtils/toSvg.ts","webpack:///./src/main/web/ontodia/src/ontodia/editor/authoredEntity.tsx","webpack:///./src/main/web/ontodia/src/ontodia/data/sparql/sparqlDataProviderSettings.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/sparql/turtle.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/sparql/graphBuilder.ts","webpack:///./src/main/web/ontodia/src/ontodia/diagram/model.ts","webpack:///./src/main/web/ontodia/src/ontodia/editor/editorController.tsx","webpack:///./src/main/web/ontodia/src/ontodia/widgets/connectionsMenu.tsx","webpack:///./src/main/web/ontodia/src/ontodia/widgets/instancesSearch.tsx","webpack:///./src/main/web/ontodia/src/ontodia/forms/linkTypeSelector.tsx","webpack:///./src/main/web/ontodia/src/ontodia/editor/validation.ts","webpack:///./src/main/web/ontodia/src/ontodia/workspace/toolbar.tsx","webpack:///./src/main/web/ontodia/src/ontodia/workspace/layout/layout.tsx","webpack:///./src/main/web/ontodia/src/ontodia/customization/templates/default.tsx","webpack:///./src/main/web/ontodia/src/ontodia/customization/templates/group.tsx","webpack:///./src/main/web/ontodia/src/ontodia/customization/defaultTypeStyles.ts","webpack:///./src/main/web/ontodia/images/icons/class.svg","webpack:///./src/main/web/ontodia/images/icons/objectProperty.svg","webpack:///./src/main/web/ontodia/images/icons/datatypeProperty.svg","webpack:///./src/main/web/ontodia/images/icons/person.svg","webpack:///./src/main/web/ontodia/images/icons/country.svg","webpack:///./src/main/web/ontodia/images/icons/organization.svg","webpack:///./src/main/web/ontodia/images/icons/location.svg","webpack:///./src/main/web/ontodia/images/icons/event.svg","webpack:///./src/main/web/ontodia/images/icons/object.svg","webpack:///./src/main/web/ontodia/src/ontodia/diagram/linkRouter.ts","webpack:///./src/main/web/ontodia/src/ontodia/customization/templates/standard.tsx","webpack:///./src/main/web/ontodia/src/ontodia/data/demo/provider.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/rdf/rdfDataProvider.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/rdf/rdfCacheableStore.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/rdf/rdfLoader.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/rdf/rdfCompositeParser.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/sparql/sparqlDataProvider.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/sparql/responseHandler.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/composite/composite.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/composite/mergeUtils.ts","webpack:///./src/main/web/ontodia/src/ontodia/data/sparql/sparqlGraphBuilder.ts","webpack:///./src/main/web/ontodia/src/ontodia/diagram/graph.ts","webpack:///./src/main/web/ontodia/src/ontodia/editor/dataFetcher.ts","webpack:///./src/main/web/ontodia/src/ontodia/widgets/dialog.tsx","webpack:///./src/main/web/ontodia/src/ontodia/forms/editEntityForm.tsx","webpack:///./src/main/web/ontodia/src/ontodia/forms/editElementTypeForm.tsx","webpack:///./src/main/web/ontodia/src/ontodia/forms/elementTypeSelector.tsx","webpack:///./src/main/web/ontodia/images/direction-in.png","webpack:///./src/main/web/ontodia/images/direction-out.png","webpack:///./src/main/web/ontodia/src/ontodia/forms/editLinkForm.tsx","webpack:///./src/main/web/ontodia/src/ontodia/forms/editLinkLabelForm.tsx","webpack:///./src/main/web/ontodia/src/ontodia/widgets/halo.tsx","webpack:///./src/main/web/ontodia/src/ontodia/widgets/haloLink.tsx","webpack:///./src/main/web/ontodia/src/ontodia/editor/linkStateWidget.tsx","webpack:///./src/main/web/ontodia/src/ontodia/editor/elementDecorator.tsx","webpack:///./src/main/web/ontodia/src/ontodia/editor/editLayer.tsx","webpack:///./src/main/web/ontodia/src/ontodia/workspace/workspace.ts","webpack:///./src/main/web/ontodia/src/ontodia/widgets/navigator.tsx","webpack:///./src/main/web/ontodia/src/ontodia/workspace/workspaceMarkup.tsx","webpack:///./src/main/web/ontodia/src/ontodia/widgets/classTree/index.ts","webpack:///./src/main/web/ontodia/src/ontodia/widgets/classTree/classTree.tsx","webpack:///./src/main/web/ontodia/src/ontodia/widgets/classTree/treeModel.ts","webpack:///./src/main/web/ontodia/src/ontodia/widgets/classTree/leaf.tsx","webpack:///./src/main/web/ontodia/images/tree/expand-toggle.svg","webpack:///./src/main/web/ontodia/images/tree/collapse-toggle.svg","webpack:///./src/main/web/ontodia/images/tree/leaf-default.svg","webpack:///./src/main/web/ontodia/images/tree/leaf-folder.svg","webpack:///./src/main/web/ontodia/src/ontodia/widgets/linksToolbox.tsx","webpack:///./src/main/web/ontodia/src/ontodia/workspace/accordion.tsx","webpack:///./src/main/web/ontodia/src/ontodia/workspace/accordionItem.tsx","webpack:///./src/main/web/ontodia/src/ontodia/internalApi.ts"],"names":["listeners","Map","on","eventKey","listener","this","get","set","push","onAny","anyListeners","off","index","indexOf","splice","offAny","trigger","data","anyListener","EventSource","unsubscribeByKey","onDispose","listen","events","listenAny","listenOnce","handled","onceListener","key","stopListening","unsubscribe","length","forEach","unsubscribers","clear","EventObserver","waitingTime","useAnimationFrame","runSynchronously","bind","schedule","scheduled","requestAnimationFrame","setTimeout","cancelScheduledTimeout","run","dispose","cancelAnimationFrame","clearTimeout","undefined","BatchingScheduler","onFetch","fetchingQueue","Object","create","keys","BufferingQueue","call","callback","Debouncer","source","aborted","signal","parent","addEventListener","event","handler","removeEventListener","abort","NEVER_SIGNAL","Cancellation","CancellationToken","throwIfAborted","ct","CancelledError","mapCancelledToNull","promise","then","value","err","Promise","reject","message","name","setPrototypeOf","prototype","Error","delay","timeout","resolve","animateInterval","duration","onProgress","cancellation","animationFrameId","start","animate","time","timePassed","easeInOutBezier","t","LinkDirection","props","links","id","position","size","fixedSize","expanded","group","elementState","temporary","_data","_position","_size","_fixedSize","_expanded","_group","_elementState","_temporary","setData","previous","updateLinksToReferByNewIri","element","oldIri","newIri","link","sourceId","targetId","setPosition","x","y","setSize","width","height","setFixedSize","isFixed","setExpanded","setGroup","setElementState","focus","requestGroupContent","addToFilter","linkType","direction","redraw","Element","label","count","_label","_count","setLabel","setCount","FatClassModel","RichProperty","typeId","vertices","linkState","_typeId","_sourceId","_targetId","_vertices","_linkState","linkTypeId","_labelBounds","setLabelBounds","_layoutOnly","setLayoutOnly","setVertices","isPolylineEqual","setLinkState","Link","linkMarkerKey","linkTypeIndex","startMarker","_isNew","_visible","_showLabel","_index","setIndex","setVisibility","params","visible","showLabel","preventLoading","Boolean","setIsNew","FatLinkType","vertexIndex","createAt","location","moveTo","remove","LinkVertex","Vector","Rect","boundsOf","intersectRayFromRectangleCenter","sourceRect","rayTarget","isTargetInsideRect","halfWidth","halfHeight","center","normalize","rightDirection","Math","abs","cross2D","sign","equals","a","b","sqrt","inverseLength","dot","x1","y1","x2","left","right","i","computePolyline","target","targetRect","startPoint","endPoint","computePolylineLength","polyline","reduce","acc","point","segmentLength","getPointAlongPolyline","offset","currentOffset","segment","newOffset","leftover","findNearestSegmentIndex","minDistance","Infinity","foundIndex","pivot","next","projectionToSegment","distanceToSegment","findElementAtPoint","elements","computeGrouping","grouping","children","PLACEHOLDER_ELEMENT_TYPE","PLACEHOLDER_LINK_TYPE","RdfNode","RdfIri","RdfLiteral","Triple","DIAGRAM_CONTEXT_URL_V1","RestoreGeometry","setElementExpanded","setElementData","setLinkData","ElementEvents","ElementTemplateState","LinkEvents","LinkTemplateState","Cell","EmbeddedLayer","DiagramModel","DiagramModelEvents","PointerEvent","PointerUpEvent","getContentFittingBox","ViewportOptions","ScaleOptions","AuthoredEntity","AuthoredEntityProps","AuthoredEntityContext","EditorOptions","EditorEvents","EditorController","PropertyEditor","PropertyEditorOptions","ValidationState","ElementValidation","LinkValidation","LayoutData","LayoutElement","LayoutLink","SerializedDiagram","convertToSerializedDiagram","makeSerializedDiagram","LinkTypeOptions","makeLayoutData","calculateLayout","removeOverlaps","CalculatedLayout","UnzippedCalculatedLayout","LayoutNode","applyLayout","forceLayout","PropertySuggestionParams","PropertyScore","DefaultToolbar","ToolbarProps","Workspace","WorkspaceProps","WorkspaceState","WorkspaceLanguage","renderTo","WorkspaceEventHandler","WorkspaceEventKey","DraggableHandle","InternalApi","GenerateID","forElement","ONTODIA_ID_URL_PREFIX","generate128BitID","forLink","TemplateProperties","PinnedProperties","CustomLabel","render","statusText","errorOccured","pathGeometry","className","transform","CLASS_NAME","d","fill","stroke","strokeWidth","strokeLinecap","style","dominantBaseline","React","Component","Spinner","min","HtmlSpinner","isIriProperty","e","type","isLiteralProperty","isArraysEqual","isLiteralsEqual","leftValue","rightValue","language","isIriPropertiesEqual","values","isLiteralPropertiesEqual","sameLink","hashLink","hash","hashFnv32a","sameElement","types","image","isPropertiesEqual","properties","hasOwnProperty","leftProperty","rightProperty","sources","objectValues","obj","items","isEmptyMap","map","cloneMap","clone","cloneSet","Set","item","add","getOrCreateArrayInMap","getOrCreateSetInMap","mapping","ordered","reorder","compare","sort","has","delete","OrderedMap","hashCode","find","p","pair","findIndex","HashMap","MoveDirection","makeMoveComparator","selected","moveDirection","orderMap","selectionIndexOffset","selectedItem","orderA","orderB","RenderingLayer","IriClickIntent","WidgetAttachment","model","options","disposed","colorSeed","_language","linkTemplates","routings","resolveTypeStyle","typeStyleResolver","DefaultTypeStyleBundle","resolveLinkTemplate","linkTemplateResolver","DefaultLinkTemplateBundle","resolveElementTemplate","elementTemplateResolver","DefaultElementTemplateBundle","initRouting","router","linkRouter","DefaultLinkRouter","updateRoutings","changeVertices","changePosition","changeSize","previousRoutes","computedRoutes","route","linkId","computed","sameRoutedLink","labelTextAnchor","getRoutings","getRouting","getLanguage","setLanguage","getLinkTemplates","performSyncUpdate","layer","FirstToUpdate","LastToUpdate","onIriClick","iri","clickIntent","persist","preventDefault","originalEvent","setPaperWidget","widget","attachment","widgets","setHandlerForNextDropOnPaper","dropOnPaperHandler","_tryHandleDropOnPaper","selectLabel","labels","targetLanguage","selectLabelLanguage","formatLabel","fallbackIri","resolveLabel","getUriLocalName","getElementTypeString","elementModel","createClass","join","getTypeStyle","color","customStyle","icon","hcl","h","getHueFromClasses","classes","seed","c","l","formatIri","isEncodedBlank","getElementTemplate","StandardTemplate","createLinkTemplate","existingTemplate","template","result","cloneDeep","fillLinkTemplateDefaults","defaultsDeep","markerTarget","renderLink","_highlighter","setHighlighter","_setElementDecorator","decorator","_elementDecorator","_decorateElement","defaultSelectLabel","texts","defaultValue","englishValue","text","DiagramView","AuthoringKind","isLinkConnectedToElement","elementIri","AuthoringState","state","ChangeElement","after","isNewElement","before","isDeletedElement","deleted","isElementWithModifiedIri","isNewLink","linkModel","isDeletedLink","empty","isEmpty","discard","discarded","newState","addElement","addLink","ChangeLink","changeElement","updatedLink","updateLinkToReferByNewIri","iriChanged","previousBefore","changeLink","deleteElement","deleteLink","deleteNewLinksConnectedToElements","elementIris","isUncertainLink","TemporaryState","title","capture","captureElementsAndLinks","hasChanges","filterOutUnchanged","filter","invoke","reverse","restoreCapturedLinkGeometry","Command","capturedInverse","changeLinkTypeVisibility","previousVisible","previousShowLabel","el","oldData","newData","PaperAreaContextTypes","ontodiaPaperArea","PropTypes","anything","context","pageSize","cssAnimations","delayedPaperAdjust","onOuterMount","outer","onAreaMount","area","onWidgetsMouseDown","stopPropagation","adjustPaper","clientWidth","clientHeight","adjusted","computeAdjustedBox","paddingX","ceil","paddingY","paperWidth","paperHeight","originX","originY","scrollBeforeUpdate","scrollLeft","top","scrollTop","setState","onPaperPointerDown","cell","movingState","HTMLElement","restore","view","batch","history","startBatch","button","startMoving","listenToPointerMove","onAreaPointerDown","onPointerMove","origin","panning","pageOffsetX","pageX","pageOffsetY","pageY","pointerMoved","panningScrollOrigin","sourceEvent","pointerX","pointerY","elementX","elementY","pageToPaperCoords","linkVertex","generateLinkVertex","stopListeningToPointerMove","document","restoreGeometry","triggerAsClick","registerToUndo","store","onWheel","shouldStartZooming","delta","max","deltaY","deltaX","zoomBy","onDragOver","dataTransfer","dropEffect","onDragDrop","paperPosition","clientToPaperCoords","onScroll","applyViewportState","targetState","scale","paperCenter","scrollCenterX","scrollCenterY","onZoom","renderedWidgets","step","maxFit","fitPadding","requireCtrl","getChildContext","paperArea","paperTransform","widgetProps","areaClass","hideScrollBars","componentClass","isAnimatingGraph","ref","onMouseDown","Paper","onPointerDown","linkLayerWidgets","w","OverLinks","cloneElement","elementLayerWidgets","OverElements","Viewport","componentDidMount","centerTo","delayedAdjust","PaperArea","updateWidgets","passive","componentDidUpdate","prevProps","prevState","scrollX","scrollY","componentWillUnmount","update","window","pageXOffset","pageYOffset","areaClientX","areaClientY","scrollablePaneToPaperCoords","paneX","paneY","clientToScrollablePaneCoords","paperToScrollablePaneCoords","paperX","paperY","getPaperSize","getAreaMetrics","offsetWidth","offsetHeight","bbox","bboxLeft","bboxTop","bboxRight","bboxBottom","bboxGrid","floor","gridWidth","gridHeight","ctrlKey","zoomOptions","shouldStartPanning","modifierPressed","shiftKey","altKey","movingElementOrigin","startPanning","clearTextSelectionInArea","getSelection","selection","removeAllRanges","getElement","segmentIndex","viewportState","setViewportState","centerContent","getScale","setScale","scaledBy","zoomIn","scaleOptions","zoomOut","zoomToFit","zoomToFitRect","viewPortState","makeToSVGOptions","svg","querySelector","paper","contentBox","getOverlayedElement","preserveDimensions","elementsToRemoveSelector","exportSVG","toSVG","exportPNG","toDataURL","animateGraph","setupChanges","changeGraphAnimationCount","onGraphAnimationEnd","change","newValue","forceUpdate","viewportAnimation","from","to","durationMs","awaitPromise","progress","childContextTypes","clientCoordsFor","container","targetBox","SVGElement","ownerSVGElement","getBoundingClientRect","containerBox","offsetX","offsetY","minX","minY","maxX","maxY","Number","isFinite","WorkspaceContextTypes","ontodiaWorkspace","findCell","currentTarget","marginLeft","marginTop","paddingRight","paddingBottom","htmlTransformStyle","TransformedSvgCanvas","overflow","LinkMarkers","LinkLayer","ElementLayer","bottom","hasAttribute","getAttribute","getLinkById","parentNode","scaledWidth","scaledHeight","svgStyle","SVG_STYLE","otherProps","totalPaneSize","pt","paneTopLeft","paneFromPaperCoords","paperFromPaneCoords","pane","action","effect","body","perform","skip","undoStack","redoStack","storeBatch","discardBatch","reset","undo","redo","execute","command","NonRememberingHistory","ProgressState","percent","showBar","loading","error","role","ProgressBar","onClick","disabled","highlightText","onDragStart","frontColor","classNames","localizedText","classesString","draggable","background","toString","highlightSubstring","ListElementView","startDragElements","iris","JSON","stringify","ex","DEFAULT_HIGHLIGHT_PROPS","substring","highlightProps","toLowerCase","end","highlighted","groupForceLayout","cola","Layout","nodes","avoidOverlaps","avoidOvelaps","convergenceThreshold","jaccardLinkLengths","preferredLinkLength","handleDisconnected","groupRemoveOverlaps","nodeRectangles","node","Rectangle","rectangle","translateToPositiveQuadrant","positions","padded","padding","biasFreePadded","nodeSizeMap","possibleCompression","maxSide","compressionX","compressionY","fittingBox","getContentFittingBoxForLayout","layoutFunction","fixedElements","selectedElements","nestedLayouts","keepAveragePosition","internalRecursion","elementsToProcess","nodeById","fixed","isSourceAndTargetVisible","sourceOf","targetOf","sourceNode","targetNode","calculateAveragePosition","xSum","ySum","uniformGrid","cellIndex","row","rows","cellSize","layout","nestedLayout","averagePosition","newAveragePosition","elementId","placeElementsAround","targetElement","prefferedLinksLength","targetElementBounds","targetPosition","outgoingAngle","averageSourcePosition","linkSource","vectorDiff","atan2","PI","elementsSteck","concat","placeElementFromSteck","curAngle","cos","sin","angle","pop","random32BitDigits","random","str","hval","charCodeAt","uri","lastIndexOf","startsWith","ENCODED_PREFIX","MAX_RECURSION_DEEP","BLANK_NODE_QUERY_PARAMETERS","BLANK_NODE_QUERY","queryFunction","queryDictionary","executeQuery","query","execution","response","processBlankBindings","blankBindings","settings","bindingGroupsById","binding","newInst","inst","relatedBlankBindnings","isRdfBlank","blankTrg","loadRelatedBlankNodes","blankChains","queryExecutor","recursionDeep","promises","chain","getQueryForChain","all","results","recursionPromises","loadedBlankBindings","bindings","relatedBlankBindings","loadedGroupsById","idsMap","getEncodedIdDictionary","mergedResults","createLabelForBlankBinding","encodedId","originalId","QueryExecutor","blankBinding","encodedId4LoadedElement","updateGroupIds","encodeId","blankBindingGroups","idDictionary","newId","bindingSet","encodedBinding","exceptInst","normalizedBindings","encodeURI","decodeId","clearId","parse","decodeURI","bn","blankType","class","blankNodes","sparqlDataProviderSettings","getQueryBlock","blankNode","maxIndex","trustableTrgProp","blankSrc","sourcePropId","blankSrcProp","instPostfix","targetPropId","blankTrgProp","defaultPrefix","getElementBindings","ids","blankElements","be","getLinkBinding","isRdfIri","getLinkCountBinding","dictionary","inCount","outCount","k","updateFilterResults","completeBindings","isBlankBinding","callBackQuery","processedBindings","elementInfo","elementIds","head","linksInfo","linkTypesOf","filterResponse","limit","elementTypeId","refElementId","refElementLinkId","getAllRelatedByLinkTypeElements","linkDirection","getAllRelatedElements","getElementTypes","isRdfLiteral","blank","serializedCellProperties","emptyDiagram","layoutData","linkTypeOptions","emptyLayoutData","cells","newCell","pick","property","diagram","modelElements","modelLinks","isFixedSize","isExpanded","groupByProperties","linkSettings","onLinkTypeVisibilityChanged","requestLinksOfType","linksOfType","graph","removeLink","_dataProvider","subscribeGraph","graphListener","setDataProvider","dataProvider","fetcher","DataFetcher","createNewDiagram","resetGraph","asyncSource","linkTypes","allLinkTypes","initLinkTypes","loadAndRenderLayout","markLinksAsLayoutOnly","catch","console","importLayout","setLinkSettings","loadingModels","preloadedElements","validateLinks","hideUnusedLinkTypes","requestingLinks","exportLayout","getElements","getLinks","getLinkTypes","addLinkType","setting","getLinkType","elementIrisToRequestData","usedLinkTypes","layoutElement","placeholderDataFromIri","layoutLink","createLinkType","requestingModels","requestElementData","allTypes","usedTypes","fetchElementData","linkTypeIds","onLinkInfoLoaded","classId","getClass","classModel","fetchClass","fetchLinkType","createProperty","propertyIri","getProperty","fetchPropertyType","allowToCreate","cancel","createLinks","targets","loadEmbeddedElements","groupBy","linkElements","res","memo","current","assign","AsyncModel","restoreLinksBetweenElements","isHoldingMouse","onHandleMouseDown","originPageX","originPageY","onMouseMove","onMouseUp","onBeginDragHandle","onDragHandle","removeListeners","onEndDragHandle","Direction","delayedChangeCells","startSelection","endSelection","onRootMount","root","renderResultItem","useDragAndDrop","canBeSelected","onItemClick","onChangeCells","newSelection","updateSelection","addKeyListener","onKeyUp","removeKeyListener","isPressedUp","keyCode","which","isPressDown","getNextIndex","Up","Down","startIndex","finishIndex","selectRange","focusOn","focusElement","onSelectionChanged","modelIndex","metaKey","tabIndex","onFocus","onBlur","componentWillReceiveProps","selectedModel","indexDelta","nextIndex","alreadyOnDiagram","scrollableContainer","parentElement","containerBounds","itemBounds","itemTop","itemBottom","defaultProps","SearchResults","getPropertyValues","nestedElementListener","layerOffsetLeft","layerOffsetTop","isApplyingParentMove","isNestedElementMoving","previousPositions","moveNestedElements","getNestedElements","newPosition","recomputeSelfBounds","onLayerInit","listenNestedElements","diffX","diffY","nestedElements","nestedElement","removeElements","removeElement","getOffset","calculateOffset","findParentElement","contextTypes","ElementContextTypes","RedrawFlags","redrawBatch","requests","forAll","None","delatedRedraw","sizeRequests","delayedUpdateSizes","onMount","requestRedraw","request","existing","redrawElements","elementStates","applyRedrawRequests","requestSizeUpdate","recomputeQueuedSizes","elementsToRender","overlayElement","OverlayedElement","onInvalidate","requestResize","elementDecorator","updateAll","requestRedrawAll","changedElement","RecomputeTemplate","RecomputeBlurred","invalidatesTemplate","changeData","changeExpanded","changeElementState","invalidatesRender","requestedRedraw","Render","ElementSize","nextProps","targetGroup","templateProps","computeTemplateProps","blurred","computeIsBlurred","ontodiaElement","rerenderTemplate","onInitResize","onResize","onResizeComplete","elementCard","htmlElement","firstElementChild","rect","resizeWidth","clientX","resizeHeight","clientY","minSize","onResetResize","initSize","parseInt","slice","onDoubleClick","TemplatedElement","typesObserver","observeElementTypes","propertiesObserver","observeProperties","observeTypes","shouldComponentUpdate","observe","templateClass","cachedTemplateClass","cachedTemplateProps","createElement","computeStyleFor","propsAsList","computePropertyTable","propTable","aLabel","bLabel","localeCompare","iconUrl","imgUrl","highlighter","subscribe","observedKeys","newObservedKeys","KeyedObserver","observeLinkTypes","LINK_SHOW_IRI","attrs","LINK_SUB_CLASS_OF","connection","LINK_DOMAIN","LINK_RANGE","LINK_TYPE_OF","UpdateRequest","delayedUpdate","updateState","Partial","scheduledToUpdate","scheduleUpdateAll","All","performUpdate","computeDeepNestedElements","groupId","deepChildren","collectNestedItems","parentId","sourceGroup","scheduleUpdateElementLinks","scheduleUpdateLink","updateChangedRoutes","changed","routing","newRoutes","changedLinks","elementEvent","linkEvent","changeLayoutOnly","changeLinkState","linkTypeEvent","changeLabel","changeVisibility","popShouldUpdatePredicate","shouldUpdate","LinkView","LINK_CLASS","TEMPORARY_LABEL_LINES","onRemoveLinkVertex","vertex","onBoundsUpdate","newBounds","grabLinkTemplate","nextState","verticesDefinedByUser","path","pathAttributes","getPathAttributes","connectionAttributes","defaultStrokeDasharray","layoutOnly","strokeDasharray","isBlurred","markerStart","typeIndex","markerEnd","renderLabels","renderVertices","cx","cy","r","VertexTools","vertexRadius","onRemove","computeLinkLabels","labelStyle","labelTexts","attributes","getLabelTextAttributes","getLabelRectAttributes","textAnchor","polylineLength","groupKey","round","line","LinkLabel","fontFamily","fontSize","fontWeight","shouldUpdateBounds","onTextMount","rectX","rectY","dy","getLabelRectangle","xOffset","recomputeBounds","bounds","getBBox","onRemoveVertex","markers","markerSource","LinkMarker","isStartMarker","onMarkerMount","marker","setAttribute","createElementNS","appendChild","clonePaperSvg","elementSizePadding","svgClone","cloneNode","removeAttribute","viewport","findViewport","child","firstChild","SVGGElement","nextSibling","imageBounds","modelId","overlayedView","elementRoot","overlayedViewContent","newRoot","clonedNodes","querySelectorAll","foreachNode","img","exportKey","uniqueId","paddedWidth","paddedHeight","viewBox","images","exportImageAsDataUri","dataUri","src","warn","defs","extractStylesheets","textContent","insertBefore","styleSheets","styleSheet","ownerNode","styleText","styleSheetURL","HTMLLinkElement","href","Request","url","fetch","ok","HTMLStyleElement","innerHTML","baseURI","embedExternalResources","baseUrl","styles","extractUrlRegex","urls","m","exec","lastIndex","urlStr","includes","resourceUrl","endsWith","exportAsDataUri","URL","resources","s","replace","original","blob","reader","FileReader","onload","readAsDataURL","nodeList","XMLSerializer","serializeToString","loadImage","Image","onerror","ev","fitRectKeepingAspectRatio","sourceWidth","sourceHeight","targetWidth","targetHeight","sourceAspectRatio","mimeType","convertImagesToDataUris","svgBox","containerSize","fallbackContainerSize","itemSize","maxResolutionScale","resolutionScale","computeAutofit","fit","innerSize","outerSize","svgString","createCanvas","canvasWidth","canvasHeight","backgroundColor","cnv","cnt","getContext","fillStyle","fillRect","canvas","encodeURIComponent","drawImage","quality","dataURLToBlob","dataURL","contentType","parts","split","raw","decodeURIComponent","Blob","rawLength","atob","uInt8Array","Uint8Array","queryCancellation","onChangeAuthoringState","editor","authoringState","queryAllowedActions","onEdit","showEditEntityForm","onDelete","deleteEntity","metadataApi","canEdit","canDelete","queryCanEdit","queryCanDelete","canEditElement","canDeleteElement","renderTemplate","editedIri","RDFSettings","linkConfigurations","openWorldLinks","propertyConfigurations","openWorldProperties","linksInfoQuery","schemaLabelProperty","dataLabelProperty","fullTextSearch","prefix","queryPattern","classTreeQuery","classInfoQuery","linkTypesQuery","linkTypesPattern","linkTypesInfoQuery","propertyInfoQuery","elementInfoQuery","imageQueryPattern","linkTypesOfQuery","linkTypesStatisticsQuery","filterRefElementLinkPattern","filterTypePattern","filterAdditionalRestriction","filterElementInfoPattern","WikidataSettings","OWLRDFSSettingsOverride","extractLabel","OWLRDFSSettings","OWLStatsSettings","DBPediaSettings","n3toRdfNode","entity","N3","Util","isLiteral","getLiteralValue","datatype","getLiteralType","getLiteralLanguage","parseTurtleText","turtleText","triples","Parser","triple","subject","predicate","object","createGraph","elementsInfo","makeLayout","getGraphFromRDFGraph","getGraphFromTurtleGraph","makeGraphItems","elementsIds","grid","layoutElementsMap","keyBy","GraphBuilder","Graph","getLink","findLink","reorderElements","elementIriOrModel","existingLink","classIri","addClass","linkTypeIri","propertyTypeIri","addProperty","triggerChangeGroupContent","createTemporaryElement","connectedLinks","DialogTypes","_authoringState","_validationState","_temporaryState","_selection","activeElement","localName","removeSelectedElements","validationState","validationApi","changedElements","changedElementsToValidate","validateElements","ElementDecorator","_initializePaperComponents","onPaperPointerUp","onCellsChanged","loadGroupContent","requestedGroupContent","setSpinner","LinkStateWidget","disableHalo","configureHalo","_metadataApi","setMetadataApi","setAuthoringState","updateAuthoringState","setValidationState","setTemporaryState","setSelection","cancelSelection","itemsToRemove","removeItems","deletedElementIris","discardChange","dialogTarget","dialogType","EditEntityForm","hideDialog","blur","LoadingWidget","spinnerProps","Key","bringSelectedElementsToFront","renderDefaultHalo","isOpened","ToEnd","halo","Halo","onExpand","navigationMenuOpened","ConnectionsMenu","onToggleNavigationMenu","showConnectionsMenu","onAddToFilter","onEstablishNewLink","startEditing","mode","EditLayerMode","establishLink","onFollowLink","JumpToEntity","HaloLink","showEditLinkForm","onSourceMove","moveLinkSource","onTargetMove","moveLinkTarget","onEditLabel","showEditLinkLabelForm","onClose","content","onAddElements","onAddElementsInConnectionMenu","suggestProperties","showDialog","modelToEdit","propertyEditor","onSubmit","changeEntityData","relatedEvent","onCancel","elementData","onApply","showEditElementTypeForm","targetIsNew","EditEntityTypeForm","removeTemporaryElement","removeTemporaryLink","EditElementTypeForm","isNew","onChangeElement","temporaryState","onChangeLink","newLink","makeLinkWithDirection","createNewLink","linkData","caption","EditLinkForm","onChange","EditLinkLabelForm","setLinkLabel","calculatePosition","dialog","Dialog","isTemporaryElement","isTemporaryLink","resetTemporaryState","dragged","placedElements","placeElements","isFirst","irisToLoad","elem","models","createNewEntity","targetIri","linksToRemove","base","addedLink","newSource","newTarget","editLayer","EditLayer","onFinishEditing","areaMetrics","paneWidth","paneHeight","ALL_RELATED_ELEMENTS_LINK","linkTypesListener","loadingState","none","addSelectedElements","selectedObjects","addedElementsIris","linkDataChunk","onExpandLink","objects","loadObjects","triggerWorkspaceEvent","connectionsExpandLink","onMoveToFilter","loadLinks","resubscribeOnLinkTypeEvents","linkTypesOfElement","countMap","completed","connectionsLoadLinks","presentOnDiagram","connectionsLoadElements","connectionsData","objectsData","ConnectionsMenuMarkup","onPressAddSelected","propertySuggestionCall","onChangeFilter","filterKey","getTitle","panel","onCollapseLink","getBreadCrumbs","getBody","ObjectsPanel","ConnectionsList","sortMode","onSortChange","renderSortSwitch","checked","htmlFor","renderSortSwitches","placeholder","updateScores","lang","token","trim","scores","compareLinks","aText","bText","compareLinksByWeight","aWeight","score","bWeight","getProbableLinks","isSmartMode","getViews","notSure","views","addView","postfix","LinkInPopupMenu","probability","newProps","viewList","probableLinks","probableViews","allRelatedElements","probablePart","expectedCount","evt","fullText","textLine","directionName","onSelectAll","allNonPresentedAreSelected","selectNonPresented","counter","activeObjCount","countString","wrongNodes","wrongNodesString","MAX_LINK_COUNT","wrongNodesCount","wrongNodesTitle","getFilteredObjects","getItems","list","added","isAllSelected","nonPresented","active","allSelected","DirectionInImage","DirectionOutImage","resultId","progressState","quering","searchTerm","inputText","criteria","renderCriteria","submitCriteriaUpdate","display","moreItemsAvailable","queryItems","criterions","elementType","classInfo","classLabel","renderRemoveCriterionButtons","onCriteriaChanged","refElement","elementLabel","refElementLink","linkTypeLabel","languageChanged","currentRequest","languageCode","loadMoreItems","createRequest","processFilterData","searchQueryItem","requestedAdditionalItems","existingIris","InstancesSearch","onChangeType","fatLinkType","originalLink","originalDirection","renderPossibleLinkType","linkValue","sourceLabel","targetLabel","in","fatLinkTypes","fetchPossibleLinkTypes","possibleLinkTypes","makeLinkTypeComparatorByLabelAndDirection","labelA","labelB","labelCompareResult","out","listenToLinkLabels","LinkTypeSelector","validateLinkType","currentLink","allowChange","some","processValidationResult","previousElement","previousLink","allErrors","elementErrors","linkErrors","outboundLinks","errors","isValid","createMutable","emptyElement","emptyLink","previousAuthoring","currentAuthoring","toValidate","cancellationToken","previousState","validate","loadingElement","previousElementState","previousLinkState","onChangeLanguage","onExportSVG","onExportPNG","renderSaveDiagramButton","onSaveDiagram","canSaveDiagram","renderPersistAuthoredChangesButton","onPersistChanges","canPersistChanges","renderLanguages","selectedLanguage","languages","code","onClearAll","onForceLayout","onZoomIn","onZoomOut","onZoomToFit","onPrint","WorkspaceLayoutType","renderAccordion","animationDuration","_onStartResize","_onResize","dockSide","undocked","DockSide","Left","Right","collapsedSize","AccordionItem","heading","defaultSize","defaultCollapsed","renderLayout","Accordion","onStartResize","Row","Column","Children","only","WorkspaceLayout","expander","renderPropertyTable","borderColor","prop","DefaultElementTemplate","CLASS","GroupTemplate","classIcon","objectPropertyIcon","datatypePropertyIcon","personIcon","countryIcon","organizationIcon","locationIcon","eventIcon","objectIcon","gap","routeFeedbackSiblingLinks","routeNormalSiblingLinks","sibling","hasUserPlacedVertices","sourceCenter","centerOfElement","targetCenter","midPoint","siblings","indexModifier","siblingIndex","offsetDirection","getLabelAlignment","connectionDirection","siblingCount","absoluteAngle","isTop","isBottom","firstOuter","secondOuter","getLabel","leftStripeColor","pinnedProperties","findPinnedProperties","borderLeftColor","renderThumbnail","getTypesLabel","renderProperties","renderPhoto","renderIri","inAuthoringMode","renderActions","templateState","pinned","filtered","propertyValues","finalIri","typeLabel","charAt","toUpperCase","allClasses","allElements","allLinks","simulateNetwork","cloned","log","classTree","classIds","cl","linkTypesInfo","counts","linkCount","isSource","each","filteredLinks","nodeId","linkedElementId","linkedElement","DemoDataProvider","PREFIX_FACTORIES","RDF","prefixFactory","RDFS","FOAF","XSD","OWL","parser","RDFCompositeParser","parsers","rdfStorage","RDFCacheableStore","acceptBlankNodes","rdfLoader","RDFLoader","proxy","dataFetching","parsePromises","datum","fileName","rdfGraph","initStatement","addGraph","waitInitCompleted","rdfClassesQuery","match","owlClassesQuery","fromRDFTypesQuery","subClassesQuery","rdfClassesGraph","owlClassesGraph","rdfTypesGraph","subClassesGraph","rdfClasses","toArray","owlClasses","rdfTypes","subClasses","classIris","clazz","interfaceName","nominalValue","parents","subClassIRI","classIRI","isNamedNode","firstLevel","labelQueries","classElement","createEmptyClass","getLabels","parentIri","propertyInfo","propertyInfoResult","queries","propertyIds","propId","checkElement","isExists","fetchIfNecessary","fetchedModels","getTypeCount","cm","lt","rdfLinksQueries","owlLinksQueries","rdfLinks","owlLinks","mapLinkTriple","linkTypePromises","linkTriple","elementInfoResult","getElementInfo","statementPromises","exists","statements","matchAll","statement","tripple","linkMap","incomingElementsTriples","incomingElements","outgoingElementsTriples","outElements","limitCallback","offsetIndex","limitIndex","elementsPromise","filterByTypeId","filterByRefAndLink","filterByRef","getAllElements","filteredElements","filterByKey","elementTriples","refEl","refLink","incomingTriples","inRelations","outgoingTriples","outRelations","promices","objectIsLiteral","isLabel","isLabelType","acceptableKey","downloadElement","shortInfo","getTypes","getProps","labelTriples","propsGraph","statemet","typeTriples","RDFDataProvider","lastSymbol","_prefix","predicateIri","isLabelIri","LABEL_URIS","toLocaleLowerCase","looksLikeLabel","LABEL_POSTFIXES","array","checkingElementMap","labelsMap","elementTypes","createStore","prefs","enrichMaps","_getLabels","slowQueries","multipleMatch","combineGraphs","newGraph","index1","index2","typeInstances","typeInstMap","instTriple","graphs","_graph","DEFAULT_PROXY","parameters","fetchingFileCatche","parseData","sharpIndex","fileUrl","substr","typePointer","mimeTypes","parserMap","recursivePart","acceptType","fetchFile","method","credentials","cache","headers","Accept","workaroundForRDFXmlParser","POSTFIX_TO_MIME","xml","rdf","owl","nttl","jsonld","rj","ttl","nt","nq","tryToGuessMimeType","mimeTypeIndex","getMimeTypeByFileName","recursion","stack","bodyToParse","SparqlQueryMethod","linkByPredicate","linkById","propertyByPredicate","isDirectLink","isDirectProperty","resolveTemplate","executeSparqlQuery","getClassTree","prepareLabels","attachLabels","flattenClassTree","escapeIri","getPropertyInfo","getClassInfo","nonBlankResources","BlankNodes","blankNodeResponse","formatPropertyInfo","executeSparqlConstruct","queryManyElementTypes","triplesToElementBinding","bindingsWithBlanks","prependAdditionalBindings","getElementsInfo","elementModels","prepareImages","fetchImages","imagePropertyUris","attachImages","typesString","enrichElementsWithImages","formatLinkLinks","vars","getLinksInfo","getLinksTypesOf","formatLinkUnion","usePredicatePart","unionParts","linkTypeBindings","getLinksTypeIds","navigateElementFilterOut","navigateElementFilterIn","foundLinkStats","linkConfig","linkConfigurationOut","linkConfigurationIn","formatLinkPath","domain","commaSeparatedDomains","restrictionOut","restrictionIn","statsQuery","linkStats","getLinkStatistics","baseParams","querySingleElementTypes","blankFiltration","getFilteredData","filterQuery","createFilterQuery","blankQuery","outerProjection","innerProjection","refQueryPart","refQueryTypes","createRefQueryPart","elementTypePart","elementTypeIri","textSearchPart","sparqlExtractLabel","queryMethod","GET","endpointUrl","refElementIRI","refLinkType","linkPattern","bindType","blankFilter","resultPattern","refElementIri","linkIri","outElementVar","inElementVar","bindDirection","fixedIri","hasDirectLink","boundedDirection","hasDirectProperty","propType","formatted","formatPropertyPath","blankResponse","fetchLabels","replaceKey","replaceValue","RegExp","endpoint","appendQueryParams","json","queryParams","initialSeparator","queryInternal","SparqlDataProvider","LABEL_URI","EMPTY_MAP","mapPropertiesByConfig","modelTypes","mapped","typeMatchesDomain","matchesDomainForLink","predicates","linkByPredicateType","hasMatch","matched","test","config","mergeProperties","propValue","every","getLocalizedString","isLocalizedEqual","enrichElement","sInst","appendLabel","newLabel","getInstCount","instcount","getPropertyModel","getLinkCount","sLinkType","emptyElementInfo","getLinkTypeInfo","sLinkInfo","treeNodes","createClassMap","createEmptyModel","allNodes","withoutCycles","breakCyclesAndCalculateCounts","tree","visiting","reduceChildren","childCount","leafs","visitClasses","instanceCount","classesList","sProperty","sPropertyTypeId","linkTypesMap","sLink","sInstTypeId","convertedResponse","trippleId","createAndPushBinding","instancesMap","respEl","sparqlLinks","linkConfigs","mappedModel","linkArray","mappedLinkType","sourceTypes","resultTypes","outPredicates","inPredicates","classAll","targetTypes","additional","dataProviders","mergeMode","dpCounter","dp","isDefinition","definition","fetchSequentially","mergeClassTree","mergePropertyInfo","queueProcessResults","previousResult","mergeClassInfo","mergeLinkTypesInfo","mergeLinkTypes","mergeElementInfo","mergeLinksInfo","mergeLinkTypesOf","mergeLinkElements","mergeFilter","processResults","responsePromise","dpName","useProviderInStats","dataSourceName","useInStats","callBack","responseList","recursiveCall","callBackResult","newResult","functionName","mergeFunction","resultPromises","providerMethod","CompositeDataProvider","lists","mergeLabels","mergeElementModels","resp","em","aLists","bLists","createIdForProperty","baseId","pKey","classTreeToArray","resultArray","getDescendants","descendants","nextGeneration","mergedValuesList","locStr","compareLabels","l1","l2","mergeCounts","mergeClassModel","childrenDictionary","composite","topLevelModels","childrenMap","childrenIds","ch","dictionaries","resultInfo","lCount","graphBuilder","getGraphFromConstruct","constructQuery","SparqlGraphBuilder","classesById","propertiesById","onElementEvent","onLinkEvent","onLinkTypeEvent","onClassEvent","findLinkIndex","silent","registerLink","removeLinkReferences","removeLinkFrom","nextLinkTypeIndex","propertyId","getClasses","richClass","haystack","classQueue","onClassesLoaded","linkTypeQueue","onLinkTypesLoaded","propertyTypeQueue","onPropertyTypesLoaded","onElementInfoLoaded","loadedModel","classInfos","propertyModels","targetProperty","propertyType","unsubscribeFromTarget","onStartDragging","preventSelection","startSize","onDragHandleBottom","dx","calculateHeight","onDragHandleRight","calculateWidth","onDragHandleBottomRight","classList","listenToTarget","listenToElement","listenToLink","calculatePositionForElement","y0","calculatePositionForLink","targetPoint","pos","getViewPortScrollablePoints","paperAreaMetrix","getDialogScrollablePoints","FOCUS_OFFSET","viewPortMin","viewPortMax","yOffset","newScrollabalCenter","minHeight","maxHeight","minWidth","maxWidth","renderProperty","richProperty","onChangeIri","onChangeLabel","propertyIris","renderType","renderLabel","validationCancellation","elementValue","validated","setElementOrLink","isValidating","validateElement","validateElementType","validateLink","elementError","linkError","ElementTypeSelector","filterCancellation","loadingItemCancellation","onElementTypeChange","isLoading","generateNewElement","renderPossibleElementType","searchString","existingElements","fetchPossibleElementTypes","searchExistingElements","typesOfElementsDraggedFrom","makeElementTypeComparatorByLabel","typeA","typeB","renderElementTypeSelector","renderExistingElementsList","isAlreadyOnDiagram","hasAppropriateType","onSelectExistingItem","autoFocus","computeLabel","targetListener","queryDebouncer","canLink","canLinkElement","x0","MARGIN","renderRemoveOrDeleteButton","renderEstablishNewLinkButton","isSourceOrTargetDeleted","canDeleteLink","canEditLink","sourceElement","calculateDegree","unit","renderSourceButton","BUTTON_SIZE","getButtonPosition","renderTargetButton","degree","points","renderEditButton","renderDeleteButton","renderEditLabelButton","labelBounds","isAuthoringMode","deleteButton","isDeletedByItself","targetEvent","scheduleUpdate","listenEvents","changeLabelBounds","Editor","calculateLinkPath","calculatePolyline","renderLinkStateLabels","renderedState","renderedErrors","renderLinkErrors","labelPosition","getLinkStateLabelPosition","renderLinkStateHighlighting","strokeOpacity","LINK_LABEL_MARGIN","validation","renderErrorIcon","pointerEvents","isTemporary","renderElementOutlines","fillOpacity","y2","renderElementErrors","renderElementState","outlines","patternUnits","patternTransform","canDropOnElementCancellation","beginCreatingLink","temporaryElement","linkTemplate","temporaryLink","waitingForMetadata","newTargetElement","queryCanDropOnElement","selectedPosition","executeEditOperation","createNewElement","beginMovingLink","queryCanLinkFrom","queryCanDropOnCanvas","startingPoint","oldLink","canLinkFrom","canDropOnCanvas","canDropOnElement","canDrop","modifiedLink","createdTarget","centerElementAtPoint","focusedLink","cleanupAndFinish","renderHighlight","renderCanDropIndicator","indicator","rx","ry","markup","clearAll","exportSvg","fileSaver","saveAs","exportPng","print","printWindow","open","write","close","changeLanguage","onLanguageChange","hideHalo","viewOptions","disableDefaultHalo","_getPaperArea","hidePanels","hideToolbar","onWorkspaceEvent","_elementsSearchPanel","WorkspaceMarkup","leftPanelInitiallyOpen","rightPanelInitiallyOpen","searchCriteria","onSearchCriteriaChanged","isLeftPanelOpen","isRightPanelOpen","toolbar","ToolbarWrapper","workspace","elementsSearchPanel","updateNavigator","hideNavigator","requestedAddToFilter","searchUpdateCriteria","onPointerUp","editorChangeSelection","editorToggleDialog","editorAddElements","showNavigator","Navigator","collapseNavigator","getModel","getDiagram","getEditor","preventTextSelectionUntilMouseUp","preventTextSelection","showWaitIndicatorWhile","operation","hideTutorial","hasUnpersistedChanges","shouldEnforceConstraints","defaultToolbarProps","toolbarProps","ReactDOM","delayedRedraw","scheduleRedraw","draw","calculateTransform","ctx","clearRect","paneStart","paneSize","paneEnd","canvasFromPaneCoords","save","drawElements","drawViewport","onDragViewport","isDraggingViewport","paperFromCanvasCoords","paneOffset","canvasOffset","canvasFromPageCoords","stopDraggingViewport","onToggleClick","chooseElementColor","strokeStyle","lineWidth","viewportStart","viewportEnd","strokeRect","beginPath","lineTo","setLineDash","scalePadding","box","displayPadding","displayStart","displayEnd","displaySize","startDragginViewport","canvasFromPaperCoords","untilMouseUpClasses","onCreateInstance","forceNonReactExecutionContext","centerElementToPosition","onDocumentMouseUp","onDropOnPaper","dragEvent","tryParseDefaultDragAndDropData","addToolbarWidgetToPaper","ToolbarWidget","getLeftPanelLayout","ClassTree","onClassSelected","instancesSearch","getRightPanelLayout","rightPanel","LinkTypesToolbox","flex","workspaceLayout","untilMouseUp","verticalResizing","horizontalResizing","tryGetIri","iriString","getData","ClassTreeProps","delayedClassUpdate","delayedSearch","loadClassesOperation","refreshOperation","onSearchTextChange","requestedSearchText","performSearch","requested","normalizeSearchText","appliedSearchText","applyFilters","onShowOnlyCreatableChange","showOnlyConstructible","onSelectNode","selectedNode","onDragCreate","refreshClassTree","refreshingState","newIris","getNewClassIris","existingClasses","visitClass","constructibleClasses","queryCreatableTypes","roots","createRoots","mapClass","derived","sortTree","filteredRoots","normalizedSearchText","searchText","Forest","onSelect","creatableClasses","onClickCreate","initClassTree","changeCount","setClassTree","diagramModel","reduceNonCycle","typeIris","filterConstructibleTypes","mapNodes","mapNode","compareByLabel","TreeNode","setDerived","filterByKeyword","collectByKeyword","filterOnlyCreatable","collectOnlyCreatable","EXPAND_ICON","default","COLLAPSE_ICON","DEFAULT_LEAF_ICON","DEFAULT_PARENT_ICON","LEAF_CLASS","toggle","toggleIcon","bodyClass","Leaf","onPressFilter","changeState","changeLinkTypeState","isChecked","stateName","getText","newIcon","countIcon","badgeContainer","onChangeInput","onDropFilter","LinkInToolBox","filterCallback","dataState","selectedElement","connectedTo","selectedElementLabel","dropButton","linkListener","debounceSelection","updateOnCurrentSelection","single","requestLinksOf","onLinkChanged","linksOfElement","subscribeOnLinksEvents","computeStateFromRequestResult","LinkTypesToolboxView","isScrollable","updateSizes","collapsed","totalSize","clientSize","leftSize","leftChildCount","newCollapsed","itemCollapsed","isLastItem","noExpandedItems","sizeWhenCollapsed","newSizes","newPercents","sizes","percents","itemIndex","originTotalSize","originSizes","computeEffectiveItemSizes","originCollapsed","resizing","header","offsetSize","SizeDistributor","distribute","isVertical","resizingClassName","scrollableClassName","renderItems","lastChild","additionalProps","onChangeCollapsed","onItemChangeCollapsed","effectiveSize","distributor","splitShift","expand","shift","freeSize","collapseForward","leftoverSize","splitIndex","collapseBackward","shiftLeft","collapse","newSize","oldSize","sizeSum","sum","_element","_header","renderToggleButton","side","bodyClassName","bodyRef","shouldRenderHandle","isMounted","WorkspaceContext","WorkspaceContextWrapper"],"mappings":"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","file":"default~diagram-search-result~ontodia~ontodia-nested-nodes~rs-dashboard~rs-image-graph-authoring~rs-~75ac7c5b-586a56ef93c367d751b1.js","sourcesContent":["export type Listener<Data, Key extends keyof Data> = (data: Data[Key], key: Key) => void;\nexport type AnyListener<Data> = (data: Partial<Data>, key: string) => void;\nexport type Unsubscribe = () => void;\n\nexport interface PropertyChange<Source, Value> {\n  source: Source;\n  previous: Value;\n}\n\nexport interface AnyEvent<Data> {\n  key: string;\n  data: Partial<Data>;\n}\n\nexport interface Events<Data> {\n  on<Key extends keyof Data>(eventKey: Key, listener: Listener<Data, Key>): void;\n  off<Key extends keyof Data>(eventKey: Key, listener: Listener<Data, Key>): void;\n  onAny(listener: AnyListener<Data>): void;\n  offAny(listener: AnyListener<Data>): void;\n}\n\nexport class EventSource<Data> implements Events<Data> {\n  private listeners = new Map<keyof Data, Array<Listener<Data, any>>>();\n  private anyListeners: Array<AnyListener<Data>> | undefined;\n\n  on<Key extends keyof Data>(eventKey: Key, listener: Listener<Data, Key>): void {\n    let listeners = this.listeners.get(eventKey);\n    if (!listeners) {\n      listeners = [];\n      this.listeners.set(eventKey, listeners);\n    }\n    listeners.push(listener);\n  }\n\n  onAny(listener: AnyListener<Data>): void {\n    let listeners = this.anyListeners;\n    if (!listeners) {\n      listeners = [];\n      this.anyListeners = listeners;\n    }\n    listeners.push(listener);\n  }\n\n  off<Key extends keyof Data>(eventKey: Key, listener: Listener<Data, Key>): void {\n    const listeners = this.listeners.get(eventKey);\n    if (!listeners) {\n      return;\n    }\n    const index = listeners.indexOf(listener);\n    if (index >= 0) {\n      listeners.splice(index, 1);\n    }\n  }\n\n  offAny(listener: AnyListener<Data>): void {\n    const listeners = this.anyListeners;\n    if (!listeners) {\n      return;\n    }\n    const index = listeners.indexOf(listener);\n    if (index >= 0) {\n      listeners.splice(index, 1);\n    }\n  }\n\n  trigger<Key extends keyof Data>(eventKey: Key, data: Data[Key]): void {\n    const listeners = this.listeners.get(eventKey);\n    if (listeners) {\n      for (const listener of listeners) {\n        listener(data, eventKey);\n      }\n    }\n\n    if (this.anyListeners) {\n      for (const anyListener of this.anyListeners) {\n        anyListener({ [eventKey]: data } as any, eventKey as string);\n      }\n    }\n  }\n}\n\nexport class EventObserver {\n  private unsubscribeByKey = new Map<string, Unsubscribe[]>();\n  private onDispose: Array<Unsubscribe> = [];\n\n  listen<Data, Key extends keyof Data>(events: Events<Data>, eventKey: Key, listener: Listener<Data, Key>) {\n    events.on(eventKey, listener);\n    this.onDispose.push(() => events.off(eventKey, listener));\n  }\n\n  listenAny<Data>(events: Events<Data>, listener: AnyListener<Data>) {\n    events.onAny(listener);\n    this.onDispose.push(() => events.offAny(listener));\n  }\n\n  listenOnce<Data, Key extends keyof Data>(events: Events<Data>, eventKey: Key, listener: Listener<Data, Key>) {\n    let handled = false;\n    const onceListener: Listener<Data, Key> = (data, key) => {\n      handled = true;\n      events.off(eventKey, onceListener);\n      listener(data, key);\n    };\n    events.on(eventKey, onceListener);\n    this.onDispose.push(() => {\n      if (handled) {\n        return;\n      }\n      events.off(eventKey, onceListener);\n    });\n  }\n\n  stopListening() {\n    for (const unsubscribe of this.onDispose) {\n      unsubscribe();\n    }\n    this.onDispose.length = 0;\n\n    this.unsubscribeByKey.forEach((unsubscribers) => {\n      for (const unsubscribe of unsubscribers) {\n        unsubscribe();\n      }\n    });\n    this.unsubscribeByKey.clear();\n  }\n}\n","import { Events, EventSource } from './events';\n\nexport abstract class BatchingScheduler {\n  private useAnimationFrame: boolean;\n  private scheduled: any | undefined;\n\n  constructor(readonly waitingTime = 0) {\n    this.useAnimationFrame = waitingTime === 0;\n    this.runSynchronously = this.runSynchronously.bind(this);\n  }\n\n  protected schedule() {\n    if (typeof this.scheduled === 'undefined') {\n      if (this.useAnimationFrame) {\n        this.scheduled = requestAnimationFrame(this.runSynchronously);\n      } else {\n        this.scheduled = setTimeout(this.runSynchronously, this.waitingTime);\n      }\n    }\n  }\n\n  protected abstract run(): void;\n\n  runSynchronously() {\n    const wasScheduled = this.cancelScheduledTimeout();\n    if (wasScheduled) {\n      this.run();\n    }\n  }\n\n  dispose() {\n    this.cancelScheduledTimeout();\n  }\n\n  private cancelScheduledTimeout(): boolean {\n    if (typeof this.scheduled !== 'undefined') {\n      if (this.useAnimationFrame) {\n        cancelAnimationFrame(this.scheduled);\n      } else {\n        clearTimeout(this.scheduled);\n      }\n      this.scheduled = undefined;\n      return true;\n    }\n    return false;\n  }\n}\n\nexport class BufferingQueue<Key extends string> extends BatchingScheduler {\n  private fetchingQueue: { [key: string]: true } = Object.create(null);\n\n  constructor(private onFetch: (keys: Key[]) => void, waitingTime = 200) {\n    super(waitingTime);\n  }\n\n  push(key: Key) {\n    this.fetchingQueue[key] = true;\n    this.schedule();\n  }\n\n  clear() {\n    this.fetchingQueue = Object.create(null);\n  }\n\n  protected run() {\n    const { fetchingQueue, onFetch } = this;\n    this.fetchingQueue = Object.create(null);\n    onFetch(Object.keys(fetchingQueue) as Key[]);\n  }\n}\n\nexport class Debouncer extends BatchingScheduler {\n  private callback: (() => void) | undefined;\n\n  call(callback: () => void) {\n    this.callback = callback;\n    this.schedule();\n  }\n\n  protected run() {\n    const callback = this.callback;\n    callback();\n  }\n}\n\nexport class Cancellation {\n  public static NEVER_SIGNAL: CancellationToken = {\n    aborted: false,\n    addEventListener: () => {\n      /* nothing */\n    },\n    removeEventListener: () => {\n      /* nothing */\n    },\n  };\n  private source: EventSource<{ abort: undefined }> | undefined = new EventSource();\n  private aborted = false;\n\n  readonly signal: CancellationToken;\n\n  constructor() {\n    this.signal = new (class {\n      constructor(private parent: Cancellation) {}\n      get aborted() {\n        return this.parent.aborted;\n      }\n      addEventListener(event: 'abort', handler: () => void) {\n        if (event !== 'abort') {\n          return;\n        }\n        if (this.parent.source) {\n          this.parent.source.on('abort', handler);\n        } else {\n          handler();\n        }\n      }\n      removeEventListener(event: 'abort', handler: () => void) {\n        if (event !== 'abort') {\n          return;\n        }\n        if (this.parent.source) {\n          this.parent.source.off('abort', handler);\n        }\n      }\n    })(this);\n  }\n\n  abort() {\n    if (this.aborted) {\n      return;\n    }\n    this.aborted = true;\n    this.source.trigger('abort', undefined);\n    this.source = undefined;\n  }\n}\n\nexport interface CancellationToken {\n  readonly aborted: boolean;\n  addEventListener(event: 'abort', handler: () => void): void;\n  removeEventListener(event: 'abort', handler: () => void): void;\n}\n\nexport namespace CancellationToken {\n  export function throwIfAborted(ct: CancellationToken): void {\n    if (ct.aborted) {\n      throw new CancelledError();\n    }\n  }\n\n  export function mapCancelledToNull<T>(ct: CancellationToken, promise: Promise<T>): Promise<T | null> {\n    const onResolve = (value: T): T | null => {\n      if (ct.aborted) {\n        return null;\n      }\n      return value;\n    };\n    const onReject = (err: any): null | Promise<null> => {\n      if (ct.aborted) {\n        return null;\n      }\n      return Promise.reject(err);\n    };\n    return promise.then(onResolve, onReject);\n  }\n}\n\nexport class CancelledError extends Error {\n  constructor(message = 'Operation was cancelled') {\n    super(message);\n    this.name = CancelledError.name;\n    Object.setPrototypeOf(this, CancelledError.prototype);\n  }\n}\n\nexport function delay(timeout: number) {\n  return new Promise((resolve) => setTimeout(() => resolve(), timeout));\n}\n\nexport function animateInterval(\n  duration: number,\n  onProgress: (progress: number) => void,\n  cancellation?: Cancellation\n): Promise<void> {\n  return new Promise((resolve) => {\n    let animationFrameId: number;\n    let start: number;\n\n    const animate = (time: number) => {\n      if (cancellation && cancellation.signal.aborted) {\n        return;\n      }\n\n      start = start || time;\n      let timePassed = time - start;\n      if (timePassed > duration) {\n        timePassed = duration;\n      }\n\n      onProgress(timePassed / duration);\n\n      if (timePassed < duration) {\n        animationFrameId = requestAnimationFrame(animate);\n      } else {\n        resolve();\n      }\n    };\n\n    cancellation.signal.addEventListener('abort', () => {\n      cancelAnimationFrame(animationFrameId);\n      resolve();\n    });\n    animationFrameId = requestAnimationFrame(animate);\n  });\n}\n\nexport function easeInOutBezier(t: number) {\n  if (t < 0) {\n    return 0;\n  }\n  if (t > 1) {\n    return 1;\n  }\n  return t * t * (3.0 - 2.0 * t);\n}\n","import {\n  ElementModel,\n  LinkModel,\n  LocalizedString,\n  ElementIri,\n  ElementTypeIri,\n  LinkTypeIri,\n  PropertyTypeIri,\n} from '../data/model';\nimport { GenerateID } from '../data/schema';\n\nimport { EventSource, Events, PropertyChange } from '../viewUtils/events';\n\nimport { Vector, Size, isPolylineEqual, Rect } from './geometry';\n\nexport type Cell = Element | Link | LinkVertex;\n\nexport enum LinkDirection {\n  in = 'in',\n  out = 'out',\n}\n\nexport interface ElementEvents {\n  changeData: PropertyChange<Element, ElementModel>;\n  changePosition: PropertyChange<Element, Vector>;\n  changeSize: PropertyChange<Element, Size>;\n  changeExpanded: PropertyChange<Element, boolean>;\n  changeGroup: PropertyChange<Element, string>;\n  changeElementState: PropertyChange<Element, ElementTemplateState | undefined>;\n  requestedFocus: { source: Element };\n  requestedGroupContent: { source: Element };\n  requestedAddToFilter: {\n    source: Element;\n    linkType?: FatLinkType;\n    direction?: 'in' | 'out';\n  };\n  requestedRedraw: { source: Element };\n}\n\nexport class Element {\n  private readonly source = new EventSource<ElementEvents>();\n  readonly events: Events<ElementEvents> = this.source;\n\n  readonly id: string;\n  /** All in and out links of the element */\n  readonly links: Link[] = [];\n\n  private _data: ElementModel;\n  private _position: Vector;\n  private _size: Size;\n  private _fixedSize: boolean;\n  private _expanded: boolean;\n  private _group: string | undefined;\n  private _elementState: ElementTemplateState | undefined;\n  private _temporary: boolean;\n\n  constructor(props: {\n    id: string;\n    data: ElementModel;\n    position?: Vector;\n    size?: Size;\n    fixedSize?: boolean;\n    expanded?: boolean;\n    group?: string;\n    elementState?: ElementTemplateState;\n    temporary?: boolean;\n  }) {\n    const {\n      id,\n      data,\n      position = { x: 0, y: 0 },\n      size = { width: 0, height: 0 },\n      fixedSize,\n      expanded = false,\n      group,\n      elementState,\n      temporary = false,\n    } = props;\n\n    this.id = id;\n    this._data = data;\n    this._position = position;\n    this._size = size;\n    this._fixedSize = fixedSize;\n    this._expanded = expanded;\n    this._group = group;\n    this._elementState = elementState;\n    this._temporary = temporary;\n  }\n\n  get iri() {\n    return this._data.id;\n  }\n\n  get data() {\n    return this._data;\n  }\n  setData(value: ElementModel) {\n    const previous = this._data;\n    if (previous === value) {\n      return;\n    }\n    this._data = value;\n    this.source.trigger('changeData', { source: this, previous });\n    updateLinksToReferByNewIri(this, previous.id, value.id);\n  }\n\n  get position(): Vector {\n    return this._position;\n  }\n  setPosition(value: Vector) {\n    const previous = this._position;\n    const same = previous.x === value.x && previous.y === value.y;\n    if (same) {\n      return;\n    }\n    this._position = value;\n    this.source.trigger('changePosition', { source: this, previous });\n  }\n\n  get size(): Size {\n    return this._size;\n  }\n  setSize(value: Size) {\n    const previous = this._size;\n    const same = previous.width === value.width && previous.height === value.height;\n    if (same) {\n      return;\n    }\n    this._size = value;\n    this.source.trigger('changeSize', { source: this, previous });\n  }\n\n\n  get isFixedSize(): boolean { return this._fixedSize; }\n  setFixedSize(isFixed: boolean) {\n    const previous = this._fixedSize;\n    if (previous === isFixed) { return; }\n\n    this._fixedSize = isFixed;\n  }\n\n  get isExpanded(): boolean {\n    return this._expanded;\n  }\n  setExpanded(value: boolean) {\n    const previous = this._expanded;\n    if (previous === value) {\n      return;\n    }\n    this._expanded = value;\n    this.source.trigger('changeExpanded', { source: this, previous });\n  }\n\n  get group(): string | undefined {\n    return this._group;\n  }\n  setGroup(value: string | undefined) {\n    const previous = this._group;\n    if (previous === value) {\n      return;\n    }\n    this._group = value;\n    this.source.trigger('changeGroup', { source: this, previous });\n  }\n\n  get elementState(): ElementTemplateState | undefined {\n    return this._elementState;\n  }\n  setElementState(value: ElementTemplateState | undefined) {\n    const previous = this._elementState;\n    if (previous === value) {\n      return;\n    }\n    this._elementState = value;\n    this.source.trigger('changeElementState', { source: this, previous });\n  }\n\n  get temporary(): boolean {\n    return this._temporary;\n  }\n\n  focus() {\n    this.source.trigger('requestedFocus', { source: this });\n  }\n\n  requestGroupContent() {\n    this.source.trigger('requestedGroupContent', { source: this });\n  }\n\n  addToFilter(linkType?: FatLinkType, direction?: 'in' | 'out') {\n    this.source.trigger('requestedAddToFilter', {\n      source: this,\n      linkType,\n      direction,\n    });\n  }\n\n  redraw() {\n    this.source.trigger('requestedRedraw', { source: this });\n  }\n}\n\nexport interface ElementTemplateState {\n  [propertyIri: string]: any;\n}\n\nexport interface AddToFilterRequest {\n  element: Element;\n  linkType?: FatLinkType;\n  direction?: 'in' | 'out';\n}\n\nfunction updateLinksToReferByNewIri(element: Element, oldIri: ElementIri, newIri: ElementIri) {\n  if (oldIri === newIri) {\n    return;\n  }\n  for (const link of element.links) {\n    let data = link.data;\n    if (data.sourceId === oldIri) {\n      data = { ...data, sourceId: newIri };\n    }\n    if (data.targetId === oldIri) {\n      data = { ...data, targetId: newIri };\n    }\n    link.setData(data);\n  }\n}\n\nexport interface FatClassModelEvents {\n  changeLabel: PropertyChange<FatClassModel, ReadonlyArray<LocalizedString>>;\n  changeCount: PropertyChange<FatClassModel, number | undefined>;\n}\n\nexport class FatClassModel {\n  private readonly source = new EventSource<FatClassModelEvents>();\n  readonly events: Events<FatClassModelEvents> = this.source;\n\n  readonly id: ElementTypeIri;\n\n  private _label: ReadonlyArray<LocalizedString>;\n  private _count: number | undefined;\n\n  constructor(props: { id: ElementTypeIri; label?: ReadonlyArray<LocalizedString>; count?: number }) {\n    const { id, label = [], count } = props;\n    this.id = id;\n    this._label = label;\n    this._count = count;\n  }\n\n  get label() {\n    return this._label;\n  }\n  setLabel(value: ReadonlyArray<LocalizedString>) {\n    const previous = this._label;\n    if (previous === value) {\n      return;\n    }\n    this._label = value;\n    this.source.trigger('changeLabel', { source: this, previous });\n  }\n\n  get count() {\n    return this._count;\n  }\n  setCount(value: number | undefined) {\n    const previous = this._count;\n    if (previous === value) {\n      return;\n    }\n    this._count = value;\n    this.source.trigger('changeCount', { source: this, previous });\n  }\n}\n\nexport interface RichPropertyEvents {\n  changeLabel: PropertyChange<RichProperty, ReadonlyArray<LocalizedString>>;\n}\n\nexport class RichProperty {\n  private readonly source = new EventSource<RichPropertyEvents>();\n  readonly events: Events<RichPropertyEvents> = this.source;\n\n  readonly id: PropertyTypeIri;\n\n  private _label: ReadonlyArray<LocalizedString>;\n\n  constructor(props: { id: PropertyTypeIri; label?: ReadonlyArray<LocalizedString> }) {\n    const { id, label = [] } = props;\n    this.id = id;\n    this._label = label;\n  }\n\n  get label(): ReadonlyArray<LocalizedString> {\n    return this._label;\n  }\n  setLabel(value: ReadonlyArray<LocalizedString>) {\n    const previous = this._label;\n    if (previous === value) {\n      return;\n    }\n    this._label = value;\n    this.source.trigger('changeLabel', { source: this, previous });\n  }\n}\n\nexport interface LinkEvents {\n  changeData: PropertyChange<Link, LinkModel>;\n  changeLayoutOnly: PropertyChange<Link, boolean>;\n  changeVertices: PropertyChange<Link, ReadonlyArray<Vector>>;\n  changeLabelBounds: PropertyChange<Link, Rect>;\n  changeLinkState: PropertyChange<Link, LinkTemplateState | undefined>;\n}\n\nexport class Link {\n  private readonly source = new EventSource<LinkEvents>();\n  readonly events: Events<LinkEvents> = this.source;\n\n  readonly id: string;\n\n  private _typeId: LinkTypeIri;\n  private _sourceId: string;\n  private _targetId: string;\n\n  private _data: LinkModel | undefined;\n  private _labelBounds: Rect | undefined;\n  private _layoutOnly: boolean;\n  private _vertices: ReadonlyArray<Vector>;\n\n  private _linkState: LinkTemplateState | undefined;\n\n  constructor(props: {\n    id?: string;\n    typeId: LinkTypeIri;\n    sourceId: string;\n    targetId: string;\n    data?: LinkModel;\n    vertices?: ReadonlyArray<Vector>;\n    linkState?: LinkTemplateState;\n  }) {\n    const { id = GenerateID.forLink(), typeId, sourceId, targetId, data, vertices = [], linkState } = props;\n    this.id = id;\n    this._typeId = typeId;\n    this._sourceId = sourceId;\n    this._targetId = targetId;\n    this._data = data;\n    this._vertices = vertices;\n    this._linkState = linkState;\n  }\n\n  get typeId() {\n    return this._typeId;\n  }\n  get sourceId(): string {\n    return this._sourceId;\n  }\n  get targetId(): string {\n    return this._targetId;\n  }\n\n  get data() {\n    return this._data;\n  }\n  setData(value: LinkModel | undefined) {\n    const previous = this._data;\n    if (previous === value) {\n      return;\n    }\n    this._data = value;\n    this._typeId = value.linkTypeId;\n    this.source.trigger('changeData', { source: this, previous });\n  }\n\n  get labelBounds() {\n    return this._labelBounds;\n  }\n  setLabelBounds(value: Rect | undefined) {\n    const previous = this._labelBounds;\n    if (previous === value) {\n      return;\n    }\n    this._labelBounds = value;\n    this.source.trigger('changeLabelBounds', { source: this, previous });\n  }\n\n  get layoutOnly(): boolean {\n    return this._layoutOnly;\n  }\n  setLayoutOnly(value: boolean) {\n    const previous = this._layoutOnly;\n    if (previous === value) {\n      return;\n    }\n    this._layoutOnly = value;\n    this.source.trigger('changeLayoutOnly', { source: this, previous });\n  }\n\n  get vertices(): ReadonlyArray<Vector> {\n    return this._vertices;\n  }\n  setVertices(value: ReadonlyArray<Vector>) {\n    const previous = this._vertices;\n    if (isPolylineEqual(this._vertices, value)) {\n      return;\n    }\n    this._vertices = value;\n    this.source.trigger('changeVertices', { source: this, previous });\n  }\n\n  get linkState(): LinkTemplateState | undefined {\n    return this._linkState;\n  }\n  setLinkState(value: LinkTemplateState | undefined) {\n    const previous = this._linkState;\n    if (previous === value) {\n      return;\n    }\n    this._linkState = value;\n    this.source.trigger('changeLinkState', { source: this, previous });\n  }\n}\n\nexport interface LinkTemplateState {\n  [propertyIri: string]: any;\n}\n\nexport function linkMarkerKey(linkTypeIndex: number, startMarker: boolean) {\n  return `ontodia-${startMarker ? 'mstart' : 'mend'}-${linkTypeIndex}`;\n}\n\nexport interface FatLinkTypeEvents {\n  changeLabel: PropertyChange<FatLinkType, ReadonlyArray<LocalizedString>>;\n  changeIsNew: PropertyChange<FatLinkType, boolean>;\n  changeVisibility: {\n    source: FatLinkType;\n    preventLoading: boolean;\n  };\n}\n\n/**\n * Properties:\n *     visible: boolean\n *     showLabel: boolean\n *     isNew?: boolean\n *     label?: { values: LocalizedString[] }\n */\nexport class FatLinkType {\n  private readonly source = new EventSource<FatLinkTypeEvents>();\n  readonly events: Events<FatLinkTypeEvents> = this.source;\n\n  readonly id: LinkTypeIri;\n\n  private _index: number | undefined;\n\n  private _label: ReadonlyArray<LocalizedString>;\n  private _isNew = false;\n\n  private _visible = true;\n  private _showLabel = true;\n\n  constructor(props: { id: LinkTypeIri; index?: number; label?: ReadonlyArray<LocalizedString> }) {\n    const { id, index, label = [] } = props;\n    this.id = id;\n    this._index = index;\n    this._label = label;\n  }\n\n  get index() {\n    return this._index;\n  }\n  setIndex(value: number) {\n    if (typeof this._index === 'number') {\n      throw new Error('Cannot set index for link type more than once.');\n    }\n    this._index = value;\n  }\n\n  get label() {\n    return this._label;\n  }\n  setLabel(value: ReadonlyArray<LocalizedString>) {\n    const previous = this._label;\n    if (previous === value) {\n      return;\n    }\n    this._label = value;\n    this.source.trigger('changeLabel', { source: this, previous });\n  }\n\n  get visible() {\n    return this._visible;\n  }\n  get showLabel() {\n    return this._showLabel;\n  }\n  setVisibility(params: { visible: boolean; showLabel: boolean; preventLoading?: boolean }) {\n    const same = this._visible === params.visible && this._showLabel === params.showLabel;\n    if (same) {\n      return;\n    }\n    const preventLoading = Boolean(params.preventLoading) || this._visible === params.visible;\n    this._visible = params.visible;\n    this._showLabel = params.showLabel;\n    this.source.trigger('changeVisibility', { source: this, preventLoading });\n  }\n\n  get isNew() {\n    return this._isNew;\n  }\n  setIsNew(value: boolean) {\n    const previous = this._isNew;\n    if (previous === value) {\n      return;\n    }\n    this._isNew = value;\n    this.source.trigger('changeIsNew', { source: this, previous });\n  }\n}\n\nexport class LinkVertex {\n  constructor(readonly link: Link, readonly vertexIndex: number) {}\n\n  createAt(location: Vector) {\n    const vertices = [...this.link.vertices];\n    vertices.splice(this.vertexIndex, 0, location);\n    this.link.setVertices(vertices);\n  }\n\n  moveTo(location: Vector) {\n    const vertices = [...this.link.vertices];\n    vertices.splice(this.vertexIndex, 1, location);\n    this.link.setVertices(vertices);\n  }\n\n  remove() {\n    const vertices = [...this.link.vertices];\n    const [location] = vertices.splice(this.vertexIndex, 1);\n    this.link.setVertices(vertices);\n  }\n}\n","import { Element } from './elements';\n\nexport interface Vector {\n  readonly x: number;\n  readonly y: number;\n}\nexport namespace Vector {\n  export function equals(a: Vector, b: Vector) {\n    return a.x === b.x && a.y === b.y;\n  }\n  export function length({ x, y }: Vector) {\n    return Math.sqrt(x * x + y * y);\n  }\n  export function normalize({ x, y }: Vector) {\n    if (x === 0 && y === 0) {\n      return { x, y };\n    }\n    const inverseLength = 1 / Math.sqrt(x * x + y * y);\n    return { x: x * inverseLength, y: y * inverseLength };\n  }\n  export function dot({ x: x1, y: y1 }: Vector, { x: x2, y: y2 }: Vector): number {\n    return x1 * x2 + y1 * y2;\n  }\n  export function cross2D({ x: x1, y: y1 }: Vector, { x: x2, y: y2 }: Vector) {\n    return x1 * y2 - y1 * x2;\n  }\n}\n\nexport interface Size {\n  readonly width: number;\n  readonly height: number;\n}\n\nexport interface Rect {\n  readonly x: number;\n  readonly y: number;\n  readonly width: number;\n  readonly height: number;\n}\nexport namespace Rect {\n  export function center({ x, y, width, height }: Rect) {\n    return { x: x + width / 2, y: y + height / 2 };\n  }\n}\n\nexport function boundsOf(element: Element): Rect {\n  const { x, y } = element.position;\n  const { width, height } = element.size;\n  return { x, y, width, height };\n}\n\nfunction intersectRayFromRectangleCenter(sourceRect: Rect, rayTarget: Vector) {\n  const isTargetInsideRect =\n    sourceRect.width === 0 ||\n    sourceRect.height === 0 ||\n    (rayTarget.x > sourceRect.x &&\n      rayTarget.x < sourceRect.x + sourceRect.width &&\n      rayTarget.y > sourceRect.y &&\n      rayTarget.y < sourceRect.y + sourceRect.height);\n\n  const halfWidth = sourceRect.width / 2;\n  const halfHeight = sourceRect.height / 2;\n  const center = {\n    x: sourceRect.x + halfWidth,\n    y: sourceRect.y + halfHeight,\n  };\n  if (isTargetInsideRect) {\n    return center;\n  }\n\n  const direction = Vector.normalize({\n    x: rayTarget.x - center.x,\n    y: rayTarget.y - center.y,\n  });\n\n  const rightDirection = { x: Math.abs(direction.x), y: direction.y };\n  const isHorizontal =\n    Vector.cross2D({ x: halfWidth, y: -halfHeight }, rightDirection) > 0 &&\n    Vector.cross2D({ x: halfWidth, y: halfHeight }, rightDirection) < 0;\n\n  if (isHorizontal) {\n    return {\n      x: center.x + halfWidth * Math.sign(direction.x),\n      y: center.y + (halfWidth * direction.y) / Math.abs(direction.x),\n    };\n  } else {\n    return {\n      x: center.x + (halfHeight * direction.x) / Math.abs(direction.y),\n      y: center.y + halfHeight * Math.sign(direction.y),\n    };\n  }\n}\n\nexport function isPolylineEqual(left: ReadonlyArray<Vector>, right: ReadonlyArray<Vector>) {\n  if (left === right) {\n    return true;\n  }\n  if (left.length !== right.length) {\n    return false;\n  }\n  for (let i = 0; i < left.length; i++) {\n    const a = left[i];\n    const b = right[i];\n    if (!(a.x === b.x && a.y === b.y)) {\n      return false;\n    }\n  }\n  return true;\n}\n\nexport function computePolyline(source: Element, target: Element, vertices: ReadonlyArray<Vector>): Vector[] {\n  const sourceRect = boundsOf(source);\n  const targetRect = boundsOf(target);\n  const startPoint = intersectRayFromRectangleCenter(\n    sourceRect,\n    vertices.length > 0 ? vertices[0] : Rect.center(targetRect)\n  );\n  const endPoint = intersectRayFromRectangleCenter(\n    targetRect,\n    vertices.length > 0 ? vertices[vertices.length - 1] : Rect.center(sourceRect)\n  );\n  return [startPoint, ...vertices, endPoint];\n}\n\nexport function computePolylineLength(polyline: ReadonlyArray<Vector>): number {\n  let previous: Vector;\n  return polyline.reduce((acc, point) => {\n    const segmentLength = previous ? Vector.length({ x: point.x - previous.x, y: point.y - previous.y }) : 0;\n    previous = point;\n    return acc + segmentLength;\n  }, 0);\n}\n\nexport function getPointAlongPolyline(polyline: ReadonlyArray<Vector>, offset: number): Vector {\n  if (polyline.length === 0) {\n    throw new Error('Cannot compute a point for empty polyline');\n  }\n  if (offset < 0) {\n    return polyline[0];\n  }\n  let currentOffset = 0;\n  for (let i = 1; i < polyline.length; i++) {\n    const previous = polyline[i - 1];\n    const point = polyline[i];\n    const segment = { x: point.x - previous.x, y: point.y - previous.y };\n    const segmentLength = Vector.length(segment);\n    const newOffset = currentOffset + segmentLength;\n    if (offset < newOffset) {\n      const leftover = (offset - currentOffset) / segmentLength;\n      return {\n        x: previous.x + leftover * segment.x,\n        y: previous.y + leftover * segment.y,\n      };\n    } else {\n      currentOffset = newOffset;\n    }\n  }\n  return polyline[polyline.length - 1];\n}\n\nexport function findNearestSegmentIndex(polyline: ReadonlyArray<Vector>, location: Vector): number {\n  let minDistance = Infinity;\n  let foundIndex = 0;\n\n  for (let i = 0; i < polyline.length - 1; i++) {\n    const pivot = polyline[i];\n    const next = polyline[i + 1];\n\n    const target = { x: location.x - pivot.x, y: location.y - pivot.y };\n    const segment = { x: next.x - pivot.x, y: next.y - pivot.y };\n    const segmentLength = Vector.length(segment);\n\n    const projectionToSegment = Vector.dot(target, segment) / segmentLength;\n    if (projectionToSegment < 0 || projectionToSegment > segmentLength) {\n      continue;\n    }\n\n    const distanceToSegment = Math.abs(Vector.cross2D(target, segment)) / segmentLength;\n    if (distanceToSegment < minDistance) {\n      minDistance = distanceToSegment;\n      foundIndex = i;\n    }\n  }\n  return foundIndex;\n}\n\nexport function findElementAtPoint(elements: ReadonlyArray<Element>, point: Vector): Element | undefined {\n  for (let i = elements.length - 1; i >= 0; i--) {\n    const element = elements[i];\n    const { x, y, width, height } = boundsOf(element);\n\n    if (element.temporary) {\n      continue;\n    }\n\n    if (point.x >= x && point.x <= x + width && point.y >= y && point.y <= y + height) {\n      return element;\n    }\n  }\n  return undefined;\n}\n\nexport function computeGrouping(elements: ReadonlyArray<Element>): Map<string, Element[]> {\n  const grouping = new Map<string, Element[]>();\n  for (const element of elements) {\n    const group = element.group;\n    if (typeof group === 'string') {\n      let children = grouping.get(group);\n      if (!children) {\n        children = [];\n        grouping.set(group, children);\n      }\n      children.push(element);\n    }\n  }\n  return grouping;\n}\n","require('../../styles/main.scss');\n\nexport * from './customization/props';\nexport * from './customization/templates';\n\nexport * from './data/model';\nexport * from './data/metadataApi';\nexport * from './data/validationApi';\nexport * from './data/provider';\nexport { PLACEHOLDER_ELEMENT_TYPE, PLACEHOLDER_LINK_TYPE } from './data/schema';\nexport * from './data/demo/provider';\nexport { RdfNode, RdfIri, RdfLiteral, Triple } from './data/sparql/sparqlModels';\nexport * from './data/rdf/rdfDataProvider';\nexport * from './data/sparql/sparqlDataProvider';\nexport * from './data/composite/composite';\nexport * from './data/sparql/sparqlDataProviderSettings';\nexport * from './data/sparql/graphBuilder';\nexport * from './data/sparql/sparqlGraphBuilder';\nexport { DIAGRAM_CONTEXT_URL_V1 } from './data/schema';\n\nexport { RestoreGeometry, setElementExpanded, setElementData, setLinkData } from './diagram/commands';\nexport {\n  Element,\n  ElementEvents,\n  ElementTemplateState,\n  Link,\n  LinkEvents,\n  LinkTemplateState,\n  LinkVertex,\n  Cell,\n  LinkDirection,\n} from './diagram/elements';\nexport { EmbeddedLayer } from './diagram/embeddedLayer';\nexport * from './diagram/geometry';\nexport * from './diagram/history';\nexport { DiagramModel, DiagramModelEvents } from './diagram/model';\nexport * from './diagram/view';\nexport { PointerEvent, PointerUpEvent, getContentFittingBox, ViewportOptions, ScaleOptions } from './diagram/paperArea';\n\nexport * from './editor/asyncModel';\nexport { AuthoredEntity, AuthoredEntityProps, AuthoredEntityContext } from './editor/authoredEntity';\nexport * from './editor/authoringState';\nexport {\n  EditorOptions,\n  EditorEvents,\n  EditorController,\n  PropertyEditor,\n  PropertyEditorOptions,\n} from './editor/editorController';\nexport { ValidationState, ElementValidation, LinkValidation } from './editor/validation';\n\nexport {\n  LayoutData,\n  LayoutElement,\n  LayoutLink,\n  SerializedDiagram,\n  convertToSerializedDiagram,\n  makeSerializedDiagram,\n  LinkTypeOptions,\n  makeLayoutData,\n} from './editor/serializedDiagram';\nexport {\n  calculateLayout,\n  removeOverlaps,\n  CalculatedLayout,\n  UnzippedCalculatedLayout,\n  LayoutNode,\n  applyLayout,\n  forceLayout,\n} from './viewUtils/layout';\n\nexport { Cancellation, CancellationToken, CancelledError } from './viewUtils/async';\nexport * from './viewUtils/events';\n\nexport { PropertySuggestionParams, PropertyScore } from './widgets/connectionsMenu';\n\nexport { DefaultToolbar, ToolbarProps } from './workspace/toolbar';\nexport { Workspace, WorkspaceProps, WorkspaceState, WorkspaceLanguage, renderTo } from './workspace/workspace';\nexport { WorkspaceEventHandler, WorkspaceEventKey } from './workspace/workspaceContext';\nexport { DraggableHandle } from './workspace/draggableHandle';\nexport * from './workspace/layout/layout';\n\nimport * as InternalApi from './internalApi';\nexport { InternalApi };\n","import { ElementTypeIri, LinkTypeIri } from './model';\nimport { generate128BitID } from './utils';\n\n// context could be imported directly from NPM package, e.g.\n//   import OntodiaContextV1 from 'ontodia/schema/context-v1.json';\nexport const DIAGRAM_CONTEXT_URL_V1 = 'https://ontodia.org/context/v1.json';\n\nexport const PLACEHOLDER_ELEMENT_TYPE = 'http://ontodia.org/NewEntity' as ElementTypeIri;\nexport const PLACEHOLDER_LINK_TYPE = 'http://ontodia.org/NewLink' as LinkTypeIri;\nconst ONTODIA_ID_URL_PREFIX = 'http://ontodia.org/data/';\n\nexport namespace GenerateID {\n  export function forElement() {\n    return `${ONTODIA_ID_URL_PREFIX}e_${generate128BitID()}`;\n  }\n  export function forLink() {\n    return `${ONTODIA_ID_URL_PREFIX}l_${generate128BitID()}`;\n  }\n}\n\nexport namespace TemplateProperties {\n  export const PinnedProperties = 'ontodia:pinnedProperties';\n  export const CustomLabel = 'ontodia:customLabel';\n}\n","import * as React from 'react';\n\nexport interface SpinnerProps {\n  size?: number;\n  position?: { x: number; y: number };\n  maxWidth?: number;\n  statusText?: string;\n  errorOccured?: boolean;\n}\n\nconst CLASS_NAME = 'ontodia-spinner';\n\nexport class Spinner extends React.Component<SpinnerProps, {}> {\n  render() {\n    const { position = { x: 0, y: 0 }, size = 50, statusText, errorOccured } = this.props;\n\n    const textLeftMargin = 5;\n    const pathGeometry =\n      'm3.47,-19.7 a20,20 0 1,1 -6.95,0 m0,0 l-6,5 m6,-5 l-8,-0' + (errorOccured ? 'M-8,-8L8,8M-8,8L8,-8' : '');\n\n    return (\n      <g className={CLASS_NAME} data-error={errorOccured} transform={`translate(${position.x},${position.y})`}>\n        <g className={`${CLASS_NAME}__arrow`}>\n          <path\n            d={pathGeometry}\n            transform={`scale(0.02)scale(${size})`}\n            fill=\"none\"\n            stroke={errorOccured ? 'red' : 'black'}\n            strokeWidth=\"3\"\n            strokeLinecap=\"round\"\n          />\n        </g>\n        <text style={{ dominantBaseline: 'middle' }} x={size / 2 + textLeftMargin}>\n          {statusText}\n        </text>\n      </g>\n    );\n  }\n}\n\nexport class HtmlSpinner extends React.Component<{ width: number; height: number }, {}> {\n  render() {\n    const { width, height } = this.props;\n    const size = Math.min(width, height);\n    return (\n      <svg width={width} height={height}>\n        <Spinner size={size} position={{ x: width / 2, y: height / 2 }} />\n      </svg>\n    );\n  }\n}\n","import { hashFnv32a } from '../data/utils';\nimport { RdfIri } from './sparql/sparqlModels';\n\nexport interface Dictionary<T> {\n  [key: string]: T;\n}\n\nexport interface LocalizedString {\n  readonly value: string;\n  readonly language: string;\n  /** Equals `xsd:string` if not defined. */\n  readonly datatype?: { readonly value: string };\n}\n\nexport interface IriProperty {\n  type: 'uri';\n  values: ReadonlyArray<RdfIri>;\n}\nexport interface LiteralProperty {\n  type: 'string';\n  values: ReadonlyArray<LocalizedString>;\n}\nexport type Property = IriProperty | LiteralProperty;\n\nexport function isIriProperty(e: Property): e is IriProperty {\n  return e && e.type === 'uri';\n}\nexport function isLiteralProperty(e: Property): e is LiteralProperty {\n  return e && e.type === 'string';\n}\n\nexport type ElementIri = string & { readonly elementBrand: void };\nexport type ElementTypeIri = string & { readonly classBrand: void };\nexport type LinkTypeIri = string & { readonly linkTypeBrand: void };\nexport type PropertyTypeIri = string & { readonly propertyTypeBrand: void };\n\nexport interface ElementModel {\n  id: ElementIri;\n  types: ElementTypeIri[];\n  label: { values: LocalizedString[] };\n  image?: string;\n  properties: { [id: string]: Property };\n  sources?: string[];\n}\n\nexport interface LinkModel {\n  linkTypeId: LinkTypeIri;\n  sourceId: ElementIri;\n  targetId: ElementIri;\n  properties?: { [id: string]: Property };\n}\n\nexport interface ClassModel {\n  id: ElementTypeIri;\n  label: { values: LocalizedString[] };\n  count?: number;\n  children: ClassModel[];\n}\n\nexport interface LinkCount {\n  id: LinkTypeIri;\n  inCount: number;\n  outCount: number;\n}\n\nexport interface LinkType {\n  id: LinkTypeIri;\n  label: { values: LocalizedString[] };\n  count?: number;\n}\n\nexport interface PropertyModel {\n  id: PropertyTypeIri;\n  label: { values: LocalizedString[] };\n}\n\nexport function sameLink(left: LinkModel, right: LinkModel) {\n  return left.linkTypeId === right.linkTypeId && left.sourceId === right.sourceId && left.targetId === right.targetId;\n}\n\nexport function hashLink(link: LinkModel): number {\n  const { linkTypeId, sourceId, targetId } = link;\n  let hash = hashFnv32a(linkTypeId);\n  hash = hash * 31 + hashFnv32a(sourceId);\n  hash = hash * 31 + hashFnv32a(targetId);\n  return hash;\n}\n\nexport function sameElement(left: ElementModel, right: ElementModel): boolean {\n  return (\n    left.id === right.id &&\n    isArraysEqual(left.types, right.types) &&\n    isLiteralsEqual(left.label.values, right.label.values) &&\n    left.image === right.image &&\n    isPropertiesEqual(left.properties, right.properties) &&\n    ((!left.sources && !right.sources) || (left.sources && right.sources && isArraysEqual(left.sources, right.sources)))\n  );\n}\n\nfunction isArraysEqual(left: string[], right: string[]): boolean {\n  if (left.length !== right.length) {\n    return false;\n  }\n  for (let i = 0; i < left.length; i++) {\n    if (left[i] !== right[i]) {\n      return false;\n    }\n  }\n  return true;\n}\n\nfunction isLiteralsEqual(left: ReadonlyArray<LocalizedString>, right: ReadonlyArray<LocalizedString>): boolean {\n  if (left.length !== right.length) {\n    return false;\n  }\n  for (let i = 0; i < left.length; i++) {\n    const leftValue = left[i];\n    const rightValue = right[i];\n    if (leftValue.value !== rightValue.value || leftValue.language !== rightValue.language) {\n      return false;\n    }\n  }\n  return true;\n}\n\nfunction isIriPropertiesEqual(left: Property, right: Property): boolean {\n  if (!isIriProperty(left) || !isIriProperty(right)) {\n    return false;\n  }\n  if (left.values.length !== right.values.length) {\n    return false;\n  }\n  for (let i = 0; i < left.values.length; i++) {\n    const leftValue = left.values[i];\n    const rightValue = right.values[i];\n    if (leftValue.value !== rightValue.value) {\n      return false;\n    }\n  }\n  return true;\n}\n\nfunction isLiteralPropertiesEqual(left: Property, right: Property): boolean {\n  if (!isLiteralProperty(left) || !isLiteralProperty(right)) {\n    return false;\n  }\n  return isLiteralsEqual(left.values, right.values);\n}\n\nfunction isPropertiesEqual(left: { [id: string]: Property }, right: { [id: string]: Property }) {\n  if (Object.keys(left).length !== Object.keys(right).length) {\n    return false;\n  }\n  for (const key in left.properties) {\n    if (left.properties.hasOwnProperty(key)) {\n      const leftProperty = left[key];\n      const rightProperty = right[key];\n      if (!rightProperty) {\n        return false;\n      }\n      if (\n        !isIriPropertiesEqual(leftProperty, rightProperty) &&\n        !isLiteralPropertiesEqual(leftProperty, rightProperty)\n      ) {\n        return false;\n      }\n    }\n  }\n  return true;\n}\n","export function objectValues<T>(obj: { [key: string]: T }): T[] {\n  const items: T[] = [];\n  for (const key in obj) {\n    if (!Object.prototype.hasOwnProperty.call(obj, key)) {\n      continue;\n    }\n    items.push(obj[key]);\n  }\n  return items;\n}\n\nexport function isEmptyMap(map: object) {\n  for (const key in map) {\n    if (Object.prototype.hasOwnProperty.call(map, key)) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Clones Map collection. Required due to IE11 not supporing `new Map(map)`.\n */\nexport function cloneMap<K, V>(map: ReadonlyMap<K, V>): Map<K, V> {\n  const clone = new Map<K, V>();\n  map.forEach((value, key) => clone.set(key, value));\n  return clone;\n}\n\n/**\n * Clones Set collection. Required due to IE11 not supporing `new Set(set)`.\n */\nexport function cloneSet<T>(set: ReadonlySet<T>): Set<T> {\n  const clone = new Set<T>();\n  set.forEach((item) => clone.add(item));\n  return clone;\n}\n\nexport function getOrCreateArrayInMap<K, V>(map: Map<K, V[]>, key: K): V[] {\n  let values = map.get(key);\n  if (!values) {\n    values = [];\n    map.set(key, values);\n  }\n  return values;\n}\n\nexport function getOrCreateSetInMap<K, V>(map: Map<K, Set<V>>, key: K): Set<V> {\n  let values = map.get(key);\n  if (!values) {\n    values = new Set();\n    map.set(key, values);\n  }\n  return values;\n}\n\nexport class OrderedMap<V> {\n  private mapping = new Map<string, V>();\n  private ordered: V[] = [];\n\n  reorder(compare: (a: V, b: V) => number) {\n    this.ordered.sort(compare);\n  }\n\n  get items(): ReadonlyArray<V> {\n    return this.ordered;\n  }\n\n  get(key: string): V | undefined {\n    return this.mapping.get(key);\n  }\n\n  push(key: string, value: V) {\n    if (this.mapping.has(key)) {\n      const previous = this.mapping.get(key);\n      if (previous === value) {\n        return;\n      }\n      const index = this.ordered.indexOf(previous);\n      this.ordered.splice(index, 1);\n    }\n    this.mapping.set(key, value);\n    this.ordered.push(value);\n  }\n\n  delete(key: string): V | undefined {\n    if (!this.mapping.has(key)) {\n      return undefined;\n    }\n    const previous = this.mapping.get(key);\n    const index = this.ordered.indexOf(previous);\n    this.ordered.splice(index, 1);\n    this.mapping.delete(key);\n    return previous;\n  }\n}\n\nexport interface ReadonlyHashMap<K, V> {\n  readonly size: number;\n  has(key: K): boolean;\n  get(key: K): V | undefined;\n  forEach(callback: (value: V, key: K, map: ReadonlyHashMap<K, V>) => void): void;\n  clone(): HashMap<K, V>;\n}\n\nexport class HashMap<K, V> implements ReadonlyHashMap<K, V> {\n  private readonly map = new Map<number, Array<{ key: K; value: V }>>();\n  private _size = 0;\n\n  constructor(private hashCode: (key: K) => number, private equals: (k1: K, k2: K) => boolean) {}\n\n  get size() {\n    return this._size;\n  }\n\n  has(key: K): boolean {\n    const items = this.map.get(this.hashCode(key));\n    if (!items) {\n      return false;\n    }\n    return Boolean(items.find((p) => this.equals(p.key, key)));\n  }\n\n  get(key: K): V | undefined {\n    const items = this.map.get(this.hashCode(key));\n    if (!items) {\n      return undefined;\n    }\n    const pair = items.find((p) => this.equals(p.key, key));\n    return pair ? pair.value : undefined;\n  }\n\n  set(key: K, value: V): this {\n    const hash = this.hashCode(key);\n    let items = this.map.get(hash);\n    if (items) {\n      const index = items.findIndex((p) => this.equals(p.key, key));\n      if (index >= 0) {\n        items.splice(index, 1);\n      } else {\n        this._size++;\n      }\n      items.push({ key, value });\n    } else {\n      items = [{ key, value }];\n      this.map.set(hash, items);\n      this._size++;\n    }\n    return this;\n  }\n\n  delete(key: K): boolean {\n    const items = this.map.get(this.hashCode(key));\n    if (!items) {\n      return false;\n    }\n    const index = items.findIndex((p) => this.equals(p.key, key));\n    if (index >= 0) {\n      items.splice(index, 1);\n      this._size--;\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  clear(): void {\n    this.map.clear();\n    this._size = 0;\n  }\n\n  forEach(callback: (value: V, key: K, map: HashMap<K, V>) => void) {\n    this.map.forEach((items) => {\n      for (const { key, value } of items) {\n        callback(value, key, this);\n      }\n    });\n  }\n\n  clone(): HashMap<K, V> {\n    const clone = new HashMap<K, V>(this.hashCode, this.equals);\n    clone._size = this.size;\n    this.map.forEach((value, key) => clone.map.set(key, [...value]));\n    return clone;\n  }\n}\n\nexport enum MoveDirection {\n  ToStart = -1,\n  ToEnd = 1,\n}\n\nexport function makeMoveComparator<T>(\n  items: ReadonlyArray<T>,\n  selected: ReadonlyArray<T>,\n  moveDirection: MoveDirection\n): (a: T, b: T) => number {\n  const orderMap = new Map<T, number>();\n  const selectionIndexOffset = moveDirection * items.length;\n\n  items.forEach((item, index) => {\n    orderMap.set(item, index);\n  });\n\n  for (const selectedItem of selected) {\n    orderMap.set(selectedItem, selectionIndexOffset + orderMap.get(selectedItem));\n  }\n\n  return (a: T, b: T) => {\n    const orderA = orderMap.get(a);\n    const orderB = orderMap.get(b);\n    return orderA > orderB ? 1 : orderA < orderB ? -1 : 0;\n  };\n}\n","import { ReactNode } from 'react';\nimport { hcl } from 'd3-color';\nimport { defaultsDeep, cloneDeep } from 'lodash';\nimport { ReactElement, MouseEvent } from 'react';\n\nimport {\n  LinkRouter,\n  TypeStyleResolver,\n  LinkTemplateResolver,\n  TemplateResolver,\n  ElementTemplate,\n  LinkTemplate,\n  RoutedLink,\n  RoutedLinks,\n} from '../customization/props';\nimport { DefaultTypeStyleBundle } from '../customization/defaultTypeStyles';\nimport { DefaultLinkTemplateBundle } from '../customization/defaultLinkStyles';\nimport { StandardTemplate, DefaultElementTemplateBundle } from '../customization/templates';\n\nimport { ElementModel, LocalizedString, ElementTypeIri, LinkTypeIri } from '../data/model';\nimport { isEncodedBlank } from '../data/sparql/blankNodes';\nimport { hashFnv32a, getUriLocalName } from '../data/utils';\n\nimport { Events, EventSource, EventObserver, PropertyChange } from '../viewUtils/events';\n\nimport { Element, Link, FatLinkType } from './elements';\nimport { Vector, isPolylineEqual } from './geometry';\nimport { DefaultLinkRouter } from './linkRouter';\nimport { DiagramModel } from './model';\n\nexport enum IriClickIntent {\n  JumpToEntity = 'jumpToEntity',\n  OpenEntityIri = 'openEntityIri',\n  OpenOtherIri = 'openOtherIri',\n}\nexport interface IriClickEvent {\n  iri: string;\n  element: Element;\n  clickIntent: IriClickIntent;\n  originalEvent: MouseEvent<any>;\n}\nexport type IriClickHandler = (event: IriClickEvent) => void;\n\nexport type LabelLanguageSelector = (\n  labels: ReadonlyArray<LocalizedString>,\n  language: string\n) => LocalizedString | undefined;\n\nexport interface ViewOptions {\n  typeStyleResolver?: TypeStyleResolver;\n  linkTemplateResolver?: LinkTemplateResolver;\n  elementTemplateResolver?: TemplateResolver;\n  selectLabelLanguage?: LabelLanguageSelector;\n  linkRouter?: LinkRouter;\n  onIriClick?: IriClickHandler;\n}\n\nexport interface TypeStyle {\n  color: { h: number; c: number; l: number };\n  icon?: string;\n}\n\nexport enum RenderingLayer {\n  Element = 1,\n  ElementSize,\n  PaperArea,\n  Link,\n  Editor,\n\n  FirstToUpdate = Element,\n  LastToUpdate = Editor,\n}\n\nexport interface DiagramViewEvents {\n  changeLanguage: PropertyChange<DiagramView, string>;\n  changeLinkTemplates: {};\n  syncUpdate: { layer: RenderingLayer };\n  updateWidgets: UpdateWidgetsEvent;\n  dispose: {};\n  changeHighlight: PropertyChange<DiagramView, Highlighter>;\n  updateRoutings: PropertyChange<DiagramView, RoutedLinks>;\n}\n\nexport interface UpdateWidgetsEvent {\n  widgets: { [key: string]: WidgetDescription };\n}\n\nexport enum WidgetAttachment {\n  Viewport = 1,\n  OverElements,\n  OverLinks,\n}\n\nexport interface WidgetDescription {\n  element: ReactElement<any>;\n  attachment: WidgetAttachment;\n}\n\nexport interface DropOnPaperEvent {\n  dragEvent: DragEvent;\n  paperPosition: Vector;\n}\n\nexport type Highlighter = ((item: Element | Link) => boolean) | undefined;\n\nexport type ElementDecoratorResolver = (element: Element) => ReactNode | undefined;\n\nexport class DiagramView {\n  private readonly listener = new EventObserver();\n  private readonly source = new EventSource<DiagramViewEvents>();\n  readonly events: Events<DiagramViewEvents> = this.source;\n\n  private disposed = false;\n\n  private readonly colorSeed = 0x0badbeef;\n\n  private readonly resolveTypeStyle: TypeStyleResolver;\n  private readonly resolveLinkTemplate: LinkTemplateResolver;\n  private readonly resolveElementTemplate: TemplateResolver;\n\n  private _language = 'en';\n\n  private linkTemplates = new Map<LinkTypeIri, LinkTemplate>();\n  private router: LinkRouter;\n  private routings: RoutedLinks = new Map<string, RoutedLink>();\n  private dropOnPaperHandler: ((e: DropOnPaperEvent) => void) | undefined;\n\n  private _highlighter: Highlighter;\n\n  private _elementDecorator: ElementDecoratorResolver;\n\n  constructor(public readonly model: DiagramModel, public readonly options: ViewOptions = {}) {\n    this.resolveTypeStyle = options.typeStyleResolver || DefaultTypeStyleBundle;\n    this.resolveLinkTemplate = options.linkTemplateResolver || DefaultLinkTemplateBundle;\n    this.resolveElementTemplate = options.elementTemplateResolver || DefaultElementTemplateBundle;\n\n    this.initRouting();\n  }\n\n  private initRouting() {\n    this.router = this.options.linkRouter || new DefaultLinkRouter();\n    this.updateRoutings();\n\n    this.listener.listen(this.model.events, 'changeCells', () => this.updateRoutings());\n    this.listener.listen(this.model.events, 'linkEvent', ({ key, data }) => {\n      if (data.changeVertices) {\n        this.updateRoutings();\n      }\n    });\n    this.listener.listen(this.model.events, 'elementEvent', ({ key, data }) => {\n      if (data.changePosition || data.changeSize) {\n        this.updateRoutings();\n      }\n    });\n  }\n\n  private updateRoutings() {\n    const previousRoutes = this.routings;\n    const computedRoutes = this.router.route(this.model);\n    previousRoutes.forEach((previous, linkId) => {\n      const computed = computedRoutes.get(linkId);\n      if (computed && sameRoutedLink(previous, computed)) {\n        // replace new route with the old one if they're equal\n        // so other components can use a simple reference equality checks\n        computedRoutes.set(linkId, previous);\n      }\n    });\n    this.routings = computedRoutes;\n    this.source.trigger('updateRoutings', { source: this, previous: previousRoutes });\n  }\n\n  getRoutings() {\n    return this.routings;\n  }\n\n  getRouting(linkId: string): RoutedLink {\n    return this.routings.get(linkId);\n  }\n\n  getLanguage(): string {\n    return this._language;\n  }\n  setLanguage(value: string) {\n    if (!value) {\n      throw new Error('Cannot set empty language.');\n    }\n    const previous = this._language;\n    if (previous === value) {\n      return;\n    }\n    this._language = value;\n    this.source.trigger('changeLanguage', { source: this, previous });\n  }\n\n  getLinkTemplates(): ReadonlyMap<LinkTypeIri, LinkTemplate> {\n    return this.linkTemplates;\n  }\n\n  performSyncUpdate() {\n    for (let layer = RenderingLayer.FirstToUpdate; layer <= RenderingLayer.LastToUpdate; layer++) {\n      this.source.trigger('syncUpdate', { layer });\n    }\n  }\n\n  onIriClick(iri: string, element: Element, clickIntent: IriClickIntent, event: React.MouseEvent<any>) {\n    event.persist();\n    event.preventDefault();\n    const { onIriClick } = this.options;\n    if (onIriClick) {\n      onIriClick({ iri, element, clickIntent, originalEvent: event });\n    }\n  }\n\n  setPaperWidget(widget: { key: string; widget: ReactElement<any> | undefined; attachment: WidgetAttachment }) {\n    const { key, widget: element, attachment } = widget;\n    const widgets = { [key]: element ? { element, attachment } : undefined };\n    this.source.trigger('updateWidgets', { widgets });\n  }\n\n  setHandlerForNextDropOnPaper(handler: (e: DropOnPaperEvent) => void) {\n    this.dropOnPaperHandler = handler;\n  }\n\n  _tryHandleDropOnPaper(e: DropOnPaperEvent): boolean {\n    const { dropOnPaperHandler } = this;\n    if (dropOnPaperHandler) {\n      this.dropOnPaperHandler = undefined;\n      dropOnPaperHandler(e);\n      return true;\n    }\n    return false;\n  }\n\n  selectLabel(labels: ReadonlyArray<LocalizedString>, language?: string): LocalizedString | undefined {\n    const targetLanguage = typeof language === 'undefined' ? this.getLanguage() : language;\n    const { selectLabelLanguage = defaultSelectLabel } = this.options;\n    return selectLabelLanguage(labels, targetLanguage);\n  }\n\n  formatLabel(labels: ReadonlyArray<LocalizedString>, fallbackIri: string, language?: string): string {\n    const label = this.selectLabel(labels, language);\n    return resolveLabel(label, fallbackIri);\n  }\n\n  public getElementTypeString(elementModel: ElementModel): string {\n    return elementModel.types\n      .map((typeId) => {\n        const type = this.model.createClass(typeId);\n        return this.formatLabel(type.label, type.id);\n      })\n      .sort()\n      .join(', ');\n  }\n\n  public getTypeStyle(types: ElementTypeIri[]): TypeStyle {\n    types.sort();\n\n    const customStyle = this.resolveTypeStyle(types);\n\n    const icon = customStyle ? customStyle.icon : undefined;\n    let color: { h: number; c: number; l: number };\n    if (customStyle && customStyle.color) {\n      color = hcl(customStyle.color);\n    } else {\n      const hue = getHueFromClasses(types, this.colorSeed);\n      color = { h: hue, c: 40, l: 75 };\n    }\n    return { icon, color };\n  }\n\n  formatIri(iri: string): string {\n    if (isEncodedBlank(iri)) {\n      return '(blank node)';\n    }\n    return `<${iri}>`;\n  }\n\n  public getElementTemplate(types: ElementTypeIri[]): ElementTemplate {\n    return this.resolveElementTemplate(types) || StandardTemplate;\n  }\n\n  createLinkTemplate(linkType: FatLinkType): LinkTemplate {\n    const existingTemplate = this.linkTemplates.get(linkType.id);\n    if (existingTemplate) {\n      return existingTemplate;\n    }\n\n    let template: LinkTemplate = {};\n    const result = this.resolveLinkTemplate(linkType.id);\n    if (result) {\n      template = cloneDeep(result);\n    }\n\n    fillLinkTemplateDefaults(template);\n    this.linkTemplates.set(linkType.id, template);\n    this.source.trigger('changeLinkTemplates', {});\n    return template;\n  }\n\n  dispose() {\n    if (this.disposed) {\n      return;\n    }\n    this.source.trigger('dispose', {});\n    this.listener.stopListening();\n    this.disposed = true;\n  }\n\n  get highlighter() {\n    return this._highlighter;\n  }\n  setHighlighter(value: Highlighter) {\n    const previous = this._highlighter;\n    if (previous === value) {\n      return;\n    }\n    this._highlighter = value;\n    this.source.trigger('changeHighlight', { source: this, previous });\n  }\n\n  _setElementDecorator(decorator: ElementDecoratorResolver) {\n    this._elementDecorator = decorator;\n  }\n\n  _decorateElement(element: Element): ReactNode | undefined {\n    return this._elementDecorator(element);\n  }\n}\n\nfunction sameRoutedLink(a: RoutedLink, b: RoutedLink) {\n  return a.linkId === b.linkId && a.labelTextAnchor === b.labelTextAnchor && isPolylineEqual(a.vertices, b.vertices);\n}\n\nfunction getHueFromClasses(classes: ReadonlyArray<ElementTypeIri>, seed?: number): number {\n  let hash = seed;\n  for (const name of classes) {\n    hash = hashFnv32a(name, hash);\n  }\n  const MAX_INT32 = 0x7fffffff;\n  return 360 * ((hash === undefined ? 0 : hash) / MAX_INT32);\n}\n\nfunction fillLinkTemplateDefaults(template: LinkTemplate) {\n  const defaults: Partial<LinkTemplate> = {\n    markerTarget: { d: 'M0,0 L0,8 L9,4 z', width: 9, height: 8, fill: 'black' },\n  };\n  defaultsDeep(template, defaults);\n  if (!template.renderLink) {\n    template.renderLink = () => ({});\n  }\n}\n\nfunction defaultSelectLabel(texts: ReadonlyArray<LocalizedString>, language: string): LocalizedString | undefined {\n  if (texts.length === 0) {\n    return undefined;\n  }\n  let defaultValue: LocalizedString;\n  let englishValue: LocalizedString;\n  for (const text of texts) {\n    if (text.language === language) {\n      return text;\n    } else if (text.language === '') {\n      defaultValue = text;\n    } else if (text.language === 'en') {\n      englishValue = text;\n    }\n  }\n  return defaultValue !== undefined ? defaultValue : englishValue !== undefined ? englishValue : texts[0];\n}\n\nfunction resolveLabel(label: LocalizedString | undefined, fallbackIri: string): string {\n  if (label) {\n    return label.value;\n  }\n  return getUriLocalName(fallbackIri) || fallbackIri;\n}\n","import { ElementModel, LinkModel, ElementIri, sameLink, hashLink } from '../data/model';\n\nimport { HashMap, ReadonlyHashMap, cloneMap } from '../viewUtils/collections';\n\nexport interface AuthoringState {\n  readonly elements: ReadonlyMap<ElementIri, ElementChange>;\n  readonly links: ReadonlyHashMap<LinkModel, LinkChange>;\n}\n\nexport type AuthoringEvent = ElementChange | LinkChange;\n\nexport enum AuthoringKind {\n  ChangeElement = 'changeElement',\n  ChangeLink = 'changeLink',\n}\n\nexport interface ElementChange {\n  readonly type: AuthoringKind.ChangeElement;\n  readonly before?: ElementModel;\n  readonly after: ElementModel;\n  readonly newIri?: ElementIri;\n  readonly deleted: boolean;\n}\n\nexport interface LinkChange {\n  readonly type: AuthoringKind.ChangeLink;\n  readonly before?: LinkModel;\n  readonly after: LinkModel;\n  readonly deleted: boolean;\n}\n\ninterface MutableAuthoringState extends AuthoringState {\n  readonly elements: Map<ElementIri, ElementChange>;\n  readonly links: HashMap<LinkModel, LinkChange>;\n}\n\nexport namespace AuthoringState {\n  export const empty: AuthoringState = {\n    elements: new Map<ElementIri, ElementChange>(),\n    links: new HashMap<LinkModel, LinkChange>(hashLink, sameLink),\n  };\n\n  export function isEmpty(state: AuthoringState) {\n    return state.elements.size === 0 && state.links.size === 0;\n  }\n\n  export function clone(index: AuthoringState): MutableAuthoringState {\n    return {\n      elements: cloneMap(index.elements),\n      links: index.links.clone(),\n    };\n  }\n\n  export function has(state: AuthoringState, event: AuthoringEvent): boolean {\n    return event.type === AuthoringKind.ChangeElement\n      ? state.elements.get(event.after.id) === event\n      : state.links.get(event.after) === event;\n  }\n\n  export function discard(state: AuthoringState, discarded: AuthoringEvent): AuthoringState {\n    if (!has(state, discarded)) {\n      return state;\n    }\n    const newState = clone(state);\n    if (discarded.type === AuthoringKind.ChangeElement) {\n      newState.elements.delete(discarded.after.id);\n      if (!discarded.before) {\n        state.links.forEach((e) => {\n          if (isLinkConnectedToElement(e.after, discarded.after.id)) {\n            newState.links.delete(e.after);\n          }\n        });\n      }\n    } else {\n      newState.links.delete(discarded.after);\n    }\n    return newState;\n  }\n\n  export function addElement(state: AuthoringState, item: ElementModel): AuthoringState {\n    const event: ElementChange = { type: AuthoringKind.ChangeElement, after: item, deleted: false };\n    const newState = clone(state);\n    newState.elements.set(event.after.id, event);\n    return newState;\n  }\n\n  export function addLink(state: AuthoringState, item: LinkModel): AuthoringState {\n    const event: LinkChange = { type: AuthoringKind.ChangeLink, after: item, deleted: false };\n    const newState = clone(state);\n    newState.links.set(event.after, event);\n    return newState;\n  }\n\n  export function changeElement(state: AuthoringState, before: ElementModel, after: ElementModel): AuthoringState {\n    const newState = clone(state);\n    // delete previous state for an entity\n    newState.elements.delete(before.id);\n\n    const previous = state.elements.get(before.id);\n    if (previous && !previous.before) {\n      // adding or changing new entity\n      newState.elements.set(after.id, {\n        type: AuthoringKind.ChangeElement,\n        after,\n        deleted: false,\n      });\n      if (before.id !== after.id) {\n        state.links.forEach((e) => {\n          if (!e.before && isLinkConnectedToElement(e.after, before.id)) {\n            const updatedLink = updateLinkToReferByNewIri(e.after, before.id, after.id);\n            newState.links.delete(e.after);\n            newState.links.set(updatedLink, {\n              type: AuthoringKind.ChangeLink,\n              after: updatedLink,\n              deleted: false,\n            });\n          }\n        });\n      }\n    } else {\n      // changing existing entity\n      const iriChanged = after.id !== before.id;\n      const previousBefore = previous ? previous.before : undefined;\n      newState.elements.set(before.id, {\n        type: AuthoringKind.ChangeElement,\n        // always initialize 'before', otherwise entity will be considered new\n        before: previousBefore || before,\n        after: iriChanged ? { ...after, id: before.id } : after,\n        newIri: iriChanged ? after.id : undefined,\n        deleted: false,\n      });\n    }\n\n    return newState;\n  }\n\n  export function changeLink(state: AuthoringState, before: LinkModel, after: LinkModel): AuthoringState {\n    if (!sameLink(before, after)) {\n      throw new Error('Cannot move link to another element or change its type');\n    }\n    const newState = clone(state);\n    const previous = state.links.get(before);\n    newState.links.set(before, {\n      type: AuthoringKind.ChangeLink,\n      before: previous ? previous.before : undefined,\n      after: after,\n      deleted: false,\n    });\n    return newState;\n  }\n\n  export function deleteElement(state: AuthoringState, model: ElementModel): AuthoringState {\n    const newState = clone(state);\n    newState.elements.delete(model.id);\n    state.links.forEach((e) => {\n      if (isLinkConnectedToElement(e.after, model.id)) {\n        newState.links.delete(e.after);\n      }\n    });\n    if (!isNewElement(state, model.id)) {\n      newState.elements.set(model.id, {\n        type: AuthoringKind.ChangeElement,\n        before: model,\n        after: model,\n        deleted: true,\n      });\n    }\n    return newState;\n  }\n\n  export function deleteLink(state: AuthoringState, target: LinkModel): AuthoringState {\n    const newState = clone(state);\n    newState.links.delete(target);\n    if (!isNewLink(state, target)) {\n      newState.links.set(target, {\n        type: AuthoringKind.ChangeLink,\n        before: target,\n        after: target,\n        deleted: true,\n      });\n    }\n    return newState;\n  }\n\n  export function deleteNewLinksConnectedToElements(\n    state: AuthoringState,\n    elementIris: Set<ElementIri>\n  ): AuthoringState {\n    const newState = clone(state);\n    state.links.forEach((e) => {\n      if (!e.before) {\n        const target = e.after;\n        if (elementIris.has(target.sourceId) || elementIris.has(target.targetId)) {\n          newState.links.delete(target);\n        }\n      }\n    });\n    return newState;\n  }\n\n  export function isNewElement(state: AuthoringState, target: ElementIri): boolean {\n    const event = state.elements.get(target);\n    return event && event.type === AuthoringKind.ChangeElement && !event.before;\n  }\n\n  export function isDeletedElement(state: AuthoringState, target: ElementIri): boolean {\n    const event = state.elements.get(target);\n    return event && event.deleted;\n  }\n\n  export function isElementWithModifiedIri(state: AuthoringState, target: ElementIri): boolean {\n    const event = state.elements.get(target);\n    return event && event.type === AuthoringKind.ChangeElement && event.before && Boolean(event.newIri);\n  }\n\n  export function isNewLink(state: AuthoringState, linkModel: LinkModel): boolean {\n    const event = state.links.get(linkModel);\n    return event && !event.before;\n  }\n\n  export function isDeletedLink(state: AuthoringState, linkModel: LinkModel): boolean {\n    const event = state.links.get(linkModel);\n    return (\n      (event && event.deleted) ||\n      isDeletedElement(state, linkModel.sourceId) ||\n      isDeletedElement(state, linkModel.targetId)\n    );\n  }\n\n  export function isUncertainLink(state: AuthoringState, linkModel: LinkModel): boolean {\n    return (\n      !isDeletedLink(state, linkModel) &&\n      (isElementWithModifiedIri(state, linkModel.sourceId) || isElementWithModifiedIri(state, linkModel.targetId))\n    );\n  }\n}\n\nexport interface TemporaryState {\n  readonly elements: ReadonlyMap<ElementIri, ElementModel>;\n  readonly links: ReadonlyHashMap<LinkModel, LinkModel>;\n}\n\nexport namespace TemporaryState {\n  export const empty: TemporaryState = {\n    elements: new Map<ElementIri, ElementModel>(),\n    links: new HashMap<LinkModel, LinkModel>(hashLink, sameLink),\n  };\n\n  export function addElement(state: TemporaryState, element: ElementModel) {\n    const elements = cloneMap(state.elements);\n    elements.set(element.id, element);\n    return { ...state, elements };\n  }\n\n  export function deleteElement(state: TemporaryState, element: ElementModel) {\n    const elements = cloneMap(state.elements);\n    elements.delete(element.id);\n    return { ...state, elements };\n  }\n\n  export function addLink(state: TemporaryState, link: LinkModel) {\n    const links = state.links.clone();\n    links.set(link, link);\n    return { ...state, links };\n  }\n  export function deleteLink(state: TemporaryState, link: LinkModel) {\n    const links = state.links.clone();\n    links.delete(link);\n    return { ...state, links };\n  }\n}\n\nexport function isLinkConnectedToElement(link: LinkModel, elementIri: ElementIri) {\n  return link.sourceId === elementIri || link.targetId === elementIri;\n}\n\nfunction updateLinkToReferByNewIri(link: LinkModel, oldIri: ElementIri, newIri: ElementIri): LinkModel {\n  return {\n    ...link,\n    sourceId: link.sourceId === oldIri ? newIri : link.sourceId,\n    targetId: link.targetId === oldIri ? newIri : link.targetId,\n  };\n}\n","import { ElementModel, ElementIri, LinkModel, sameLink } from '../data/model';\n\nimport { Element, Link, FatLinkType, Cell, LinkVertex } from './elements';\nimport { Vector, isPolylineEqual } from './geometry';\nimport { Command } from './history';\nimport { DiagramModel } from './model';\n\nexport class RestoreGeometry implements Command {\n  readonly title = 'Move elements and links';\n\n  constructor(\n    private elementState: ReadonlyArray<{ element: Element; position: Vector }>,\n    private linkState: ReadonlyArray<{ link: Link; vertices: ReadonlyArray<Vector> }>\n  ) {}\n\n  static capture(model: DiagramModel) {\n    return RestoreGeometry.captureElementsAndLinks(model.elements, model.links);\n  }\n\n  private static captureElementsAndLinks(elements: ReadonlyArray<Element>, links: ReadonlyArray<Link>) {\n    return new RestoreGeometry(\n      elements.map((element) => ({ element, position: element.position })),\n      links.map((link) => ({ link, vertices: link.vertices }))\n    );\n  }\n\n  hasChanges() {\n    return this.elementState.length > 0 || this.linkState.length > 0;\n  }\n\n  filterOutUnchanged(): RestoreGeometry {\n    return new RestoreGeometry(\n      this.elementState.filter(({ element, position }) => !Vector.equals(element.position, position)),\n      this.linkState.filter(({ link, vertices }) => !isPolylineEqual(link.vertices, vertices))\n    );\n  }\n\n  invoke(): RestoreGeometry {\n    const previous = RestoreGeometry.captureElementsAndLinks(\n      this.elementState.map((state) => state.element),\n      this.linkState.map((state) => state.link)\n    );\n    // restore in reverse order to workaround position changed event\n    // handling in EmbeddedLayer inside nested elements\n    // (child's position change causes group to resize or move itself)\n    for (const { element, position } of [...this.elementState].reverse()) {\n      element.setPosition(position);\n    }\n    for (const { link, vertices } of this.linkState) {\n      link.setVertices(vertices);\n    }\n    return previous;\n  }\n}\n\nexport function restoreCapturedLinkGeometry(link: Link): Command {\n  const vertices = link.vertices;\n  return Command.create('Change link vertices', () => {\n    const capturedInverse = restoreCapturedLinkGeometry(link);\n    link.setVertices(vertices);\n    return capturedInverse;\n  });\n}\n\nexport function setElementExpanded(element: Element, expanded: boolean): Command {\n  const title = expanded ? 'Expand element' : 'Collapse element';\n  return Command.create(title, () => {\n    element.setExpanded(expanded);\n    return setElementExpanded(element, !expanded);\n  });\n}\n\nexport function changeLinkTypeVisibility(params: {\n  linkType: FatLinkType;\n  visible: boolean;\n  showLabel: boolean;\n  preventLoading?: boolean;\n}): Command {\n  const { linkType, visible, showLabel, preventLoading } = params;\n  return Command.create('Change link type visibility', () => {\n    const previousVisible = linkType.visible;\n    const previousShowLabel = linkType.showLabel;\n    linkType.setVisibility({ visible, showLabel, preventLoading });\n    return changeLinkTypeVisibility({\n      linkType,\n      visible: previousVisible,\n      showLabel: previousShowLabel,\n      preventLoading,\n    });\n  });\n}\n\nexport function setElementData(model: DiagramModel, target: ElementIri, data: ElementModel): Command {\n  const elements = model.elements.filter((el) => el.iri === target);\n  const previous = elements.length > 0 ? elements[0].data : undefined;\n  return Command.create('Set element data', () => {\n    for (const element of model.elements.filter((el) => el.iri === target)) {\n      element.setData(data);\n    }\n    return setElementData(model, data.id, previous);\n  });\n}\n\nexport function setLinkData(model: DiagramModel, oldData: LinkModel, newData: LinkModel): Command {\n  if (!sameLink(oldData, newData)) {\n    throw new Error('Cannot change typeId, sourceId or targetId when changing link data');\n  }\n  return Command.create('Set link data', () => {\n    for (const link of model.links) {\n      if (sameLink(link.data, oldData)) {\n        link.setData(newData);\n      }\n    }\n    return setLinkData(model, newData, oldData);\n  });\n}\n","import * as React from 'react';\n\nimport { Debouncer, Cancellation, animateInterval, delay, easeInOutBezier } from '../viewUtils/async';\nimport { EventObserver, Events, EventSource, PropertyChange } from '../viewUtils/events';\nimport { PropTypes } from '../viewUtils/react';\nimport { ToSVGOptions, ToDataURLOptions, toSVG, toDataURL, fitRectKeepingAspectRatio } from '../viewUtils/toSvg';\n\nimport { RestoreGeometry } from './commands';\nimport { Element, Link, Cell, LinkVertex } from './elements';\nimport { Vector, Rect, computePolyline, findNearestSegmentIndex } from './geometry';\nimport { Batch } from './history';\nimport { DiagramView, RenderingLayer, WidgetDescription, WidgetAttachment } from './view';\nimport { Paper, PaperTransform } from './paper';\n\nexport interface PaperAreaProps {\n  view: DiagramView;\n  zoomOptions?: ZoomOptions;\n  hideScrollBars?: boolean;\n  onDragDrop?: (e: DragEvent, paperPosition: { x: number; y: number }) => void;\n  onZoom?: (scaleX: number, scaleY: number) => void;\n}\n\nexport interface ZoomOptions {\n  min?: number;\n  max?: number;\n  step?: number;\n  /** Used when zooming to fit to limit zoom of small diagrams */\n  maxFit?: number;\n  fitPadding?: number;\n  requireCtrl?: boolean;\n}\n\nexport interface PaperAreaEvents {\n  pointerDown: PointerEvent;\n  pointerMove: PointerEvent;\n  pointerUp: PointerUpEvent;\n  scroll: { source: PaperArea };\n  changeAnimatingGraph: PropertyChange<PaperArea, boolean>;\n}\n\nexport interface PointerEvent {\n  source: PaperArea;\n  sourceEvent: React.MouseEvent<Element> | MouseEvent;\n  target: Cell | undefined;\n  panning: boolean;\n}\n\nexport interface PointerUpEvent extends PointerEvent {\n  triggerAsClick: boolean;\n}\n\nexport interface PaperWidgetProps {\n  paperArea?: PaperArea;\n  paperTransform?: PaperTransform;\n}\n\nexport interface State {\n  readonly paperWidth?: number;\n  readonly paperHeight?: number;\n  readonly originX?: number;\n  readonly originY?: number;\n  readonly scale?: number;\n  readonly paddingX?: number;\n  readonly paddingY?: number;\n  readonly renderedWidgets?: ReadonlyArray<WidgetDescription>;\n}\n\nexport interface PaperAreaContextWrapper {\n  ontodiaPaperArea: PaperAreaContext;\n}\n\nexport interface PaperAreaContext {\n  paperArea: PaperArea;\n  view: DiagramView;\n}\n\nexport const PaperAreaContextTypes: { [K in keyof PaperAreaContextWrapper]: any } = {\n  ontodiaPaperArea: PropTypes.anything,\n};\n\ninterface PointerMoveState {\n  pointerMoved: boolean;\n  target: Cell | undefined;\n  panning: boolean;\n  origin: {\n    readonly pageX: number;\n    readonly pageY: number;\n  };\n  batch: Batch;\n  restoreGeometry: RestoreGeometry;\n}\n\ninterface ViewportState {\n  /** Center of the viewport in paper coordinates. */\n  readonly center: Vector;\n  readonly scale: Vector;\n}\n\ninterface ViewportAnimation {\n  readonly from: ViewportState;\n  readonly to: ViewportState;\n  readonly cancellation: Cancellation;\n}\n\nexport interface ViewportOptions {\n  /**\n   * True if operation should be animated.\n   * If duration is not provided assumes default one.\n   */\n  animate?: boolean;\n  /**\n   * Animation duration in milliseconds.\n   * Implicitly sets `animate: true` if greater than zero.\n   */\n  duration?: number;\n  /**\n   * Elements to apply layout and zoomToFit operations.\n   * (In other words we narrowing down viewPort to selected elements)\n   */\n  elements?: ReadonlySet<Element>;\n}\n\nexport interface ScaleOptions extends ViewportOptions {\n  pivot?: { x: number; y: number };\n}\n\nconst CLASS_NAME = 'ontodia-paper-area';\nconst DEFAULT_ANIMATION_DURATION = 500;\nconst LEFT_MOUSE_BUTTON = 0;\n\nexport class PaperArea extends React.Component<PaperAreaProps, State> {\n  static childContextTypes = PaperAreaContextTypes;\n\n  private readonly listener = new EventObserver();\n  private readonly source = new EventSource<PaperAreaEvents>();\n  readonly events: Events<PaperAreaEvents> = this.source;\n\n  private outer: HTMLDivElement;\n  private area: HTMLDivElement;\n  private widgets: { [key: string]: WidgetDescription } = {};\n\n  private readonly pageSize = { x: 1500, y: 800 };\n\n  private viewportAnimation: ViewportAnimation | undefined;\n  private cssAnimations = 0;\n\n  private movingState: PointerMoveState | undefined;\n  private panningScrollOrigin: { scrollLeft: number; scrollTop: number };\n  private movingElementOrigin: {\n    pointerX: number;\n    pointerY: number;\n    elementX: number;\n    elementY: number;\n  };\n\n  private delayedPaperAdjust = new Debouncer();\n  private scrollBeforeUpdate:\n    | undefined\n    | {\n        left: number;\n        top: number;\n      };\n\n  private get zoomOptions(): ZoomOptions {\n    const { min = 0.2, max = 2, step = 0.1, maxFit = 1, fitPadding = 20, requireCtrl = true } =\n      this.props.zoomOptions || {};\n    return { min, max, step, maxFit, fitPadding, requireCtrl };\n  }\n\n  constructor(props: PaperAreaProps, context: any) {\n    super(props, context);\n    this.state = {\n      paperWidth: this.pageSize.x,\n      paperHeight: this.pageSize.y,\n      originX: 0,\n      originY: 0,\n      scale: 1,\n      paddingX: 0,\n      paddingY: 0,\n      renderedWidgets: [],\n    };\n  }\n\n  getChildContext(): PaperAreaContextWrapper {\n    const { view } = this.props;\n    const ontodiaPaperArea: PaperAreaContext = { paperArea: this, view };\n    return { ontodiaPaperArea };\n  }\n\n  render() {\n    const { view } = this.props;\n    const { paperWidth, paperHeight, originX, originY, scale, paddingX, paddingY, renderedWidgets } = this.state;\n    const paperTransform: PaperTransform = {\n      width: paperWidth,\n      height: paperHeight,\n      originX,\n      originY,\n      scale,\n      paddingX,\n      paddingY,\n    };\n    const widgetProps: PaperWidgetProps = { paperArea: this, paperTransform };\n\n    let areaClass = `${CLASS_NAME}__area`;\n    if (this.props.hideScrollBars) {\n      areaClass += ` ${CLASS_NAME}--hide-scrollbars`;\n    }\n\n    let componentClass = CLASS_NAME;\n    if (this.isAnimatingGraph()) {\n      componentClass += ` ${CLASS_NAME}--animated`;\n    }\n\n    return (\n      <div className={componentClass} ref={this.onOuterMount}>\n        <div className={areaClass} ref={this.onAreaMount} onMouseDown={this.onAreaPointerDown}>\n          <Paper\n            view={view}\n            paperTransform={paperTransform}\n            onPointerDown={this.onPaperPointerDown}\n            linkLayerWidgets={\n              <div className={`${CLASS_NAME}__widgets`} onMouseDown={this.onWidgetsMouseDown}>\n                {renderedWidgets\n                  .filter((w) => w.attachment === WidgetAttachment.OverLinks)\n                  .map((widget) => React.cloneElement(widget.element, widgetProps))}\n              </div>\n            }\n            elementLayerWidgets={\n              <div className={`${CLASS_NAME}__widgets`} onMouseDown={this.onWidgetsMouseDown}>\n                {renderedWidgets\n                  .filter((w) => w.attachment === WidgetAttachment.OverElements)\n                  .map((widget) => React.cloneElement(widget.element, widgetProps))}\n              </div>\n            }\n          />\n        </div>\n        {renderedWidgets\n          .filter((w) => w.attachment === WidgetAttachment.Viewport)\n          .map((widget) => {\n            return React.cloneElement(widget.element, widgetProps);\n          })}\n      </div>\n    );\n  }\n\n  private onOuterMount = (outer: HTMLDivElement) => {\n    this.outer = outer;\n  };\n  private onAreaMount = (area: HTMLDivElement) => {\n    this.area = area;\n  };\n\n  componentDidMount() {\n    this.adjustPaper(() => this.centerTo());\n\n    const { view } = this.props;\n    const delayedAdjust = () => this.delayedPaperAdjust.call(this.adjustPaper);\n    this.listener.listen(view.model.events, 'changeCells', delayedAdjust);\n    this.listener.listen(view.model.events, 'elementEvent', ({ data }) => {\n      if (data.changePosition || data.changeSize) {\n        delayedAdjust();\n      }\n    });\n    this.listener.listen(view.model.events, 'linkEvent', ({ data }) => {\n      if (data.changeVertices) {\n        delayedAdjust();\n      }\n    });\n    this.listener.listen(view.events, 'syncUpdate', ({ layer }) => {\n      if (layer !== RenderingLayer.PaperArea) {\n        return;\n      }\n      this.delayedPaperAdjust.runSynchronously();\n    });\n    this.listener.listen(view.events, 'updateWidgets', ({ widgets }) => {\n      this.updateWidgets(widgets);\n    });\n\n    this.area.addEventListener('dragover', this.onDragOver);\n    this.area.addEventListener('drop', this.onDragDrop);\n    this.area.addEventListener('scroll', this.onScroll);\n    this.area.addEventListener('wheel', this.onWheel, { passive: false });\n  }\n\n  componentDidUpdate(prevProps: PaperAreaProps, prevState: State) {\n    if (this.scrollBeforeUpdate) {\n      const { scale, originX, originY, paddingX, paddingY } = this.state;\n      const scrollX = (originX - prevState.originX) * scale + (paddingX - prevState.paddingX);\n      const scrollY = (originY - prevState.originY) * scale + (paddingY - prevState.paddingY);\n\n      const scrollLeft = this.scrollBeforeUpdate.left + scrollX;\n      const scrollTop = this.scrollBeforeUpdate.top + scrollY;\n\n      this.area.scrollLeft = scrollLeft;\n      this.area.scrollTop = scrollTop;\n\n      this.scrollBeforeUpdate = undefined;\n    }\n  }\n\n  componentWillUnmount() {\n    this.stopListeningToPointerMove();\n    this.listener.stopListening();\n    this.area.removeEventListener('dragover', this.onDragOver);\n    this.area.removeEventListener('drop', this.onDragDrop);\n    this.area.removeEventListener('scroll', this.onScroll);\n    this.area.removeEventListener('wheel', this.onWheel);\n  }\n\n  private updateWidgets(update: { [key: string]: WidgetDescription }) {\n    this.widgets = { ...this.widgets, ...update };\n    const renderedWidgets = Object.keys(this.widgets)\n      .filter((key) => this.widgets[key])\n      .map((key) => {\n        const widget = this.widgets[key];\n        const element = React.cloneElement(widget.element, { key });\n        return { ...widget, element };\n      });\n    this.setState({ renderedWidgets });\n  }\n\n  private onWidgetsMouseDown = (e: React.MouseEvent<any>) => {\n    // prevent PaperArea from generating click on a blank area\n    e.stopPropagation();\n  };\n\n  pageToPaperCoords(pageX: number, pageY: number) {\n    const { left, top } = this.area.getBoundingClientRect();\n    return this.clientToPaperCoords(pageX - (left + window.pageXOffset), pageY - (top + window.pageYOffset));\n  }\n\n  clientToPaperCoords(areaClientX: number, areaClientY: number) {\n    const { x: paneX, y: paneY } = this.clientToScrollablePaneCoords(areaClientX, areaClientY);\n    return this.scrollablePaneToPaperCoords(paneX, paneY);\n  }\n\n  clientToScrollablePaneCoords(areaClientX: number, areaClientY: number) {\n    const { paddingX, paddingY } = this.state;\n    const paneX = areaClientX + this.area.scrollLeft - paddingX;\n    const paneY = areaClientY + this.area.scrollTop - paddingY;\n    return { x: paneX, y: paneY };\n  }\n\n  scrollablePaneToPaperCoords(paneX: number, paneY: number) {\n    const { scale, paddingX, paddingY, originX, originY } = this.state;\n    const paperX = paneX / scale - originX;\n    const paperY = paneY / scale - originY;\n    return { x: paperX, y: paperY };\n  }\n\n  paperToScrollablePaneCoords(paperX: number, paperY: number) {\n    const { scale, paddingX, paddingY, originX, originY } = this.state;\n    const paneX = (paperX + originX) * scale;\n    const paneY = (paperY + originY) * scale;\n    return { x: paneX, y: paneY };\n  }\n\n  /** Returns bounding box of paper content in paper coordinates. */\n  getContentFittingBox() {\n    const { elements, links } = this.props.view.model;\n    return getContentFittingBox(elements, links);\n  }\n\n  /** Returns paper size in paper coordinates. */\n  getPaperSize(): { width: number; height: number } {\n    const { paperWidth: width, paperHeight: height, scale } = this.state;\n    return { width: width / scale, height: height / scale };\n  }\n\n  getAreaMetrics() {\n    const { clientWidth, clientHeight, offsetWidth, offsetHeight } = this.area;\n    return { clientWidth, clientHeight, offsetWidth, offsetHeight };\n  }\n\n  private computeAdjustedBox(): Partial<State> {\n    // bbox in paper coordinates\n    const bbox = this.getContentFittingBox();\n    const bboxLeft = bbox.x;\n    const bboxTop = bbox.y;\n    const bboxRight = bbox.x + bbox.width;\n    const bboxBottom = bbox.y + bbox.height;\n\n    const { x: gridWidth, y: gridHeight } = this.pageSize;\n\n    // bbox in integer grid coordinates (open-closed intervals)\n    const bboxGrid = {\n      left: Math.floor(bboxLeft / gridWidth),\n      top: Math.floor(bboxTop / gridHeight),\n      right: Math.ceil(bboxRight / gridWidth),\n      bottom: Math.ceil(bboxBottom / gridHeight),\n    };\n\n    // const oldOrigin = this.paper.options.origin;\n    const originX = -bboxGrid.left * gridWidth;\n    const originY = -bboxGrid.top * gridHeight;\n\n    const paperWidth = Math.max(bboxGrid.right - bboxGrid.left, 1) * gridWidth;\n    const paperHeight = Math.max(bboxGrid.bottom - bboxGrid.top, 1) * gridHeight;\n\n    return { paperWidth, paperHeight, originX, originY };\n  }\n\n  private adjustPaper = (callback?: () => void) => {\n    const { clientWidth, clientHeight } = this.area;\n    const adjusted: Partial<State> = {\n      ...this.computeAdjustedBox(),\n      paddingX: Math.ceil(clientWidth),\n      paddingY: Math.ceil(clientHeight),\n    };\n    const previous = this.state;\n    const samePaperProps =\n      adjusted.paperWidth === previous.paperWidth &&\n      adjusted.paperHeight === previous.paperHeight &&\n      adjusted.originX === previous.originX &&\n      adjusted.originY === previous.originY &&\n      adjusted.paddingX === previous.paddingX &&\n      adjusted.paddingY === previous.paddingY;\n    if (!samePaperProps) {\n      this.scrollBeforeUpdate = {\n        left: this.area.scrollLeft,\n        top: this.area.scrollTop,\n      };\n      this.setState(adjusted, callback);\n    } else if (callback) {\n      callback();\n    }\n  };\n\n  private shouldStartZooming(e: MouseEvent | React.MouseEvent<any>) {\n    return (Boolean(e.ctrlKey) && Boolean(this.zoomOptions.requireCtrl)) || !this.zoomOptions.requireCtrl;\n  }\n\n  private shouldStartPanning(e: MouseEvent | React.MouseEvent<any>) {\n    const modifierPressed = e.ctrlKey || e.shiftKey || e.altKey;\n    return e.button === LEFT_MOUSE_BUTTON && !modifierPressed;\n  }\n\n  private onPaperPointerDown = (e: React.MouseEvent<HTMLElement>, cell: Cell | undefined) => {\n    if (this.movingState) {\n      return;\n    }\n\n    // if pointer is down on resize handle then we don't need to move the node\n    // see OverlayedElement in the elementLayer.tsx\n    if (\n      (e.target instanceof HTMLElement) &&\n      e.target.className === 'ontodia-overlayed-element__resizable-handle'\n    ) {\n      return ;\n    }\n\n    const restore = RestoreGeometry.capture(this.props.view.model);\n    const batch = this.props.view.model.history.startBatch(restore.title);\n\n    if (cell && e.button === LEFT_MOUSE_BUTTON) {\n      if (cell instanceof Element) {\n        e.preventDefault();\n        this.startMoving(e, cell);\n        this.listenToPointerMove(e, cell, batch, restore);\n      } else {\n        e.preventDefault();\n        this.listenToPointerMove(e, cell, batch, restore);\n      }\n    } else {\n      e.preventDefault();\n      this.listenToPointerMove(e, undefined, batch, restore);\n    }\n  };\n\n  private onAreaPointerDown = (e: React.MouseEvent<HTMLDivElement>) => {\n    if (e.target === this.area) {\n      this.onPaperPointerDown(e, undefined);\n    }\n  };\n\n  private startMoving(e: React.MouseEvent<HTMLElement>, element: Element) {\n    const { x: pointerX, y: pointerY } = this.pageToPaperCoords(e.pageX, e.pageY);\n    const { x: elementX, y: elementY } = element.position;\n    this.movingElementOrigin = { pointerX, pointerY, elementX, elementY };\n  }\n\n  private startPanning(event: React.MouseEvent<any>) {\n    const { scrollLeft, scrollTop } = this.area;\n    this.panningScrollOrigin = { scrollLeft, scrollTop };\n    this.clearTextSelectionInArea();\n  }\n\n  /** Clears accidental text selection in the diagram area. */\n  private clearTextSelectionInArea() {\n    if (document.getSelection) {\n      const selection = document.getSelection();\n      if (selection.removeAllRanges) {\n        selection.removeAllRanges();\n      }\n    }\n  }\n\n  private generateLinkVertex(link: Link, location: Vector): LinkVertex {\n    const previous = link.vertices;\n    const vertices = previous ? [...previous] : [];\n    const model = this.props.view.model;\n    const polyline = computePolyline(model.getElement(link.sourceId), model.getElement(link.targetId), vertices);\n    const segmentIndex = findNearestSegmentIndex(polyline, location);\n    return new LinkVertex(link, segmentIndex);\n  }\n\n  private listenToPointerMove(\n    event: React.MouseEvent<any>,\n    cell: Cell | undefined,\n    batch: Batch,\n    restoreGeometry: RestoreGeometry\n  ) {\n    if (this.movingState) {\n      return;\n    }\n    const panning = cell === undefined && this.shouldStartPanning(event);\n    if (panning) {\n      this.startPanning(event);\n    }\n    const { pageX, pageY } = event;\n    this.movingState = {\n      origin: { pageX, pageY },\n      target: cell,\n      panning,\n      pointerMoved: false,\n      batch,\n      restoreGeometry,\n    };\n    document.addEventListener('mousemove', this.onPointerMove);\n    document.addEventListener('mouseup', this.stopListeningToPointerMove);\n    this.source.trigger('pointerDown', {\n      source: this,\n      sourceEvent: event,\n      target: cell,\n      panning,\n    });\n  }\n\n  private onPointerMove = (e: MouseEvent) => {\n    if (!this.movingState || this.scrollBeforeUpdate) {\n      return;\n    }\n\n    const { origin, target, panning } = this.movingState;\n    const pageOffsetX = e.pageX - origin.pageX;\n    const pageOffsetY = e.pageY - origin.pageY;\n    if (Math.abs(pageOffsetX) >= 1 && Math.abs(pageOffsetY) >= 1) {\n      this.movingState.pointerMoved = true;\n    }\n\n    if (typeof target === 'undefined') {\n      if (panning) {\n        this.area.scrollLeft = this.panningScrollOrigin.scrollLeft - pageOffsetX;\n        this.area.scrollTop = this.panningScrollOrigin.scrollTop - pageOffsetY;\n      }\n      this.source.trigger('pointerMove', { source: this, sourceEvent: e, target, panning });\n    } else if (target instanceof Element) {\n      const { x, y } = this.pageToPaperCoords(e.pageX, e.pageY);\n      const { pointerX, pointerY, elementX, elementY } = this.movingElementOrigin;\n      target.setPosition({\n        x: elementX + x - pointerX,\n        y: elementY + y - pointerY,\n      });\n      this.source.trigger('pointerMove', { source: this, sourceEvent: e, target, panning });\n      this.props.view.performSyncUpdate();\n    } else if (target instanceof Link) {\n      const location = this.pageToPaperCoords(e.pageX, e.pageY);\n      const linkVertex = this.generateLinkVertex(target, location);\n      linkVertex.createAt(location);\n      this.movingState.target = linkVertex;\n    } else if (target instanceof LinkVertex) {\n      const location = this.pageToPaperCoords(e.pageX, e.pageY);\n      target.moveTo(location);\n      this.source.trigger('pointerMove', { source: this, sourceEvent: e, target, panning });\n      this.props.view.performSyncUpdate();\n    }\n  };\n\n  private stopListeningToPointerMove = (e?: MouseEvent) => {\n    const movingState = this.movingState;\n    this.movingState = undefined;\n\n    if (movingState) {\n      document.removeEventListener('mousemove', this.onPointerMove);\n      document.removeEventListener('mouseup', this.stopListeningToPointerMove);\n    }\n\n    if (e && movingState) {\n      const { pointerMoved, target, batch, restoreGeometry } = movingState;\n      this.source.trigger('pointerUp', {\n        source: this,\n        sourceEvent: e,\n        target,\n        panning: movingState.panning,\n        triggerAsClick: !pointerMoved,\n      });\n\n      const restore = restoreGeometry.filterOutUnchanged();\n      if (restore.hasChanges()) {\n        batch.history.registerToUndo(restore);\n      }\n      batch.store();\n    }\n  };\n\n  private onWheel = (e: MouseWheelEvent) => {\n    if (this.shouldStartZooming(e)) {\n      e.preventDefault();\n      const delta = Math.max(-1, Math.min(1, e.deltaY || e.deltaX));\n      const pivot = this.pageToPaperCoords(e.pageX, e.pageY);\n      this.zoomBy(-delta * 0.1, { pivot });\n    }\n  };\n\n  centerTo(paperPosition?: { x: number; y: number }, options: ViewportOptions = {}): Promise<void> {\n    const { paperWidth, paperHeight } = this.state;\n    const paperCenter = paperPosition || { x: paperWidth / 2, y: paperHeight / 2 };\n    const viewportState: Partial<ViewportState> = {\n      center: paperCenter,\n    };\n    return this.setViewportState(viewportState, options);\n  }\n\n  centerContent(options: ViewportOptions = {}): Promise<void> {\n    const bbox = this.getContentFittingBox();\n    return this.centerTo(\n      {\n        x: bbox.x + bbox.width / 2,\n        y: bbox.y + bbox.height / 2,\n      },\n      options\n    );\n  }\n\n  getScale() {\n    return this.state.scale;\n  }\n\n  setScale(value: number, options?: ScaleOptions): Promise<void> {\n    let scale = value;\n\n    const { min, max } = this.zoomOptions;\n    scale = Math.max(scale, min);\n    scale = Math.min(scale, max);\n\n    let viewportState: Partial<ViewportState>;\n    if (options && options.pivot) {\n      const { x, y } = options.pivot;\n      const paperCenter = this.clientToPaperCoords(this.area.clientWidth / 2, this.area.clientHeight / 2);\n      const previousScale = this.state.scale;\n      const scaledBy = scale / previousScale;\n      viewportState = {\n        center: {\n          x: x - (x - paperCenter.x) / scaledBy,\n          y: y - (y - paperCenter.y) / scaledBy,\n        },\n        scale: { x: scale, y: scale },\n      };\n    } else {\n      viewportState = {\n        scale: { x: scale, y: scale },\n      };\n    }\n    return this.setViewportState(viewportState, options);\n  }\n\n  zoomBy(value: number, options?: ScaleOptions) {\n    return this.setScale(this.getScale() + value, options);\n  }\n\n  zoomIn(scaleOptions?: ScaleOptions) {\n    return this.zoomBy(this.zoomOptions.step, scaleOptions);\n  }\n\n  zoomOut(scaleOptions?: ScaleOptions) {\n    return this.zoomBy(-this.zoomOptions.step, scaleOptions);\n  }\n\n  zoomToFit(options: ViewportOptions = {}): Promise<void> {\n    if (options.elements && options.elements.size === 0) {\n      return;\n    }\n    if (this.props.view.model.elements.length === 0) {\n      return this.centerTo();\n    }\n\n    let bbox;\n    let elements: ReadonlyArray<Element>;\n    if (options.elements) {\n      const selectionElements: Element[] = [];\n      options.elements.forEach((el) => selectionElements.push(el));\n      elements = selectionElements;\n    } else {\n      elements = this.props.view.model.elements;\n    }\n    bbox = getContentFittingBox(elements, []);\n    return this.zoomToFitRect(bbox, options);\n  }\n\n  zoomToFitRect(bbox: Rect, options: ViewportOptions = {}) {\n    const { clientWidth, clientHeight } = this.area;\n\n    if (bbox.width === 0) {\n      return;\n    }\n\n    const { width } = fitRectKeepingAspectRatio(bbox.width, bbox.height, clientWidth, clientHeight);\n\n    let scale = width / bbox.width;\n    const { min, maxFit } = this.zoomOptions;\n    scale = Math.max(scale, min);\n    scale = Math.min(scale, maxFit);\n\n    const center = {\n      x: bbox.x + bbox.width / 2,\n      y: bbox.y + bbox.height / 2,\n    };\n\n    const viewPortState: ViewportState = {\n      center,\n      scale: { x: scale, y: scale },\n    };\n\n    return this.setViewportState(viewPortState, options);\n  }\n\n  private onDragOver = (e: DragEvent) => {\n    // Necessary. Allows us to drop.\n    if (e.preventDefault) {\n      e.preventDefault();\n    }\n    e.dataTransfer.dropEffect = 'move';\n    const { x, y } = clientCoordsFor(this.area, e);\n    return false;\n  };\n\n  private onDragDrop = (e: DragEvent) => {\n    if (this.props.onDragDrop) {\n      const { x, y } = clientCoordsFor(this.area, e);\n      const paperPosition = this.clientToPaperCoords(x, y);\n      this.props.onDragDrop(e, paperPosition);\n    }\n  };\n\n  private onScroll = () => {\n    this.source.trigger('scroll', { source: this });\n  };\n\n  private makeToSVGOptions(): ToSVGOptions {\n    const svg = this.area.querySelector('.ontodia-paper__canvas');\n    if (!svg) {\n      throw new Error('Cannot find SVG canvas to export');\n    }\n    return {\n      model: this.props.view.model,\n      paper: svg as SVGSVGElement,\n      contentBox: this.getContentFittingBox(),\n      getOverlayedElement: (id) => this.area.querySelector(`[data-element-id='${id}']`) as HTMLElement,\n      preserveDimensions: true,\n      elementsToRemoveSelector: '.ontodia-link__vertex-tools',\n    };\n  }\n\n  exportSVG(): Promise<string> {\n    return toSVG(this.makeToSVGOptions());\n  }\n\n  exportPNG(options: ToDataURLOptions): Promise<string> {\n    return toDataURL({ ...options, ...this.makeToSVGOptions() });\n  }\n\n  isAnimatingGraph(): boolean {\n    return this.cssAnimations > 0;\n  }\n\n  /**\n   * Starts animation for graph elements and links.\n   *\n   * @param setupChanges immediately called function to perform animatable changes on graph\n   * @param duration animation duration in milliseconds (requires custom CSS to override)\n   * @returns promise which resolves when this animation ends\n   */\n  animateGraph(setupChanges: () => void, duration?: number): Promise<void> {\n    this.changeGraphAnimationCount(+1);\n    setupChanges();\n\n    const timeout = typeof duration === 'number' ? duration : DEFAULT_ANIMATION_DURATION;\n    return delay(timeout).then(() => this.onGraphAnimationEnd());\n  }\n\n  private onGraphAnimationEnd() {\n    this.changeGraphAnimationCount(-1);\n  }\n\n  private changeGraphAnimationCount(change: number) {\n    const newValue = this.cssAnimations + change;\n    if (newValue < 0) {\n      return;\n    }\n\n    const previous = this.isAnimatingGraph();\n    this.cssAnimations = newValue;\n\n    const current = this.isAnimatingGraph();\n    if (previous !== current) {\n      this.forceUpdate();\n      this.source.trigger('changeAnimatingGraph', { source: this, previous });\n    }\n  }\n\n  private get viewportState(): ViewportState {\n    const { clientWidth, clientHeight } = this.area;\n    const { originX, originY, paddingX, paddingY, scale } = this.state;\n\n    const scrollCenterX = this.area.scrollLeft + clientWidth / 2 - paddingX;\n    const scrollCenterY = this.area.scrollTop + clientHeight / 2 - paddingY;\n    const paperCenter = {\n      x: scrollCenterX / scale - originX,\n      y: scrollCenterY / scale - originY,\n    };\n\n    return {\n      center: paperCenter,\n      scale: {\n        x: scale,\n        y: scale,\n      },\n    };\n  }\n\n  private setViewportState(state: Partial<ViewportState>, options?: ViewportOptions): Promise<void> {\n    if (this.viewportAnimation) {\n      this.viewportAnimation.cancellation.abort();\n    }\n    const from = this.viewportState;\n    const to = { ...from, ...state };\n    const animate = options && (options.animate || options.duration > 0);\n    if (animate) {\n      const viewportAnimation: ViewportAnimation = {\n        from,\n        to,\n        cancellation: new Cancellation(),\n      };\n      const durationMs = typeof options.duration === 'number' ? options.duration : DEFAULT_ANIMATION_DURATION;\n\n      const awaitPromise = animateInterval(\n        durationMs,\n        (progress) => {\n          const t = easeInOutBezier(progress);\n          const computed: ViewportState = {\n            center: {\n              x: from.center.x + (to.center.x - from.center.x) * t,\n              y: from.center.y + (to.center.y - from.center.y) * t,\n            },\n            scale: {\n              x: from.scale.x + (to.scale.x - from.scale.x) * t,\n              y: from.scale.y + (to.scale.y - from.scale.y) * t,\n            },\n          };\n          this.applyViewportState(computed);\n        },\n        viewportAnimation.cancellation\n      );\n\n      this.viewportAnimation = viewportAnimation;\n      return awaitPromise.then(() => {\n        this.viewportAnimation = undefined;\n      });\n    } else {\n      this.applyViewportState(to);\n      return Promise.resolve();\n    }\n  }\n\n  applyViewportState = (targetState: ViewportState) => {\n    const scale = targetState.scale.x;\n    const paperCenter = targetState.center;\n\n    this.setState({ scale }, () => {\n      const { originX, originY, paddingX, paddingY } = this.state;\n      const scrollCenterX = (paperCenter.x + originX) * scale;\n      const scrollCenterY = (paperCenter.y + originY) * scale;\n      const { clientWidth, clientHeight } = this.area;\n\n      this.area.scrollLeft = scrollCenterX - clientWidth / 2 + paddingX;\n      this.area.scrollTop = scrollCenterY - clientHeight / 2 + paddingY;\n\n      if (this.props.onZoom) {\n        this.props.onZoom(scale, scale);\n      }\n    });\n  };\n}\n\nfunction clientCoordsFor(container: HTMLElement, e: MouseEvent) {\n  const target =\n    e.target instanceof SVGElement && e.target.ownerSVGElement !== null\n      ? e.target.ownerSVGElement\n      : (e.target as HTMLElement);\n  const targetBox = target.getBoundingClientRect();\n  const containerBox = container.getBoundingClientRect();\n  return {\n    x: e.offsetX + (targetBox.left - containerBox.left),\n    y: e.offsetY + (targetBox.top - containerBox.top),\n  };\n}\n\nexport function getContentFittingBox(\n  elements: ReadonlyArray<Element>,\n  links: ReadonlyArray<Link>\n): { x: number; y: number; width: number; height: number } {\n  let minX = Infinity,\n    minY = Infinity;\n  let maxX = -Infinity,\n    maxY = -Infinity;\n\n  for (const element of elements) {\n    const { x, y } = element.position;\n    const size = element.size;\n    minX = Math.min(minX, x);\n    minY = Math.min(minY, y);\n    maxX = Math.max(maxX, x + size.width);\n    maxY = Math.max(maxY, y + size.height);\n  }\n\n  for (const link of links) {\n    const vertices = link.vertices || [];\n    for (const { x, y } of vertices) {\n      minX = Math.min(minX, x);\n      minY = Math.min(minY, y);\n      maxX = Math.max(maxX, x);\n      maxY = Math.max(maxY, y);\n    }\n  }\n\n  return {\n    x: Number.isFinite(minX) ? minX : 0,\n    y: Number.isFinite(minY) ? minY : 0,\n    width: Number.isFinite(minX) && Number.isFinite(maxX) ? maxX - minX : 0,\n    height: Number.isFinite(minY) && Number.isFinite(maxY) ? maxY - minY : 0,\n  };\n}\n","import { PropTypes } from '../viewUtils/react';\nimport { EditorController } from '../editor/editorController';\n\nexport type WorkspaceEventHandler = (key: WorkspaceEventKey) => void;\nexport enum WorkspaceEventKey {\n  searchUpdateCriteria = 'search:updateCriteria',\n  searchQueryItem = 'search:queryItems',\n  connectionsLoadLinks = 'connections:loadLinks',\n  connectionsExpandLink = 'connections:expandLink',\n  connectionsLoadElements = 'connections:loadElements',\n  editorChangeSelection = 'editor:changeSelection',\n  editorToggleDialog = 'editor:toggleDialog',\n  editorAddElements = 'editor:addElements',\n}\n\nexport interface WorkspaceContextWrapper {\n  ontodiaWorkspace: WorkspaceContext;\n}\n\nexport interface WorkspaceContext {\n  editor: EditorController;\n  triggerWorkspaceEvent: WorkspaceEventHandler;\n}\n\nexport const WorkspaceContextTypes: { [K in keyof WorkspaceContextWrapper]: any } = {\n  ontodiaWorkspace: PropTypes.anything,\n};\n","import * as React from 'react';\nimport { Component, CSSProperties } from 'react';\n\nimport { Cell, LinkVertex } from './elements';\nimport { ElementLayer } from './elementLayer';\nimport { Vector } from './geometry';\nimport { LinkLayer, LinkMarkers } from './linkLayer';\nimport { DiagramModel } from './model';\nimport { DiagramView } from './view';\n\nexport interface PaperProps {\n  view: DiagramView;\n  paperTransform: PaperTransform;\n  onPointerDown?: (e: React.MouseEvent<HTMLElement>, cell: Cell | undefined) => void;\n  group?: string;\n  linkLayerWidgets?: React.ReactElement<any>;\n  elementLayerWidgets?: React.ReactElement<any>;\n}\n\nconst CLASS_NAME = 'ontodia-paper';\n\nexport class Paper extends Component<PaperProps, {}> {\n  render() {\n    const { view, group, paperTransform, linkLayerWidgets, elementLayerWidgets } = this.props;\n    const { width, height, originX, originY, scale, paddingX, paddingY } = paperTransform;\n\n    const scaledWidth = width * scale;\n    const scaledHeight = height * scale;\n    // using padding instead of margin in combination with setting width and height\n    // on .paper element to avoid \"over-constrained\" margins, see an explanation here:\n    // https://stackoverflow.com/questions/11695354\n    const style: CSSProperties = {\n      width: scaledWidth + paddingX,\n      height: scaledHeight + paddingY,\n      marginLeft: paddingX,\n      marginTop: paddingY,\n      paddingRight: paddingX,\n      paddingBottom: paddingY,\n    };\n    const htmlTransformStyle: React.CSSProperties = {\n      position: 'absolute',\n      left: 0,\n      top: 0,\n      transform: `scale(${scale},${scale})translate(${originX}px,${originY}px)`,\n    };\n\n    return (\n      <div className={CLASS_NAME} style={style} onMouseDown={this.onMouseDown}>\n        <TransformedSvgCanvas\n          className={`${CLASS_NAME}__canvas`}\n          style={{ overflow: 'visible' }}\n          paperTransform={paperTransform}\n        >\n          <LinkMarkers view={view} />\n          <LinkLayer view={view} links={view.model.links} group={group} />\n        </TransformedSvgCanvas>\n        {linkLayerWidgets}\n        <ElementLayer view={view} group={group} style={htmlTransformStyle} scale={scale} />\n        {elementLayerWidgets}\n      </div>\n    );\n  }\n\n  private onMouseDown = (e: React.MouseEvent<HTMLDivElement>) => {\n    const { view, onPointerDown } = this.props;\n    const cell = e.target instanceof Element ? findCell(e.target, e.currentTarget, view.model) : undefined;\n    if (onPointerDown) {\n      onPointerDown(e, cell);\n    }\n  };\n}\n\nfunction findCell(bottom: Element, top: Element, model: DiagramModel): Cell | undefined {\n  let target: Node = bottom;\n  let vertexIndex: number | undefined;\n  while (true) {\n    if (target instanceof Element) {\n      if (target.hasAttribute('data-element-id')) {\n        return model.getElement(target.getAttribute('data-element-id'));\n      } else if (target.hasAttribute('data-link-id')) {\n        const link = model.getLinkById(target.getAttribute('data-link-id'));\n        return typeof vertexIndex === 'number' ? new LinkVertex(link, vertexIndex) : link;\n      } else if (target.hasAttribute('data-vertex')) {\n        vertexIndex = Number(target.getAttribute('data-vertex'));\n      }\n    }\n    if (!target || target === top) {\n      break;\n    }\n    target = target.parentNode;\n  }\n  return undefined;\n}\n\nexport interface PaperTransform {\n  width: number;\n  height: number;\n  originX: number;\n  originY: number;\n  scale: number;\n  paddingX: number;\n  paddingY: number;\n}\n\nexport interface TransformedSvgCanvasProps extends React.SVGProps<SVGSVGElement> {\n  paperTransform: PaperTransform;\n}\n\nexport class TransformedSvgCanvas extends Component<TransformedSvgCanvasProps, {}> {\n  private static readonly SVG_STYLE: CSSProperties = {\n    position: 'absolute',\n    top: 0,\n    left: 0,\n  };\n  render() {\n    const { paperTransform, style, children, ...otherProps } = this.props;\n    const { width, height, originX, originY, scale, paddingX, paddingY } = paperTransform;\n    const scaledWidth = width * scale;\n    const scaledHeight = height * scale;\n    let svgStyle = TransformedSvgCanvas.SVG_STYLE;\n    if (style) {\n      svgStyle = { ...svgStyle, ...style };\n    }\n    return (\n      <svg width={scaledWidth} height={scaledHeight} style={svgStyle} {...otherProps}>\n        <g transform={`scale(${scale},${scale})translate(${originX},${originY})`}>{children}</g>\n      </svg>\n    );\n  }\n}\n\n/**\n * @returns scrollable pane size in non-scaled pane coords.\n */\nexport function totalPaneSize(pt: PaperTransform): Vector {\n  return {\n    x: pt.width * pt.scale + pt.paddingX * 2,\n    y: pt.height * pt.scale + pt.paddingY * 2,\n  };\n}\n\n/**\n * @returns scrollable pane top-left corner position in non-scaled pane coords.\n */\nexport function paneTopLeft(pt: PaperTransform): Vector {\n  return { x: -pt.paddingX, y: -pt.paddingY };\n}\n\nexport function paneFromPaperCoords(paper: Vector, pt: PaperTransform): Vector {\n  return {\n    x: (paper.x + pt.originX) * pt.scale,\n    y: (paper.y + pt.originY) * pt.scale,\n  };\n}\n\nexport function paperFromPaneCoords(pane: Vector, pt: PaperTransform): Vector {\n  return {\n    x: pane.x / pt.scale - pt.originX,\n    y: pane.y / pt.scale - pt.originY,\n  };\n}\n","import { EventSource, Events } from '../viewUtils/events';\n\nexport interface Command {\n  readonly title?: string;\n  readonly invoke: CommandAction;\n}\n\n/** @returns Inverse command */\nexport type CommandAction = () => Command;\n\nexport namespace Command {\n  export function create(title: string, action: CommandAction): Command {\n    return { title, invoke: action };\n  }\n\n  export function effect(title: string, body: () => void): Command {\n    const perform = {\n      title,\n      invoke: () => {\n        body();\n        return skip;\n      },\n    };\n    const skip = {\n      title: 'Skipped effect: ' + title,\n      invoke: () => perform,\n    };\n    return perform;\n  }\n}\n\nexport interface CommandHistoryEvents {\n  historyChanged: { hasChanges: boolean };\n}\n\nexport interface CommandHistory {\n  readonly events: Events<CommandHistoryEvents>;\n  readonly undoStack: ReadonlyArray<Command>;\n  readonly redoStack: ReadonlyArray<Command>;\n  reset(): void;\n  undo(): void;\n  redo(): void;\n  execute(command: Command): void;\n  registerToUndo(command: Command): void;\n  startBatch(title?: string): Batch;\n}\n\nexport interface Batch {\n  readonly history: CommandHistory;\n  store(): void;\n  discard(): void;\n}\n\nexport class NonRememberingHistory implements CommandHistory {\n  private readonly source = new EventSource<CommandHistoryEvents>();\n  readonly events: Events<CommandHistoryEvents> = this.source;\n\n  readonly undoStack: ReadonlyArray<Command> = [];\n  readonly redoStack: ReadonlyArray<Command> = [];\n\n  reset() {\n    this.source.trigger('historyChanged', { hasChanges: false });\n  }\n  undo() {\n    throw new Error('Undo is unsupported');\n  }\n  redo() {\n    throw new Error('Redo is unsupported');\n  }\n\n  execute(command: Command) {\n    command.invoke();\n    this.source.trigger('historyChanged', { hasChanges: true });\n  }\n  registerToUndo(command: Command) {\n    this.source.trigger('historyChanged', { hasChanges: true });\n  }\n  startBatch(title?: string): Batch {\n    return {\n      history: this,\n      store: this.storeBatch,\n      discard: this.discardBatch,\n    };\n  }\n  private storeBatch = () => {\n    /* nothing */\n  };\n  private discardBatch = () => {\n    /* nothing */\n  };\n}\n","import * as React from 'react';\n\nexport enum ProgressState {\n  none = 'none',\n  loading = 'loading',\n  error = 'error',\n  completed = 'completed',\n}\n\nexport interface ProgressBarProps {\n  state: ProgressState;\n  percent?: number;\n  height?: number;\n}\n\nconst CLASS_NAME = 'ontodia-progress-bar';\n\nexport class ProgressBar extends React.Component<ProgressBarProps, {}> {\n  render() {\n    const { state, percent = 100, height = 20 } = this.props;\n    const className = `${CLASS_NAME} ${CLASS_NAME}--${state}`;\n    const showBar = state === ProgressState.loading || state === ProgressState.error;\n    return (\n      <div className={className} style={{ height: showBar ? height : 0 }}>\n        <div\n          className={`${CLASS_NAME}__bar`}\n          role=\"progressbar\"\n          style={{ width: `${percent}%` }}\n          aria-valuemin={0}\n          aria-valuemax={100}\n          aria-valuenow={percent}\n        ></div>\n      </div>\n    );\n  }\n}\n","import * as React from 'react';\nimport { hcl } from 'd3-color';\n\nimport { ElementModel } from '../data/model';\nimport { DiagramView } from '../diagram/view';\n\nexport interface ListElementViewProps {\n  className?: string;\n  view: DiagramView;\n  model: ElementModel;\n  highlightText?: string;\n  disabled?: boolean;\n  selected?: boolean;\n  onClick?: (event: React.MouseEvent<any>, model: ElementModel) => void;\n  onDragStart?: React.HTMLProps<HTMLElement>['onDragStart'];\n}\n\nconst CLASS_NAME = 'ontodia-list-element-view';\n\nexport class ListElementView extends React.Component<ListElementViewProps, {}> {\n  render() {\n    const { className, view, model, highlightText, disabled, selected, onDragStart } = this.props;\n\n    const { h, c, l } = view.getTypeStyle(model.types).color;\n    const frontColor = selected && !disabled ? hcl(h, c, l * 1.2) : hcl('white');\n\n    let classNames = `${CLASS_NAME}`;\n    classNames += disabled ? ` ${CLASS_NAME}--disabled` : '';\n    classNames += className ? ` ${className}` : '';\n    const localizedText = view.formatLabel(model.label.values, model.id);\n    const classesString = model.types.length > 0 ? `\\nClasses: ${view.getElementTypeString(model)}` : '';\n\n    return (\n      <li\n        className={classNames}\n        draggable={!disabled && Boolean(onDragStart)}\n        title={`${localizedText} ${view.formatIri(model.id)}${classesString}`}\n        style={{ background: hcl(h, c, l).toString() }}\n        onClick={this.onClick}\n        onDragStart={onDragStart}\n      >\n        <div className={`${CLASS_NAME}__label`} style={{ background: frontColor.toString() }}>\n          {highlightSubstring(localizedText, highlightText)}\n        </div>\n      </li>\n    );\n  }\n\n  private onClick = (event: React.MouseEvent<any>) => {\n    const { disabled, model, onClick } = this.props;\n    if (!disabled && onClick) {\n      event.persist();\n      onClick(event, model);\n    }\n  };\n}\n\nexport function startDragElements(e: React.DragEvent<{}>, iris: ReadonlyArray<string>) {\n  try {\n    e.dataTransfer.setData('application/x-ontodia-elements', JSON.stringify(iris));\n  } catch (ex) {\n    // IE fix\n    e.dataTransfer.setData('text', JSON.stringify(iris));\n  }\n  return false;\n}\n\nconst DEFAULT_HIGHLIGHT_PROPS: React.HTMLProps<HTMLSpanElement> = {\n  className: `ontodia-text-highlight`,\n};\n\nexport function highlightSubstring(\n  text: string,\n  substring: string | undefined,\n  highlightProps = DEFAULT_HIGHLIGHT_PROPS\n) {\n  if (!substring) {\n    return <span>{text}</span>;\n  }\n\n  const start = text.toLowerCase().indexOf(substring.toLowerCase());\n  if (start < 0) {\n    return <span>{text}</span>;\n  }\n\n  const end = start + substring.length;\n  const before = text.substring(0, start);\n  const highlighted = text.substring(start, end);\n  const after = text.substring(end);\n\n  return (\n    <span>\n      {before}\n      <span {...highlightProps}>{highlighted}</span>\n      {after}\n    </span>\n  );\n}\n","import * as cola from 'webcola';\n\nimport { DiagramModel } from '../diagram/model';\nimport { boundsOf, Vector, computeGrouping, Size } from '../diagram/geometry';\nimport { Element } from '../diagram/elements';\nimport { EventObserver } from './events';\nimport { getContentFittingBox } from '../diagram/paperArea';\n\nexport interface LayoutNode {\n  id?: string;\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n  bounds?: any;\n  fixed?: number;\n  innerBounds?: any;\n}\n\nexport interface LayoutLink {\n  source: LayoutNode;\n  target: LayoutNode;\n}\n\nexport function groupForceLayout(params: {\n  nodes: LayoutNode[];\n  links: LayoutLink[];\n  preferredLinkLength: number;\n  avoidOvelaps?: boolean;\n}) {\n  const layout = new cola.Layout()\n    .nodes(params.nodes)\n    .links(params.links)\n    .avoidOverlaps(params.avoidOvelaps)\n    .convergenceThreshold(1e-9)\n    .jaccardLinkLengths(params.preferredLinkLength)\n    .handleDisconnected(true);\n  layout.start(30, 0, 10, undefined, false);\n}\n\nexport function groupRemoveOverlaps(nodes: LayoutNode[]) {\n  const nodeRectangles: cola.Rectangle[] = [];\n  for (const node of nodes) {\n    nodeRectangles.push(new cola.Rectangle(node.x, node.x + node.width, node.y, node.y + node.height));\n  }\n\n  cola.removeOverlaps(nodeRectangles);\n\n  for (let i = 0; i < nodeRectangles.length; i++) {\n    const node = nodes[i];\n    const rectangle = nodeRectangles[i];\n    node.x = rectangle.x;\n    node.y = rectangle.y;\n  }\n}\n\nexport function translateToPositiveQuadrant(positions: Map<string, Vector>, offset: Vector) {\n  let minX = Infinity,\n    minY = Infinity;\n  positions.forEach((position) => {\n    minX = Math.min(minX, position.x);\n    minY = Math.min(minY, position.y);\n  });\n\n  const { x, y } = offset;\n  positions.forEach((position, key) => {\n    positions.set(key, {\n      x: position.x - minX + x,\n      y: position.y - minY + y,\n    });\n  });\n}\n\nexport function uniformGrid(params: { rows: number; cellSize: Vector }): (cellIndex: number) => LayoutNode {\n  return (cellIndex) => {\n    const row = Math.floor(cellIndex / params.rows);\n    const column = cellIndex - row * params.rows;\n    return {\n      x: column * params.cellSize.x,\n      y: row * params.cellSize.y,\n      width: params.cellSize.x,\n      height: params.cellSize.y,\n    };\n  };\n}\n\nexport function padded(nodes: LayoutNode[], padding: { x: number; y: number } | undefined, transform: () => void) {\n  if (padding) {\n    for (const node of nodes) {\n      node.x -= padding.x;\n      node.y -= padding.y;\n      node.width += 2 * padding.x;\n      node.height += 2 * padding.y;\n    }\n  }\n\n  transform();\n\n  if (padding) {\n    for (const node of nodes) {\n      node.x += padding.x;\n      node.y += padding.y;\n      node.width -= 2 * padding.x;\n      node.height -= 2 * padding.y;\n    }\n  }\n}\n\nexport function biasFreePadded(\n  nodes: LayoutNode[],\n  padding: { x: number; y: number } | undefined,\n  transform: () => void\n) {\n  const nodeSizeMap = new Map<string, Size>();\n  const possibleCompression = { x: Infinity, y: Infinity };\n  for (const node of nodes) {\n    nodeSizeMap.set(node.id, { width: node.width, height: node.height });\n    const maxSide = Math.max(node.width, node.height);\n\n    const compressionX = node.width ? maxSide / node.width : 1;\n    const compressionY = node.height ? maxSide / node.height : 1;\n    possibleCompression.x = Math.min(1 + (compressionX - 1), possibleCompression.x);\n    possibleCompression.y = Math.min(1 + (compressionY - 1), possibleCompression.y);\n\n    node.height = maxSide;\n    node.width = maxSide;\n  }\n  padded(nodes, padding, () => transform());\n\n  const fittingBox = getContentFittingBoxForLayout(nodes);\n  for (const node of nodes) {\n    const size = nodeSizeMap.get(node.id);\n    node.x = (node.x - fittingBox.x) / possibleCompression.x + fittingBox.x;\n    node.y = (node.y - fittingBox.y) / possibleCompression.y + fittingBox.y;\n    node.height = size.height;\n    node.width = size.width;\n  }\n}\n\nexport type CalculatedLayout = object & { readonly layoutBrand: void };\n\nexport interface UnzippedCalculatedLayout extends CalculatedLayout {\n  group?: string;\n  keepAveragePosition: boolean;\n  positions: Map<string, Vector>;\n  nestedLayouts: UnzippedCalculatedLayout[];\n}\n\nexport function calculateLayout(params: {\n  model: DiagramModel;\n  layoutFunction: (nodes: LayoutNode[], links: LayoutLink[], group: string) => void;\n  fixedElements?: ReadonlySet<Element>;\n  group?: string;\n  selectedElements?: ReadonlySet<Element>;\n}): CalculatedLayout {\n  const grouping = computeGrouping(params.model.elements);\n  const { layoutFunction, model, fixedElements, selectedElements } = params;\n\n  if (selectedElements && selectedElements.size <= 1) {\n    return {\n      positions: new Map(),\n      nestedLayouts: [],\n      keepAveragePosition: false,\n    } as UnzippedCalculatedLayout;\n  }\n  return internalRecursion(params.group);\n\n  function internalRecursion(group: string): CalculatedLayout {\n    const elementsToProcess = group ? grouping.get(group) : model.elements.filter((el) => el.group === undefined);\n    const elements = selectedElements ? elementsToProcess.filter((el) => selectedElements.has(el)) : elementsToProcess;\n\n    const nestedLayouts: CalculatedLayout[] = [];\n    for (const element of elements) {\n      if (grouping.has(element.id)) {\n        nestedLayouts.push(internalRecursion(element.id));\n      }\n    }\n\n    const nodes: LayoutNode[] = [];\n    const nodeById: { [id: string]: LayoutNode } = {};\n    for (const element of elements) {\n      const { x, y, width, height } = boundsOf(element);\n      const node: LayoutNode = {\n        id: element.id,\n        x,\n        y,\n        width,\n        height,\n        fixed: fixedElements && fixedElements.has(element) ? 1 : 0,\n      };\n      nodeById[element.id] = node;\n      nodes.push(node);\n    }\n\n    const links: LayoutLink[] = [];\n    for (const link of model.links) {\n      if (!model.isSourceAndTargetVisible(link)) {\n        continue;\n      }\n      const source = model.sourceOf(link);\n      const target = model.targetOf(link);\n      const sourceNode = nodeById[source.id];\n      const targetNode = nodeById[target.id];\n      if (sourceNode && targetNode) {\n        links.push({ source: sourceNode, target: targetNode });\n      }\n    }\n    layoutFunction(nodes, links, group);\n\n    const positions: Map<string, Vector> = new Map();\n    for (const node of nodes) {\n      positions.set(node.id, { x: node.x, y: node.y });\n    }\n\n    return {\n      positions,\n      group,\n      nestedLayouts,\n      keepAveragePosition: Boolean(selectedElements),\n    } as UnzippedCalculatedLayout;\n  }\n}\n\nexport function applyLayout(model: DiagramModel, layout: CalculatedLayout) {\n  const { positions, group, nestedLayouts, keepAveragePosition } = layout as UnzippedCalculatedLayout;\n  const elements = model.elements.filter(({ id }) => positions.has(id));\n  for (const nestedLayout of nestedLayouts) {\n    applyLayout(model, nestedLayout);\n  }\n\n  if (group) {\n    const offset: Vector = getContentFittingBox(elements, []);\n    translateToPositiveQuadrant(positions, offset);\n  }\n\n  const averagePosition = keepAveragePosition ? calculateAveragePosition(elements) : undefined;\n  for (const element of elements) {\n    element.setPosition(positions.get(element.id));\n  }\n\n  if (keepAveragePosition) {\n    const newAveragePosition = calculateAveragePosition(elements);\n    const averageDiff = {\n      x: averagePosition.x - newAveragePosition.x,\n      y: averagePosition.y - newAveragePosition.y,\n    };\n    positions.forEach((position, elementId) => {\n      const element = model.getElement(elementId);\n      element.setPosition({\n        x: position.x + averageDiff.x,\n        y: position.y + averageDiff.y,\n      });\n    });\n  }\n}\n\nexport function calculateAveragePosition(position: ReadonlyArray<Element>): Vector {\n  let xSum = 0;\n  let ySum = 0;\n  for (const element of position) {\n    xSum += element.position.x + element.size.width / 2;\n    ySum += element.position.y + element.size.height / 2;\n  }\n  return {\n    x: xSum / position.length,\n    y: ySum / position.length,\n  };\n}\n\nexport function placeElementsAround(params: {\n  model: DiagramModel;\n  elements: ReadonlyArray<Element>;\n  prefferedLinksLength: number;\n  targetElement: Element;\n  startAngle?: number;\n}) {\n  const { model, elements, targetElement, prefferedLinksLength } = params;\n  const targetElementBounds = boundsOf(targetElement);\n  const targetPosition: Vector = {\n    x: targetElementBounds.x + targetElementBounds.width / 2,\n    y: targetElementBounds.y + targetElementBounds.height / 2,\n  };\n  let outgoingAngle = 0;\n  if (targetElement.links.length > 0) {\n    const averageSourcePosition = calculateAveragePosition(\n      targetElement.links.map((link) => {\n        const linkSource = model.sourceOf(link);\n        return linkSource !== targetElement ? linkSource : model.targetOf(link);\n      })\n    );\n    const vectorDiff: Vector = {\n      x: targetPosition.x - averageSourcePosition.x,\n      y: targetPosition.y - averageSourcePosition.y,\n    };\n    if (vectorDiff.x !== 0 || vectorDiff.y !== 0) {\n      outgoingAngle = Math.atan2(vectorDiff.y, vectorDiff.x);\n    }\n  }\n\n  const step = Math.min(Math.PI / elements.length, Math.PI / 6);\n  const elementsSteck: Element[] = [].concat(elements);\n\n  const placeElementFromSteck = (curAngle: number, element: Element) => {\n    if (element) {\n      const size = element.size;\n      element.setPosition({\n        x: targetPosition.x + prefferedLinksLength * Math.cos(curAngle) - size.width / 2,\n        y: targetPosition.y + prefferedLinksLength * Math.sin(curAngle) - size.height / 2,\n      });\n    }\n  };\n\n  const isOddLength = elementsSteck.length % 2 === 0;\n  if (isOddLength) {\n    for (let angle = step / 2; elementsSteck.length > 0; angle += step) {\n      placeElementFromSteck(outgoingAngle - angle, elementsSteck.pop());\n      placeElementFromSteck(outgoingAngle + angle, elementsSteck.pop());\n    }\n  } else {\n    placeElementFromSteck(outgoingAngle, elementsSteck.pop());\n    for (let angle = step; elementsSteck.length > 0; angle += step) {\n      placeElementFromSteck(outgoingAngle - angle, elementsSteck.pop());\n      placeElementFromSteck(outgoingAngle + angle, elementsSteck.pop());\n    }\n  }\n\n  return new Promise((resolve) => {\n    const listener = new EventObserver();\n    listener.listen(model.events, 'changeCells', () => {\n      listener.stopListening();\n\n      removeOverlaps({\n        model,\n        padding: { x: 15, y: 15 },\n      });\n      resolve();\n    });\n  });\n}\n\nexport function removeOverlaps(params: {\n  model: DiagramModel;\n  fixedElements?: ReadonlySet<Element>;\n  padding?: Vector;\n  group?: string;\n  selectedElements?: ReadonlySet<Element>;\n}): CalculatedLayout {\n  const { padding, model, group, fixedElements, selectedElements } = params;\n  return calculateLayout({\n    model,\n    group,\n    fixedElements,\n    selectedElements,\n    layoutFunction: (nodes) => {\n      padded(nodes, padding, () => groupRemoveOverlaps(nodes));\n    },\n  });\n}\n\nexport function forceLayout(params: {\n  model: DiagramModel;\n  fixedElements?: ReadonlySet<Element>;\n  group?: string;\n  selectedElements?: ReadonlySet<Element>;\n}): CalculatedLayout {\n  const { model, group, fixedElements, selectedElements } = params;\n  return calculateLayout({\n    model,\n    group,\n    fixedElements,\n    selectedElements,\n    layoutFunction: (nodes, links) => {\n      if (fixedElements && fixedElements.size > 0) {\n        biasFreePadded(nodes, { x: 50, y: 50 }, () =>\n          groupForceLayout({\n            nodes,\n            links,\n            preferredLinkLength: 200,\n            avoidOvelaps: true,\n          })\n        );\n      } else {\n        groupForceLayout({ nodes, links, preferredLinkLength: 200 });\n        biasFreePadded(nodes, { x: 50, y: 50 }, () => groupRemoveOverlaps(nodes));\n      }\n    },\n  });\n}\n\nexport function getContentFittingBoxForLayout(\n  nodes: ReadonlyArray<LayoutNode>\n): { x: number; y: number; width: number; height: number } {\n  let minX = Infinity,\n    minY = Infinity;\n  let maxX = -Infinity,\n    maxY = -Infinity;\n\n  for (const node of nodes) {\n    const { x, y, width, height } = node;\n    minX = Math.min(minX, x);\n    minY = Math.min(minY, y);\n    maxX = Math.max(maxX, x + width);\n    maxY = Math.max(maxY, y + height);\n  }\n\n  return {\n    x: Number.isFinite(minX) ? minX : 0,\n    y: Number.isFinite(minY) ? minY : 0,\n    width: Number.isFinite(minX) && Number.isFinite(maxX) ? maxX - minX : 0,\n    height: Number.isFinite(minY) && Number.isFinite(maxY) ? maxY - minY : 0,\n  };\n}\n","/** Generates random 32-digit hexadecimal string. */\nexport function generate128BitID() {\n  function random32BitDigits() {\n    return Math.floor((1 + Math.random()) * 0x100000000)\n      .toString(16)\n      .substring(1);\n  }\n  // generate by half because of restricted numerical precision\n  return random32BitDigits() + random32BitDigits() + random32BitDigits() + random32BitDigits();\n}\n\n/**\n * Calculate a 32 bit FNV-1a hash\n * Found here: https://gist.github.com/vaiorabbit/5657561\n * Ref.: http://isthe.com/chongo/tech/comp/fnv/\n *\n * @param {string} str the input value\n * @param {integer} [seed] optionally pass the hash of the previous chunk\n * @returns {integer}\n */\nexport function hashFnv32a(str: string, seed = 0x811c9dc5): number {\n  /* tslint:disable:no-bitwise */\n  let i: number,\n    l: number,\n    hval = seed & 0x7fffffff;\n\n  for (i = 0, l = str.length; i < l; i++) {\n    hval ^= str.charCodeAt(i);\n    hval += (hval << 1) + (hval << 4) + (hval << 7) + (hval << 8) + (hval << 24);\n  }\n  return hval >>> 0;\n  /* tslint:enable:no-bitwise */\n}\n\n/**\n * Extracts local name for URI the same way as it's done in RDF4J.\n */\nexport function getUriLocalName(uri: string): string | undefined {\n  let index = uri.indexOf('#');\n  if (index < 0) {\n    index = uri.lastIndexOf('/');\n  }\n  if (index < 0) {\n    index = uri.lastIndexOf(':');\n  }\n  if (index < 0) {\n    return undefined;\n  }\n  return uri.substring(index + 1);\n}\n","export namespace PropTypes {\n  export const anything: any = (): null => null;\n}\n","import { Dictionary } from '../model';\nimport { FilterParams } from '../provider';\nimport { getUriLocalName } from '../utils';\n\nimport { SparqlDataProviderSettings } from './sparqlDataProviderSettings';\nimport {\n  ElementBinding,\n  LinkBinding,\n  BlankBinding,\n  FilterBinding,\n  LinkCountBinding,\n  ElementTypeBinding,\n  SparqlResponse,\n  RdfLiteral,\n  isRdfIri,\n  isRdfBlank,\n  isBlankBinding,\n} from './sparqlModels';\n\nexport const MAX_RECURSION_DEEP = 3;\n\nexport const ENCODED_PREFIX = 'sparql-blank:';\n\nexport const BLANK_NODE_QUERY_PARAMETERS = '?blankTrgProp ?blankTrg ?blankSrc ?blankSrcProp ?listHead';\n\nexport const BLANK_NODE_QUERY = `\n    OPTIONAL {\n        FILTER (ISBLANK(?inst)).\n        {\n            ?inst ?blankTrgProp ?blankTrg.\n            ?blankSrc ?blankSrcProp ?inst.\n            FILTER NOT EXISTS { ?inst rdf:first _:smth1 }.\n            BIND(\"blankNode\" as ?blankType)\n        } UNION {\n            ?inst rdf:rest*/rdf:first ?blankTrg.\n            ?blankSrc ?blankSrcProp ?inst.\n            _:smth2 rdf:first ?blankTrg.\n            BIND(?blankSrcProp as ?blankTrgProp)\n            BIND(\"listHead\" as ?blankType)\n            FILTER NOT EXISTS { _:smth3 rdf:rest ?inst }.\n        } UNION {\n            ?listHead rdf:rest* ?inst.\n            FILTER NOT EXISTS { _:smth4 rdf:rest ?listHead }.\n\n            ?listHead rdf:rest*/rdf:first ?blankTrg.\n            ?blankSrc ?blankSrcProp ?listHead.\n            _:smth5 rdf:first ?blankTrg.\n            BIND(?blankSrcProp as ?blankTrgProp)\n            BIND(\"listHead\" as ?blankType)\n        }\n    }\n`;\n\nexport function isEncodedBlank(id: string): boolean {\n  return id.startsWith(ENCODED_PREFIX);\n}\n\nexport class QueryExecutor {\n  queryDictionary: Dictionary<Promise<SparqlResponse<BlankBinding>>> = {};\n  constructor(public queryFunction: (query: string) => Promise<SparqlResponse<BlankBinding>>) {}\n\n  executeQuery(query: string): Promise<SparqlResponse<BlankBinding>> {\n    const execution = this.queryDictionary[query];\n    if (execution) {\n      return execution;\n    } else {\n      this.queryDictionary[query] = this.queryFunction(query).then((response) => {\n        delete this.queryDictionary[query];\n        return response;\n      });\n      return this.queryDictionary[query];\n    }\n  }\n}\n\nexport function updateFilterResults(\n  result: SparqlResponse<ElementBinding & FilterBinding>,\n  queryFunction: (query: string) => Promise<SparqlResponse<BlankBinding>>,\n  settings: SparqlDataProviderSettings\n): Promise<SparqlResponse<ElementBinding & FilterBinding>> {\n  const completeBindings: Array<ElementBinding & FilterBinding> = [];\n  const blankBindings: Array<BlankBinding & FilterBinding> = [];\n\n  for (const binding of result.results.bindings) {\n    if (isBlankBinding(binding)) {\n      blankBindings.push(binding);\n    } else {\n      completeBindings.push(binding);\n    }\n  }\n  return processBlankBindings(\n    blankBindings,\n    (callBackQuery: string) => {\n      return queryFunction(callBackQuery);\n    },\n    settings\n  ).then((processedBindings) => {\n    result.results.bindings = completeBindings.concat(processedBindings);\n    return result;\n  });\n}\n\nexport function processBlankBindings(\n  blankBindings: BlankBinding[],\n  queryFunction: (query: string) => Promise<SparqlResponse<BlankBinding>>,\n  settings: SparqlDataProviderSettings\n): Promise<BlankBinding[]> {\n  const bindingGroupsById: Dictionary<BlankBinding[]> = {};\n  for (const binding of blankBindings) {\n    if (binding.newInst) {\n      binding.inst = binding.newInst;\n    }\n    if (!bindingGroupsById[binding.inst.value]) {\n      bindingGroupsById[binding.inst.value] = [];\n    }\n    bindingGroupsById[binding.inst.value].push(binding);\n  }\n\n  const relatedBlankBindnings: BlankBinding[][] = [];\n  for (const b of blankBindings) {\n    if (isRdfBlank(b.blankTrg)) {\n      relatedBlankBindnings.push([b]);\n    }\n  }\n\n  const queryExecutor = new QueryExecutor(queryFunction);\n\n  return loadRelatedBlankNodes(relatedBlankBindnings, queryExecutor, settings).then((loadedGroupsById) => {\n    const idsMap = getEncodedIdDictionary(loadedGroupsById);\n    const groups = Object.keys(bindingGroupsById).map((key) => bindingGroupsById[key]);\n\n    for (const group of groups) {\n      for (const blankBinding of group) {\n        if (!blankBinding.label) {\n          blankBinding.label = createLabelForBlankBinding(blankBinding);\n        }\n        const encodedId4LoadedElement = idsMap[blankBinding.blankTrg.value];\n        if (encodedId4LoadedElement) {\n          blankBinding.blankTrg.value = encodedId4LoadedElement;\n        }\n      }\n      const encodedId = encodeId(group);\n      updateGroupIds(group, encodedId);\n    }\n\n    return blankBindings;\n  });\n}\n\nfunction getEncodedIdDictionary(blankBindingGroups: Dictionary<BlankBinding[]>): Dictionary<string> {\n  const idDictionary: Dictionary<string> = {};\n  const keys = Object.keys(blankBindingGroups);\n  for (const key of keys) {\n    idDictionary[key] = encodeId(blankBindingGroups[key]);\n    updateGroupIds(blankBindingGroups[key], idDictionary[key]);\n  }\n  return idDictionary;\n}\n\nfunction updateGroupIds(group: BlankBinding[], newId: string) {\n  for (const loadedBlankBinding of group) {\n    loadedBlankBinding.inst.value = newId;\n  }\n}\n\nexport function encodeId(blankBindings: BlankBinding[]): string {\n  const bindingSet: Dictionary<BlankBinding> = {};\n  for (const binding of blankBindings) {\n    // leave out instance unique ID\n    const { inst, ...exceptInst } = binding;\n    const encodedBinding = JSON.stringify(exceptInst);\n    bindingSet[encodedBinding] = exceptInst as BlankBinding;\n  }\n\n  const normalizedBindings = Object.keys(bindingSet)\n    .sort()\n    .map((key) => bindingSet[key]);\n  return ENCODED_PREFIX + encodeURI(JSON.stringify(normalizedBindings));\n}\n\nexport function decodeId(id: string): BlankBinding[] {\n  if (!isEncodedBlank(id)) {\n    return undefined;\n  }\n  try {\n    const clearId = id.substring(ENCODED_PREFIX.length, id.length);\n    const parsedBindings: BlankBinding[] = JSON.parse(decodeURI(clearId));\n    const bindings = parsedBindings.map((binding) => {\n      // restore instance unique ID\n      binding.inst = { type: 'uri', value: id };\n      return binding;\n    });\n    return bindings;\n  } catch (error) {\n    /* silent */\n    return undefined;\n  }\n}\n\nexport function createLabelForBlankBinding(bn: BlankBinding): RdfLiteral {\n  if (bn.blankType.value === 'listHead') {\n    return {\n      type: 'literal',\n      value: 'RDFList',\n      'xml:lang': '',\n    };\n  } else {\n    return {\n      type: 'literal',\n      value: bn.class ? getUriLocalName(bn.class.value) || bn.class.value : 'anonymous',\n      'xml:lang': '',\n    };\n  }\n}\n\nfunction loadRelatedBlankNodes(\n  blankChains: BlankBinding[][],\n  queryExecutor: QueryExecutor,\n  settings: SparqlDataProviderSettings,\n  recursionDeep?: number\n): Promise<Dictionary<BlankBinding[]>> {\n  recursionDeep = recursionDeep || 1;\n\n  if (recursionDeep > MAX_RECURSION_DEEP) {\n    return Promise.resolve({});\n  }\n\n  const queryPairs = blankChains.map((chain) => ({\n    query: getQueryForChain(chain, settings),\n    chain: chain,\n  }));\n\n  const promises = queryPairs.map((pair) =>\n    queryExecutor.executeQuery(pair.query).then((response) => ({\n      response: response,\n      chain: pair.chain,\n    }))\n  );\n\n  return Promise.all(promises).then((results) => {\n    const recursionPromises: Promise<boolean>[] = [];\n\n    const loadedBlankBindings: Dictionary<BlankBinding[]> = {};\n    for (const result of results) {\n      const bindings = result.response.results.bindings;\n      if (bindings.length > 0) {\n        const relatedBlankBindings: BlankBinding[][] = [];\n\n        for (const binding of bindings) {\n          if (isRdfBlank(binding.blankTrg)) {\n            relatedBlankBindings.push(result.chain.concat([binding]));\n          }\n        }\n\n        recursionPromises.push(\n          loadRelatedBlankNodes(relatedBlankBindings, queryExecutor, settings, recursionDeep + 1).then(\n            (loadedGroupsById) => {\n              const idsMap = getEncodedIdDictionary(loadedGroupsById);\n              const mergedResults: Dictionary<BlankBinding[]> = {};\n\n              for (const binding of bindings) {\n                binding.label = createLabelForBlankBinding(binding);\n\n                const encodedId = idsMap[binding.blankTrg.value];\n\n                if (encodedId) {\n                  binding.blankTrg.value = encodedId;\n                }\n\n                if (!mergedResults[binding.inst.value]) {\n                  mergedResults[binding.inst.value] = [];\n                }\n\n                mergedResults[binding.inst.value].push(binding);\n              }\n\n              Object.keys(mergedResults).forEach((key) => {\n                const group = mergedResults[key];\n                const originalId = group[0].inst.value;\n                loadedBlankBindings[originalId] = group;\n              });\n\n              return true;\n            }\n          )\n        );\n      }\n    }\n    return Promise.all(recursionPromises).then(() => {\n      return loadedBlankBindings;\n    });\n  });\n}\n\nfunction getQueryForChain(blankNodes: BlankBinding[], sparqlDataProviderSettings: SparqlDataProviderSettings): string {\n  function getQueryBlock(blankNode: BlankBinding, index: number, maxIndex: number) {\n    // if blankNode has type 'listHead' then his target and targetProperty is artificial,\n    // and we can't include this id in chain\n    const trustableTrgProp = index === 0 || blankNode.blankType.value !== 'listHead';\n\n    const sourceId = index > 0 ? '?inst' + (index - 1) : '<' + blankNode.blankSrc.value + '>';\n    const sourcePropId = trustableTrgProp\n      ? index > 0\n        ? '?blankTrgProp' + (index - 1)\n        : '<' + blankNode.blankSrcProp.value + '>'\n      : '?anyType' + index;\n\n    const instPostfix = index === maxIndex ? '' : index.toString();\n\n    const targetPropId = trustableTrgProp ? '<' + blankNode.blankTrgProp.value + '>' : '?anyType0' + index;\n\n    const firstRelation =\n      index === 0 && blankNode.blankType.value === 'listHead'\n        ? `\n            ?blankSrc${index} rdf:rest*/rdf:first ?inst${instPostfix}.\n            `\n        : `?blankSrc${index} ${targetPropId} ?inst${instPostfix}.`;\n\n    return `\n            # ======================\n            ${sourceId} ${sourcePropId} ?blankSrc${index}.\n            ${firstRelation}\n            BIND (<${blankNode.blankTrgProp.value}> as ?blankSrcProp${index}).\n            FILTER (ISBLANK(?inst${instPostfix})).\n            {\n                ?inst${instPostfix} ?blankTrgProp${instPostfix} ?blankTrg${instPostfix}.\n                BIND(\"blankNode\" as ?blankType${instPostfix}).\n                FILTER NOT EXISTS { ?inst${instPostfix} rdf:first _:smth1${index} }.\n            } UNION {\n                ?inst${instPostfix} rdf:rest*/rdf:first ?blankTrg${instPostfix}.\n                ?blankSrc${index} ?blankSrcProp${index} ?inst${instPostfix}.\n                _:smth2${index} rdf:first ?blankTrg${instPostfix}.\n                BIND(?blankSrcProp${index} as ?blankTrgProp${instPostfix})\n                BIND(\"listHead\" as ?blankType${instPostfix})\n                FILTER NOT EXISTS { _:smth3${index} rdf:rest ?inst${instPostfix} }.\n            }\n            OPTIONAL {\n                ?inst${instPostfix} rdf:type ?class${instPostfix}.\n            }\n        `;\n  }\n\n  const body = blankNodes.map((bn, index) => getQueryBlock(bn, index, blankNodes.length - 1)).join('\\n');\n  const query = `${sparqlDataProviderSettings.defaultPrefix}\n    SELECT ?inst ?class ?label ?blankTrgProp ?blankTrg ?blankType\n        WHERE {\n           ${body}\n        }\n    `;\n  return query;\n}\n\nexport function elementInfo(elementIds: string[]): SparqlResponse<ElementBinding> {\n  const ids = elementIds.filter((id) => isEncodedBlank(id));\n\n  return {\n    head: undefined,\n    results: { bindings: getElementBindings(ids) },\n  };\n}\n\nexport function linksInfo(elementIds: string[]): SparqlResponse<LinkBinding> {\n  return {\n    head: undefined,\n    results: { bindings: getLinkBinding(elementIds) },\n  };\n}\n\nexport function linkTypesOf(params: { elementId: string }): SparqlResponse<LinkCountBinding> {\n  return {\n    head: undefined,\n    results: { bindings: getLinkCountBinding(params.elementId) },\n  };\n}\n\nexport function filter(params: FilterParams): SparqlResponse<ElementBinding> {\n  const filterResponse: SparqlResponse<ElementBinding> = {\n    head: undefined,\n    results: { bindings: [] },\n  };\n  if (params.limit === 0) {\n    params.limit = 100;\n  }\n\n  if (params.elementTypeId) {\n    filterResponse.results.bindings = [];\n  } else if (params.refElementId && params.refElementLinkId) {\n    filterResponse.results.bindings = getAllRelatedByLinkTypeElements(\n      params.refElementId,\n      params.refElementLinkId,\n      params.linkDirection\n    );\n  } else if (params.refElementId) {\n    filterResponse.results.bindings = getAllRelatedElements(params.refElementId);\n  }\n\n  if (params.text && filterResponse.results.bindings.length !== 0) {\n    filterResponse.results.bindings = filterResponse.results.bindings.filter(\n      (be) => be.inst.value.toLowerCase().indexOf(params.text) !== -1\n    );\n  }\n\n  return filterResponse;\n}\n\nexport function getElementTypes(elementIds: ReadonlyArray<string>): SparqlResponse<ElementTypeBinding> {\n  const bindings: ElementTypeBinding[] = [];\n  for (const id of elementIds) {\n    const blankBindings = decodeId(id);\n    if (blankBindings) {\n      for (const be of blankBindings) {\n        if (isRdfIri(be.inst) && be.class) {\n          bindings.push({ inst: be.inst, class: be.class });\n        }\n      }\n    }\n  }\n  return { head: undefined, results: { bindings } };\n}\n\nfunction getAllRelatedByLinkTypeElements(\n  refElementId: string,\n  refElementLinkId: string,\n  linkDirection: string\n): ElementBinding[] {\n  const blankElements = (decodeId(refElementId) || []).concat(decodeId(refElementLinkId) || []);\n  let bindings: ElementBinding[] = [];\n  if (blankElements.length > 0) {\n    for (const be of blankElements) {\n      if (linkDirection === 'in') {\n        if (\n          be.inst.value === refElementId &&\n          (isRdfIri(be.blankSrc) || isRdfBlank(be.blankSrc)) &&\n          refElementLinkId === be.blankSrcProp.value\n        ) {\n          if (isRdfIri(be.blankSrc)) {\n            bindings.push({\n              inst: be.blankSrc,\n            });\n          } else {\n            bindings = bindings.concat(decodeId(be.blankSrc.value) || [{ inst: be.blankSrc }]);\n          }\n        } else if (be.blankTrg.value === refElementId && refElementLinkId === be.blankTrgProp.value) {\n          bindings.push(be);\n        }\n      } else {\n        if (\n          be.inst.value === refElementId &&\n          (isRdfIri(be.blankTrg) || isRdfBlank(be.blankTrg)) &&\n          refElementLinkId === be.blankTrgProp.value\n        ) {\n          if (isRdfIri(be.blankTrg)) {\n            bindings.push({\n              inst: be.blankTrg,\n            });\n          } else {\n            bindings = bindings.concat(decodeId(be.blankTrg.value) || [{ inst: be.blankTrg }]);\n          }\n        } else if (be.blankSrc.value === refElementId && refElementLinkId === be.blankSrcProp.value) {\n          bindings.push(be);\n        }\n      }\n    }\n  }\n  return bindings;\n}\n\nfunction getAllRelatedElements(id: string): ElementBinding[] {\n  const blankElements = decodeId(id);\n  let bindings: ElementBinding[] = [];\n  if (blankElements) {\n    for (const be of blankElements) {\n      if (be.inst.value === id || id === be.blankSrc.value || id === be.blankTrg.value) {\n        bindings.push(be);\n        if (isRdfIri(be.blankSrc)) {\n          bindings.push({ inst: be.blankSrc });\n        } else if (isRdfBlank(be.blankSrc)) {\n          bindings = bindings.concat(decodeId(be.blankSrc.value) || [{ inst: be.blankSrc }]);\n        }\n        if (isRdfIri(be.blankTrg)) {\n          bindings.push({ inst: be.blankTrg });\n        } else if (isRdfBlank(be.blankTrg)) {\n          bindings = bindings.concat(decodeId(be.blankTrg.value) || [{ inst: be.blankTrg }]);\n        }\n      }\n    }\n  }\n  return bindings;\n}\n\nfunction getElementBindings(ids: string[]): ElementBinding[] {\n  let blankElements: BlankBinding[] = [];\n  for (const id of ids) {\n    const blankBindings = decodeId(id);\n    if (blankBindings) {\n      blankElements = blankElements.concat(decodeId(id));\n    }\n  }\n  return blankElements.filter((be) => {\n    return ids.indexOf(be.inst.value) !== -1;\n  });\n}\n\nfunction getLinkBinding(ids: string[]): LinkBinding[] {\n  let blankElements: BlankBinding[] = [];\n  for (const id of ids) {\n    const blankBindings = decodeId(id);\n    if (blankBindings) {\n      blankElements = blankElements.concat(decodeId(id));\n    }\n  }\n\n  const bindings: LinkBinding[] = [];\n  for (const be of blankElements) {\n    if (ids.indexOf(be.inst.value) !== -1) {\n      if (\n        (isRdfIri(be.blankSrc) || isRdfBlank(be.blankSrc)) &&\n        isRdfIri(be.blankSrcProp) &&\n        ids.indexOf(be.blankSrc.value) !== -1\n      ) {\n        bindings.push({\n          source: be.blankSrc,\n          type: be.blankSrcProp,\n          target: be.inst,\n        });\n      }\n      if (\n        (isRdfIri(be.blankTrg) || isRdfBlank(be.blankTrg)) &&\n        isRdfIri(be.blankTrgProp) &&\n        ids.indexOf(be.blankTrg.value) !== -1\n      ) {\n        bindings.push({\n          source: be.inst,\n          type: be.blankTrgProp,\n          target: be.blankTrg,\n        });\n      }\n    }\n  }\n  return bindings;\n}\n\nfunction getLinkCountBinding(id: string): LinkCountBinding[] {\n  const blankElements = decodeId(id);\n\n  const bindings: LinkBinding[] = [];\n  const dictionary: Dictionary<LinkCountBinding> = {};\n\n  for (const be of blankElements) {\n    if (id === be.inst.value) {\n      if ((isRdfIri(be.blankTrg) || isRdfBlank(be.blankTrg)) && isRdfIri(be.blankTrgProp)) {\n        if ((isRdfIri(be.blankSrc) || isRdfBlank(be.blankSrc)) && isRdfIri(be.blankSrcProp)) {\n          if (!dictionary[be.blankSrcProp.value]) {\n            dictionary[be.blankSrcProp.value] = {\n              link: be.blankSrcProp,\n              inCount: {\n                type: 'literal',\n                value: '1',\n                'xml:lang': '',\n              },\n              outCount: {\n                type: 'literal',\n                value: '0',\n                'xml:lang': '',\n              },\n            };\n          }\n        }\n        if (!dictionary[be.blankTrgProp.value]) {\n          dictionary[be.blankTrgProp.value] = {\n            link: be.blankTrgProp,\n            inCount: {\n              type: 'literal',\n              value: '0',\n              'xml:lang': '',\n            },\n            outCount: {\n              type: 'literal',\n              value: '1',\n              'xml:lang': '',\n            },\n          };\n        } else {\n          dictionary[be.blankTrgProp.value].outCount.value = (\n            +dictionary[be.blankTrgProp.value].outCount.value + 1\n          ).toString();\n        }\n      }\n    }\n  }\n  return Object.keys(dictionary).map((k) => dictionary[k]);\n}\n","export type RdfNode = RdfIri | RdfLiteral | RdfBlank;\n\nexport interface RdfIri {\n  type: 'uri';\n  value: string;\n}\n\nexport interface RdfBlank {\n  type: 'bnode';\n  value: string;\n}\n\nexport interface RdfLiteral {\n  type: 'literal';\n  value: string;\n  datatype?: string;\n  'xml:lang': string;\n}\n\nexport interface Triple {\n  subject: RdfNode;\n  predicate: RdfNode;\n  object: RdfNode;\n}\n\nexport function isRdfBlank(e: RdfNode): e is RdfBlank {\n  return e && e.type === 'bnode';\n}\n\nexport function isRdfIri(e: RdfNode): e is RdfIri {\n  return e && e.type === 'uri';\n}\n\nexport function isRdfLiteral(e: RdfNode): e is RdfLiteral {\n  return e && e.type === 'literal';\n}\n\nexport interface BlankBinding extends ElementBinding {\n  blankType: {\n    value: 'listHead' | 'blankNode';\n  };\n  blankTrgProp: RdfNode;\n  blankTrg: RdfNode;\n  blankSrc?: RdfNode;\n  blankSrcProp?: RdfNode;\n  newInst?: RdfIri | RdfBlank;\n}\n\nexport function isBlankBinding(binding: ElementBinding | BlankBinding): binding is BlankBinding {\n  const blank = binding as BlankBinding;\n  return (\n    blank.blankTrgProp !== undefined ||\n    blank.blankTrg !== undefined ||\n    blank.blankSrcProp !== undefined ||\n    blank.blankSrc !== undefined\n  );\n}\n\nexport interface ElementBinding {\n  inst: RdfIri | RdfBlank;\n  class?: RdfIri;\n  label?: RdfLiteral;\n  propType?: RdfIri;\n  propValue?: RdfIri | RdfLiteral;\n}\n\nexport interface ClassBinding {\n  class: RdfIri;\n  instcount?: RdfLiteral;\n  label?: RdfLiteral;\n  parent?: RdfIri;\n}\n\nexport interface PropertyBinding {\n  property: RdfIri;\n  label?: RdfLiteral;\n}\n\nexport interface LinkBinding {\n  source: RdfIri | RdfBlank;\n  type: RdfIri;\n  target: RdfIri | RdfBlank;\n  propType?: RdfIri;\n  propValue?: RdfLiteral;\n}\n\nexport interface LinkCountBinding {\n  link: RdfIri | RdfBlank;\n  inCount: RdfLiteral;\n  outCount: RdfLiteral;\n}\n\nexport interface LinkTypeBinding {\n  link: RdfIri;\n  label?: RdfLiteral;\n  instcount?: RdfLiteral;\n}\n\nexport interface ElementImageBinding {\n  inst: RdfIri;\n  linkType: RdfIri;\n  image: RdfIri;\n}\n\nexport interface ElementTypeBinding {\n  inst: RdfIri;\n  class: RdfIri;\n}\n\nexport interface FilterBinding {\n  classAll?: RdfIri;\n  link?: RdfIri;\n  direction?: RdfLiteral;\n}\n\nexport interface SparqlResponse<Binding> {\n  head: { vars: string[] };\n  results: { bindings: Binding[] };\n}\n","import { pick } from 'lodash';\n\nimport { ElementIri, LinkTypeIri } from '../data/model';\nimport { DIAGRAM_CONTEXT_URL_V1 } from '../data/schema';\n\nimport { Element, ElementTemplateState, Link, LinkTemplateState } from '../diagram/elements';\nimport { Vector, Size } from '../diagram/geometry';\n\nexport interface SerializedDiagram {\n  '@context': any;\n  '@type': 'Diagram';\n  layoutData: LayoutData;\n  linkTypeOptions?: ReadonlyArray<LinkTypeOptions>;\n}\n\nexport interface LinkTypeOptions {\n  '@type': 'LinkTypeOptions';\n  property: LinkTypeIri;\n  visible: boolean;\n  showLabel?: boolean;\n}\n\nexport interface LayoutData {\n  '@type': 'Layout';\n  elements: ReadonlyArray<LayoutElement>;\n  links: ReadonlyArray<LayoutLink>;\n}\n\nexport interface LayoutElement {\n  '@type': 'Element';\n  '@id': string;\n  iri: ElementIri;\n  position: Vector;\n  size?: Size;\n  fixedSize?: boolean;\n  angle?: number;\n  isExpanded?: boolean;\n  group?: string;\n  elementState?: ElementTemplateState;\n}\n\nexport interface LayoutLink {\n  '@type': 'Link';\n  '@id': string;\n  property: LinkTypeIri;\n  source: { '@id': string };\n  target: { '@id': string };\n  vertices?: ReadonlyArray<Vector>;\n  linkState?: LinkTemplateState;\n}\n\nconst serializedCellProperties = [\n  // common properties\n  'id',\n  'type',\n  // element properties\n  'size',\n  'fixedSize',\n  'angle',\n  'isExpanded',\n  'position',\n  'iri',\n  'group',\n  // link properties\n  'typeId',\n  'source',\n  'target',\n  'vertices',\n];\n\nexport function emptyDiagram(): SerializedDiagram {\n  return {\n    '@context': DIAGRAM_CONTEXT_URL_V1,\n    '@type': 'Diagram',\n    layoutData: emptyLayoutData(),\n    linkTypeOptions: [],\n  };\n}\n\nexport function emptyLayoutData(): LayoutData {\n  return { '@type': 'Layout', elements: [], links: [] };\n}\n\nexport function convertToSerializedDiagram(params: { layoutData: any; linkTypeOptions: any }): SerializedDiagram {\n  const elements: LayoutElement[] = [];\n  const links: LayoutLink[] = [];\n\n  for (const cell of params.layoutData.cells) {\n    // get rid of unused properties\n    const newCell: any = pick(cell, serializedCellProperties);\n\n    // normalize type\n    if (newCell.type === 'Ontodia.Element' || newCell.type === 'element') {\n      newCell.type = 'Element';\n    }\n\n    // normalize type\n    if (newCell.type === 'link') {\n      newCell.type = 'Link';\n    }\n\n    if (!newCell.iri) {\n      newCell.iri = newCell.id;\n    }\n\n    // rename to @id and @type to match JSON-LD\n    newCell['@id'] = newCell.id;\n    delete newCell.id;\n\n    newCell['@type'] = newCell.type;\n    delete newCell.type;\n\n    // make two separate lists\n    switch (newCell['@type']) {\n      case 'Element':\n        elements.push(newCell);\n        break;\n      case 'Link':\n        // rename internal IDs\n        newCell.source['@id'] = newCell.source.id;\n        delete newCell.source.id;\n        newCell.target['@id'] = newCell.target.id;\n        delete newCell.target.id;\n        // rename typeID to property\n        newCell.property = newCell.typeId;\n        delete newCell.typeId;\n        links.push(newCell);\n        break;\n    }\n  }\n\n  return {\n    ...emptyDiagram(),\n    layoutData: { '@type': 'Layout', elements, links },\n    linkTypeOptions: params.linkTypeOptions,\n  };\n}\n\nexport function makeSerializedDiagram(params: {\n  layoutData?: LayoutData;\n  linkTypeOptions?: ReadonlyArray<LinkTypeOptions>;\n}): SerializedDiagram {\n  const diagram: SerializedDiagram = {\n    ...emptyDiagram(),\n    linkTypeOptions: params.linkTypeOptions,\n  };\n  // layout data is a complex structure we want to persist\n  if (params.layoutData) {\n    diagram.layoutData = params.layoutData;\n  }\n  return diagram;\n}\n\nexport function makeLayoutData(modelElements: ReadonlyArray<Element>, modelLinks: ReadonlyArray<Link>): LayoutData {\n  const elements = modelElements.map(\n    (element): LayoutElement => ({\n      '@type': 'Element',\n      '@id': element.id,\n      iri: element.iri,\n      position: element.position,\n      size: element.size,\n      fixedSize: element.isFixedSize,\n      isExpanded: element.isExpanded,\n      group: element.group,\n      elementState: element.elementState,\n    })\n  );\n  const links = modelLinks.map(\n    (link): LayoutLink => ({\n      '@type': 'Link',\n      '@id': link.id,\n      property: link.typeId,\n      source: { '@id': link.sourceId },\n      target: { '@id': link.targetId },\n      vertices: [...link.vertices],\n      linkState: link.linkState,\n    })\n  );\n  return { '@type': 'Layout', elements, links };\n}\n","import {\n  Dictionary,\n  ElementModel,\n  LinkModel,\n  ClassModel,\n  LinkType,\n  ElementIri,\n  LinkTypeIri,\n  ElementTypeIri,\n  PropertyTypeIri,\n} from '../data/model';\nimport { DataProvider } from '../data/provider';\nimport { PLACEHOLDER_LINK_TYPE } from '../data/schema';\n\nimport { Element, FatLinkType, FatClassModel, RichProperty, FatLinkTypeEvents, Link } from '../diagram/elements';\nimport { CommandHistory, Command } from '../diagram/history';\nimport { DiagramModel, DiagramModelEvents, placeholderDataFromIri } from '../diagram/model';\n\nimport { EventSource, Events, Listener } from '../viewUtils/events';\n\nimport { DataFetcher } from './dataFetcher';\nimport {\n  LayoutData,\n  LayoutElement,\n  makeLayoutData,\n  convertToSerializedDiagram,\n  emptyDiagram,\n  LinkTypeOptions,\n  SerializedDiagram,\n  makeSerializedDiagram,\n  emptyLayoutData,\n} from './serializedDiagram';\n\nexport interface GroupBy {\n  linkType: string;\n  linkDirection: 'in' | 'out';\n}\n\nexport interface AsyncModelEvents extends DiagramModelEvents {\n  loadingStart: { source: AsyncModel };\n  loadingSuccess: { source: AsyncModel };\n  loadingError: {\n    source: AsyncModel;\n    error: any;\n  };\n  createLoadedLink: {\n    source: AsyncModel;\n    model: LinkModel;\n    cancel(): void;\n  };\n}\n\nexport class AsyncModel extends DiagramModel {\n  readonly events: Events<AsyncModelEvents>;\n\n  private _dataProvider: DataProvider;\n  private fetcher: DataFetcher;\n\n  private linkSettings: { [linkTypeId: string]: LinkTypeOptions } = {};\n\n  constructor(history: CommandHistory, private groupByProperties: ReadonlyArray<GroupBy>) {\n    super(history);\n  }\n\n  private get asyncSource(): EventSource<AsyncModelEvents> {\n    return this.source as EventSource<any>;\n  }\n\n  get dataProvider() {\n    return this._dataProvider;\n  }\n\n  subscribeGraph() {\n    super.subscribeGraph();\n\n    this.graphListener.listen(this.graph.events, 'linkTypeEvent', (e) => {\n      if (e.key === 'changeVisibility') {\n        this.onLinkTypeVisibilityChanged(e.data[e.key], e.key);\n      }\n    });\n  }\n\n  private setDataProvider(dataProvider: DataProvider) {\n    this._dataProvider = dataProvider;\n    this.fetcher = new DataFetcher(this.graph, dataProvider);\n  }\n\n  createNewDiagram(dataProvider: DataProvider): Promise<void> {\n    this.resetGraph();\n    this.setDataProvider(dataProvider);\n    this.asyncSource.trigger('loadingStart', { source: this });\n\n    return this.dataProvider\n      .linkTypes()\n      .then((linkTypes: LinkType[]) => {\n        const allLinkTypes = this.initLinkTypes(linkTypes);\n        return this.loadAndRenderLayout({\n          allLinkTypes,\n          markLinksAsLayoutOnly: false,\n        });\n      })\n      .catch((error) => {\n        // tslint:disable-next-line:no-console\n        console.error(error);\n        this.asyncSource.trigger('loadingError', { source: this, error });\n        return Promise.reject(error);\n      });\n  }\n\n  importLayout(params: {\n    dataProvider: DataProvider;\n    preloadedElements?: Dictionary<ElementModel>;\n    validateLinks?: boolean;\n    diagram?: SerializedDiagram;\n    hideUnusedLinkTypes?: boolean;\n  }): Promise<void> {\n    this.resetGraph();\n    this.setDataProvider(params.dataProvider);\n    this.asyncSource.trigger('loadingStart', { source: this });\n\n    return this.dataProvider\n      .linkTypes()\n      .then((linkTypes) => {\n        const allLinkTypes = this.initLinkTypes(linkTypes);\n        const diagram = params.diagram ? params.diagram : emptyDiagram();\n        this.setLinkSettings(diagram.linkTypeOptions);\n        const loadingModels = this.loadAndRenderLayout({\n          layoutData: diagram.layoutData,\n          preloadedElements: params.preloadedElements || {},\n          markLinksAsLayoutOnly: params.validateLinks || false,\n          allLinkTypes,\n          hideUnusedLinkTypes: params.hideUnusedLinkTypes,\n        });\n        const requestingLinks = params.validateLinks ? this.requestLinksOfType() : Promise.resolve();\n        return Promise.all([loadingModels, requestingLinks]);\n      })\n      .then(() => {\n        this.asyncSource.trigger('loadingSuccess', { source: this });\n      })\n      .catch((error) => {\n        // tslint:disable-next-line:no-console\n        console.error(error);\n        this.asyncSource.trigger('loadingError', { source: this, error });\n        return Promise.reject(error);\n      });\n  }\n\n  exportLayout(): SerializedDiagram {\n    const layoutData = makeLayoutData(this.graph.getElements(), this.graph.getLinks());\n    const linkTypeOptions = this.graph\n      .getLinkTypes()\n      // do not serialize default link type options\n      .filter((linkType) => (!linkType.visible || !linkType.showLabel) && linkType.id !== PLACEHOLDER_LINK_TYPE)\n      .map(\n        ({ id, visible, showLabel }): LinkTypeOptions => ({\n          '@type': 'LinkTypeOptions',\n          property: id,\n          visible,\n          showLabel,\n        })\n      );\n    return makeSerializedDiagram({ layoutData, linkTypeOptions });\n  }\n\n  private initLinkTypes(linkTypes: LinkType[]): FatLinkType[] {\n    const types: FatLinkType[] = [];\n    for (const { id, label } of linkTypes) {\n      const linkType = new FatLinkType({ id, label: label.values });\n      this.graph.addLinkType(linkType);\n      types.push(linkType);\n    }\n    return types;\n  }\n\n  private setLinkSettings(settings: ReadonlyArray<LinkTypeOptions>) {\n    if (!settings) {\n      return;\n    }\n    for (const setting of settings) {\n      const { visible = true, showLabel = true } = setting;\n      const linkTypeId = setting.property as LinkTypeIri;\n      this.linkSettings[linkTypeId] = { '@type': 'LinkTypeOptions', property: linkTypeId, visible, showLabel };\n      const linkType = this.getLinkType(linkTypeId);\n      if (linkType) {\n        linkType.setVisibility({ visible, showLabel });\n      }\n    }\n  }\n\n  private loadAndRenderLayout(params: {\n    layoutData?: LayoutData;\n    preloadedElements?: Dictionary<ElementModel>;\n    markLinksAsLayoutOnly: boolean;\n    allLinkTypes: ReadonlyArray<FatLinkType>;\n    hideUnusedLinkTypes?: boolean;\n  }) {\n    const {\n      layoutData = emptyLayoutData(),\n      preloadedElements = {},\n      markLinksAsLayoutOnly,\n      hideUnusedLinkTypes,\n    } = params;\n\n    const elementIrisToRequestData: ElementIri[] = [];\n    const usedLinkTypes: { [typeId: string]: FatLinkType } = {};\n\n    for (const layoutElement of layoutData.elements) {\n      const { '@id': id, iri, position, size, fixedSize, isExpanded, group, elementState } = layoutElement;\n      const template = preloadedElements[iri];\n      const data = template || placeholderDataFromIri(iri);\n      const element = new Element({ id, data, position, size, fixedSize, expanded: isExpanded, group, elementState });\n      this.graph.addElement(element);\n      if (!template) {\n        elementIrisToRequestData.push(element.iri);\n      }\n    }\n\n    for (const layoutLink of layoutData.links) {\n      const { '@id': id, property, source, target, vertices, linkState } = layoutLink;\n      const linkType = this.createLinkType(property);\n      usedLinkTypes[linkType.id] = linkType;\n      const link = this.addLink(\n        new Link({\n          id,\n          typeId: linkType.id,\n          sourceId: source['@id'],\n          targetId: target['@id'],\n          vertices,\n          linkState,\n        })\n      );\n      if (link) {\n        link.setLayoutOnly(markLinksAsLayoutOnly);\n      }\n    }\n\n    this.subscribeGraph();\n    const requestingModels = this.requestElementData(elementIrisToRequestData);\n\n    if (hideUnusedLinkTypes && params.allLinkTypes) {\n      this.hideUnusedLinkTypes(params.allLinkTypes, usedLinkTypes);\n    }\n\n    return requestingModels;\n  }\n\n  private hideUnusedLinkTypes(allTypes: ReadonlyArray<FatLinkType>, usedTypes: { [typeId: string]: FatLinkType }) {\n    for (const linkType of allTypes) {\n      if (!usedTypes[linkType.id]) {\n        linkType.setVisibility({\n          visible: false,\n          showLabel: linkType.showLabel,\n        });\n      }\n    }\n  }\n\n  requestElementData(elementIris: ReadonlyArray<ElementIri>): Promise<void> {\n    return this.fetcher.fetchElementData(elementIris);\n  }\n\n  requestLinksOfType(linkTypeIds?: LinkTypeIri[]): Promise<void> {\n    const linkTypes =\n      linkTypeIds ||\n      this.graph\n        .getLinkTypes()\n        .filter((type) => type.visible)\n        .map((type) => type.id);\n    return this.dataProvider\n      .linksInfo({\n        elementIds: this.graph.getElements().map((element) => element.iri),\n        linkTypeIds: linkTypes,\n      })\n      .then((links) => this.onLinkInfoLoaded(links));\n  }\n\n  createClass(classId: ElementTypeIri): FatClassModel {\n    if (this.graph.getClass(classId)) {\n      return super.getClass(classId);\n    }\n    const classModel = super.createClass(classId);\n    this.fetcher.fetchClass(classModel);\n    return classModel;\n  }\n\n  createLinkType(linkTypeId: LinkTypeIri): FatLinkType {\n    if (this.graph.getLinkType(linkTypeId)) {\n      return super.createLinkType(linkTypeId);\n    }\n    const linkType = super.createLinkType(linkTypeId);\n    const setting = this.linkSettings[linkType.id];\n    if (setting) {\n      const { visible, showLabel } = setting;\n      linkType.setVisibility({ visible, showLabel, preventLoading: true });\n    }\n    this.fetcher.fetchLinkType(linkType);\n    return linkType;\n  }\n\n  createProperty(propertyIri: PropertyTypeIri): RichProperty {\n    if (this.graph.getProperty(propertyIri)) {\n      return super.createProperty(propertyIri);\n    }\n    const property = super.createProperty(propertyIri);\n    this.fetcher.fetchPropertyType(property);\n    return property;\n  }\n\n  private onLinkTypeVisibilityChanged: Listener<FatLinkTypeEvents, 'changeVisibility'> = (e) => {\n    if (e.source.visible) {\n      if (!e.preventLoading) {\n        this.requestLinksOfType([e.source.id]);\n      }\n    } else {\n      for (const link of this.linksOfType(e.source.id)) {\n        this.graph.removeLink(link.id);\n      }\n    }\n  };\n\n  private onLinkInfoLoaded(links: LinkModel[]) {\n    let allowToCreate: boolean;\n    const cancel = () => {\n      allowToCreate = false;\n    };\n\n    for (const linkModel of links) {\n      this.createLinkType(linkModel.linkTypeId);\n      allowToCreate = true;\n      this.asyncSource.trigger('createLoadedLink', { source: this, model: linkModel, cancel });\n      if (allowToCreate) {\n        this.createLinks(linkModel);\n      }\n    }\n  }\n\n  createLinks(data: LinkModel) {\n    const sources = this.graph.getElements().filter((el) => el.iri === data.sourceId);\n    const targets = this.graph.getElements().filter((el) => el.iri === data.targetId);\n    const typeId = data.linkTypeId;\n\n    for (const source of sources) {\n      for (const target of targets) {\n        this.addLink(new Link({ typeId, sourceId: source.id, targetId: target.id, data }));\n      }\n    }\n  }\n\n  loadEmbeddedElements(elementIri: ElementIri): Promise<Dictionary<ElementModel>> {\n    const elements = this.groupByProperties.map((groupBy) =>\n      this.dataProvider.linkElements({\n        elementId: elementIri,\n        linkId: groupBy.linkType as LinkTypeIri,\n        offset: 0,\n        direction: groupBy.linkDirection,\n      })\n    );\n    return Promise.all(elements).then((res) => res.reduce((memo, current) => Object.assign(memo, current), {}));\n  }\n}\n\nexport function requestElementData(model: AsyncModel, elementIris: ReadonlyArray<ElementIri>): Command {\n  return Command.effect('Fetch element data', () => {\n    model.requestElementData(elementIris);\n  });\n}\n\nexport function restoreLinksBetweenElements(model: AsyncModel): Command {\n  return Command.effect('Restore links between elements', () => {\n    model.requestLinksOfType();\n  });\n}\n","import * as React from 'react';\n\nexport interface Props extends React.HTMLAttributes<HTMLDivElement> {\n  onBeginDragHandle: (e: React.MouseEvent<HTMLDivElement>) => void;\n  onDragHandle: (e: MouseEvent, dx: number, dy: number) => void;\n  onEndDragHandle?: (e: MouseEvent) => void;\n}\n\nexport class DraggableHandle extends React.Component<Props, {}> {\n  private isHoldingMouse = false;\n  private originPageX: number;\n  private originPageY: number;\n\n  render() {\n    // remove custom handlers from `div` props\n    // tslint:disable-next-line:no-unused-variable\n    const { onBeginDragHandle, onDragHandle, onEndDragHandle, ...props } = this.props;\n    return (\n      <div {...props} onMouseDown={this.onHandleMouseDown}>\n        {this.props.children}\n      </div>\n    );\n  }\n\n  componentWillUnmount() {\n    this.removeListeners();\n  }\n\n  private onHandleMouseDown = (e: React.MouseEvent<HTMLDivElement>) => {\n    if (e.target !== e.currentTarget) {\n      return;\n    }\n    if (this.isHoldingMouse) {\n      return;\n    }\n\n    const LEFT_BUTTON = 0;\n    if (e.button !== LEFT_BUTTON) {\n      return;\n    }\n\n    this.isHoldingMouse = true;\n    this.originPageX = e.pageX;\n    this.originPageY = e.pageY;\n    document.addEventListener('mousemove', this.onMouseMove);\n    document.addEventListener('mouseup', this.onMouseUp);\n    this.props.onBeginDragHandle(e);\n  };\n\n  private onMouseMove = (e: MouseEvent) => {\n    if (!this.isHoldingMouse) {\n      return;\n    }\n    e.preventDefault();\n    this.props.onDragHandle(e, e.pageX - this.originPageX, e.pageY - this.originPageY);\n  };\n\n  private onMouseUp = (e: MouseEvent) => {\n    this.removeListeners();\n    if (this.props.onEndDragHandle) {\n      this.props.onEndDragHandle(e);\n    }\n  };\n\n  private removeListeners() {\n    if (this.isHoldingMouse) {\n      this.isHoldingMouse = false;\n      document.removeEventListener('mousemove', this.onMouseMove);\n      document.removeEventListener('mouseup', this.onMouseUp);\n    }\n  }\n}\n","import * as React from 'react';\n\nimport { ElementModel, ElementIri } from '../data/model';\nimport { DiagramView } from '../diagram/view';\nimport { cloneSet } from '../viewUtils/collections';\nimport { Debouncer } from '../viewUtils/async';\nimport { EventObserver } from '../viewUtils/events';\nimport { ListElementView, startDragElements } from './listElementView';\n\nconst CLASS_NAME = 'ontodia-search-results';\n\nexport interface SearchResultProps {\n  view: DiagramView;\n  items: ReadonlyArray<ElementModel>;\n  selection: ReadonlySet<ElementIri>;\n  onSelectionChanged: (newSelection: ReadonlySet<ElementIri>) => void;\n  highlightText?: string;\n  /** @default true */\n  useDragAndDrop?: boolean;\n}\n\nconst enum Direction {\n  Up,\n  Down,\n}\n\nexport class SearchResults extends React.Component<SearchResultProps, {}> {\n  static defaultProps: Partial<SearchResultProps> = {\n    useDragAndDrop: true,\n  };\n\n  private readonly listener = new EventObserver();\n  private readonly delayedChangeCells = new Debouncer();\n\n  private root: HTMLElement;\n\n  private startSelection = 0;\n  private endSelection = 0;\n\n  constructor(props: SearchResultProps) {\n    super(props);\n    this.state = {\n      selection: props.selection || {},\n    };\n  }\n\n  render(): React.ReactElement<any> {\n    const items = this.props.items || [];\n    return (\n      <ul\n        className={CLASS_NAME}\n        ref={this.onRootMount}\n        tabIndex={-1}\n        onFocus={this.addKeyListener}\n        onBlur={this.removeKeyListener}\n      >\n        {items.map(this.renderResultItem)}\n      </ul>\n    );\n  }\n\n  private onRootMount = (root: HTMLElement) => {\n    this.root = root;\n  };\n\n  private renderResultItem = (model: ElementModel) => {\n    const { useDragAndDrop } = this.props;\n    const canBeSelected = this.canBeSelected(model);\n    return (\n      <ListElementView\n        key={model.id}\n        model={model}\n        view={this.props.view}\n        highlightText={this.props.highlightText}\n        disabled={!canBeSelected}\n        selected={this.props.selection.has(model.id)}\n        onClick={canBeSelected ? this.onItemClick : undefined}\n        onDragStart={\n          useDragAndDrop\n            ? (e) => {\n                const { selection } = this.props;\n                const iris: ElementIri[] = [];\n                selection.forEach((iri) => iris.push(iri));\n                if (!selection.has(model.id)) {\n                  iris.push(model.id);\n                }\n                return startDragElements(e, iris);\n              }\n            : undefined\n        }\n      />\n    );\n  };\n\n  componentDidMount() {\n    this.listener.listen(this.props.view.model.events, 'changeCells', () => {\n      this.delayedChangeCells.call(this.onChangeCells);\n    });\n  }\n\n  private onChangeCells = () => {\n    const { items, selection } = this.props;\n    if (selection.size === 0) {\n      if (items && items.length > 0) {\n        // redraw \"already on diagram\" state\n        this.forceUpdate();\n      }\n    } else {\n      const newSelection = cloneSet(selection);\n      for (const element of this.props.view.model.elements) {\n        if (element.group === undefined && selection.has(element.iri)) {\n          newSelection.delete(element.iri);\n        }\n      }\n      this.updateSelection(newSelection);\n    }\n  };\n\n  componentWillReceiveProps(props: SearchResultProps) {\n    this.setState({ selection: props.selection || {} });\n  }\n\n  componentWillUnmount() {\n    this.removeKeyListener();\n    this.listener.stopListening();\n    this.delayedChangeCells.dispose();\n  }\n\n  private updateSelection(selection: ReadonlySet<ElementIri>) {\n    const { onSelectionChanged } = this.props;\n    onSelectionChanged(selection);\n  }\n\n  private addKeyListener = () => {\n    document.addEventListener('keydown', this.onKeyUp);\n  };\n\n  private removeKeyListener = () => {\n    document.removeEventListener('keydown', this.onKeyUp);\n  };\n\n  private onKeyUp = (event: KeyboardEvent) => {\n    const { items } = this.props;\n    const isPressedUp = event.keyCode === 38 || event.which === 38;\n    const isPressDown = event.keyCode === 40 || event.which === 40;\n\n    if (isPressedUp || isPressDown) {\n      if (event.shiftKey) {\n        // select range\n        if (isPressedUp) {\n          this.endSelection = this.getNextIndex(this.endSelection, Direction.Up);\n        } else if (isPressDown) {\n          this.endSelection = this.getNextIndex(this.endSelection, Direction.Down);\n        }\n        const startIndex = Math.min(this.startSelection, this.endSelection);\n        const finishIndex = Math.max(this.startSelection, this.endSelection);\n        const selection = this.selectRange(startIndex, finishIndex);\n\n        this.updateSelection(selection);\n        this.focusOn(this.endSelection);\n      } else {\n        // change focus\n        const startIndex = Math.min(this.startSelection, this.endSelection);\n        const finishIndex = Math.max(this.startSelection, this.endSelection);\n\n        if (isPressedUp) {\n          this.startSelection = this.getNextIndex(startIndex, Direction.Up);\n        } else if (isPressDown) {\n          this.startSelection = this.getNextIndex(finishIndex, Direction.Down);\n        }\n        this.endSelection = this.startSelection;\n\n        const focusElement = items[this.startSelection];\n        const newSelection = new Set<ElementIri>();\n        newSelection.add(focusElement.id);\n\n        this.updateSelection(newSelection);\n        this.focusOn(this.startSelection);\n      }\n    }\n    event.preventDefault();\n  };\n\n  private onItemClick = (event: React.MouseEvent<any>, model: ElementModel) => {\n    event.preventDefault();\n\n    const { items, selection, onSelectionChanged } = this.props;\n    const previouslySelected = selection.has(model.id);\n    const modelIndex = items.indexOf(model);\n\n    let newSelection: Set<ElementIri>;\n\n    if (event.shiftKey && this.startSelection !== -1) {\n      // select range\n      const start = Math.min(this.startSelection, modelIndex);\n      const end = Math.max(this.startSelection, modelIndex);\n      newSelection = this.selectRange(start, end);\n    } else {\n      this.endSelection = this.startSelection = modelIndex;\n      const ctrlKey = event.ctrlKey || event.metaKey;\n\n      if (ctrlKey) {\n        // select/deselect\n        newSelection = cloneSet(selection);\n        if (selection.has(model.id)) {\n          newSelection.delete(model.id);\n        } else {\n          newSelection.add(model.id);\n        }\n      } else {\n        // single click\n        newSelection = new Set<ElementIri>();\n        newSelection.add(model.id);\n      }\n    }\n\n    onSelectionChanged(newSelection);\n  };\n\n  private selectRange(start: number, end: number): Set<ElementIri> {\n    const { items } = this.props;\n    const selection = new Set<ElementIri>();\n    for (let i = start; i <= end; i++) {\n      const selectedModel = items[i];\n      if (this.canBeSelected(selectedModel)) {\n        selection.add(selectedModel.id);\n      }\n    }\n    return selection;\n  }\n\n  private getNextIndex(startIndex: number, direction: Direction) {\n    const { items } = this.props;\n    if (items.length === 0) {\n      return startIndex;\n    }\n    const indexDelta = direction === Direction.Up ? -1 : 1;\n    for (let step = 1; step < items.length; step++) {\n      let nextIndex = startIndex + step * indexDelta;\n      if (nextIndex < 0) {\n        nextIndex += items.length;\n      }\n      if (nextIndex >= items.length) {\n        nextIndex -= items.length;\n      }\n      if (this.canBeSelected(items[nextIndex])) {\n        return nextIndex;\n      }\n    }\n    return startIndex;\n  }\n\n  private canBeSelected(model: ElementModel) {\n    const alreadyOnDiagram =\n      this.props.view.model.elements.findIndex((element) => element.iri === model.id && element.group === undefined) >=\n      0;\n    return !this.props.useDragAndDrop || !alreadyOnDiagram;\n  }\n\n  private focusOn(index: number) {\n    const scrollableContainer = this.root.parentElement;\n\n    const containerBounds = scrollableContainer.getBoundingClientRect();\n\n    const item = this.root.children.item(index) as HTMLElement;\n    const itemBounds = item.getBoundingClientRect();\n    const itemTop = itemBounds.top - containerBounds.top;\n    const itemBottom = itemBounds.bottom - containerBounds.top;\n\n    if (itemTop < 0) {\n      scrollableContainer.scrollTop += itemTop;\n    } else if (itemBottom > containerBounds.height) {\n      scrollableContainer.scrollTop += itemBottom - containerBounds.height;\n    }\n\n    item.focus();\n  }\n}\n","import { TemplateResolver } from '../props';\n\nexport * from './default';\nexport * from './group';\nexport * from './standard';\n\nexport const DefaultElementTemplateBundle: TemplateResolver = (types) => undefined;\n","import { Dictionary, Property, isIriProperty, isLiteralProperty } from '../../data/model';\n\nexport function getProperty(props: Dictionary<Property>, id: string) {\n  if (props && props[id]) {\n    return getPropertyValues(props[id]).join(', ');\n  } else {\n    return undefined;\n  }\n}\n\nexport function getPropertyValues(property: Property): string[] {\n  if (isIriProperty(property)) {\n    return property.values.map(({ value }) => value);\n  } else if (isLiteralProperty(property)) {\n    return property.values.map(({ value }) => value);\n  }\n  return [];\n}\n","import * as React from 'react';\n\nimport { Dictionary, ElementModel, ElementIri } from '../data/model';\nimport { Paper, PaperTransform } from './paper';\nimport { PaperAreaContextTypes, PaperAreaContextWrapper } from './paperArea';\nimport { Element, Cell } from './elements';\nimport { ElementLayer, ElementContextWrapper, ElementContextTypes } from './elementLayer';\nimport { EventObserver } from '../viewUtils/events';\n\nimport { Vector, Rect } from './geometry';\nimport { getContentFittingBox } from './paperArea';\nimport { DiagramView } from './view';\n\nexport interface State {\n  paperWidth?: number;\n  paperHeight?: number;\n  offsetX?: number;\n  offsetY?: number;\n}\n\nexport class EmbeddedLayer extends React.Component<{}, State> {\n  static contextTypes = { ...ElementContextTypes, ...PaperAreaContextTypes };\n\n  context: ElementContextWrapper & PaperAreaContextWrapper;\n\n  private readonly listener = new EventObserver();\n  private nestedElementListener = new EventObserver();\n\n  private layerOffsetLeft = 0;\n  private layerOffsetTop = 0;\n\n  private isApplyingParentMove = false;\n  private isNestedElementMoving = false;\n  private previousPositions: Array<{ id: string; position: Vector }> = [];\n\n  constructor(props: {}) {\n    super(props);\n    this.state = { paperWidth: 0, paperHeight: 0, offsetX: 0, offsetY: 0 };\n  }\n\n  componentDidMount() {\n    const { element } = this.context.ontodiaElement;\n    const { paperArea, view } = this.context.ontodiaPaperArea;\n\n    this.listener.listen(view.model.events, 'changeGroupContent', ({ group }) => {\n      if (group === element.id) {\n        this.listenNestedElements(this.getNestedElements());\n        const { offsetX, offsetY } = this.getOffset();\n        this.moveNestedElements(offsetX, offsetY);\n      }\n    });\n\n    this.listener.listen(element.events, 'changePosition', () => {\n      if (this.isNestedElementMoving) {\n        return;\n      }\n\n      const { offsetX, offsetY } = this.getOffset();\n      const { x, y } = this.getContentFittingBox();\n\n      const diffX = offsetX - x;\n      const diffY = offsetY - y;\n      this.moveNestedElements(diffX, diffY);\n\n      this.setState({ offsetX, offsetY });\n    });\n\n    this.listener.listen(paperArea.events, 'pointerUp', (e) => {\n      this.isNestedElementMoving = false;\n    });\n\n    const nestedElements = this.getNestedElements();\n    this.listenNestedElements(nestedElements);\n\n    if (nestedElements.length > 0) {\n      const { x: offsetX, y: offsetY, width: paperWidth, height: paperHeight } = this.getContentFittingBox();\n      this.setState({ offsetX, offsetY, paperWidth, paperHeight }, () => element.redraw());\n    } else {\n      element.requestGroupContent();\n    }\n  }\n\n  private listenNestedElements(nestedElements: ReadonlyArray<Element>) {\n    const listener = new EventObserver();\n    for (const nestedElement of nestedElements) {\n      listener.listen(nestedElement.events, 'changePosition', this.recomputeSelfBounds);\n      listener.listen(nestedElement.events, 'changeSize', this.recomputeSelfBounds);\n    }\n    this.nestedElementListener.stopListening();\n    this.nestedElementListener = listener;\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n    this.nestedElementListener.stopListening();\n    this.removeElements();\n    this.setState({ paperWidth: 0, paperHeight: 0, offsetX: 0, offsetY: 0 });\n  }\n\n  private getNestedElements() {\n    const { element } = this.context.ontodiaElement;\n    const { view } = this.context.ontodiaPaperArea;\n    return view.model.elements.filter((el) => el.group === element.id);\n  }\n\n  private getContentFittingBox(): Rect {\n    const nestedElements = this.getNestedElements();\n    return getContentFittingBox(nestedElements, []);\n  }\n\n  private removeElements() {\n    const { view } = this.context.ontodiaPaperArea;\n    const batch = view.model.history.startBatch();\n    for (const element of this.getNestedElements()) {\n      view.model.removeElement(element.id);\n    }\n    batch.discard();\n  }\n\n  private getOffset(): { offsetX: number; offsetY: number } {\n    const { element } = this.context.ontodiaElement;\n    const { x: elementX, y: elementY } = element.position;\n\n    const offsetX = elementX + this.layerOffsetLeft;\n    const offsetY = elementY + this.layerOffsetTop;\n\n    return { offsetX, offsetY };\n  }\n\n  private moveNestedElements = (offsetX: number, offsetY: number) => {\n    this.isApplyingParentMove = true;\n    try {\n      for (const element of this.getNestedElements()) {\n        const { x, y } = element.position;\n        const newPosition = { x: x + offsetX, y: y + offsetY };\n        element.setPosition(newPosition);\n      }\n    } finally {\n      this.isApplyingParentMove = false;\n      this.recomputeSelfBounds();\n    }\n  };\n\n  private recomputeSelfBounds = () => {\n    if (this.isApplyingParentMove) {\n      return;\n    }\n\n    const { element } = this.context.ontodiaElement;\n    const { x: offsetX, y: offsetY, width: paperWidth, height: paperHeight } = this.getContentFittingBox();\n\n    if (this.isNestedElementMoving) {\n      const position = {\n        x: offsetX - this.layerOffsetLeft,\n        y: offsetY - this.layerOffsetTop,\n      };\n      element.setPosition(position);\n    }\n\n    this.setState({ offsetX, offsetY, paperWidth, paperHeight }, () => element.redraw());\n  };\n\n  private onPaperPointerDown = (e: React.MouseEvent<HTMLElement>, cell: Cell | undefined) => {\n    if (e.button !== 0 /* left mouse button */) {\n      return;\n    }\n\n    if (cell && cell instanceof Element) {\n      e.preventDefault();\n      this.isNestedElementMoving = true;\n    }\n  };\n\n  private calculateOffset(layer: HTMLElement): { left: number; top: number } {\n    const { paperArea } = this.context.ontodiaPaperArea;\n    const scale = paperArea.getScale();\n    const parent = findParentElement(layer);\n    const { left, top } = layer.getBoundingClientRect();\n    const { left: parentLeft, top: parentTop } = parent.getBoundingClientRect();\n\n    return { left: (left - parentLeft) / scale, top: (top - parentTop) / scale };\n  }\n\n  private onLayerInit = (layer: HTMLElement) => {\n    if (!layer) {\n      return;\n    }\n\n    const { left, top } = this.calculateOffset(layer);\n\n    this.layerOffsetLeft = left;\n    this.layerOffsetTop = top;\n  };\n\n  render() {\n    const { element } = this.context.ontodiaElement;\n    const { view } = this.context.ontodiaPaperArea;\n    const { paperWidth, paperHeight, offsetX, offsetY } = this.state;\n\n    const paperTransform: PaperTransform = {\n      width: paperWidth,\n      height: paperHeight,\n      originX: -offsetX,\n      originY: -offsetY,\n      scale: 1,\n      paddingX: 0,\n      paddingY: 0,\n    };\n\n    return (\n      <div className=\"ontodia-embedded-layer\" ref={this.onLayerInit}>\n        <Paper\n          view={view}\n          paperTransform={paperTransform}\n          onPointerDown={this.onPaperPointerDown}\n          group={element.id}\n        ></Paper>\n      </div>\n    );\n  }\n}\n\nfunction findParentElement(layer: HTMLElement): HTMLElement {\n  const parent = layer.parentElement;\n  if (!parent) {\n    throw new Error('Cannot find parent diagram element for EmbeddedLayer');\n  } else if (parent.hasAttribute('data-element-id')) {\n    return parent;\n  } else {\n    return findParentElement(parent);\n  }\n}\n","import * as React from 'react';\nimport { findDOMNode } from 'react-dom';\nimport { hcl } from 'd3-color';\n\nimport { Property, ElementTypeIri, PropertyTypeIri } from '../data/model';\nimport { TemplateProps } from '../customization/props';\nimport { Debouncer } from '../viewUtils/async';\nimport { EventObserver } from '../viewUtils/events';\nimport { PropTypes } from '../viewUtils/react';\nimport { KeyedObserver, observeElementTypes, observeProperties } from '../viewUtils/keyedObserver';\n\nimport { setElementExpanded } from './commands';\nimport { Element } from './elements';\nimport { DiagramView, RenderingLayer, IriClickIntent } from './view';\n\nexport interface Props {\n  view: DiagramView;\n  group?: string;\n  style: React.CSSProperties;\n\n  // we need to have scale in the element layer to properly\n  // calculate size of the element on element resize by user\n  scale: number;\n}\n\ninterface State {\n  readonly elementStates?: ReadonlyMap<string, ElementState>;\n}\n\ninterface ElementState {\n  element: Element;\n  templateProps: TemplateProps;\n  blurred: boolean;\n}\n\n// tslint:disable:no-bitwise\nenum RedrawFlags {\n  None = 0,\n  Render = 1,\n  RecomputeTemplate = 1 | 2,\n  RecomputeBlurred = 1 | 4,\n}\n// tslint:enable:no-bitwise\n\ninterface RedrawBatch {\n  requests: Map<string, RedrawFlags>;\n  forAll: RedrawFlags;\n}\n\ninterface SizeUpdateRequest {\n  element: Element;\n  node: HTMLDivElement;\n}\n\nexport class ElementLayer extends React.Component<Props, State> {\n  private readonly listener = new EventObserver();\n\n  private redrawBatch: RedrawBatch = {\n    requests: new Map<string, RedrawFlags>(),\n    forAll: RedrawFlags.None,\n  };\n  private delatedRedraw = new Debouncer();\n\n  private sizeRequests = new Map<string, SizeUpdateRequest>();\n  private delayedUpdateSizes = new Debouncer();\n\n  private layer: HTMLDivElement;\n\n  constructor(props: Props, context: any) {\n    super(props, context);\n    const { view, group } = this.props;\n    this.state = {\n      elementStates: applyRedrawRequests(view, group, this.redrawBatch, new Map<string, ElementState>()),\n    };\n  }\n\n  render() {\n    const { view, style, scale } = this.props;\n    const { elementStates } = this.state;\n\n    const elementsToRender: ElementState[] = [];\n    for (const { id } of view.model.elements) {\n      const state = elementStates.get(id);\n      if (state) {\n        elementsToRender.push(state);\n      }\n    }\n\n    return (\n      <div className=\"ontodia-element-layer\" ref={this.onMount} style={style}>\n        {elementsToRender.map((state) => {\n          const overlayElement = (\n            <OverlayedElement\n              key={state.element.id}\n              state={state}\n              view={view}\n              scale={scale}\n              onInvalidate={this.requestRedraw}\n              requestResize={this.requestSizeUpdate}\n            />\n          );\n          const elementDecorator = view._decorateElement(state.element);\n          if (elementDecorator) {\n            return (\n              <div key={state.element.id}>\n                {overlayElement}\n                {elementDecorator}\n              </div>\n            );\n          }\n          return overlayElement;\n        })}\n      </div>\n    );\n  }\n\n  private onMount = (layer: HTMLDivElement) => {\n    this.layer = layer;\n  };\n\n  componentDidMount() {\n    const { view } = this.props;\n    this.listener.listen(view.model.events, 'changeCells', (e) => {\n      if (e.updateAll) {\n        this.requestRedrawAll(RedrawFlags.None);\n      } else {\n        if (e.changedElement) {\n          this.requestRedraw(e.changedElement, RedrawFlags.None);\n        }\n      }\n    });\n    this.listener.listen(view.events, 'changeLanguage', () => {\n      this.requestRedrawAll(RedrawFlags.RecomputeTemplate);\n    });\n    this.listener.listen(view.events, 'changeHighlight', () => {\n      this.requestRedrawAll(RedrawFlags.RecomputeBlurred);\n    });\n    this.listener.listen(view.model.events, 'elementEvent', ({ data }) => {\n      const invalidatesTemplate = data.changeData || data.changeExpanded || data.changeElementState;\n      if (invalidatesTemplate) {\n        this.requestRedraw(invalidatesTemplate.source, RedrawFlags.RecomputeTemplate);\n      }\n      const invalidatesRender = data.changePosition || data.requestedRedraw;\n      if (invalidatesRender) {\n        this.requestRedraw(invalidatesRender.source, RedrawFlags.Render);\n      }\n    });\n    this.listener.listen(view.events, 'syncUpdate', ({ layer }) => {\n      if (layer === RenderingLayer.Element) {\n        this.delatedRedraw.runSynchronously();\n      } else if (layer === RenderingLayer.ElementSize) {\n        this.delayedUpdateSizes.runSynchronously();\n      }\n    });\n  }\n\n  componentWillReceiveProps(nextProps: Props) {\n    if (this.props.group !== nextProps.group) {\n      this.setState(\n        (state): State => ({\n          elementStates: applyRedrawRequests(nextProps.view, nextProps.group, this.redrawBatch, state.elementStates),\n        })\n      );\n    }\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n    this.delatedRedraw.dispose();\n    this.delayedUpdateSizes.dispose();\n  }\n\n  private requestRedraw = (element: Element, request: RedrawFlags) => {\n    // tslint:disable:no-bitwise\n    const flagsWithForAll = this.redrawBatch.forAll | request;\n    if (flagsWithForAll === this.redrawBatch.forAll) {\n      // forAll flags already include the request\n      return;\n    }\n    const existing = this.redrawBatch.requests.get(element.id);\n    this.redrawBatch.requests.set(element.id, existing | request);\n    this.delatedRedraw.call(this.redrawElements);\n    // tslint:enable:no-bitwise\n  };\n\n  private requestRedrawAll(request: RedrawFlags) {\n    // tslint:disable-next-line:no-bitwise\n    this.redrawBatch.forAll |= request;\n    this.delatedRedraw.call(this.redrawElements);\n  }\n\n  private redrawElements = () => {\n    const props = this.props;\n    this.setState(\n      (state): State => ({\n        elementStates: applyRedrawRequests(props.view, props.group, this.redrawBatch, state.elementStates),\n      })\n    );\n  };\n\n  private requestSizeUpdate = (element: Element, node: HTMLDivElement) => {\n    this.sizeRequests.set(element.id, {element, node});\n    this.delayedUpdateSizes.call(this.recomputeQueuedSizes);\n  };\n\n  private recomputeQueuedSizes = () => {\n    const batch = this.sizeRequests;\n    this.sizeRequests = new Map<string, SizeUpdateRequest>();\n    batch.forEach(({ element, node }) => {\n      const { clientWidth, clientHeight } = node;\n      element.setSize({ width: clientWidth, height: clientHeight });\n    });\n  };\n}\n\nfunction applyRedrawRequests(\n  view: DiagramView,\n  targetGroup: string | undefined,\n  batch: RedrawBatch,\n  previous: ReadonlyMap<string, ElementState>\n): ReadonlyMap<string, ElementState> {\n  const computed = new Map<string, ElementState>();\n  for (const element of view.model.elements) {\n    if (element.group !== targetGroup) {\n      continue;\n    }\n    const elementId = element.id;\n    if (previous.has(elementId)) {\n      let state = previous.get(elementId);\n      // tslint:disable:no-bitwise\n      const request = (batch.requests.get(elementId) || RedrawFlags.None) | batch.forAll;\n      if (request & RedrawFlags.Render) {\n        state = {\n          element,\n          templateProps:\n            (request & RedrawFlags.RecomputeTemplate) === RedrawFlags.RecomputeTemplate\n              ? computeTemplateProps(state.element, view)\n              : state.templateProps,\n          blurred:\n            (request & RedrawFlags.RecomputeBlurred) === RedrawFlags.RecomputeBlurred\n              ? computeIsBlurred(state.element, view)\n              : state.blurred,\n        };\n      }\n      computed.set(elementId, state);\n      batch.requests.delete(elementId);\n      // tslint:enable:no-bitwise\n    } else {\n      computed.set(element.id, {\n        element,\n        templateProps: computeTemplateProps(element, view),\n        blurred: computeIsBlurred(element, view),\n      });\n    }\n  }\n  batch.forAll = RedrawFlags.None;\n  return computed;\n}\n\ninterface OverlayedElementProps {\n  state: ElementState;\n  view: DiagramView;\n  scale: number;\n  onInvalidate: (model: Element, request: RedrawFlags) => void;\n  requestResize: (model: Element, node: HTMLDivElement) => void;\n}\n\nexport interface ElementContextWrapper {\n  ontodiaElement: ElementContext;\n}\nexport const ElementContextTypes: { [K in keyof ElementContextWrapper]: any } = {\n  ontodiaElement: PropTypes.anything,\n};\n\nexport interface ElementContext {\n  element: Element;\n}\n\ninterface OverlayedElementState {\n  height: number;\n  width: number;\n}\n\nclass OverlayedElement extends React.Component<OverlayedElementProps, OverlayedElementState> {\n  static childContextTypes = ElementContextTypes;\n\n  private readonly listener = new EventObserver();\n  private disposed = false;\n\n  private typesObserver: KeyedObserver<ElementTypeIri>;\n  private propertiesObserver: KeyedObserver<PropertyTypeIri>;\n\n  private htmlElement: HTMLDivElement;\n\n  getChildContext(): ElementContextWrapper {\n    const ontodiaElement: ElementContext = {\n      element: this.props.state.element,\n    };\n    return { ontodiaElement };\n  }\n\n  private rerenderTemplate = () => {\n    if (this.disposed) {\n      return;\n    }\n    this.props.onInvalidate(this.props.state.element, RedrawFlags.RecomputeTemplate);\n  };\n\n  render(): React.ReactElement<any> {\n    const {\n      state: { element, blurred },\n    } = this.props;\n    if (element.temporary) {\n      return <div />;\n    }\n\n    const { x = 0, y = 0 } = element.position;\n    const transform = `translate(${x}px,${y}px)`;\n\n    // const angle = model.get('angle') || 0;\n    // if (angle) { transform += `rotate(${angle}deg)`; }\n\n    const className = `ontodia-overlayed-element ${blurred ? 'ontodia-overlayed-element--blurred' : ''}`;\n    return (\n      <div\n        className={className}\n        // set `element-id` to translate mouse events to paper\n        data-element-id={element.id}\n        style={{position: 'absolute', transform}}\n        tabIndex={0}\n        ref={this.onMount}\n        // resize element when child image loaded\n        onDoubleClick={this.onDoubleClick}\n      >\n        <TemplatedElement {...this.props} />\n\n        {\n          // Warning.\n          // className for resizable element should match to the one used in the paperArea.tsx\n        }\n        <span className=\"ontodia-overlayed-element__resizable-handle\"\n          onMouseDown={this.onInitResize}\n          onDoubleClick={this.onResetResize}\n          title=\"double-click on resize handle to reset the card size\"\n        ></span>\n      </div>\n    );\n  }\n\n  // resize handlers\n\n\n  private minSize: {height: number; width: number;};\n  private onInitResize = (e: React.SyntheticEvent) => {\n    // we need to preventDefault here because otherwise we\n    // can get ugly text selection in addition to resize\n    e.preventDefault();\n\n    window.addEventListener('mousemove', this.onResize);\n    window.addEventListener('mouseup', this.onResizeComplete);\n  }\n\n  private onResize = (e: MouseEvent) => {\n    this.props.state.element.setFixedSize(true);\n\n    const elementCard = this.htmlElement.firstElementChild as HTMLElement;\n\n    const rect = elementCard.getBoundingClientRect();\n    const resizeWidth = (e.clientX - rect.left) / this.props.scale;\n    const resizeHeight = (e.clientY - rect.top) / this.props.scale;\n\n    const width = resizeWidth < this.minSize.width ? this.minSize.width : resizeWidth;\n    const height = resizeHeight < this.minSize.height ? this.minSize.height : resizeHeight;\n\n    this.props.state.element.setSize({\n      width: width,\n      height: height\n    });\n\n    elementCard.style.width = width + 'px';\n    elementCard.style.height = height + 'px';\n  }\n\n  private onResizeComplete = () => {\n    window.removeEventListener('mousemove', this.onResize);\n    window.removeEventListener('mouseup', this.onResizeComplete);\n  }\n\n  private onResetResize = (e: React.SyntheticEvent) => {\n    e.preventDefault();\n\n    if (this.props.state.element.isFixedSize) {\n      const elementCard = this.htmlElement.firstElementChild as HTMLElement;\n      elementCard.style.width = this.minSize.width + 'px';\n      elementCard.style.height = this.minSize.height + 'px';\n\n      this.props.state.element.setFixedSize(false);\n      this.requestResize();\n    }\n  }\n\n  private initSize = () => {\n    const elementCard = this.htmlElement.firstElementChild as HTMLElement;\n    this.minSize = {\n      height: parseInt(elementCard.style.height.slice(0, -2)),\n      width: parseInt(elementCard.style.width.slice(0, -2))\n    };\n\n    const { element } = this.props.state;\n    if (element.isFixedSize) {\n      elementCard.style.width = element.size.width + 'px';\n      elementCard.style.height = element.size.height + 'px';\n    }\n  }\n  // end resize handlers\n\n  private onMount = (node: HTMLDivElement | undefined) => {\n    if (!node) {\n      return;\n    }\n    this.htmlElement = node;\n  };\n\n  private onDoubleClick = (e: React.MouseEvent<HTMLDivElement>) => {\n    e.preventDefault();\n    e.stopPropagation();\n    const {\n      view,\n      state: { element },\n    } = this.props;\n    view.model.history.execute(setElementExpanded(element, !element.isExpanded));\n  };\n\n  componentDidMount() {\n    const { state, view } = this.props;\n    this.listener.listen(state.element.events, 'requestedFocus', () => {\n      if (this.htmlElement) {\n        this.htmlElement.focus();\n      }\n    });\n    this.typesObserver = observeElementTypes(view.model, 'changeLabel', this.rerenderTemplate);\n    this.propertiesObserver = observeProperties(view.model, 'changeLabel', this.rerenderTemplate);\n\n    this.observeTypes();\n    this.requestResize();\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n    this.typesObserver.stopListening();\n    this.propertiesObserver.stopListening();\n    this.disposed = true;\n  }\n\n  shouldComponentUpdate(nextProps: OverlayedElementProps) {\n    return this.props.state !== nextProps.state;\n  }\n\n  componentDidUpdate() {\n    this.observeTypes();\n    this.requestResize();\n\n    if (this.minSize === undefined &&\n        !this.props.state.element.temporary) {\n      this.initSize();\n    }\n  }\n\n  private requestResize = () => {\n    const { isFixedSize, temporary } = this.props.state.element;\n    if (!temporary && !isFixedSize) {\n      this.props.requestResize(this.props.state.element, this.htmlElement);\n    }\n  }\n\n  private observeTypes() {\n    const {\n      state: { element },\n    } = this.props;\n    this.typesObserver.observe(element.data.types);\n    this.propertiesObserver.observe(Object.keys(element.data.properties) as PropertyTypeIri[]);\n  }\n}\n\nclass TemplatedElement extends React.Component<OverlayedElementProps, {}> {\n  private cachedTemplateClass: React.ComponentClass<TemplateProps>;\n  private cachedTemplateProps: TemplateProps;\n\n  render() {\n    const { state, view } = this.props;\n    const { element, templateProps } = state;\n    const templateClass = view.getElementTemplate(element.data.types);\n    this.cachedTemplateClass = templateClass;\n    this.cachedTemplateProps = templateProps;\n    return React.createElement(templateClass, templateProps);\n  }\n\n  shouldComponentUpdate(nextProps: OverlayedElementProps) {\n    const templateClass = nextProps.view.getElementTemplate(nextProps.state.element.data.types);\n    return !(this.cachedTemplateClass === templateClass && this.cachedTemplateProps === nextProps.state.templateProps);\n  }\n}\n\nfunction computeTemplateProps(model: Element, view: DiagramView): TemplateProps {\n  const types = model.data.types.length > 0 ? view.getElementTypeString(model.data) : 'Thing';\n  const label = view.formatLabel(model.data.label.values, model.iri);\n  const { color, icon } = computeStyleFor(model, view);\n  const propsAsList = computePropertyTable(model, view);\n\n  return {\n    elementId: model.id,\n    data: model.data,\n    iri: model.iri,\n    types,\n    label,\n    color,\n    iconUrl: icon,\n    imgUrl: model.data.image,\n    isExpanded: model.isExpanded,\n    props: model.data.properties,\n    propsAsList,\n  };\n}\n\nfunction computePropertyTable(\n  model: Element,\n  view: DiagramView\n): Array<{ id: string; name: string; property: Property }> {\n  if (!model.data.properties) {\n    return [];\n  }\n\n  const propertyIris = Object.keys(model.data.properties) as PropertyTypeIri[];\n  const propTable = propertyIris.map((key) => {\n    const property = view.model.createProperty(key);\n    const name = view.formatLabel(property.label, key);\n    return {\n      id: key,\n      name: name,\n      property: model.data.properties[key],\n    };\n  });\n\n  propTable.sort((a, b) => {\n    const aLabel = (a.name || a.id).toLowerCase();\n    const bLabel = (b.name || b.id).toLowerCase();\n    return aLabel.localeCompare(bLabel);\n  });\n  return propTable;\n}\n\nfunction computeStyleFor(model: Element, view: DiagramView) {\n  const {\n    color: { h, c, l },\n    icon,\n  } = view.getTypeStyle(model.data.types);\n  return {\n    icon,\n    color: hcl(h, c, l).toString(),\n  };\n}\n\nfunction computeIsBlurred(element: Element, view: DiagramView): boolean {\n  return view.highlighter && !view.highlighter(element);\n}\n","import { ElementTypeIri, LinkTypeIri, PropertyTypeIri } from '../data/model';\n\nimport { FatClassModelEvents, FatLinkTypeEvents, RichPropertyEvents } from '../diagram/elements';\nimport { DiagramModel } from '../diagram/model';\n\nimport { Unsubscribe, Listener } from './events';\n\nexport class KeyedObserver<Key extends string> {\n  private observedKeys = new Map<string, Unsubscribe>();\n\n  constructor(readonly subscribe: (key: Key) => Unsubscribe | undefined) {}\n\n  observe(keys: ReadonlyArray<Key>) {\n    if (keys.length === 0 && this.observedKeys.size === 0) {\n      return;\n    }\n    const newObservedKeys = new Map<string, Unsubscribe>();\n\n    for (const key of keys) {\n      if (newObservedKeys.has(key)) {\n        continue;\n      }\n      let unsubscribe = this.observedKeys.get(key);\n      if (!unsubscribe) {\n        unsubscribe = this.subscribe(key);\n      }\n      newObservedKeys.set(key, unsubscribe);\n    }\n\n    this.observedKeys.forEach((unsubscribe, key) => {\n      if (!newObservedKeys.has(key)) {\n        unsubscribe();\n      }\n    });\n\n    this.observedKeys = newObservedKeys;\n  }\n\n  stopListening() {\n    this.observe([]);\n  }\n}\n\nexport function observeElementTypes<Event extends keyof FatClassModelEvents>(\n  model: DiagramModel,\n  event: Event,\n  listener: Listener<FatClassModelEvents, Event>\n) {\n  return new KeyedObserver<ElementTypeIri>((key) => {\n    const type = model.getClass(key);\n    if (type) {\n      type.events.on(event, listener);\n      return () => type.events.off(event, listener);\n    }\n    return undefined;\n  });\n}\n\nexport function observeProperties<Event extends keyof RichPropertyEvents>(\n  model: DiagramModel,\n  event: Event,\n  listener: Listener<RichPropertyEvents, Event>\n) {\n  return new KeyedObserver<PropertyTypeIri>((key) => {\n    const property = model.getProperty(key);\n    if (property) {\n      property.events.on(event, listener);\n      return () => property.events.off(event, listener);\n    }\n    return undefined;\n  });\n}\n\nexport function observeLinkTypes<Event extends keyof FatLinkTypeEvents>(\n  model: DiagramModel,\n  event: Event,\n  listener: Listener<FatLinkTypeEvents, Event>\n) {\n  return new KeyedObserver<LinkTypeIri>((key) => {\n    const type = model.createLinkType(key);\n    if (type) {\n      type.events.on(event, listener);\n      return () => type.events.off(event, listener);\n    }\n    return undefined;\n  });\n}\n","import { LinkTemplate, LinkTemplateResolver } from './props';\nimport { PLACEHOLDER_LINK_TYPE } from '../data/schema';\n\nexport const LINK_SHOW_IRI: LinkTemplate = {\n  renderLink: (link) => ({\n    properties: [\n      {\n        position: 0.5,\n        attrs: {\n          text: {\n            text: [\n              {\n                value: link.typeId,\n                language: '',\n              },\n            ],\n            fill: 'gray',\n            'font-size': 12,\n            'font-weight': 'lighter',\n          },\n        },\n      },\n    ],\n  }),\n};\n\nconst LINK_SUB_CLASS_OF: LinkTemplate = {\n  markerTarget: {\n    fill: '#f8a485',\n    stroke: '#cf8e76',\n  },\n  renderLink: () => ({\n    connection: {\n      stroke: '#f8a485',\n      'stroke-width': 2,\n    },\n  }),\n};\n\nconst LINK_DOMAIN: LinkTemplate = {\n  markerTarget: {\n    fill: '#34c7f3',\n    stroke: '#38b5db',\n  },\n  renderLink: () => ({\n    connection: {\n      stroke: '#34c7f3',\n      'stroke-width': 2,\n    },\n  }),\n};\n\nconst LINK_RANGE: LinkTemplate = {\n  markerTarget: {\n    fill: '#34c7f3',\n    stroke: '#38b5db',\n  },\n  renderLink: () => ({\n    connection: {\n      stroke: '#34c7f3',\n      'stroke-width': 2,\n    },\n  }),\n};\n\nconst LINK_TYPE_OF: LinkTemplate = {\n  markerTarget: {\n    fill: '#8cd965',\n    stroke: '#5b9a3b',\n  },\n  renderLink: () => ({\n    connection: {\n      stroke: '#8cd965',\n      'stroke-width': 2,\n    },\n  }),\n};\n\nexport const DefaultLinkTemplateBundle: LinkTemplateResolver = (type) => {\n  if (type === 'http://www.w3.org/2000/01/rdf-schema#subClassOf') {\n    return LINK_SUB_CLASS_OF;\n  } else if (type === 'http://www.w3.org/2000/01/rdf-schema#domain') {\n    return LINK_DOMAIN;\n  } else if (type === 'http://www.w3.org/2000/01/rdf-schema#range') {\n    return LINK_RANGE;\n  } else if (type === 'http://www.w3.org/1999/02/22-rdf-syntax-ns#type') {\n    return LINK_TYPE_OF;\n  } else if (type === PLACEHOLDER_LINK_TYPE) {\n    return { markerTarget: { fill: 'none' } };\n  } else {\n    return undefined;\n  }\n};\n","import * as React from 'react';\nimport { Component, ReactElement, SVGAttributes, CSSProperties } from 'react';\n\nimport { LocalizedString } from '../data/model';\nimport {\n  LinkTemplate,\n  LinkStyle,\n  LinkLabel as LinkLabelProperties,\n  LinkMarkerStyle,\n  RoutedLink,\n  RoutedLinks,\n} from '../customization/props';\nimport { Debouncer } from '../viewUtils/async';\nimport { EventObserver } from '../viewUtils/events';\n\nimport { restoreCapturedLinkGeometry } from './commands';\nimport { Element as DiagramElement, Link as DiagramLink, LinkVertex, linkMarkerKey, FatLinkType } from './elements';\nimport {\n  Vector,\n  computePolyline,\n  computePolylineLength,\n  getPointAlongPolyline,\n  computeGrouping,\n  Rect,\n} from './geometry';\nimport { DiagramView, RenderingLayer } from './view';\n\nexport interface LinkLayerProps {\n  view: DiagramView;\n  links: ReadonlyArray<DiagramLink>;\n  group?: string;\n}\n\nenum UpdateRequest {\n  /** Some part of layer requested an update */\n  Partial = 1,\n  /** Full update requested */\n  All,\n}\n\nconst CLASS_NAME = 'ontodia-link-layer';\n\nexport class LinkLayer extends Component<LinkLayerProps, {}> {\n  private readonly listener = new EventObserver();\n  private readonly delayedUpdate = new Debouncer();\n\n  private updateState = UpdateRequest.Partial;\n  /** List of link IDs to update at the next flush event */\n  private scheduledToUpdate = new Set<string>();\n\n  constructor(props: LinkLayerProps, context: any) {\n    super(props, context);\n  }\n\n  componentDidMount() {\n    const { view } = this.props;\n\n    const scheduleUpdateElementLinks = (element: DiagramElement) => {\n      for (const link of element.links) {\n        this.scheduleUpdateLink(link.id);\n      }\n    };\n    this.listener.listen(view.events, 'changeLanguage', this.scheduleUpdateAll);\n    this.listener.listen(view.events, 'changeHighlight', this.scheduleUpdateAll);\n    const updateChangedRoutes = (changed: RoutedLinks, previous: RoutedLinks) => {\n      changed.forEach((routing, linkId) => {\n        if (previous.get(linkId) !== routing) {\n          this.scheduleUpdateLink(linkId);\n        }\n      });\n    };\n    this.listener.listen(view.events, 'updateRoutings', ({ previous }) => {\n      const newRoutes = view.getRoutings();\n      updateChangedRoutes(newRoutes, previous);\n      updateChangedRoutes(previous, newRoutes);\n    });\n    this.listener.listen(view.model.events, 'changeCells', (e) => {\n      if (e.updateAll) {\n        this.scheduleUpdateAll();\n      } else {\n        if (e.changedElement) {\n          scheduleUpdateElementLinks(e.changedElement);\n        }\n        if (e.changedLinks) {\n          for (const link of e.changedLinks) {\n            this.scheduleUpdateLink(link.id);\n          }\n        }\n      }\n    });\n    this.listener.listen(view.model.events, 'elementEvent', ({ data }) => {\n      const elementEvent = data.changePosition || data.changeSize;\n      if (!elementEvent) {\n        return;\n      }\n      scheduleUpdateElementLinks(elementEvent.source);\n    });\n    this.listener.listen(view.model.events, 'linkEvent', ({ data }) => {\n      const linkEvent = data.changeData || data.changeLayoutOnly || data.changeVertices || data.changeLinkState;\n      if (linkEvent) {\n        this.scheduleUpdateLink(linkEvent.source.id);\n      }\n    });\n    this.listener.listen(view.model.events, 'linkTypeEvent', ({ data }) => {\n      const linkTypeEvent = data.changeLabel || data.changeVisibility;\n      if (!linkTypeEvent) {\n        return;\n      }\n      const linkTypeId = linkTypeEvent.source.id;\n      for (const link of view.model.linksOfType(linkTypeId)) {\n        this.scheduleUpdateLink(link.id);\n      }\n    });\n    this.listener.listen(view.events, 'syncUpdate', ({ layer }) => {\n      if (layer !== RenderingLayer.Link) {\n        return;\n      }\n      this.delayedUpdate.runSynchronously();\n    });\n  }\n\n  shouldComponentUpdate() {\n    return false;\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n    this.delayedUpdate.dispose();\n  }\n\n  private scheduleUpdateAll = () => {\n    if (this.updateState !== UpdateRequest.All) {\n      this.updateState = UpdateRequest.All;\n      this.scheduledToUpdate = new Set<string>();\n    }\n    this.delayedUpdate.call(this.performUpdate);\n  };\n\n  private scheduleUpdateLink(linkId: string) {\n    if (this.updateState === UpdateRequest.Partial) {\n      this.scheduledToUpdate.add(linkId);\n    }\n    this.delayedUpdate.call(this.performUpdate);\n  }\n\n  private popShouldUpdatePredicate(): (model: DiagramLink) => boolean {\n    const { updateState, scheduledToUpdate } = this;\n    this.scheduledToUpdate = new Set<string>();\n    this.updateState = UpdateRequest.Partial;\n    return updateState === UpdateRequest.All ? () => true : (link) => scheduledToUpdate.has(link.id);\n  }\n\n  private performUpdate = () => {\n    this.forceUpdate();\n  };\n\n  private getLinks = () => {\n    const { view, links, group } = this.props;\n\n    if (!group) {\n      return links;\n    }\n\n    const grouping = computeGrouping(view.model.elements);\n    const nestedElements = computeDeepNestedElements(grouping, group);\n\n    return links.filter((link) => {\n      const { sourceId, targetId } = link;\n\n      const source = view.model.getElement(sourceId);\n      const target = view.model.getElement(targetId);\n\n      if (!source || !target) {\n        return false;\n      }\n\n      const sourceGroup = source.group;\n      const targetGroup = target.group;\n\n      return nestedElements[sourceGroup] || nestedElements[targetGroup];\n    });\n  };\n\n  render() {\n    const { view } = this.props;\n    const shouldUpdate = this.popShouldUpdatePredicate();\n\n    return (\n      <g className={CLASS_NAME}>\n        {this.getLinks().map((model) => (\n          <LinkView\n            key={model.id}\n            view={view}\n            model={model}\n            shouldUpdate={shouldUpdate(model)}\n            route={view.getRouting(model.id)}\n          />\n        ))}\n      </g>\n    );\n  }\n}\n\nfunction computeDeepNestedElements(grouping: Map<string, DiagramElement[]>, groupId: string): { [id: string]: true } {\n  const deepChildren: { [elementId: string]: true } = {};\n\n  function collectNestedItems(parentId: string) {\n    deepChildren[parentId] = true;\n    const children = grouping.get(parentId);\n    if (!children) {\n      return;\n    }\n    for (const element of children) {\n      if (element.group !== parentId) {\n        continue;\n      }\n      collectNestedItems(element.id);\n    }\n  }\n\n  collectNestedItems(groupId);\n  return deepChildren;\n}\n\ninterface LinkViewProps {\n  view: DiagramView;\n  model: DiagramLink;\n  shouldUpdate: boolean;\n  route?: RoutedLink;\n}\n\nconst LINK_CLASS = 'ontodia-link';\nconst LABEL_GROUPING_PRECISION = 100;\n// temporary, cleared-before-render map to hold line numbers for labels\n// grouped on the same link offset\nconst TEMPORARY_LABEL_LINES = new Map<number, number>();\n\nclass LinkView extends Component<LinkViewProps, {}> {\n  private linkType: FatLinkType;\n  private template: LinkTemplate;\n\n  constructor(props: LinkViewProps, context: any) {\n    super(props, context);\n    this.grabLinkTemplate(this.props);\n  }\n\n  componentWillReceiveProps(nextProps: LinkViewProps) {\n    if (this.linkType.id !== nextProps.model.typeId) {\n      this.grabLinkTemplate(nextProps);\n    }\n  }\n\n  shouldComponentUpdate(nextProps: LinkViewProps, nextState: {}) {\n    return nextProps.shouldUpdate;\n  }\n\n  private grabLinkTemplate(props: LinkViewProps) {\n    this.linkType = props.view.model.getLinkType(props.model.typeId);\n    this.template = props.view.createLinkTemplate(this.linkType);\n  }\n\n  render() {\n    const { view, model, route } = this.props;\n    const source = view.model.getElement(model.sourceId);\n    const target = view.model.getElement(model.targetId);\n    if (!(source && target)) {\n      return null;\n    }\n\n    const verticesDefinedByUser = model.vertices || [];\n    const vertices = route ? route.vertices : verticesDefinedByUser;\n    const polyline = computePolyline(source, target, vertices);\n\n    const path = 'M' + polyline.map(({ x, y }) => `${x},${y}`).join(' L');\n\n    const { index: typeIndex, showLabel } = this.linkType;\n    const style = this.template.renderLink(model);\n    const pathAttributes = getPathAttributes(model, style);\n\n    const isBlurred = view.highlighter && !view.highlighter(model);\n    const className = `${LINK_CLASS} ${isBlurred ? `${LINK_CLASS}--blurred` : ''}`;\n    return (\n      <g className={className} data-link-id={model.id} data-source-id={source.id} data-target-id={target.id}>\n        <path\n          className={`${LINK_CLASS}__connection`}\n          d={path}\n          {...pathAttributes}\n          markerStart={`url(#${linkMarkerKey(typeIndex, true)})`}\n          markerEnd={`url(#${linkMarkerKey(typeIndex, false)})`}\n        />\n        <path className={`${LINK_CLASS}__wrap`} d={path} />\n        {showLabel ? this.renderLabels(polyline, style) : undefined}\n        {this.renderVertices(verticesDefinedByUser, pathAttributes.stroke)}\n      </g>\n    );\n  }\n\n  private renderVertices(vertices: ReadonlyArray<Vector>, fill: string) {\n    const elements: ReactElement<any>[] = [];\n\n    const vertexClass = `${LINK_CLASS}__vertex`;\n    const vertexRadius = 10;\n\n    let index = 0;\n    for (const { x, y } of vertices) {\n      elements.push(\n        <circle\n          key={index * 2}\n          data-vertex={index}\n          className={vertexClass}\n          cx={x}\n          cy={y}\n          r={vertexRadius}\n          fill={fill}\n        />\n      );\n      elements.push(\n        <VertexTools\n          key={index * 2 + 1}\n          className={`${LINK_CLASS}__vertex-tools`}\n          model={this.props.model}\n          vertexIndex={index}\n          vertexRadius={vertexRadius}\n          x={x}\n          y={y}\n          onRemove={this.onRemoveLinkVertex}\n        />\n      );\n      index++;\n    }\n\n    return <g className={`${LINK_CLASS}__vertices`}>{elements}</g>;\n  }\n\n  private onRemoveLinkVertex = (vertex: LinkVertex) => {\n    const model = this.props.view.model;\n    model.history.registerToUndo(restoreCapturedLinkGeometry(vertex.link));\n    vertex.remove();\n  };\n\n  private onBoundsUpdate = (newBounds: Rect | undefined) => {\n    const { model } = this.props;\n    model.setLabelBounds(newBounds);\n  };\n\n  private renderLabels(polyline: ReadonlyArray<Vector>, style: LinkStyle) {\n    const { view, model, route } = this.props;\n\n    const labels = computeLinkLabels(model, style, view);\n\n    let textAnchor: 'start' | 'middle' | 'end' = 'middle';\n    if (route && route.labelTextAnchor) {\n      textAnchor = route.labelTextAnchor;\n    }\n\n    const polylineLength = computePolylineLength(polyline);\n    TEMPORARY_LABEL_LINES.clear();\n\n    return (\n      <g className={`${LINK_CLASS}__labels`}>\n        {labels.map((label, index) => {\n          const { x, y } = getPointAlongPolyline(polyline, polylineLength * label.offset);\n          const groupKey = Math.round(label.offset * LABEL_GROUPING_PRECISION) / LABEL_GROUPING_PRECISION;\n          const line = TEMPORARY_LABEL_LINES.get(groupKey) || 0;\n          TEMPORARY_LABEL_LINES.set(groupKey, line + 1);\n          return (\n            <LinkLabel\n              key={index}\n              x={x}\n              y={y}\n              line={line}\n              label={label}\n              textAnchor={textAnchor}\n              onBoundsUpdate={index === 0 ? this.onBoundsUpdate : undefined}\n            />\n          );\n        })}\n      </g>\n    );\n  }\n}\n\nfunction computeLinkLabels(model: DiagramLink, style: LinkStyle, view: DiagramView) {\n  const labels: LabelAttributes[] = [];\n\n  const labelStyle = style.label || {};\n  const labelTexts = labelStyle.attrs && labelStyle.attrs.text ? labelStyle.attrs.text.text : undefined;\n\n  let text: LocalizedString | undefined;\n  let title: string | undefined = labelStyle.title;\n  if (labelTexts && labelTexts.length > 0) {\n    text = view.selectLabel(labelTexts);\n  } else {\n    const type = view.model.getLinkType(model.typeId);\n    text = view.selectLabel(type.label) || {\n      value: view.formatLabel(type.label, type.id),\n      language: '',\n    };\n    if (title === undefined) {\n      title = `${text.value} ${view.formatIri(model.typeId)}`;\n    }\n  }\n\n  labels.push({\n    offset: labelStyle.position || 0.5,\n    text,\n    title,\n    attributes: {\n      text: getLabelTextAttributes(labelStyle),\n      rect: getLabelRectAttributes(labelStyle),\n    },\n  });\n\n  if (style.properties) {\n    for (const property of style.properties) {\n      if (!(property.attrs && property.attrs.text && property.attrs.text.text)) {\n        continue;\n      }\n      labels.push({\n        offset: property.position || 0.5,\n        text: view.selectLabel(property.attrs.text.text),\n        title: property.title,\n        attributes: {\n          text: getLabelTextAttributes(property),\n          rect: getLabelRectAttributes(property),\n        },\n      });\n    }\n  }\n\n  return labels;\n}\n\nfunction getPathAttributes(model: DiagramLink, style: LinkStyle): SVGAttributes<SVGPathElement> {\n  const connectionAttributes: LinkStyle['connection'] = style.connection || {};\n  const defaultStrokeDasharray = model.layoutOnly ? '5,5' : undefined;\n  const {\n    fill = 'none',\n    stroke = 'black',\n    'stroke-width': strokeWidth,\n    'stroke-dasharray': strokeDasharray = defaultStrokeDasharray,\n  } = connectionAttributes;\n  return { fill, stroke, strokeWidth, strokeDasharray };\n}\n\nfunction getLabelTextAttributes(label: LinkLabelProperties): CSSProperties {\n  const {\n    fill = 'black',\n    stroke = 'none',\n    'stroke-width': strokeWidth = 0,\n    'font-family': fontFamily = '\"Helvetica Neue\", \"Helvetica\", \"Arial\", sans-serif',\n    'font-size': fontSize = 'inherit',\n    'font-weight': fontWeight = 'bold',\n  } = label.attrs ? label.attrs.text : {};\n  return {\n    fill,\n    stroke,\n    strokeWidth,\n    fontFamily,\n    fontSize,\n    fontWeight: fontWeight as CSSProperties['fontWeight'],\n  };\n}\n\nfunction getLabelRectAttributes(label: LinkLabelProperties): CSSProperties {\n  const { fill = 'white', stroke = 'none', 'stroke-width': strokeWidth = 0 } =\n    label.attrs && label.attrs.rect ? label.attrs.rect : {};\n  return { fill, stroke, strokeWidth };\n}\n\ninterface LabelAttributes {\n  offset: number;\n  text: LocalizedString;\n  title?: string;\n  attributes: {\n    text: CSSProperties;\n    rect: CSSProperties;\n  };\n}\n\ninterface LinkLabelProps {\n  x: number;\n  y: number;\n  line: number;\n  label: LabelAttributes;\n  textAnchor: 'start' | 'middle' | 'end';\n  onBoundsUpdate?: (newBounds: Rect) => void;\n}\n\ninterface LinkLabelState {\n  readonly width?: number;\n  readonly height?: number;\n}\n\nconst GROUPED_LABEL_MARGIN = 2;\n\nclass LinkLabel extends Component<LinkLabelProps, LinkLabelState> {\n  private text: SVGTextElement | undefined;\n  private shouldUpdateBounds = true;\n\n  constructor(props: LinkLabelProps) {\n    super(props);\n    this.state = { width: 0, height: 0 };\n  }\n\n  render() {\n    const { x, y, label, line, textAnchor } = this.props;\n    const { width, height } = this.state;\n    const { x: rectX, y: rectY } = this.getLabelRectangle(width, height);\n\n    const transform = line === 0 ? undefined : `translate(0, ${line * (height + GROUPED_LABEL_MARGIN)}px)`;\n    // HACK: 'alignment-baseline' and 'dominant-baseline' are not supported in Edge and IE\n    const dy = '0.6ex';\n\n    return (\n      <g style={transform ? { transform } : undefined}>\n        {label.title ? <title>{label.title}</title> : undefined}\n        <rect x={rectX} y={rectY} width={width} height={height} style={label.attributes.rect} />\n        <text ref={this.onTextMount} x={x} y={y} dy={dy} textAnchor={textAnchor} style={label.attributes.text}>\n          {label.text.value}\n        </text>\n      </g>\n    );\n  }\n\n  private getLabelRectangle(width: number, height: number): Rect {\n    const { x, y, textAnchor } = this.props;\n\n    let xOffset = 0;\n    if (textAnchor === 'middle') {\n      xOffset = -width / 2;\n    } else if (textAnchor === 'end') {\n      xOffset = -width;\n    }\n\n    return {\n      x: x + xOffset,\n      y: y - height / 2,\n      width,\n      height,\n    };\n  }\n\n  private onTextMount = (text: SVGTextElement | undefined) => {\n    this.text = text;\n  };\n\n  componentDidMount() {\n    this.recomputeBounds(this.props);\n  }\n\n  componentWillUnmount() {\n    const { onBoundsUpdate } = this.props;\n    onBoundsUpdate(undefined);\n  }\n\n  componentWillReceiveProps(nextProps: LinkLabelProps) {\n    this.shouldUpdateBounds = true;\n  }\n\n  componentDidUpdate(props: LinkLabelProps) {\n    this.recomputeBounds(this.props);\n  }\n\n  private recomputeBounds(props: LinkLabelProps) {\n    if (this.shouldUpdateBounds) {\n      const { onBoundsUpdate } = this.props;\n      this.shouldUpdateBounds = false;\n      const bounds = this.text.getBBox();\n\n      if (onBoundsUpdate) {\n        const labelBounds = this.getLabelRectangle(bounds.width, bounds.height);\n        onBoundsUpdate(labelBounds);\n      }\n\n      this.setState({\n        width: bounds.width,\n        height: bounds.height,\n      });\n    }\n  }\n}\n\nclass VertexTools extends Component<\n  {\n    className: string;\n    model: DiagramLink;\n    vertexIndex: number;\n    vertexRadius: number;\n    x: number;\n    y: number;\n    onRemove: (vertex: LinkVertex) => void;\n  },\n  {}\n> {\n  render() {\n    const { className, vertexIndex, vertexRadius, x, y } = this.props;\n    const transform = `translate(${x + 2 * vertexRadius},${y - 2 * vertexRadius})scale(${vertexRadius})`;\n    return (\n      <g className={className} transform={transform} onMouseDown={this.onRemoveVertex}>\n        <title>Remove vertex</title>\n        <circle r={1} />\n        <path d=\"M-0.5,-0.5 L0.5,0.5 M0.5,-0.5 L-0.5,0.5\" strokeWidth={2 / vertexRadius} />\n      </g>\n    );\n  }\n\n  private onRemoveVertex = (e: React.MouseEvent<SVGElement>) => {\n    if (e.button !== 0 /* left button */) {\n      return;\n    }\n    e.preventDefault();\n    e.stopPropagation();\n    const { onRemove, model, vertexIndex } = this.props;\n    onRemove(new LinkVertex(model, vertexIndex));\n  };\n}\n\nexport class LinkMarkers extends Component<{ view: DiagramView }, {}> {\n  private readonly listener = new EventObserver();\n  private readonly delayedUpdate = new Debouncer();\n\n  render() {\n    const { view } = this.props;\n    const markers: Array<ReactElement<LinkMarkerProps>> = [];\n\n    view.getLinkTemplates().forEach((template, linkTypeId) => {\n      const type = view.model.getLinkType(linkTypeId);\n      if (!type) {\n        return;\n      }\n\n      const typeIndex = type.index;\n      if (template.markerSource) {\n        markers.push(\n          <LinkMarker\n            key={typeIndex * 2}\n            linkTypeIndex={typeIndex}\n            style={template.markerSource}\n            isStartMarker={true}\n          />\n        );\n      }\n      if (template.markerTarget) {\n        markers.push(\n          <LinkMarker\n            key={typeIndex * 2 + 1}\n            linkTypeIndex={typeIndex}\n            style={template.markerTarget}\n            isStartMarker={false}\n          />\n        );\n      }\n    });\n\n    return <defs>{markers}</defs>;\n  }\n\n  componentDidMount() {\n    const { view } = this.props;\n    this.listener.listen(view.events, 'syncUpdate', ({ layer }) => {\n      if (layer !== RenderingLayer.Link) {\n        return;\n      }\n      this.delayedUpdate.runSynchronously();\n    });\n    this.listener.listen(view.events, 'changeLinkTemplates', () => {\n      this.delayedUpdate.call(() => this.forceUpdate());\n    });\n  }\n\n  shouldComponentUpdate() {\n    return false;\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n    this.delayedUpdate.dispose();\n  }\n}\n\nconst SVG_NAMESPACE: 'http://www.w3.org/2000/svg' = 'http://www.w3.org/2000/svg';\n\ninterface LinkMarkerProps {\n  linkTypeIndex: number;\n  isStartMarker: boolean;\n  style: LinkMarkerStyle;\n}\n\nclass LinkMarker extends Component<LinkMarkerProps, {}> {\n  render() {\n    return <marker ref={this.onMarkerMount}></marker>;\n  }\n\n  shouldComponentUpdate() {\n    return false;\n  }\n\n  private onMarkerMount = (marker: SVGMarkerElement) => {\n    if (!marker) {\n      return;\n    }\n\n    const { linkTypeIndex, isStartMarker, style } = this.props;\n\n    marker.setAttribute('id', linkMarkerKey(linkTypeIndex, isStartMarker));\n    marker.setAttribute('markerWidth', style.width.toString());\n    marker.setAttribute('markerHeight', style.height.toString());\n    marker.setAttribute('orient', 'auto');\n\n    const xOffset = isStartMarker ? 0 : style.width - 1;\n    marker.setAttribute('refX', xOffset.toString());\n    marker.setAttribute('refY', (style.height / 2).toString());\n    marker.setAttribute('markerUnits', 'userSpaceOnUse');\n\n    const path = document.createElementNS(SVG_NAMESPACE, 'path');\n    path.setAttribute('d', style.d);\n    if (style.fill !== undefined) {\n      path.setAttribute('fill', style.fill);\n    }\n    if (style.stroke !== undefined) {\n      path.setAttribute('stroke', style.stroke);\n    }\n    if (style.strokeWidth !== undefined) {\n      path.setAttribute('stroke-width', style.strokeWidth);\n    }\n\n    marker.appendChild(path);\n  };\n}\n","import { uniqueId, includes } from 'lodash';\n\nimport { DiagramModel } from '../diagram/model';\nimport { Rect, Vector, boundsOf } from '../diagram/geometry';\n\nconst SVG_NAMESPACE: 'http://www.w3.org/2000/svg' = 'http://www.w3.org/2000/svg';\n\nexport interface ToSVGOptions {\n  model: DiagramModel;\n  paper: SVGSVGElement;\n  contentBox: Rect;\n  getOverlayedElement: (id: string) => HTMLElement;\n  preserveDimensions?: boolean;\n  elementsToRemoveSelector?: string;\n}\n\ninterface Bounds {\n  width: number;\n  height: number;\n}\n\n/**\n * Padding (in px) for <foreignObject> elements of exported SVG to\n * mitigate issues with elements body overflow caused by missing styles\n * in exported image.\n */\nconst FOREIGN_OBJECT_SIZE_PADDING = 2;\nconst BORDER_PADDING = 100;\n\nexport async function toSVG(options: ToSVGOptions): Promise<string> {\n  const svg = await exportSVG(options);\n  return new XMLSerializer().serializeToString(svg);\n}\n\nasync function exportSVG(options: ToSVGOptions): Promise<SVGElement> {\n  const { contentBox: bbox } = options;\n  const { svgClone, imageBounds } = clonePaperSvg(options, FOREIGN_OBJECT_SIZE_PADDING);\n\n  const paddedWidth = bbox.width + 2 * BORDER_PADDING;\n  const paddedHeight = bbox.height + 2 * BORDER_PADDING;\n\n  if (options.preserveDimensions) {\n    svgClone.setAttribute('width', paddedWidth.toString());\n    svgClone.setAttribute('height', paddedHeight.toString());\n  } else {\n    svgClone.setAttribute('width', '100%');\n    svgClone.setAttribute('height', '100%');\n  }\n\n  const viewBox: Rect = {\n    x: bbox.x - BORDER_PADDING,\n    y: bbox.y - BORDER_PADDING,\n    width: paddedWidth,\n    height: paddedHeight,\n  };\n  svgClone.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);\n\n  const images: HTMLImageElement[] = [];\n  const nodes = svgClone.querySelectorAll('img');\n  foreachNode(nodes, (node) => images.push(node));\n\n  const convertingImages = Promise.all(\n    images.map(async (img) => {\n      const exportKey = img.getAttribute('export-key');\n      img.removeAttribute('export-key');\n      if (exportKey) {\n        const { width, height } = imageBounds[exportKey];\n        img.setAttribute('width', width.toString());\n        img.setAttribute('height', height.toString());\n        try {\n          const dataUri = await exportImageAsDataUri(img);\n          // check for empty svg data URI which happens when mockJointXHR catches an exception\n          if (dataUri && dataUri !== 'data:image/svg+xml,') {\n            img.src = dataUri;\n          }\n        } catch (err) {\n          // tslint:disable-next-line:no-console\n          console.warn('Failed to export image: ' + img.src, err);\n        }\n      } else {\n        return Promise.resolve();\n      }\n    })\n  );\n\n  await convertingImages;\n  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');\n  const style = document.createElement('style');\n\n  // it is important to use textContent not innerHtml because style\n  // content can't be properly parsed as HTML\n  style.textContent = await extractStylesheets();\n  defs.appendChild(style);\n  svgClone.insertBefore(defs, svgClone.firstChild);\n  if (options.elementsToRemoveSelector) {\n    foreachNode(svgClone.querySelectorAll(options.elementsToRemoveSelector), (node) => node.remove());\n  }\n  return svgClone;\n}\n\nasync function extractStylesheets() {\n  const styleSheets: String[] = [];\n  // we extract all styles from current html document because there is no way to\n  // reliably get only styles that are applicable to diagram elements.\n  //\n  // for more information about used DOM API see\n  // https://developer.mozilla.org/en-US/docs/Web/API/CSSStyleSheet#Notes\n  for (let i = 0; i < document.styleSheets.length; i++) {\n    const styleSheet = document.styleSheets[i];\n    const ownerNode = styleSheet.ownerNode;\n    let styleText;\n\n    // we remember url of the stylesheet because we then need to use it to resolve all\n    // relative URLs inside the stylesheet\n    let styleSheetURL;\n    if (ownerNode instanceof HTMLLinkElement) {\n      // if stylesheet is coming from <link> element then we need to get the content on our own\n      const url = ownerNode.href;\n      const request = new Request(url);\n      // this will give us absolute URL of the stylesheet\n      styleSheetURL = request.url;\n      styleText = await fetch(request).then((response) => {\n        if (!response.ok) {\n          throw new Error(`Ontodia was not able to fetch stylesheet: ${url}`);\n        }\n        return response.text();\n      });\n    } else if (ownerNode instanceof HTMLStyleElement) {\n      // if it is from <style> then we can just grab innerHTML\n      styleText = ownerNode.innerHTML;\n      // in case of <style> we assume that stylesheet URL is current document\n      styleSheetURL = document.baseURI;\n    } else {\n      // We assume that all style-sheets in the document are coming from <style> or <link>,\n      // currently there is no support for css @import rules.\n      throw new Error(\n        'Current HTML document contains css stylesheet with @import rule, that is currently not supported by ontodia. See ontodia sources toSvg.ts#extractStylesheets'\n      );\n    }\n\n    styleSheets.push(await embedExternalResources(styleSheetURL, styleText));\n  }\n\n  return `${styleSheets.join('\\n')}`;\n}\n\n/**\n * Embeds all referenced resources in CSS as data urls.\n *\n * @param baseUrl - stylesheet URL for relative link resolution\n * @param styles - actual stylesheet text\n *\n * @returns stylesheet with url(*) resolved as embedded data-uris\n */\nasync function embedExternalResources(baseUrl: string, styles: string) {\n  const extractUrlRegex = /url\\((.*?)\\)/gm;\n\n  const urls: Array<string> = [];\n  let m;\n  while ((m = extractUrlRegex.exec(styles)) !== null) {\n    if (m.index === extractUrlRegex.lastIndex) {\n      extractUrlRegex.lastIndex++;\n    }\n\n    // 0 is the whole match, 1 is the first matching group (in our case everything inside url())\n    const urlStr: string = m[1];\n    // if URL is data url then we don't need to do anything with it\n    if (includes(urlStr, 'data:')) {\n      // it is data-url so just ignore it;\n    } else {\n      urls.push(urlStr);\n    }\n  }\n\n  // fetch all fonts as data uri\n  const resources = await Promise.all(\n    urls.map((urlStr) => {\n      // the urls that we extracted\n      let resourceUrl = urlStr;\n\n      // URL can be represented in three ways:\n      //    <a_css_property>: url(\"http://mysite.example.com/mycursor.png\")\n      //    <a_css_property>: url('http://mysite.example.com/mycursor.png')\n      //    <a_css_property>: url(http://mysite.example.com/mycursor.png)\n      //\n      // see https://developer.mozilla.org/en-US/docs/Web/CSS/url#Syntax\n      //\n      // so we need to strip quotes to get the actual URL\n      if ((urlStr.startsWith('\"') && urlStr.endsWith('\"')) || (urlStr.startsWith(\"'\") && urlStr.endsWith(\"'\"))) {\n        // strip double or single quotes\n        resourceUrl = urlStr.slice(1, -1);\n      }\n      return exportAsDataUri(new URL(resourceUrl, baseUrl).href);\n    })\n  );\n\n  // replace all urls with data uris\n  return urls.reduce((s, url, i) => s.replace(url, '\"' + resources[i] + '\"'), styles);\n}\n\nfunction clonePaperSvg(\n  options: ToSVGOptions,\n  elementSizePadding: number\n): {\n  svgClone: SVGSVGElement;\n  imageBounds: { [path: string]: Bounds };\n} {\n  const { model, paper, getOverlayedElement } = options;\n  const svgClone = paper.cloneNode(true) as SVGSVGElement;\n  svgClone.removeAttribute('class');\n  svgClone.removeAttribute('style');\n\n  function findViewport() {\n    let child = svgClone.firstChild;\n    while (child) {\n      if (child instanceof SVGGElement) {\n        return child;\n      }\n      child = child.nextSibling;\n    }\n    return undefined;\n  }\n\n  const viewport = findViewport();\n  viewport.removeAttribute('transform');\n\n  // TODO, needed for proper export of the diagram with custom app as of April 2020, remove when we refactor ResearchSpace styling\n  viewport.setAttribute('class', 'rs-application');\n\n  const imageBounds: { [path: string]: Bounds } = {};\n\n  for (const element of model.elements) {\n    const modelId = element.id;\n    const overlayedView = getOverlayedElement(modelId);\n    if (!overlayedView) {\n      continue;\n    }\n\n    const elementRoot = document.createElementNS(SVG_NAMESPACE, 'g');\n    const overlayedViewContent = overlayedView.firstChild.cloneNode(true) as HTMLElement;\n    elementRoot.setAttribute('class', 'ontodia-exported-element');\n\n    let newRoot;\n    newRoot = document.createElementNS(SVG_NAMESPACE, 'foreignObject');\n    newRoot.appendChild(overlayedViewContent);\n    const { x, y, width, height } = boundsOf(element);\n    newRoot.setAttribute('transform', `translate(${x},${y})`);\n    newRoot.setAttribute('width', (width + elementSizePadding).toString());\n    newRoot.setAttribute('height', (height + elementSizePadding).toString());\n\n    elementRoot.appendChild(newRoot);\n    viewport.appendChild(elementRoot);\n\n    const clonedNodes = overlayedViewContent.querySelectorAll('img');\n\n    foreachNode(overlayedView.querySelectorAll('img'), (img, index) => {\n      const exportKey = uniqueId('export-key-');\n      clonedNodes[index].setAttribute('export-key', exportKey);\n      imageBounds[exportKey] = {\n        width: img.clientWidth,\n        height: img.clientHeight,\n      };\n    });\n  }\n\n  return { svgClone, imageBounds };\n}\n\nfunction exportImageAsDataUri(original: HTMLImageElement): Promise<string> {\n  const url = original.src;\n  if (!url || url.startsWith('data:')) {\n    return Promise.resolve(url);\n  }\n\n  return exportAsDataUri(url);\n}\n\nasync function exportAsDataUri(url: string) {\n  const result = await fetch(url);\n  const blob = await result.blob();\n  return new Promise<string>((resolve) => {\n    let reader = new FileReader();\n    reader.onload = () => {\n      resolve(reader.result as string);\n    };\n    reader.readAsDataURL(blob);\n  });\n}\n\nfunction foreachNode<T extends Node>(nodeList: NodeListOf<T>, callback: (node?: T, index?: number) => void) {\n  for (let i = 0; i < nodeList.length; i++) {\n    callback(nodeList[i], i);\n  }\n}\n\nexport interface ToDataURLOptions {\n  /** 'image/png' | 'image/jpeg' | ... */\n  mimeType?: string;\n  width?: number;\n  height?: number;\n  /** Background color, transparent by default. */\n  backgroundColor?: string;\n  quality?: number;\n}\n\nconst MAX_CANVAS_LENGTH = 4096;\n\nexport async function toDataURL(options: ToSVGOptions & ToDataURLOptions): Promise<string> {\n  const { mimeType = 'image/png' } = options;\n  const svgOptions = {\n    ...options,\n    convertImagesToDataUris: true,\n    preserveDimensions: true,\n  };\n  const svg = await exportSVG(svgOptions);\n  const svgBox: Bounds = {\n    width: Number(svg.getAttribute('width')),\n    height: Number(svg.getAttribute('height')),\n  };\n\n  const containerSize =\n    typeof options.width === 'number' || typeof options.height === 'number'\n      ? { width: options.width, height: options.height }\n      : fallbackContainerSize(svgBox);\n\n  const { innerSize, outerSize, offset } = computeAutofit(svgBox, containerSize);\n  svg.setAttribute('width', innerSize.width.toString());\n  svg.setAttribute('height', innerSize.height.toString());\n  const svgString = new XMLSerializer().serializeToString(svg);\n\n  const { canvas, context } = createCanvas(outerSize.width, outerSize.height, options.backgroundColor);\n\n  const image = await loadImage('data:image/svg+xml,' + encodeURIComponent(svgString));\n  context.drawImage(image, offset.x, offset.y, innerSize.width, innerSize.height);\n  return canvas.toDataURL(mimeType, options.quality);\n\n  function createCanvas(canvasWidth: number, canvasHeight: number, backgroundColor?: string) {\n    const cnv = document.createElement('canvas');\n    cnv.width = canvasWidth;\n    cnv.height = canvasHeight;\n    const cnt = cnv.getContext('2d');\n    if (backgroundColor) {\n      cnt.fillStyle = backgroundColor;\n      cnt.fillRect(0, 0, canvasWidth, canvasHeight);\n    }\n    return { canvas: cnv, context: cnt };\n  }\n}\n\nexport function loadImage(source: string): Promise<HTMLImageElement> {\n  return new Promise((resolve, reject) => {\n    const image = new Image();\n    image.onload = function () {\n      resolve(image);\n    };\n    image.onerror = function (ev) {\n      reject(ev);\n    };\n    image.src = source;\n  });\n}\n\nfunction computeAutofit(itemSize: Bounds, containerSize: Bounds) {\n  const fit = fitRectKeepingAspectRatio(itemSize.width, itemSize.height, containerSize.width, containerSize.height);\n  const innerSize: Bounds = {\n    width: Math.floor(fit.width),\n    height: Math.floor(fit.height),\n  };\n  const outerSize: Bounds = {\n    width: typeof containerSize.width === 'number' ? containerSize.width : innerSize.width,\n    height: typeof containerSize.height === 'number' ? containerSize.height : innerSize.height,\n  };\n  const offset: Vector = {\n    x: Math.round((outerSize.width - innerSize.width) / 2),\n    y: Math.round((outerSize.height - innerSize.height) / 2),\n  };\n  return { innerSize, outerSize, offset };\n}\n\nfunction fallbackContainerSize(itemSize: Bounds): Bounds {\n  const maxResolutionScale = Math.min(MAX_CANVAS_LENGTH / itemSize.width, MAX_CANVAS_LENGTH / itemSize.height);\n  const resolutionScale = Math.min(2.0, maxResolutionScale);\n  const width = Math.floor(itemSize.width * resolutionScale);\n  const height = Math.floor(itemSize.height * resolutionScale);\n  return { width, height };\n}\n\nexport function fitRectKeepingAspectRatio(\n  sourceWidth: number,\n  sourceHeight: number,\n  targetWidth: number | undefined,\n  targetHeight: number | undefined\n): { width: number; height: number } {\n  if (!(typeof targetWidth === 'number' || typeof targetHeight === 'number')) {\n    return { width: sourceWidth, height: sourceHeight };\n  }\n  const sourceAspectRatio = sourceWidth / sourceHeight;\n  targetWidth = typeof targetWidth === 'number' ? targetWidth : targetHeight * sourceAspectRatio;\n  targetHeight = typeof targetHeight === 'number' ? targetHeight : targetWidth / sourceAspectRatio;\n  if (targetHeight * sourceAspectRatio <= targetWidth) {\n    return { width: targetHeight * sourceAspectRatio, height: targetHeight };\n  } else {\n    return { width: targetWidth, height: targetWidth / sourceAspectRatio };\n  }\n}\n\n/**\n * Creates and returns a blob from a data URL (either base64 encoded or not).\n *\n * @param {string} dataURL The data URL to convert.\n * @return {Blob} A blob representing the array buffer data.\n */\nexport function dataURLToBlob(dataURL: string): Blob {\n  const BASE64_MARKER = ';base64,';\n  if (dataURL.indexOf(BASE64_MARKER) === -1) {\n    const parts = dataURL.split(',');\n    const contentType = parts[0].split(':')[1];\n    const raw = decodeURIComponent(parts[1]);\n\n    return new Blob([raw], { type: contentType });\n  } else {\n    const parts = dataURL.split(BASE64_MARKER);\n    const contentType = parts[0].split(':')[1];\n    const raw = window.atob(parts[1]);\n    const rawLength = raw.length;\n\n    const uInt8Array = new Uint8Array(rawLength);\n\n    for (let i = 0; i < rawLength; ++i) {\n      uInt8Array[i] = raw.charCodeAt(i);\n    }\n\n    return new Blob([uInt8Array], { type: contentType });\n  }\n}\n","import * as React from 'react';\n\nimport { TemplateProps } from '../customization/props';\n\nimport { ElementModel } from '../data/model';\n\nimport { DiagramView } from '../diagram/view';\nimport { PaperAreaContextTypes, PaperAreaContextWrapper } from '../diagram/paperArea';\n\nimport { Cancellation, CancellationToken } from '../viewUtils/async';\nimport { Listener } from '../viewUtils/events';\n\nimport { WorkspaceContextTypes, WorkspaceContextWrapper } from '../workspace/workspaceContext';\n\nimport { AuthoringState, AuthoringKind } from './authoringState';\nimport { EditorController, EditorEvents } from './editorController';\n\nexport interface AuthoredEntityProps {\n  templateProps: TemplateProps;\n  children: (context: AuthoredEntityContext) => React.ReactElement<any>;\n}\n\nexport interface AuthoredEntityContext {\n  editor: EditorController;\n  editedIri?: string;\n  view: DiagramView;\n  canEdit: boolean | undefined;\n  canDelete: boolean | undefined;\n  onEdit: () => void;\n  onDelete: () => void;\n}\n\nexport interface State {\n  canEdit?: boolean;\n  canDelete?: boolean;\n}\n\n/**\n * Component to simplify tracking changes in validation messages (property and link type labels).\n */\nexport class AuthoredEntity extends React.Component<AuthoredEntityProps, State> {\n  static contextTypes = { ...PaperAreaContextTypes, ...WorkspaceContextTypes };\n  context: PaperAreaContextWrapper & WorkspaceContextWrapper;\n\n  private queryCancellation = new Cancellation();\n\n  constructor(props: AuthoredEntityProps, context: any) {\n    super(props, context);\n    this.state = {};\n  }\n\n  componentDidMount() {\n    const { editor } = this.context.ontodiaWorkspace;\n    editor.events.on('changeAuthoringState', this.onChangeAuthoringState);\n    this.queryAllowedActions();\n  }\n\n  componentDidUpdate(prevProps: AuthoredEntityProps) {\n    const shouldUpdateAllowedActions = this.props.templateProps.data !== prevProps.templateProps.data;\n    if (shouldUpdateAllowedActions) {\n      this.queryAllowedActions();\n    }\n  }\n\n  componentWillUnmount() {\n    const { editor } = this.context.ontodiaWorkspace;\n    editor.events.off('changeAuthoringState', this.onChangeAuthoringState);\n    this.queryCancellation.abort();\n  }\n\n  private onChangeAuthoringState: Listener<EditorEvents, 'changeAuthoringState'> = (e) => {\n    const { source: editor, previous } = e;\n    const iri = this.props.templateProps.data.id;\n    const current = editor.authoringState;\n    if (current.elements.get(iri) !== previous.elements.get(iri)) {\n      this.queryAllowedActions();\n    }\n  };\n\n  private queryAllowedActions() {\n    const { data } = this.props.templateProps;\n    this.queryCancellation.abort();\n    this.queryCancellation = new Cancellation();\n\n    const { editor } = this.context.ontodiaWorkspace;\n\n    if (!editor.metadataApi || AuthoringState.isDeletedElement(editor.authoringState, data.id)) {\n      this.setState({ canEdit: false, canDelete: false });\n    } else {\n      this.queryCanEdit(data);\n      this.queryCanDelete(data);\n    }\n  }\n\n  private queryCanEdit(data: ElementModel) {\n    const { editor } = this.context.ontodiaWorkspace;\n    const signal = this.queryCancellation.signal;\n    this.setState({ canEdit: undefined });\n    CancellationToken.mapCancelledToNull(signal, editor.metadataApi.canEditElement(data, signal)).then((canEdit) => {\n      if (canEdit === null) {\n        return;\n      }\n      this.setState({ canEdit });\n    });\n  }\n\n  private queryCanDelete(data: ElementModel) {\n    const { editor } = this.context.ontodiaWorkspace;\n    const signal = this.queryCancellation.signal;\n    this.setState({ canDelete: undefined });\n    CancellationToken.mapCancelledToNull(signal, editor.metadataApi.canDeleteElement(data, signal)).then(\n      (canDelete) => {\n        if (canDelete === null) {\n          return;\n        }\n        this.setState({ canDelete });\n      }\n    );\n  }\n\n  render() {\n    const { children: renderTemplate } = this.props;\n    const { view } = this.context.ontodiaPaperArea;\n    const { editor } = this.context.ontodiaWorkspace;\n    const { canEdit, canDelete } = this.state;\n\n    const iri = this.props.templateProps.iri;\n    const elementEvent = editor.authoringState.elements.get(iri);\n    const editedIri =\n      elementEvent && elementEvent.type === AuthoringKind.ChangeElement ? elementEvent.newIri : undefined;\n\n    return renderTemplate({\n      editor,\n      view,\n      canEdit,\n      canDelete,\n      editedIri,\n      onEdit: this.onEdit,\n      onDelete: this.onDelete,\n    });\n  }\n\n  private onEdit = () => {\n    const { editor } = this.context.ontodiaWorkspace;\n    const { elementId } = this.props.templateProps;\n    const element = editor.model.getElement(elementId);\n    editor.showEditEntityForm(element);\n  };\n\n  private onDelete = () => {\n    const { editor } = this.context.ontodiaWorkspace;\n    const { data } = this.props.templateProps;\n    editor.deleteEntity(data.id);\n  };\n}\n","/**\n * Dataset-schema specific settings for SPARQL data provider.\n */\nexport interface SparqlDataProviderSettings {\n  /**\n   * Default prefix to be used in every query.\n   */\n  defaultPrefix: string;\n\n  /**\n   * Property path for querying schema labels in schema (classes, link types, properties).\n   */\n  schemaLabelProperty: string;\n\n  /**\n   * Property path for querying instance data labels (elements, links).\n   */\n  dataLabelProperty: string;\n\n  /**\n   * Full-text search settings.\n   */\n  fullTextSearch: FullTextSearchSettings;\n\n  /**\n   * SELECT query to retreive class tree.\n   *\n   * Parametrized variables:\n   *   - `${schemaLabelProperty}` `schemaLabelProperty` property from the settings\n   *\n   * Expected output bindings:\n   *   - `?class`\n   *   - `?label` (optional)\n   *   - `?parent` (optional)\n   *   - `?instcount` (optional)\n   */\n  classTreeQuery?: string;\n\n  /**\n   * SELECT query to retrieve data for each class in a set.\n   *\n   * Parametrized variables:\n   *   - `${ids}` VALUES clause content with class IRIs\n   *   - `${schemaLabelProperty}` `schemaLabelProperty` property from the settings\n   *\n   * Expected output bindings:\n   *   - `?class`\n   *   - `?label` (optional)\n   *   - `?instcount` (optional)\n   */\n  classInfoQuery?: string;\n\n  /**\n   * SELECT query to retrieve initial link types.\n   *\n   * Parametrized variables:\n   *   - `${linkTypesPattern}` `linkTypesPattern` property from the settings\n   *   - `${schemaLabelProperty}` `schemaLabelProperty` property from the settings\n   *\n   * Expected output bindings:\n   *   - `?link`\n   *   - `?label` (optional)\n   *   - `?instcount` (optional)\n   */\n  linkTypesQuery?: string;\n\n  /**\n   * Overridable part of `linkTypesQuery` with same output bindings.\n   *\n   * Parametrized variables: none\n   */\n  linkTypesPattern?: string;\n\n  /**\n   * SELECT query to retrieve data for each link type in a set.\n   *\n   * Parametrized variables:\n   *   - `${ids}` VALUES clause content with link type IRIs\n   *   - `${schemaLabelProperty}` `schemaLabelProperty` property from the settings\n   *\n   * Expected output bindings:\n   *   - `?link`\n   *   - `?label` (optional)\n   *   - `?instcount` (optional)\n   */\n  linkTypesInfoQuery?: string;\n\n  /**\n   * SELECT query to retrieve data for each datatype property in a set.\n   *\n   * Parametrized variables:\n   *   - `${ids}` VALUES clause content with datatype property IRIs\n   *   - `${schemaLabelProperty}` `schemaLabelProperty` property from the settings\n   *\n   * Expected output bindings:\n   *   - `?property`\n   *   - `?label` (optional)\n   */\n  propertyInfoQuery?: string;\n\n  /**\n   * CONSTRUCT query to retrieve data for each element (types, labels, properties).\n   *\n   * Parametrized variables:\n   *   - `${ids}` VALUES clause content with element IRIs\n   *   - `${dataLabelProperty}` `dataLabelProperty` property from the settings\n   *   - `${propertyConfigurations}`\n   *\n   * Expected output format for triples:\n   *   - `?inst <https://ontodia.org/context/v1.json/type> ?class` element has type\n   *   - `?inst <https://ontodia.org/context/v1.json/label> ?label` element has label\n   *   - `?inst ?property ?value` element has value for a datatype property\n   */\n  elementInfoQuery: string;\n\n  /**\n   * SELECT query to retrieve all links between specified elements.\n   *\n   * Parametrized variables:\n   *   - `${ids}` VALUES clause content with element IRIs\n   *   - `${linkConfigurations}`\n   *\n   * Expected output bindings:\n   *   - `?type` link type\n   *   - `?source` link source\n   *   - `?target` link target\n   *   - `?propType` (optional) link property type\n   *   - `?propValue` (optional) link property value\n   */\n  linksInfoQuery: string;\n\n  /**\n   * Query pattern to retrieve image URL for an element.\n   *\n   * Expected bindings:\n   *   - `?inst` element IRI\n   *   - `?linkType` image property IRI\n   *   - `?image` result image URL\n   */\n  imageQueryPattern: string;\n\n  /**\n   * SELECT query to retrieve incoming/outgoing link types from specified element with statistics.\n   *\n   * Parametrized variables:\n   *   - `${elementIri}`\n   *   - `${linkConfigurations}`\n   *\n   * Expected bindings:\n   *   - `?link`\n   *   - `?label` (optional)\n   *   - `?instcount` (optional)\n   */\n  linkTypesOfQuery: string;\n\n  /**\n   * SELECT query to retrieve statistics of incoming/outgoing link types for specified element.\n   *\n   * Parametrized variables:\n   *   - `${linkId}`\n   *   - `${elementIri}`\n   *   - `${linkConfigurationOut}`\n   *   - `${linkConfigurationIn}`\n   *   - `${navigateElementFilterOut}` (optional; for blank node support only)\n   *   - `${navigateElementFilterIn}` (optional; for blank node support only)\n   *\n   * Expected bindings:\n   *   - `?link` link type\n   *   - `?inCount` incoming links count\n   *   - `?outCount` outgoing links count\n   */\n  linkTypesStatisticsQuery: string;\n\n  /**\n   * when fetching all links from element, we could specify additional filter\n   */\n  filterRefElementLinkPattern: string;\n\n  /**\n   * SPARQL query pattern to retrieve transitive type sets for elements.\n   *\n   * Expected output bindings:\n   *   - `?inst` element IRI\n   *   - `?class` element type (there may be multiple or transitive types for an element)\n   */\n  filterTypePattern: string;\n\n  /**\n   * how to fetch elements info when fetching data.\n   */\n  filterElementInfoPattern: string;\n\n  /**\n   * imposes additional filtering on elements within filter\n   */\n  filterAdditionalRestriction: string;\n\n  /**\n   * Abstract links configuration - one could abstract a property path as a link on the diagram.\n   */\n  linkConfigurations: LinkConfiguration[];\n\n  /**\n   * (Experimental) Allows data provider to find links other than specified in `linkConfigurations`\n   * when `linkConfigurations` has at least one value set.\n   *\n   * @default false\n   */\n  openWorldLinks?: boolean;\n\n  /**\n   * Abstract property configuration similar to abstract link configuration. Not type-specific yet.\n   */\n  propertyConfigurations: PropertyConfiguration[];\n\n  /**\n   * (Experimental) Allows data provider to find element properties other than specified in\n   * `propertyConfigurations` when `propertyConfigurations` has at least one value set.\n   *\n   * @default false\n   */\n  openWorldProperties?: boolean;\n}\n\n/**\n * Full text search settings,\n * developer could use anything from search extensions of triplestore to regular expressions match\n * See wikidata and dbpedia examples for reusing full text search capabilities of Blazegraph and Virtuozo\n */\nexport interface FullTextSearchSettings {\n  /**\n   * Prefixes to use in full text search queries.\n   */\n  prefix: string;\n\n  /**\n   * SPARQL query pattern to search/restrict results by text token.\n   *\n   * Parametrized variables:\n   *   - `${text}` text token\n   *   - `${dataLabelProperty}` `dataLabelProperty` property from the settings\n   *\n   * Expected bindings:\n   *   - `?inst` link type\n   *   - `?score` numerical score for ordering search results by relevance\n   *   - `?extractedLabel` (optional; if `extractLabel` is enabled)\n   */\n  queryPattern: string;\n\n  /**\n   * When enabled, adds SPARQL patterns to try to extract label from IRI and\n   * makes it available as `?extractedLabel` binding in `queryPattern`.\n   */\n  extractLabel?: boolean;\n}\n\n/**\n * Link abstraction configuration.\n */\nexport interface LinkConfiguration {\n  /**\n   * IRI of the \"virtual\" link\n   */\n  id: string;\n\n  /**\n   * Optional domain constraint for source element of the link.\n   * If specified checks RDF type of source element to match one from this set.\n   */\n  domain?: ReadonlyArray<string>;\n\n  /**\n   * SPARQL predicate or pattern connecting source element to target element.\n   *\n   * Expected bindings (if it is a pattern):\n   *   - `?source` source element\n   *   - `?target` target element\n   *\n   * @example\n   * Direct configuration: `ex:relatedToOther`\n   *\n   * Pattern configuration: `\n   *   ?source ex:hasAddress ?addr .\n   *   ?addr ex:hasCountry ?target .\n   *   OPTIONAL {\n   *     BIND(ex:addressType as ?propType)\n   *     ?addr ex:addressType ?propValue\n   *   }\n   * `\n   */\n  path: string;\n\n  /**\n   * Additional SPARQL patterns can be used for getting properties of the link.\n   *\n   * Expected bindings\n   *   - `?source` source element\n   *   - `?target` target element\n   *   - `?propType` link property type\n   *   - `?propValue` link property value\n   */\n  properties?: string;\n}\n\n/**\n * Specifies property abstraction configuration\n */\nexport interface PropertyConfiguration {\n  /**\n   * IRI of the \"virtual\" link\n   */\n  id: string;\n\n  /**\n   * Optional domain constraint for source element of the property.\n   * If specified checks RDF type of source element to match one from this set.\n   */\n  domain?: ReadonlyArray<string>;\n\n  /**\n   * SPARQL predicate or pattern connecting source element to property value.\n   *\n   * Expected bindings (if it is a pattern):\n   *   - `?inst` source element\n   *   - `?value` property value\n   *\n   * @example\n   * Direct configuration: `ex:firstName`\n   *\n   * Pattern configuration: `\n   *   ?inst ex:hasAddress ?addr .\n   *   ?addr ex:hasApartmentNumber ?value\n   * `\n   */\n  path: string;\n}\n\nexport const RDFSettings: SparqlDataProviderSettings = {\n  linkConfigurations: [],\n  openWorldLinks: false,\n\n  propertyConfigurations: [],\n  openWorldProperties: false,\n\n  linksInfoQuery: `SELECT ?source ?type ?target\n            WHERE {\n                \\${linkConfigurations}\n                VALUES (?source) {\\${ids}}\n                VALUES (?target) {\\${ids}}\n            }`,\n\n  defaultPrefix: '',\n\n  schemaLabelProperty: 'rdfs:label',\n  dataLabelProperty: 'rdfs:label',\n\n  fullTextSearch: {\n    prefix: '',\n    queryPattern: ``,\n  },\n\n  classTreeQuery: ``,\n\n  classInfoQuery: `SELECT ?class ?label ?instcount WHERE {\n    VALUES(?class) {\\${ids}}\n    OPTIONAL { ?class \\${schemaLabelProperty} ?label }\n    BIND(\"\" as ?instcount)\n}`,\n\n  linkTypesQuery: `SELECT DISTINCT ?link ?instcount ?label WHERE {\n    \\${linkTypesPattern}\n    OPTIONAL { ?link \\${schemaLabelProperty} ?label }\n}`,\n\n  linkTypesPattern: ``,\n\n  linkTypesInfoQuery: `SELECT ?link ?label WHERE {\n    VALUES(?link) {\\${ids}}\n    OPTIONAL { ?link \\${schemaLabelProperty} ?label }\n}`,\n\n  propertyInfoQuery: `SELECT ?property ?label WHERE {\n    VALUES(?property) {\\${ids}}\n    OPTIONAL { ?property \\${schemaLabelProperty} ?label }\n}`,\n\n  elementInfoQuery: ``,\n  imageQueryPattern: ``,\n\n  linkTypesOfQuery: ``,\n  linkTypesStatisticsQuery: ``,\n  filterRefElementLinkPattern: '',\n  filterTypePattern: ``,\n  filterAdditionalRestriction: ``,\n  filterElementInfoPattern: ``,\n};\n\nconst WikidataSettingsOverride: Partial<SparqlDataProviderSettings> = {\n  defaultPrefix: `PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\n PREFIX rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\n PREFIX wdt: <http://www.wikidata.org/prop/direct/>\n PREFIX wd: <http://www.wikidata.org/entity/>\n PREFIX owl:  <http://www.w3.org/2002/07/owl#>\n\n`,\n\n  schemaLabelProperty: 'rdfs:label',\n  dataLabelProperty: 'rdfs:label',\n\n  fullTextSearch: {\n    prefix: 'PREFIX bds: <http://www.bigdata.com/rdf/search#>' + '\\n',\n    queryPattern: `\n              ?inst rdfs:label ?searchLabel.\n              SERVICE bds:search {\n                     ?searchLabel bds:search \"\\${text}*\" ;\n                                  bds:minRelevance '0.5' ;\n                                  bds:matchAllTerms 'true' .\n              }\n              BIND(IF(STRLEN(?strInst) > 33,\n                            0-<http://www.w3.org/2001/XMLSchema#integer>(SUBSTR(?strInst, 33)),\n                            -10000) as ?score)\n            `,\n  },\n\n  classTreeQuery: `\n            SELECT distinct ?class ?label ?parent WHERE {\n              ?class rdfs:label ?label.\n              { ?class wdt:P279 wd:Q35120. }\n                UNION\n              { ?parent wdt:P279 wd:Q35120.\n                ?class wdt:P279 ?parent. }\n                UNION\n              { ?parent wdt:P279/wdt:P279 wd:Q35120.\n                ?class wdt:P279 ?parent. }\n            }\n        `,\n\n  // todo: think more, maybe add a limit here?\n  linkTypesPattern: `?link wdt:P279* wd:Q18616576.\n    BIND(0 as ?instcount)\n`,\n\n  elementInfoQuery: `\n        CONSTRUCT {\n            ?inst <https://ontodia.org/context/v1.json/type> ?class .\n            ?inst <https://ontodia.org/context/v1.json/label> ?label .\n            ?inst ?propType ?propValue.\n        } WHERE {\n            VALUES (?inst) {\\${ids}}\n            OPTIONAL {\n                ?inst wdt:P31 ?class\n            }\n            OPTIONAL {?inst rdfs:label ?label}\n            OPTIONAL {\n                \\${propertyConfigurations}\n                FILTER (isLiteral(?propValue))\n            }\n        }\n    `,\n  imageQueryPattern: ` { ?inst ?linkType ?fullImage } union { ?inst wdt:P163/wdt:P18 ?fullImage }\n                BIND(CONCAT(\"https://commons.wikimedia.org/w/thumb.php?f=\",\n                    STRAFTER(STR(?fullImage), \"Special:FilePath/\"), \"&w=200\") AS ?image)`,\n  linkTypesOfQuery: `\n        SELECT DISTINCT ?link\n        WHERE {\n            \\${linkConfigurations}\n            ?claim <http://wikiba.se/ontology#directClaim> ?link .\n        }\n    `,\n  linkTypesStatisticsQuery: `\n        SELECT (\\${linkId} as ?link) (COUNT(?outObject) AS ?outCount) (COUNT(?inObject) AS ?inCount)\n        WHERE {\n            {\n                {\n                    SELECT DISTINCT ?outObject WHERE {\n                        \\${linkConfigurationOut}\n                        FILTER(ISIRI(?outObject))\n                        ?outObject ?someprop ?someobj.\n                    }\n                    LIMIT 101\n                }\n            } UNION {\n                {\n                    SELECT DISTINCT ?inObject WHERE {\n                        \\${linkConfigurationIn}\n                        FILTER(ISIRI(?inObject))\n                        ?inObject ?someprop ?someobj.\n                    }\n                    LIMIT 101\n                }\n            }\n        }\n    `,\n  filterRefElementLinkPattern: '?claim <http://wikiba.se/ontology#directClaim> ?link .',\n  filterTypePattern: `?inst wdt:P31 ?instType. ?instType wdt:P279* ?class`,\n  filterAdditionalRestriction: `FILTER ISIRI(?inst)\n                        BIND(STR(?inst) as ?strInst)\n                        FILTER exists {?inst ?someprop ?someobj}\n`,\n  filterElementInfoPattern: `OPTIONAL {?inst wdt:P31 ?foundClass}\n                BIND (coalesce(?foundClass, owl:Thing) as ?class)\n                OPTIONAL {?inst rdfs:label ?label}\n`,\n};\n\nexport const WikidataSettings: SparqlDataProviderSettings = { ...RDFSettings, ...WikidataSettingsOverride };\n\nexport const OWLRDFSSettingsOverride: Partial<SparqlDataProviderSettings> = {\n  defaultPrefix: `PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\n PREFIX rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\n PREFIX owl:  <http://www.w3.org/2002/07/owl#>\n`,\n  schemaLabelProperty: 'rdfs:label',\n  dataLabelProperty: 'rdfs:label',\n  fullTextSearch: {\n    prefix: '',\n    queryPattern: ` OPTIONAL {?inst \\${dataLabelProperty} ?search1}\n        FILTER regex(COALESCE(str(?search1), str(?extractedLabel)), \"\\${text}\", \"i\")\n        BIND(0 as ?score)\n`,\n    extractLabel: true,\n  },\n  classTreeQuery: `\n            SELECT ?class ?label ?parent\n            WHERE {\n                {\n                    ?class a rdfs:Class\n                } UNION {\n                    ?class a owl:Class\n                }\n                FILTER ISIRI(?class)\n                OPTIONAL {?class rdfs:label ?label}\n                OPTIONAL {?class rdfs:subClassOf ?parent. FILTER ISIRI(?parent)}\n            }\n        `,\n\n  // todo: think more, maybe add a limit here?\n  linkTypesPattern: `{\t?link a rdf:Property\n                    } UNION {\n                    ?link a owl:ObjectProperty\n                }\n                BIND('' as ?instcount)\n    `,\n  elementInfoQuery: `\n        CONSTRUCT {\n            ?inst <https://ontodia.org/context/v1.json/type> ?class .\n            ?inst <https://ontodia.org/context/v1.json/label> ?label .\n            ?inst ?propType ?propValue.\n        } WHERE {\n            VALUES (?inst) {\\${ids}}\n            OPTIONAL { ?inst a ?class }\n            OPTIONAL {?inst \\${dataLabelProperty} ?label}\n            OPTIONAL {\n                \\${propertyConfigurations}\n                FILTER (isLiteral(?propValue))\n            }\n        }\n    `,\n  imageQueryPattern: `{ ?inst ?linkType ?image } UNION { [] ?linkType ?inst. BIND(?inst as ?image) }`,\n  linkTypesOfQuery: `\n        SELECT DISTINCT ?link\n        WHERE {\n            \\${linkConfigurations}\n        }\n    `,\n  linkTypesStatisticsQuery: `\n        SELECT ?link ?outCount ?inCount\n        WHERE {\n            {\n                SELECT (\\${linkId} as ?link) (count(?outObject) as ?outCount) WHERE {\n                    \\${linkConfigurationOut}\n                    \\${navigateElementFilterOut}\n                } LIMIT 101\n            } {\n                SELECT (\\${linkId} as ?link) (count(?inObject) as ?inCount) WHERE {\n                    \\${linkConfigurationIn}\n                    \\${navigateElementFilterIn}\n                } LIMIT 101\n            }\n        }\n    `,\n  filterRefElementLinkPattern: '',\n  filterTypePattern: `?inst a ?instType. ?instType rdfs:subClassOf* ?class`,\n  filterElementInfoPattern: `OPTIONAL {?inst rdf:type ?foundClass}\n                BIND (coalesce(?foundClass, owl:Thing) as ?class)\n                OPTIONAL {?inst \\${dataLabelProperty} ?label}`,\n  filterAdditionalRestriction: '',\n};\n\nexport const OWLRDFSSettings: SparqlDataProviderSettings = { ...RDFSettings, ...OWLRDFSSettingsOverride };\n\nconst OWLStatsOverride: Partial<SparqlDataProviderSettings> = {\n  classTreeQuery: `\n        SELECT ?class ?instcount ?label ?parent\n        WHERE {\n            {SELECT ?class (count(?inst) as ?instcount)\n                WHERE {\n                    ?inst rdf:type ?class.\n                    FILTER ISIRI(?class)\n                } GROUP BY ?class } UNION\n            {\n                ?class rdf:type rdfs:Class\n            } UNION {\n                ?class rdf:type owl:Class\n            }\n            OPTIONAL {?class rdfs:label ?label}\n            OPTIONAL {?class rdfs:subClassOf ?parent. FILTER ISIRI(?parent)}\n        }\n    `,\n};\nexport const OWLStatsSettings: SparqlDataProviderSettings = { ...OWLRDFSSettings, ...OWLStatsOverride };\n\nconst DBPediaOverride: Partial<SparqlDataProviderSettings> = {\n  fullTextSearch: {\n    prefix: 'PREFIX dbo: <http://dbpedia.org/ontology/>\\n',\n    queryPattern: `\n              ?inst rdfs:label ?searchLabel.\n              ?searchLabel bif:contains \"\\${text}\".\n              ?inst dbo:wikiPageID ?origScore .\n              BIND(0-?origScore as ?score)\n        `,\n  },\n\n  classTreeQuery: `\n        SELECT distinct ?class ?label ?parent WHERE {\n            ?class rdfs:label ?label.\n            OPTIONAL {?class rdfs:subClassOf ?parent}\n            ?root rdfs:subClassOf owl:Thing.\n            ?class rdfs:subClassOf? | rdfs:subClassOf/rdfs:subClassOf ?root\n        }\n    `,\n\n  elementInfoQuery: `\n        CONSTRUCT {\n            ?inst <https://ontodia.org/context/v1.json/type> ?class .\n            ?inst <https://ontodia.org/context/v1.json/label> ?label .\n            ?inst ?propType ?propValue.\n        } WHERE {\n            VALUES (?inst) {\\${ids}}\n            ?inst a ?class .\n            ?inst rdfs:label ?label .\n            FILTER (!contains(str(?class), 'http://dbpedia.org/class/yago'))\n            OPTIONAL {\n                \\${propertyConfigurations}\n                FILTER (isLiteral(?propValue))\n            }\n        }\n    `,\n\n  filterTypePattern: `?inst a ?instType. ?instType rdfs:subClassOf* ?class`,\n  filterElementInfoPattern: `\n        OPTIONAL {?inst rdf:type ?foundClass. FILTER (!contains(str(?foundClass), 'http://dbpedia.org/class/yago'))}\n        BIND (coalesce(?foundClass, owl:Thing) as ?class)\n        OPTIONAL {?inst \\${dataLabelProperty} ?label}`,\n\n  imageQueryPattern: ` { ?inst ?linkType ?fullImage } UNION { [] ?linkType ?inst. BIND(?inst as ?fullImage) }\n            BIND(CONCAT(\"https://commons.wikimedia.org/w/thumb.php?f=\",\n            STRAFTER(STR(?fullImage), \"Special:FilePath/\"), \"&w=200\") AS ?image)\n    `,\n};\nexport const DBPediaSettings: SparqlDataProviderSettings = { ...OWLRDFSSettings, ...DBPediaOverride };\n","import * as N3 from 'n3';\n\nimport { RdfNode, Triple } from './sparqlModels';\n\nexport function parseTurtleText(turtleText: string): Promise<Triple[]> {\n  return new Promise<Triple[]>((resolve, reject) => {\n    const triples: Triple[] = [];\n    N3.Parser().parse(turtleText, (error, triple, hash) => {\n      if (error) {\n        reject(error);\n      } else if (triple) {\n        triples.push({\n          subject: n3toRdfNode(triple.subject),\n          predicate: n3toRdfNode(triple.predicate),\n          object: n3toRdfNode(triple.object),\n        });\n      } else {\n        resolve(triples);\n      }\n    });\n  });\n}\n\nexport function n3toRdfNode(entity: string): RdfNode {\n  if (N3.Util.isLiteral(entity)) {\n    return {\n      type: 'literal',\n      value: N3.Util.getLiteralValue(entity),\n      datatype: N3.Util.getLiteralType(entity),\n      'xml:lang': N3.Util.getLiteralLanguage(entity),\n    };\n  } else {\n    return { type: 'uri', value: entity };\n  }\n}\n","import { keyBy } from 'lodash';\n\nimport { GenerateID } from '../../data/schema';\nimport { LayoutElement, LayoutLink, SerializedDiagram, makeSerializedDiagram } from '../../editor/serializedDiagram';\nimport { uniformGrid } from '../../viewUtils/layout';\n\nimport { Dictionary, ElementModel, LinkModel, ElementIri, LinkTypeIri } from '../model';\nimport { DataProvider } from '../provider';\nimport { Triple } from './sparqlModels';\nimport { parseTurtleText } from './turtle';\n\nconst GREED_STEP = 150;\n\nexport class GraphBuilder {\n  constructor(public dataProvider: DataProvider) {}\n\n  createGraph(graph: {\n    elementIds: ElementIri[];\n    links: LinkModel[];\n  }): Promise<{\n    preloadedElements: Dictionary<ElementModel>;\n    diagram: SerializedDiagram;\n  }> {\n    return this.dataProvider.elementInfo({ elementIds: graph.elementIds }).then((elementsInfo) => ({\n      preloadedElements: elementsInfo,\n      diagram: makeLayout(graph.elementIds, graph.links),\n    }));\n  }\n\n  getGraphFromRDFGraph(\n    graph: Triple[]\n  ): Promise<{\n    preloadedElements: Dictionary<ElementModel>;\n    diagram: SerializedDiagram;\n  }> {\n    const { elementIds, links } = makeGraphItems(graph);\n    return this.createGraph({ elementIds, links });\n  }\n\n  getGraphFromTurtleGraph(\n    graph: string\n  ): Promise<{\n    preloadedElements: Dictionary<ElementModel>;\n    diagram: SerializedDiagram;\n  }> {\n    return parseTurtleText(graph).then((triples) => this.getGraphFromRDFGraph(triples));\n  }\n}\n\nexport function makeGraphItems(\n  response: ReadonlyArray<Triple>\n): {\n  elementIds: ElementIri[];\n  links: LinkModel[];\n} {\n  const elements: Dictionary<boolean> = {};\n  const links: LinkModel[] = [];\n\n  for (const { subject, predicate, object } of response) {\n    if (subject.type === 'uri' && !elements[subject.value]) {\n      elements[subject.value] = true;\n    }\n\n    if (object.type === 'uri' && !elements[object.value]) {\n      elements[object.value] = true;\n    }\n\n    if (subject.type === 'uri' && object.type === 'uri') {\n      links.push({\n        linkTypeId: predicate.value as LinkTypeIri,\n        sourceId: subject.value as ElementIri,\n        targetId: object.value as ElementIri,\n      });\n    }\n  }\n  return { elementIds: Object.keys(elements) as ElementIri[], links };\n}\n\nexport function makeLayout(\n  elementsIds: ReadonlyArray<ElementIri>,\n  linksInfo: ReadonlyArray<LinkModel>\n): SerializedDiagram {\n  const rows = Math.ceil(Math.sqrt(elementsIds.length));\n  const grid = uniformGrid({ rows, cellSize: { x: GREED_STEP, y: GREED_STEP } });\n\n  const elements: LayoutElement[] = elementsIds.map<LayoutElement>((id, index) => {\n    const { x, y } = grid(index);\n    return { '@type': 'Element', '@id': GenerateID.forElement(), iri: id, position: { x, y } };\n  });\n\n  const layoutElementsMap: { [iri: string]: LayoutElement } = keyBy(elements, 'iri');\n  const links: LayoutLink[] = [];\n\n  linksInfo.forEach((link, index) => {\n    const source = layoutElementsMap[link.sourceId];\n    const target = layoutElementsMap[link.targetId];\n\n    if (!source || !target) {\n      return;\n    }\n\n    links.push({\n      '@type': 'Link',\n      '@id': GenerateID.forLink(),\n      property: link.linkTypeId,\n      source: { '@id': source['@id'] },\n      target: { '@id': target['@id'] },\n    });\n  });\n  return makeSerializedDiagram({ layoutData: { '@type': 'Layout', elements, links }, linkTypeOptions: [] });\n}\n","import { ElementModel, ElementIri, ElementTypeIri, LinkTypeIri, PropertyTypeIri } from '../data/model';\nimport { GenerateID } from '../data/schema';\n\nimport { EventSource, Events, EventObserver, AnyEvent } from '../viewUtils/events';\n\nimport {\n  Element,\n  ElementEvents,\n  Link,\n  LinkEvents,\n  FatLinkType,\n  FatLinkTypeEvents,\n  FatClassModel,\n  FatClassModelEvents,\n  RichProperty,\n} from './elements';\nimport { Graph, CellsChangedEvent } from './graph';\nimport { CommandHistory, Command } from './history';\n\nexport interface DiagramModelEvents {\n  changeCells: CellsChangedEvent;\n  elementEvent: AnyEvent<ElementEvents>;\n  linkEvent: AnyEvent<LinkEvents>;\n  linkTypeEvent: AnyEvent<FatLinkTypeEvents>;\n  classEvent: AnyEvent<FatClassModelEvents>;\n  changeGroupContent: { group: string };\n}\n\n/**\n * Model of diagram.\n */\nexport class DiagramModel {\n  protected readonly source = new EventSource<DiagramModelEvents>();\n  readonly events: Events<DiagramModelEvents> = this.source;\n\n  protected graph = new Graph();\n  protected graphListener = new EventObserver();\n\n  constructor(readonly history: CommandHistory) {}\n\n  get elements() {\n    return this.graph.getElements();\n  }\n  get links() {\n    return this.graph.getLinks();\n  }\n\n  getElement(elementId: string): Element | undefined {\n    return this.graph.getElement(elementId);\n  }\n\n  getLinkById(linkId: string): Link | undefined {\n    return this.graph.getLink(linkId);\n  }\n\n  linksOfType(linkTypeId: LinkTypeIri): ReadonlyArray<Link> {\n    return this.graph.getLinks().filter((link) => link.typeId === linkTypeId);\n  }\n\n  findLink(linkTypeId: LinkTypeIri, sourceId: string, targetId: string): Link | undefined {\n    return this.graph.findLink(linkTypeId, sourceId, targetId);\n  }\n\n  sourceOf(link: Link) {\n    return this.getElement(link.sourceId);\n  }\n  targetOf(link: Link) {\n    return this.getElement(link.targetId);\n  }\n  isSourceAndTargetVisible(link: Link): boolean {\n    return Boolean(this.sourceOf(link) && this.targetOf(link));\n  }\n\n  resetGraph() {\n    if (this.graphListener) {\n      this.graphListener.stopListening();\n      this.graphListener = new EventObserver();\n    }\n    this.graph = new Graph();\n  }\n\n  subscribeGraph() {\n    this.graphListener.listen(this.graph.events, 'changeCells', (e) => {\n      this.source.trigger('changeCells', e);\n    });\n    this.graphListener.listen(this.graph.events, 'elementEvent', (e) => {\n      this.source.trigger('elementEvent', e);\n    });\n    this.graphListener.listen(this.graph.events, 'linkEvent', (e) => {\n      this.source.trigger('linkEvent', e);\n    });\n    this.graphListener.listen(this.graph.events, 'linkTypeEvent', (e) => {\n      this.source.trigger('linkTypeEvent', e);\n    });\n    this.graphListener.listen(this.graph.events, 'classEvent', (e) => {\n      this.source.trigger('classEvent', e);\n    });\n\n    this.source.trigger('changeCells', { updateAll: true });\n  }\n\n  reorderElements(compare: (a: Element, b: Element) => number) {\n    this.graph.reorderElements(compare);\n  }\n\n  createElement(elementIriOrModel: ElementIri | ElementModel, group?: string): Element {\n    const elementIri =\n      typeof elementIriOrModel === 'string' ? elementIriOrModel : (elementIriOrModel as ElementModel).id;\n\n    const elements = this.elements.filter((el) => el.iri === elementIri && el.group === group);\n    if (elements.length > 0) {\n      // usually there should be only one element\n      return elements[0];\n    }\n\n    let data =\n      typeof elementIriOrModel === 'string' ? placeholderDataFromIri(elementIri) : (elementIriOrModel as ElementModel);\n    data = { ...data, id: data.id };\n    const element = new Element({ id: GenerateID.forElement(), data, group });\n    this.addElement(element);\n    return element;\n  }\n\n  addElement(element: Element): void {\n    this.history.execute(addElement(this.graph, element, []));\n  }\n\n  removeElement(elementId: string) {\n    const element = this.getElement(elementId);\n    if (element) {\n      this.history.execute(removeElement(this.graph, element));\n    }\n  }\n\n  addLink(link: Link): Link {\n    const { typeId, sourceId, targetId, data } = link;\n    if (data && data.linkTypeId !== typeId) {\n      throw new Error('linkTypeId must match linkType.id');\n    }\n\n    const existingLink = this.findLink(typeId, sourceId, targetId);\n    if (existingLink) {\n      if (link.data) {\n        existingLink.setLayoutOnly(false);\n        existingLink.setData(data);\n      }\n      return existingLink;\n    }\n\n    const linkType = this.createLinkType(link.typeId);\n    const source = this.getElement(sourceId);\n    const target = this.getElement(targetId);\n    const shouldBeVisible = linkType.visible && source && target;\n    if (!shouldBeVisible) {\n      return undefined;\n    }\n\n    if (!link.data) {\n      link.setData({ linkTypeId: typeId, sourceId: source.iri, targetId: target.iri });\n    }\n    this.graph.addLink(link);\n    return link;\n  }\n\n  removeLink(linkId: string) {\n    this.graph.removeLink(linkId);\n  }\n\n  getClass(classIri: ElementTypeIri): FatClassModel {\n    return this.graph.getClass(classIri);\n  }\n\n  createClass(classIri: ElementTypeIri): FatClassModel {\n    const existing = this.graph.getClass(classIri);\n    if (existing) {\n      return existing;\n    }\n    const classModel = new FatClassModel({ id: classIri });\n    this.addClass(classModel);\n    return classModel;\n  }\n\n  addClass(model: FatClassModel) {\n    this.graph.addClass(model);\n  }\n\n  getLinkType(linkTypeIri: LinkTypeIri): FatLinkType | undefined {\n    return this.graph.getLinkType(linkTypeIri);\n  }\n\n  createLinkType(linkTypeIri: LinkTypeIri): FatLinkType {\n    const existing = this.graph.getLinkType(linkTypeIri);\n    if (existing) {\n      return existing;\n    }\n    const linkType = new FatLinkType({ id: linkTypeIri });\n    this.graph.addLinkType(linkType);\n    return linkType;\n  }\n\n  getProperty(propertyTypeIri: PropertyTypeIri): RichProperty {\n    return this.graph.getProperty(propertyTypeIri);\n  }\n\n  createProperty(propertyIri: PropertyTypeIri): RichProperty {\n    const existing = this.graph.getProperty(propertyIri);\n    if (existing) {\n      return existing;\n    }\n    const property = new RichProperty({ id: propertyIri });\n    this.graph.addProperty(property);\n    return property;\n  }\n\n  triggerChangeGroupContent(group: string) {\n    this.source.trigger('changeGroupContent', { group });\n  }\n\n  createTemporaryElement(): Element {\n    const target = new Element({\n      id: GenerateID.forElement(),\n      data: placeholderDataFromIri('' as ElementIri),\n      temporary: true,\n    });\n\n    this.graph.addElement(target);\n\n    return target;\n  }\n}\n\nexport function placeholderDataFromIri(iri: ElementIri): ElementModel {\n  return {\n    id: iri,\n    types: [],\n    label: { values: [] },\n    properties: {},\n  };\n}\n\nfunction addElement(graph: Graph, element: Element, connectedLinks: ReadonlyArray<Link>): Command {\n  return Command.create('Add element', () => {\n    graph.addElement(element);\n    for (const link of connectedLinks) {\n      const existing = graph.getLink(link.id) || graph.findLink(link.typeId, link.sourceId, link.targetId);\n      if (!existing) {\n        graph.addLink(link);\n      }\n    }\n    return removeElement(graph, element);\n  });\n}\n\nfunction removeElement(graph: Graph, element: Element): Command {\n  return Command.create('Remove element', () => {\n    const connectedLinks = [...element.links];\n    graph.removeElement(element.id);\n    return addElement(graph, element, connectedLinks);\n  });\n}\n","import * as React from 'react';\n\nimport { MetadataApi } from '../data/metadataApi';\nimport { ValidationApi } from '../data/validationApi';\nimport { ElementModel, LinkModel, ElementIri, sameLink, sameElement } from '../data/model';\n\nimport { setElementExpanded, setElementData, setLinkData, changeLinkTypeVisibility } from '../diagram/commands';\nimport { Element, Link, LinkVertex, FatLinkType } from '../diagram/elements';\nimport { Vector, boundsOf } from '../diagram/geometry';\nimport { Command } from '../diagram/history';\nimport { PaperArea, PointerUpEvent, PaperWidgetProps } from '../diagram/paperArea';\nimport { DiagramView, IriClickIntent, WidgetAttachment } from '../diagram/view';\n\nimport { Events, EventSource, EventObserver, PropertyChange } from '../viewUtils/events';\n\nimport { Dialog } from '../widgets/dialog';\nimport { ConnectionsMenu, PropertySuggestionHandler } from '../widgets/connectionsMenu';\nimport { EditEntityForm } from '../forms/editEntityForm';\nimport { EditElementTypeForm } from '../forms/editElementTypeForm';\nimport { EditLinkForm } from '../forms/editLinkForm';\nimport { EditLinkLabelForm } from '../forms/editLinkLabelForm';\nimport { Halo } from '../widgets/halo';\nimport { HaloLink } from '../widgets/haloLink';\nimport { LinkStateWidget } from './linkStateWidget';\nimport { ElementDecorator } from './elementDecorator';\n\nimport { placeElementsAround, forceLayout, applyLayout, removeOverlaps } from '../viewUtils/layout';\nimport { Spinner, SpinnerProps } from '../viewUtils/spinner';\n\nimport { AsyncModel, requestElementData, restoreLinksBetweenElements } from './asyncModel';\nimport { AuthoringState, AuthoringKind, AuthoringEvent, TemporaryState, ElementChange } from './authoringState';\nimport { EditLayer, EditLayerMode } from './editLayer';\nimport { ValidationState, changedElementsToValidate, validateElements } from './validation';\n\nimport { Cancellation } from '../viewUtils/async';\nimport { makeMoveComparator, MoveDirection } from '../viewUtils/collections';\n\nexport interface PropertyEditorOptions {\n  elementData: ElementModel;\n  onSubmit: (newData: ElementModel) => void;\n  onCancel?: () => void;\n}\nexport type PropertyEditor = (options: PropertyEditorOptions) => React.ReactElement<any>;\n\nexport enum DialogTypes {\n  ConnectionsMenu,\n  EditEntityForm,\n  EditLinkForm,\n  EditEntityTypeForm,\n  EditLinkLabelForm,\n}\n\nexport type SelectionItem = Element | Link;\n\nexport interface EditorProps extends EditorOptions {\n  model: AsyncModel;\n  view: DiagramView;\n}\n\nexport interface EditorOptions {\n  disableHalo?: boolean;\n  suggestProperties?: PropertySuggestionHandler;\n  validationApi?: ValidationApi;\n  propertyEditor?: PropertyEditor;\n}\n\nexport interface EditorEvents {\n  changeMode: { source: EditorController };\n  changeSelection: PropertyChange<EditorController, ReadonlyArray<SelectionItem>>;\n  changeAuthoringState: PropertyChange<EditorController, AuthoringState>;\n  changeValidationState: PropertyChange<EditorController, ValidationState>;\n  changeTemporaryState: PropertyChange<EditorController, TemporaryState>;\n  toggleDialog: { isOpened: boolean };\n  addElements: { elements: ReadonlyArray<Element> };\n}\n\nexport class EditorController {\n  private readonly listener = new EventObserver();\n  private readonly source = new EventSource<EditorEvents>();\n  readonly events: Events<EditorEvents> = this.source;\n\n  readonly model: AsyncModel;\n  private readonly view: DiagramView;\n  private readonly options: EditorOptions;\n\n  private _metadataApi: MetadataApi | undefined;\n  private _authoringState = AuthoringState.empty;\n  private _validationState = ValidationState.empty;\n  private _temporaryState = TemporaryState.empty;\n  private _selection: ReadonlyArray<SelectionItem> = [];\n\n  private dialogType: DialogTypes;\n  private dialogTarget: SelectionItem;\n\n  private readonly cancellation = new Cancellation();\n\n  constructor(props: EditorProps) {\n    const { model, view, ...options } = props;\n    this.model = model;\n    this.view = view;\n    this.options = options;\n\n    this.listener.listen(this.events, 'changeValidationState', (e) => {\n      for (const element of this.model.elements) {\n        const previous = e.previous.elements.get(element.iri);\n        const current = this.validationState.elements.get(element.iri);\n        if (current !== previous) {\n          element.redraw();\n        }\n      }\n    });\n    this.listener.listen(this.events, 'changeAuthoringState', (e) => {\n      if (this.options.validationApi) {\n        const changedElements = changedElementsToValidate(e.previous, this);\n        validateElements(changedElements, this.options.validationApi, this, this.cancellation.signal);\n      }\n    });\n\n    this.view._setElementDecorator((element: Element) => (\n      <ElementDecorator model={element} view={this.view} editor={this} position={element.position} />\n    ));\n  }\n\n  _initializePaperComponents(paperArea: PaperArea) {\n    this.listener.listen(paperArea.events, 'pointerUp', (e) => this.onPaperPointerUp(e));\n    this.listener.listen(this.model.events, 'changeCells', () => this.onCellsChanged());\n    this.listener.listen(this.model.events, 'elementEvent', (e) => {\n      if (e.key === 'requestedGroupContent') {\n        this.loadGroupContent(e.data.requestedGroupContent.source);\n      }\n    });\n\n    this.listener.listen(this.model.events, 'loadingStart', () => this.setSpinner({}));\n    this.listener.listen(this.model.events, 'loadingSuccess', () => {\n      this.setSpinner(undefined);\n\n      const widget = <LinkStateWidget view={this.view} editor={this} />;\n      this.view.setPaperWidget({ key: 'states', widget, attachment: WidgetAttachment.OverLinks });\n    });\n    this.listener.listen(this.model.events, 'loadingError', ({ error }) => {\n      const statusText = error ? error.message : undefined;\n      this.setSpinner({ statusText, errorOccured: true });\n    });\n\n    if (!this.options.disableHalo) {\n      this.configureHalo();\n      document.addEventListener('keyup', this.onKeyUp);\n      this.listener.listen(this.view.events, 'dispose', () => {\n        document.removeEventListener('keyup', this.onKeyUp);\n      });\n    }\n  }\n\n  get inAuthoringMode(): boolean {\n    return Boolean(this._metadataApi);\n  }\n\n  get metadataApi() {\n    return this._metadataApi;\n  }\n  setMetadataApi(value: MetadataApi) {\n    const previous = this._metadataApi;\n    if (value === previous) {\n      return;\n    }\n    this._metadataApi = value;\n    if (Boolean(value) !== Boolean(previous)) {\n      // authoring mode changed\n      this.source.trigger('changeMode', { source: this });\n    }\n  }\n\n  get authoringState() {\n    return this._authoringState;\n  }\n  setAuthoringState(value: AuthoringState) {\n    const previous = this._authoringState;\n    if (previous === value) {\n      return;\n    }\n    this.model.history.execute(this.updateAuthoringState(value));\n  }\n\n  private updateAuthoringState(state: AuthoringState): Command {\n    const previous = this._authoringState;\n    return Command.create('Create or delete entities and links', () => {\n      this._authoringState = state;\n      this.source.trigger('changeAuthoringState', { source: this, previous });\n      return this.updateAuthoringState(previous);\n    });\n  }\n\n  get validationState() {\n    return this._validationState;\n  }\n  setValidationState(value: ValidationState) {\n    const previous = this._validationState;\n    if (value === previous) {\n      return;\n    }\n    this._validationState = value;\n    this.source.trigger('changeValidationState', { source: this, previous });\n  }\n\n  get temporaryState() {\n    return this._temporaryState;\n  }\n  setTemporaryState(value: TemporaryState) {\n    const previous = this._temporaryState;\n    if (value === previous) {\n      return;\n    }\n    this._temporaryState = value;\n    this.source.trigger('changeTemporaryState', { source: this, previous });\n  }\n\n  get selection() {\n    return this._selection;\n  }\n  setSelection(value: ReadonlyArray<SelectionItem>) {\n    const previous = this._selection;\n    if (previous === value) {\n      return;\n    }\n    this._selection = value;\n    this.source.trigger('changeSelection', { source: this, previous });\n  }\n\n  cancelSelection() {\n    this.setSelection([]);\n  }\n\n  private onKeyUp = (e: KeyboardEvent) => {\n    const DELETE_KEY_CODE = 46;\n    if (e.keyCode === DELETE_KEY_CODE && document.activeElement.localName !== 'input') {\n      this.removeSelectedElements();\n    }\n  };\n\n  removeSelectedElements() {\n    const itemsToRemove = this.selection;\n    if (itemsToRemove.length === 0) {\n      return;\n    }\n\n    this.cancelSelection();\n    this.removeItems(itemsToRemove);\n  }\n\n  removeItems(items: ReadonlyArray<SelectionItem>) {\n    const batch = this.model.history.startBatch();\n    const deletedElementIris = new Set<ElementIri>();\n\n    for (const item of items) {\n      if (item instanceof Element) {\n        const event = this.authoringState.elements.get(item.iri);\n        if (event) {\n          this.discardChange(event);\n        }\n        this.model.removeElement(item.id);\n        deletedElementIris.add(item.iri);\n      } else if (item instanceof Link) {\n        if (AuthoringState.isNewLink(this.authoringState, item.data)) {\n          this.deleteLink(item.data);\n        }\n      }\n    }\n\n    if (deletedElementIris.size > 0) {\n      const newState = AuthoringState.deleteNewLinksConnectedToElements(this.authoringState, deletedElementIris);\n      this.setAuthoringState(newState);\n    }\n\n    batch.store();\n  }\n\n  private onPaperPointerUp(event: PointerUpEvent) {\n    if (this.options.disableHalo) {\n      return;\n    }\n    const { sourceEvent, target, triggerAsClick } = event;\n\n    if (sourceEvent.ctrlKey || sourceEvent.shiftKey || sourceEvent.metaKey) {\n      return;\n    }\n\n    if (this.dialogTarget && this.dialogType === DialogTypes.EditEntityForm) {\n      return;\n    }\n\n    if (target instanceof Element) {\n      this.setSelection([target]);\n      target.focus();\n    } else if (target instanceof Link) {\n      this.setSelection([target]);\n    } else if (target instanceof LinkVertex) {\n      this.setSelection([target.link]);\n    } else if (!target && triggerAsClick) {\n      this.setSelection([]);\n      this.hideDialog();\n      if (document.activeElement) {\n        (document.activeElement as HTMLElement).blur();\n      }\n    }\n  }\n\n  private onCellsChanged() {\n    if (this.selection.length === 0) {\n      return;\n    }\n    const newSelection = this.selection.filter((item) =>\n      item instanceof Element\n        ? this.model.getElement(item.id)\n        : item instanceof Link\n        ? this.model.getLinkById(item.id)\n        : false\n    );\n    if (newSelection.length < this.selection.length) {\n      this.setSelection(newSelection);\n    }\n  }\n\n  setSpinner(props: SpinnerProps | undefined) {\n    const widget = props ? <LoadingWidget spinnerProps={props} /> : undefined;\n    this.view.setPaperWidget({ key: LoadingWidget.Key, widget, attachment: WidgetAttachment.Viewport });\n  }\n\n  private configureHalo() {\n    if (this.options.disableHalo) {\n      return;\n    }\n\n    this.listener.listen(this.events, 'changeSelection', () => {\n      const selected = this.selection.length === 1 ? this.selection[0] : undefined;\n      if (this.dialogTarget && selected !== this.dialogTarget) {\n        this.hideDialog();\n      }\n      this.bringSelectedElementsToFront();\n      this.renderDefaultHalo();\n    });\n\n    this.listener.listen(this.events, 'toggleDialog', ({ isOpened }) => {\n      this.renderDefaultHalo();\n    });\n\n    this.renderDefaultHalo();\n  }\n\n  private bringSelectedElementsToFront() {\n    if (this.selection.length === 0) {\n      return;\n    }\n    this.model.reorderElements(\n      makeMoveComparator(\n        this.model.elements,\n        this.selection.filter((item) => item instanceof Element),\n        MoveDirection.ToEnd\n      )\n    );\n  }\n\n  private renderDefaultHalo() {\n    const selected = this.selection.length === 1 ? this.selection[0] : undefined;\n\n    let halo: React.ReactElement<Halo | HaloLink>;\n\n    if (selected instanceof Element) {\n      halo = (\n        <Halo\n          editor={this}\n          metadataApi={this.metadataApi}\n          target={selected}\n          onRemove={() => this.removeSelectedElements()}\n          onExpand={() => {\n            this.model.history.execute(setElementExpanded(selected, !selected.isExpanded));\n          }}\n          navigationMenuOpened={this.dialogType === DialogTypes.ConnectionsMenu}\n          onToggleNavigationMenu={() => {\n            if (this.dialogTarget && this.dialogType === DialogTypes.ConnectionsMenu) {\n              this.hideDialog();\n            } else {\n              this.showConnectionsMenu(selected);\n            }\n            this.renderDefaultHalo();\n          }}\n          onAddToFilter={() => selected.addToFilter()}\n          onEstablishNewLink={(point: { x: number; y: number }) =>\n            this.startEditing({ target: selected, mode: EditLayerMode.establishLink, point })\n          }\n          onFollowLink={(element, e) => this.view.onIriClick(element.iri, element, IriClickIntent.JumpToEntity, e)}\n        />\n      );\n    } else if (selected instanceof Link) {\n      halo = (\n        <HaloLink\n          view={this.view}\n          editor={this}\n          metadataApi={this.metadataApi}\n          target={selected}\n          onEdit={() => this.showEditLinkForm(selected)}\n          onDelete={() => this.deleteLink(selected.data)}\n          onSourceMove={(point: { x: number; y: number }) =>\n            this.startEditing({ target: selected, mode: EditLayerMode.moveLinkSource, point })\n          }\n          onTargetMove={(point: { x: number; y: number }) =>\n            this.startEditing({ target: selected, mode: EditLayerMode.moveLinkTarget, point })\n          }\n          onEditLabel={() => this.showEditLinkLabelForm(selected)}\n        />\n      );\n    }\n\n    this.view.setPaperWidget({ key: 'halo', widget: halo, attachment: WidgetAttachment.OverElements });\n  }\n\n  showConnectionsMenu(target: Element) {\n    const dialogType = DialogTypes.ConnectionsMenu;\n    const onClose = () => this.hideDialog();\n    const content = (\n      <ConnectionsMenu\n        view={this.view}\n        editor={this}\n        target={target}\n        onAddElements={(iris, linkType) => this.onAddElementsInConnectionMenu(iris, target, linkType)}\n        onClose={onClose}\n        suggestProperties={this.options.suggestProperties}\n      />\n    );\n    this.showDialog({ target, dialogType, content, onClose });\n  }\n\n  showEditEntityForm(target: Element) {\n    const { propertyEditor } = this.options;\n    const dialogType = DialogTypes.EditEntityForm;\n    const onSubmit = (newData: ElementModel) => {\n      this.hideDialog();\n      this.changeEntityData(target.data.id, newData);\n    };\n    const isIriModified = AuthoringState.isElementWithModifiedIri(this.authoringState, target.data.id);\n    let modelToEdit;\n    if (isIriModified) {\n      const relatedEvent = this.authoringState.elements.get(target.data.id);\n      modelToEdit = {\n        ...target.data,\n        id: (relatedEvent as ElementChange).newIri,\n      };\n    } else {\n      modelToEdit = target.data;\n    }\n    const onCancel = () => this.hideDialog();\n    const content = propertyEditor ? (\n      propertyEditor({ elementData: target.data, onSubmit, onCancel })\n    ) : (\n      <EditEntityForm view={this.view} entity={modelToEdit} onApply={onSubmit} onCancel={onCancel} />\n    );\n    this.showDialog({ target, dialogType, content, onClose: onCancel });\n  }\n\n  showEditElementTypeForm({\n    link,\n    source,\n    target,\n    targetIsNew,\n  }: {\n    link: Link;\n    source: Element;\n    target: Element;\n    targetIsNew: boolean;\n  }) {\n    const dialogType = DialogTypes.EditEntityTypeForm;\n    const onCancel = () => {\n      this.removeTemporaryElement(target);\n      this.removeTemporaryLink(link);\n      this.hideDialog();\n    };\n    const content = (\n      <EditElementTypeForm\n        editor={this}\n        view={this.view}\n        metadataApi={this.metadataApi}\n        link={link.data}\n        source={source.data}\n        target={{ value: target.data, isNew: targetIsNew }}\n        onChangeElement={(data: ElementModel) => {\n          const previous = target.data;\n          this.setTemporaryState(TemporaryState.deleteElement(this.temporaryState, previous));\n          target.setData(data);\n          this.setTemporaryState(TemporaryState.addElement(this.temporaryState, data));\n        }}\n        onChangeLink={(data: LinkModel) => {\n          this.removeTemporaryLink(link);\n          const newLink = makeLinkWithDirection(\n            new Link({\n              typeId: data.linkTypeId,\n              sourceId: source.id,\n              targetId: target.id,\n              data: {\n                ...data,\n                sourceId: source.iri,\n                targetId: target.iri,\n              },\n            }),\n            data\n          );\n          link = this.createNewLink({ link: newLink, temporary: true });\n        }}\n        onApply={(elementData: ElementModel, isNewElement: boolean, linkData: LinkModel) => {\n          this.removeTemporaryElement(target);\n          this.removeTemporaryLink(link);\n\n          const batch = this.model.history.startBatch(isNewElement ? 'Create new entity' : 'Link to entity');\n\n          this.model.addElement(target);\n          if (isNewElement) {\n            target.setExpanded(true);\n            this.setAuthoringState(AuthoringState.addElement(this._authoringState, target.data));\n          } else {\n            this.model.requestLinksOfType();\n          }\n\n          const newLink = makeLinkWithDirection(\n            new Link({\n              typeId: link.typeId,\n              sourceId: source.id,\n              targetId: target.id,\n              data: {\n                ...link.data,\n                sourceId: source.iri,\n                targetId: target.iri,\n              },\n            }),\n            linkData\n          );\n          this.createNewLink({ link: newLink });\n\n          batch.store();\n\n          this.hideDialog();\n          if (isNewElement) {\n            this.showEditEntityForm(target);\n          }\n        }}\n        onCancel={onCancel}\n      />\n    );\n    this.showDialog({ target, dialogType, content, caption: 'Establish New Connection', onClose: onCancel });\n  }\n\n  showEditLinkForm(link: Link) {\n    const dialogType = DialogTypes.EditLinkForm;\n    const source = this.model.getElement(link.sourceId).data;\n    const target = this.model.getElement(link.targetId).data;\n    const onCancel = () => {\n      if (this.temporaryState.links.has(link.data)) {\n        this.removeTemporaryLink(link);\n      }\n      this.hideDialog();\n    };\n    const content = (\n      <EditLinkForm\n        editor={this}\n        view={this.view}\n        metadataApi={this.metadataApi}\n        link={link.data}\n        source={source}\n        target={target}\n        onChange={(data: LinkModel) => {\n          if (this.temporaryState.links.has(link.data)) {\n            this.removeTemporaryLink(link);\n            const newLink = makeLinkWithDirection(link, data);\n            this.showEditLinkForm(this.createNewLink({ link: newLink, temporary: true }));\n          }\n        }}\n        onApply={(data: LinkModel) => {\n          if (this.temporaryState.links.has(link.data)) {\n            this.removeTemporaryLink(link);\n            const newLink = makeLinkWithDirection(link, data);\n            this.createNewLink({ link: newLink });\n          } else {\n            this.changeLink(link.data, data);\n          }\n          this.hideDialog();\n        }}\n        onCancel={onCancel}\n      />\n    );\n    const caption = this.temporaryState.links.has(link.data) ? 'Establish New Connection' : 'Edit Connection';\n    this.showDialog({\n      target: link,\n      dialogType,\n      content,\n      size: { width: 300, height: 160 },\n      caption,\n      onClose: onCancel,\n    });\n  }\n\n  // Link editing implementation could be rethought in the future.\n  private showEditLinkLabelForm(link: Link) {\n    const linkType = this.view.model.getLinkType(link.typeId);\n    const template = this.view.createLinkTemplate(linkType);\n    const size = { width: 300, height: 145 };\n    const onCancel = () => this.hideDialog();\n    this.showDialog({\n      target: link,\n      dialogType: DialogTypes.EditLinkLabelForm,\n      content: (\n        <EditLinkLabelForm\n          view={this.view}\n          link={link}\n          onApply={(label: string) => {\n            template.setLinkLabel(link, label);\n            this.hideDialog();\n          }}\n          onCancel={onCancel}\n        />\n      ),\n      size,\n      caption: 'Edit Link Label',\n      offset: { x: 25, y: -size.height / 2 },\n      calculatePosition: () => {\n        const { x, y, width, height } = link.labelBounds;\n        return { x: x + width, y: y + height / 2 };\n      },\n      onClose: onCancel,\n    });\n  }\n\n  showDialog(params: {\n    target: SelectionItem;\n    dialogType: DialogTypes;\n    content: React.ReactElement<any>;\n    size?: { width: number; height: number };\n    caption?: string;\n    offset?: Vector;\n    calculatePosition?: () => Vector;\n    onClose: () => void;\n  }) {\n    const { target, dialogType, content, size, caption, offset, calculatePosition, onClose } = params;\n\n    this.dialogTarget = target;\n    this.dialogType = dialogType;\n\n    const dialog = (\n      <Dialog\n        view={this.view}\n        target={target}\n        size={size}\n        caption={caption}\n        offset={offset}\n        calculatePosition={calculatePosition}\n        onClose={onClose}\n      >\n        {content}\n      </Dialog>\n    );\n    this.view.setPaperWidget({ key: 'dialog', widget: dialog, attachment: WidgetAttachment.OverElements });\n    this.source.trigger('toggleDialog', { isOpened: true });\n  }\n\n  hideDialog() {\n    if (this.dialogTarget) {\n      const isTemporaryElement =\n        this.dialogTarget instanceof Element && this.temporaryState.elements.has(this.dialogTarget.iri);\n      const isTemporaryLink =\n        this.dialogTarget instanceof Link && this.temporaryState.links.has(this.dialogTarget.data);\n      if (isTemporaryElement || isTemporaryLink) {\n        this.resetTemporaryState();\n      }\n      this.dialogType = undefined;\n      this.dialogTarget = undefined;\n      this.view.setPaperWidget({ key: 'dialog', widget: undefined, attachment: WidgetAttachment.OverElements });\n      this.source.trigger('toggleDialog', { isOpened: false });\n    }\n  }\n\n  onDragDrop(dragged: ReadonlyArray<ElementIri | ElementModel>, paperPosition: Vector) {\n    const batch = this.model.history.startBatch('Drag and drop onto diagram');\n    const placedElements = placeElements(this.view, dragged, paperPosition);\n    const irisToLoad = placedElements.map((elem) => elem.iri);\n    batch.history.execute(requestElementData(this.model, irisToLoad));\n    batch.history.execute(restoreLinksBetweenElements(this.model));\n    batch.store();\n\n    if (placedElements.length > 0) {\n      placedElements[placedElements.length - 1].focus();\n    }\n\n    this.setSelection(placedElements);\n\n    this.source.trigger('addElements', { elements: placedElements });\n  }\n\n  onAddElementsInConnectionMenu(elementIris: ElementIri[], targetElement: Element, linkType: FatLinkType | undefined) {\n    const batch = this.view.model.history.startBatch();\n\n    const elements = elementIris.map((iri) => this.model.createElement(iri));\n    this.view.performSyncUpdate();\n\n    placeElementsAround({\n      model: this.model,\n      elements,\n      targetElement,\n      prefferedLinksLength: 300,\n    }).then(() => {\n      this.source.trigger('addElements', { elements });\n    });\n\n    if (linkType && !linkType.visible) {\n      batch.history.execute(\n        changeLinkTypeVisibility({\n          linkType,\n          visible: true,\n          showLabel: true,\n          preventLoading: true,\n        })\n      );\n    }\n\n    batch.history.execute(requestElementData(this.model, elementIris));\n    batch.history.execute(restoreLinksBetweenElements(this.model));\n    batch.store();\n  }\n\n  private loadGroupContent(element: Element): Promise<void> {\n    return this.model.loadEmbeddedElements(element.iri).then((models) => {\n      const batch = this.model.history.startBatch();\n      const elementIris = Object.keys(models) as ElementIri[];\n      const elements = elementIris.map((key) => this.model.createElement(models[key], element.id));\n      batch.discard();\n\n      return Promise.all([this.model.requestElementData(elementIris), this.model.requestLinksOfType()]).then(() => {\n        this.view.performSyncUpdate();\n        applyLayout(\n          this.model,\n          forceLayout({\n            model: this.model,\n            group: element.id,\n          })\n        );\n        this.model.triggerChangeGroupContent(element.id);\n      });\n    });\n  }\n\n  createNewEntity({\n    elementModel, temporary\n  }: { elementModel: ElementModel; position?: Vector, temporary?: boolean }): Element {\n    const batch = this.model.history.startBatch('Create new entity');\n\n    // when creating new element we want to put it in the center of the diagram\n    // but avoid overlap with other existing elements\n    // to do this we need to remember elements before addition an then\n    // call removeOverlaps with fixed old elements\n    const fixedElements = new Set(this.model.elements);\n    const element = this.model.createElement(elementModel);\n    // set initial position slightly off from the center to avoid webcola bug\n    // see https://github.com/tgdwyer/WebCola/issues/279\n    element.setPosition({x: Math.random(), y: Math.random()});\n    element.setExpanded(true);\n    if (temporary) {\n      this.setTemporaryState(TemporaryState.addElement(this.temporaryState, element.data));\n      batch.discard();\n    } else {\n      this.setAuthoringState(AuthoringState.addElement(this._authoringState, element.data));\n      batch.store();\n    }\n\n    this.view.performSyncUpdate();\n    applyLayout(\n      this.model,\n      removeOverlaps({model: this.model, fixedElements, padding: { x: 15, y: 15 }})\n    );\n    return element;\n  }\n\n  changeEntityData(targetIri: ElementIri, newData: ElementModel) {\n    const elements = this.model.elements.filter((el) => el.iri === targetIri);\n    if (elements.length === 0) {\n      return;\n    }\n    const oldData = elements[0].data;\n    const batch = this.model.history.startBatch('Edit entity');\n\n    const newState = AuthoringState.changeElement(this._authoringState, oldData, newData);\n    // get created authoring event by either old or new IRI (in case of new entities)\n    const event = newState.elements.get(targetIri) || newState.elements.get(newData.id);\n    this.model.history.execute(setElementData(this.model, targetIri, event.after));\n    this.setAuthoringState(newState);\n\n    batch.store();\n  }\n\n  deleteEntity(elementIri: ElementIri) {\n    const state = this.authoringState;\n    const elements = this.model.elements.filter((el) => el.iri === elementIri);\n    if (elements.length === 0) {\n      return;\n    }\n\n    const batch = this.model.history.startBatch('Delete entity');\n    const model = elements[0].data;\n\n    const event = state.elements.get(elementIri);\n    // remove new connected links\n    const linksToRemove = new Set<string>();\n    for (const element of elements) {\n      for (const link of element.links) {\n        if (link.data && AuthoringState.isNewLink(state, link.data)) {\n          linksToRemove.add(link.id);\n        }\n      }\n    }\n    linksToRemove.forEach((linkId) => this.model.removeLink(linkId));\n\n    if (event) {\n      this.discardChange(event);\n    }\n    this.setAuthoringState(AuthoringState.deleteElement(state, model));\n    batch.store();\n  }\n\n  createNewLink(params: { link: Link; temporary?: boolean }): Link {\n    const { link: base, temporary } = params;\n    const existingLink = this.model.findLink(base.typeId, base.sourceId, base.targetId);\n    if (existingLink) {\n      throw Error('The link already exists');\n    }\n\n    const batch = this.model.history.startBatch('Create new link');\n\n    const addedLink = this.model.addLink(base);\n    if (!temporary) {\n      this.model.createLinks(base.data);\n    }\n\n    const links = this.model.links.filter((link) => sameLink(link.data, base.data));\n    if (links.length > 0) {\n      if (temporary) {\n        this.setTemporaryState(TemporaryState.addLink(this.temporaryState, base.data));\n        batch.discard();\n      } else {\n        this.setAuthoringState(AuthoringState.addLink(this._authoringState, base.data));\n        batch.store();\n      }\n    } else {\n      batch.discard();\n    }\n\n    return addedLink;\n  }\n\n  changeLink(oldData: LinkModel, newData: LinkModel) {\n    const batch = this.model.history.startBatch('Change link');\n    if (sameLink(oldData, newData)) {\n      this.model.history.execute(setLinkData(this.model, oldData, newData));\n      this.setAuthoringState(AuthoringState.changeLink(this._authoringState, oldData, newData));\n    } else {\n      let newState = this._authoringState;\n      newState = AuthoringState.deleteLink(newState, oldData);\n      newState = AuthoringState.addLink(newState, newData);\n\n      if (AuthoringState.isNewLink(this._authoringState, oldData)) {\n        this.model.links\n          .filter((link) => sameLink(link.data, oldData))\n          .forEach((link) => this.model.removeLink(link.id));\n      }\n      this.model.createLinks(newData);\n      this.setAuthoringState(newState);\n    }\n    batch.store();\n  }\n\n  moveLinkSource(params: { link: Link; newSource: Element }): Link {\n    const { link, newSource } = params;\n    const batch = this.model.history.startBatch('Move link to another element');\n    this.changeLink(link.data, { ...link.data, sourceId: newSource.iri });\n    const newLink = this.model.findLink(link.typeId, newSource.id, link.targetId);\n    newLink.setVertices(link.vertices);\n    batch.store();\n    return newLink;\n  }\n\n  moveLinkTarget(params: { link: Link; newTarget: Element }): Link {\n    const { link, newTarget } = params;\n    const batch = this.model.history.startBatch('Move link to another element');\n    this.changeLink(link.data, { ...link.data, targetId: newTarget.iri });\n    const newLink = this.model.findLink(link.typeId, link.sourceId, newTarget.id);\n    newLink.setVertices(link.vertices);\n    batch.store();\n    return newLink;\n  }\n\n  deleteLink(model: LinkModel) {\n    const state = this.authoringState;\n    if (AuthoringState.isDeletedLink(state, model)) {\n      return;\n    }\n    const batch = this.model.history.startBatch('Delete link');\n    const newState = AuthoringState.deleteLink(state, model);\n    if (AuthoringState.isNewLink(state, model)) {\n      this.model.links.filter(({ data }) => sameLink(data, model)).forEach((link) => this.model.removeLink(link.id));\n    }\n    this.setAuthoringState(newState);\n    batch.store();\n  }\n\n  private startEditing(params: { target: Element | Link; mode: EditLayerMode; point: Vector }) {\n    const { target, mode, point } = params;\n    const onFinishEditing = () => {\n      this.view.setPaperWidget({ key: 'editLayer', widget: undefined, attachment: WidgetAttachment.OverElements });\n    };\n    const editLayer = (\n      <EditLayer\n        view={this.view}\n        editor={this}\n        metadataApi={this.metadataApi}\n        mode={mode}\n        target={target}\n        point={point}\n        onFinishEditing={onFinishEditing}\n      />\n    );\n    this.view.setPaperWidget({ key: 'editLayer', widget: editLayer, attachment: WidgetAttachment.OverElements });\n  }\n\n  private resetTemporaryState() {\n    if (this.temporaryState.elements.size) {\n      this.model.elements.forEach((element) => {\n        if (this.temporaryState.elements.has(element.iri)) {\n          this.removeTemporaryElement(element);\n        }\n      });\n    }\n    if (this.temporaryState.links.size) {\n      this.model.links.forEach((link) => {\n        if (this.temporaryState.links.get(link.data)) {\n          this.removeTemporaryLink(link);\n        }\n      });\n    }\n  }\n\n  private removeTemporaryElement(element: Element) {\n    const batch = this.model.history.startBatch();\n    this.model.removeElement(element.id);\n    batch.discard();\n    this.setTemporaryState(TemporaryState.deleteElement(this.temporaryState, element.data));\n  }\n\n  private removeTemporaryLink(link: Link) {\n    this.model.removeLink(link.id);\n    this.setTemporaryState(TemporaryState.deleteLink(this.temporaryState, link.data));\n  }\n\n  discardChange(event: AuthoringEvent) {\n    const newState = AuthoringState.discard(this._authoringState, event);\n    if (newState === this._authoringState) {\n      return;\n    }\n\n    const batch = this.model.history.startBatch('Discard change');\n    if (event.type === AuthoringKind.ChangeElement) {\n      if (event.deleted) {\n        /* nothing */\n      } else if (event.before) {\n        this.model.history.execute(setElementData(this.model, event.after.id, event.before));\n      } else {\n        this.model.elements.filter((el) => el.iri === event.after.id).forEach((el) => this.model.removeElement(el.id));\n      }\n    } else if (event.type === AuthoringKind.ChangeLink) {\n      if (event.deleted) {\n        /* nothing */\n      } else if (event.before) {\n        this.model.history.execute(setLinkData(this.model, event.after, event.before));\n      } else {\n        this.model.links\n          .filter(({ data }) => sameLink(data, event.after))\n          .forEach((link) => this.model.removeLink(link.id));\n      }\n    }\n    this.setAuthoringState(newState);\n    batch.store();\n  }\n}\n\ninterface LoadingWidgetProps extends PaperWidgetProps {\n  spinnerProps: Partial<SpinnerProps>;\n}\n\nclass LoadingWidget extends React.Component<LoadingWidgetProps, {}> {\n  static readonly Key = 'loadingWidget';\n\n  render() {\n    const { spinnerProps, paperArea } = this.props;\n    const areaMetrics = paperArea.getAreaMetrics();\n    const paneWidth = areaMetrics.clientWidth;\n    const paneHeight = areaMetrics.clientHeight;\n\n    const x = spinnerProps.statusText ? paneWidth / 3 : paneWidth / 2;\n    const position = { x, y: paneHeight / 2 };\n    return (\n      <div className=\"ontodia-loading-widget\">\n        <svg width={paneWidth} height={paneHeight}>\n          <Spinner position={position} {...spinnerProps} />\n        </svg>\n      </div>\n    );\n  }\n}\n\nfunction placeElements(\n  view: DiagramView,\n  dragged: ReadonlyArray<ElementIri | ElementModel>,\n  position: Vector\n): Element[] {\n  const elements = dragged.map((item) => view.model.createElement(item));\n  for (const element of elements) {\n    // intialally anchor element at top left corner to preserve canvas scroll state,\n    // measure it and only then move to center-anchored position\n    element.setPosition(position);\n  }\n  view.performSyncUpdate();\n\n  let { x, y } = position;\n  let isFirst = true;\n  for (const element of elements) {\n    let { width, height } = boundsOf(element);\n    if (width === 0) {\n      width = 100;\n    }\n    if (height === 0) {\n      height = 50;\n    }\n\n    if (isFirst) {\n      isFirst = false;\n      x -= width / 2;\n      y -= height / 2;\n    }\n\n    element.setPosition({ x, y });\n    y += height + 20;\n  }\n\n  return elements;\n}\n\nfunction makeLinkWithDirection(original: Link, data: LinkModel): Link {\n  if (!(data.sourceId === original.data.sourceId || data.sourceId === original.data.targetId)) {\n    throw new Error('New link source IRI is unrelated to original link');\n  }\n  if (!(data.targetId === original.data.sourceId || data.targetId === original.data.targetId)) {\n    throw new Error('New link target IRI is unrelated to original link');\n  }\n  const sourceId = data.sourceId === original.data.sourceId ? original.sourceId : original.targetId;\n  const targetId = data.targetId === original.data.targetId ? original.targetId : original.sourceId;\n  return new Link({ typeId: data.linkTypeId, sourceId, targetId, data });\n}\n","import * as React from 'react';\n\nimport { Dictionary, ElementModel, ElementIri, LinkTypeIri } from '../data/model';\n\nimport { FatLinkType, Element } from '../diagram/elements';\nimport { DiagramView } from '../diagram/view';\n\nimport { EditorController } from '../editor/editorController';\nimport { EventObserver } from '../viewUtils/events';\nimport { ProgressBar, ProgressState } from '../widgets/progressBar';\nimport { highlightSubstring } from './listElementView';\nimport { SearchResults } from './searchResults';\n\nimport { WorkspaceContextTypes, WorkspaceContextWrapper, WorkspaceEventKey } from '../workspace/workspaceContext';\n\ninterface ConnectionCount {\n  inCount: number;\n  outCount: number;\n}\n\nexport interface ReactElementModel {\n  model: ElementModel;\n  presentOnDiagram: boolean;\n}\n\nconst MAX_LINK_COUNT = 100;\nconst ALL_RELATED_ELEMENTS_LINK: FatLinkType = new FatLinkType({\n  id: 'allRelatedElements' as LinkTypeIri,\n  label: [{ value: 'All', language: '' }],\n});\n\nexport interface PropertySuggestionParams {\n  elementId: string;\n  token: string;\n  properties: string[];\n  lang: string;\n}\nexport type PropertySuggestionHandler = (params: PropertySuggestionParams) => Promise<Dictionary<PropertyScore>>;\n\ntype SortMode = 'alphabet' | 'smart';\n\nexport interface PropertyScore {\n  propertyIri: string;\n  score: number;\n}\n\nexport interface LinkDataChunk {\n  link: FatLinkType;\n  direction?: 'in' | 'out';\n  expectedCount: number;\n  offset?: number;\n}\n\nexport interface ObjectsData {\n  linkDataChunk: LinkDataChunk;\n  objects: ReactElementModel[];\n}\n\nexport interface ConnectionsMenuProps {\n  view: DiagramView;\n  editor: EditorController;\n  target: Element;\n  onClose: () => void;\n  onAddElements: (elementIris: ElementIri[], linkType: FatLinkType | undefined) => void;\n  suggestProperties?: PropertySuggestionHandler;\n}\n\nexport class ConnectionsMenu extends React.Component<ConnectionsMenuProps, {}> {\n  static contextTypes = WorkspaceContextTypes;\n  readonly context: WorkspaceContextWrapper;\n\n  private readonly handler = new EventObserver();\n  private readonly linkTypesListener = new EventObserver();\n  private loadingState = ProgressState.none;\n\n  private links: FatLinkType[];\n  private countMap: { [linkTypeId: string]: ConnectionCount };\n\n  private linkDataChunk: LinkDataChunk;\n  private objects: ReactElementModel[];\n\n  private updateAll = () => this.forceUpdate();\n\n  componentDidMount() {\n    const { view } = this.props;\n    this.handler.listen(view.events, 'changeLanguage', this.updateAll);\n\n    this.loadLinks();\n  }\n\n  componentWillUnmount() {\n    this.handler.stopListening();\n    this.linkTypesListener.stopListening();\n  }\n\n  private resubscribeOnLinkTypeEvents(linkTypesOfElement: ReadonlyArray<FatLinkType>) {\n    this.linkTypesListener.stopListening();\n    for (const linkType of linkTypesOfElement) {\n      this.linkTypesListener.listen(linkType.events, 'changeLabel', this.updateAll);\n      this.linkTypesListener.listen(linkType.events, 'changeVisibility', this.updateAll);\n    }\n  }\n\n  private loadLinks() {\n    const { view, editor, target } = this.props;\n\n    this.loadingState = ProgressState.loading;\n    this.links = [];\n    this.countMap = {};\n    editor.model.dataProvider\n      .linkTypesOf({ elementId: target.iri })\n      .then((linkTypes) => {\n        this.loadingState = ProgressState.completed;\n\n        const countMap: Dictionary<ConnectionCount> = {};\n        const links: FatLinkType[] = [];\n        for (const { id: linkTypeId, inCount, outCount } of linkTypes) {\n          countMap[linkTypeId] = { inCount, outCount };\n          links.push(view.model.createLinkType(linkTypeId));\n        }\n\n        countMap[ALL_RELATED_ELEMENTS_LINK.id] = Object.keys(countMap)\n          .map((key) => countMap[key])\n          .reduce(\n            (a, b) => {\n              return { inCount: a.inCount + b.inCount, outCount: a.outCount + b.outCount };\n            },\n            { inCount: 0, outCount: 0 }\n          );\n\n        this.countMap = countMap;\n        this.links = links;\n        this.resubscribeOnLinkTypeEvents(this.links);\n\n        this.updateAll();\n\n        this.context.ontodiaWorkspace.triggerWorkspaceEvent(WorkspaceEventKey.connectionsLoadLinks);\n      })\n      .catch((err) => {\n        // tslint:disable-next-line:no-console\n        console.error(err);\n        this.loadingState = ProgressState.error;\n        this.updateAll();\n      });\n    this.updateAll();\n  }\n\n  private loadObjects(linkDataChunk: LinkDataChunk) {\n    const { view, editor, target } = this.props;\n    const { link, direction } = linkDataChunk;\n    const offset = linkDataChunk.offset || 0;\n\n    this.loadingState = ProgressState.loading;\n    this.linkDataChunk = linkDataChunk;\n    this.objects = [];\n\n    editor.model.dataProvider\n      .linkElements({\n        elementId: target.iri,\n        linkId: link === ALL_RELATED_ELEMENTS_LINK ? undefined : link.id,\n        limit: offset + MAX_LINK_COUNT,\n        offset: offset,\n        direction,\n      })\n      .then((elements) => {\n        this.loadingState = ProgressState.completed;\n        this.objects = Object.keys(elements).map((iri) => ({\n          model: elements[iri],\n          presentOnDiagram:\n            view.model.elements.findIndex((element) => element.iri === iri && element.group === undefined) >= 0,\n        }));\n        this.updateAll();\n\n        this.context.ontodiaWorkspace.triggerWorkspaceEvent(WorkspaceEventKey.connectionsLoadElements);\n      })\n      .catch((err) => {\n        // tslint:disable-next-line:no-console\n        console.error(err);\n        this.loadingState = ProgressState.error;\n        this.updateAll();\n      });\n  }\n\n  private addSelectedElements = (selectedObjects: ReactElementModel[]) => {\n    const { onClose, onAddElements } = this.props;\n\n    const addedElementsIris = selectedObjects.map((item) => item.model.id);\n    const linkType = this.linkDataChunk ? this.linkDataChunk.link : undefined;\n    const hasChosenLinkType = this.linkDataChunk && linkType !== ALL_RELATED_ELEMENTS_LINK;\n\n    onAddElements(addedElementsIris, hasChosenLinkType ? linkType : undefined);\n    onClose();\n  };\n\n  private onExpandLink = (linkDataChunk: LinkDataChunk) => {\n    const alreadyLoaded =\n      this.objects &&\n      this.linkDataChunk &&\n      this.linkDataChunk.link === linkDataChunk.link &&\n      this.linkDataChunk.direction === linkDataChunk.direction;\n    if (!alreadyLoaded) {\n      this.loadObjects(linkDataChunk);\n    }\n    this.updateAll();\n\n    this.context.ontodiaWorkspace.triggerWorkspaceEvent(WorkspaceEventKey.connectionsExpandLink);\n  };\n\n  private onMoveToFilter = (linkDataChunk: LinkDataChunk) => {\n    const { view, target } = this.props;\n    const { link, direction } = linkDataChunk;\n\n    if (link === ALL_RELATED_ELEMENTS_LINK) {\n      target.addToFilter();\n    } else {\n      const selectedElement = view.model.getElement(target.id);\n      selectedElement.addToFilter(link, direction);\n    }\n  };\n\n  render() {\n    const connectionsData = {\n      links: this.links || [],\n      countMap: this.countMap || {},\n    };\n\n    let objectsData: ObjectsData = null;\n\n    if (this.linkDataChunk && this.objects) {\n      objectsData = {\n        linkDataChunk: this.linkDataChunk,\n        objects: this.objects,\n      };\n    }\n\n    const { view, target, suggestProperties } = this.props;\n    return (\n      <ConnectionsMenuMarkup\n        target={target}\n        connectionsData={connectionsData}\n        objectsData={objectsData}\n        state={this.loadingState}\n        view={view}\n        onExpandLink={this.onExpandLink}\n        onPressAddSelected={this.addSelectedElements}\n        onMoveToFilter={this.onMoveToFilter}\n        propertySuggestionCall={suggestProperties}\n      />\n    );\n  }\n}\n\ninterface ConnectionsMenuMarkupProps {\n  target: Element;\n\n  connectionsData: {\n    links: FatLinkType[];\n    countMap: { [linkTypeId: string]: ConnectionCount };\n  };\n\n  objectsData?: ObjectsData;\n\n  view: DiagramView;\n  state: ProgressState;\n\n  onExpandLink?: (linkDataChunk: LinkDataChunk) => void;\n  onPressAddSelected?: (selectedObjects: ReactElementModel[]) => void;\n  onMoveToFilter?: (linkDataChunk: LinkDataChunk) => void;\n\n  propertySuggestionCall?: PropertySuggestionHandler;\n}\n\ninterface ConnectionsMenuMarkupState {\n  filterKey?: string;\n  panel?: string;\n  sortMode?: SortMode;\n}\n\nclass ConnectionsMenuMarkup extends React.Component<ConnectionsMenuMarkupProps, ConnectionsMenuMarkupState> {\n  constructor(props: ConnectionsMenuMarkupProps) {\n    super(props);\n    this.state = {\n      filterKey: '',\n      panel: 'connections',\n      sortMode: 'alphabet',\n    };\n  }\n\n  private onChangeFilter = (e: React.FormEvent<HTMLInputElement>) => {\n    const filterKey = e.currentTarget.value;\n    this.setState({ filterKey });\n  };\n\n  private getTitle = () => {\n    if (this.props.objectsData && this.state.panel === 'objects') {\n      return 'Objects';\n    } else if (this.props.connectionsData && this.state.panel === 'connections') {\n      return 'Connections';\n    }\n    return 'Error';\n  };\n\n  private onExpandLink = (linkDataChunk: LinkDataChunk) => {\n    this.setState({ filterKey: '', panel: 'objects' });\n    this.props.onExpandLink(linkDataChunk);\n  };\n\n  private onCollapseLink = () => {\n    this.setState({ filterKey: '', panel: 'connections' });\n  };\n\n  private getBreadCrumbs = () => {\n    if (this.props.objectsData && this.state.panel === 'objects') {\n      const { link, direction } = this.props.objectsData.linkDataChunk;\n      const localizedText = this.props.view.formatLabel(link.label, link.id);\n\n      return (\n        <span className=\"ontodia-connections-menu_bread-crumbs\">\n          <a className=\"ontodia-connections-menu__link\" onClick={this.onCollapseLink}>\n            Connections\n          </a>\n          {'\\u00A0' + '/' + '\\u00A0'}\n          {localizedText} {direction ? `(${direction})` : null}\n        </span>\n      );\n    } else {\n      return null;\n    }\n  };\n\n  private getBody = () => {\n    if (this.props.state === 'error') {\n      return <label className=\"ontodia-label ontodia-connections-menu__error\">Error</label>;\n    } else if (this.props.objectsData && this.state.panel === 'objects') {\n      return (\n        <ObjectsPanel\n          data={this.props.objectsData}\n          onMoveToFilter={this.props.onMoveToFilter}\n          view={this.props.view}\n          filterKey={this.state.filterKey}\n          loading={this.props.state === ProgressState.loading}\n          onPressAddSelected={this.props.onPressAddSelected}\n        />\n      );\n    } else if (this.props.connectionsData && this.state.panel === 'connections') {\n      if (this.props.state === ProgressState.loading) {\n        return <label className=\"ontodia-label ontodia-connections-menu__loading\">Loading...</label>;\n      }\n\n      return (\n        <ConnectionsList\n          id={this.props.target.id}\n          data={this.props.connectionsData}\n          view={this.props.view}\n          filterKey={this.state.filterKey}\n          onExpandLink={this.onExpandLink}\n          onMoveToFilter={this.props.onMoveToFilter}\n          propertySuggestionCall={this.props.propertySuggestionCall}\n          sortMode={this.state.sortMode}\n        />\n      );\n    } else {\n      return <div />;\n    }\n  };\n\n  private onSortChange = (e: React.FormEvent<HTMLInputElement>) => {\n    const value = (e.target as HTMLInputElement).value as SortMode;\n\n    if (this.state.sortMode === value) {\n      return;\n    }\n\n    this.setState({ sortMode: value });\n  };\n\n  private renderSortSwitch = (id: string, icon: string, title: string) => {\n    return (\n      <div>\n        <input\n          type=\"radio\"\n          name=\"sort\"\n          id={id}\n          value={id}\n          className=\"ontodia-connections-menu__sort-switch\"\n          onChange={this.onSortChange}\n          checked={this.state.sortMode === id}\n        />\n        <label htmlFor={id} className=\"ontodia-connections-menu__sort-switch-label\" title={title}>\n          <i className={`fa ${icon}`} />\n        </label>\n      </div>\n    );\n  };\n\n  private renderSortSwitches = () => {\n    if (this.state.panel !== 'connections' || !this.props.propertySuggestionCall) {\n      return null;\n    }\n\n    return (\n      <div className=\"ontodia-connections-menu_search-line-sort-switches\">\n        {this.renderSortSwitch('alphabet', 'fa-sort-alpha-asc', 'Sort alphabetically')}\n        {this.renderSortSwitch('smart', 'fa-lightbulb-o', 'Smart sort')}\n      </div>\n    );\n  };\n\n  render() {\n    return (\n      <div className=\"ontodia-connections-menu\">\n        <label className=\"ontodia-label ontodia-connections-menu__title-label\">{this.getTitle()}</label>\n        {this.getBreadCrumbs()}\n        <div className=\"ontodia-connections-menu_search-line\">\n          <input\n            type=\"text\"\n            className=\"search-input ontodia-form-control ontodia-connections-menu__search-line-input\"\n            value={this.state.filterKey}\n            onChange={this.onChangeFilter}\n            placeholder=\"Search for...\"\n          />\n          {this.renderSortSwitches()}\n        </div>\n        <ProgressBar state={this.props.state} height={10} />\n        {this.getBody()}\n      </div>\n    );\n  }\n}\n\ninterface ConnectionsListProps {\n  id: string;\n  data: {\n    links: FatLinkType[];\n    countMap: { [linkTypeId: string]: ConnectionCount };\n  };\n  view: DiagramView;\n  filterKey: string;\n\n  onExpandLink?: (linkDataChunk: LinkDataChunk) => void;\n  onMoveToFilter?: (linkDataChunk: LinkDataChunk) => void;\n\n  propertySuggestionCall?: PropertySuggestionHandler;\n  sortMode: SortMode;\n}\n\nclass ConnectionsList extends React.Component<ConnectionsListProps, { scores: Dictionary<PropertyScore> }> {\n  constructor(props: ConnectionsListProps) {\n    super(props);\n    this.state = { scores: {} };\n    this.updateScores(props);\n  }\n\n  componentWillReceiveProps(newProps: ConnectionsListProps) {\n    this.updateScores(newProps);\n  }\n\n  private updateScores = (props: ConnectionsListProps) => {\n    if (props.propertySuggestionCall && (props.filterKey || props.sortMode === 'smart')) {\n      const { id, data, view, filterKey } = props;\n      const lang = view.getLanguage();\n      const token = filterKey.trim();\n      const properties = data.links.map((l) => l.id);\n      props\n        .propertySuggestionCall({ elementId: id, token, properties, lang })\n        .then((scores) => this.setState({ scores }));\n    }\n  };\n\n  private isSmartMode(): boolean {\n    return this.props.sortMode === 'smart' && !this.props.filterKey;\n  }\n\n  private compareLinks = (a: FatLinkType, b: FatLinkType) => {\n    const { view } = this.props;\n    const aText = view.formatLabel(a.label, a.id);\n    const bText = view.formatLabel(b.label, b.id);\n    return aText.localeCompare(bText);\n  };\n\n  private compareLinksByWeight = (a: FatLinkType, b: FatLinkType) => {\n    const { view } = this.props;\n    const aText = view.formatLabel(a.label, a.id);\n    const bText = view.formatLabel(b.label, b.id);\n\n    const aWeight = this.state.scores[a.id] ? this.state.scores[a.id].score : 0;\n    const bWeight = this.state.scores[b.id] ? this.state.scores[b.id].score : 0;\n\n    return aWeight > bWeight ? -1 : aWeight < bWeight ? 1 : aText.localeCompare(bText);\n  };\n\n  private getLinks = () => {\n    const { view, data, filterKey } = this.props;\n    return (data.links || [])\n      .filter((link) => {\n        const text = view.formatLabel(link.label, link.id).toLowerCase();\n        return !filterKey || text.indexOf(filterKey.toLowerCase()) >= 0;\n      })\n      .sort(this.compareLinks);\n  };\n\n  private getProbableLinks = () => {\n    const isSmartMode = this.isSmartMode();\n    return (this.props.data.links || [])\n      .filter((link) => {\n        return this.state.scores[link.id] && (this.state.scores[link.id].score > 0 || isSmartMode);\n      })\n      .sort(this.compareLinksByWeight);\n  };\n\n  private getViews = (links: FatLinkType[], notSure?: boolean) => {\n    const { view } = this.props;\n    const countMap = this.props.data.countMap || {};\n\n    const views: JSX.Element[] = [];\n    const addView = (link: FatLinkType, direction: 'in' | 'out') => {\n      const count = direction === 'in' ? countMap[link.id].inCount : countMap[link.id].outCount;\n      if (count === 0) {\n        return;\n      }\n      const postfix = notSure ? '-probable' : '';\n      views.push(\n        <LinkInPopupMenu\n          key={`${direction}-${link.id}-${postfix}`}\n          link={link}\n          onExpandLink={this.props.onExpandLink}\n          view={view}\n          count={count}\n          direction={direction}\n          filterKey={notSure ? '' : this.props.filterKey}\n          onMoveToFilter={this.props.onMoveToFilter}\n          probability={this.state.scores[link.id] && notSure ? this.state.scores[link.id].score : 0}\n        />\n      );\n    };\n\n    for (const link of links) {\n      addView(link, 'in');\n      addView(link, 'out');\n    }\n\n    return views;\n  };\n\n  render() {\n    const { view } = this.props;\n    const isSmartMode = this.isSmartMode();\n\n    const links = isSmartMode ? [] : this.getLinks();\n    const probableLinks = this.getProbableLinks().filter((link) => links.indexOf(link) === -1);\n    const views = this.getViews(links);\n    const probableViews = this.getViews(probableLinks, true);\n\n    let viewList: React.ReactElement<any> | React.ReactElement<any>[];\n    if (views.length === 0 && probableViews.length === 0) {\n      viewList = <label className=\"ontodia-label ontodia-connections-menu_links-list__empty\">List empty</label>;\n    } else {\n      viewList = views;\n      if (views.length > 1 || (isSmartMode && probableViews.length > 1)) {\n        const countMap = this.props.data.countMap || {};\n        const allRelatedElements = countMap[ALL_RELATED_ELEMENTS_LINK.id];\n        viewList = [\n          <LinkInPopupMenu\n            key={ALL_RELATED_ELEMENTS_LINK.id}\n            link={ALL_RELATED_ELEMENTS_LINK}\n            onExpandLink={this.props.onExpandLink}\n            view={view}\n            count={allRelatedElements.inCount + allRelatedElements.outCount}\n            onMoveToFilter={this.props.onMoveToFilter}\n          />,\n          <hr key=\"ontodia-hr-line\" className=\"ontodia-connections-menu_links-list__hr\" />,\n        ].concat(viewList);\n      }\n    }\n    let probablePart = null;\n    if (probableViews.length !== 0) {\n      probablePart = [\n        isSmartMode ? null : (\n          <li key=\"probable-links\">\n            <span className=\"ontodia-label\">Probably, you're looking for..</span>\n          </li>\n        ),\n        probableViews,\n      ];\n    }\n    return (\n      <ul\n        className={\n          'ontodia-connections-menu_links-list ' +\n          (views.length === 0 && probableViews.length === 0 ? 'ocm_links-list-empty' : '')\n        }\n      >\n        {viewList}\n        {probablePart}\n      </ul>\n    );\n  }\n}\n\ninterface LinkInPopupMenuProps {\n  link: FatLinkType;\n  count: number;\n  direction?: 'in' | 'out';\n  view: DiagramView;\n  filterKey?: string;\n  onExpandLink?: (linkDataChunk: LinkDataChunk) => void;\n  onMoveToFilter?: (linkDataChunk: LinkDataChunk) => void;\n  probability?: number;\n}\n\nclass LinkInPopupMenu extends React.Component<LinkInPopupMenuProps, {}> {\n  constructor(props: LinkInPopupMenuProps) {\n    super(props);\n  }\n\n  private onExpandLink = (expectedCount: number, direction?: 'in' | 'out') => {\n    this.props.onExpandLink({\n      link: this.props.link,\n      direction,\n      expectedCount,\n    });\n  };\n\n  private onMoveToFilter = (evt: React.MouseEvent<any>) => {\n    evt.stopPropagation();\n    this.props.onMoveToFilter({\n      link: this.props.link,\n      direction: this.props.direction,\n      expectedCount: this.props.count,\n    });\n  };\n\n  render() {\n    const { view, link } = this.props;\n    const fullText = view.formatLabel(link.label, link.id);\n    const probability = Math.round(this.props.probability * 100);\n    const textLine = highlightSubstring(\n      fullText + (probability > 0 ? ' (' + probability + '%)' : ''),\n      this.props.filterKey\n    );\n    const directionName =\n      this.props.direction === 'in' ? 'source' : this.props.direction === 'out' ? 'target' : 'all connected';\n\n    return (\n      <li\n        data-linktypeid={this.props.link.id}\n        className=\"link-in-popup-menu\"\n        title={`${directionName} of \"${fullText}\" ${view.formatIri(link.id)}`}\n        onClick={() => this.onExpandLink(this.props.count, this.props.direction)}\n      >\n        {this.props.direction === 'in' || this.props.direction === 'out' ? (\n          <div className=\"link-in-popup-menu_direction\">\n            {this.props.direction === 'in' && <div className=\"link-in-popup-menu_direction__in-direction\" />}\n            {this.props.direction === 'out' && <div className=\"link-in-popup-menu_direction__out-direction\" />}\n          </div>\n        ) : null}\n        <div className=\"link-in-popup-menu__link-title\">{textLine}</div>\n        <span className=\"ontodia-badge link-in-popup-menu__count\">\n          {this.props.count <= MAX_LINK_COUNT ? this.props.count : '100+'}\n        </span>\n        <div\n          className=\"link-in-popup-menu__filter-button\"\n          onClick={this.onMoveToFilter}\n          title=\"Set as filter in the Instances panel\"\n        />\n        <div\n          className=\"link-in-popup-menu__navigate-button\"\n          title={`Navigate to ${directionName} \"${fullText}\" elements`}\n        />\n      </li>\n    );\n  }\n}\n\ninterface ObjectsPanelProps {\n  data: ObjectsData;\n  loading?: boolean;\n  view: DiagramView;\n  filterKey?: string;\n  onPressAddSelected?: (selectedObjects: ReactElementModel[]) => void;\n  onMoveToFilter?: (linkDataChunk: LinkDataChunk) => void;\n}\n\ninterface ObjectsPanelState {\n  selection: ReadonlySet<ElementIri>;\n}\n\nclass ObjectsPanel extends React.Component<ObjectsPanelProps, ObjectsPanelState> {\n  constructor(props: ObjectsPanelProps) {\n    super(props);\n    this.state = { selection: new Set<ElementIri>() };\n  }\n\n  componentWillReceiveProps(nextProps: ObjectsPanelProps) {\n    if (this.props.data.objects.length < nextProps.data.objects.length) {\n      this.setState({ selection: new Set<ElementIri>() });\n    }\n  }\n\n  private onSelectAll = () => {\n    const objects = this.props.data.objects;\n    if (objects.length === 0) {\n      return;\n    }\n    const allSelected = allNonPresentedAreSelected(objects, this.state.selection);\n    const newSelection = allSelected ? new Set<ElementIri>() : selectNonPresented(this.props.data.objects);\n    this.updateSelection(newSelection);\n  };\n\n  private getFilteredObjects(): ReactElementModel[] {\n    if (!this.props.filterKey) {\n      return this.props.data.objects;\n    }\n    const filterKey = this.props.filterKey.toLowerCase();\n    return this.props.data.objects.filter((element) => {\n      const text = this.props.view.formatLabel(element.model.label.values, element.model.id).toLowerCase();\n      return text && text.indexOf(filterKey) >= 0;\n    });\n  }\n\n  private getItems(list: ReadonlyArray<ReactElementModel>) {\n    const added: { [id: string]: true } = {};\n    const result: ElementModel[] = [];\n    for (const obj of list) {\n      if (added[obj.model.id]) {\n        continue;\n      }\n      added[obj.model.id] = true;\n      result.push(obj.model);\n    }\n    return result;\n  }\n\n  private updateSelection = (newSelection: ReadonlySet<ElementIri>) => {\n    this.setState({ selection: newSelection });\n  };\n\n  private counter = (activeObjCount: number) => {\n    const countString = `${activeObjCount}\\u00A0of\\u00A0${this.props.data.objects.length}`;\n\n    const wrongNodes =\n      Math.min(MAX_LINK_COUNT, this.props.data.linkDataChunk.expectedCount) - this.props.data.objects.length;\n    const wrongNodesString =\n      Math.abs(wrongNodes) > MAX_LINK_COUNT ? `${MAX_LINK_COUNT}+` : Math.abs(wrongNodes).toString();\n    const wrongNodesCount =\n      wrongNodes === 0 ? '' : wrongNodes < 0 ? `\\u00A0(${wrongNodesString})` : `\\u00A0(${wrongNodesString})`;\n    const wrongNodesTitle = wrongNodes === 0 ? '' : wrongNodes > 0 ? 'Unavailable nodes' : 'Extra nodes';\n\n    return (\n      <div className=\"ontodia-label ontodia-connections-menu_objects-panel_bottom-panel__count-label\">\n        <span>{countString}</span>\n        <span className=\"ontodia-connections-menu_objects-panel_bottom-panel__extra-elements\" title={wrongNodesTitle}>\n          {wrongNodesCount}\n        </span>\n      </div>\n    );\n  };\n\n  render() {\n    const { onPressAddSelected, filterKey } = this.props;\n    const { selection } = this.state;\n    const objects = this.getFilteredObjects();\n    const isAllSelected = allNonPresentedAreSelected(objects, selection);\n\n    const nonPresented = objects.filter((el) => !el.presentOnDiagram);\n    const active = nonPresented.filter((el) => selection.has(el.model.id));\n\n    return (\n      <div className=\"ontodia-connections-menu_objects-panel\">\n        <div className=\"ontodia-connections-menu_objects-panel__select-all\">\n          <label>\n            <input\n              type=\"checkbox\"\n              checked={isAllSelected && nonPresented.length > 0}\n              onChange={this.onSelectAll}\n              disabled={nonPresented.length === 0}\n            />\n            <span>Select All</span>\n          </label>\n        </div>\n        {this.props.loading ? (\n          <label className=\"ontodia-label ontodia-connections-menu__loading-objects\">Loading...</label>\n        ) : objects.length === 0 ? (\n          <label className=\"ontodia-label ontodia-connections-menu__loading-objects\">No available nodes</label>\n        ) : (\n          <div className=\"ontodia-connections-menu_objects-panel_objects-list\">\n            <SearchResults\n              view={this.props.view}\n              items={this.getItems(objects)}\n              selection={this.state.selection}\n              onSelectionChanged={this.updateSelection}\n              highlightText={filterKey}\n            />\n            {this.props.data.linkDataChunk.expectedCount > MAX_LINK_COUNT ? (\n              <div\n                className=\"ontodia-connections-menu__move-to-filter\"\n                onClick={() => this.props.onMoveToFilter(this.props.data.linkDataChunk)}\n              >\n                The list was truncated, for more data click here to use the filter panel\n              </div>\n            ) : null}\n          </div>\n        )}\n        <div className=\"ontodia-connections-menu_objects-panel_bottom-panel\">\n          {this.counter(active.length)}\n          <button\n            className={\n              'ontodia-btn ontodia-btn-primary pull-right ' +\n              'ontodia-connections-menu_objects-panel_bottom-panel__add-button'\n            }\n            disabled={this.props.loading || nonPresented.length === 0}\n            onClick={() => onPressAddSelected(active.length > 0 ? active : nonPresented)}\n          >\n            {active.length > 0 ? 'Add selected' : 'Add all'}\n          </button>\n        </div>\n      </div>\n    );\n  }\n}\n\nfunction selectNonPresented(objects: ReadonlyArray<ReactElementModel>) {\n  const selection = new Set<ElementIri>();\n  for (const object of objects) {\n    if (object.presentOnDiagram) {\n      continue;\n    }\n    selection.add(object.model.id);\n  }\n  return selection;\n}\n\nfunction allNonPresentedAreSelected(\n  objects: ReadonlyArray<ReactElementModel>,\n  selection: ReadonlySet<ElementIri>\n): boolean {\n  let allSelected = true;\n  for (const object of objects) {\n    if (object.presentOnDiagram) {\n      continue;\n    }\n    allSelected = allSelected && selection.has(object.model.id);\n  }\n  return allSelected;\n}\n","import * as React from 'react';\n\nimport { ElementModel, ElementIri, Dictionary } from '../data/model';\nimport { FilterParams } from '../data/provider';\n\nimport { Element as DiagramElement, FatLinkType, FatClassModel } from '../diagram/elements';\nimport { DiagramView } from '../diagram/view';\n\nimport { AsyncModel } from '../editor/asyncModel';\nimport { EventObserver } from '../viewUtils/events';\nimport { ProgressBar, ProgressState } from '../widgets/progressBar';\nimport { SearchResults } from './searchResults';\n\nimport { WorkspaceContextTypes, WorkspaceContextWrapper, WorkspaceEventKey } from '../workspace/workspaceContext';\n\nconst DirectionInImage = require('../../../images/direction-in.png');\nconst DirectionOutImage = require('../../../images/direction-out.png');\n\nexport interface InstancesSearchProps {\n  className?: string;\n  model: AsyncModel;\n  view: DiagramView;\n  criteria: SearchCriteria;\n  onCriteriaChanged: (criteria: SearchCriteria) => void;\n}\n\nexport interface SearchCriteria {\n  readonly text?: string;\n  readonly elementType?: FatClassModel;\n  readonly refElement?: DiagramElement;\n  readonly refElementLink?: FatLinkType;\n  readonly linkDirection?: 'in' | 'out';\n}\n\nexport interface State {\n  readonly inputText?: string;\n  readonly quering?: boolean;\n  readonly resultId?: number;\n  readonly error?: any;\n  readonly items?: ReadonlyArray<ElementModel>;\n  readonly selection?: ReadonlySet<ElementIri>;\n  readonly moreItemsAvailable?: boolean;\n}\n\nconst CLASS_NAME = 'ontodia-instances-search';\n\nexport class InstancesSearch extends React.Component<InstancesSearchProps, State> {\n  static contextTypes = WorkspaceContextTypes;\n  readonly context: WorkspaceContextWrapper;\n\n  private readonly listener = new EventObserver();\n\n  private currentRequest: FilterParams;\n\n  constructor(props: InstancesSearchProps, context: any) {\n    super(props, context);\n    this.state = {\n      resultId: 0,\n      selection: new Set<ElementIri>(),\n    };\n  }\n\n  render() {\n    const ENTER_KEY_CODE = 13;\n\n    const className = `${CLASS_NAME} ${this.props.className || ''}`;\n    const progressState = this.state.quering\n      ? ProgressState.loading\n      : this.state.error\n      ? ProgressState.error\n      : this.state.items\n      ? ProgressState.completed\n      : ProgressState.none;\n\n    const searchTerm = this.state.inputText === undefined ? this.props.criteria.text : this.state.inputText;\n\n    return (\n      <div className={className}>\n        <ProgressBar state={progressState} />\n        <div className={`${CLASS_NAME}__criteria`}>\n          {this.renderCriteria()}\n          <div className={`${CLASS_NAME}__text-criteria ontodia-input-group`}>\n            <input\n              type=\"text\"\n              className=\"ontodia-form-control\"\n              placeholder=\"Search for...\"\n              value={searchTerm || ''}\n              onChange={(e) => this.setState({ inputText: e.currentTarget.value })}\n              onKeyUp={(e) => {\n                if (e.keyCode === ENTER_KEY_CODE) {\n                  this.submitCriteriaUpdate();\n                }\n              }}\n            />\n            <span className=\"ontodia-input-group-btn\">\n              <button\n                className=\"ontodia-btn ontodia-btn-default\"\n                type=\"button\"\n                title=\"Search\"\n                onClick={() => this.submitCriteriaUpdate()}\n              >\n                <span className=\"fa fa-search\" aria-hidden=\"true\" />\n              </button>\n            </span>\n          </div>\n        </div>\n        {/* specify resultId as key to reset scroll position when loaded new search results */}\n        <div className={`${CLASS_NAME}__rest ontodia-scrollable`} key={this.state.resultId}>\n          <SearchResults\n            view={this.props.view}\n            items={this.state.items}\n            highlightText={this.props.criteria.text}\n            selection={this.state.selection}\n            onSelectionChanged={this.onSelectionChanged}\n          />\n          <div className={`${CLASS_NAME}__rest-end`}>\n            <button\n              type=\"button\"\n              className={`${CLASS_NAME}__load-more ontodia-btn ontodia-btn-primary`}\n              disabled={this.state.quering}\n              style={{ display: this.state.moreItemsAvailable ? undefined : 'none' }}\n              onClick={() => this.queryItems(true)}\n            >\n              <span className=\"fa fa-chevron-down\" aria-hidden=\"true\" />\n              &nbsp;Show more\n            </button>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  private onSelectionChanged = (newSelection: ReadonlySet<ElementIri>) => {\n    this.setState({ selection: newSelection });\n  };\n\n  private renderCriteria(): React.ReactElement<any> {\n    const { criteria = {}, view } = this.props;\n    const criterions: React.ReactElement<any>[] = [];\n\n    if (criteria.elementType) {\n      const classInfo = criteria.elementType;\n      const classLabel = view.formatLabel(classInfo.label, classInfo.id);\n      criterions.push(\n        <div key=\"hasType\" className={`${CLASS_NAME}__criterion`}>\n          {this.renderRemoveCriterionButtons(() =>\n            this.props.onCriteriaChanged({ ...this.props.criteria, elementType: undefined })\n          )}\n          Has type{' '}\n          <span className={`${CLASS_NAME}__criterion-class`} title={classInfo.id}>\n            {classLabel}\n          </span>\n        </div>\n      );\n    } else if (criteria.refElement) {\n      const element = criteria.refElement;\n      const elementLabel = view.formatLabel(element.data.label.values, element.iri);\n\n      const linkType = criteria.refElementLink;\n      const linkTypeLabel = linkType ? view.formatLabel(linkType.label, linkType.id) : undefined;\n\n      criterions.push(\n        <div key=\"hasLinkedElement\" className={`${CLASS_NAME}__criterion`}>\n          {this.renderRemoveCriterionButtons(() =>\n            this.props.onCriteriaChanged({ ...this.props.criteria, refElement: undefined, refElementLink: undefined })\n          )}\n          Connected to{' '}\n          <span className={`${CLASS_NAME}__criterion-element`} title={element ? element.iri : undefined}>\n            {elementLabel}\n          </span>\n          {linkType && (\n            <span>\n              {' through '}\n              <span className={`${CLASS_NAME}__criterion-link-type`} title={linkType ? linkType.id : undefined}>\n                {linkTypeLabel}\n              </span>\n              {criteria.linkDirection === 'in' && (\n                <span>\n                  {' as '}\n                  <img className={`${CLASS_NAME}__link-direction`} src={DirectionInImage} />\n                  &nbsp;source\n                </span>\n              )}\n              {criteria.linkDirection === 'out' && (\n                <span>\n                  {' as '}\n                  <img className={`${CLASS_NAME}__link-direction`} src={DirectionOutImage} />\n                  &nbsp;target\n                </span>\n              )}\n            </span>\n          )}\n        </div>\n      );\n    }\n\n    return <div className={`${CLASS_NAME}__criterions`}>{criterions}</div>;\n  }\n\n  private renderRemoveCriterionButtons(onClick: () => void) {\n    return (\n      <div className={`${CLASS_NAME}__criterion-remove ontodia-btn-group ontodia-btn-group-xs`}>\n        <button type=\"button\" className=\"ontodia-btn ontodia-btn-default\" title=\"Remove criteria\" onClick={onClick}>\n          <span className=\"fa fa-times\" aria-hidden=\"true\"></span>\n        </button>\n      </div>\n    );\n  }\n\n  private submitCriteriaUpdate() {\n    let text = this.state.inputText === undefined ? this.props.criteria.text : this.state.inputText;\n    text = text === '' ? undefined : text;\n    this.props.onCriteriaChanged({ ...this.props.criteria, text });\n  }\n\n  componentDidMount() {\n    this.listener.listen(this.props.view.events, 'changeLanguage', () => this.forceUpdate());\n    this.queryItems(false);\n  }\n\n  componentWillReceiveProps(nextProps: InstancesSearchProps) {\n    const languageChanged = this.currentRequest\n      ? this.currentRequest.languageCode !== nextProps.view.getLanguage()\n      : false;\n\n    if (this.props.criteria !== nextProps.criteria || languageChanged) {\n      this.setState({ inputText: undefined }, () => this.queryItems(false));\n    }\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n    this.currentRequest = undefined;\n  }\n\n  private queryItems(loadMoreItems: boolean) {\n    let request: FilterParams;\n    if (loadMoreItems) {\n      if (!this.currentRequest) {\n        throw new Error('Cannot request more items without initial request.');\n      }\n      const { offset, limit } = this.currentRequest;\n      request = { ...this.currentRequest, offset: offset + limit };\n    } else {\n      request = createRequest(this.props.criteria, this.props.view.getLanguage());\n    }\n\n    if (!(request.text || request.elementTypeId || request.refElementId || request.refElementLinkId)) {\n      this.setState({\n        quering: false,\n        error: undefined,\n        items: undefined,\n        selection: new Set<ElementIri>(),\n        moreItemsAvailable: false,\n      });\n      return;\n    }\n\n    this.currentRequest = request;\n    this.setState({\n      quering: true,\n      error: undefined,\n      moreItemsAvailable: false,\n    });\n\n    this.props.model.dataProvider\n      .filter(request)\n      .then((elements) => {\n        if (this.currentRequest !== request) {\n          return;\n        }\n        this.processFilterData(elements);\n        this.context.ontodiaWorkspace.triggerWorkspaceEvent(WorkspaceEventKey.searchQueryItem);\n      })\n      .catch((error) => {\n        if (this.currentRequest !== request) {\n          return;\n        }\n        // tslint:disable-next-line:no-console\n        console.error(error);\n        this.setState({ quering: false, error });\n      });\n  }\n\n  private processFilterData(elements: Dictionary<ElementModel>) {\n    const requestedAdditionalItems = this.currentRequest.offset > 0;\n\n    const existingIris: { [iri: string]: true } = {};\n\n    if (requestedAdditionalItems) {\n      this.state.items.forEach((item) => (existingIris[item.id] = true));\n    }\n\n    const items = requestedAdditionalItems ? [...this.state.items] : [];\n    for (const iri in elements) {\n      if (!elements.hasOwnProperty(iri)) {\n        continue;\n      }\n      if (existingIris[iri]) {\n        continue;\n      }\n      items.push(elements[iri]);\n    }\n\n    const moreItemsAvailable = Object.keys(elements).length >= this.currentRequest.limit;\n\n    if (requestedAdditionalItems) {\n      this.setState({ quering: false, items, error: undefined, moreItemsAvailable });\n    } else {\n      this.setState({\n        quering: false,\n        resultId: this.state.resultId + 1,\n        items,\n        selection: new Set<ElementIri>(),\n        error: undefined,\n        moreItemsAvailable,\n      });\n    }\n  }\n}\n\nexport function createRequest(criteria: SearchCriteria, language: string): FilterParams {\n  const { text, elementType, refElement, refElementLink, linkDirection } = criteria;\n  return {\n    text,\n    elementTypeId: elementType ? elementType.id : undefined,\n    refElementId: refElement ? refElement.iri : undefined,\n    refElementLinkId: refElementLink ? refElementLink.id : undefined,\n    linkDirection,\n    offset: 0,\n    limit: 100,\n    languageCode: language || 'en',\n  };\n}\n","import * as React from 'react';\n\nimport { MetadataApi } from '../data/metadataApi';\nimport { LinkModel, ElementModel, sameLink } from '../data/model';\nimport { PLACEHOLDER_LINK_TYPE } from '../data/schema';\n\nimport { EditorController } from '../editor/editorController';\nimport { FatLinkType, LinkDirection } from '../diagram/elements';\nimport { DiagramView } from '../diagram/view';\nimport { EventObserver } from '../viewUtils/events';\nimport { Cancellation, CancellationToken } from '../viewUtils/async';\nimport { HtmlSpinner } from '../viewUtils/spinner';\n\nconst CLASS_NAME = 'ontodia-edit-form';\n\nexport interface Value {\n  link: LinkModel;\n  direction: LinkDirection;\n}\n\nexport interface LinkValue {\n  value: Value;\n  error?: string;\n  validated: boolean;\n  allowChange: boolean;\n}\n\ninterface DirectedFatLinkType {\n  fatLinkType: FatLinkType;\n  direction: LinkDirection;\n}\n\nexport interface Props {\n  editor: EditorController;\n  view: DiagramView;\n  metadataApi: MetadataApi | undefined;\n  linkValue: LinkValue;\n  source: ElementModel;\n  target: ElementModel;\n  onChange: (value: Value) => void;\n  disabled?: boolean;\n}\n\nexport interface State {\n  fatLinkTypes?: Array<DirectedFatLinkType>;\n}\n\nexport class LinkTypeSelector extends React.Component<Props, State> {\n  private readonly listener = new EventObserver();\n  private readonly cancellation = new Cancellation();\n\n  constructor(props: Props) {\n    super(props);\n    this.state = {\n      fatLinkTypes: [],\n    };\n  }\n\n  private updateAll = () => this.forceUpdate();\n\n  componentDidMount() {\n    this.fetchPossibleLinkTypes();\n  }\n\n  componentDidUpdate(prevProps: Props) {\n    const { source, target } = this.props;\n    if (prevProps.source !== source || prevProps.target !== target) {\n      this.setState({ fatLinkTypes: undefined });\n      this.fetchPossibleLinkTypes();\n    }\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n    this.cancellation.abort();\n  }\n\n  private async fetchPossibleLinkTypes() {\n    const { view, metadataApi, source, target } = this.props;\n    if (!metadataApi) {\n      return;\n    }\n    const linkTypes = await CancellationToken.mapCancelledToNull(\n      this.cancellation.signal,\n      metadataApi.possibleLinkTypes(source, target, this.cancellation.signal)\n    );\n    if (linkTypes === null) {\n      return;\n    }\n    const fatLinkTypes: Array<DirectedFatLinkType> = [];\n    linkTypes.forEach(({ linkTypeIri, direction }) => {\n      const fatLinkType = view.model.createLinkType(linkTypeIri);\n      fatLinkTypes.push({ fatLinkType, direction });\n    });\n    fatLinkTypes.sort(makeLinkTypeComparatorByLabelAndDirection(view));\n    this.setState({ fatLinkTypes });\n    this.listenToLinkLabels(fatLinkTypes);\n  }\n\n  private listenToLinkLabels(fatLinkTypes: Array<{ fatLinkType: FatLinkType; direction: LinkDirection }>) {\n    fatLinkTypes.forEach(({ fatLinkType }) => this.listener.listen(fatLinkType.events, 'changeLabel', this.updateAll));\n  }\n\n  private onChangeType = (e: React.FormEvent<HTMLSelectElement>) => {\n    const { link: originalLink, direction: originalDirection } = this.props.linkValue.value;\n    const index = parseInt(e.currentTarget.value, 10);\n    const { fatLinkType, direction } = this.state.fatLinkTypes[index];\n    const link: LinkModel = { ...originalLink, linkTypeId: fatLinkType.id };\n    // switches source and target if the direction has changed\n    if (originalDirection !== direction) {\n      link.sourceId = originalLink.targetId;\n      link.targetId = originalLink.sourceId;\n    }\n    this.props.onChange({ link, direction });\n  };\n\n  private renderPossibleLinkType = (\n    { fatLinkType, direction }: { fatLinkType: FatLinkType; direction: LinkDirection },\n    index: number\n  ) => {\n    const { view, linkValue, source, target } = this.props;\n    const label = view.formatLabel(fatLinkType.label, fatLinkType.id);\n    let [sourceLabel, targetLabel] = [source, target].map((element) =>\n      view.formatLabel(element.label.values, element.id)\n    );\n    if (direction === LinkDirection.in) {\n      [sourceLabel, targetLabel] = [targetLabel, sourceLabel];\n    }\n    return (\n      <option key={index} value={index}>\n        {label} [{sourceLabel} &rarr; {targetLabel}]\n      </option>\n    );\n  };\n\n  render() {\n    const { linkValue, disabled } = this.props;\n    const { fatLinkTypes } = this.state;\n    const value = (fatLinkTypes || []).findIndex(\n      ({ fatLinkType, direction }) =>\n        fatLinkType.id === linkValue.value.link.linkTypeId && direction === linkValue.value.direction\n    );\n    return (\n      <div className={`${CLASS_NAME}__control-row`}>\n        <label>Link Type</label>\n        {fatLinkTypes ? (\n          <select className=\"ontodia-form-control\" value={value} onChange={this.onChangeType} disabled={disabled}>\n            <option value={-1} disabled={true}>\n              Select link type\n            </option>\n            {fatLinkTypes.map(this.renderPossibleLinkType)}\n          </select>\n        ) : (\n          <div>\n            <HtmlSpinner width={20} height={20} />\n          </div>\n        )}\n        {linkValue.error ? <span className={`${CLASS_NAME}__control-error`}>{linkValue.error}</span> : ''}\n      </div>\n    );\n  }\n}\n\nfunction makeLinkTypeComparatorByLabelAndDirection(view: DiagramView) {\n  return (a: DirectedFatLinkType, b: DirectedFatLinkType) => {\n    const labelA = view.formatLabel(a.fatLinkType.label, a.fatLinkType.id);\n    const labelB = view.formatLabel(b.fatLinkType.label, b.fatLinkType.id);\n    const labelCompareResult = labelA.localeCompare(labelB);\n    if (labelCompareResult !== 0) {\n      return labelCompareResult;\n    }\n    if (a.direction === LinkDirection.out && b.direction === LinkDirection.in) {\n      return -1;\n    }\n    if (a.direction === LinkDirection.in && b.direction === LinkDirection.out) {\n      return 1;\n    }\n    return 0;\n  };\n}\n\nexport function validateLinkType(\n  editor: EditorController,\n  currentLink: LinkModel,\n  originalLink: LinkModel\n): Promise<Pick<LinkValue, 'error' | 'allowChange'>> {\n  if (currentLink.linkTypeId === PLACEHOLDER_LINK_TYPE) {\n    return Promise.resolve({ error: 'Required.', allowChange: true });\n  }\n  if (sameLink(currentLink, originalLink)) {\n    return Promise.resolve({ error: undefined, allowChange: true });\n  }\n  const alreadyOnDiagram = editor.model.links.find(\n    ({ data: { linkTypeId, sourceId, targetId } }) =>\n      linkTypeId === currentLink.linkTypeId &&\n      sourceId === currentLink.sourceId &&\n      targetId === currentLink.targetId &&\n      !editor.temporaryState.links.has(currentLink)\n  );\n  if (alreadyOnDiagram) {\n    return Promise.resolve({ error: 'The link already exists.', allowChange: false });\n  }\n  return editor.model.dataProvider\n    .linksInfo({\n      elementIds: [currentLink.sourceId, currentLink.targetId],\n      linkTypeIds: [currentLink.linkTypeId],\n    })\n    .then(\n      (links): Pick<LinkValue, 'error' | 'allowChange'> => {\n        const alreadyExists = links.some((link) => sameLink(link, currentLink));\n        return alreadyExists\n          ? { error: 'The link already exists.', allowChange: false }\n          : { error: undefined, allowChange: true };\n      }\n    );\n}\n","import { isEmpty } from 'lodash';\n\nimport { ElementIri, LinkModel, hashLink, sameLink } from '../data/model';\nimport { ValidationApi, ValidationEvent, ElementError, LinkError } from '../data/validationApi';\nimport { CancellationToken } from '../viewUtils/async';\nimport { HashMap, ReadonlyHashMap, cloneMap } from '../viewUtils/collections';\nimport { AuthoringState } from './authoringState';\nimport { EditorController } from './editorController';\n\nexport interface ValidationState {\n  readonly elements: ReadonlyMap<ElementIri, ElementValidation>;\n  readonly links: ReadonlyHashMap<LinkModel, LinkValidation>;\n  readonly isValid: boolean;\n}\n\ninterface MutableValidationState {\n  elements: Map<ElementIri, ElementValidation>;\n  links: HashMap<LinkModel, LinkValidation>;\n  isValid: boolean;\n}\n\nexport interface ElementValidation {\n  readonly loading: boolean;\n  readonly errors: ReadonlyArray<ElementError>;\n}\n\nexport interface LinkValidation {\n  readonly loading: boolean;\n  readonly errors: ReadonlyArray<LinkError>;\n}\n\nexport namespace ValidationState {\n  export const empty: ValidationState = createMutable();\n  export const emptyElement: ElementValidation = { loading: false, errors: [] };\n  export const emptyLink: LinkValidation = { loading: false, errors: [] };\n\n  export function createMutable(): MutableValidationState {\n    return {\n      elements: new Map<ElementIri, ElementValidation>(),\n      links: new HashMap<LinkModel, LinkValidation>(hashLink, sameLink),\n      isValid: true,\n    };\n  }\n}\n\nexport function changedElementsToValidate(previousAuthoring: AuthoringState, editor: EditorController) {\n  const currentAuthoring = editor.authoringState;\n\n  const links = new HashMap<LinkModel, true>(hashLink, sameLink);\n  previousAuthoring.links.forEach((e, model) => links.set(model, true));\n  currentAuthoring.links.forEach((e, model) => links.set(model, true));\n\n  const toValidate = new Set<ElementIri>();\n  links.forEach((value, linkModel) => {\n    const current = currentAuthoring.links.get(linkModel);\n    const previous = previousAuthoring.links.get(linkModel);\n    if (current !== previous) {\n      toValidate.add(linkModel.sourceId);\n    }\n  });\n\n  for (const element of editor.model.elements) {\n    const current = currentAuthoring.elements.get(element.iri);\n    const previous = previousAuthoring.elements.get(element.iri);\n    if (current !== previous) {\n      toValidate.add(element.iri);\n\n      // when we remove element incoming link are removed as well so we should update their sources\n      if ((current || previous).deleted) {\n        for (const link of element.links) {\n          if (link.data.sourceId !== element.iri) {\n            toValidate.add(link.data.sourceId);\n          }\n        }\n      }\n    }\n  }\n\n  return toValidate;\n}\n\nexport async function validateElements(\n  targets: ReadonlySet<ElementIri>,\n  validationApi: ValidationApi,\n  editor: EditorController,\n  cancellationToken: CancellationToken\n) {\n  const previousState = editor.validationState;\n  let newState = ValidationState.createMutable();\n\n  for (const element of editor.model.elements) {\n    if (newState.elements.has(element.iri)) {\n      continue;\n    }\n\n    const outboundLinks = element.links.reduce((acc: LinkModel[], link) => {\n      if (link.sourceId === element.id) {\n        acc.push(link.data);\n      }\n      return acc;\n    }, []);\n\n    if (targets.has(element.iri)) {\n      const event: ValidationEvent = {\n        target: element.data,\n        outboundLinks,\n        state: editor.authoringState,\n        model: editor.model,\n        cancellation: cancellationToken,\n      };\n      const result = CancellationToken.mapCancelledToNull(cancellationToken, validationApi.validate(event));\n\n      const loadingElement: ElementValidation = { loading: true, errors: [] };\n      const loadingLink: LinkValidation = { loading: true, errors: [] };\n      newState.elements.set(element.iri, loadingElement);\n      outboundLinks.forEach((link) => newState.links.set(link, loadingLink));\n\n      newState = await processValidationResult(result, loadingElement, loadingLink, event, newState);\n    } else {\n      // use previous state for element and outbound links\n      const previousElementState = previousState.elements.get(element.iri);\n      newState.elements.set(element.iri, previousElementState);\n      newState.isValid =\n        newState.isValid && isEmpty(previousElementState?.errors)\n      for (const link of outboundLinks) {\n        const previousLinkState = previousState.links.get(link);\n        newState.isValid =\n          newState.isValid && isEmpty(previousLinkState?.errors)\n        newState.links.set(link, previousLinkState);\n      }\n    }\n  }\n\n  editor.setValidationState(newState);\n}\n\nasync function processValidationResult(\n  result: Promise<Array<ElementError | LinkError> | null>,\n  previousElement: ElementValidation,\n  previousLink: LinkValidation,\n  e: ValidationEvent,\n  state: MutableValidationState\n): Promise<MutableValidationState> {\n  let allErrors: Array<ElementError | LinkError> | null;\n  try {\n    allErrors = await result;\n    if (allErrors === null) {\n      // validation was cancelled\n      return;\n    }\n  } catch (err) {\n    // tslint:disable-next-line:no-console\n    console.error(`Failed to validate element`, e.target, err);\n    allErrors = [{ type: 'element', target: e.target.id, message: `Failed to validate element` }];\n  }\n\n  const elementErrors: ElementError[] = [];\n  const linkErrors = new HashMap<LinkModel, LinkError[]>(hashLink, sameLink);\n  e.outboundLinks.forEach((link) => linkErrors.set(link, []));\n\n  for (const error of allErrors) {\n    if (error.type === 'element' && error.target === e.target.id) {\n      elementErrors.push(error);\n    } else if (error.type === 'link' && linkErrors.has(error.target)) {\n      linkErrors.get(error.target).push(error);\n    }\n  }\n\n  if (state.elements.get(e.target.id) === previousElement) {\n    if (elementErrors.length > 0) {\n      state.elements.set(e.target.id, { loading: false, errors: elementErrors });\n    } else {\n      state.elements.delete(e.target.id);\n    }\n  }\n  linkErrors.forEach((errors, link) => {\n    if (state.links.get(link) === previousLink) {\n      if (errors.length > 0) {\n        state.links.set(link, { loading: false, errors });\n      } else {\n        state.links.delete(link);\n      }\n    }\n  });\n  state.isValid = state.isValid && isEmpty(allErrors);\n\n  return state;\n}\n","import * as React from 'react';\n\nimport { WorkspaceLanguage } from './workspace';\n\nexport interface ToolbarProps {\n  canSaveDiagram?: boolean;\n  onSaveDiagram?: () => void;\n  canPersistChanges?: boolean;\n  hasUnpersistedChanges?: boolean;\n  onPersistChanges?: () => void;\n  onForceLayout?: () => void;\n  onClearAll?: () => void;\n  onZoomIn?: () => void;\n  onZoomOut?: () => void;\n  onZoomToFit?: () => void;\n  onExportSVG?: (fileName?: string) => void;\n  onExportPNG?: (fileName?: string) => void;\n  onPrint?: () => void;\n  languages?: ReadonlyArray<WorkspaceLanguage>;\n  selectedLanguage?: string;\n  onChangeLanguage?: (language: string) => void;\n  hidePanels?: boolean;\n}\n\nconst CLASS_NAME = 'ontodia-toolbar';\n\nexport class DefaultToolbar extends React.Component<ToolbarProps, {}> {\n  private onChangeLanguage = (event: React.SyntheticEvent<HTMLSelectElement>) => {\n    const value = event.currentTarget.value;\n    this.props.onChangeLanguage(value);\n  };\n\n  private onExportSVG = () => {\n    this.props.onExportSVG();\n  };\n\n  private onExportPNG = () => {\n    this.props.onExportPNG();\n  };\n\n  private renderSaveDiagramButton() {\n    if (!this.props.onSaveDiagram) {\n      return null;\n    }\n    return (\n      <button\n        type=\"button\"\n        className=\"saveDiagramButton ontodia-btn ontodia-btn-primary\"\n        disabled={this.props.canSaveDiagram === false}\n        onClick={this.props.onSaveDiagram}\n      >\n        <span className=\"fa fa-floppy-o\" aria-hidden=\"true\" /> Save diagram\n      </button>\n    );\n  }\n\n  private renderPersistAuthoredChangesButton() {\n    if (!this.props.onPersistChanges) {\n      return null;\n    }\n    return (\n      <button\n        type=\"button\"\n        className=\"saveDiagramButton ontodia-btn ontodia-btn-success\"\n        disabled={this.props.canPersistChanges === false}\n        onClick={this.props.onPersistChanges}\n      >\n        <span className=\"fa fa-floppy-o\" aria-hidden=\"true\" /> Save data\n      </button>\n    );\n  }\n\n  private renderLanguages() {\n    const { selectedLanguage, languages } = this.props;\n    if (languages.length <= 1) {\n      return null;\n    }\n\n    return (\n      <span className={`ontodia-btn-group ${CLASS_NAME}__language-selector`}>\n        <label className=\"ontodia-label\">\n          <span>Data Language - </span>\n        </label>\n        <select value={selectedLanguage} onChange={this.onChangeLanguage}>\n          {languages.map(({ code, label }) => (\n            <option key={code} value={code}>\n              {label}\n            </option>\n          ))}\n        </select>\n      </span>\n    );\n  }\n\n  render() {\n    return (\n      <div className={CLASS_NAME}>\n        <div className=\"ontodia-btn-group ontodia-btn-group-sm\">\n          {this.renderSaveDiagramButton()}\n          {this.renderPersistAuthoredChangesButton()}\n          {this.props.onClearAll ? (\n            <button\n              type=\"button\"\n              className=\"ontodia-btn ontodia-btn-default\"\n              title=\"Clear All\"\n              onClick={this.props.onClearAll}\n            >\n              <span className=\"fa fa-trash\" aria-hidden=\"true\" />\n              &nbsp;Clear All\n            </button>\n          ) : null}\n          <button\n            type=\"button\"\n            className=\"ontodia-btn ontodia-btn-default\"\n            title=\"Force layout\"\n            onClick={this.props.onForceLayout}\n          >\n            <span className=\"fa fa-sitemap\" aria-hidden=\"true\" /> Layout\n          </button>\n          <button\n            type=\"button\"\n            className=\"ontodia-btn ontodia-btn-default\"\n            title=\"Zoom In\"\n            onClick={this.props.onZoomIn}\n          >\n            <span className=\"fa fa-search-plus\" aria-hidden=\"true\" />\n          </button>\n          <button\n            type=\"button\"\n            className=\"ontodia-btn ontodia-btn-default\"\n            title=\"Zoom Out\"\n            onClick={this.props.onZoomOut}\n          >\n            <span className=\"fa fa-search-minus\" aria-hidden=\"true\" />\n          </button>\n          <button\n            type=\"button\"\n            className=\"ontodia-btn ontodia-btn-default\"\n            title=\"Fit to Screen\"\n            onClick={this.props.onZoomToFit}\n          >\n            <span className=\"fa fa-arrows-alt\" aria-hidden=\"true\" />\n          </button>\n          <button\n            type=\"button\"\n            className=\"ontodia-btn ontodia-btn-default\"\n            title=\"Export diagram as PNG\"\n            onClick={this.onExportPNG}\n          >\n            <span className=\"fa fa-picture-o\" aria-hidden=\"true\" /> PNG\n          </button>\n          <button\n            type=\"button\"\n            className=\"ontodia-btn ontodia-btn-default\"\n            title=\"Export diagram as SVG\"\n            onClick={this.onExportSVG}\n          >\n            <span className=\"fa fa-picture-o\" aria-hidden=\"true\" /> SVG\n          </button>\n          <button\n            type=\"button\"\n            className=\"ontodia-btn ontodia-btn-default\"\n            title=\"Print diagram\"\n            onClick={this.props.onPrint}\n          >\n            <span className=\"fa fa-print\" aria-hidden=\"true\" />\n          </button>\n          {this.renderLanguages()}\n        </div>\n      </div>\n    );\n  }\n}\n","import * as React from 'react';\n\nimport { Accordion } from '../accordion';\nimport { AccordionItem, DockSide } from '../accordionItem';\n\nconst DEFAULT_HORIZONTAL_COLLAPSED_SIZE = 28;\n\nexport enum WorkspaceLayoutType {\n  Row = 'row',\n  Column = 'column',\n  Component = 'component',\n}\n\nexport type WorkspaceLayoutNode = Container | Component;\n\ninterface Container {\n  type: WorkspaceLayoutType.Row | WorkspaceLayoutType.Column;\n  children: ReadonlyArray<WorkspaceLayoutNode>;\n  defaultSize?: number;\n  defaultCollapsed?: boolean;\n  collapsedSize?: number;\n  minSize?: number;\n  undocked?: boolean;\n  animationDuration?: number;\n}\n\ninterface Component {\n  id: string;\n  type: WorkspaceLayoutType.Component;\n  content: React.ReactElement<any>;\n  heading?: React.ReactNode;\n  defaultSize?: number;\n  defaultCollapsed?: boolean;\n  collapsedSize?: number;\n  minSize?: number;\n  undocked?: boolean;\n  className?: string;\n}\n\nexport interface WorkspaceLayoutProps {\n  layout: WorkspaceLayoutNode;\n  _onStartResize?: (direction: 'vertical' | 'horizontal') => void;\n  _onResize?: (direction: 'vertical' | 'horizontal') => void;\n}\n\nexport class WorkspaceLayout extends React.Component<WorkspaceLayoutProps, {}> {\n  private renderAccordion({\n    children,\n    direction,\n    animationDuration,\n  }: {\n    children: ReadonlyArray<WorkspaceLayoutNode>;\n    direction: 'horizontal' | 'vertical';\n    animationDuration?: number;\n  }) {\n    const { _onStartResize, _onResize } = this.props;\n    const items = children.map((child, index) => {\n      let dockSide: DockSide;\n      if (direction === 'horizontal' && !child.undocked) {\n        if (index === 0) {\n          dockSide = DockSide.Left;\n        } else if (index === children.length - 1) {\n          dockSide = DockSide.Right;\n        }\n      }\n      let collapsedSize = child.collapsedSize;\n      if (collapsedSize === undefined && direction === 'horizontal') {\n        collapsedSize = DEFAULT_HORIZONTAL_COLLAPSED_SIZE;\n      }\n      return (\n        <AccordionItem\n          key={child.type === WorkspaceLayoutType.Component ? child.id : index}\n          heading={child.type === WorkspaceLayoutType.Component ? child.heading : undefined}\n          className={child.type === WorkspaceLayoutType.Component ? child.className : undefined}\n          dockSide={dockSide}\n          defaultSize={child.defaultSize}\n          defaultCollapsed={child.defaultCollapsed}\n          collapsedSize={collapsedSize}\n          minSize={child.minSize}\n        >\n          {this.renderLayout(child)}\n        </AccordionItem>\n      );\n    });\n    return (\n      <Accordion\n        direction={direction}\n        onStartResize={_onStartResize}\n        onResize={_onResize}\n        animationDuration={animationDuration}\n      >\n        {items}\n      </Accordion>\n    );\n  }\n\n  private renderLayout(layout: WorkspaceLayoutNode) {\n    if (layout.type === WorkspaceLayoutType.Row) {\n      return this.renderAccordion({\n        children: layout.children,\n        direction: 'horizontal',\n        animationDuration: layout.animationDuration,\n      });\n    }\n    if (layout.type === WorkspaceLayoutType.Column) {\n      return this.renderAccordion({\n        children: layout.children,\n        direction: 'vertical',\n        animationDuration: layout.animationDuration,\n      });\n    }\n    if (layout.type === WorkspaceLayoutType.Component) {\n      return React.Children.only(layout.content);\n    }\n    return null;\n  }\n\n  render() {\n    const { layout } = this.props;\n    return this.renderLayout(layout);\n  }\n}\n","import * as React from 'react';\nimport { ReactElement } from 'react';\n\nimport { TemplateProps } from '../props';\n\nimport { getPropertyValues } from './utils';\n\nconst CLASS_NAME = 'ontodia-default-template';\n\nexport class DefaultElementTemplate extends React.Component<TemplateProps, {}> {\n  render() {\n    const props = this.props;\n\n    const image = props.imgUrl ? (\n      <div className={`${CLASS_NAME}__thumbnail`}>\n        <img src={props.imgUrl} />\n      </div>\n    ) : undefined;\n\n    const expander = props.isExpanded ? (\n      <div>\n        <div className=\"ontodia-default-template_body_expander\">\n          <div className=\"ontodia-default-template_body_expander__iri_label\">IRI:</div>\n          <div className=\"ontodia-default-template_body_expander_iri\">\n            <a className=\"ontodia-default-template_body_expander_iri__link\" href={props.iri} title={props.iri}>\n              {props.iri}\n            </a>\n          </div>\n        </div>\n        <hr className=\"ontodia-default-template_body_expander__hr\" />\n        {this.renderPropertyTable()}\n      </div>\n    ) : null;\n\n    return (\n      <div\n        className=\"ontodia-default-template\"\n        style={{\n          backgroundColor: props.color,\n          borderColor: props.color,\n        }}\n        data-expanded={this.props.isExpanded}\n      >\n        <div className=\"ontodia-default-template_type-line\" title={props.label}>\n          <div className=\"ontodia-default-template_type-line__icon\" aria-hidden=\"true\">\n            <img src={props.iconUrl} />\n          </div>\n          <div title={props.types} className=\"ontodia-default-template_type-line_text-container\">\n            <div className=\"ontodia-default-template_type-line_text-container__text\">{props.types}</div>\n          </div>\n        </div>\n        {image}\n        <div className=\"ontodia-default-template_body\" style={{ borderColor: props.color }}>\n          <span className=\"ontodia-default-template_body__label\" title={props.label}>\n            {props.label}\n          </span>\n          {expander}\n        </div>\n      </div>\n    );\n  }\n\n  renderPropertyTable() {\n    const { propsAsList } = this.props;\n    if (propsAsList && propsAsList.length > 0) {\n      return (\n        <div className=\"ontodia-default-template_body_expander_property-table\">\n          {propsAsList.map((prop) => {\n            const propertyValues = getPropertyValues(prop.property);\n            const values = propertyValues.map((text, index) => (\n              <div\n                className=\"ontodia-default-template_body_expander_property-table_row_key_values__value\"\n                key={index}\n                title={text}\n              >\n                {text}\n              </div>\n            ));\n            return (\n              <div key={prop.id} className=\"ontodia-default-template_body_expander_property-table_row\">\n                <div\n                  title={prop.name + ' (' + prop.id + ')'}\n                  className=\"ontodia-default-template_body_expander_property-table_row__key\"\n                >\n                  {prop.name}\n                </div>\n                <div className=\"ontodia-default-template_body_expander_property-table_row_key_values\">{values}</div>\n              </div>\n            );\n          })}\n        </div>\n      );\n    } else {\n      return <div>no properties</div>;\n    }\n  }\n}\n","import * as React from 'react';\n\nimport { TemplateProps } from '../props';\nimport { EmbeddedLayer } from '../../diagram/embeddedLayer';\n\nconst CLASS = 'ontodia-group-template';\n\nexport class GroupTemplate extends React.Component<TemplateProps, {}> {\n  render() {\n    const { label, iconUrl, types, color, isExpanded } = this.props;\n\n    return (\n      <div className={CLASS}>\n        <div\n          className={`${CLASS}__wrap`}\n          style={{\n            backgroundColor: color,\n            borderColor: color,\n          }}\n        >\n          <div className={`${CLASS}__type-line`} title={label}>\n            <div className={`${CLASS}__type-line-icon`}>\n              <img src={iconUrl} />\n            </div>\n            <div title={types} className={`${CLASS}__type-line-text-container`}>\n              <div className={`${CLASS}__type-line-text`}>{types}</div>\n            </div>\n          </div>\n          <div className={`${CLASS}__body`} style={{ borderColor: color }}>\n            <span className={`${CLASS}__label`} title={label}>\n              {label}\n            </span>\n            {isExpanded ? (\n              <div className={`${CLASS}__embedded-layer`}>\n                <EmbeddedLayer />\n              </div>\n            ) : null}\n          </div>\n        </div>\n      </div>\n    );\n  }\n}\n","import { TypeStyleResolver } from './props';\n\nconst classIcon = require('../../../images/icons/class.svg');\nconst objectPropertyIcon = require('../../../images/icons/objectProperty.svg');\nconst datatypePropertyIcon = require('../../../images/icons/datatypeProperty.svg');\nconst personIcon = require('../../../images/icons/person.svg');\nconst countryIcon = require('../../../images/icons/country.svg');\nconst organizationIcon = require('../../../images/icons/organization.svg');\nconst locationIcon = require('../../../images/icons/location.svg');\nconst eventIcon = require('../../../images/icons/event.svg');\nconst objectIcon = require('../../../images/icons/object.svg');\n\nexport const DefaultTypeStyleBundle: TypeStyleResolver = (types) => {\n  if (\n    types.indexOf('http://www.w3.org/2002/07/owl#Class') !== -1 ||\n    types.indexOf('http://www.w3.org/2000/01/rdf-schema#Class') !== -1\n  ) {\n    return { color: '#eaac77', icon: classIcon };\n  } else if (types.indexOf('http://www.w3.org/2002/07/owl#ObjectProperty') !== -1) {\n    return { color: '#34c7f3', icon: objectPropertyIcon };\n  } else if (types.indexOf('http://www.w3.org/2002/07/owl#DatatypeProperty') !== -1) {\n    return { color: '#34c7f3', icon: datatypePropertyIcon };\n  } else if (\n    types.indexOf('http://xmlns.com/foaf/0.1/Person') !== -1 ||\n    types.indexOf('http://www.wikidata.org/entity/Q5') !== -1\n  ) {\n    return { color: '#eb7777', icon: personIcon };\n  } else if (types.indexOf('http://www.wikidata.org/entity/Q6256') !== -1) {\n    return { color: '#77ca98', icon: countryIcon };\n  } else if (\n    types.indexOf('http://schema.org/Organization') !== -1 ||\n    types.indexOf('http://dbpedia.org/ontology/Organisation') !== -1 ||\n    types.indexOf('http://xmlns.com/foaf/0.1/Organization') !== -1 ||\n    types.indexOf('http://www.wikidata.org/entity/Q43229') !== -1\n  ) {\n    return { color: '#77ca98', icon: organizationIcon };\n  } else if (types.indexOf('http://www.wikidata.org/entity/Q618123') !== -1) {\n    return { color: '#bebc71', icon: locationIcon };\n  } else if (types.indexOf('http://www.wikidata.org/entity/Q1190554') !== -1) {\n    return { color: '#b4b1fb', icon: eventIcon };\n  } else if (types.indexOf('http://www.wikidata.org/entity/Q488383') !== -1) {\n    return { color: '#53ccb2', icon: objectIcon };\n  } else {\n    return undefined;\n  }\n};\n","export default __webpack_public_path__ + \"cab65e2315f76cf56a3770a5beeeab59.svg\";","export default __webpack_public_path__ + \"5be47e72a75723a361b5d77280341b06.svg\";","export default __webpack_public_path__ + \"efb6a7d0bd589a4824dca3c7fa20b72d.svg\";","export default __webpack_public_path__ + \"a611ce4b1c21523088ac82ad304c569c.svg\";","export default __webpack_public_path__ + \"c24aa430e34aa6a64f1d0d26f27cc215.svg\";","export default __webpack_public_path__ + \"ad307120dd0372e10c3334a40e7877bb.svg\";","export default __webpack_public_path__ + \"23d23fe36bf5518fd59ecd152c469a04.svg\";","export default __webpack_public_path__ + \"01cf2fccdcf763aff705a71df4b6f70c.svg\";","export default __webpack_public_path__ + \"f196018229024e8524818df83812fc74.svg\";","import { LinkRouter, RoutedLinks, Vertex } from '../customization/props';\nimport { DiagramModel } from './model';\nimport { Link as DiagramLink, Element as DiagramElement } from './elements';\nimport { Vector } from './geometry';\n\nexport class DefaultLinkRouter implements LinkRouter {\n  constructor(private gap = 20) {}\n\n  route(model: DiagramModel): RoutedLinks {\n    const routings: RoutedLinks = new Map();\n\n    for (const link of model.links) {\n      if (routings.has(link.id)) {\n        continue;\n      }\n      // The cell is a link. Let's find its source and target models.\n      const { sourceId, targetId } = link;\n      if (!sourceId || !targetId) {\n        continue;\n      } else if (sourceId === targetId) {\n        this.routeFeedbackSiblingLinks(model, sourceId, routings);\n      } else {\n        this.routeNormalSiblingLinks(model, sourceId, targetId, routings);\n      }\n    }\n\n    return routings;\n  }\n\n  private routeFeedbackSiblingLinks(model: DiagramModel, elementId: string, routings: RoutedLinks) {\n    const element = model.getElement(elementId);\n    const { x, y } = element.position;\n    const { width, height } = element.size;\n\n    let index = 0;\n    for (const sibling of element.links) {\n      if (routings.has(sibling.id) || hasUserPlacedVertices(sibling)) {\n        continue;\n      }\n      const { sourceId, targetId } = sibling;\n      if (sourceId === targetId) {\n        const offset = this.gap * (index + 1);\n        const vertices: Vertex[] = [\n          { x: x - offset, y: y + height / 2 },\n          { x: x - offset, y: y - offset },\n          { x: x + width / 2, y: y - offset },\n        ];\n        routings.set(sibling.id, { linkId: sibling.id, vertices });\n        index++;\n      }\n    }\n  }\n\n  private routeNormalSiblingLinks(model: DiagramModel, sourceId: string, targetId: string, routings: RoutedLinks) {\n    const source = model.getElement(sourceId);\n    const target = model.getElement(targetId);\n\n    const sourceCenter = centerOfElement(source);\n    const targetCenter = centerOfElement(target);\n    const midPoint = {\n      x: (sourceCenter.x + targetCenter.x) / 2,\n      y: (sourceCenter.y + targetCenter.y) / 2,\n    };\n    const direction = Vector.normalize({\n      x: targetCenter.x - sourceCenter.x,\n      y: targetCenter.y - sourceCenter.y,\n    });\n\n    const siblings = source.links.filter(\n      (link) =>\n        (link.sourceId === targetId || link.targetId === targetId) &&\n        !routings.has(link.id) &&\n        !hasUserPlacedVertices(link)\n    );\n    if (siblings.length <= 1) {\n      return;\n    }\n    const indexModifier = siblings.length % 2 ? 0 : 1;\n\n    siblings.forEach((sibling, siblingIndex) => {\n      // For mor beautifull positioning\n      const index = siblingIndex + indexModifier;\n      // We want the offset values to be calculated as follows 0, 50, 50, 100, 100, 150, 150 ..\n      const offset = this.gap * Math.ceil(index / 2) - (indexModifier ? this.gap / 2 : 0);\n      // Now we need the vertices to be placed at points which are 'offset' pixels distant\n      // from the first link and forms a perpendicular angle to it. And as index goes up\n      // alternate left and right.\n      //\n      //  ^  odd indexes\n      //  |\n      //  |---->  index 0 line (straight line between a source center and a target center.\n      //  |\n      //  v  even indexes\n      const offsetDirection =\n        index % 2\n          ? { x: -direction.y, y: direction.x } // rotate by 90 degrees counter-clockwise\n          : { x: direction.y, y: -direction.x }; // rotate by 90 degrees clockwise\n      // We found the vertex.\n      const vertex = {\n        x: midPoint.x + offsetDirection.x * offset,\n        y: midPoint.y + offsetDirection.y * offset,\n      };\n      routings.set(sibling.id, {\n        linkId: sibling.id,\n        vertices: [vertex],\n        labelTextAnchor: this.getLabelAlignment(direction, siblingIndex, siblings.length),\n      });\n    });\n  }\n\n  private getLabelAlignment(\n    connectionDirection: Vector,\n    siblingIndex: number,\n    siblingCount: number\n  ): 'start' | 'middle' | 'end' {\n    // offset direction angle in [0; 2 Pi] interval\n    const angle = Math.atan2(connectionDirection.y, connectionDirection.x);\n    const absoluteAngle = Math.abs(angle);\n    const isHorizontal = absoluteAngle < (Math.PI * 1) / 8 || absoluteAngle > (Math.PI * 7) / 8;\n    const isTop = angle < 0;\n    const isBottom = angle > 0;\n\n    const firstOuter = siblingCount - 2;\n    const secondOuter = siblingCount - 1;\n\n    if (!isHorizontal) {\n      if ((isTop && siblingIndex === secondOuter) || (isBottom && siblingIndex === firstOuter)) {\n        return 'end';\n      } else if ((isTop && siblingIndex === firstOuter) || (isBottom && siblingIndex === secondOuter)) {\n        return 'start';\n      }\n    }\n\n    return 'middle';\n  }\n}\n\nfunction hasUserPlacedVertices(link: DiagramLink) {\n  const vertices = link.vertices;\n  return vertices && vertices.length > 0;\n}\n\nfunction centerOfElement(element: DiagramElement): Vector {\n  const { x, y } = element.position;\n  const { width, height } = element.size;\n  return { x: x + width / 2, y: y + height / 2 };\n}\n","import * as React from 'react';\nimport { Component } from 'react';\n\nimport { isEncodedBlank } from '../../data/sparql/blankNodes';\n\nimport { TemplateProps, PropArray } from '../props';\nimport { getProperty, getPropertyValues } from './utils';\n\nimport { TemplateProperties } from '../../data/schema';\n\nimport { AuthoredEntity, AuthoredEntityContext } from '../../editor/authoredEntity';\nimport { AuthoringState } from '../../editor/authoringState';\n\nimport { HtmlSpinner } from '../../viewUtils/spinner';\n\nconst FOAF_NAME = 'http://xmlns.com/foaf/0.1/name';\n\nconst CLASS_NAME = 'ontodia-standard-template';\n\nexport class StandardTemplate extends Component<TemplateProps, {}> {\n  render() {\n    return <AuthoredEntity templateProps={this.props}>{(context) => this.renderTemplate(context)}</AuthoredEntity>;\n  }\n\n  private renderTemplate(context: AuthoredEntityContext) {\n    const { color, types, isExpanded, iri, propsAsList } = this.props;\n    const label = this.getLabel();\n\n    const { editor } = context;\n    const isNewElement = AuthoringState.isNewElement(editor.authoringState, iri);\n    const leftStripeColor = isNewElement ? 'white' : color;\n    const pinnedProperties = this.findPinnedProperties(context);\n\n    return (\n      <div className={CLASS_NAME}>\n        <div className={`${CLASS_NAME}__main`} style={{ backgroundColor: leftStripeColor, borderColor: color }}>\n          <div className={`${CLASS_NAME}__body`} style={{ borderLeftColor: color }}>\n            <div className={`${CLASS_NAME}__body-horizontal`}>\n              {this.renderThumbnail()}\n              <div className={`${CLASS_NAME}__body-content`}>\n                <div title={types} className={`${CLASS_NAME}__type`}>\n                  <div className={`${CLASS_NAME}__type-value`}>{this.getTypesLabel()}</div>\n                </div>\n                <div className={`${CLASS_NAME}__label`} title={label}>\n                  {label}\n                </div>\n              </div>\n            </div>\n            {pinnedProperties ? (\n              <div className={`${CLASS_NAME}__pinned-props`} style={{ borderColor: color }}>\n                {this.renderProperties(pinnedProperties)}\n              </div>\n            ) : null}\n          </div>\n        </div>\n        {isExpanded ? (\n          <div className={`${CLASS_NAME}__dropdown`} style={{ borderColor: color }}>\n            {this.renderPhoto()}\n            <div className={`${CLASS_NAME}__dropdown-content`}>\n              {this.renderIri(context)}\n              {this.renderProperties(propsAsList)}\n              {editor.inAuthoringMode ? <hr className={`${CLASS_NAME}__hr`} /> : null}\n              {editor.inAuthoringMode ? this.renderActions(context) : null}\n            </div>\n          </div>\n        ) : null}\n      </div>\n    );\n  }\n\n  private findPinnedProperties(context: AuthoredEntityContext): PropArray | undefined {\n    const { isExpanded, propsAsList, elementId } = this.props;\n    if (isExpanded) {\n      return undefined;\n    }\n    const templateState = context.view.model.getElement(elementId).elementState;\n    if (!templateState) {\n      return undefined;\n    }\n    const pinned = templateState[TemplateProperties.PinnedProperties] as PinnedProperties;\n    if (!pinned) {\n      return undefined;\n    }\n    const filtered = propsAsList.filter((prop) => Boolean(pinned[prop.id]));\n    return filtered.length === 0 ? undefined : filtered;\n  }\n\n  private renderProperties(propsAsList: PropArray) {\n    if (!propsAsList.length) {\n      return <div>no properties</div>;\n    }\n\n    return (\n      <div className={`${CLASS_NAME}__properties`}>\n        {propsAsList.map(({ name, id, property }) => {\n          const propertyValues = getPropertyValues(property);\n          return (\n            <div key={id} className={`${CLASS_NAME}__properties-row`}>\n              <div className={`${CLASS_NAME}__properties-key`} title={`${name} (${id})`}>\n                {name}\n              </div>\n              <div className={`${CLASS_NAME}__properties-values`}>\n                {propertyValues.map((text, index) => (\n                  <div className={`${CLASS_NAME}__properties-value`} key={index} title={text}>\n                    {text}\n                  </div>\n                ))}\n              </div>\n            </div>\n          );\n        })}\n      </div>\n    );\n  }\n\n  private renderPhoto() {\n    const { color, imgUrl } = this.props;\n\n    if (!imgUrl) {\n      return null;\n    }\n\n    return (\n      <div className={`${CLASS_NAME}__photo`} style={{ borderColor: color }}>\n        <img src={imgUrl} className={`${CLASS_NAME}__photo-image`} />\n      </div>\n    );\n  }\n\n  private renderIri(context: AuthoredEntityContext) {\n    const { iri } = this.props;\n    const finalIri = context.editedIri === undefined ? iri : context.editedIri;\n    return (\n      <div>\n        <div className={`${CLASS_NAME}__iri`}>\n          <div className={`${CLASS_NAME}__iri-key`}>IRI{context.editedIri ? '\\u00A0(edited)' : ''}:</div>\n          <div className={`${CLASS_NAME}__iri-value`}>\n            {isEncodedBlank(finalIri) ? (\n              <span>(blank node)</span>\n            ) : (\n              <a href={finalIri} title={finalIri} data-iri-click-intent=\"openEntityIri\">\n                {finalIri}\n              </a>\n            )}\n          </div>\n        </div>\n        <hr className={`${CLASS_NAME}__hr`} />\n      </div>\n    );\n  }\n\n  private renderThumbnail() {\n    const { color, imgUrl, iconUrl } = this.props;\n\n    if (imgUrl) {\n      return (\n        <div className={`${CLASS_NAME}__thumbnail`} aria-hidden=\"true\">\n          <img src={imgUrl} className={`${CLASS_NAME}__thumbnail-image`} />\n        </div>\n      );\n    } else if (iconUrl) {\n      return (\n        <div className={`${CLASS_NAME}__thumbnail`} aria-hidden=\"true\">\n          <img src={iconUrl} className={`${CLASS_NAME}__thumbnail-icon`} />\n        </div>\n      );\n    }\n\n    const typeLabel = this.getTypesLabel();\n    return (\n      <div className={`${CLASS_NAME}__thumbnail`} aria-hidden=\"true\" style={{ color }}>\n        {typeLabel.length > 0 ? typeLabel.charAt(0).toUpperCase() : ''}\n      </div>\n    );\n  }\n\n  protected getTypesLabel(): string {\n    return this.props.types;\n  }\n\n  private getLabel() {\n    const { label, props } = this.props;\n    return getProperty(props, FOAF_NAME) || label;\n  }\n\n  private renderActions(context: AuthoredEntityContext) {\n    const { canEdit, canDelete, onEdit, onDelete } = context;\n    const SPINNER_WIDTH = 15;\n    const SPINNER_HEIGHT = 12;\n    return (\n      <div className={`${CLASS_NAME}__actions`}>\n        <button\n          type=\"button\"\n          className=\"ontodia-btn ontodia-btn-default\"\n          title={canDelete ? 'Delete entity' : 'Deletion is unavailable for the selected element'}\n          disabled={!canDelete}\n          onClick={onDelete}\n        >\n          <span className=\"fa fa-trash\" />\n          &nbsp;\n          {canEdit === undefined ? <HtmlSpinner width={SPINNER_WIDTH} height={SPINNER_HEIGHT} /> : 'Delete'}\n        </button>\n        <button\n          type=\"button\"\n          className=\"ontodia-btn ontodia-btn-default\"\n          title={canEdit ? 'Edit entity' : 'Editing is unavailable for the selected element'}\n          disabled={!canEdit}\n          onClick={onEdit}\n        >\n          <span className=\"fa fa-edit\" />\n          &nbsp;\n          {canEdit === undefined ? <HtmlSpinner width={SPINNER_WIDTH} height={SPINNER_HEIGHT} /> : 'Edit'}\n        </button>\n      </div>\n    );\n  }\n}\n\ninterface PinnedProperties {\n  [propertyId: string]: boolean;\n}\n","import { cloneDeep, keyBy, map, each } from 'lodash';\nimport { DataProvider, LinkElementsParams, FilterParams } from '../provider';\nimport {\n  Dictionary,\n  ClassModel,\n  LinkType,\n  ElementModel,\n  LinkModel,\n  LinkCount,\n  ElementIri,\n  ElementTypeIri,\n  LinkTypeIri,\n  PropertyTypeIri,\n} from '../model';\n\nexport class DemoDataProvider implements DataProvider {\n  constructor(\n    private allClasses: ClassModel[],\n    private allLinkTypes: LinkType[],\n    private allElements: Dictionary<ElementModel>,\n    private allLinks: LinkModel[]\n  ) {}\n\n  private simulateNetwork<T>(result: T) {\n    const MEAN_DELAY = 200;\n    const cloned = cloneDeep(result);\n    // simulate exponential distribution\n    const delay = -Math.log(Math.random()) * MEAN_DELAY;\n    return new Promise<T>((resolve) => {\n      setTimeout(() => resolve(cloned), delay);\n    });\n  }\n\n  classTree() {\n    return this.simulateNetwork(this.allClasses);\n  }\n\n  classInfo(params: { classIds: ElementTypeIri[] }) {\n    const classIds = params.classIds || [];\n    return this.simulateNetwork(this.allClasses.filter((cl) => classIds.indexOf(cl.id)));\n  }\n\n  linkTypes() {\n    return this.simulateNetwork(this.allLinkTypes);\n  }\n\n  linkTypesInfo(params: { linkTypeIds: LinkTypeIri[] }): Promise<LinkType[]> {\n    const types = keyBy(params.linkTypeIds);\n    const linkTypes = this.allLinkTypes.filter((type) => types[type.id]);\n    return this.simulateNetwork(linkTypes);\n  }\n\n  elementInfo(params: { elementIds: ElementIri[] }): Promise<Dictionary<ElementModel>> {\n    const elements = params.elementIds\n      .map((elementId) => this.allElements[elementId])\n      .filter((element) => element !== undefined);\n    return this.simulateNetwork(keyBy(elements, (element) => element.id));\n  }\n\n  linksInfo(params: { elementIds: ElementIri[]; linkTypeIds: LinkTypeIri[] }) {\n    const nodes = keyBy(params.elementIds);\n    const types = keyBy(params.linkTypeIds);\n    const links = this.allLinks.filter(\n      (link) => types[link.linkTypeId] && nodes[link.sourceId] && nodes[link.targetId]\n    );\n    return this.simulateNetwork(links);\n  }\n\n  linkTypesOf(params: { elementId: ElementIri }) {\n    const counts: Dictionary<LinkCount> = {};\n    for (const link of this.allLinks) {\n      if (link.sourceId === params.elementId || link.targetId === params.elementId) {\n        const linkCount = counts[link.linkTypeId];\n        const isSource = link.sourceId === params.elementId;\n        if (linkCount) {\n          isSource ? linkCount.outCount++ : linkCount.inCount++;\n        } else {\n          counts[link.linkTypeId] = isSource\n            ? { id: link.linkTypeId, inCount: 0, outCount: 1 }\n            : { id: link.linkTypeId, inCount: 1, outCount: 0 };\n        }\n      }\n    }\n    return this.simulateNetwork(map(counts));\n  }\n\n  linkElements(params: LinkElementsParams): Promise<Dictionary<ElementModel>> {\n    // for sparql we have rich filtering features and we just reuse filter.\n    return this.filter({\n      refElementId: params.elementId,\n      refElementLinkId: params.linkId,\n      linkDirection: params.direction,\n      limit: params.limit,\n      offset: params.offset,\n      languageCode: '',\n    });\n  }\n\n  filter(params: FilterParams): Promise<Dictionary<ElementModel>> {\n    if (params.limit === undefined) {\n      params.limit = 100;\n    }\n\n    if (params.offset > 0) {\n      return Promise.resolve({});\n    }\n\n    let filtered: Dictionary<ElementModel> = {};\n    if (params.elementTypeId) {\n      each(this.allElements, (element) => {\n        if (element.types.indexOf(params.elementTypeId) >= 0) {\n          filtered[element.id] = element;\n        }\n      });\n    } else if (params.refElementId) {\n      const filteredLinks = params.refElementLinkId\n        ? this.allLinks.filter((link) => link.linkTypeId === params.refElementLinkId)\n        : this.allLinks;\n      const nodeId = params.refElementId;\n      for (const link of filteredLinks) {\n        let linkedElementId: string;\n        if (link.sourceId === nodeId && params.linkDirection !== 'in') {\n          linkedElementId = link.targetId;\n        } else if (link.targetId === nodeId && params.linkDirection !== 'out') {\n          linkedElementId = link.sourceId;\n        }\n        if (linkedElementId !== undefined) {\n          const linkedElement = this.allElements[linkedElementId];\n          if (linkedElement) {\n            filtered[linkedElement.id] = linkedElement;\n          }\n        }\n      }\n    } else if (params.text) {\n      filtered = this.allElements; // filtering by text is done below\n    } else {\n      return Promise.reject(new Error('This type of filter is not implemented'));\n    }\n\n    if (params.text) {\n      const filteredByText: Dictionary<ElementModel> = {};\n      const text = params.text.toLowerCase();\n      each(filtered, (element) => {\n        let found = false;\n        if (element.id.toLowerCase().indexOf(text) >= 0) {\n          found = true;\n        } else {\n          found = element.label.values.some((label) => label.value.toLowerCase().indexOf(text) >= 0);\n        }\n        if (found) {\n          filteredByText[element.id] = element;\n        }\n      });\n      return this.simulateNetwork(filteredByText);\n    } else {\n      return this.simulateNetwork(filtered);\n    }\n  }\n}\n","import { Node, RDFGraph, Triple } from 'rdf-ext';\nimport {\n  RDFCacheableStore,\n  MatchStatement,\n  prefixFactory,\n  isLiteral,\n  isNamedNode,\n  isLabelType,\n} from './rdfCacheableStore';\nimport { DataProvider, LinkElementsParams, FilterParams } from '../provider';\nimport { RDFLoader } from './rdfLoader';\nimport {\n  LocalizedString,\n  Dictionary,\n  ClassModel,\n  LinkType,\n  ElementModel,\n  LinkModel,\n  LinkCount,\n  PropertyModel,\n  Property,\n  ElementIri,\n  ElementTypeIri,\n  LinkTypeIri,\n  PropertyTypeIri,\n} from '../model';\nimport { RDFCompositeParser } from './rdfCompositeParser';\n\nconst PREFIX_FACTORIES = {\n  RDF: prefixFactory('http://www.w3.org/1999/02/22-rdf-syntax-ns#'),\n  RDFS: prefixFactory('http://www.w3.org/2000/01/rdf-schema#'),\n  FOAF: prefixFactory('http://xmlns.com/foaf/0.1/'),\n  XSD: prefixFactory('http://www.w3.org/2001/XMLSchema#'),\n  OWL: prefixFactory('http://www.w3.org/2002/07/owl#'),\n};\n\nexport interface RDFFile {\n  content: string;\n  fileName?: string;\n  type?: string;\n  uri?: string;\n}\n\nexport interface RDFDataProviderOptions {\n  data: RDFFile[];\n  parsers: { [id: string]: any };\n  acceptBlankNodes?: boolean;\n  dataFetching?: boolean;\n  proxy?: string;\n}\n\n/** An opaque reference to RDFGraph type from `rdf-ext` library */\nexport type RDFExtGraph = object;\n\nexport class RDFDataProvider implements DataProvider {\n  public dataFetching: boolean;\n  private initStatement: Promise<any> | undefined;\n  private rdfStorage: RDFCacheableStore;\n  private rdfLoader: RDFLoader;\n\n  readonly options: RDFDataProviderOptions;\n\n  constructor(options: RDFDataProviderOptions) {\n    const parser = new RDFCompositeParser(options.parsers);\n\n    this.rdfStorage = new RDFCacheableStore({\n      parser,\n      acceptBlankNodes: options.acceptBlankNodes,\n    });\n    this.rdfLoader = new RDFLoader({\n      parser: parser,\n      proxy: options.proxy,\n    });\n    this.dataFetching = options.dataFetching;\n\n    const parsePromises = (options.data || []).map((datum) => {\n      return parser.parse(datum.content, datum.type, datum.fileName).then((rdfGraph) => {\n        this.rdfStorage.add(rdfGraph);\n        return true;\n      });\n    });\n\n    this.initStatement = Promise.all(parsePromises).catch((error: Error) => {\n      error.message = 'Initialization failed! Cause: ' + error.message;\n      throw error;\n    });\n    this.options = options;\n  }\n\n  addGraph(graph: RDFExtGraph) {\n    this.rdfStorage.add(graph as RDFGraph);\n  }\n\n  private waitInitCompleted(): Promise<void> {\n    if (this.initStatement) {\n      return this.initStatement.then(() => {\n        delete this.initStatement;\n      });\n    } else {\n      return Promise.resolve();\n    }\n  }\n\n  async classTree(): Promise<ClassModel[]> {\n    await this.waitInitCompleted();\n    const rdfClassesQuery = this.rdfStorage.match(\n      null,\n      PREFIX_FACTORIES.RDF('type'),\n      PREFIX_FACTORIES.RDFS('Class'),\n      null\n    );\n    const owlClassesQuery = this.rdfStorage.match(null, PREFIX_FACTORIES.RDF('type'), PREFIX_FACTORIES.OWL('Class'));\n    const fromRDFTypesQuery = this.rdfStorage.match(null, PREFIX_FACTORIES.RDF('type'), null);\n\n    const subClassesQuery = this.rdfStorage.match(null, PREFIX_FACTORIES.RDFS('subClassOf'), null);\n\n    const [rdfClassesGraph, owlClassesGraph, rdfTypesGraph, subClassesGraph] = await Promise.all([\n      rdfClassesQuery,\n      owlClassesQuery,\n      fromRDFTypesQuery,\n      subClassesQuery,\n    ]);\n    const rdfClasses = rdfClassesGraph.toArray().map((cl) => cl.subject);\n    const owlClasses = owlClassesGraph.toArray().map((cl) => cl.subject);\n    const rdfTypes = rdfTypesGraph.toArray().map((cl) => cl.object);\n    const subClasses = subClassesGraph.toArray();\n\n    const classes = rdfClasses.concat(owlClasses).concat(rdfTypes);\n    const classIris = classes\n      .filter((clazz) => clazz.interfaceName !== 'BlankNode')\n      .map((clazz) => clazz.nominalValue as ElementTypeIri);\n\n    const parents: Dictionary<ElementTypeIri[]> = {};\n    for (const triple of subClasses) {\n      const subClassIRI = triple.subject.nominalValue as ElementTypeIri;\n      const classIRI = triple.object.nominalValue as ElementTypeIri;\n      if (isNamedNode(triple.subject) && !parents[subClassIRI]) {\n        parents[subClassIRI] = [];\n      }\n      if (isNamedNode(triple.object) && parents[subClassIRI].indexOf(classIRI) === -1) {\n        parents[subClassIRI].push(classIRI);\n      }\n    }\n\n    const dictionary: Dictionary<ClassModel> = {};\n    const firstLevel: Dictionary<ClassModel> = {};\n    const labelQueries: Promise<any>[] = [];\n\n    for (const classIri of classIris) {\n      let classElement: ClassModel;\n      if (!dictionary[classIri]) {\n        classElement = this.createEmptyClass(classIri);\n        dictionary[classIri] = classElement;\n        firstLevel[classIri] = classElement;\n        labelQueries.push(\n          this.getLabels(classIri).then((labels) => {\n            classElement.label = { values: labels };\n          })\n        );\n      } else {\n        classElement = dictionary[classIri];\n      }\n\n      if (parents[classIri]) {\n        for (const parentIri of parents[classIri]) {\n          if (!dictionary[parentIri]) {\n            const parentElement = this.createEmptyClass(parentIri);\n            dictionary[parentIri] = parentElement;\n            firstLevel[parentIri] = parentElement;\n            labelQueries.push(\n              this.getLabels(parentIri).then((labels) => {\n                parentElement.label = { values: labels };\n              })\n            );\n          }\n          if (dictionary[parentIri].children.indexOf(classElement) === -1) {\n            dictionary[parentIri].children.push(classElement);\n            dictionary[parentIri].count += classElement.count;\n          }\n          delete firstLevel[classElement.id];\n        }\n      }\n    }\n\n    await Promise.all(labelQueries);\n\n    const result = Object.keys(firstLevel).map((k) => firstLevel[k]);\n    return result;\n  }\n\n  async propertyInfo(params: { propertyIds: PropertyTypeIri[] }): Promise<Dictionary<PropertyModel>> {\n    await this.waitInitCompleted();\n    const propertyInfoResult: Dictionary<PropertyModel> = {};\n\n    const queries = params.propertyIds.map(async (propId) => {\n      try {\n        const isExists = await this.checkElement(propId);\n        await this.fetchIfNecessary(propId, isExists);\n        const labels = await this.getLabels(propId);\n        return {\n          id: propId,\n          label: { values: labels },\n        };\n      } catch (error) {\n        // tslint:disable-next-line:no-console\n        console.warn(error);\n        return null;\n      }\n    });\n\n    const fetchedModels = await Promise.all(queries);\n    for (const model of fetchedModels) {\n      if (model) {\n        propertyInfoResult[model.id] = model;\n      }\n    }\n    return propertyInfoResult;\n  }\n\n  async classInfo(params: { classIds: ElementTypeIri[] }): Promise<ClassModel[]> {\n    await this.waitInitCompleted();\n    const queries = params.classIds.map(async (classId) => {\n      try {\n        const isExists = await this.checkElement(classId);\n        await this.fetchIfNecessary(classId, isExists);\n        const labels = await this.getLabels(classId);\n        return {\n          id: classId,\n          label: { values: labels },\n          count: this.rdfStorage.getTypeCount(classId),\n          children: [],\n        };\n      } catch (error) {\n        // tslint:disable-next-line:no-console\n        console.warn(error);\n        return null;\n      }\n    });\n\n    const fetchedModels = await Promise.all(queries);\n    return fetchedModels.filter((cm) => cm);\n  }\n\n  async linkTypesInfo(params: { linkTypeIds: LinkTypeIri[] }): Promise<LinkType[]> {\n    await this.waitInitCompleted();\n    const queries: Promise<LinkType>[] = params.linkTypeIds.map(async (typeId) => {\n      try {\n        const isExists = await this.rdfStorage.checkElement(typeId);\n        await this.fetchIfNecessary(typeId, isExists);\n        const labels = await this.getLabels(typeId);\n        return {\n          id: typeId,\n          label: { values: labels },\n          count: this.rdfStorage.getTypeCount(typeId),\n        };\n      } catch (error) {\n        // tslint:disable-next-line:no-console\n        console.warn(error);\n        return null;\n      }\n    });\n\n    const fetchedModels = await Promise.all(queries);\n    return fetchedModels.filter((lt) => lt);\n  }\n\n  async linkTypes(): Promise<LinkType[]> {\n    await this.waitInitCompleted();\n    const linkTypes: LinkType[] = [];\n    const rdfLinksQueries = this.rdfStorage.match(\n      undefined,\n      PREFIX_FACTORIES.RDF('type'),\n      PREFIX_FACTORIES.RDF('Property')\n    );\n    const owlLinksQueries = this.rdfStorage.match(\n      undefined,\n      PREFIX_FACTORIES.RDF('type'),\n      PREFIX_FACTORIES.OWL('ObjectProperty')\n    );\n    const [rdfLinks, owlLinks] = await Promise.all([rdfLinksQueries, owlLinksQueries]);\n    const linkTypeIds = new Set();\n    const mapLinkTriple = async (triple: Triple): Promise<void> => {\n      if (!linkTypeIds.has(triple.subject.nominalValue)) {\n        linkTypeIds.add(triple.subject.nominalValue);\n        const labels = await this.getLabels(triple.subject.nominalValue);\n\n        linkTypes.push({\n          id: triple.subject.nominalValue as LinkTypeIri,\n          label: { values: labels },\n          count: this.rdfStorage.getTypeCount(triple.subject.nominalValue),\n        });\n      }\n    };\n    const linkTypePromises: Promise<void>[] = [];\n    for (const linkTriple of rdfLinks.toArray()) {\n      linkTypePromises.push(mapLinkTriple(linkTriple));\n    }\n    for (const linkTriple of owlLinks.toArray()) {\n      linkTypePromises.push(mapLinkTriple(linkTriple));\n    }\n\n    await Promise.all(linkTypePromises);\n    return linkTypes;\n  }\n\n  async elementInfo(params: { elementIds: ElementIri[] }): Promise<Dictionary<ElementModel>> {\n    await this.waitInitCompleted();\n    const elementInfoResult: Dictionary<ElementModel> = {};\n\n    const queries = params.elementIds.map(async (elementId) => {\n      try {\n        const isExists = await this.rdfStorage.checkElement(elementId);\n        await this.fetchIfNecessary(elementId, isExists);\n        return this.getElementInfo(elementId);\n      } catch (error) {\n        // tslint:disable-next-line:no-console\n        console.warn(error);\n        return null;\n      }\n    });\n\n    const fetchedModels = await Promise.all(queries);\n    for (const model of fetchedModels) {\n      if (model) {\n        elementInfoResult[model.id] = model;\n      }\n    }\n    return elementInfoResult;\n  }\n\n  async linksInfo(params: { elementIds: ElementIri[]; linkTypeIds: LinkTypeIri[] }): Promise<LinkModel[]> {\n    await this.waitInitCompleted();\n    const statementPromises: Promise<MatchStatement>[] = [];\n    for (const source of params.elementIds) {\n      for (const target of params.elementIds) {\n        statementPromises.push(\n          Promise.all([\n            this.rdfStorage.checkElement(source).then((exists) => this.fetchIfNecessary(source, exists)),\n            this.rdfStorage.checkElement(target).then((exists) => this.fetchIfNecessary(target, exists)),\n          ])\n            .then(() => ({ subject: source, object: target }))\n            .catch((error) => {\n              // tslint:disable-next-line:no-console\n              console.warn(error);\n              return null;\n            })\n        );\n      }\n    }\n\n    const statements = await Promise.all(statementPromises);\n    const graph = await this.rdfStorage.matchAll(statements.filter((statement) => statement));\n    let triples;\n    if (this.options.acceptBlankNodes) {\n      triples = graph.toArray();\n    } else {\n      triples = graph.toArray().filter((tripple) => isNamedNode(tripple.subject) && isNamedNode(tripple.object));\n    }\n\n    const fetchedModels = triples.map(\n      (t): LinkModel => ({\n        linkTypeId: t.predicate.nominalValue as LinkTypeIri,\n        sourceId: t.subject.nominalValue as ElementIri,\n        targetId: t.object.nominalValue as ElementIri,\n      })\n    );\n    return fetchedModels;\n  }\n\n  async linkTypesOf(params: { elementId: ElementIri }): Promise<LinkCount[]> {\n    await this.waitInitCompleted();\n    const links: LinkCount[] = [];\n    const element = params.elementId;\n    const linkMap: Dictionary<LinkCount> = {};\n\n    const incomingElementsTriples = await this.rdfStorage.match(null, null, element);\n\n    const incomingElements = incomingElementsTriples\n      .toArray()\n      .filter((t) => isNamedNode(t.subject))\n      .map((triple) => triple.predicate);\n    for (const el of incomingElements) {\n      const linkTypeId = el.nominalValue as LinkTypeIri;\n      if (!linkMap[linkTypeId]) {\n        linkMap[linkTypeId] = {\n          id: linkTypeId,\n          inCount: 1,\n          outCount: 0,\n        };\n        links.push(linkMap[linkTypeId]);\n      } else {\n        linkMap[linkTypeId].inCount++;\n      }\n    }\n\n    const outgoingElementsTriples = await this.rdfStorage.match(element, null, null);\n\n    const outElements = outgoingElementsTriples\n      .toArray()\n      .filter((t) => isNamedNode(t.object))\n      .map((triple) => triple.predicate);\n    for (const el of outElements) {\n      const linkTypeId = el.nominalValue as LinkTypeIri;\n      if (!linkMap[linkTypeId]) {\n        linkMap[linkTypeId] = {\n          id: linkTypeId,\n          inCount: 0,\n          outCount: 1,\n        };\n        links.push(linkMap[linkTypeId]);\n      } else {\n        linkMap[linkTypeId].outCount++;\n      }\n    }\n    return links;\n  }\n\n  async linkElements(params: LinkElementsParams): Promise<Dictionary<ElementModel>> {\n    await this.waitInitCompleted();\n    return await this.filter({\n      refElementId: params.elementId,\n      refElementLinkId: params.linkId,\n      linkDirection: params.direction,\n      limit: params.limit,\n      offset: params.offset,\n      languageCode: '',\n    });\n  }\n\n  async filter(params: FilterParams): Promise<Dictionary<ElementModel>> {\n    await this.waitInitCompleted();\n\n    if (params.limit === undefined) {\n      params.limit = 100;\n    }\n    const limitCallback = (node: Node, index: number) => {\n      return (blankNodes || isNamedNode(node)) && offsetIndex <= index && index < limitIndex;\n    };\n\n    const offsetIndex = params.offset;\n    const limitIndex = params.offset + params.limit;\n    const blankNodes = this.options.acceptBlankNodes;\n\n    let elementsPromise: Promise<ElementModel[]>;\n    if (params.elementTypeId) {\n      elementsPromise = this.filterByTypeId(params.elementTypeId, limitCallback);\n    } else if (params.refElementId && params.refElementLinkId) {\n      elementsPromise = this.filterByRefAndLink(\n        params.refElementId,\n        params.refElementLinkId,\n        params.linkDirection,\n        limitCallback\n      );\n    } else if (params.refElementId) {\n      elementsPromise = this.filterByRef(params.refElementId, limitCallback);\n    } else if (params.text) {\n      const filteredElements = await this.getAllElements(params.text, limitCallback);\n      return this.filterByKey(undefined, filteredElements);\n    } else {\n      return {};\n    }\n\n    const elements = await elementsPromise;\n    return this.filterByKey(params.text, elements);\n  }\n\n  private async filterByTypeId(\n    elementTypeId: ElementTypeIri,\n    filter: (node: Node, index: number) => boolean\n  ): Promise<ElementModel[]> {\n    const elementTriples = await this.rdfStorage.match(undefined, PREFIX_FACTORIES.RDF('type'), elementTypeId);\n\n    return Promise.all(\n      elementTriples\n        .toArray()\n        .filter((t, index) => filter(t.subject, index))\n        .map((el) => this.getElementInfo(el.subject.nominalValue as ElementIri, true))\n    );\n  }\n\n  private async filterByRefAndLink(\n    refEl: ElementIri,\n    refLink: LinkTypeIri,\n    linkDirection: 'in' | 'out',\n    filter: (node: Node, index: number) => boolean\n  ): Promise<ElementModel[]> {\n    if (linkDirection === 'in') {\n      const elementTriples = await this.rdfStorage.match(null, refLink, refEl);\n      return Promise.all(\n        elementTriples\n          .toArray()\n          .filter((t, index) => filter(t.subject, index))\n          .map((el) => this.getElementInfo(el.subject.nominalValue as ElementIri, true))\n      );\n    } else {\n      const elementTriples = await this.rdfStorage.match(refEl, refLink, null);\n      return Promise.all(\n        elementTriples\n          .toArray()\n          .filter((t, index) => filter(t.object, index))\n          .map((el) => this.getElementInfo(el.object.nominalValue as ElementIri, true))\n      );\n    }\n  }\n\n  private async filterByRef(\n    refEl: ElementIri,\n    filter: (node: Node, index: number) => boolean\n  ): Promise<ElementModel[]> {\n    const incomingTriples = await this.rdfStorage.match(null, null, refEl);\n    const inRelations = await Promise.all(\n      incomingTriples\n        .toArray()\n        .filter((t, index) => filter(t.subject, index))\n        .map((el) => this.getElementInfo(el.subject.nominalValue as ElementIri, true))\n    );\n    const outgoingTriples = await this.rdfStorage.match(refEl, null, null);\n    const outRelations = await Promise.all(\n      outgoingTriples\n        .toArray()\n        .filter((t, index) => filter(t.object, index))\n        .map((el) => this.getElementInfo(el.object.nominalValue as ElementIri, true))\n    );\n\n    return inRelations.concat(outRelations);\n  }\n\n  private async getAllElements(text: string, filter: (node: Node, index: number) => boolean): Promise<ElementModel[]> {\n    const key = text ? text.toLowerCase() : null;\n    const elementTriples = await this.rdfStorage.match(null, null, null);\n    const promices: Promise<ElementModel>[] = [];\n    for (const triple of elementTriples.toArray()) {\n      if (filter(triple.subject, promices.length)) {\n        const objectIsLiteral = triple.object.interfaceName === 'Literal';\n        const isLabel = isLabelType(triple.predicate.nominalValue);\n        const containsKey =\n          (isLabel && triple.object.nominalValue.toLowerCase().indexOf(key) !== -1) ||\n          (!objectIsLiteral && triple.subject.nominalValue.toLowerCase().indexOf(key) !== -1);\n\n        if (containsKey) {\n          promices.push(this.getElementInfo(triple.subject.nominalValue as ElementIri, true));\n        }\n      }\n    }\n    return Promise.all(promices);\n  }\n\n  private filterByKey(text: string, elements: ElementModel[]): Dictionary<ElementModel> {\n    const result: Dictionary<ElementModel> = {};\n    const key = text ? text.toLowerCase() : null;\n    if (key) {\n      for (const el of elements) {\n        let acceptableKey = false;\n        for (const label of el.label.values) {\n          acceptableKey = acceptableKey || label.value.toLowerCase().indexOf(key) !== -1;\n          if (acceptableKey) {\n            break;\n          }\n        }\n        acceptableKey = acceptableKey || el.id.toLowerCase().indexOf(key) !== -1;\n        if (acceptableKey) {\n          result[el.id] = el;\n        }\n      }\n    } else {\n      for (const el of elements) {\n        result[el.id] = el;\n      }\n    }\n    return result;\n  }\n\n  private checkElement(id: string): Promise<boolean> {\n    return this.dataFetching ? this.rdfStorage.checkElement(id) : Promise.resolve(true);\n  }\n\n  private fetchIfNecessary(id: string, exists: boolean) {\n    if (exists || !this.dataFetching) {\n      return Promise.resolve();\n    } else {\n      return this.rdfLoader\n        .downloadElement(id)\n        .then((rdfGraph) => {\n          this.rdfStorage.add(rdfGraph);\n          return;\n        })\n        .catch((error) => {\n          // tslint:disable-next-line:no-console\n          console.warn(error);\n          return;\n        });\n    }\n  }\n\n  private getElementInfo(id: ElementIri, shortInfo?: boolean): Promise<ElementModel> {\n    return Promise.all([\n      this.getTypes(id),\n      !shortInfo ? this.getProps(id) : Promise.resolve({}),\n      this.getLabels(id),\n    ]).then(([types, props, labels]) => {\n      return {\n        id: id,\n        types: types,\n        label: { values: labels },\n        properties: props,\n      };\n    });\n  }\n\n  private getLabels(id: string): Promise<LocalizedString[]> {\n    return this.rdfStorage.getLabels(id).then((labelTriples) => {\n      return labelTriples.toArray().map(\n        (l): LocalizedString => ({\n          value: l.object.nominalValue,\n          language: isLiteral(l.object) ? l.object.language || '' : '',\n        })\n      );\n    });\n  }\n\n  private getProps(el: string): Promise<Dictionary<Property>> {\n    return this.rdfStorage.match(el, null, null).then((propsGraph) => {\n      const props: Dictionary<Property> = {};\n      const propTriples = propsGraph.toArray();\n\n      for (const statemet of propTriples) {\n        if (isLiteral(statemet.object) && statemet.predicate.nominalValue !== PREFIX_FACTORIES.RDFS('label')) {\n          const property = props[statemet.predicate.nominalValue];\n          const value = {\n            text: statemet.object.nominalValue,\n            lang: statemet.object.language || '',\n          };\n          props[statemet.predicate.nominalValue] = {\n            type: 'string',\n            values: property ? [...property.values, value] : [value],\n          } as Property;\n        }\n      }\n      return props;\n    });\n  }\n\n  private getTypes(el: ElementIri): Promise<ElementTypeIri[]> {\n    return this.rdfStorage.match(el, PREFIX_FACTORIES.RDF('type'), null).then((typeTriples) => {\n      return typeTriples.toArray().map((t) => t.object.nominalValue as ElementTypeIri);\n    });\n  }\n\n  private createEmptyClass(classIri: ElementTypeIri): ClassModel {\n    return {\n      id: classIri,\n      label: {\n        values: [],\n      },\n      count: this.rdfStorage.getTypeCount(classIri),\n      children: [],\n    };\n  }\n}\n","import { RDFStore, RDFGraph, createStore, createGraph, Node, Literal, NamedNode, Triple } from 'rdf-ext';\nimport { Dictionary } from '../model';\nimport { RDFCompositeParser } from './rdfCompositeParser';\n\nimport { uniqueId } from 'lodash';\n\nconst DEFAULT_STORAGE_TYPE = 'text/turtle';\nconst DEFAULT_STORAGE_URI = 'http://ontodia.org/defaultGraph';\n\nexport function prefixFactory(prefix: string): (id: string) => string {\n  const lastSymbol = prefix[prefix.length - 1];\n  const _prefix = lastSymbol === '/' || lastSymbol === '#' ? prefix : prefix + '/';\n  return (id: string) => {\n    return _prefix + id;\n  };\n}\n\nexport function isLiteral(el: Node): el is Literal {\n  return el.interfaceName === 'Literal';\n}\n\nexport function isNamedNode(el: Node): el is NamedNode {\n  return el.interfaceName === 'NamedNode';\n}\n\nexport interface MatchStatement {\n  subject?: string;\n  predicate?: string;\n  object?: string;\n  iri?: string;\n  callback?: (...args: any[]) => void;\n  limit?: number;\n}\n\nexport const LABEL_URIS = [\n  'http://www.w3.org/2004/02/skos/core#prefLabel',\n  'http://www.w3.org/2004/02/skos/core#label',\n  'http://www.w3.org/2004/02/skos/core#altLabel',\n  'http://www.w3.org/2000/01/rdf-schema#prefLabel',\n  'http://www.w3.org/2000/01/rdf-schema#label',\n  'http://xmlns.com/foaf/0.1/name',\n  'http://schema.org/name',\n];\n\nexport const LABEL_POSTFIXES = ['prefLabel', 'prefName', 'label', 'name', 'title'];\n\nexport function isLabelType(predicateIri: string): boolean {\n  const isLabelIri = LABEL_URIS.indexOf(predicateIri) !== -1;\n  const type = predicateIri.toLocaleLowerCase();\n  const looksLikeLabel = Boolean(\n    LABEL_POSTFIXES.find((value, index, array) => {\n      const postfix = value.toLocaleLowerCase();\n      return type.indexOf(postfix) !== -1;\n    })\n  );\n  return isLabelIri || looksLikeLabel;\n}\n\nexport interface RDFStoreOptions {\n  parser: RDFCompositeParser;\n  acceptBlankNodes?: boolean;\n}\n\nexport class RDFCacheableStore {\n  private readonly parser: RDFCompositeParser;\n  private readonly acceptBlankNodes: boolean;\n\n  private readonly rdfStorage: RDFStore;\n  private readonly prefs: { [id: string]: (id: string) => string };\n\n  private checkingElementMap: Dictionary<Promise<boolean>> = {};\n  private labelsMap: Dictionary<Triple[]> = {};\n  private countMap: Dictionary<number> = {};\n  private elementTypes: Dictionary<Triple[]> = {};\n\n  constructor(options: RDFStoreOptions) {\n    this.parser = options.parser;\n    this.acceptBlankNodes = Boolean(options.acceptBlankNodes);\n\n    this.rdfStorage = createStore();\n    this.prefs = {\n      RDF: prefixFactory('http://www.w3.org/1999/02/22-rdf-syntax-ns#'),\n      RDFS: prefixFactory('http://www.w3.org/2000/01/rdf-schema#'),\n      FOAF: prefixFactory('http://xmlns.com/foaf/0.1/'),\n      XSD: prefixFactory('http://www.w3.org/2001/XMLSchema#'),\n      OWL: prefixFactory('http://www.w3.org/2002/07/owl#'),\n    };\n  }\n\n  add(rdfGraph: RDFGraph, prefix?: string) {\n    this.rdfStorage.add(uniqueId(prefix) || uniqueId(DEFAULT_STORAGE_URI), rdfGraph);\n    this.enrichMaps(rdfGraph);\n  }\n\n  match(\n    subject?: string,\n    predicate?: string,\n    object?: string,\n    iri?: string,\n    callback?: (...args: any[]) => void,\n    limit?: number\n  ): Promise<RDFGraph> {\n    if (subject && LABEL_URIS.indexOf(predicate) !== -1 && !object) {\n      return Promise.resolve(this._getLabels(subject));\n    } else if (subject && predicate === this.prefs.RDF('type') && !object) {\n      return Promise.resolve(this.getTypes(subject));\n    } else {\n      return this.rdfStorage.match(subject, predicate, object, iri, callback, limit);\n    }\n  }\n\n  matchAll(statements: MatchStatement[]): Promise<RDFGraph> {\n    const slowQueries: MatchStatement[] = [];\n    const queries: RDFGraph[] = [];\n\n    statements.forEach((statement) => {\n      if (statement.subject && LABEL_URIS.indexOf(statement.predicate) !== -1 && !statement.object) {\n        queries.push(this._getLabels(statement.subject));\n      } else if (statement.subject && statement.predicate === this.prefs.RDF('type') && !statement.object) {\n        queries.push(this.getTypes(statement.subject));\n      } else {\n        slowQueries.push(statement);\n      }\n    });\n\n    queries.push(this.multipleMatch(slowQueries));\n\n    return Promise.resolve(this.combineGraphs(queries));\n  }\n\n  getLabels(id: string): Promise<RDFGraph> {\n    return Promise.resolve(createGraph(this.labelsMap[id]));\n  }\n\n  // Checks whetger the element is in the storage.\n  checkElement(id: string): Promise<boolean> {\n    if (this.labelsMap[id]) {\n      // if there is label for an id then the element is already fetched\n      return Promise.resolve(true);\n    } else {\n      if (!this.checkingElementMap[id]) {\n        this.checkingElementMap[id] = this.rdfStorage.match(id, null, null).then((result) => {\n          const resultArray = result.toArray();\n          return resultArray.length !== 0;\n        });\n      }\n      return this.checkingElementMap[id];\n    }\n  }\n\n  getTypeCount(id: string): number {\n    return this.countMap[id] || 0;\n  }\n\n  private enrichMaps(newGraph: RDFGraph): boolean {\n    const triples = newGraph.toArray();\n\n    // Deal with labels\n    for (const triple of triples) {\n      const element = triple.subject.nominalValue;\n      const predicate = triple.predicate.nominalValue;\n\n      if (isLabelType(predicate)) {\n        if (!this.labelsMap[element]) {\n          this.labelsMap[element] = [];\n        }\n        if (isLiteral(triple.object)) {\n          this.labelsMap[element].push(triple);\n          this.labelsMap[element].sort((a, b) => {\n            const index1 = LABEL_URIS.indexOf(a.predicate.nominalValue);\n            const index2 = LABEL_URIS.indexOf(b.predicate.nominalValue);\n            if (index1 > index2) {\n              return 1;\n            } else if (index1 < index2) {\n              return -1;\n            } else {\n              return 0;\n            }\n          });\n        }\n      }\n    }\n\n    // Deal with counts\n    const typeInstances = newGraph.match(null, this.prefs.RDF('type'), null).toArray();\n    const typeInstMap: Dictionary<string[]> = {};\n    for (const instTriple of typeInstances) {\n      const type = instTriple.object.nominalValue;\n      const inst = instTriple.subject.nominalValue;\n      if (!typeInstMap[type]) {\n        typeInstMap[type] = [];\n      }\n      if (this.acceptBlankNodes || isNamedNode(instTriple.subject)) {\n        if (!this.elementTypes[inst]) {\n          this.elementTypes[inst] = [];\n        }\n        if (typeInstMap[type].indexOf(inst) === -1) {\n          typeInstMap[type].push(inst);\n        }\n        this.elementTypes[inst].push(instTriple);\n      }\n    }\n    Object.keys(typeInstMap).forEach((key) => (this.countMap[key] = typeInstMap[key].length));\n\n    return true;\n  }\n\n  private _getLabels(id: string): RDFGraph {\n    return createGraph(this.labelsMap[id]);\n  }\n\n  private getTypes(id: string): RDFGraph {\n    return createGraph(this.elementTypes[id]);\n  }\n\n  private combineGraphs(graphs: RDFGraph[]): RDFGraph {\n    const triples: Triple[] = [];\n    for (const graph of graphs) {\n      for (const triple of graph.toArray()) {\n        triples.push(triple);\n      }\n    }\n    return createGraph(triples);\n  }\n\n  private multipleMatch(statements: MatchStatement[]): RDFGraph {\n    const triples: Triple[] = [];\n    const graphs = Object.keys(this.rdfStorage.graphs).map((id) => this.rdfStorage.graphs[id]);\n    for (const graph of graphs) {\n      for (const triple of graph._graph) {\n        for (const statement of statements) {\n          if (\n            (!statement.object || statement.object === triple.object.nominalValue) &&\n            (!statement.predicate || statement.predicate === triple.predicate.nominalValue) &&\n            (!statement.subject || statement.subject === triple.subject.nominalValue)\n          ) {\n            triples.push(triple);\n            continue;\n          }\n        }\n      }\n    }\n    return createGraph(triples);\n  }\n}\n","import { RDFGraph } from 'rdf-ext';\nimport { Dictionary } from '../model';\nimport { RDFCompositeParser } from './rdfCompositeParser';\n\nexport const DEFAULT_PROXY = '/lod-proxy/';\n\nexport class RDFLoader {\n  private fetchingFileCatche: Dictionary<Promise<RDFGraph>> = {};\n  public parser: RDFCompositeParser;\n  public proxy: string;\n\n  constructor(parameters: { parser: RDFCompositeParser; proxy?: string }) {\n    this.parser = parameters.parser;\n    this.proxy = parameters.proxy || DEFAULT_PROXY;\n  }\n\n  private parseData(data: string, contentType?: string, prefix?: string): Promise<RDFGraph> {\n    let result: Promise<RDFGraph>;\n    result = this.parser.parse(data, contentType);\n    return result;\n  }\n\n  downloadElement(elementId: string): Promise<RDFGraph> {\n    const sharpIndex = elementId.indexOf('#');\n    const fileUrl = sharpIndex !== -1 ? elementId.substr(0, sharpIndex) : elementId;\n    let typePointer = 0;\n    const mimeTypes = Object.keys(this.parser.parserMap);\n\n    const recursivePart = (): Promise<RDFGraph> => {\n      const acceptType = mimeTypes[typePointer++];\n\n      if (acceptType && (elementId.startsWith('http') || elementId.startsWith('file'))) {\n        return fetchFile({\n          url: elementId,\n          proxy: this.proxy,\n          headers: {\n            Accept: acceptType,\n          },\n        }).then((body: string) => {\n          return this.parseData(body, acceptType, elementId).catch((error) => {\n            // tslint:disable-next-line:no-console\n            console.warn(error);\n            if (typePointer < mimeTypes.length) {\n              return recursivePart();\n            } else {\n              throw new Error(`Unable to parse response. Response: ${body}`);\n            }\n          });\n        });\n      } else {\n        throw new Error(`Unable to fetch data using this id (${elementId})`);\n      }\n    };\n\n    if (!this.fetchingFileCatche[fileUrl]) {\n      this.fetchingFileCatche[fileUrl] = recursivePart();\n    }\n    return this.fetchingFileCatche[fileUrl];\n  }\n}\n\nfunction fetchFile(params: { url: string; proxy: string; headers?: any }) {\n  return fetch(params.proxy + params.url, {\n    method: 'GET',\n    credentials: 'same-origin',\n    mode: 'cors',\n    cache: 'default',\n    headers: params.headers || {\n      Accept: 'application/rdf+xml',\n    },\n  }).then((response) => {\n    if (response.ok) {\n      return response.text();\n    } else {\n      const error = new Error(response.statusText);\n      (error as any).response = response;\n      throw error;\n    }\n  });\n}\n","import { Dictionary } from '../model';\n\nfunction workaroundForRDFXmlParser(body: string) {\n  // For some strange reason we've encountered xml parser errors\n  // when parsing rdf/xml file with Collection tag.\n  // As I remember, file came from x3c Ontology\n  // and this workaround helps to get file through xml parsing.\n  return body.replace(/parseType=[\"']Collection[\"']/gi, 'parseType=\"Collection1\"');\n}\n\nconst POSTFIX_TO_MIME: { [key: string]: string } = {\n  xml: 'application/rdf+xml',\n  rdf: 'application/rdf+xml',\n  owl: 'application/rdf+xml',\n  nttl: 'application/x-turtle',\n  jsonld: 'application/ld+json',\n  rj: 'application/ld+json',\n  ttl: 'text/turtle',\n  nt: 'text/turtle',\n  nq: 'text/turtle',\n};\n\nfunction getMimeTypeByFileName(fileName: string): string {\n  const postfix = (fileName.match(/\\.([\\S]*)$/i) || [])[1];\n  return postfix ? POSTFIX_TO_MIME[postfix] : undefined;\n}\n\nexport class RDFCompositeParser {\n  constructor(public parserMap: Dictionary<any>) {}\n\n  parse(body: string, mimeType?: string, fileName?: string): Promise<any> {\n    if (mimeType) {\n      if (mimeType === 'application/rdf+xml') {\n        body = workaroundForRDFXmlParser(body);\n      }\n      if (!this.parserMap[mimeType]) {\n        throw Error('There is no parser for this MIME type');\n      }\n      return this.parserMap[mimeType].parse(body);\n    } else {\n      return this.tryToGuessMimeType(body, fileName);\n    }\n  }\n\n  private tryToGuessMimeType(body: string, fileName?: string): Promise<any> {\n    let mimeTypeIndex = 0;\n    let mimeTypes = Object.keys(this.parserMap);\n\n    if (fileName) {\n      const mime = getMimeTypeByFileName(fileName);\n      if (mime) {\n        mimeTypes = [mime].concat(mimeTypes.filter((type) => type !== mime));\n      }\n    }\n\n    const errors: Array<{ mimeType: string; error: Error }> = [];\n\n    const recursion = (): Promise<any> => {\n      if (mimeTypeIndex < mimeTypes.length) {\n        const mimeType = mimeTypes[mimeTypeIndex++];\n        try {\n          const bodyToParse = mimeType === 'application/rdf+xml' ? workaroundForRDFXmlParser(body) : body;\n\n          return this.parserMap[mimeType].parse(bodyToParse).catch((error: Error) => {\n            errors.push({ mimeType, error });\n            return recursion();\n          });\n        } catch (error) {\n          return recursion();\n        }\n      } else {\n        throw new Error(\n          'Unknow mime type. Parse errors:\\n' +\n            errors.map((e) => `${e.mimeType}: ${e.error.message} ${e.error.stack};\\n`).join('\\n')\n        );\n      }\n    };\n    return recursion();\n  }\n}\n","import { objectValues, getOrCreateArrayInMap } from '../../viewUtils/collections';\nimport { DataProvider, LinkElementsParams, FilterParams } from '../provider';\nimport {\n  Dictionary,\n  ClassModel,\n  LinkType,\n  ElementModel,\n  LinkModel,\n  LinkCount,\n  PropertyModel,\n  ElementIri,\n  ElementTypeIri,\n  LinkTypeIri,\n  PropertyTypeIri,\n  LocalizedString,\n} from '../model';\nimport {\n  prependAdditionalBindings,\n  enrichElementsWithImages,\n  flattenClassTree,\n  getClassTree,\n  getClassInfo,\n  getPropertyInfo,\n  getLinkTypes,\n  getElementsInfo,\n  getElementTypes,\n  getLinksInfo,\n  getLinksTypeIds,\n  getFilteredData,\n  getLinksTypesOf,\n  getLinkStatistics,\n  triplesToElementBinding,\n  isDirectLink,\n  isDirectProperty,\n} from './responseHandler';\nimport {\n  ClassBinding,\n  ElementBinding,\n  LinkBinding,\n  PropertyBinding,\n  BlankBinding,\n  FilterBinding,\n  LinkCountBinding,\n  LinkTypeBinding,\n  ElementImageBinding,\n  ElementTypeBinding,\n  SparqlResponse,\n  Triple,\n} from './sparqlModels';\nimport {\n  SparqlDataProviderSettings,\n  OWLStatsSettings,\n  LinkConfiguration,\n  PropertyConfiguration,\n} from './sparqlDataProviderSettings';\nimport * as BlankNodes from './blankNodes';\nimport { parseTurtleText } from './turtle';\n\nexport enum SparqlQueryMethod {\n  GET = 1,\n  POST,\n}\n\nexport type QueryFunction = (params: {\n  url: string;\n  body?: string;\n  headers: { [header: string]: string };\n  method: string;\n}) => Promise<Response>;\n\n/**\n * Runtime settings of SPARQL data provider\n */\nexport interface SparqlDataProviderOptions {\n  /**\n   * If it's true then blank nodes will be present on the paper\n   * By default blank nodes wont be shown\n   */\n  acceptBlankNodes?: boolean;\n\n  /**\n   *  sparql endpoint URL to use\n   */\n  endpointUrl: string;\n\n  // there are two options for fetching images: specify imagePropertyUris\n  // to use as image properties or specify a function to fetch image URLs\n\n  /**\n   * properties to use as image URLs\n   */\n  imagePropertyUris?: string[];\n\n  /**\n   * Allows to extract/fetch image URLs externally instead of using `imagePropertyUris` option.\n   */\n  prepareImages?: (elementInfo: Dictionary<ElementModel>) => Promise<Dictionary<string>>;\n\n  /**\n   * Allows to extract/fetch labels separately from SPARQL query as an alternative or\n   * in addition to `label` output binding.\n   */\n  prepareLabels?: (resources: Set<string>) => Promise<Map<string, LocalizedString[]>>;\n\n  /**\n   * wether to use GET (more compatible (Virtuozo), more error-prone due to large request URLs)\n   * or POST(less compatible, better on large data sets)\n   */\n  queryMethod?: SparqlQueryMethod;\n\n  /*\n   * function to send sparql requests\n   */\n  queryFunction?: QueryFunction;\n}\n\nexport class SparqlDataProvider implements DataProvider {\n  readonly options: SparqlDataProviderOptions;\n  readonly settings: SparqlDataProviderSettings;\n\n  private linkByPredicate = new Map<string, LinkConfiguration[]>();\n  private linkById = new Map<LinkTypeIri, LinkConfiguration>();\n  private openWorldLinks: boolean;\n\n  private propertyByPredicate = new Map<string, PropertyConfiguration[]>();\n  private openWorldProperties: boolean;\n\n  constructor(options: SparqlDataProviderOptions, settings: SparqlDataProviderSettings = OWLStatsSettings) {\n    const { queryFunction = queryInternal } = options;\n    this.options = { ...options, queryFunction };\n    this.settings = settings;\n\n    for (const link of settings.linkConfigurations) {\n      this.linkById.set(link.id as LinkTypeIri, link);\n      const predicate = isDirectLink(link) ? link.path : link.id;\n      getOrCreateArrayInMap(this.linkByPredicate, predicate).push(link);\n    }\n    this.openWorldLinks = settings.linkConfigurations.length === 0 || Boolean(settings.openWorldLinks);\n\n    for (const property of settings.propertyConfigurations) {\n      const predicate = isDirectProperty(property) ? property.path : property.id;\n      getOrCreateArrayInMap(this.propertyByPredicate, predicate).push(property);\n    }\n    this.openWorldProperties = settings.propertyConfigurations.length === 0 || Boolean(settings.openWorldProperties);\n  }\n\n  async classTree(): Promise<ClassModel[]> {\n    const { defaultPrefix, schemaLabelProperty, classTreeQuery } = this.settings;\n    if (!classTreeQuery) {\n      return [];\n    }\n\n    const query =\n      defaultPrefix +\n      resolveTemplate(classTreeQuery, {\n        schemaLabelProperty,\n      });\n    const result = await this.executeSparqlQuery<ClassBinding>(query);\n    const classTree = getClassTree(result);\n\n    if (this.options.prepareLabels) {\n      await attachLabels(flattenClassTree(classTree), this.options.prepareLabels);\n    }\n\n    return classTree;\n  }\n\n  async propertyInfo(params: { propertyIds: PropertyTypeIri[] }): Promise<Dictionary<PropertyModel>> {\n    const { defaultPrefix, schemaLabelProperty, propertyInfoQuery } = this.settings;\n\n    let properties: Dictionary<PropertyModel>;\n    if (propertyInfoQuery) {\n      const ids = params.propertyIds\n        .map(escapeIri)\n        .map((id) => ` ( ${id} )`)\n        .join(' ');\n      const query =\n        defaultPrefix +\n        resolveTemplate(propertyInfoQuery, {\n          ids,\n          schemaLabelProperty,\n        });\n      const result = await this.executeSparqlQuery<PropertyBinding>(query);\n      properties = getPropertyInfo(result);\n    } else {\n      properties = {};\n      for (const id of params.propertyIds) {\n        properties[id] = { id, label: { values: [] } };\n      }\n    }\n\n    if (this.options.prepareLabels) {\n      await attachLabels(objectValues(properties), this.options.prepareLabels);\n    }\n\n    return properties;\n  }\n\n  async classInfo(params: { classIds: ElementTypeIri[] }): Promise<ClassModel[]> {\n    const { defaultPrefix, schemaLabelProperty, classInfoQuery } = this.settings;\n\n    let classes: ClassModel[];\n    if (classInfoQuery) {\n      const ids = params.classIds\n        .map(escapeIri)\n        .map((id) => ` ( ${id} )`)\n        .join(' ');\n      const query =\n        defaultPrefix +\n        resolveTemplate(classInfoQuery, {\n          ids,\n          schemaLabelProperty,\n        });\n      const result = await this.executeSparqlQuery<ClassBinding>(query);\n      classes = getClassInfo(result);\n    } else {\n      classes = params.classIds.map((id): ClassModel => ({ id, label: { values: [] }, children: [] }));\n    }\n\n    if (this.options.prepareLabels) {\n      await attachLabels(classes, this.options.prepareLabels);\n    }\n\n    return classes;\n  }\n\n  async linkTypesInfo(params: { linkTypeIds: LinkTypeIri[] }): Promise<LinkType[]> {\n    const { defaultPrefix, schemaLabelProperty, linkTypesInfoQuery } = this.settings;\n\n    let linkTypes: LinkType[];\n    if (linkTypesInfoQuery) {\n      const ids = params.linkTypeIds\n        .map(escapeIri)\n        .map((id) => ` ( ${id} )`)\n        .join(' ');\n      const query =\n        defaultPrefix +\n        resolveTemplate(linkTypesInfoQuery, {\n          ids,\n          schemaLabelProperty,\n        });\n      const result = await this.executeSparqlQuery<LinkTypeBinding>(query);\n      linkTypes = getLinkTypes(result);\n    } else {\n      linkTypes = params.linkTypeIds.map((id): LinkType => ({ id, label: { values: [] } }));\n    }\n\n    if (this.options.prepareLabels) {\n      await attachLabels(linkTypes, this.options.prepareLabels);\n    }\n\n    return linkTypes;\n  }\n\n  async linkTypes(): Promise<LinkType[]> {\n    const { defaultPrefix, schemaLabelProperty, linkTypesQuery, linkTypesPattern } = this.settings;\n    if (!linkTypesQuery) {\n      return [];\n    }\n\n    const query =\n      defaultPrefix +\n      resolveTemplate(linkTypesQuery, {\n        linkTypesPattern,\n        schemaLabelProperty,\n      });\n    const result = await this.executeSparqlQuery<LinkTypeBinding>(query);\n    const linkTypes = getLinkTypes(result);\n\n    if (this.options.prepareLabels) {\n      await attachLabels(linkTypes, this.options.prepareLabels);\n    }\n\n    return linkTypes;\n  }\n\n  async elementInfo(params: { elementIds: ElementIri[] }): Promise<Dictionary<ElementModel>> {\n    const nonBlankResources = params.elementIds.filter((id) => !BlankNodes.isEncodedBlank(id));\n    const blankNodeResponse = this.options.acceptBlankNodes ? BlankNodes.elementInfo(params.elementIds) : undefined;\n\n    let triples: Triple[];\n    if (nonBlankResources.length > 0) {\n      const ids = nonBlankResources\n        .map(escapeIri)\n        .map((id) => ` (${id})`)\n        .join(' ');\n      const { defaultPrefix, dataLabelProperty, elementInfoQuery } = this.settings;\n      const query =\n        defaultPrefix +\n        resolveTemplate(elementInfoQuery, {\n          ids,\n          dataLabelProperty,\n          propertyConfigurations: this.formatPropertyInfo(),\n        });\n      triples = await this.executeSparqlConstruct(query);\n    } else {\n      triples = [];\n    }\n\n    const types = this.queryManyElementTypes(this.settings.propertyConfigurations.length > 0 ? params.elementIds : []);\n\n    const bindings = triplesToElementBinding(triples);\n    const bindingsWithBlanks = prependAdditionalBindings(bindings, blankNodeResponse);\n    const elementModels = getElementsInfo(\n      bindingsWithBlanks,\n      await types,\n      this.propertyByPredicate,\n      this.openWorldProperties\n    );\n\n    if (this.options.prepareLabels) {\n      await attachLabels(objectValues(elementModels), this.options.prepareLabels);\n    }\n\n    if (this.options.prepareImages) {\n      await prepareElementImages(this.options.prepareImages, elementModels);\n    } else if (this.options.imagePropertyUris && this.options.imagePropertyUris.length) {\n      await this.attachImages(elementModels, this.options.imagePropertyUris);\n    }\n\n    return elementModels;\n  }\n\n  private async attachImages(elementsInfo: Dictionary<ElementModel>, types: string[]): Promise<void> {\n    const ids = Object.keys(elementsInfo)\n      .filter((id) => !BlankNodes.isEncodedBlank(id))\n      .map(escapeIri)\n      .map((id) => ` ( ${id} )`)\n      .join(' ');\n    const typesString = types\n      .map(escapeIri)\n      .map((id) => ` ( ${id} )`)\n      .join(' ');\n\n    const query =\n      this.settings.defaultPrefix +\n      `\n            SELECT ?inst ?linkType ?image\n            WHERE {{\n                VALUES (?inst) {${ids}}\n                VALUES (?linkType) {${typesString}}\n                ${this.settings.imageQueryPattern}\n            }}\n        `;\n    try {\n      const bindings = await this.executeSparqlQuery<ElementImageBinding>(query);\n      enrichElementsWithImages(bindings, elementsInfo);\n    } catch (err) {\n      // tslint:disable-next-line:no-console\n      console.error(err);\n    }\n  }\n\n  async linksInfo(params: { elementIds: ElementIri[]; linkTypeIds: LinkTypeIri[] }): Promise<LinkModel[]> {\n    const nonBlankResources = params.elementIds.filter((id) => !BlankNodes.isEncodedBlank(id));\n    const blankNodeResponse = this.options.acceptBlankNodes ? BlankNodes.linksInfo(params.elementIds) : undefined;\n\n    const linkConfigurations = this.formatLinkLinks();\n\n    let bindings: Promise<SparqlResponse<LinkBinding>>;\n    let types: Promise<Map<ElementIri, Set<ElementTypeIri>>>;\n    if (nonBlankResources.length > 0) {\n      const ids = nonBlankResources\n        .map(escapeIri)\n        .map((id) => ` ( ${id} )`)\n        .join(' ');\n      const linksInfoQuery =\n        this.settings.defaultPrefix +\n        resolveTemplate(this.settings.linksInfoQuery, {\n          ids,\n          linkConfigurations,\n        });\n      bindings = this.executeSparqlQuery<LinkBinding>(linksInfoQuery);\n      types = this.queryManyElementTypes(params.elementIds);\n    } else {\n      bindings = Promise.resolve({\n        head: { vars: [] },\n        results: { bindings: [] },\n      });\n      types = this.queryManyElementTypes([]);\n    }\n\n    const bindingsWithBlanks = prependAdditionalBindings(await bindings, blankNodeResponse);\n    const linksInfo = getLinksInfo(bindingsWithBlanks, await types, this.linkByPredicate, this.openWorldLinks);\n    return linksInfo;\n  }\n\n  async linkTypesOf(params: { elementId: ElementIri }): Promise<LinkCount[]> {\n    if (this.options.acceptBlankNodes && BlankNodes.isEncodedBlank(params.elementId)) {\n      return Promise.resolve(getLinksTypesOf(BlankNodes.linkTypesOf(params)));\n    }\n    const { defaultPrefix, linkTypesOfQuery, linkTypesStatisticsQuery, filterTypePattern } = this.settings;\n\n    const elementIri = escapeIri(params.elementId);\n    const forAll = this.formatLinkUnion(params.elementId, undefined, undefined, '?outObject', '?inObject', false);\n    if (forAll.usePredicatePart) {\n      forAll.unionParts.push(`{ ${elementIri} ?link ?outObject }`);\n      forAll.unionParts.push(`{ ?inObject ?link ${elementIri} }`);\n    }\n\n    const query =\n      defaultPrefix +\n      resolveTemplate(linkTypesOfQuery, {\n        elementIri,\n        linkConfigurations: forAll.unionParts.join('\\nUNION\\n'),\n      });\n\n    const linkTypeBindings = await this.executeSparqlQuery<LinkTypeBinding>(query);\n    const linkTypeIds = getLinksTypeIds(linkTypeBindings, this.linkByPredicate, this.openWorldLinks);\n\n    const navigateElementFilterOut = this.options.acceptBlankNodes\n      ? `FILTER (IsIri(?outObject) || IsBlank(?outObject))`\n      : `FILTER IsIri(?outObject)`;\n    const navigateElementFilterIn = this.options.acceptBlankNodes\n      ? `FILTER (IsIri(?inObject) || IsBlank(?inObject))`\n      : `FILTER IsIri(?inObject)`;\n\n    const foundLinkStats: LinkCount[] = [];\n    await Promise.all(\n      linkTypeIds.map(async (linkId) => {\n        const linkConfig = this.linkById.get(linkId);\n        let linkConfigurationOut: string;\n        let linkConfigurationIn: string;\n\n        if (!linkConfig || isDirectLink(linkConfig)) {\n          const predicate = escapeIri(linkConfig && isDirectLink(linkConfig) ? linkConfig.path : linkId);\n          linkConfigurationOut = `${elementIri} ${predicate} ?outObject`;\n          linkConfigurationIn = `?inObject ${predicate} ${elementIri}`;\n        } else {\n          linkConfigurationOut = this.formatLinkPath(linkConfig.path, elementIri, '?outObject');\n          linkConfigurationIn = this.formatLinkPath(linkConfig.path, '?inObject', elementIri);\n        }\n\n        if (linkConfig && linkConfig.domain?.length > 0) {\n          const commaSeparatedDomains = linkConfig.domain.map(escapeIri).join(', ');\n          const restrictionOut = filterTypePattern.replace(/[?$]inst\\b/g, elementIri);\n          const restrictionIn = filterTypePattern.replace(/[?$]inst\\b/g, '?inObject');\n          linkConfigurationOut += ` { ${restrictionOut} FILTER(?class IN (${commaSeparatedDomains})) }`;\n          linkConfigurationIn += ` { ${restrictionIn} FILTER(?class IN (${commaSeparatedDomains})) }`;\n        }\n\n        const statsQuery =\n          defaultPrefix +\n          resolveTemplate(linkTypesStatisticsQuery, {\n            linkId: escapeIri(linkId),\n            elementIri,\n            linkConfigurationOut,\n            linkConfigurationIn,\n            navigateElementFilterOut,\n            navigateElementFilterIn,\n          });\n\n        const bindings = await this.executeSparqlQuery<LinkCountBinding>(statsQuery);\n        const linkStats = getLinkStatistics(bindings);\n        if (linkStats) {\n          foundLinkStats.push(linkStats);\n        }\n      })\n    );\n    return foundLinkStats;\n  }\n\n  linkElements(params: LinkElementsParams): Promise<Dictionary<ElementModel>> {\n    // for sparql we have rich filtering features and we just reuse filter.\n    return this.filter({\n      refElementId: params.elementId,\n      refElementLinkId: params.linkId,\n      linkDirection: params.direction,\n      limit: params.limit,\n      offset: params.offset,\n      languageCode: '',\n    });\n  }\n\n  async filter(baseParams: FilterParams): Promise<Dictionary<ElementModel>> {\n    const params: FilterParams = { ...baseParams };\n    if (params.limit === undefined) {\n      params.limit = 100;\n    }\n\n    // query types to match link configuration domains\n    const types = this.querySingleElementTypes(\n      params.refElementId && this.settings.linkConfigurations.length > 0 ? params.refElementId : undefined\n    );\n\n    const blankFiltration = this.options.acceptBlankNodes ? BlankNodes.filter(params) : undefined;\n    if (blankFiltration && blankFiltration.results.bindings.length > 0) {\n      return getFilteredData(blankFiltration, await types, this.linkByPredicate, this.openWorldLinks);\n    }\n\n    const filterQuery = this.createFilterQuery(params);\n    const bindings = await this.executeSparqlQuery<ElementBinding & FilterBinding>(filterQuery);\n\n    let bindingsWithBlanks: SparqlResponse<ElementBinding & FilterBinding>;\n    if (this.options.acceptBlankNodes) {\n      bindingsWithBlanks = await BlankNodes.updateFilterResults(\n        bindings,\n        (blankQuery) => this.executeSparqlQuery<BlankBinding>(blankQuery),\n        this.settings\n      );\n    } else {\n      bindingsWithBlanks = bindings as SparqlResponse<ElementBinding & FilterBinding>;\n    }\n\n    const elementModels = getFilteredData(bindingsWithBlanks, await types, this.linkByPredicate, this.openWorldLinks);\n\n    if (this.options.prepareLabels) {\n      await attachLabels(objectValues(elementModels), this.options.prepareLabels);\n    }\n\n    return elementModels;\n  }\n\n  private createFilterQuery(params: FilterParams): string {\n    if (!params.refElementId && params.refElementLinkId) {\n      throw new Error('Cannot execute refElementLink filter without refElement');\n    }\n\n    let outerProjection = '?inst ?class ?label ?blankType';\n    let innerProjection = '?inst ?localName';\n\n    let refQueryPart = '';\n    let refQueryTypes = '';\n    if (params.refElementId) {\n      outerProjection += ' ?link ?direction';\n      innerProjection += ' ?link ?direction';\n      refQueryPart = this.createRefQueryPart({\n        elementId: params.refElementId,\n        linkId: params.refElementLinkId,\n        direction: params.linkDirection,\n      });\n\n      if (this.settings.linkConfigurations.length > 0) {\n        outerProjection += ' ?classAll';\n        refQueryTypes = this.settings.filterTypePattern.replace(/[?$]class\\b/g, '?classAll');\n      }\n    }\n\n    let elementTypePart = '';\n    if (params.elementTypeId) {\n      const elementTypeIri = escapeIri(params.elementTypeId);\n      elementTypePart = this.settings.filterTypePattern.replace(/[?$]class\\b/g, elementTypeIri);\n    }\n\n    const { defaultPrefix, fullTextSearch, dataLabelProperty } = this.settings;\n\n    let textSearchPart = '';\n    if (params.text) {\n      innerProjection += ' ?score';\n      if (this.settings.fullTextSearch.extractLabel) {\n        textSearchPart += sparqlExtractLabel('?inst', '?extractedLabel');\n      }\n      textSearchPart = resolveTemplate(fullTextSearch.queryPattern, { text: params.text, dataLabelProperty });\n    }\n\n    const blankNodes = this.options.acceptBlankNodes;\n    if (blankNodes) {\n      outerProjection += ` ${BlankNodes.BLANK_NODE_QUERY_PARAMETERS}`;\n    }\n\n    // in this query we have such complex ORDER BY to get consistent ordering in ontodia instance search: try to order by label, normalizing case and datatype. If there is no labels then order by string representation of the IRI, also normalizing case.\n    return `${defaultPrefix}\n            ${fullTextSearch.prefix}\n\n        SELECT DISTINCT ${outerProjection}\n        WHERE {\n            {\n                SELECT DISTINCT ${innerProjection} WHERE {\n                    ${elementTypePart}\n                    ${refQueryPart}\n                    ${textSearchPart}\n                    ${this.settings.filterAdditionalRestriction}\n                    BIND(REPLACE(LCASE(STR(?inst)), '(^.*)(#|/)([^/]*)$', '$3') AS ?localName)\n                    OPTIONAL { ?inst ${dataLabelProperty} ?label }\n                }\n                ORDER BY ${textSearchPart ? 'DESC(?score)' : ''} ASC(STR(LCASE(?label))) ASC(?localName)\n                LIMIT ${params.limit} OFFSET ${params.offset}\n            }\n            ${refQueryTypes}\n            ${resolveTemplate(this.settings.filterElementInfoPattern, { dataLabelProperty })}\n            ${blankNodes ? BlankNodes.BLANK_NODE_QUERY : ''}\n        }\n        ORDER BY ${textSearchPart ? 'DESC(?score)' : ''} ASC(STR(LCASE(?label))) ASC(?localName)\n        `;\n  }\n\n  executeSparqlQuery<Binding>(query: string) {\n    const method = this.options.queryMethod ? this.options.queryMethod : SparqlQueryMethod.GET;\n    return executeSparqlQuery<Binding>(this.options.endpointUrl, query, method, this.options.queryFunction);\n  }\n\n  executeSparqlConstruct(query: string): Promise<Triple[]> {\n    const method = this.options.queryMethod ? this.options.queryMethod : SparqlQueryMethod.GET;\n    return executeSparqlConstruct(this.options.endpointUrl, query, method, this.options.queryFunction);\n  }\n\n  protected createRefQueryPart(params: { elementId: ElementIri; linkId?: LinkTypeIri; direction?: 'in' | 'out' }) {\n    const { elementId, linkId, direction } = params;\n\n    const { unionParts, usePredicatePart } = this.formatLinkUnion(elementId, linkId, direction, '?inst', '?inst', true);\n\n    if (usePredicatePart) {\n      const refElementIRI = escapeIri(params.elementId);\n      let refLinkType: string | undefined;\n      if (linkId) {\n        const link = this.linkById.get(linkId);\n        refLinkType = link && isDirectLink(link) ? escapeIri(link.path) : escapeIri(linkId);\n      }\n\n      const linkPattern = refLinkType || '?link';\n      const bindType = refLinkType ? `BIND(${refLinkType} as ?link)` : '';\n      // FILTER ISIRI is used to prevent blank nodes appearing in results\n      const blankFilter = this.options.acceptBlankNodes\n        ? 'FILTER(isIri(?inst) || isBlank(?inst))'\n        : 'FILTER(isIri(?inst))';\n\n      if (!direction || direction === 'out') {\n        unionParts.push(\n          `{ ${refElementIRI} ${linkPattern} ?inst BIND(\"out\" as ?direction) ${bindType} ${blankFilter} }`\n        );\n      }\n      if (!direction || direction === 'in') {\n        unionParts.push(\n          `{ ?inst ${linkPattern} ${refElementIRI} BIND(\"in\" as ?direction) ${bindType} ${blankFilter} }`\n        );\n      }\n    }\n\n    let resultPattern = unionParts.length === 0 ? 'FILTER(false)' : unionParts.join(`\\nUNION\\n`);\n\n    const useAllLinksPattern = !linkId && this.settings.filterRefElementLinkPattern.length > 0;\n    if (useAllLinksPattern) {\n      resultPattern += `\\n${this.settings.filterRefElementLinkPattern}`;\n    }\n\n    return resultPattern;\n  }\n\n  private formatLinkUnion(\n    refElementIri: ElementIri,\n    linkIri: LinkTypeIri | undefined,\n    direction: 'in' | 'out' | undefined,\n    outElementVar: string,\n    inElementVar: string,\n    bindDirection: boolean\n  ) {\n    const { linkConfigurations } = this.settings;\n    const fixedIri = escapeIri(refElementIri);\n\n    const unionParts: string[] = [];\n    let hasDirectLink = false;\n\n    for (const link of linkConfigurations) {\n      if (linkIri && link.id !== linkIri) {\n        continue;\n      }\n      if (isDirectLink(link)) {\n        hasDirectLink = true;\n      } else {\n        const linkType = escapeIri(link.id);\n        if (!direction || direction === 'out') {\n          const path = this.formatLinkPath(link.path, fixedIri, outElementVar);\n          const boundedDirection = bindDirection ? `BIND(\"out\" as ?direction) ` : '';\n          unionParts.push(`{ ${path} BIND(${linkType} as ?link) ${boundedDirection}}`);\n        }\n        if (!direction || direction === 'in') {\n          const path = this.formatLinkPath(link.path, inElementVar, fixedIri);\n          const boundedDirection = bindDirection ? `BIND(\"in\" as ?direction) ` : '';\n          unionParts.push(`{ ${path} BIND(${linkType} as ?link) ${boundedDirection}}`);\n        }\n      }\n    }\n\n    const usePredicatePart = this.openWorldLinks || hasDirectLink;\n    return { unionParts, usePredicatePart };\n  }\n\n  formatLinkLinks(): string {\n    const unionParts: string[] = [];\n    let hasDirectLink = false;\n    for (const link of this.settings.linkConfigurations) {\n      if (isDirectLink(link)) {\n        hasDirectLink = true;\n      } else {\n        const linkType = escapeIri(link.id);\n        unionParts.push(`{ ${this.formatLinkPath(link.path, '?source', '?target')} BIND(${linkType} as ?type) }`);\n      }\n    }\n\n    const usePredicatePart = this.openWorldLinks || hasDirectLink;\n    if (usePredicatePart) {\n      unionParts.push(`{ ?source ?type ?target }`);\n    }\n\n    return unionParts.join('\\nUNION\\n');\n  }\n\n  formatLinkPath(path: string, source: string, target: string): string {\n    return path.replace(/[?$]source\\b/g, source).replace(/[?$]target\\b/g, target);\n  }\n\n  formatPropertyInfo(): string {\n    const unionParts: string[] = [];\n    let hasDirectProperty = false;\n    for (const property of this.settings.propertyConfigurations) {\n      if (isDirectProperty(property)) {\n        hasDirectProperty = true;\n      } else {\n        const propType = escapeIri(property.id);\n        const formatted = this.formatPropertyPath(property.path, '?inst', '?propValue');\n        unionParts.push(`{ ${formatted} BIND(${propType} as ?propType) }`);\n      }\n    }\n\n    const usePredicatePart = this.openWorldProperties || hasDirectProperty;\n    if (usePredicatePart) {\n      unionParts.push(`{ ?inst ?propType ?propValue }`);\n    }\n\n    return unionParts.join('\\nUNION\\n');\n  }\n\n  formatPropertyPath(path: string, subject: string, value: string): string {\n    return path.replace(/[?$]inst\\b/g, subject).replace(/[?$]value\\b/g, value);\n  }\n\n  private async querySingleElementTypes(element: ElementIri | undefined): Promise<Set<ElementTypeIri> | undefined> {\n    const types = await this.queryManyElementTypes(element ? [element] : []);\n    return types.get(element);\n  }\n\n  private async queryManyElementTypes(\n    elements: ReadonlyArray<ElementIri>\n  ): Promise<Map<ElementIri, Set<ElementTypeIri>>> {\n    if (elements.length === 0) {\n      return new Map();\n    }\n    const { filterTypePattern } = this.settings;\n    const ids = elements\n      .filter((iri) => !BlankNodes.isEncodedBlank(iri))\n      .map((iri) => `(${escapeIri(iri)})`)\n      .join(' ');\n\n    // Make sure that all entities are always typed as rdfs:Resource, even if not explicitly defined.\n    // This is quite useful in authoring mode, so we can attach rdf:type and rdfs:label to all entities, even if they are not explicitly typed\n    const queryTemplate = `\n              SELECT ?inst ?class {\n                VALUES(?inst) { \\${ids} }\n                {\n                  \\${filterTypePattern}\n                } UNION {\n                  BIND(rdfs:Resource as ?class)\n                }\n              }\n            `;\n    const query = resolveTemplate(queryTemplate, { ids, filterTypePattern });\n    let response = await this.executeSparqlQuery<ElementTypeBinding>(query);\n\n    if (this.options.acceptBlankNodes && elements.find(BlankNodes.isEncodedBlank)) {\n      const blankResponse = BlankNodes.getElementTypes(elements);\n      response = prependAdditionalBindings(response, blankResponse);\n    }\n\n    return getElementTypes(response);\n  }\n}\n\ninterface LabeledItem {\n  id: string;\n  label: { values: LocalizedString[] };\n}\n\nasync function attachLabels(\n  items: ReadonlyArray<LabeledItem>,\n  fetchLabels: SparqlDataProviderOptions['prepareLabels']\n): Promise<void> {\n  const resources = new Set<string>();\n  for (const item of items) {\n    if (BlankNodes.isEncodedBlank(item.id)) {\n      continue;\n    }\n    resources.add(item.id);\n  }\n  const labels = await fetchLabels(resources);\n  for (const item of items) {\n    if (labels.has(item.id)) {\n      item.label = { values: labels.get(item.id) };\n    }\n  }\n}\n\nfunction prepareElementImages(\n  fetchImages: SparqlDataProviderOptions['prepareImages'],\n  elementsInfo: Dictionary<ElementModel>\n): Promise<void> {\n  return fetchImages(elementsInfo).then((images) => {\n    for (const iri in images) {\n      if (Object.prototype.hasOwnProperty.call(images, iri) && elementsInfo[iri]) {\n        elementsInfo[iri].image = images[iri];\n      }\n    }\n  });\n}\n\nfunction resolveTemplate(template: string, values: Dictionary<string>) {\n  let result = template;\n  for (const replaceKey in values) {\n    if (!values.hasOwnProperty(replaceKey)) {\n      continue;\n    }\n    const replaceValue = values[replaceKey];\n    if (replaceValue) {\n      result = result.replace(new RegExp('\\\\${' + replaceKey + '}', 'g'), replaceValue);\n    }\n  }\n  return result;\n}\n\nexport function executeSparqlQuery<Binding>(\n  endpoint: string,\n  query: string,\n  method: SparqlQueryMethod,\n  queryFunction: QueryFunction\n): Promise<SparqlResponse<Binding>> {\n  let internalQuery: Promise<Response>;\n  if (method === SparqlQueryMethod.GET) {\n    internalQuery = queryFunction({\n      url: appendQueryParams(endpoint, { query }),\n      headers: {\n        Accept: 'application/sparql-results+json',\n      },\n      method: 'GET',\n    });\n  } else {\n    internalQuery = queryFunction({\n      url: endpoint,\n      body: query,\n      headers: {\n        Accept: 'application/sparql-results+json',\n        'Content-Type': 'application/sparql-query; charset=UTF-8',\n      },\n      method: 'POST',\n    });\n  }\n  return internalQuery.then(\n    (response): Promise<SparqlResponse<Binding>> => {\n      if (response.ok) {\n        return response.json();\n      } else {\n        const error = new Error(response.statusText);\n        (error as any).response = response;\n        throw error;\n      }\n    }\n  );\n}\n\nexport function executeSparqlConstruct(\n  endpoint: string,\n  query: string,\n  method: SparqlQueryMethod,\n  queryFunction: QueryFunction\n): Promise<Triple[]> {\n  let internalQuery: Promise<Response>;\n  if (method === SparqlQueryMethod.GET) {\n    internalQuery = queryFunction({\n      url: appendQueryParams(endpoint, { query }),\n      headers: {\n        Accept: 'text/turtle',\n      },\n      method: 'GET',\n    });\n  } else {\n    internalQuery = queryFunction({\n      url: endpoint,\n      body: query,\n      headers: {\n        Accept: 'text/turtle',\n        'Content-Type': 'application/sparql-query; charset=UTF-8',\n      },\n      method: 'POST',\n    });\n  }\n  return internalQuery\n    .then((response) => {\n      if (response.ok) {\n        return response.text();\n      } else {\n        const error = new Error(response.statusText);\n        (error as any).response = response;\n        throw error;\n      }\n    })\n    .then(parseTurtleText);\n}\n\nfunction appendQueryParams(endpoint: string, queryParams: { [key: string]: string } = {}) {\n  const initialSeparator = endpoint.indexOf('?') < 0 ? '?' : '&';\n  const additionalParams =\n    initialSeparator +\n    Object.keys(queryParams)\n      .map((key) => `${key}=${encodeURIComponent(queryParams[key])}`)\n      .join('&');\n  return endpoint + additionalParams;\n}\n\nfunction queryInternal(params: { url: string; body?: string; headers: any; method: string }) {\n  return fetch(params.url, {\n    method: params.method,\n    body: params.body,\n    credentials: 'same-origin',\n    mode: 'cors',\n    cache: 'default',\n    headers: params.headers,\n  });\n}\n\nfunction sparqlExtractLabel(subject: string, label: string): string {\n  return `\n        BIND ( str( ${subject} ) as ?uriStr)\n        BIND ( strafter(?uriStr, \"#\") as ?label3)\n        BIND ( strafter(strafter(?uriStr, \"//\"), \"/\") as ?label6)\n        BIND ( strafter(?label6, \"/\") as ?label5)\n        BIND ( strafter(?label5, \"/\") as ?label4)\n        BIND (if (?label3 != \"\", ?label3,\n            if (?label4 != \"\", ?label4,\n            if (?label5 != \"\", ?label5, ?label6))) as ${label})\n    `;\n}\n\nfunction escapeIri(iri: string) {\n  if (typeof iri !== 'string') {\n    throw new Error(`Cannot escape IRI of type \"${typeof iri}\"`);\n  }\n  return `<${iri}>`;\n}\n","import { LinkConfiguration, PropertyConfiguration } from './sparqlDataProviderSettings';\nimport {\n  RdfLiteral,\n  isRdfLiteral,\n  SparqlResponse,\n  ClassBinding,\n  ElementBinding,\n  LinkBinding,\n  isRdfIri,\n  isRdfBlank,\n  RdfIri,\n  ElementImageBinding,\n  LinkCountBinding,\n  LinkTypeBinding,\n  PropertyBinding,\n  ElementTypeBinding,\n  FilterBinding,\n  Triple,\n} from './sparqlModels';\nimport {\n  Dictionary,\n  LocalizedString,\n  LinkType,\n  ClassModel,\n  ElementModel,\n  LinkModel,\n  Property,\n  PropertyModel,\n  LinkCount,\n  ElementIri,\n  ElementTypeIri,\n  LinkTypeIri,\n  PropertyTypeIri,\n  isIriProperty,\n  isLiteralProperty,\n  sameLink,\n  hashLink,\n} from '../model';\nimport { HashMap, getOrCreateSetInMap } from '../../viewUtils/collections';\n\n// This URIs are used as predicates in the result of the elementInfoQuery construct query\n// to distinguish element labels and types.\nconst LABEL_URI = 'https://ontodia.org/context/v1.json/label';\nconst RDF_TYPE_URI = 'https://ontodia.org/context/v1.json/type';\n\nconst EMPTY_MAP: ReadonlyMap<any, any> = new Map();\n\nexport function getClassTree(response: SparqlResponse<ClassBinding>): ClassModel[] {\n  const treeNodes = createClassMap(response.results.bindings);\n  const allNodes: ClassModel[] = [];\n\n  // createClassMap ensures we get both elements and parents and we can use treeNodes[treeNode.parent] safely\n  treeNodes.forEach((node) => {\n    allNodes.push(node);\n    node.parents.forEach((parent) => {\n      treeNodes.get(parent).children.push(node);\n    });\n    node.parents = undefined;\n  });\n\n  const withoutCycles = breakCyclesAndCalculateCounts(allNodes);\n  const leafs = new Set<ElementTypeIri>();\n  for (const node of withoutCycles) {\n    for (const child of node.children) {\n      leafs.add(child.id);\n    }\n  }\n\n  const tree = withoutCycles.filter((node) => !leafs.has(node.id));\n  return tree;\n}\n\nexport function flattenClassTree(classTree: ReadonlyArray<ClassModel>) {\n  const all: ClassModel[] = [];\n  const visitClasses = (classes: ReadonlyArray<ClassModel>) => {\n    for (const model of classes) {\n      all.push(model);\n      visitClasses(model.children);\n    }\n  };\n  visitClasses(classTree);\n  return all;\n}\n\n/**\n * This extension of ClassModel is used only in processing, parent links are not needed in UI (yet?)\n */\ninterface HierarchicalClassModel extends ClassModel {\n  parents?: Set<ElementTypeIri>;\n}\n\nfunction createClassMap(bindings: ClassBinding[]): Map<ElementTypeIri, HierarchicalClassModel> {\n  const treeNodes = new Map<ElementTypeIri, HierarchicalClassModel>();\n\n  for (const binding of bindings) {\n    if (!isRdfIri(binding.class)) {\n      continue;\n    }\n    const classIri = binding.class.value as ElementTypeIri;\n\n    let node = treeNodes.get(classIri);\n    if (!node) {\n      node = createEmptyModel(classIri);\n      treeNodes.set(classIri, node);\n    }\n\n    if (binding.label) {\n      appendLabel(node.label, getLocalizedString(binding.label));\n    }\n    if (binding.parent) {\n      const parentIri = binding.parent.value as ElementTypeIri;\n      node.parents.add(parentIri);\n    }\n    if (binding.instcount) {\n      node.count = getInstCount(binding.instcount);\n    }\n  }\n\n  // ensuring parent will always be there\n  for (const binding of bindings) {\n    if (binding.parent) {\n      const parentIri = binding.parent.value as ElementTypeIri;\n      if (!treeNodes.has(parentIri)) {\n        treeNodes.set(parentIri, createEmptyModel(parentIri));\n      }\n    }\n  }\n\n  function createEmptyModel(iri: ElementTypeIri): HierarchicalClassModel {\n    return {\n      id: iri as ElementTypeIri,\n      children: [],\n      label: { values: [] },\n      count: undefined,\n      parents: new Set<ElementTypeIri>(),\n    };\n  }\n\n  return treeNodes;\n}\n\nfunction breakCyclesAndCalculateCounts(tree: ClassModel[]): ClassModel[] {\n  const visiting = new Set<ElementTypeIri>();\n\n  function reduceChildren(acc: ClassModel[], node: ClassModel): ClassModel[] {\n    if (visiting.has(node.id)) {\n      // prevent unbounded recursion\n      return acc;\n    }\n    // no more to count\n    if (!node.children) {\n      return;\n    }\n    // ensure all children have their counts completed;\n    visiting.add(node.id);\n    node.children = node.children.reduce(reduceChildren, []);\n    visiting.delete(node.id);\n    // we have to preserve no data here. If nor element nor childs have no count information,\n    // we just pass undefined upwards.\n    let childCount: number;\n\n    node.children.forEach(({ count }) => {\n      if (count === undefined) {\n        return;\n      }\n\n      childCount = childCount === undefined ? count : childCount + count;\n    });\n\n    if (childCount !== undefined) {\n      node.count = node.count === undefined ? childCount : node.count + childCount;\n    }\n\n    acc.push(node);\n    return acc;\n  }\n\n  return tree.reduce(reduceChildren, []);\n}\n\nexport function getClassInfo(response: SparqlResponse<ClassBinding>): ClassModel[] {\n  const classes: { [id: string]: ClassModel } = {};\n  for (const binding of response.results.bindings) {\n    if (!binding.class) {\n      continue;\n    }\n    const id = binding.class.value as ElementTypeIri;\n    const model = classes[id];\n    if (model) {\n      appendLabel(model.label, getLocalizedString(binding.label));\n      const instanceCount = getInstCount(binding.instcount);\n      if (instanceCount !== undefined) {\n        model.count = Math.max(model.count, instanceCount);\n      }\n    } else {\n      const label = getLocalizedString(binding.label);\n      classes[id] = {\n        id,\n        children: [],\n        label: { values: label ? [label] : [] },\n        count: getInstCount(binding.instcount),\n      };\n    }\n  }\n\n  const classesList: ClassModel[] = [];\n  for (const id in classes) {\n    if (!classes.hasOwnProperty(id)) {\n      continue;\n    }\n    const model = classes[id];\n    classesList.push(model);\n  }\n\n  return classesList;\n}\n\nexport function getPropertyInfo(response: SparqlResponse<PropertyBinding>): Dictionary<PropertyModel> {\n  const models: Dictionary<PropertyModel> = {};\n\n  for (const sProperty of response.results.bindings) {\n    const sPropertyTypeId = sProperty.property.value as PropertyTypeIri;\n    if (models[sPropertyTypeId]) {\n      if (sProperty.label) {\n        const label = models[sPropertyTypeId].label;\n        if (label.values.length === 1 && !label.values[0].language) {\n          label.values = [];\n        }\n        label.values.push(getLocalizedString(sProperty.label));\n      }\n    } else {\n      models[sPropertyTypeId] = getPropertyModel(sProperty);\n    }\n  }\n  return models;\n}\n\nexport function getLinkTypes(response: SparqlResponse<LinkTypeBinding>): LinkType[] {\n  const sInst = response.results.bindings;\n  const linkTypes: LinkType[] = [];\n  const linkTypesMap: Dictionary<LinkType> = {};\n\n  for (const sLink of sInst) {\n    const sInstTypeId = sLink.link.value as LinkTypeIri;\n    if (linkTypesMap[sInstTypeId]) {\n      if (sLink.label) {\n        const label = linkTypesMap[sInstTypeId].label;\n        if (label.values.length === 1 && !label.values[0].language) {\n          label.values = [];\n        }\n        label.values.push(getLocalizedString(sLink.label));\n      }\n    } else {\n      linkTypesMap[sInstTypeId] = getLinkTypeInfo(sLink);\n      linkTypes.push(linkTypesMap[sInstTypeId]);\n    }\n  }\n\n  return linkTypes;\n}\n\nexport function triplesToElementBinding(triples: Triple[]): SparqlResponse<ElementBinding> {\n  const map: Dictionary<ElementBinding> = {};\n  const convertedResponse: SparqlResponse<ElementBinding> = {\n    head: {\n      vars: ['inst', 'class', 'label', 'blankType', 'propType', 'propValue'],\n    },\n    results: {\n      bindings: [],\n    },\n  };\n  for (const triple of triples) {\n    const trippleId = triple.subject.value;\n    if (!map[trippleId]) {\n      map[trippleId] = createAndPushBinding(triple);\n    }\n\n    if (triple.predicate.value === LABEL_URI && isRdfLiteral(triple.object)) {\n      // Label\n      if (map[trippleId].label) {\n        map[trippleId] = createAndPushBinding(triple);\n      }\n      map[trippleId].label = triple.object;\n    } else if (\n      // Class\n      triple.predicate.value === RDF_TYPE_URI &&\n      isRdfIri(triple.object) &&\n      isRdfIri(triple.predicate)\n    ) {\n      if (map[trippleId].class) {\n        map[trippleId] = createAndPushBinding(triple);\n      }\n      map[trippleId].class = triple.object;\n    } else if (!isRdfBlank(triple.object) && isRdfIri(triple.predicate)) {\n      // Property\n      if (map[trippleId].propType) {\n        map[trippleId] = createAndPushBinding(triple);\n      }\n      map[trippleId].propType = triple.predicate;\n      map[trippleId].propValue = triple.object;\n    }\n  }\n\n  function createAndPushBinding(tripple: Triple): ElementBinding {\n    const binding: ElementBinding = {\n      inst: tripple.subject as RdfIri,\n    };\n    convertedResponse.results.bindings.push(binding);\n    return binding;\n  }\n\n  return convertedResponse;\n}\n\nexport function getElementsInfo(\n  response: SparqlResponse<ElementBinding>,\n  types: ReadonlyMap<ElementIri, ReadonlySet<ElementTypeIri>> = EMPTY_MAP,\n  propertyByPredicate: ReadonlyMap<string, readonly PropertyConfiguration[]> = EMPTY_MAP,\n  openWorldProperties = true\n): Dictionary<ElementModel> {\n  const instancesMap: Dictionary<ElementModel> = {};\n\n  for (const binding of response.results.bindings) {\n    if (!isRdfIri(binding.inst)) {\n      continue;\n    }\n    const iri = binding.inst.value as ElementIri;\n    let model = instancesMap[iri];\n    if (!model) {\n      model = emptyElementInfo(iri);\n      instancesMap[iri] = model;\n    }\n    enrichElement(model, binding);\n  }\n\n  if (!openWorldProperties || propertyByPredicate.size > 0) {\n    for (const iri in instancesMap) {\n      if (!Object.hasOwnProperty.call(instancesMap, iri)) {\n        continue;\n      }\n      const model = instancesMap[iri];\n      const modelTypes = types.get(model.id);\n      model.properties = mapPropertiesByConfig(model, modelTypes, propertyByPredicate, openWorldProperties);\n    }\n  }\n\n  return instancesMap;\n}\n\nfunction mapPropertiesByConfig(\n  model: ElementModel,\n  modelTypes: ReadonlySet<ElementTypeIri> | undefined,\n  propertyByPredicate: ReadonlyMap<string, readonly PropertyConfiguration[]>,\n  openWorldProperties: boolean\n): ElementModel['properties'] {\n  const mapped: ElementModel['properties'] = {};\n  for (const propertyIri in model.properties) {\n    if (!Object.hasOwnProperty.call(model.properties, propertyIri)) {\n      continue;\n    }\n    const properties = propertyByPredicate.get(propertyIri);\n    if (properties && properties.length > 0) {\n      for (const property of properties) {\n        if (typeMatchesDomain(property, modelTypes)) {\n          mapped[property.id] = model.properties[propertyIri];\n        }\n      }\n    } else if (openWorldProperties) {\n      mapped[propertyIri] = model.properties[propertyIri];\n    }\n  }\n  return mapped;\n}\n\nexport function enrichElementsWithImages(\n  response: SparqlResponse<ElementImageBinding>,\n  elementsInfo: Dictionary<ElementModel>\n): void {\n  const respElements = response.results.bindings;\n  for (const respEl of respElements) {\n    const elementInfo = elementsInfo[respEl.inst.value];\n    if (elementInfo) {\n      elementInfo.image = respEl.image.value;\n    }\n  }\n}\n\nexport function getElementTypes(response: SparqlResponse<ElementTypeBinding>): Map<ElementIri, Set<ElementTypeIri>> {\n  const types = new Map<ElementIri, Set<ElementTypeIri>>();\n  for (const binding of response.results.bindings) {\n    if (isRdfIri(binding.inst) && isRdfIri(binding.class)) {\n      const element = binding.inst.value as ElementIri;\n      const type = binding.class.value as ElementTypeIri;\n      getOrCreateSetInMap(types, element).add(type);\n    }\n  }\n  return types;\n}\n\nexport function getLinksInfo(\n  response: SparqlResponse<LinkBinding>,\n  types: ReadonlyMap<ElementIri, ReadonlySet<ElementTypeIri>> = EMPTY_MAP,\n  linkByPredicateType: ReadonlyMap<string, readonly LinkConfiguration[]> = EMPTY_MAP,\n  openWorldLinks: boolean = true\n): LinkModel[] {\n  const sparqlLinks = response.results.bindings;\n  const links = new HashMap<LinkModel, LinkModel>(hashLink, sameLink);\n\n  for (const binding of sparqlLinks) {\n    const model: LinkModel = {\n      sourceId: binding.source.value as ElementIri,\n      linkTypeId: binding.type.value as LinkTypeIri,\n      targetId: binding.target.value as ElementIri,\n      properties: {},\n    };\n    if (links.has(model)) {\n      // this can only happen due to error in sparql or when merging properties\n      if (binding.propType) {\n        const existing = links.get(model);\n        mergeProperties(existing.properties, binding.propType, binding.propValue);\n      }\n    } else {\n      if (binding.propType) {\n        mergeProperties(model.properties, binding.propType, binding.propValue);\n      }\n      const linkConfigs = linkByPredicateType.get(model.linkTypeId);\n      if (linkConfigs && linkConfigs.length > 0) {\n        for (const linkConfig of linkConfigs) {\n          if (typeMatchesDomain(linkConfig, types.get(model.sourceId))) {\n            const mappedModel: LinkModel = isDirectLink(linkConfig)\n              ? { ...model, linkTypeId: linkConfig.id as LinkTypeIri }\n              : model;\n            links.set(mappedModel, mappedModel);\n          }\n        }\n      } else if (openWorldLinks) {\n        links.set(model, model);\n      }\n    }\n  }\n\n  const linkArray: LinkModel[] = [];\n  links.forEach((value) => linkArray.push(value));\n  return linkArray;\n}\n\nexport function getLinksTypesOf(response: SparqlResponse<LinkCountBinding>): LinkCount[] {\n  const sparqlLinkTypes = response.results.bindings.filter((b) => !isRdfBlank(b.link));\n  return sparqlLinkTypes.map((sLink: LinkCountBinding) => getLinkCount(sLink));\n}\n\nexport function getLinksTypeIds(\n  response: SparqlResponse<LinkTypeBinding>,\n  linkByPredicateType: ReadonlyMap<string, readonly LinkConfiguration[]> = EMPTY_MAP,\n  openWorldLinks: boolean = true\n): LinkTypeIri[] {\n  const linkTypes: LinkTypeIri[] = [];\n  for (const binding of response.results.bindings) {\n    if (!isRdfIri(binding.link)) {\n      continue;\n    }\n    const linkConfigs = linkByPredicateType.get(binding.link.value);\n    if (linkConfigs && linkConfigs.length > 0) {\n      for (const linkConfig of linkConfigs) {\n        const mappedLinkType = isDirectLink(linkConfig) ? linkConfig.id : binding.link.value;\n        linkTypes.push(mappedLinkType as LinkTypeIri);\n      }\n    } else if (openWorldLinks) {\n      linkTypes.push(binding.link.value as LinkTypeIri);\n    }\n  }\n  return linkTypes;\n}\n\nexport function getLinkStatistics(response: SparqlResponse<LinkCountBinding>): LinkCount | undefined {\n  for (const binding of response.results.bindings) {\n    if (isRdfIri(binding.link)) {\n      return getLinkCount(binding);\n    }\n  }\n  return undefined;\n}\n\nexport function getFilteredData(\n  response: SparqlResponse<ElementBinding & FilterBinding>,\n  sourceTypes?: ReadonlySet<ElementTypeIri>,\n  linkByPredicateType: ReadonlyMap<string, readonly LinkConfiguration[]> = EMPTY_MAP,\n  openWorldLinks: boolean = true\n): Dictionary<ElementModel> {\n  const instancesMap: Dictionary<ElementModel> = {};\n  const resultTypes = new Map<ElementIri, Set<ElementTypeIri>>();\n  const outPredicates = new Map<ElementIri, Set<string>>();\n  const inPredicates = new Map<ElementIri, Set<string>>();\n\n  for (const binding of response.results.bindings) {\n    if (!isRdfIri(binding.inst) && !isRdfBlank(binding.inst)) {\n      continue;\n    }\n\n    const iri = binding.inst.value as ElementIri;\n    let model = instancesMap[iri];\n    if (!model) {\n      model = emptyElementInfo(iri);\n      instancesMap[iri] = model;\n    }\n    enrichElement(model, binding);\n\n    if (isRdfIri(binding.classAll)) {\n      getOrCreateSetInMap(resultTypes, iri).add(binding.classAll.value as ElementTypeIri);\n    }\n\n    if (!openWorldLinks && binding.link && binding.direction) {\n      const predicates = binding.direction.value === 'out' ? outPredicates : inPredicates;\n      getOrCreateSetInMap(predicates, model.id).add(binding.link.value);\n    }\n  }\n\n  if (!openWorldLinks) {\n    for (const id of Object.keys(instancesMap)) {\n      const model = instancesMap[id];\n      const targetTypes = resultTypes.get(model.id);\n      const doesMatchesDomain =\n        matchesDomainForLink(sourceTypes, outPredicates.get(model.id), linkByPredicateType) &&\n        matchesDomainForLink(targetTypes, inPredicates.get(model.id), linkByPredicateType);\n      if (!doesMatchesDomain) {\n        delete instancesMap[id];\n      }\n    }\n  }\n\n  return instancesMap;\n}\n\nfunction matchesDomainForLink(\n  types: ReadonlySet<ElementTypeIri> | undefined,\n  predicates: Set<string> | undefined,\n  linkByPredicateType: ReadonlyMap<string, readonly LinkConfiguration[]>\n) {\n  if (!predicates) {\n    return true;\n  }\n\n  let hasMatch = false;\n  predicates.forEach((predicate) => {\n    const matched = linkByPredicateType.get(predicate);\n    if (matched) {\n      for (const link of matched) {\n        if (typeMatchesDomain(link, types)) {\n          hasMatch = true;\n        }\n      }\n    }\n  });\n  return hasMatch;\n}\n\nexport function isDirectLink(link: LinkConfiguration) {\n  // link configuration is path-based if includes any variables\n  const pathBased = /[?$][a-zA-Z]+\\b/.test(link.path);\n  return !pathBased;\n}\n\nexport function isDirectProperty(property: PropertyConfiguration) {\n  // property configuration is path-based if includes any variables\n  const pathBased = /[?$][a-zA-Z]+\\b/.test(property.path);\n  return !pathBased;\n}\n\nfunction typeMatchesDomain(\n  config: { readonly domain?: ReadonlyArray<string> },\n  types: ReadonlySet<ElementTypeIri> | undefined\n): boolean {\n  if (!config.domain || config.domain.length === 0) {\n    return true;\n  } else if (!types) {\n    return false;\n  } else {\n    for (const type of config.domain) {\n      if (types.has(type as ElementTypeIri)) {\n        return true;\n      }\n    }\n    return false;\n  }\n}\n\n/**\n * Modifies properties with merging with new values, couls be new peroperty or new value for existing properties.\n * @param properties\n * @param propType\n * @param propValue\n */\nfunction mergeProperties(properties: { [id: string]: Property }, propType: RdfIri, propValue: RdfIri | RdfLiteral) {\n  let property = properties[propType.value];\n  if (isRdfIri(propValue)) {\n    if (!property) {\n      property = { type: 'uri', values: [] };\n    }\n    if (isIriProperty(property) && property.values.every(({ value }) => value !== propValue.value)) {\n      property.values = [...property.values, propValue];\n    }\n  } else if (isRdfLiteral(propValue)) {\n    if (!property) {\n      property = { type: 'string', values: [] };\n    }\n    const propertyValue = getLocalizedString(propValue);\n    if (isLiteralProperty(property) && property.values.every((value) => !isLocalizedEqual(value, propertyValue))) {\n      property.values = [...property.values, propertyValue];\n    }\n  }\n  properties[propType.value] = property;\n}\n\nexport function enrichElement(element: ElementModel, sInst: ElementBinding) {\n  if (!element) {\n    return;\n  }\n  if (sInst.label) {\n    const label = getLocalizedString(sInst.label);\n\n    if (element.label.values.every((value) => !isLocalizedEqual(value, label))) {\n      element.label.values.push(label);\n    }\n  }\n  if (sInst.class && element.types.indexOf(sInst.class.value as ElementTypeIri) < 0) {\n    element.types.push(sInst.class.value as ElementTypeIri);\n  }\n  if (sInst.propType && sInst.propType.value !== LABEL_URI) {\n    mergeProperties(element.properties, sInst.propType, sInst.propValue);\n  }\n}\n\nfunction appendLabel(container: { values: LocalizedString[] }, newLabel: LocalizedString | undefined) {\n  if (!newLabel) {\n    return;\n  }\n  for (const existing of container.values) {\n    if (isLocalizedEqual(existing, newLabel)) {\n      return;\n    }\n  }\n  container.values.push(newLabel);\n}\n\nfunction isLocalizedEqual(left: LocalizedString, right: LocalizedString) {\n  return left.language === right.language && left.value === right.value;\n}\n\nexport function getLocalizedString(label: RdfLiteral): LocalizedString | undefined {\n  if (label) {\n    return {\n      value: label.value,\n      language: label['xml:lang'],\n      datatype: label.datatype ? { value: label.datatype } : undefined,\n    };\n  } else {\n    return undefined;\n  }\n}\n\nexport function getInstCount(instcount: RdfLiteral): number | undefined {\n  return instcount ? +instcount.value : undefined;\n}\n\nexport function getPropertyModel(node: PropertyBinding): PropertyModel {\n  const label = getLocalizedString(node.label);\n  return {\n    id: node.property.value as PropertyTypeIri,\n    label: { values: label ? [label] : [] },\n  };\n}\n\nexport function getLinkCount(sLinkType: LinkCountBinding): LinkCount {\n  return {\n    id: sLinkType.link.value as LinkTypeIri,\n    inCount: getInstCount(sLinkType.inCount),\n    outCount: getInstCount(sLinkType.outCount),\n  };\n}\n\nexport function emptyElementInfo(id: ElementIri): ElementModel {\n  const elementInfo: ElementModel = {\n    id: id,\n    label: { values: [] },\n    types: [],\n    properties: {},\n  };\n  return elementInfo;\n}\n\nexport function getLinkTypeInfo(sLinkInfo: LinkTypeBinding): LinkType {\n  if (!sLinkInfo) {\n    return undefined;\n  }\n  const label = getLocalizedString(sLinkInfo.label);\n  return {\n    id: sLinkInfo.link.value as LinkTypeIri,\n    label: { values: label ? [label] : [] },\n    count: getInstCount(sLinkInfo.instcount),\n  };\n}\n\nexport function prependAdditionalBindings<Binding>(\n  base: SparqlResponse<Binding>,\n  additional: SparqlResponse<Binding> | undefined\n): SparqlResponse<Binding> {\n  if (!additional) {\n    return base;\n  }\n  return {\n    head: { vars: base.head.vars },\n    results: {\n      bindings: [...additional.results.bindings, ...base.results.bindings],\n    },\n  };\n}\n","import { DataProvider, LinkElementsParams, FilterParams } from '../provider';\nimport {\n  Dictionary,\n  ClassModel,\n  LinkType,\n  ElementModel,\n  LinkModel,\n  LinkCount,\n  Property,\n  PropertyModel,\n  LocalizedString,\n  ElementIri,\n  ElementTypeIri,\n  LinkTypeIri,\n  PropertyTypeIri,\n} from '../model';\nimport {\n  CompositeResponse,\n  mergeClassTree,\n  mergePropertyInfo,\n  mergeClassInfo,\n  mergeLinkTypesInfo,\n  mergeLinkTypes,\n  mergeElementInfo,\n  mergeLinksInfo,\n  mergeLinkTypesOf,\n  mergeLinkElements,\n  mergeFilter,\n} from './mergeUtils';\n\nexport interface DPDefinition {\n  name: string;\n  dataProvider: DataProvider;\n  useInStats?: boolean;\n}\n\nfunction isDefinition(dp: DataProvider | DPDefinition): dp is DPDefinition {\n  const definition = dp as Partial<DPDefinition>;\n  return definition.name !== undefined && definition.dataProvider !== undefined;\n}\n\nexport type MergeMode = 'fetchAll' | 'sequentialFetching';\n\nexport class CompositeDataProvider implements DataProvider {\n  public dataProviders: DPDefinition[];\n  public mergeMode: MergeMode = 'fetchAll';\n\n  constructor(\n    dataProviders: (DataProvider | DPDefinition)[],\n    params?: {\n      mergeMode?: MergeMode;\n    }\n  ) {\n    let dpCounter = 1;\n    this.dataProviders = dataProviders.map((dp) => {\n      if (isDefinition(dp)) {\n        return dp;\n      } else {\n        return {\n          name: 'dataProvider_' + dpCounter++,\n          dataProvider: dp,\n        };\n      }\n    });\n\n    if (params && params.mergeMode) {\n      this.mergeMode = params.mergeMode;\n    }\n  }\n\n  classTree(): Promise<ClassModel[]> {\n    return this.fetchSequentially('classTree', mergeClassTree, undefined);\n  }\n\n  propertyInfo(params: { propertyIds: PropertyTypeIri[] }): Promise<Dictionary<PropertyModel>> {\n    if (this.mergeMode === 'fetchAll') {\n      return this.fetchSequentially('propertyInfo', mergePropertyInfo, params);\n    } else {\n      let propertyIds = params.propertyIds;\n      return this.queueProcessResults((previousResult: Dictionary<PropertyModel>, dp: DPDefinition) => {\n        propertyIds = propertyIds.filter((id) => !previousResult || !previousResult[id]);\n        return propertyIds.length > 0 ? dp.dataProvider.propertyInfo({ propertyIds: propertyIds }) : undefined;\n      }).then(mergePropertyInfo);\n    }\n  }\n\n  classInfo(params: { classIds: ElementTypeIri[] }): Promise<ClassModel[]> {\n    if (this.mergeMode === 'fetchAll') {\n      return this.fetchSequentially('classInfo', mergeClassInfo, params);\n    } else {\n      let classIds = params.classIds;\n      return this.queueProcessResults((previousResult: ClassModel[], dp: DPDefinition) => {\n        classIds = classIds.filter((id) => !previousResult || previousResult.map((cm) => cm.id).indexOf(id) === -1);\n        return classIds.length > 0 ? dp.dataProvider.classInfo({ classIds: classIds }) : undefined;\n      }).then(mergeClassInfo);\n    }\n  }\n\n  linkTypesInfo(params: { linkTypeIds: LinkTypeIri[] }): Promise<LinkType[]> {\n    if (this.mergeMode === 'fetchAll') {\n      return this.fetchSequentially('linkTypesInfo', mergeLinkTypesInfo, params);\n    } else {\n      let linkTypeIds = params.linkTypeIds;\n      return this.queueProcessResults((previousResult: LinkType[], dp: DPDefinition) => {\n        linkTypeIds = linkTypeIds.filter(\n          (id) => !previousResult || previousResult.map((lt) => lt.id).indexOf(id) === -1\n        );\n        return linkTypeIds.length > 0 ? dp.dataProvider.linkTypesInfo({ linkTypeIds: linkTypeIds }) : undefined;\n      }).then(mergeLinkTypesInfo);\n    }\n  }\n\n  linkTypes(): Promise<LinkType[]> {\n    return this.fetchSequentially('linkTypes', mergeLinkTypes, undefined);\n  }\n\n  elementInfo(params: { elementIds: ElementIri[] }): Promise<Dictionary<ElementModel>> {\n    if (this.mergeMode === 'fetchAll') {\n      return this.fetchSequentially('elementInfo', mergeElementInfo, params);\n    } else {\n      let elementIds = params.elementIds;\n      return this.queueProcessResults((previousResult: Dictionary<ElementModel>, dp: DPDefinition) => {\n        elementIds = elementIds.filter((id) => !previousResult || !previousResult[id]);\n        return elementIds.length > 0 ? dp.dataProvider.elementInfo({ elementIds: elementIds }) : undefined;\n      }).then(mergeElementInfo);\n    }\n  }\n\n  linksInfo(params: { elementIds: ElementIri[]; linkTypeIds: LinkTypeIri[] }): Promise<LinkModel[]> {\n    if (this.mergeMode === 'fetchAll') {\n      return this.fetchSequentially('linksInfo', mergeLinksInfo, params);\n    } else {\n      let elementIds = params.elementIds;\n      return this.queueProcessResults((previousResult: LinkModel[], dp: DPDefinition) => {\n        elementIds = elementIds.filter((id) => {\n          if (previousResult) {\n            for (const linkModel of previousResult) {\n              if (linkModel.sourceId === id) {\n                return false;\n              }\n            }\n          }\n          return true;\n        });\n        return elementIds.length > 0\n          ? dp.dataProvider.linksInfo({ elementIds: elementIds, linkTypeIds: params.linkTypeIds })\n          : undefined;\n      }).then(mergeLinksInfo);\n    }\n  }\n\n  linkTypesOf(params: { elementId: ElementIri }): Promise<LinkCount[]> {\n    if (this.mergeMode === 'fetchAll') {\n      return this.fetchSequentially('linkTypesOf', mergeLinkTypesOf, params);\n    } else {\n      return this.queueProcessResults((previousResult: LinkCount[], dp: DPDefinition) => {\n        if (!previousResult || (previousResult && previousResult.length === 0)) {\n          return dp.dataProvider.linkTypesOf(params);\n        } else {\n          return undefined;\n        }\n      }).then(mergeLinkTypesOf);\n    }\n  }\n\n  linkElements(params: LinkElementsParams): Promise<Dictionary<ElementModel>> {\n    if (this.mergeMode === 'fetchAll') {\n      return this.fetchSequentially('linkElements', mergeLinkElements, params);\n    } else {\n      return this.queueProcessResults((previousResult: Dictionary<ElementModel>, dp: DPDefinition) => {\n        if (!previousResult || (previousResult && Object.keys(previousResult).length === 0)) {\n          return dp.dataProvider.linkElements(params);\n        } else {\n          return undefined;\n        }\n      }).then(mergeLinkElements);\n    }\n  }\n\n  filter(params: FilterParams): Promise<Dictionary<ElementModel>> {\n    if (this.mergeMode === 'fetchAll') {\n      return this.fetchSequentially('filter', mergeFilter, params);\n    } else {\n      return this.queueProcessResults((previousResult: Dictionary<ElementModel>, dp: DPDefinition) => {\n        if (!previousResult || (previousResult && Object.keys(previousResult).length === 0)) {\n          return dp.dataProvider.filter(params);\n        } else {\n          return undefined;\n        }\n      }).then(mergeFilter);\n    }\n  }\n\n  private processResults<ResponseType>(\n    responsePromise: Promise<ResponseType>,\n    dpName: string,\n    useProviderInStats?: boolean\n  ): Promise<CompositeResponse<ResponseType>> {\n    return responsePromise\n      .then((response) => ({ dataSourceName: dpName, useInStats: useProviderInStats, response: response }))\n      .catch((error) => {\n        // tslint:disable-next-line:no-console\n        console.error(error);\n        return { dataSourceName: dpName, useInStats: useProviderInStats, response: undefined };\n      });\n  }\n\n  private queueProcessResults<ResponseType>(\n    callBack: (previousResult: ResponseType, dp: DPDefinition) => Promise<ResponseType>\n  ): Promise<CompositeResponse<ResponseType>[]> {\n    let counter = 0;\n    const responseList: CompositeResponse<ResponseType>[] = [];\n\n    const recursiveCall = (result?: ResponseType): Promise<CompositeResponse<ResponseType>[]> => {\n      if (this.dataProviders.length > counter) {\n        const dp = this.dataProviders[counter++];\n        const callBackResult = callBack(result, dp);\n\n        if (!callBackResult) {\n          return Promise.resolve(responseList);\n        }\n        return callBackResult\n          .then((newResult) => {\n            responseList.push({\n              dataSourceName: dp.name,\n              response: newResult,\n            });\n            return recursiveCall(newResult);\n          })\n          .catch((error) => {\n            // tslint:disable-next-line:no-console\n            console.error(error);\n            return recursiveCall(result);\n          });\n      } else {\n        return Promise.resolve(responseList);\n      }\n    };\n    return recursiveCall();\n  }\n\n  private fetchSequentially<K extends keyof DataProvider>(\n    functionName: K,\n    mergeFunction: (response: CompositeResponse<OperationResult<K>>[]) => OperationResult<K>,\n    params: OperationParams<K>\n  ) {\n    const resultPromises = this.dataProviders.map((dp: DPDefinition) => {\n      const providerMethod = (dp.dataProvider[functionName] as any) as (\n        this: DataProvider,\n        params: OperationParams<K>\n      ) => Promise<OperationResult<K>>;\n      return this.processResults(providerMethod.call(dp.dataProvider, params), dp.name, dp.useInStats);\n    });\n    return Promise.all(resultPromises).then(mergeFunction);\n  }\n}\n\ntype OperationParams<K extends keyof DataProvider> = DataProvider[K] extends (params: infer P) => any ? P : never;\ntype OperationResult<K extends keyof DataProvider> = ReturnType<DataProvider[K]> extends Promise<infer R> ? R : never;\n","import { DataProvider, FilterParams } from '../provider';\nimport {\n  Dictionary,\n  ClassModel,\n  LinkType,\n  ElementModel,\n  LinkModel,\n  LinkCount,\n  Property,\n  PropertyModel,\n  LocalizedString,\n} from '../model';\n\nconst DATA_PROVIDER_PROPERTY = 'http://ontodia.org/property/DataProvider';\n\nexport interface CompositeResponse<Type> {\n  dataSourceName: string;\n  useInStats?: boolean;\n  response: Type;\n}\n\nexport function mergeClassTree(composite: CompositeResponse<ClassModel[]>[]): ClassModel[] {\n  const lists = composite\n    .filter((r) => r.response)\n    .map(({ useInStats, response }) => ({ useInStats, classes: classTreeToArray(response) }));\n  const dictionary: Dictionary<ClassModel> = {};\n  const topLevelModels: Dictionary<ClassModel> = {};\n  const childrenMap: Dictionary<string[]> = {};\n\n  for (const { useInStats, classes } of lists) {\n    for (const model of classes) {\n      const childrenIds: string[] = childrenMap[model.id] || [];\n      model.children\n        .map((ch) => ch.id)\n        .forEach((id) => {\n          if (childrenIds.indexOf(id) === -1) {\n            childrenIds.push(id);\n          }\n        });\n      model.children = [];\n\n      if (!useInStats) {\n        delete model.count;\n      }\n\n      if (!dictionary[model.id]) {\n        topLevelModels[model.id] = model;\n        dictionary[model.id] = model;\n        childrenMap[model.id] = childrenIds;\n      } else {\n        topLevelModels[model.id] = mergeClassModel(dictionary[model.id], model);\n        dictionary[model.id] = topLevelModels[model.id];\n      }\n    }\n  }\n\n  const models = Object.keys(dictionary).map((key) => dictionary[key]);\n\n  for (const m of models) {\n    m.children = (childrenMap[m.id] || []).map((id) => {\n      delete topLevelModels[id];\n      return dictionary[id];\n    });\n  }\n\n  return Object.keys(topLevelModels).map((key) => topLevelModels[key]);\n}\n\nexport function mergePropertyInfo(response: CompositeResponse<Dictionary<PropertyModel>>[]): Dictionary<PropertyModel> {\n  const result: Dictionary<PropertyModel> = {};\n  const props = response.filter((r) => r.response).map((r) => r.response);\n  for (const model of props) {\n    const keys = Object.keys(model);\n    for (const key of keys) {\n      const prop = model[key];\n      if (!result[key]) {\n        result[key] = prop;\n      } else {\n        result[key].label = mergeLabels(result[key].label, prop.label);\n      }\n    }\n  }\n  return result;\n}\n\nexport function mergeClassInfo(response: CompositeResponse<ClassModel[]>[]): ClassModel[] {\n  const dictionaries = response.filter((r) => r.response).map((r) => r.response);\n  const dictionary: Dictionary<ClassModel> = {};\n\n  for (const models of dictionaries) {\n    for (const model of models) {\n      if (!dictionary[model.id]) {\n        dictionary[model.id] = model;\n      } else {\n        dictionary[model.id] = mergeClassModel(dictionary[model.id], model);\n      }\n    }\n  }\n  return Object.keys(dictionary).map((key) => dictionary[key]);\n}\n\nexport function mergeLinkTypesInfo(response: CompositeResponse<LinkType[]>[]): LinkType[] {\n  const lists = response.filter((r) => r.response).map((r) => r.response);\n\n  const mergeLinkType = (a: LinkType, b: LinkType): LinkType => {\n    return {\n      id: a.id,\n      label: mergeLabels(a.label, b.label),\n      count: a.count + b.count,\n    };\n  };\n\n  const dictionary: Dictionary<LinkType> = {};\n\n  for (const linkTypes of lists) {\n    for (const linkType of linkTypes) {\n      if (!dictionary[linkType.id]) {\n        dictionary[linkType.id] = linkType;\n      } else {\n        dictionary[linkType.id] = mergeLinkType(dictionary[linkType.id], linkType);\n      }\n    }\n  }\n  return Object.keys(dictionary).map((key) => dictionary[key]);\n}\n\nexport function mergeLinkTypes(response: CompositeResponse<LinkType[]>[]): LinkType[] {\n  return mergeLinkTypesInfo(response);\n}\n\nexport function mergeElementInfo(response: CompositeResponse<Dictionary<ElementModel>>[]): Dictionary<ElementModel> {\n  const mergeElementModels = (a: ElementModel, b: ElementModel): ElementModel => {\n    const types = a.types;\n    for (const t of b.types) {\n      if (types.indexOf(t) === -1) {\n        types.push(t);\n      }\n    }\n    const sources: string[] = [];\n    for (const s of a.sources) {\n      if (sources.indexOf(s) === -1) {\n        sources.push(s);\n      }\n    }\n    for (const s of b.sources) {\n      if (sources.indexOf(s) === -1) {\n        sources.push(s);\n      }\n    }\n    return {\n      id: a.id,\n      label: mergeLabels(a.label, b.label),\n      types: types,\n      image: a.image || b.image,\n      properties: mergeProperties(a.properties, b.properties),\n      sources: sources,\n    };\n  };\n\n  const dictionaries = response.filter((r) => r.response).map((r) => r.response);\n  const dictionary: Dictionary<ElementModel> = {};\n\n  for (const resp of response) {\n    if (!resp.response) {\n      continue;\n    }\n    const list = Object.keys(resp.response).map((k) => resp.response[k]);\n\n    for (const em of list) {\n      em.sources = [resp.dataSourceName];\n      em.properties[DATA_PROVIDER_PROPERTY] = {\n        type: 'string',\n        values: [{ value: resp.dataSourceName, language: '' }],\n      };\n      if (!dictionary[em.id]) {\n        dictionary[em.id] = em;\n      } else {\n        dictionary[em.id] = mergeElementModels(dictionary[em.id], em);\n      }\n    }\n  }\n  return dictionary;\n}\n\nexport function mergeProperties(a: Dictionary<Property>, b: Dictionary<Property>): Dictionary<Property> {\n  const aLists = Object.keys(a);\n  const bLists = Object.keys(b);\n\n  const result: Dictionary<Property> = {};\n\n  function createIdForProperty(baseId: string): string {\n    let counter = 1;\n    while (result[baseId + '_' + counter]) {\n      counter++;\n    }\n    return baseId + '_' + counter;\n  }\n\n  for (const pKey of aLists) {\n    const prop = a[pKey];\n    if (!result[pKey]) {\n      result[pKey] = prop;\n    } else {\n      result[createIdForProperty(pKey)] = prop;\n    }\n  }\n  for (const pKey of bLists) {\n    const prop = b[pKey];\n    if (!result[pKey]) {\n      result[pKey] = prop;\n    } else {\n      result[createIdForProperty(pKey)] = prop;\n    }\n  }\n\n  return result;\n}\n\nexport function mergeLinksInfo(response: CompositeResponse<LinkModel[]>[]): LinkModel[] {\n  const lists = response.filter((r) => r.response).map((r) => r.response);\n  const resultInfo: LinkModel[] = [];\n\n  function compareLinksInfo(a: LinkModel, b: LinkModel): boolean {\n    return a.sourceId === b.sourceId && a.targetId === b.targetId && a.linkTypeId === b.linkTypeId;\n  }\n\n  for (const linkInfo of lists) {\n    for (const linkModel of linkInfo) {\n      if (!resultInfo.some((l) => compareLinksInfo(l, linkModel))) {\n        resultInfo.push(linkModel);\n      }\n    }\n  }\n  return resultInfo;\n}\n\nexport function mergeLinkTypesOf(response: CompositeResponse<LinkCount[]>[]): LinkCount[] {\n  const lists = response.filter((r) => r.response).map((r) => r.response);\n  const dictionary: Dictionary<LinkCount> = {};\n\n  const merge = (a: LinkCount, b: LinkCount): LinkCount => {\n    return {\n      id: a.id,\n      inCount: a.inCount + b.inCount,\n      outCount: a.outCount + b.outCount,\n    };\n  };\n\n  for (const linkCount of lists) {\n    for (const lCount of linkCount) {\n      if (!dictionary[lCount.id]) {\n        dictionary[lCount.id] = lCount;\n      } else {\n        dictionary[lCount.id] = merge(lCount, dictionary[lCount.id]);\n      }\n    }\n  }\n  return Object.keys(dictionary).map((key) => dictionary[key]);\n}\n\nexport function mergeLinkElements(response: CompositeResponse<Dictionary<ElementModel>>[]): Dictionary<ElementModel> {\n  return mergeElementInfo(response);\n}\n\nexport function mergeFilter(response: CompositeResponse<Dictionary<ElementModel>>[]): Dictionary<ElementModel> {\n  return mergeElementInfo(response);\n}\n\nexport function classTreeToArray(models: ClassModel[]): ClassModel[] {\n  let resultArray: ClassModel[] = models;\n\n  function getDescendants(model: ClassModel): ClassModel[] {\n    let descendants = model.children || [];\n    for (const descendant of descendants) {\n      const nextGeneration = getDescendants(descendant);\n      descendants = descendants.concat(nextGeneration);\n    }\n    return descendants;\n  }\n\n  for (const model of models) {\n    const descendants = getDescendants(model);\n    resultArray = resultArray.concat(descendants);\n  }\n\n  return resultArray;\n}\n\nexport function mergeLabels(\n  a: { values: LocalizedString[] },\n  b: { values: LocalizedString[] }\n): { values: LocalizedString[] } {\n  function compareLabels(l1: LocalizedString, l2: LocalizedString): boolean {\n    return l1.language === l2.language && l1.value === l2.value;\n  }\n\n  const mergedValuesList = a.values;\n\n  for (const locStr of b.values) {\n    if (!mergedValuesList.some((l) => compareLabels(l, locStr))) {\n      mergedValuesList.push(locStr);\n    }\n  }\n\n  return {\n    values: mergedValuesList,\n  };\n}\n\nexport function mergeCounts(a?: number, b?: number): number | undefined {\n  if (a === undefined && b === undefined) {\n    return undefined;\n  }\n\n  return (a || 0) + (b || 0);\n}\n\nexport function mergeClassModel(a: ClassModel, b: ClassModel): ClassModel {\n  const childrenDictionary: Dictionary<ClassModel> = {};\n  for (const child of a.children.concat(b.children)) {\n    if (!childrenDictionary[child.id]) {\n      childrenDictionary[child.id] = child;\n    }\n  }\n\n  return {\n    id: a.id,\n    label: mergeLabels(a.label, b.label),\n    count: mergeCounts(a.count, b.count),\n    children: Object.keys(childrenDictionary).map((key) => childrenDictionary[key]),\n  };\n}\n","import { LayoutData, SerializedDiagram } from '../../editor/serializedDiagram';\n\nimport { Dictionary, ElementModel } from '../model';\n\nimport { GraphBuilder } from './graphBuilder';\nimport { SparqlDataProvider } from './sparqlDataProvider';\n\nconst DEFAULT_PREFIX =\n  `PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\n PREFIX rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\n PREFIX owl:  <http://www.w3.org/2002/07/owl#>` + '\\n\\n';\n\nexport class SparqlGraphBuilder {\n  graphBuilder: GraphBuilder;\n\n  constructor(public dataProvider: SparqlDataProvider) {\n    this.graphBuilder = new GraphBuilder(dataProvider);\n  }\n\n  getGraphFromConstruct(\n    constructQuery: string\n  ): Promise<{\n    preloadedElements: Dictionary<ElementModel>;\n    diagram: SerializedDiagram;\n  }> {\n    const query = DEFAULT_PREFIX + constructQuery;\n    return this.dataProvider\n      .executeSparqlConstruct(query)\n      .then((graph) => this.graphBuilder.getGraphFromRDFGraph(graph));\n  }\n}\n","import { ElementTypeIri, LinkTypeIri, PropertyTypeIri } from '../data/model';\nimport { OrderedMap } from '../viewUtils/collections';\nimport { EventSource, Events, AnyEvent, AnyListener } from '../viewUtils/events';\n\nimport {\n  Element as DiagramElement,\n  ElementEvents,\n  Link as DiagramLink,\n  LinkEvents,\n  FatLinkType,\n  FatLinkTypeEvents,\n  FatClassModel,\n  FatClassModelEvents,\n  RichProperty,\n} from './elements';\n\nexport interface GraphEvents {\n  changeCells: CellsChangedEvent;\n  elementEvent: AnyEvent<ElementEvents>;\n  linkEvent: AnyEvent<LinkEvents>;\n  linkTypeEvent: AnyEvent<FatLinkTypeEvents>;\n  classEvent: AnyEvent<FatClassModelEvents>;\n}\n\nexport interface CellsChangedEvent {\n  readonly updateAll: boolean;\n  readonly changedElement?: DiagramElement;\n  readonly changedLinks?: ReadonlyArray<DiagramLink>;\n}\n\nexport class Graph {\n  private readonly source = new EventSource<GraphEvents>();\n  readonly events: Events<GraphEvents> = this.source;\n\n  private elements = new OrderedMap<DiagramElement>();\n  private links = new OrderedMap<DiagramLink>();\n\n  private classesById = new Map<ElementTypeIri, FatClassModel>();\n  private propertiesById = new Map<PropertyTypeIri, RichProperty>();\n\n  private linkTypes = new Map<LinkTypeIri, FatLinkType>();\n  private static nextLinkTypeIndex = 0;\n\n  getElements() {\n    return this.elements.items;\n  }\n  getLinks() {\n    return this.links.items;\n  }\n\n  getLink(linkId: string): DiagramLink | undefined {\n    return this.links.get(linkId);\n  }\n\n  findLink(linkTypeId: LinkTypeIri, sourceId: string, targetId: string): DiagramLink | undefined {\n    const source = this.getElement(sourceId);\n    if (!source) {\n      return undefined;\n    }\n    const index = findLinkIndex(source.links, linkTypeId, sourceId, targetId);\n    return index >= 0 ? source.links[index] : undefined;\n  }\n\n  sourceOf(link: DiagramLink) {\n    return this.getElement(link.sourceId);\n  }\n\n  targetOf(link: DiagramLink) {\n    return this.getElement(link.targetId);\n  }\n\n  reorderElements(compare: (a: DiagramElement, b: DiagramElement) => number) {\n    this.elements.reorder(compare);\n  }\n\n  getElement(elementId: string): DiagramElement | undefined {\n    return this.elements.get(elementId);\n  }\n\n  addElement(element: DiagramElement): void {\n    if (this.getElement(element.id)) {\n      throw new Error(`Element '${element.id}' already exists.`);\n    }\n    element.events.onAny(this.onElementEvent);\n    this.elements.push(element.id, element);\n    this.source.trigger('changeCells', { updateAll: false, changedElement: element });\n  }\n\n  private onElementEvent: AnyListener<ElementEvents> = (data, key) => {\n    this.source.trigger('elementEvent', { key, data });\n  };\n\n  removeElement(elementId: string): void {\n    const element = this.elements.get(elementId);\n    if (element) {\n      const options = { silent: true };\n      // clone links to prevent modifications during iteration\n      const changedLinks = [...element.links];\n      for (const link of changedLinks) {\n        this.removeLink(link.id, options);\n      }\n      this.elements.delete(elementId);\n      element.events.offAny(this.onElementEvent);\n      this.source.trigger('changeCells', { updateAll: false, changedElement: element, changedLinks });\n    }\n  }\n\n  addLink(link: DiagramLink): void {\n    if (this.getLink(link.id)) {\n      throw new Error(`Link '${link.id}' already exists.`);\n    }\n    const linkType = this.getLinkType(link.typeId);\n    if (!linkType) {\n      throw new Error(`Link type '${link.typeId}' not found.`);\n    }\n    this.registerLink(link);\n  }\n\n  private registerLink(link: DiagramLink) {\n    this.sourceOf(link).links.push(link);\n    if (link.sourceId !== link.targetId) {\n      this.targetOf(link).links.push(link);\n    }\n\n    link.events.onAny(this.onLinkEvent);\n    this.links.push(link.id, link);\n    this.source.trigger('changeCells', { updateAll: false, changedLinks: [link] });\n  }\n\n  private onLinkEvent: AnyListener<LinkEvents> = (data, key) => {\n    this.source.trigger('linkEvent', { key, data });\n  };\n\n  removeLink(linkId: string, options?: { silent?: boolean }) {\n    const link = this.links.delete(linkId);\n    if (link) {\n      const { typeId, sourceId, targetId } = link;\n      link.events.offAny(this.onLinkEvent);\n      this.removeLinkReferences(typeId, sourceId, targetId);\n      if (!(options && options.silent)) {\n        this.source.trigger('changeCells', { updateAll: false, changedLinks: [link] });\n      }\n    }\n  }\n\n  private removeLinkReferences(linkTypeId: LinkTypeIri, sourceId: string, targetId: string) {\n    const source = this.getElement(sourceId);\n    if (source) {\n      removeLinkFrom(source.links, linkTypeId, sourceId, targetId);\n    }\n    const target = this.getElement(targetId);\n    if (target) {\n      removeLinkFrom(target.links, linkTypeId, sourceId, targetId);\n    }\n  }\n\n  getLinkTypes(): FatLinkType[] {\n    const result: FatLinkType[] = [];\n    this.linkTypes.forEach((type) => result.push(type));\n    return result;\n  }\n\n  getLinkType(linkTypeId: LinkTypeIri): FatLinkType | undefined {\n    return this.linkTypes.get(linkTypeId);\n  }\n\n  addLinkType(linkType: FatLinkType): void {\n    if (this.getLinkType(linkType.id)) {\n      throw new Error(`Link type '${linkType.id}' already exists.`);\n    }\n    linkType.setIndex(Graph.nextLinkTypeIndex++);\n    linkType.events.onAny(this.onLinkTypeEvent);\n    this.linkTypes.set(linkType.id, linkType);\n  }\n\n  private onLinkTypeEvent: AnyListener<FatLinkTypeEvents> = (data, key) => {\n    this.source.trigger('linkTypeEvent', { key, data });\n  };\n\n  getProperty(propertyId: PropertyTypeIri): RichProperty | undefined {\n    return this.propertiesById.get(propertyId);\n  }\n\n  addProperty(property: RichProperty): void {\n    if (this.getProperty(property.id)) {\n      throw new Error(`Property '${property.id}' already exists.`);\n    }\n    this.propertiesById.set(property.id, property);\n  }\n\n  getClass(classId: ElementTypeIri): FatClassModel | undefined {\n    return this.classesById.get(classId);\n  }\n\n  getClasses(): FatClassModel[] {\n    const classes: FatClassModel[] = [];\n    this.classesById.forEach((richClass) => classes.push(richClass));\n    return classes;\n  }\n\n  addClass(classModel: FatClassModel): void {\n    if (this.getClass(classModel.id)) {\n      throw new Error(`Class '${classModel.id}' already exists.`);\n    }\n    classModel.events.onAny(this.onClassEvent);\n    this.classesById.set(classModel.id, classModel);\n  }\n\n  private onClassEvent: AnyListener<FatClassModelEvents> = (data, key) => {\n    this.source.trigger('classEvent', { key, data });\n  };\n}\n\nfunction removeLinkFrom(links: DiagramLink[], linkTypeId: LinkTypeIri, sourceId: string, targetId: string) {\n  if (!links) {\n    return;\n  }\n  while (true) {\n    const index = findLinkIndex(links, linkTypeId, sourceId, targetId);\n    if (index < 0) {\n      break;\n    }\n    links.splice(index, 1);\n  }\n}\n\nfunction findLinkIndex(haystack: DiagramLink[], linkTypeId: LinkTypeIri, sourceId: string, targetId: string) {\n  for (let i = 0; i < haystack.length; i++) {\n    const link = haystack[i];\n    if (link.sourceId === sourceId && link.targetId === targetId && link.typeId === linkTypeId) {\n      return i;\n    }\n  }\n  return -1;\n}\n","import {\n  ElementModel,\n  ClassModel,\n  LinkType,\n  PropertyModel,\n  ElementIri,\n  ElementTypeIri,\n  LinkTypeIri,\n  PropertyTypeIri,\n} from '../data/model';\nimport { DataProvider } from '../data/provider';\n\nimport { FatClassModel, FatLinkType, RichProperty } from '../diagram/elements';\nimport { Graph } from '../diagram/graph';\n\nimport { BufferingQueue } from '../viewUtils/async';\n\nexport class DataFetcher {\n  private classQueue = new BufferingQueue<ElementTypeIri>((classIds) => {\n    this.dataProvider.classInfo({ classIds }).then(this.onClassesLoaded);\n  });\n  private linkTypeQueue = new BufferingQueue<LinkTypeIri>((linkTypeIds) => {\n    this.dataProvider.linkTypesInfo({ linkTypeIds }).then(this.onLinkTypesLoaded);\n  });\n  private propertyTypeQueue = new BufferingQueue<PropertyTypeIri>((propertyIds) => {\n    this.dataProvider.propertyInfo({ propertyIds }).then(this.onPropertyTypesLoaded);\n  });\n\n  constructor(private graph: Graph, private dataProvider: DataProvider) {}\n\n  fetchElementData(elementIris: ReadonlyArray<ElementIri>): Promise<void> {\n    if (elementIris.length === 0) {\n      return Promise.resolve();\n    }\n    return this.dataProvider.elementInfo({ elementIds: [...elementIris] }).then(this.onElementInfoLoaded);\n  }\n\n  private onElementInfoLoaded = (elements: { [elementId: string]: ElementModel }) => {\n    for (const element of this.graph.getElements()) {\n      const loadedModel = elements[element.iri];\n      if (loadedModel) {\n        element.setData(loadedModel);\n      }\n    }\n  };\n\n  fetchClass(model: FatClassModel): void {\n    this.classQueue.push(model.id);\n  }\n\n  private onClassesLoaded = (classInfos: ClassModel[]) => {\n    for (const { id, label, count } of classInfos) {\n      const model = this.graph.getClass(id);\n      if (!model) {\n        continue;\n      }\n      model.setLabel(label.values);\n      if (typeof count === 'number') {\n        model.setCount(count);\n      }\n    }\n  };\n\n  fetchLinkType(linkType: FatLinkType): void {\n    this.linkTypeQueue.push(linkType.id);\n  }\n\n  private onLinkTypesLoaded = (linkTypesInfo: LinkType[]) => {\n    for (const { id, label } of linkTypesInfo) {\n      const model = this.graph.getLinkType(id);\n      if (!model) {\n        continue;\n      }\n      model.setLabel(label.values);\n    }\n  };\n\n  fetchPropertyType(propertyType: RichProperty): void {\n    if (!this.dataProvider.propertyInfo) {\n      return;\n    }\n    this.propertyTypeQueue.push(propertyType.id);\n  }\n\n  private onPropertyTypesLoaded = (propertyModels: { [propertyId: string]: PropertyModel }) => {\n    for (const propId in propertyModels) {\n      if (!Object.prototype.hasOwnProperty.call(propertyModels, propId)) {\n        continue;\n      }\n      const { id, label } = propertyModels[propId];\n      const targetProperty = this.graph.getProperty(id);\n      if (targetProperty) {\n        targetProperty.setLabel(label.values);\n      }\n    }\n  };\n}\n","import * as React from 'react';\n\nimport { DiagramView } from '../diagram/view';\nimport { Element, Link } from '../diagram/elements';\nimport { EventObserver, Unsubscribe } from '../viewUtils/events';\nimport { PaperWidgetProps } from '../diagram/paperArea';\nimport { boundsOf, computePolyline, computePolylineLength, getPointAlongPolyline, Vector } from '../diagram/geometry';\nimport { DraggableHandle } from '../workspace/draggableHandle';\n\nconst DEFAULT_WIDTH = 300;\nconst DEFAULT_HEIGHT = 300;\nconst MIN_WIDTH = 250;\nconst MIN_HEIGHT = 250;\nconst MAX_WIDTH = 800;\nconst MAX_HEIGHT = 800;\n\nconst ELEMENT_OFFSET = 40;\nconst LINK_OFFSET = 20;\nconst FOCUS_OFFSET = 20;\n\nconst CLASS_NAME = 'ontodia-dialog';\n\nexport interface Props extends PaperWidgetProps {\n  view: DiagramView;\n  target: Element | Link;\n  size?: { width: number; height: number };\n  caption?: string;\n  offset?: Vector;\n  calculatePosition?: () => Vector;\n  onClose: () => void;\n}\n\nexport interface State {\n  width?: number;\n  height?: number;\n}\n\nexport class Dialog extends React.Component<Props, State> {\n  private static defaultProps: Partial<Props> = {\n    size: { width: DEFAULT_WIDTH, height: DEFAULT_HEIGHT },\n  };\n\n  private unsubscribeFromTarget: Unsubscribe | undefined = undefined;\n  private readonly handler = new EventObserver();\n\n  private updateAll = () => this.forceUpdate();\n\n  constructor(props: Props) {\n    super(props);\n    this.state = {};\n  }\n\n  componentDidMount() {\n    this.listenToTarget(this.props.target);\n    this.focusOn();\n  }\n\n  componentWillReceiveProps(nextProps: Props) {\n    if (nextProps.target !== this.props.target) {\n      this.listenToTarget(nextProps.target);\n    }\n  }\n\n  componentWillUnmount() {\n    this.listenToTarget(undefined);\n  }\n\n  private listenToTarget(target?: Element | Link) {\n    if (this.unsubscribeFromTarget) {\n      this.unsubscribeFromTarget();\n      this.unsubscribeFromTarget = undefined;\n    }\n\n    if (target) {\n      const { view } = this.props;\n\n      if (target instanceof Element) {\n        this.listenToElement(target);\n      } else if (target instanceof Link) {\n        this.listenToLink(target);\n      }\n\n      this.handler.listen(view.events, 'changeLanguage', this.updateAll);\n\n      this.unsubscribeFromTarget = () => {\n        this.handler.stopListening();\n      };\n    }\n  }\n\n  private listenToElement(element: Element) {\n    this.handler.listen(element.events, 'changePosition', this.updateAll);\n    this.handler.listen(element.events, 'changeSize', this.updateAll);\n  }\n\n  private listenToLink(link: Link) {\n    const { view } = this.props;\n\n    const source = view.model.getElement(link.sourceId);\n    const target = view.model.getElement(link.targetId);\n\n    this.listenToElement(source);\n    this.listenToElement(target);\n\n    this.handler.listen(link.events, 'changeVertices', this.updateAll);\n    this.handler.listen(link.events, 'changeLabelBounds', this.updateAll);\n  }\n\n  private calculatePositionForElement(element: Element): Vector {\n    const { paperArea, size } = this.props;\n\n    const bbox = boundsOf(element);\n    const { y: y0 } = paperArea.paperToScrollablePaneCoords(bbox.x, bbox.y);\n    const { x: x1, y: y1 } = paperArea.paperToScrollablePaneCoords(bbox.x + bbox.width, bbox.y + bbox.height);\n\n    return {\n      x: x1 + ELEMENT_OFFSET,\n      y: (y0 + y1) / 2 - size.height / 2,\n    };\n  }\n\n  private calculatePositionForLink(link: Link): Vector {\n    const { view, paperArea } = this.props;\n\n    const source = view.model.getElement(link.sourceId);\n    const target = view.model.getElement(link.targetId);\n\n    if (!source || !target) {\n      throw new Error('Source and target are not specified');\n    }\n\n    const route = view.getRouting(link.id);\n    const verticesDefinedByUser = link.vertices || [];\n    const vertices = route ? route.vertices : verticesDefinedByUser;\n\n    const polyline = computePolyline(source, target, vertices);\n    const polylineLength = computePolylineLength(polyline);\n    const targetPoint = getPointAlongPolyline(polyline, polylineLength / 2);\n\n    const { x, y } = paperArea.paperToScrollablePaneCoords(targetPoint.x, targetPoint.y);\n\n    return { y: y + LINK_OFFSET, x: x + LINK_OFFSET };\n  }\n\n  private calculatePosition(): Vector {\n    const { target, paperArea, offset = { x: 0, y: 0 }, calculatePosition } = this.props;\n\n    if (calculatePosition) {\n      const pos = calculatePosition();\n      const { x, y } = paperArea.paperToScrollablePaneCoords(pos.x, pos.y);\n      return { x: x + offset.x, y: y + offset.y };\n    }\n\n    if (target instanceof Element) {\n      return this.calculatePositionForElement(target);\n    } else if (target instanceof Link) {\n      return this.calculatePositionForLink(target);\n    }\n\n    throw new Error('Unknown target type');\n  }\n\n  private getViewPortScrollablePoints(): { min: Vector; max: Vector } {\n    const { paperArea } = this.props;\n    const paperAreaMetrix = paperArea.getAreaMetrics();\n    const min = paperArea.clientToScrollablePaneCoords(0, 0);\n    const max = paperArea.clientToScrollablePaneCoords(paperAreaMetrix.clientWidth, paperAreaMetrix.clientHeight);\n    return { min, max };\n  }\n\n  private getDialogScrollablePoints(): { min: Vector; max: Vector } {\n    const { size } = this.props;\n    const { x, y } = this.calculatePosition();\n    const min = {\n      x: x - FOCUS_OFFSET,\n      y: y - FOCUS_OFFSET,\n    };\n    const max = {\n      x: min.x + size.width + FOCUS_OFFSET * 2,\n      y: min.y + size.height + FOCUS_OFFSET * 2,\n    };\n    return { min, max };\n  }\n\n  private focusOn() {\n    const { paperArea } = this.props;\n    const { min: viewPortMin, max: viewPortMax } = this.getViewPortScrollablePoints();\n    const { min, max } = this.getDialogScrollablePoints();\n\n    let xOffset = 0;\n    if (min.x < viewPortMin.x) {\n      xOffset = min.x - viewPortMin.x;\n    } else if (max.x > viewPortMax.x) {\n      xOffset = max.x - viewPortMax.x;\n    }\n\n    let yOffset = 0;\n    if (min.y < viewPortMin.y) {\n      yOffset = min.y - viewPortMin.y;\n    } else if (max.y > viewPortMax.y) {\n      yOffset = max.y - viewPortMax.y;\n    }\n\n    const curScrollableCenter = {\n      x: viewPortMin.x + (viewPortMax.x - viewPortMin.x) / 2,\n      y: viewPortMin.y + (viewPortMax.y - viewPortMin.y) / 2,\n    };\n    const newScrollabalCenter = {\n      x: curScrollableCenter.x + xOffset,\n      y: curScrollableCenter.y + yOffset,\n    };\n    const paperCenter = paperArea.scrollablePaneToPaperCoords(newScrollabalCenter.x, newScrollabalCenter.y);\n    paperArea.centerTo(paperCenter);\n  }\n\n  private startSize: Vector;\n  private onStartDragging = (e: React.MouseEvent<HTMLDivElement>) => {\n    this.preventSelection();\n    const { size } = this.props;\n    this.startSize = { x: this.state.width || size.width, y: this.state.height || size.height };\n  };\n\n  private calculateHeight(height: number) {\n    const { size } = this.props;\n    const minHeight = Math.min(size.height, MIN_HEIGHT);\n    const maxHeight = Math.max(size.height, MAX_HEIGHT);\n    return Math.max(minHeight, Math.min(maxHeight, height));\n  }\n\n  private calculateWidth(width: number) {\n    const { size } = this.props;\n    const minWidth = Math.min(size.width, MIN_WIDTH);\n    const maxWidth = Math.max(size.width, MAX_WIDTH);\n    return Math.max(minWidth, Math.min(maxWidth, width));\n  }\n\n  private onDragHandleBottom = (e: MouseEvent, dx: number, dy: number) => {\n    const height = this.calculateHeight(this.startSize.y + dy);\n    this.setState({ height });\n  };\n\n  private onDragHandleRight = (e: MouseEvent, dx: number) => {\n    const width = this.calculateWidth(this.startSize.x + dx);\n    this.setState({ width });\n  };\n\n  private onDragHandleBottomRight = (e: MouseEvent, dx: number, dy: number) => {\n    const width = this.calculateWidth(this.startSize.x + dx);\n    const height = this.calculateHeight(this.startSize.y + dy);\n    this.setState({ width, height });\n  };\n\n  private preventSelection = () => {\n    const onMouseUp = () => {\n      document.body.classList.remove('ontodia--unselectable');\n      document.removeEventListener('mouseup', onMouseUp);\n    };\n    document.addEventListener('mouseup', onMouseUp);\n    document.body.classList.add('ontodia--unselectable');\n  };\n\n  render() {\n    const { size, caption } = this.props;\n    const { x, y } = this.calculatePosition();\n    const width = this.state.width || size.width;\n    const height = this.state.height || size.height;\n    const style = {\n      top: y,\n      left: x,\n      width,\n      height,\n    };\n\n    return (\n      <div className={CLASS_NAME} style={style}>\n        <button className={`${CLASS_NAME}__close-button`} onClick={() => this.props.onClose()} />\n        {caption ? <div className=\"ontodia-dialog__caption\">{caption}</div> : null}\n        {this.props.children}\n        <DraggableHandle\n          className={`${CLASS_NAME}__bottom-handle`}\n          onBeginDragHandle={this.onStartDragging}\n          onDragHandle={this.onDragHandleBottom}\n        ></DraggableHandle>\n        <DraggableHandle\n          className={`${CLASS_NAME}__right-handle`}\n          onBeginDragHandle={this.onStartDragging}\n          onDragHandle={this.onDragHandleRight}\n        ></DraggableHandle>\n        <DraggableHandle\n          className={`${CLASS_NAME}__bottom-right-handle`}\n          onBeginDragHandle={this.onStartDragging}\n          onDragHandle={this.onDragHandleBottomRight}\n        ></DraggableHandle>\n      </div>\n    );\n  }\n}\n","import * as React from 'react';\n\nimport { DiagramView } from '../diagram/view';\nimport {\n  ElementModel,\n  LocalizedString,\n  PropertyTypeIri,\n  Property,\n  isIriProperty,\n  isLiteralProperty,\n  ElementIri,\n} from '../data/model';\n\nconst CLASS_NAME = 'ontodia-edit-form';\n\nexport interface Props {\n  view: DiagramView;\n  entity: ElementModel;\n  onApply: (entity: ElementModel) => void;\n  onCancel: () => void;\n}\n\nexport interface State {\n  elementModel?: ElementModel;\n}\n\nexport class EditEntityForm extends React.Component<Props, State> {\n  constructor(props: Props) {\n    super(props);\n\n    this.state = { elementModel: props.entity };\n  }\n\n  componentWillReceiveProps(nextProps: Props) {\n    if (this.props.entity !== nextProps.entity) {\n      this.setState({ elementModel: nextProps.entity });\n    }\n  }\n\n  private renderProperty = (key: PropertyTypeIri, property: Property) => {\n    const { view } = this.props;\n    const richProperty = view.model.getProperty(key);\n    const label = view.formatLabel(richProperty.label, key);\n\n    let values: string[] = [];\n    if (isIriProperty(property)) {\n      values = property.values.map(({ value }) => value);\n    } else if (isLiteralProperty(property)) {\n      values = property.values.map(({ value }) => value);\n    }\n    return (\n      <div key={key} className={`${CLASS_NAME}__form-row`}>\n        <label>\n          {label}\n          {values.map((value, index) => (\n            <input key={index} className=\"ontodia-form-control\" defaultValue={value} />\n          ))}\n        </label>\n      </div>\n    );\n  };\n\n  private renderProperties() {\n    const { properties } = this.props.entity;\n    const propertyIris = Object.keys(properties) as PropertyTypeIri[];\n    return (\n      <div>\n        {propertyIris.map((iri) => {\n          return this.renderProperty(iri, properties[iri]);\n        })}\n      </div>\n    );\n  }\n\n  private renderType() {\n    const { view } = this.props;\n    const { elementModel } = this.state;\n    const label = view.getElementTypeString(elementModel);\n    return (\n      <label>\n        Type\n        <input className=\"ontodia-form-control\" value={label} disabled={true} />\n      </label>\n    );\n  }\n\n  private onChangeIri = (e: React.FormEvent<HTMLInputElement>) => {\n    const target = e.target as HTMLInputElement;\n    const iri = target.value as ElementIri;\n    this.setState((prevState) => {\n      return {\n        elementModel: {\n          ...prevState.elementModel,\n          id: iri,\n        },\n      };\n    });\n  };\n\n  private renderIri() {\n    const { elementModel } = this.state;\n    return (\n      <label>\n        IRI\n        <input className=\"ontodia-form-control\" defaultValue={elementModel.id} onChange={this.onChangeIri} />\n      </label>\n    );\n  }\n\n  private onChangeLabel = (e: React.FormEvent<HTMLInputElement>) => {\n    const target = e.target as HTMLInputElement;\n\n    const labels: LocalizedString[] = target.value.length > 0 ? [{ value: target.value, language: '' }] : [];\n\n    this.setState({\n      elementModel: {\n        ...this.state.elementModel,\n        label: { values: labels },\n      },\n    });\n  };\n\n  private renderLabel() {\n    const { view } = this.props;\n    const label = view.selectLabel(this.state.elementModel.label.values);\n    const text = label ? label.value : '';\n    return (\n      <label>\n        Label\n        <input className=\"ontodia-form-control\" value={text} onChange={this.onChangeLabel} />\n      </label>\n    );\n  }\n\n  render() {\n    return (\n      <div className={CLASS_NAME}>\n        <div className={`${CLASS_NAME}__body`}>\n          <div className={`${CLASS_NAME}__form-row`}>{this.renderIri()}</div>\n          <div className={`${CLASS_NAME}__form-row`}>{this.renderType()}</div>\n          <div className={`${CLASS_NAME}__form-row`}>{this.renderLabel()}</div>\n          {this.renderProperties()}\n        </div>\n        <div className={`${CLASS_NAME}__controls`}>\n          <button\n            className={`ontodia-btn ontodia-btn-success ${CLASS_NAME}__apply-button`}\n            onClick={() => this.props.onApply(this.state.elementModel)}\n          >\n            Apply\n          </button>\n          <button className=\"ontodia-btn ontodia-btn-danger\" onClick={this.props.onCancel}>\n            Cancel\n          </button>\n        </div>\n      </div>\n    );\n  }\n}\n","import * as React from 'react';\n\nimport { EditorController } from '../editor/editorController';\nimport { DiagramView } from '../diagram/view';\nimport { ElementModel, LinkModel } from '../data/model';\nimport { MetadataApi } from '../data/metadataApi';\nimport { LinkDirection } from '../diagram/elements';\n\nimport { Cancellation } from '../viewUtils/async';\nimport { HtmlSpinner } from '../viewUtils/spinner';\n\nimport { ProgressBar, ProgressState } from '../widgets/progressBar';\n\nimport { ElementTypeSelector, ElementValue, validateElementType } from './elementTypeSelector';\nimport { LinkTypeSelector, LinkValue, validateLinkType } from './linkTypeSelector';\n\nconst CLASS_NAME = 'ontodia-edit-form';\n\nexport interface Props {\n  editor: EditorController;\n  view: DiagramView;\n  metadataApi?: MetadataApi;\n  link: LinkModel;\n  source: ElementModel;\n  target: {\n    value: ElementModel;\n    isNew: boolean;\n  };\n  onChangeElement: (value: ElementModel) => void;\n  onChangeLink: (value: LinkModel) => void;\n  onApply: (elementData: ElementModel, isNewElement: boolean, linkData: LinkModel) => void;\n  onCancel: () => void;\n}\n\nexport interface State {\n  elementValue?: ElementValue;\n  linkValue?: LinkValue;\n  isValidating?: boolean;\n}\n\nexport class EditElementTypeForm extends React.Component<Props, State> {\n  private validationCancellation = new Cancellation();\n\n  constructor(props: Props) {\n    super(props);\n    const { target, link } = this.props;\n    this.state = {\n      elementValue: {\n        value: target.value,\n        isNew: target.isNew,\n        loading: false,\n        validated: true,\n        allowChange: true,\n      },\n      linkValue: {\n        value: { link, direction: LinkDirection.out },\n        validated: true,\n        allowChange: true,\n      },\n    };\n  }\n\n  componentDidMount() {\n    this.validate();\n  }\n\n  componentWillUnmount() {\n    this.validationCancellation.abort();\n  }\n\n  private setElementOrLink({ elementValue, linkValue }: { elementValue?: ElementValue; linkValue?: LinkValue }) {\n    this.setState(\n      (state) => ({\n        elementValue: elementValue || state.elementValue,\n        linkValue: linkValue || state.linkValue,\n      }),\n      () => {\n        if ((elementValue && !elementValue.validated) || (linkValue && !linkValue.validated)) {\n          this.validate();\n        }\n        if (elementValue && elementValue.validated && elementValue.allowChange) {\n          this.props.onChangeElement(elementValue.value);\n        }\n        if (linkValue && linkValue.validated && linkValue.allowChange) {\n          this.props.onChangeLink(linkValue.value.link);\n        }\n      }\n    );\n  }\n\n  private validate() {\n    const { editor, link: originalLink } = this.props;\n    const { elementValue, linkValue } = this.state;\n    this.setState({ isValidating: true });\n\n    this.validationCancellation.abort();\n    this.validationCancellation = new Cancellation();\n    const signal = this.validationCancellation.signal;\n\n    const validateElement = validateElementType(elementValue.value);\n    const validateLink = validateLinkType(editor, linkValue.value.link, originalLink);\n    Promise.all([validateElement, validateLink]).then(([elementError, linkError]) => {\n      if (signal.aborted) {\n        return;\n      }\n      this.setState({ isValidating: false });\n      this.setElementOrLink({\n        elementValue: { ...elementValue, ...elementError, validated: true },\n        linkValue: { ...linkValue, ...linkError, validated: true },\n      });\n    });\n  }\n\n  render() {\n    const { editor, view, metadataApi, source, link: originalLink } = this.props;\n    const { elementValue, linkValue, isValidating } = this.state;\n    const isValid = !elementValue.error && !linkValue.error;\n    return (\n      <div className={CLASS_NAME}>\n        <div className={`${CLASS_NAME}__body`}>\n          <ElementTypeSelector\n            editor={editor}\n            view={view}\n            metadataApi={metadataApi}\n            source={source}\n            elementValue={elementValue}\n            onChange={(newState) => {\n              this.setElementOrLink({\n                elementValue: {\n                  value: newState.value,\n                  isNew: newState.isNew,\n                  loading: newState.loading,\n                  error: undefined,\n                  validated: false,\n                  allowChange: false,\n                },\n                linkValue: {\n                  value: {\n                    link: { ...originalLink, targetId: newState.value.id },\n                    direction: LinkDirection.out,\n                  },\n                  validated: false,\n                  allowChange: false,\n                },\n              });\n            }}\n          />\n          {elementValue.loading ? (\n            <div style={{ display: 'flex' }}>\n              <HtmlSpinner width={20} height={20} />\n              &nbsp;Loading entity...\n            </div>\n          ) : (\n            <LinkTypeSelector\n              editor={editor}\n              view={view}\n              metadataApi={metadataApi}\n              linkValue={linkValue}\n              source={source}\n              target={elementValue.value}\n              onChange={(value) =>\n                this.setElementOrLink({\n                  linkValue: { value, error: undefined, validated: false, allowChange: false },\n                })\n              }\n              disabled={elementValue.error !== undefined}\n            />\n          )}\n          {isValidating ? (\n            <div className={`${CLASS_NAME}__progress`}>\n              <ProgressBar state={ProgressState.loading} height={10} />\n            </div>\n          ) : null}\n        </div>\n        <div className={`${CLASS_NAME}__controls`}>\n          <button\n            className={`ontodia-btn ontodia-btn-success ${CLASS_NAME}__apply-button`}\n            onClick={() => this.props.onApply(elementValue.value, elementValue.isNew, linkValue.value.link)}\n            disabled={elementValue.loading || !isValid || isValidating}\n          >\n            Apply\n          </button>\n          <button className=\"ontodia-btn ontodia-btn-danger\" onClick={this.props.onCancel}>\n            Cancel\n          </button>\n        </div>\n      </div>\n    );\n  }\n}\n","import * as React from 'react';\n\nimport { PLACEHOLDER_ELEMENT_TYPE } from '../data/schema';\nimport { ElementModel, ElementIri, ElementTypeIri } from '../data/model';\n\nimport { EditorController } from '../editor/editorController';\nimport { DiagramView } from '../diagram/view';\nimport { MetadataApi } from '../data/metadataApi';\n\nimport { createRequest } from '../widgets/instancesSearch';\nimport { ListElementView } from '../widgets/listElementView';\n\nimport { Cancellation, CancellationToken } from '../viewUtils/async';\nimport { HtmlSpinner } from '../viewUtils/spinner';\n\nconst CLASS_NAME = 'ontodia-edit-form';\n\nexport interface ElementValue {\n  value: ElementModel;\n  isNew: boolean;\n  loading: boolean;\n  error?: string;\n  validated: boolean;\n  allowChange: boolean;\n}\n\nexport interface Props {\n  editor: EditorController;\n  view: DiagramView;\n  metadataApi: MetadataApi | undefined;\n  source: ElementModel;\n  elementValue: ElementValue;\n  onChange: (state: Pick<ElementValue, 'value' | 'isNew' | 'loading'>) => void;\n}\n\nexport interface State {\n  elementTypes?: ReadonlyArray<ElementTypeIri>;\n  searchString?: string;\n  isLoading?: boolean;\n  existingElements?: ReadonlyArray<ElementModel>;\n}\n\nexport class ElementTypeSelector extends React.Component<Props, State> {\n  private readonly cancellation = new Cancellation();\n  private filterCancellation = new Cancellation();\n  private loadingItemCancellation = new Cancellation();\n\n  constructor(props: Props) {\n    super(props);\n    this.state = { searchString: '', existingElements: [] };\n  }\n\n  componentDidMount() {\n    this.fetchPossibleElementTypes();\n  }\n\n  componentDidUpdate(prevProps: Props, prevState: State) {\n    const { searchString } = this.state;\n    if (searchString !== prevState.searchString) {\n      this.searchExistingElements();\n    }\n  }\n\n  componentWillUnmount() {\n    this.cancellation.abort();\n    this.filterCancellation.abort();\n    this.loadingItemCancellation.abort();\n  }\n\n  private async fetchPossibleElementTypes() {\n    const { view, metadataApi, source } = this.props;\n    if (!metadataApi) {\n      return;\n    }\n    const elementTypes = await CancellationToken.mapCancelledToNull(\n      this.cancellation.signal,\n      metadataApi.typesOfElementsDraggedFrom(source, this.cancellation.signal)\n    );\n    if (elementTypes === null) {\n      return;\n    }\n    elementTypes.sort(makeElementTypeComparatorByLabel(view));\n    this.setState({ elementTypes });\n  }\n\n  private searchExistingElements() {\n    const { editor, view } = this.props;\n    const { searchString } = this.state;\n    this.setState({ existingElements: [] });\n    if (searchString.length > 0) {\n      this.setState({ isLoading: true });\n\n      this.filterCancellation.abort();\n      this.filterCancellation = new Cancellation();\n      const signal = this.filterCancellation.signal;\n\n      const request = createRequest({ text: searchString }, view.getLanguage());\n      editor.model.dataProvider.filter(request).then((elements) => {\n        if (signal.aborted) {\n          return;\n        }\n        const existingElements = Object.keys(elements).map((key) => elements[key]);\n        this.setState({ existingElements, isLoading: false });\n      });\n    }\n  }\n\n  private onElementTypeChange = async (e: React.FormEvent<HTMLSelectElement>) => {\n    this.setState({ isLoading: true });\n\n    this.loadingItemCancellation.abort();\n    this.loadingItemCancellation = new Cancellation();\n    const signal = this.loadingItemCancellation.signal;\n\n    const { onChange, metadataApi } = this.props;\n    const classId = (e.target as HTMLSelectElement).value as ElementTypeIri;\n    const elementModel = await CancellationToken.mapCancelledToNull(\n      signal,\n      metadataApi.generateNewElement([classId], signal)\n    );\n    if (elementModel === null) {\n      return;\n    }\n    this.setState({ isLoading: false });\n    onChange({\n      value: elementModel,\n      isNew: true,\n      loading: false,\n    });\n  };\n\n  private renderPossibleElementType = (elementType: ElementTypeIri) => {\n    const { view } = this.props;\n    const type = view.model.createClass(elementType);\n    const label = view.formatLabel(type.label, type.id);\n    return (\n      <option key={elementType} value={elementType}>\n        {label}\n      </option>\n    );\n  };\n\n  private renderElementTypeSelector() {\n    const { elementValue } = this.props;\n    const { elementTypes, isLoading } = this.state;\n    const value = elementValue.value.types.length ? elementValue.value.types[0] : '';\n    if (isLoading) {\n      return <HtmlSpinner width={20} height={20} />;\n    }\n    return (\n      <div className={`${CLASS_NAME}__control-row`}>\n        <label>Entity Type</label>\n        {elementTypes ? (\n          <select className=\"ontodia-form-control\" value={value} onChange={this.onElementTypeChange}>\n            <option value={PLACEHOLDER_ELEMENT_TYPE} disabled={true}>\n              Select entity type\n            </option>\n            {elementTypes.map(this.renderPossibleElementType)}\n          </select>\n        ) : (\n          <div>\n            <HtmlSpinner width={20} height={20} />\n          </div>\n        )}\n        {elementValue.error ? <span className={`${CLASS_NAME}__control-error`}>{elementValue.error}</span> : ''}\n      </div>\n    );\n  }\n\n  private renderExistingElementsList() {\n    const { view, editor, elementValue } = this.props;\n    const { elementTypes, isLoading, existingElements } = this.state;\n    if (isLoading) {\n      return <HtmlSpinner width={20} height={20} />;\n    }\n    if (existingElements.length > 0) {\n      return existingElements.map((element) => {\n        const isAlreadyOnDiagram =\n          !editor.temporaryState.elements.has(element.id) &&\n          Boolean(editor.model.elements.find(({ iri, group }) => iri === element.id && group === undefined));\n        const hasAppropriateType = Boolean(elementTypes.find((type) => element.types.indexOf(type) >= 0));\n        return (\n          <ListElementView\n            key={element.id}\n            view={view}\n            model={element}\n            disabled={isAlreadyOnDiagram || !hasAppropriateType}\n            selected={element.id === elementValue.value.id}\n            onClick={(e, model) => this.onSelectExistingItem(model)}\n          />\n        );\n      });\n    }\n    return <span>No results</span>;\n  }\n\n  private async onSelectExistingItem(model: ElementModel) {\n    const { editor, onChange } = this.props;\n\n    this.loadingItemCancellation.abort();\n    this.loadingItemCancellation = new Cancellation();\n    const signal = this.loadingItemCancellation.signal;\n\n    onChange({ value: model, isNew: false, loading: true });\n    const result = await editor.model.dataProvider.elementInfo({ elementIds: [model.id] });\n    if (signal.aborted) {\n      return;\n    }\n\n    const loadedModel = result[model.id];\n    onChange({ value: loadedModel, isNew: false, loading: false });\n  }\n\n  render() {\n    const { searchString } = this.state;\n    return (\n      <div className={`${CLASS_NAME}__form-row ${CLASS_NAME}__element-selector`}>\n        <div className={`${CLASS_NAME}__search`}>\n          <i className={`fa fa-search ${CLASS_NAME}__search-icon`} />\n          <input\n            value={searchString}\n            onChange={(e) => this.setState({ searchString: (e.target as HTMLInputElement).value })}\n            className={`ontodia-form-control ${CLASS_NAME}__search-input`}\n            placeholder=\"Search for...\"\n            autoFocus\n          />\n        </div>\n        {searchString.length > 0 ? (\n          <div className={`${CLASS_NAME}__existing-elements-list`}>{this.renderExistingElementsList()}</div>\n        ) : (\n          <div>\n            <div className={`${CLASS_NAME}__separator`}>\n              <span className={`${CLASS_NAME}__separator-text`}>or create new entity</span>\n            </div>\n            {this.renderElementTypeSelector()}\n          </div>\n        )}\n      </div>\n    );\n  }\n}\n\nfunction makeElementTypeComparatorByLabel(view: DiagramView) {\n  return (a: ElementTypeIri, b: ElementTypeIri) => {\n    const typeA = view.model.createClass(a);\n    const typeB = view.model.createClass(b);\n    const labelA = view.formatLabel(typeA.label, typeA.id);\n    const labelB = view.formatLabel(typeB.label, typeB.id);\n    return labelA.localeCompare(labelB);\n  };\n}\n\nexport function validateElementType(element: ElementModel): Promise<Pick<ElementValue, 'error' | 'allowChange'>> {\n  const isElementTypeSelected = element.types.indexOf(PLACEHOLDER_ELEMENT_TYPE) < 0;\n  const error = !isElementTypeSelected ? 'Required.' : undefined;\n  return Promise.resolve({ error, allowChange: true });\n}\n","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAbCAYAAAAOEM1uAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAZEQAAGREBkIelaAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAG2SURBVFiFzde9axRRFMbhJ3Hjx0YRgkWElGIRGyVgaaG9XQpBrNIETJHKjxBSJCA2NiIWdhYKgoqCIELq/AU2tiJpAiliDMHEWEyKZfdO5szHrr4wzcx77vnNnXPnnktcK9jBwYCuLcwNBeHGsIGovyltDweNbYOHg9Eo4D9Tq0bsGj40BXKoO5isEjiht4ifHuE/qVpJvO/O049PvIxN/MBMH8ZP6pzeGVxK+C4kfAsl8vTMYBnI1x1Bv3E54bmWSHCAx2KfvBbgKGbxJAfOIcS7HMjnKCqpWoBRtfE5B/IVRsoAtnAGd3GlQchd/NE7Y7dwCtPYiw72xuD216KFk/zN3Ii+SYOajhqHZUU9aK1GjS3M4xumFK+yMuPexLHEsy9YbChPJR3HW+na+yjbBvNU+zdzHbcxfoTnUw7cS8XNSS3AFx1B6zif8FzKgXsmVj6VAduyFrwzcCUHcL/L9yiaJAUYXRRjON1172zC9xX3ZS+ziTk8KAFYWWX7wRGcqJAnudVV1RTu1YhP6WL3jWjXO4HvzbLE9N8fmqKAv/SpNyvQdmorSmlHVvhX1TsJltFPPPwL/+nTC6wUIf8AAAAASUVORK5CYII=\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAbCAYAAAAOEM1uAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAZEQAAGREBkIelaAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAGCSURBVFiFzdi9ShxRFAfwn+uiaAoRVBQbbfMEFqIoFja+QCoLLQQr8R0sbdIJgTQiSgT1AcTKzkdIQhpTaOlX0GyK2WJ2c8d1Pt0/XBjOnTnnP+eerxnYxj0aJa9nfEOvlLirgFx8zaQhV8Ng2jfKiVT2amWxKAr1gOwElwXpH8NWXiXtMbKZV2EMHwP6F2P7dR1O8T2PeBW/8EMHp5TpwWGtJewF06JEuWmzu4ueqgnC55juw6ZsHE8B218F8qJsgkS1b0Grh74EbDdwioGqCYbQj6MEkhcYIlxm3opZrGEyh47eJqH22JvDOZbJ5sEJ4Rgqeh1nLTMr6Mv4bBpMZSV4hj9FMknA96wxeC3qCOvyxWAd88L17wobdHkWV0VwxP+e3ksgd6LiOrgtyvhn7DRlo3gM2K68kwziNqb7QTSC9eN3m9136cWvjVuf8FOHaSZPJ8mLfRw0r/8m3RQiuIQPBZEY67CfSCyOsttV0hG/CV3/0VQTTbxVIrW9rv6z8A+8NRQ5z9bcwQAAAABJRU5ErkJggg==\"","import * as React from 'react';\n\nimport { MetadataApi } from '../data/metadataApi';\nimport { ElementModel, LinkModel, sameLink } from '../data/model';\n\nimport { EditorController } from '../editor/editorController';\nimport { DiagramView } from '../diagram/view';\nimport { LinkDirection } from '../diagram/elements';\n\nimport { Cancellation } from '../viewUtils/async';\n\nimport { ProgressBar, ProgressState } from '../widgets/progressBar';\n\nimport { LinkTypeSelector, LinkValue, validateLinkType } from './linkTypeSelector';\n\nconst CLASS_NAME = 'ontodia-edit-form';\n\nexport interface Props {\n  editor: EditorController;\n  view: DiagramView;\n  metadataApi: MetadataApi | undefined;\n  link: LinkModel;\n  source: ElementModel;\n  target: ElementModel;\n  onChange: (entity: LinkModel) => void;\n  onApply: (entity: LinkModel) => void;\n  onCancel: () => void;\n}\n\nexport interface State {\n  linkValue?: LinkValue;\n  isValidating?: boolean;\n}\n\nexport class EditLinkForm extends React.Component<Props, State> {\n  private validationCancellation = new Cancellation();\n\n  constructor(props: Props) {\n    super(props);\n    this.state = {\n      linkValue: {\n        value: { link: props.link, direction: LinkDirection.out },\n        validated: true,\n        allowChange: true,\n      },\n    };\n  }\n\n  componentDidMount() {\n    this.validate();\n  }\n\n  componentDidUpdate(prevProps: Props, prevState: State) {\n    const { linkValue } = this.state;\n    if (!sameLink(linkValue.value.link, prevState.linkValue.value.link)) {\n      this.validate();\n    }\n    if (linkValue !== prevState.linkValue && linkValue.validated && linkValue.allowChange) {\n      this.props.onChange(linkValue.value.link);\n    }\n  }\n\n  componentWillUnmount() {\n    this.validationCancellation.abort();\n  }\n\n  private validate() {\n    const { editor, link: originalLink } = this.props;\n    const {\n      linkValue: { value },\n    } = this.state;\n    this.setState({ isValidating: true });\n\n    this.validationCancellation.abort();\n    this.validationCancellation = new Cancellation();\n    const signal = this.validationCancellation.signal;\n\n    validateLinkType(editor, value.link, originalLink).then((error) => {\n      if (signal.aborted) {\n        return;\n      }\n      this.setState(({ linkValue }) => ({\n        linkValue: { ...linkValue, ...error, validated: true },\n        isValidating: false,\n      }));\n    });\n  }\n\n  render() {\n    const { editor, view, metadataApi, source, target } = this.props;\n    const { linkValue, isValidating } = this.state;\n    const isValid = !linkValue.error;\n    return (\n      <div className={CLASS_NAME}>\n        <div className={`${CLASS_NAME}__body`}>\n          <LinkTypeSelector\n            editor={editor}\n            view={view}\n            metadataApi={metadataApi}\n            linkValue={linkValue}\n            source={source}\n            target={target}\n            onChange={(value) =>\n              this.setState({\n                linkValue: { value, error: undefined, validated: false, allowChange: false },\n              })\n            }\n          />\n          {isValidating ? (\n            <div className={`${CLASS_NAME}__progress`}>\n              <ProgressBar state={ProgressState.loading} height={10} />\n            </div>\n          ) : null}\n        </div>\n        <div className={`${CLASS_NAME}__controls`}>\n          <button\n            className={`ontodia-btn ontodia-btn-success ${CLASS_NAME}__apply-button`}\n            onClick={() => this.props.onApply(linkValue.value.link)}\n            disabled={!isValid || isValidating}\n          >\n            Apply\n          </button>\n          <button className=\"ontodia-btn ontodia-btn-danger\" onClick={this.props.onCancel}>\n            Cancel\n          </button>\n        </div>\n      </div>\n    );\n  }\n}\n","import * as React from 'react';\n\nimport { Link } from '../diagram/elements';\nimport { DiagramView } from '../diagram/view';\n\nconst CLASS_NAME = 'ontodia-edit-form';\n\nexport interface Props {\n  view: DiagramView;\n  link: Link;\n  onApply: (label: string) => void;\n  onCancel: () => void;\n}\n\nexport interface State {\n  label?: string;\n}\n\nexport class EditLinkLabelForm extends React.Component<Props, State> {\n  constructor(props: Props) {\n    super(props);\n    const label = this.computeLabel();\n    this.state = { label };\n  }\n\n  componentDidUpdate(prevProps: Props) {\n    if (this.props.link.typeId !== prevProps.link.typeId) {\n      const label = this.computeLabel();\n      this.setState({ label });\n    }\n  }\n\n  private computeLabel(): string {\n    const { view, link } = this.props;\n\n    const linkType = view.model.getLinkType(link.typeId);\n    const template = view.createLinkTemplate(linkType);\n    const { label = {} } = template.renderLink(link);\n\n    const labelTexts = label.attrs && label.attrs.text ? label.attrs.text.text : undefined;\n    return labelTexts && labelTexts.length > 0\n      ? view.selectLabel(labelTexts).value\n      : view.formatLabel(linkType.label, linkType.id);\n  }\n\n  render() {\n    const { onApply, onCancel } = this.props;\n    const { label } = this.state;\n    return (\n      <div className={CLASS_NAME}>\n        <div className={`${CLASS_NAME}__body`}>\n          <div className={`${CLASS_NAME}__form-row`}>\n            <label>Link Label</label>\n            <input\n              className=\"ontodia-form-control\"\n              value={label}\n              onChange={(e) => this.setState({ label: (e.target as HTMLInputElement).value })}\n            />\n          </div>\n        </div>\n        <div className={`${CLASS_NAME}__controls`}>\n          <button\n            className={`ontodia-btn ontodia-btn-success ${CLASS_NAME}__apply-button`}\n            onClick={() => onApply(label)}\n          >\n            Apply\n          </button>\n          <button className=\"ontodia-btn ontodia-btn-danger\" onClick={() => onCancel()}>\n            Cancel\n          </button>\n        </div>\n      </div>\n    );\n  }\n}\n","import * as React from 'react';\n\nimport { MetadataApi } from '../data/metadataApi';\n\nimport { Element as DiagramElement, ElementEvents, Element } from '../diagram/elements';\nimport { Vector, boundsOf } from '../diagram/geometry';\nimport { PaperWidgetProps } from '../diagram/paperArea';\n\nimport { EditorController } from '../editor/editorController';\nimport { AuthoringState } from '../editor/authoringState';\n\nimport { AnyListener, EventObserver } from '../viewUtils/events';\nimport { Cancellation, CancellationToken, Debouncer } from '../viewUtils/async';\nimport { HtmlSpinner } from '../viewUtils/spinner';\n\nexport interface Props extends PaperWidgetProps {\n  target: DiagramElement | undefined;\n  editor: EditorController;\n  metadataApi?: MetadataApi;\n  onRemove?: () => void;\n  onExpand?: () => void;\n  navigationMenuOpened?: boolean;\n  onToggleNavigationMenu?: () => void;\n  onAddToFilter?: () => void;\n  onEstablishNewLink?: (point: Vector) => void;\n  onFollowLink?: (element: Element, event: React.MouseEvent<any>) => void;\n}\n\nexport interface State {\n  canLink?: boolean;\n}\n\nconst CLASS_NAME = 'ontodia-halo';\n\nexport class Halo extends React.Component<Props, State> {\n  private readonly listener = new EventObserver();\n  private targetListener = new EventObserver();\n  private queryDebouncer = new Debouncer();\n  private queryCancellation = new Cancellation();\n\n  constructor(props: Props) {\n    super(props);\n    this.state = {};\n  }\n\n  componentDidMount() {\n    const { editor, target } = this.props;\n    this.listener.listen(editor.events, 'changeAuthoringState', () => {\n      this.queryAllowedActions();\n    });\n    this.listenToElement(target);\n    this.queryAllowedActions();\n  }\n\n  componentDidUpdate(prevProps: Props) {\n    if (prevProps.target !== this.props.target) {\n      this.listenToElement(this.props.target);\n      this.queryAllowedActions();\n    }\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n    this.listenToElement(undefined);\n    this.queryDebouncer.dispose();\n    this.queryCancellation.abort();\n  }\n\n  listenToElement(element: DiagramElement | undefined) {\n    this.targetListener.stopListening();\n    if (element) {\n      this.targetListener.listenAny(element.events, this.onElementEvent);\n    }\n  }\n\n  private queryAllowedActions() {\n    this.queryDebouncer.call(() => {\n      this.queryCancellation.abort();\n      this.queryCancellation = new Cancellation();\n      this.canLink(this.props.target);\n    });\n  }\n\n  private canLink(target: DiagramElement) {\n    const { metadataApi, editor } = this.props;\n    if (!metadataApi) {\n      this.setState({ canLink: false });\n      return;\n    }\n    const event = editor.authoringState.elements.get(target.iri);\n    if (event && event.deleted) {\n      this.setState({ canLink: false });\n    } else {\n      this.setState({ canLink: undefined });\n      const signal = this.queryCancellation.signal;\n      CancellationToken.mapCancelledToNull(signal, metadataApi.canLinkElement(target.data, signal)).then((canLink) => {\n        if (canLink === null) {\n          return;\n        }\n        if (this.props.target.iri === target.iri) {\n          this.setState({ canLink });\n        }\n      });\n    }\n  }\n\n  private onElementEvent: AnyListener<ElementEvents> = (data) => {\n    if (data.changePosition || data.changeSize || data.changeExpanded) {\n      this.forceUpdate();\n    }\n    if (data.changeData) {\n      this.queryAllowedActions();\n    }\n  };\n\n  render() {\n    const {\n      paperArea,\n      editor,\n      target,\n      navigationMenuOpened,\n      onToggleNavigationMenu,\n      onAddToFilter,\n      onExpand,\n      onFollowLink,\n    } = this.props;\n\n    if (!target) {\n      return <div className={CLASS_NAME} style={{ display: 'none' }} />;\n    }\n\n    const bbox = boundsOf(target);\n    const { x: x0, y: y0 } = paperArea.paperToScrollablePaneCoords(bbox.x, bbox.y);\n    const { x: x1, y: y1 } = paperArea.paperToScrollablePaneCoords(bbox.x + bbox.width, bbox.y + bbox.height);\n    const MARGIN = 5;\n    const style: React.CSSProperties = {\n      left: x0 - MARGIN,\n      top: y0 - MARGIN,\n      width: x1 - x0 + MARGIN * 2,\n      height: y1 - y0 + MARGIN * 2,\n    };\n\n    return (\n      <div className={CLASS_NAME} style={style}>\n        {this.renderRemoveOrDeleteButton()}\n        {onToggleNavigationMenu && (\n          <div\n            className={\n              `${CLASS_NAME}__navigate ` + `${CLASS_NAME}__navigate--${navigationMenuOpened ? 'closed' : 'open'}`\n            }\n            role=\"button\"\n            title=\"Open a dialog to navigate to connected elements\"\n            onClick={onToggleNavigationMenu}\n          />\n        )}\n        {onFollowLink && (\n          <a\n            className={`${CLASS_NAME}__folow`}\n            href={target.iri}\n            role=\"button\"\n            title=\"Jump to resource\"\n            onClick={(e) => onFollowLink(target, e)}\n          />\n        )}\n        {onAddToFilter && (\n          <div\n            className={`${CLASS_NAME}__add-to-filter`}\n            role=\"button\"\n            title=\"Search for connected elements\"\n            onClick={onAddToFilter}\n          />\n        )}\n        {onExpand && (\n          <div\n            className={`${CLASS_NAME}__expand ` + `${CLASS_NAME}__expand--${target.isExpanded ? 'closed' : 'open'}`}\n            role=\"button\"\n            title={`Expand an element to reveal additional properties`}\n            onClick={onExpand}\n          />\n        )}\n        {editor.inAuthoringMode ? this.renderEstablishNewLinkButton() : null}\n      </div>\n    );\n  }\n\n  private renderRemoveOrDeleteButton() {\n    const { editor, target, onRemove } = this.props;\n    if (!onRemove) {\n      return null;\n    }\n\n    const isNewElement = AuthoringState.isNewElement(editor.authoringState, target.iri);\n    return (\n      <div\n        className={isNewElement ? `${CLASS_NAME}__delete` : `${CLASS_NAME}__remove`}\n        role=\"button\"\n        title={isNewElement ? 'Delete new element' : 'Remove an element from the diagram'}\n        onClick={onRemove}\n      ></div>\n    );\n  }\n\n  private renderEstablishNewLinkButton() {\n    const { onEstablishNewLink } = this.props;\n    const { canLink } = this.state;\n    if (!onEstablishNewLink) {\n      return null;\n    }\n    if (canLink === undefined) {\n      return (\n        <div className={`${CLASS_NAME}__establish-connection-spinner`}>\n          <HtmlSpinner width={20} height={20} />\n        </div>\n      );\n    }\n    const title = canLink ? 'Establish connection' : 'Establishing connection is unavailable for the selected element';\n    return (\n      <button\n        className={`${CLASS_NAME}__establish-connection`}\n        title={title}\n        onMouseDown={this.onEstablishNewLink}\n        disabled={!canLink}\n      />\n    );\n  }\n\n  private onEstablishNewLink = (e: React.MouseEvent<HTMLElement>) => {\n    const point = this.props.paperArea.pageToPaperCoords(e.pageX, e.pageY);\n    this.props.onEstablishNewLink(point);\n  };\n}\n","import * as React from 'react';\n\nimport { MetadataApi } from '../data/metadataApi';\n\nimport { Element, Link } from '../diagram/elements';\nimport { computePolyline, computePolylineLength, getPointAlongPolyline, Vector } from '../diagram/geometry';\nimport { PaperWidgetProps } from '../diagram/paperArea';\nimport { DiagramView } from '../diagram/view';\n\nimport { EditorController } from '../editor/editorController';\nimport { AuthoringState } from '../editor/authoringState';\n\nimport { EventObserver } from '../viewUtils/events';\nimport { Cancellation, CancellationToken, Debouncer } from '../viewUtils/async';\nimport { HtmlSpinner } from '../viewUtils/spinner';\n\nconst CLASS_NAME = 'ontodia-halo-link';\nconst BUTTON_SIZE = 20;\nconst BUTTON_MARGIN = 5;\n\nexport interface Props extends PaperWidgetProps {\n  view: DiagramView;\n  editor: EditorController;\n  metadataApi?: MetadataApi;\n  target: Link;\n  onEdit: () => void;\n  onDelete: () => void;\n  onSourceMove: (point: { x: number; y: number }) => void;\n  onTargetMove: (point: { x: number; y: number }) => void;\n  onEditLabel: () => void;\n}\n\nexport interface State {\n  canDelete?: boolean;\n  canEdit?: boolean;\n}\n\nexport class HaloLink extends React.Component<Props, State> {\n  private readonly listener = new EventObserver();\n  private targetListener = new EventObserver();\n  private queryDebouncer = new Debouncer();\n  private queryCancellation = new Cancellation();\n\n  constructor(props: Props) {\n    super(props);\n    this.state = {};\n  }\n\n  private updateAll = () => this.forceUpdate();\n\n  componentDidMount() {\n    const { target, editor } = this.props;\n    this.listener.listen(editor.events, 'changeAuthoringState', () => {\n      this.queryAllowedActions();\n    });\n    this.listenToTarget(target);\n    this.queryAllowedActions();\n  }\n\n  componentDidUpdate(prevProps: Props) {\n    if (prevProps.target !== this.props.target) {\n      this.listenToTarget(this.props.target);\n      this.queryAllowedActions();\n    }\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n    this.listenToTarget(undefined);\n    this.queryDebouncer.dispose();\n    this.queryCancellation.abort();\n  }\n\n  private queryAllowedActions() {\n    this.queryDebouncer.call(() => {\n      this.queryCancellation.abort();\n      this.queryCancellation = new Cancellation();\n      this.queryCanDelete(this.props.target);\n      this.queryCanEdit(this.props.target);\n    });\n  }\n\n  private queryCanDelete(link: Link) {\n    const { metadataApi, editor, view } = this.props;\n    if (!metadataApi) {\n      this.setState({ canDelete: false });\n      return;\n    }\n    if (isSourceOrTargetDeleted(editor.authoringState, link)) {\n      this.setState({ canDelete: false });\n    } else {\n      this.setState({ canDelete: undefined });\n      const source = view.model.getElement(link.sourceId);\n      const target = view.model.getElement(link.targetId);\n      const signal = this.queryCancellation.signal;\n      CancellationToken.mapCancelledToNull(\n        signal,\n        metadataApi.canDeleteLink(link.data, source.data, target.data, signal)\n      ).then((canDelete) => {\n        if (canDelete === null) {\n          return;\n        }\n        if (this.props.target.id === link.id) {\n          this.setState({ canDelete });\n        }\n      });\n    }\n  }\n\n  private queryCanEdit(link: Link) {\n    const { metadataApi, editor, view } = this.props;\n    if (!metadataApi) {\n      this.setState({ canEdit: false });\n      return;\n    }\n    if (isDeletedLink(editor.authoringState, link)) {\n      this.setState({ canEdit: false });\n    } else {\n      this.setState({ canEdit: undefined });\n      const source = view.model.getElement(link.sourceId);\n      const target = view.model.getElement(link.targetId);\n      const signal = this.queryCancellation.signal;\n      CancellationToken.mapCancelledToNull(\n        signal,\n        metadataApi.canEditLink(link.data, source.data, target.data, signal)\n      ).then((canEdit) => {\n        if (canEdit === null) {\n          return;\n        }\n        if (this.props.target.id === link.id) {\n          this.setState({ canEdit });\n        }\n      });\n    }\n  }\n\n  private listenToTarget(link: Link | undefined) {\n    const { view } = this.props;\n\n    this.targetListener.stopListening();\n    if (link) {\n      const source = view.model.getElement(link.sourceId);\n      const target = view.model.getElement(link.targetId);\n\n      const listenToElement = (element: Element) => {\n        this.targetListener.listen(element.events, 'changePosition', this.updateAll);\n        this.targetListener.listen(element.events, 'changeSize', this.updateAll);\n      };\n\n      listenToElement(source);\n      listenToElement(target);\n      this.targetListener.listen(link.events, 'changeVertices', this.updateAll);\n      this.targetListener.listen(link.events, 'changeLabelBounds', this.updateAll);\n    }\n  }\n\n  private paperToScrollablePaneCoords(point: Vector): Vector {\n    return this.props.paperArea.paperToScrollablePaneCoords(point.x, point.y);\n  }\n\n  private computePolyline(): ReadonlyArray<Vector> {\n    const { view, target } = this.props;\n\n    const sourceElement = view.model.getElement(target.sourceId);\n    const targetElement = view.model.getElement(target.targetId);\n\n    if (!(sourceElement && targetElement)) {\n      return undefined;\n    }\n\n    const route = view.getRouting(target.id);\n    const verticesDefinedByUser = target.vertices || [];\n    const vertices = route ? route.vertices : verticesDefinedByUser;\n\n    return computePolyline(sourceElement, targetElement, vertices);\n  }\n\n  private calculateDegree(source: Vector, target: Vector): number {\n    const x = target.x - source.x;\n    const y = target.y - source.y;\n    const r = Math.sqrt(x * x + y * y);\n    const unit = { x: x / r, y: y / r };\n    return Math.atan2(unit.y, unit.x) * (180 / Math.PI);\n  }\n\n  private onSourceMove = (e: React.MouseEvent<HTMLElement>) => {\n    const point = this.props.paperArea.pageToPaperCoords(e.pageX, e.pageY);\n    this.props.onSourceMove(point);\n  };\n\n  private renderSourceButton(polyline: ReadonlyArray<Vector>) {\n    const { editor, target } = this.props;\n    const point = getPointAlongPolyline(polyline, 0);\n    const { x, y } = this.paperToScrollablePaneCoords(point);\n\n    const style = { top: y - BUTTON_SIZE / 2, left: x - BUTTON_SIZE / 2 };\n\n    return (\n      <button\n        className={`${CLASS_NAME}__button`}\n        style={style}\n        disabled={isDeletedLink(editor.authoringState, target)}\n        onMouseDown={this.onSourceMove}\n      >\n        <svg width={BUTTON_SIZE} height={BUTTON_SIZE}>\n          <g transform={`scale(${BUTTON_SIZE})`}>\n            <circle r={0.5} cx={0.5} cy={0.5} fill=\"#198AD3\" />\n          </g>\n        </svg>\n      </button>\n    );\n  }\n\n  private onTargetMove = (e: React.MouseEvent<HTMLElement>) => {\n    const point = this.props.paperArea.pageToPaperCoords(e.pageX, e.pageY);\n    this.props.onTargetMove(point);\n  };\n\n  private getButtonPosition(polyline: ReadonlyArray<Vector>, index: number): { top: number; left: number } {\n    const polylineLength = computePolylineLength(polyline);\n    const point = getPointAlongPolyline(polyline, polylineLength - (BUTTON_SIZE + BUTTON_MARGIN) * index);\n    const { x, y } = this.paperToScrollablePaneCoords(point);\n\n    return { top: y - BUTTON_SIZE / 2, left: x - BUTTON_SIZE / 2 };\n  }\n\n  private renderTargetButton(polyline: ReadonlyArray<Vector>) {\n    const { editor, target } = this.props;\n    const style = this.getButtonPosition(polyline, 0);\n\n    const { length } = polyline;\n    const degree = this.calculateDegree(polyline[length - 1], polyline[length - 2]);\n\n    return (\n      <button\n        className={`${CLASS_NAME}__button`}\n        style={style}\n        disabled={isDeletedLink(editor.authoringState, target)}\n        onMouseDown={this.onTargetMove}\n      >\n        <svg width={BUTTON_SIZE} height={BUTTON_SIZE} style={{ transform: `rotate(${degree}deg)` }}>\n          <g transform={`scale(${BUTTON_SIZE})`}>\n            <polygon points={'0,0.5 1,1 1,0'} fill=\"#198AD3\" />\n          </g>\n        </svg>\n      </button>\n    );\n  }\n\n  private renderEditButton(polyline: ReadonlyArray<Vector>) {\n    const { canEdit } = this.state;\n    const style = this.getButtonPosition(polyline, 1);\n    if (canEdit === undefined) {\n      return (\n        <div className={`${CLASS_NAME}__spinner`} style={style}>\n          <HtmlSpinner width={20} height={20} />\n        </div>\n      );\n    }\n    const title = canEdit ? 'Edit link' : 'Editing is unavailable for the selected link';\n    return (\n      <button\n        className={`${CLASS_NAME}__button ${CLASS_NAME}__edit`}\n        style={style}\n        title={title}\n        onClick={this.props.onEdit}\n        disabled={!canEdit}\n      />\n    );\n  }\n\n  private renderDeleteButton(polyline: ReadonlyArray<Vector>) {\n    const { canDelete } = this.state;\n    const style = this.getButtonPosition(polyline, 2);\n    if (canDelete === undefined) {\n      return (\n        <div className={`${CLASS_NAME}__spinner`} style={style}>\n          <HtmlSpinner width={20} height={20} />\n        </div>\n      );\n    }\n    const title = canDelete ? 'Delete link' : 'Deletion is unavailable for the selected link';\n    return (\n      <button\n        className={`${CLASS_NAME}__button ${CLASS_NAME}__delete`}\n        style={style}\n        title={title}\n        onClick={this.props.onDelete}\n        disabled={!canDelete}\n      />\n    );\n  }\n\n  // Link editing implementation could be rethought in the future.\n  private renderEditLabelButton() {\n    const { view, target, paperArea, onEditLabel } = this.props;\n\n    const linkType = view.model.getLinkType(target.typeId);\n    const template = view.createLinkTemplate(linkType);\n\n    if (!template.setLinkLabel || !target.labelBounds) {\n      return null;\n    }\n\n    const { x, y, width, height } = target.labelBounds;\n    const { x: left, y: top } = paperArea.paperToScrollablePaneCoords(x + width, y + height / 2);\n    const size = { width: 15, height: 17 };\n    const style = { width: size.width, height: size.height, top: top - size.height / 2, left };\n    return (\n      <button\n        className={`${CLASS_NAME}__edit-label-button`}\n        style={style}\n        onClick={() => onEditLabel()}\n        title={'Edit Link Label'}\n      />\n    );\n  }\n\n  render() {\n    const { editor, target, metadataApi } = this.props;\n    const polyline = this.computePolyline();\n    if (!polyline) {\n      return null;\n    }\n\n    const isAuthoringMode = Boolean(metadataApi);\n    const deleteButton =\n      isDeletedByItself(editor.authoringState, target) || isSourceOrTargetDeleted(editor.authoringState, target)\n        ? null\n        : this.renderDeleteButton(polyline);\n\n    return (\n      <div className={`${CLASS_NAME}`}>\n        {isAuthoringMode ? this.renderTargetButton(polyline) : null}\n        {isAuthoringMode ? this.renderSourceButton(polyline) : null}\n        {!isAuthoringMode || isDeletedLink(editor.authoringState, target) ? null : this.renderEditButton(polyline)}\n        {isAuthoringMode ? deleteButton : null}\n        {this.renderEditLabelButton()}\n      </div>\n    );\n  }\n}\n\nfunction isDeletedLink(state: AuthoringState, link: Link) {\n  return isDeletedByItself(state, link) || isSourceOrTargetDeleted(state, link);\n}\n\nfunction isDeletedByItself(state: AuthoringState, link: Link) {\n  const event = state.links.get(link.data);\n  return event && event.deleted;\n}\n\nfunction isSourceOrTargetDeleted(state: AuthoringState, link: Link) {\n  const sourceEvent = state.elements.get(link.data.sourceId);\n  const targetEvent = state.elements.get(link.data.targetId);\n  return (sourceEvent && sourceEvent.deleted) || (targetEvent && targetEvent.deleted);\n}\n","import * as React from 'react';\n\nimport { LinkModel } from '../data/model';\n\nimport { Vector, computePolyline, getPointAlongPolyline, computePolylineLength } from '../diagram/geometry';\nimport { TransformedSvgCanvas } from '../diagram/paper';\nimport { PaperWidgetProps } from '../diagram/paperArea';\nimport { DiagramView, RenderingLayer } from '../diagram/view';\nimport { Link } from '../diagram/elements';\n\nimport { Debouncer } from '../viewUtils/async';\nimport { EventObserver } from '../viewUtils/events';\nimport { HtmlSpinner } from '../viewUtils/spinner';\n\nimport { EditorController } from './editorController';\n\nimport { AuthoringKind, AuthoringState } from './authoringState';\nimport { LinkValidation, ElementValidation } from './validation';\n\nexport interface Props extends PaperWidgetProps {\n  view: DiagramView;\n  editor: EditorController;\n}\n\nconst CLASS_NAME = `ontodia-authoring-state`;\nconst LINK_LABEL_MARGIN = 5;\n\nexport class LinkStateWidget extends React.Component<Props, {}> {\n  private readonly listener = new EventObserver();\n  private readonly delayedUpdate = new Debouncer();\n\n  componentDidMount() {\n    this.listenEvents();\n  }\n\n  componentDidUpdate(prevProps: Props) {\n    const sameEventSources = this.props.view === prevProps.view;\n    if (!sameEventSources) {\n      this.listener.stopListening();\n      this.listenEvents();\n    }\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n  }\n\n  private listenEvents() {\n    const { editor, view } = this.props;\n    this.listener.listen(editor.model.events, 'elementEvent', ({ data }) => {\n      if (data.changeSize || data.changePosition) {\n        this.scheduleUpdate();\n      }\n    });\n    this.listener.listen(editor.model.events, 'linkEvent', ({ data }) => {\n      if (data.changeVertices || data.changeLabelBounds) {\n        this.scheduleUpdate();\n      }\n    });\n    this.listener.listen(editor.model.events, 'changeCells', this.scheduleUpdate);\n    this.listener.listen(editor.events, 'changeAuthoringState', this.scheduleUpdate);\n    this.listener.listen(editor.events, 'changeTemporaryState', this.scheduleUpdate);\n    this.listener.listen(editor.events, 'changeValidationState', this.scheduleUpdate);\n    this.listener.listen(view.events, 'syncUpdate', ({ layer }) => {\n      if (layer === RenderingLayer.Editor) {\n        this.delayedUpdate.runSynchronously();\n      }\n    });\n  }\n\n  private scheduleUpdate = () => {\n    this.delayedUpdate.call(this.performUpdate);\n  };\n\n  private performUpdate = () => {\n    this.forceUpdate();\n  };\n\n  private calculateLinkPath(link: Link) {\n    const polyline = this.calculatePolyline(link);\n    return 'M' + polyline.map(({ x, y }) => `${x},${y}`).join(' L');\n  }\n\n  private calculatePolyline(link: Link) {\n    const { editor, view } = this.props;\n\n    const source = editor.model.getElement(link.sourceId);\n    const target = editor.model.getElement(link.targetId);\n\n    const route = view.getRouting(link.id);\n    const verticesDefinedByUser = link.vertices || [];\n    const vertices = route ? route.vertices : verticesDefinedByUser;\n\n    return computePolyline(source, target, vertices);\n  }\n\n  private renderLinkStateLabels() {\n    const { editor } = this.props;\n\n    return editor.model.links.map((link) => {\n      let renderedState: JSX.Element | null = null;\n      const state = editor.authoringState.links.get(link.data);\n      if (state) {\n        const onCancel = () => editor.discardChange(state);\n\n        let statusText: string;\n        let title: string;\n\n        if (state.deleted) {\n          statusText = 'Delete';\n          title = 'Revert deletion of the link';\n        } else if (!state.before) {\n          statusText = 'New';\n          title = 'Revert creation of the link';\n        } else {\n          statusText = 'Change';\n          title = 'Revert all changes in properties of the link';\n        }\n\n        if (statusText && title) {\n          renderedState = (\n            <span>\n              <span className={`${CLASS_NAME}__state-label`}>{statusText}</span>[\n              <span className={`${CLASS_NAME}__state-cancel`} onClick={onCancel} title={title}>\n                cancel\n              </span>\n              ]\n            </span>\n          );\n        }\n      }\n\n      const renderedErrors = this.renderLinkErrors(link.data);\n      if (renderedState || renderedErrors) {\n        const labelPosition = this.getLinkStateLabelPosition(link);\n        if (!labelPosition) {\n          return null;\n        }\n        const style = { left: labelPosition.x, top: labelPosition.y };\n        return (\n          <div className={`${CLASS_NAME}__state-indicator`} key={link.id} style={style}>\n            <div className={`${CLASS_NAME}__state-indicator-container`}>\n              <div className={`${CLASS_NAME}__state-indicator-body`}>\n                {renderedState}\n                {renderedErrors}\n              </div>\n            </div>\n          </div>\n        );\n      } else {\n        return null;\n      }\n    });\n  }\n\n  private renderLinkStateHighlighting() {\n    const { editor } = this.props;\n    return editor.model.links.map((link) => {\n      if (editor.temporaryState.links.has(link.data)) {\n        const path = this.calculateLinkPath(link);\n        return (\n          <path\n            key={link.id}\n            d={path}\n            fill={'none'}\n            stroke={'grey'}\n            strokeWidth={5}\n            strokeOpacity={0.5}\n            strokeDasharray={'8 8'}\n          />\n        );\n      }\n      const event = editor.authoringState.links.get(link.data);\n      const isDeletedLink = AuthoringState.isDeletedLink(editor.authoringState, link.data);\n      const isUncertainLink = AuthoringState.isUncertainLink(editor.authoringState, link.data);\n      if (event || isDeletedLink || isUncertainLink) {\n        const path = this.calculateLinkPath(link);\n        let color: string;\n        if (isDeletedLink) {\n          color = 'red';\n        } else if (isUncertainLink) {\n          color = 'blue';\n        } else if (event && event.type === AuthoringKind.ChangeLink) {\n          color = event.before ? 'blue' : 'green';\n        }\n        return <path key={link.id} d={path} fill={'none'} stroke={color} strokeWidth={5} strokeOpacity={0.5} />;\n      }\n      return null;\n    });\n  }\n\n  private getLinkStateLabelPosition(link: Link): Vector {\n    if (link.labelBounds) {\n      const { x, y } = link.labelBounds;\n      return { x, y: y - LINK_LABEL_MARGIN / 2 };\n    } else {\n      const polyline = this.calculatePolyline(link);\n      const polylineLength = computePolylineLength(polyline);\n      return getPointAlongPolyline(polyline, polylineLength / 2);\n    }\n  }\n\n  private renderLinkErrors(linkModel: LinkModel) {\n    const { editor } = this.props;\n    const { validationState } = editor;\n\n    const validation = validationState.links.get(linkModel);\n    if (!validation) {\n      return null;\n    }\n    const title = validation.errors.map((error) => error.message).join('\\n');\n\n    return this.renderErrorIcon(title, validation);\n  }\n\n  private renderErrorIcon(title: string, validation: LinkValidation | ElementValidation): JSX.Element {\n    return (\n      <div className={`${CLASS_NAME}__item-error`} title={title}>\n        {validation.loading ? (\n          <HtmlSpinner width={15} height={17} />\n        ) : (\n          <div className={`${CLASS_NAME}__item-error-icon`} />\n        )}\n        {!validation.loading && validation.errors.length > 0 ? validation.errors.length : undefined}\n      </div>\n    );\n  }\n\n  render() {\n    const { editor, paperTransform } = this.props;\n    const { scale, originX, originY } = paperTransform;\n    if (!editor.inAuthoringMode) {\n      return null;\n    }\n    const htmlTransformStyle: React.CSSProperties = {\n      position: 'absolute',\n      left: 0,\n      top: 0,\n      transform: `scale(${scale},${scale})translate(${originX}px,${originY}px)`,\n    };\n    return (\n      <div className={`${CLASS_NAME}`}>\n        <TransformedSvgCanvas paperTransform={paperTransform} style={{ overflow: 'visible', pointerEvents: 'none' }}>\n          {this.renderLinkStateHighlighting()}\n        </TransformedSvgCanvas>\n        <div className={`${CLASS_NAME}__validation-layer`} style={htmlTransformStyle}>\n          {this.renderLinkStateLabels()}\n        </div>\n      </div>\n    );\n  }\n}\n","import * as React from 'react';\n\nimport { EventObserver } from '../viewUtils/events';\nimport { HtmlSpinner } from '../viewUtils/spinner';\n\nimport { Element } from '../diagram/elements';\nimport { DiagramView } from '../diagram/view';\nimport { Vector } from '../diagram/geometry';\n\nimport { EditorController } from './editorController';\nimport { ElementChange } from './authoringState';\nimport { ElementValidation, LinkValidation } from './validation';\n\nconst CLASS_NAME = `ontodia-authoring-state`;\n\nexport interface ElementDecoratorProps {\n  model: Element;\n  view: DiagramView;\n  editor: EditorController;\n  position: Vector;\n}\n\ninterface State {\n  state?: ElementChange;\n  validation?: ElementValidation;\n  isTemporary?: boolean;\n}\n\nexport class ElementDecorator extends React.Component<ElementDecoratorProps, State> {\n  private readonly listener = new EventObserver();\n\n  constructor(props: ElementDecoratorProps) {\n    super(props);\n    const { model, editor } = props;\n    this.state = {\n      state: editor.authoringState.elements.get(model.iri),\n      validation: editor.validationState.elements.get(model.iri),\n      isTemporary: editor.temporaryState.elements.has(model.iri),\n    };\n  }\n\n  componentDidMount() {\n    const { model, editor } = this.props;\n    this.listener.listen(model.events, 'changeSize', () => this.forceUpdate());\n    this.listener.listen(editor.events, 'changeAuthoringState', (e) => {\n      const state = editor.authoringState.elements.get(model.iri);\n      if (state === e.previous.elements.get(model.iri)) {\n        return;\n      }\n      this.setState({ state });\n    });\n    this.listener.listen(editor.events, 'changeValidationState', (e) => {\n      const validation = editor.validationState.elements.get(model.iri);\n      if (validation === e.previous.elements.get(model.iri)) {\n        return;\n      }\n      this.setState({ validation });\n    });\n    this.listener.listen(editor.events, 'changeTemporaryState', (e) => {\n      const isTemporary = editor.temporaryState.elements.has(model.iri);\n      if (isTemporary === e.previous.elements.has(model.iri)) {\n        return;\n      }\n      this.setState({ isTemporary });\n    });\n    this.listener.listen(model.events, 'changeData', (e) => {\n      if (e.previous.id !== model.iri) {\n        this.setState({\n          isTemporary: editor.temporaryState.elements.has(model.iri),\n          validation: editor.validationState.elements.get(model.iri),\n          state: editor.authoringState.elements.get(model.iri),\n        });\n      }\n    });\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n  }\n\n  shouldComponentUpdate(nextProps: ElementDecoratorProps, nextState: State) {\n    return (\n      this.state.state !== nextState.state ||\n      this.state.validation !== nextState.validation ||\n      this.state.isTemporary !== nextState.isTemporary ||\n      this.props.position !== nextProps.position\n    );\n  }\n\n  private renderElementOutlines() {\n    const { model } = this.props;\n    const { state, isTemporary } = this.state;\n    const { width, height } = model.size;\n    if (isTemporary) {\n      return [\n        <rect key={`${model.id}-opacity`} x={0} y={0} width={width} height={height} fill=\"rgba(255, 255, 255, 0.5)\" />,\n        <rect key={`${model.id}-stripes`} x={0} y={0} width={width} height={height} fill=\"url(#stripe-pattern)\" />,\n      ];\n    }\n    if (state && state.deleted) {\n      const right = width;\n      const bottom = height;\n      return (\n        <g key={model.id}>\n          <rect x={0} y={0} width={width} height={height} fill=\"white\" fillOpacity={0.5} />\n          <line x1={0} y1={0} x2={right} y2={bottom} stroke=\"red\" />\n          <line x1={right} y1={0} x2={0} y2={bottom} stroke=\"red\" />\n        </g>\n      );\n    }\n    return null;\n  }\n\n  private renderErrorIcon(title: string, validation: LinkValidation | ElementValidation) {\n    return (\n      <div className={`${CLASS_NAME}__item-error`} title={title}>\n        {validation.loading ? (\n          <HtmlSpinner width={15} height={17} />\n        ) : (\n          <div className={`${CLASS_NAME}__item-error-icon`} />\n        )}\n        {!validation.loading && validation.errors.length > 0 ? validation.errors.length : undefined}\n      </div>\n    );\n  }\n\n  private renderElementErrors() {\n    const { view } = this.props;\n    const { validation } = this.state;\n    if (!validation) {\n      return null;\n    }\n    const title = validation.errors\n      .map((error) => {\n        if (error.propertyType) {\n          const { id, label } = view.model.createProperty(error.propertyType);\n          const source = view.formatLabel(label, id);\n          return `${source}: ${error.message}`;\n        } else {\n          return error.message;\n        }\n      })\n      .join('\\n');\n\n    return this.renderErrorIcon(title, validation);\n  }\n\n  private renderElementState() {\n    const { model, editor } = this.props;\n    const { state } = this.state;\n    if (state) {\n      const onCancel = () => editor.discardChange(state);\n\n      let renderedState: React.ReactElement<any>;\n      let statusText: string;\n      let title: string;\n\n      if (state.deleted) {\n        statusText = 'Delete';\n        title = 'Revert deletion of the element';\n      } else if (!state.before) {\n        statusText = 'New';\n        title = 'Revert creation of the element';\n      } else {\n        statusText = 'Change';\n        title = 'Revert all changes in properties of the element';\n      }\n\n      if (statusText && title) {\n        renderedState = (\n          <span>\n            <span className={`${CLASS_NAME}__state-label`}>{statusText}</span>[\n            <span className={`${CLASS_NAME}__state-cancel`} onClick={onCancel} title={title}>\n              cancel\n            </span>\n            ]\n          </span>\n        );\n      }\n\n      const renderedErrors = this.renderElementErrors();\n      if (renderedState || renderedErrors) {\n        return (\n          <div className={`${CLASS_NAME}__state-indicator`} key={model.id} style={{ left: 0, top: 0 }}>\n            <div className={`${CLASS_NAME}__state-indicator-container`}>\n              <div className={`${CLASS_NAME}__state-indicator-body`}>\n                {renderedState}\n                {renderedErrors}\n              </div>\n            </div>\n          </div>\n        );\n      }\n    }\n    return null;\n  }\n\n  render() {\n    const { position, size } = this.props.model;\n    const transform = `translate(${position.x}px,${position.y}px)`;\n    const outlines = this.renderElementOutlines();\n    const state = this.renderElementState();\n    if (!outlines && !state) {\n      return null;\n    }\n    return (\n      <div style={{ position: 'absolute', transform }}>\n        {outlines ? (\n          <svg\n            width={size.width}\n            height={size.height}\n            style={{ position: 'absolute', pointerEvents: 'none', overflow: 'visible' }}\n          >\n            <defs>\n              <pattern\n                id=\"stripe-pattern\"\n                patternUnits=\"userSpaceOnUse\"\n                width={13}\n                height={13}\n                patternTransform=\"rotate(45)\"\n              >\n                <line x1={0} y={0} x2={0} y2={13} stroke=\"#ddd\" strokeWidth={10} strokeOpacity={0.2} />\n              </pattern>\n            </defs>\n            {this.renderElementOutlines()}\n          </svg>\n        ) : null}\n        {state}\n      </div>\n    );\n  }\n}\n","import * as React from 'react';\n\nimport { MetadataApi } from '../data/metadataApi';\nimport { ElementModel, LinkModel } from '../data/model';\nimport { PLACEHOLDER_ELEMENT_TYPE, PLACEHOLDER_LINK_TYPE } from '../data/schema';\n\nimport { DiagramView } from '../diagram/view';\nimport { LinkLayer, LinkMarkers } from '../diagram/linkLayer';\nimport { Element, Link, LinkDirection } from '../diagram/elements';\nimport { boundsOf, Vector, findElementAtPoint } from '../diagram/geometry';\nimport { TransformedSvgCanvas } from '../diagram/paper';\nimport { PaperWidgetProps } from '../diagram/paperArea';\n\nimport { Cancellation, CancellationToken } from '../viewUtils/async';\nimport { EventObserver } from '../viewUtils/events';\nimport { Spinner } from '../viewUtils/spinner';\n\nimport { TemporaryState } from './authoringState';\nimport { EditorController } from './editorController';\n\nexport enum EditLayerMode {\n  establishLink,\n  moveLinkSource,\n  moveLinkTarget,\n}\n\nexport interface Props extends PaperWidgetProps {\n  view: DiagramView;\n  editor: EditorController;\n  metadataApi: MetadataApi | undefined;\n  mode: EditLayerMode;\n  target: Element | Link;\n  point: { x: number; y: number };\n  onFinishEditing: () => void;\n}\n\nexport interface State {\n  targetElement?: Element;\n  canLinkFrom?: boolean;\n  canDropOnCanvas?: boolean;\n  canDropOnElement?: boolean;\n  waitingForMetadata?: boolean;\n}\n\nexport class EditLayer extends React.Component<Props, State> {\n  private readonly listener = new EventObserver();\n  private readonly cancellation = new Cancellation();\n\n  private canDropOnElementCancellation = new Cancellation();\n\n  private temporaryLink: Link | undefined;\n  private temporaryElement: Element | undefined;\n  private oldLink: Link | undefined;\n\n  constructor(props: Props) {\n    super(props);\n    this.state = {};\n  }\n\n  componentDidMount() {\n    const { mode, target, point } = this.props;\n    if (mode === EditLayerMode.establishLink) {\n      this.beginCreatingLink({ sourceId: target.id, point });\n    } else if (mode === EditLayerMode.moveLinkSource || mode === EditLayerMode.moveLinkTarget) {\n      this.beginMovingLink(target as Link, point);\n    } else {\n      throw new Error('Unknown edit mode');\n    }\n    this.forceUpdate();\n    this.queryCanLinkFrom();\n    this.queryCanDropOnCanvas();\n    document.addEventListener('mousemove', this.onMouseMove);\n    document.addEventListener('mouseup', this.onMouseUp);\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n    this.cancellation.abort();\n    this.canDropOnElementCancellation.abort();\n    document.removeEventListener('mousemove', this.onMouseMove);\n    document.removeEventListener('mouseup', this.onMouseUp);\n  }\n\n  private beginCreatingLink = (params: { sourceId: string; point: Vector }) => {\n    const { editor } = this.props;\n    const { sourceId, point } = params;\n\n    const temporaryElement = this.createTemporaryElement(point);\n    const linkTemplate = new Link({\n      typeId: PLACEHOLDER_LINK_TYPE,\n      sourceId,\n      targetId: temporaryElement.id,\n    });\n    const temporaryLink = editor.createNewLink({ link: linkTemplate, temporary: true });\n    const fatLinkType = editor.model.createLinkType(temporaryLink.typeId);\n    fatLinkType.setVisibility({ visible: true, showLabel: false });\n\n    this.temporaryElement = temporaryElement;\n    this.temporaryLink = temporaryLink;\n  };\n\n  private beginMovingLink(target: Link, startingPoint: Vector) {\n    const { editor, mode } = this.props;\n\n    if (!(mode === EditLayerMode.moveLinkSource || mode === EditLayerMode.moveLinkTarget)) {\n      throw new Error('Unexpected edit mode for moving link');\n    }\n\n    this.oldLink = target;\n    editor.model.removeLink(target.id);\n    const { id, typeId, sourceId, targetId, ...otherProps } = target;\n\n    const temporaryElement = this.createTemporaryElement(startingPoint);\n    const linkTemplate = new Link({\n      typeId,\n      sourceId: mode === EditLayerMode.moveLinkSource ? temporaryElement.id : sourceId,\n      targetId: mode === EditLayerMode.moveLinkTarget ? temporaryElement.id : targetId,\n      ...otherProps,\n    });\n    const temporaryLink = editor.createNewLink({ link: linkTemplate, temporary: true });\n\n    this.temporaryElement = temporaryElement;\n    this.temporaryLink = temporaryLink;\n  }\n\n  private createTemporaryElement(point: Vector) {\n    const temporaryElement = this.props.view.model.createTemporaryElement();\n    temporaryElement.setPosition(point);\n\n    return temporaryElement;\n  }\n\n  private onMouseMove = (e: MouseEvent) => {\n    const { view, paperArea } = this.props;\n    const { targetElement, waitingForMetadata } = this.state;\n\n    e.preventDefault();\n    e.stopPropagation();\n\n    if (waitingForMetadata) {\n      return;\n    }\n\n    const point = paperArea.pageToPaperCoords(e.pageX, e.pageY);\n    this.temporaryElement.setPosition(point);\n\n    const newTargetElement = findElementAtPoint(view.model.elements, point);\n\n    if (newTargetElement !== targetElement) {\n      this.queryCanDropOnElement(newTargetElement);\n    }\n    this.setState({ targetElement: newTargetElement });\n  };\n\n  private queryCanLinkFrom() {\n    const { editor, metadataApi } = this.props;\n\n    if (!metadataApi) {\n      this.setState({ canLinkFrom: false });\n      return;\n    }\n\n    this.setState({ canLinkFrom: undefined });\n\n    const source = editor.model.getElement(this.temporaryLink.sourceId);\n    CancellationToken.mapCancelledToNull(\n      this.cancellation.signal,\n      metadataApi.canLinkElement(source.data, this.cancellation.signal)\n    ).then(\n      (canLinkFrom) => {\n        if (canLinkFrom === null) {\n          return;\n        }\n        this.setState({ canLinkFrom });\n      },\n      (error) => {\n        // tslint:disable-next-line: no-console\n        console.error('Error calling canLinkElement:', error);\n        this.setState({ canLinkFrom: false });\n      }\n    );\n  }\n\n  private queryCanDropOnCanvas() {\n    const { mode, editor, metadataApi } = this.props;\n\n    if (!metadataApi || mode !== EditLayerMode.establishLink) {\n      this.setState({ canDropOnCanvas: false });\n      return;\n    }\n\n    this.setState({ canDropOnCanvas: undefined });\n\n    const source = editor.model.getElement(this.temporaryLink.sourceId);\n    CancellationToken.mapCancelledToNull(\n      this.cancellation.signal,\n      metadataApi.canDropOnCanvas(source.data, this.cancellation.signal)\n    ).then(\n      (canDropOnCanvas) => {\n        if (canDropOnCanvas === null) {\n          return;\n        }\n        this.setState({ canDropOnCanvas });\n      },\n      (error) => {\n        // tslint:disable-next-line: no-console\n        console.error('Error calling canDropOnCanvas:', error);\n        this.setState({ canDropOnCanvas: false });\n      }\n    );\n  }\n\n  private queryCanDropOnElement(targetElement: Element | undefined) {\n    const { mode, editor, metadataApi } = this.props;\n\n    this.canDropOnElementCancellation.abort();\n    this.canDropOnElementCancellation = new Cancellation();\n\n    if (!(metadataApi && targetElement)) {\n      this.setState({ canDropOnElement: false });\n      return;\n    }\n\n    this.setState({ canDropOnElement: undefined });\n\n    let source: ElementModel;\n    let target: ElementModel;\n\n    if (mode === EditLayerMode.establishLink || mode === EditLayerMode.moveLinkTarget) {\n      source = editor.model.getElement(this.temporaryLink.sourceId).data;\n      target = targetElement.data;\n    } else if (mode === EditLayerMode.moveLinkSource) {\n      source = targetElement.data;\n      target = editor.model.getElement(this.temporaryLink.targetId).data;\n    }\n\n    const signal = this.canDropOnElementCancellation.signal;\n    CancellationToken.mapCancelledToNull(signal, metadataApi.canDropOnElement(source, target, signal)).then(\n      (canDropOnElement) => {\n        if (canDropOnElement === null) {\n          return;\n        }\n        this.setState({ canDropOnElement });\n      }\n    );\n  }\n\n  private onMouseUp = (e: MouseEvent) => {\n    if (this.state.waitingForMetadata) {\n      return;\n    }\n    // show spinner while waiting for additinal MetadataApi queries\n    this.setState({ waitingForMetadata: true });\n    const selectedPosition = this.props.paperArea.pageToPaperCoords(e.pageX, e.pageY);\n    this.executeEditOperation(selectedPosition);\n  };\n\n  private async executeEditOperation(selectedPosition: Vector): Promise<void> {\n    const { view, editor, mode } = this.props;\n\n    try {\n      const { targetElement, canLinkFrom, canDropOnCanvas, canDropOnElement } = this.state;\n\n      if (this.oldLink) {\n        editor.model.addLink(this.oldLink);\n      }\n\n      const canDrop = targetElement ? canDropOnElement : canDropOnCanvas;\n      if (canLinkFrom && canDrop) {\n        let modifiedLink: Link | undefined;\n        let createdTarget: Element | undefined = targetElement;\n\n        switch (mode) {\n          case EditLayerMode.establishLink: {\n            if (!createdTarget) {\n              const source = editor.model.getElement(this.temporaryLink.sourceId);\n              createdTarget = await this.createNewElement(source.data);\n              createdTarget.setPosition(selectedPosition);\n              view.performSyncUpdate();\n              centerElementAtPoint(createdTarget, selectedPosition);\n            }\n            const sourceElement = editor.model.getElement(this.temporaryLink.sourceId);\n            modifiedLink = await this.createNewLink(sourceElement, createdTarget);\n            break;\n          }\n          case EditLayerMode.moveLinkSource: {\n            modifiedLink = editor.moveLinkSource({ link: this.oldLink, newSource: targetElement });\n            break;\n          }\n          case EditLayerMode.moveLinkTarget: {\n            modifiedLink = editor.moveLinkTarget({ link: this.oldLink, newTarget: targetElement });\n            break;\n          }\n          default: {\n            throw new Error('Unknown edit mode');\n          }\n        }\n\n        if (targetElement) {\n          const focusedLink = modifiedLink || this.oldLink;\n          editor.setSelection([focusedLink]);\n          editor.showEditLinkForm(focusedLink);\n        } else if (createdTarget && modifiedLink) {\n          editor.setSelection([createdTarget]);\n          const source = editor.model.getElement(modifiedLink.sourceId);\n          editor.showEditElementTypeForm({\n            link: modifiedLink,\n            source,\n            target: createdTarget,\n            targetIsNew: true,\n          });\n        }\n      }\n    } finally {\n      this.cleanupAndFinish();\n    }\n  }\n\n  private createNewElement = async (source: ElementModel): Promise<Element | undefined> => {\n    const { editor, metadataApi } = this.props;\n    if (!metadataApi) {\n      return;\n    }\n    const elementTypes = await CancellationToken.mapCancelledToNull(\n      this.cancellation.signal,\n      metadataApi.typesOfElementsDraggedFrom(source, this.cancellation.signal)\n    );\n    if (elementTypes === null) {\n      return;\n    }\n    const classId = elementTypes.length === 1 ? elementTypes[0] : PLACEHOLDER_ELEMENT_TYPE;\n    const elementModel = await CancellationToken.mapCancelledToNull(\n      this.cancellation.signal,\n      metadataApi.generateNewElement([classId], this.cancellation.signal)\n    );\n    if (elementModel === null) {\n      return;\n    }\n    return editor.createNewEntity({ elementModel, temporary: true });\n  };\n\n  private async createNewLink(source: Element, target: Element): Promise<Link | undefined> {\n    const { editor, metadataApi } = this.props;\n    if (!metadataApi) {\n      return undefined;\n    }\n    const linkTypes = await CancellationToken.mapCancelledToNull(\n      this.cancellation.signal,\n      metadataApi.possibleLinkTypes(source.data, target.data, this.cancellation.signal)\n    );\n    if (linkTypes === null) {\n      return undefined;\n    }\n    const placeholder = { linkTypeIri: PLACEHOLDER_LINK_TYPE, direction: LinkDirection.out };\n    const { linkTypeIri: typeId, direction } = linkTypes.length === 1 ? linkTypes[0] : placeholder;\n    const data: LinkModel = {\n      linkTypeId: typeId,\n      sourceId: source.iri,\n      targetId: target.iri,\n    };\n    let [sourceId, targetId] = [source.id, target.id];\n    // switches source and target if the direction equals 'in'\n    if (direction === LinkDirection.in) {\n      data.sourceId = target.iri;\n      data.targetId = source.iri;\n      [sourceId, targetId] = [targetId, sourceId];\n    }\n    const link = new Link({ typeId, sourceId, targetId, data });\n    const existingLink = editor.model.findLink(link.typeId, link.sourceId, link.targetId);\n    return existingLink || editor.createNewLink({ link, temporary: true });\n  }\n\n  private cleanupAndFinish() {\n    const { editor, onFinishEditing } = this.props;\n\n    const batch = editor.model.history.startBatch();\n    editor.model.removeElement(this.temporaryElement.id);\n    editor.model.removeLink(this.temporaryLink.id);\n    editor.setTemporaryState(TemporaryState.deleteLink(editor.temporaryState, this.temporaryLink.data));\n    batch.discard();\n\n    onFinishEditing();\n  }\n\n  render() {\n    const { view, paperTransform } = this.props;\n    const { waitingForMetadata } = this.state;\n\n    if (!this.temporaryLink) {\n      return null;\n    }\n\n    return (\n      <TransformedSvgCanvas paperTransform={paperTransform} style={{ overflow: 'visible' }}>\n        <LinkMarkers view={view} />\n        {this.renderHighlight()}\n        {this.renderCanDropIndicator()}\n        {waitingForMetadata ? null : <LinkLayer view={view} links={[this.temporaryLink]} />}\n      </TransformedSvgCanvas>\n    );\n  }\n\n  private renderHighlight() {\n    const { targetElement, canLinkFrom, canDropOnElement, waitingForMetadata } = this.state;\n\n    if (!targetElement) {\n      return null;\n    }\n\n    const { x, y, width, height } = boundsOf(targetElement);\n\n    if (canLinkFrom === undefined || canDropOnElement === undefined || waitingForMetadata) {\n      return (\n        <g transform={`translate(${x},${y})`}>\n          <rect width={width} height={height} fill={'white'} fillOpacity={0.5} />\n          <Spinner size={30} position={{ x: width / 2, y: height / 2 }} />\n        </g>\n      );\n    }\n\n    const stroke = canLinkFrom && canDropOnElement ? '#5cb85c' : '#c9302c';\n    return <rect x={x} y={y} width={width} height={height} fill={'transparent'} stroke={stroke} strokeWidth={3} />;\n  }\n\n  private renderCanDropIndicator() {\n    const { targetElement, canLinkFrom, canDropOnCanvas, waitingForMetadata } = this.state;\n\n    if (targetElement) {\n      return null;\n    }\n\n    const { x, y } = this.temporaryElement.position;\n\n    let indicator: React.ReactElement<any>;\n    if (canLinkFrom === undefined || canDropOnCanvas === undefined) {\n      indicator = <Spinner size={1.2} position={{ x: 0.5, y: -0.5 }} />;\n    } else if (canLinkFrom && canDropOnCanvas) {\n      indicator = <path d=\"M0.5,0 L0.5,-1 M0,-0.5 L1,-0.5\" strokeWidth={0.2} stroke=\"#5cb85c\" />;\n    } else {\n      indicator = (\n        <g>\n          <circle cx=\"0.5\" cy=\"-0.5\" r=\"0.5\" fill=\"none\" strokeWidth={0.2} stroke=\"#c9302c\" />\n          <path d=\"M0.5,0 L0.5,-1\" strokeWidth={0.2} stroke=\"#c9302c\" transform=\"rotate(-45 0.5 -0.5)\" />\n        </g>\n      );\n    }\n\n    return (\n      <g transform={`translate(${x} ${y})scale(40)`}>\n        <rect x={-0.5} y={-0.5} width={1} height={1} fill=\"rgba(0, 0, 0, 0.1)\" rx={0.25} ry={0.25} />\n        {waitingForMetadata ? (\n          <Spinner size={0.8} />\n        ) : (\n          <g transform={`translate(${0.5}, -${0.5})scale(${0.25})`}>{indicator}</g>\n        )}\n      </g>\n    );\n  }\n}\n\nfunction centerElementAtPoint(element: Element, point: Vector) {\n  element.setPosition({\n    x: point.x - element.size.width / 2,\n    y: point.y - element.size.height / 2,\n  });\n}\n","import { Component, createElement, ReactElement, cloneElement } from 'react';\nimport * as ReactDOM from 'react-dom';\nimport * as fileSaver from 'file-saver';\n\nimport { LinkRouter, LinkTemplateResolver, TemplateResolver, TypeStyleResolver } from '../customization/props';\n\nimport { MetadataApi } from '../data/metadataApi';\nimport { ValidationApi } from '../data/validationApi';\n\nimport { Rect } from '../diagram/geometry';\nimport { RestoreGeometry } from '../diagram/commands';\nimport { Command, CommandHistory, NonRememberingHistory } from '../diagram/history';\nimport { PaperArea, ZoomOptions, PointerEvent, PointerUpEvent } from '../diagram/paperArea';\nimport { DiagramView, IriClickHandler, LabelLanguageSelector, WidgetAttachment } from '../diagram/view';\n\nimport { AsyncModel, GroupBy } from '../editor/asyncModel';\nimport { AuthoringState } from '../editor/authoringState';\nimport { EditorController, PropertyEditor } from '../editor/editorController';\n\nimport { EventObserver } from '../viewUtils/events';\nimport { dataURLToBlob } from '../viewUtils/toSvg';\n\nimport { PropertySuggestionHandler } from '../widgets/connectionsMenu';\nimport { SearchCriteria } from '../widgets/instancesSearch';\nimport { Navigator } from '../widgets/navigator';\n\nimport { DefaultToolbar, ToolbarProps } from './toolbar';\nimport { WorkspaceMarkup, WorkspaceMarkupProps } from './workspaceMarkup';\nimport { WorkspaceEventHandler, WorkspaceEventKey } from './workspaceContext';\nimport { forceLayout, applyLayout } from '../viewUtils/layout';\n\nexport interface WorkspaceProps {\n  /** Saves diagram layout (position and state of elements and links). */\n  onSaveDiagram?: (workspace: Workspace) => void;\n  /** Persists authored changes in the editor. */\n  onPersistChanges?: (workspace: Workspace) => void;\n  onPointerDown?: (e: PointerEvent) => void;\n  onPointerMove?: (e: PointerEvent) => void;\n  onPointerUp?: (e: PointerUpEvent) => void;\n\n  /**\n   * Custom toolbar to replace the default one.\n   */\n  toolbar?: ReactElement<any>;\n  /** @default false */\n  hidePanels?: boolean;\n  /** @default false */\n  hideToolbar?: boolean;\n  /** @default false */\n  hideScrollBars?: boolean;\n  /** @default false */\n  hideHalo?: boolean;\n  /** @default true */\n  hideTutorial?: boolean;\n  /** @default false */\n  hideNavigator?: boolean;\n  /** @default false */\n  collapseNavigator?: boolean;\n  /** @default true */\n  leftPanelInitiallyOpen?: boolean;\n  /** @default false */\n  rightPanelInitiallyOpen?: boolean;\n\n  /**\n   * Set of languages to display diagram data.\n   */\n  languages?: ReadonlyArray<WorkspaceLanguage>;\n  /**\n   * Currently selected language.\n   */\n  language?: string;\n  /**\n   * Called when user selected another language from the UI.\n   *\n   * If this function is set, language selection will work in controlled mode;\n   * otherwise language selection will function in uncontrolled mode.\n   */\n  onLanguageChange?: (language: string) => void;\n\n  zoomOptions?: ZoomOptions;\n  onZoom?: (scaleX: number, scaleY: number) => void;\n\n  history?: CommandHistory;\n  viewOptions?: DiagramViewOptions;\n\n  /**\n   * If provided, switches editor into \"authoring mode\".\n   */\n  metadataApi?: MetadataApi;\n  validationApi?: ValidationApi;\n  propertyEditor?: PropertyEditor;\n  onWorkspaceEvent?: WorkspaceEventHandler;\n\n  /**\n   * Custom panel to search existing elements on the diagram.\n   */\n  _elementsSearchPanel?: ReactElement<any>;\n\n  typeStyleResolver?: TypeStyleResolver;\n  linkTemplateResolver?: LinkTemplateResolver;\n  elementTemplateResolver?: TemplateResolver;\n  /**\n   * Overrides label selection based on target language.\n   */\n  selectLabelLanguage?: LabelLanguageSelector;\n}\n\nexport interface DiagramViewOptions {\n  linkRouter?: LinkRouter;\n  onIriClick?: IriClickHandler;\n  groupBy?: GroupBy[];\n  disableDefaultHalo?: boolean;\n  suggestProperties?: PropertySuggestionHandler;\n}\n\nexport interface WorkspaceLanguage {\n  code: string;\n  label: string;\n}\n\nexport interface WorkspaceState {\n  readonly criteria?: SearchCriteria;\n}\n\nexport class Workspace extends Component<WorkspaceProps, WorkspaceState> {\n  static readonly defaultProps: Partial<WorkspaceProps> = {\n    hideTutorial: true,\n    collapseNavigator: false,\n    leftPanelInitiallyOpen: true,\n    rightPanelInitiallyOpen: false,\n    languages: [\n      { code: 'en', label: 'English' },\n      { code: 'ru', label: 'Russian' },\n    ],\n    language: 'en',\n  };\n\n  private readonly listener = new EventObserver();\n\n  private readonly model: AsyncModel;\n  private readonly view: DiagramView;\n  private readonly editor: EditorController;\n\n  private markup: WorkspaceMarkup;\n\n  constructor(props: WorkspaceProps) {\n    super(props);\n\n    const {\n      hideHalo,\n      history,\n      viewOptions = {},\n      metadataApi,\n      validationApi,\n      propertyEditor,\n      elementTemplateResolver,\n      linkTemplateResolver,\n      typeStyleResolver,\n      selectLabelLanguage,\n    } = this.props;\n    const { linkRouter, onIriClick, disableDefaultHalo, suggestProperties, groupBy } = viewOptions;\n\n    this.model = new AsyncModel(history || new NonRememberingHistory(), groupBy || []);\n    this.view = new DiagramView(this.model, {\n      elementTemplateResolver,\n      linkTemplateResolver,\n      typeStyleResolver,\n      selectLabelLanguage,\n      linkRouter,\n      onIriClick,\n    });\n    this.editor = new EditorController({\n      model: this.model,\n      view: this.view,\n      disableHalo: hideHalo || disableDefaultHalo,\n      suggestProperties,\n      validationApi,\n      propertyEditor,\n    });\n    this.editor.setMetadataApi(metadataApi);\n\n    this.view.setLanguage(this.props.language);\n    this.state = {};\n  }\n\n  _getPaperArea(): PaperArea | undefined {\n    return this.markup ? this.markup.paperArea : undefined;\n  }\n\n  render(): ReactElement<any> {\n    const { hidePanels, hideToolbar, metadataApi, hideScrollBars, onWorkspaceEvent, _elementsSearchPanel } = this.props;\n    return createElement(WorkspaceMarkup, {\n      ref: (markup) => {\n        this.markup = markup;\n      },\n      hidePanels,\n      hideToolbar,\n      hideScrollBars,\n      model: this.model,\n      view: this.view,\n      editor: this.editor,\n      metadataApi,\n      leftPanelInitiallyOpen: this.props.leftPanelInitiallyOpen,\n      rightPanelInitiallyOpen: this.props.rightPanelInitiallyOpen,\n      searchCriteria: this.state.criteria,\n      onSearchCriteriaChanged: (criteria) => this.setState({ criteria }),\n      zoomOptions: this.props.zoomOptions,\n      onZoom: this.props.onZoom,\n      isLeftPanelOpen: this.props.leftPanelInitiallyOpen,\n      isRightPanelOpen: this.props.rightPanelInitiallyOpen,\n      toolbar: createElement(ToolbarWrapper, { workspace: this }),\n      onWorkspaceEvent,\n      elementsSearchPanel: _elementsSearchPanel,\n    } as WorkspaceMarkupProps & React.ClassAttributes<WorkspaceMarkup>);\n  }\n\n  componentDidMount() {\n    const { onWorkspaceEvent } = this.props;\n\n    this.editor._initializePaperComponents(this.markup.paperArea);\n    this.updateNavigator(!this.props.hideNavigator);\n\n    this.listener.listen(this.model.events, 'loadingSuccess', () => {\n      this.view.performSyncUpdate();\n      this.markup.paperArea.centerContent();\n    });\n\n    this.listener.listen(this.model.events, 'elementEvent', ({ key, data }) => {\n      if (!data.requestedAddToFilter) {\n        return;\n      }\n      const { source, linkType, direction } = data.requestedAddToFilter;\n      this.setState({\n        criteria: {\n          refElement: source,\n          refElementLink: linkType,\n          linkDirection: direction,\n        },\n      });\n      if (onWorkspaceEvent) {\n        onWorkspaceEvent(WorkspaceEventKey.searchUpdateCriteria);\n      }\n    });\n\n    this.listener.listen(this.markup.paperArea.events, 'pointerUp', (e) => {\n      if (this.props.onPointerUp) {\n        this.props.onPointerUp(e);\n      }\n    });\n    this.listener.listen(this.markup.paperArea.events, 'pointerMove', (e) => {\n      if (this.props.onPointerMove) {\n        this.props.onPointerMove(e);\n      }\n    });\n    this.listener.listen(this.markup.paperArea.events, 'pointerDown', (e) => {\n      if (this.props.onPointerDown) {\n        this.props.onPointerDown(e);\n      }\n    });\n\n    if (onWorkspaceEvent) {\n      this.listener.listen(this.editor.events, 'changeSelection', () =>\n        onWorkspaceEvent(WorkspaceEventKey.editorChangeSelection)\n      );\n      this.listener.listen(this.editor.events, 'toggleDialog', () =>\n        onWorkspaceEvent(WorkspaceEventKey.editorToggleDialog)\n      );\n      this.listener.listen(this.editor.events, 'addElements', () =>\n        onWorkspaceEvent(WorkspaceEventKey.editorAddElements)\n      );\n    }\n  }\n\n  componentWillReceiveProps(nextProps: WorkspaceProps) {\n    const controlledLanguage = Boolean(nextProps.onLanguageChange);\n    if (controlledLanguage && nextProps.language !== this.view.getLanguage()) {\n      this.view.setLanguage(nextProps.language);\n    }\n\n    if (nextProps.metadataApi !== this.editor.metadataApi) {\n      this.editor.setMetadataApi(nextProps.metadataApi);\n    }\n\n    if (nextProps.hideNavigator !== this.props.hideNavigator) {\n      this.updateNavigator(!nextProps.hideNavigator);\n    }\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n    this.view.dispose();\n  }\n\n  private updateNavigator(showNavigator: boolean) {\n    if (showNavigator) {\n      const widget = createElement(Navigator, { view: this.view, expanded: !this.props.collapseNavigator });\n      this.view.setPaperWidget({ key: 'navigator', widget, attachment: WidgetAttachment.Viewport });\n    } else {\n      this.view.setPaperWidget({ key: 'navigator', widget: undefined, attachment: WidgetAttachment.Viewport });\n    }\n  }\n\n  getModel() {\n    return this.model;\n  }\n  getDiagram() {\n    return this.view;\n  }\n  getEditor() {\n    return this.editor;\n  }\n\n  preventTextSelectionUntilMouseUp() {\n    this.markup.preventTextSelection();\n  }\n\n  zoomToFit = () => {\n    this.markup.paperArea.zoomToFit();\n  };\n\n  zoomToFitRect = (bbox: Rect) => {\n    this.markup.paperArea.zoomToFitRect(bbox);\n  };\n\n  clearAll = () => {\n    this.editor.removeItems([...this.model.elements]);\n  };\n\n  showWaitIndicatorWhile(operation: Promise<any>) {\n    this.editor.setSpinner({});\n    if (operation) {\n      operation\n        .then(() => {\n          this.editor.setSpinner(undefined);\n        })\n        .catch((error) => {\n          // tslint:disable-next-line:no-console\n          console.error(error);\n          this.editor.setSpinner({ statusText: 'Unknown error occured', errorOccured: true });\n        });\n    }\n  }\n\n  forceLayout = () => {\n    const batch = this.model.history.startBatch('Force layout');\n    batch.history.registerToUndo(RestoreGeometry.capture(this.model));\n\n    applyLayout(this.model, forceLayout({ model: this.model }));\n\n    for (const link of this.model.links) {\n      link.setVertices([]);\n    }\n\n    batch.store();\n  };\n\n  exportSvg = (fileName?: string) => {\n    this.markup.paperArea.exportSVG().then((svg) => {\n      fileName = fileName || 'diagram.svg';\n      const xmlEncodingHeader = '<?xml version=\"1.0\" encoding=\"UTF-8\"?>';\n      const blob = new Blob([xmlEncodingHeader + svg], { type: 'image/svg+xml' });\n      fileSaver.saveAs(blob, fileName);\n    });\n  };\n\n  exportPng = (fileName?: string) => {\n    fileName = fileName || 'diagram.png';\n    this.markup.paperArea.exportPNG({ backgroundColor: 'white' }).then((dataUri) => {\n      const blob = dataURLToBlob(dataUri);\n      fileSaver.saveAs(blob, fileName);\n    });\n  };\n\n  undo = () => {\n    this.model.history.undo();\n  };\n\n  redo = () => {\n    this.model.history.redo();\n  };\n\n  zoomBy = (value: number) => {\n    this.markup.paperArea.zoomBy(value);\n  };\n\n  zoomIn = () => {\n    this.markup.paperArea.zoomIn();\n  };\n\n  zoomOut = () => {\n    this.markup.paperArea.zoomOut();\n  };\n\n  print = () => {\n    this.markup.paperArea.exportSVG().then((svg) => {\n      const printWindow = window.open('', undefined, 'width=1280,height=720');\n      printWindow.document.write(svg);\n      printWindow.document.close();\n      printWindow.print();\n    });\n  };\n\n  changeLanguage = (language: string) => {\n    const { onLanguageChange } = this.props;\n    // if language is in controlled mode we'll just forward the change\n    if (onLanguageChange) {\n      onLanguageChange(language);\n    } else {\n      this.view.setLanguage(language);\n      // since we have toolbar dependent on language, we're forcing update here\n      this.forceUpdate();\n    }\n  };\n\n  centerTo = (paperPosition?: { x: number; y: number }) => {\n    this.markup.paperArea.centerTo(paperPosition);\n  };\n}\n\ninterface ToolbarWrapperProps {\n  workspace: Workspace;\n}\n\nclass ToolbarWrapper extends Component<ToolbarWrapperProps, {}> {\n  private readonly listener = new EventObserver();\n\n  render() {\n    const { workspace } = this.props;\n    const view = workspace.getDiagram();\n    const editor = workspace.getEditor();\n    const { languages, onSaveDiagram, onPersistChanges, hidePanels, toolbar } = workspace.props;\n\n    const hasUnpersistedChanges = !AuthoringState.isEmpty(editor.authoringState);\n    let canPersistChanges = onPersistChanges ? hasUnpersistedChanges : undefined;\n    let canSaveDiagram = !canPersistChanges;\n\n    if (onPersistChanges && workspace.props.validationApi.shouldEnforceConstraints()) {\n      canSaveDiagram = !hasUnpersistedChanges;\n      canPersistChanges = canPersistChanges && editor.validationState.isValid;\n    }\n\n    const defaultToolbarProps: ToolbarProps = {\n      onZoomIn: workspace.zoomIn,\n      onZoomOut: workspace.zoomOut,\n      onZoomToFit: workspace.zoomToFit,\n      onPrint: workspace.print,\n      onExportSVG: workspace.exportSvg,\n      onExportPNG: workspace.exportPng,\n      canSaveDiagram,\n      onSaveDiagram: onSaveDiagram ? () => onSaveDiagram(workspace) : undefined,\n      canPersistChanges,\n      hasUnpersistedChanges,\n      onPersistChanges: onPersistChanges ? () => onPersistChanges(workspace) : undefined,\n      onForceLayout: () => {\n        workspace.forceLayout();\n        workspace.getDiagram().performSyncUpdate();\n        workspace.zoomToFit();\n      },\n      onClearAll: workspace.clearAll,\n      languages,\n      selectedLanguage: view.getLanguage(),\n      onChangeLanguage: workspace.changeLanguage,\n      hidePanels,\n    };\n    if (toolbar) {\n      const toolbarProps: ToolbarProps = {\n        ...defaultToolbarProps,\n        ...toolbar.props,\n      };\n      return cloneElement(toolbar, toolbarProps);\n    } else {\n      return createElement(DefaultToolbar, defaultToolbarProps);\n    }\n  }\n\n  componentDidMount() {\n    const { workspace } = this.props;\n    const editor = workspace.getEditor();\n    this.listener.listen(editor.events, 'changeAuthoringState', () => {\n      this.forceUpdate();\n    });\n\n    this.listener.listen(editor.events, 'changeValidationState', () => {\n      this.forceUpdate();\n    });\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n  }\n}\n\nexport function renderTo<WorkspaceComponentProps>(\n  workspace: React.ComponentClass<WorkspaceComponentProps>,\n  container: HTMLElement,\n  props: WorkspaceComponentProps\n) {\n  ReactDOM.render(createElement(workspace, props), container);\n}\n","import * as React from 'react';\nimport { hcl } from 'd3-color';\n\nimport { Element } from '../diagram/elements';\nimport { DiagramView } from '../diagram/view';\nimport { PaperWidgetProps } from '../diagram/paperArea';\n\nimport { Debouncer } from '../viewUtils/async';\nimport { EventObserver } from '../viewUtils/events';\nimport { PaperTransform, totalPaneSize, paneTopLeft, paneFromPaperCoords, paperFromPaneCoords } from '../diagram/paper';\nimport { Vector } from '../diagram/geometry';\n\nexport interface NavigatorProps extends PaperWidgetProps {\n  view: DiagramView;\n  width?: number;\n  height?: number;\n  scalePadding?: number;\n  expanded?: boolean;\n}\n\ninterface NavigatorTransform {\n  scale: number;\n  canvasOffset: Vector;\n  paneOffset: Vector;\n}\n\nconst CLASS_NAME = 'ontodia-navigator';\nconst MIN_SCALE = 0.25;\n\ninterface State {\n  expanded?: boolean;\n}\n\nexport class Navigator extends React.Component<NavigatorProps, State> {\n  static defaultProps: Partial<NavigatorProps> = {\n    width: 300,\n    height: 160,\n    scalePadding: 0.2,\n    expanded: true,\n  };\n\n  private readonly delayedRedraw = new Debouncer();\n  private readonly listener = new EventObserver();\n  private canvas: HTMLCanvasElement;\n\n  private transform: NavigatorTransform;\n  private isDraggingViewport: boolean;\n\n  constructor(props: NavigatorProps, context: any) {\n    super(props, context);\n    this.state = { expanded: this.props.expanded };\n  }\n\n  componentDidMount() {\n    const { view, paperArea } = this.props;\n    this.listener.listen(view.events, 'changeHighlight', this.scheduleRedraw);\n    this.listener.listen(view.model.events, 'changeCells', this.scheduleRedraw);\n    this.listener.listen(view.model.events, 'elementEvent', this.scheduleRedraw);\n    this.listener.listen(paperArea.events, 'pointerMove', this.scheduleRedraw);\n    this.listener.listen(paperArea.events, 'scroll', this.scheduleRedraw);\n  }\n\n  shouldComponentUpdate(nextProps: NavigatorProps, nextState: State) {\n    return nextState !== this.state;\n  }\n\n  componentWillUnmount() {\n    this.delayedRedraw.dispose();\n    this.listener.stopListening();\n    this.stopDraggingViewport();\n  }\n\n  private scheduleRedraw = () => {\n    if (this.state.expanded) {\n      this.delayedRedraw.call(this.draw);\n    }\n  };\n\n  private draw = () => {\n    const { paperTransform: pt, width, height } = this.props;\n\n    this.calculateTransform();\n\n    const ctx = this.canvas.getContext('2d');\n    ctx.fillStyle = '#EEEEEE';\n    ctx.clearRect(0, 0, width, height);\n    ctx.fillRect(0, 0, width, height);\n\n    const paneStart = paneTopLeft(pt);\n    const paneSize = totalPaneSize(pt);\n    const paneEnd = {\n      x: paneStart.x + paneSize.x,\n      y: paneStart.y + paneSize.y,\n    };\n\n    const start = canvasFromPaneCoords(paneStart, pt, this.transform);\n    const end = canvasFromPaneCoords(paneEnd, pt, this.transform);\n    ctx.fillStyle = 'white';\n    ctx.fillRect(start.x, start.y, end.x - start.x, end.y - start.y);\n\n    ctx.save();\n\n    this.drawElements(ctx);\n    this.drawViewport(ctx);\n\n    ctx.restore();\n  };\n\n  private drawElements(ctx: CanvasRenderingContext2D) {\n    const { view, paperTransform: pt } = this.props;\n    view.model.elements.forEach((element) => {\n      const { position, size } = element;\n      ctx.fillStyle = this.chooseElementColor(element);\n\n      const { x: x1, y: y1 } = canvasFromPaperCoords(position, pt, this.transform);\n      const { x: x2, y: y2 } = canvasFromPaperCoords(\n        {\n          x: position.x + size.width,\n          y: position.y + size.height,\n        },\n        pt,\n        this.transform\n      );\n\n      ctx.fillRect(x1, y1, x2 - x1, y2 - y1);\n    });\n  }\n\n  private chooseElementColor(element: Element): string {\n    const { view } = this.props;\n    const isBlurred = view.highlighter && !view.highlighter(element);\n    if (isBlurred) {\n      return 'lightgray';\n    }\n    const {\n      color: { h, c, l },\n    } = view.getTypeStyle(element.data.types);\n    return hcl(h, c, l).toString();\n  }\n\n  private drawViewport(ctx: CanvasRenderingContext2D) {\n    const { paperArea, paperTransform: pt, width, height } = this.props;\n\n    ctx.strokeStyle = '#337ab7';\n    ctx.lineWidth = 2;\n\n    const { clientWidth, clientHeight } = paperArea.getAreaMetrics();\n    const viewportStart = paperArea.clientToScrollablePaneCoords(0, 0);\n    const viewportEnd = paperArea.clientToScrollablePaneCoords(clientWidth, clientHeight);\n\n    const { x: x1, y: y1 } = canvasFromPaneCoords(viewportStart, pt, this.transform);\n    const { x: x2, y: y2 } = canvasFromPaneCoords(viewportEnd, pt, this.transform);\n\n    // draw visible viewport rectangle\n    ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);\n\n    // draw \"out of area\" viewport borders\n    ctx.beginPath();\n    if (x1 < 0) {\n      ctx.moveTo(0, y1);\n      ctx.lineTo(0, y2);\n    }\n    if (y1 < 0) {\n      ctx.moveTo(x1, 0);\n      ctx.lineTo(x2, 0);\n    }\n    if (x2 > width) {\n      ctx.moveTo(width, y1);\n      ctx.lineTo(width, y2);\n    }\n    if (y2 > height) {\n      ctx.moveTo(x1, height);\n      ctx.lineTo(x2, height);\n    }\n\n    ctx.lineWidth = 4;\n    ctx.strokeStyle = '#a0d2ff';\n    ctx.setLineDash([5, 5]);\n    ctx.stroke();\n  }\n\n  private calculateTransform() {\n    const { paperArea, paperTransform: pt, width, height, scalePadding } = this.props;\n\n    const box = paperArea.getContentFittingBox();\n    const displayPadding: Vector = {\n      x: Math.max(box.width, width / MIN_SCALE) * scalePadding,\n      y: Math.max(box.height, height / MIN_SCALE) * scalePadding,\n    };\n    const displayStart = paneFromPaperCoords(\n      {\n        x: box.x - displayPadding.x,\n        y: box.y - displayPadding.y,\n      },\n      pt\n    );\n    const displayEnd = paneFromPaperCoords(\n      {\n        x: box.x + box.width + displayPadding.x,\n        y: box.y + box.height + displayPadding.y,\n      },\n      pt\n    );\n    const displaySize: Vector = {\n      x: displayEnd.x - displayStart.x,\n      y: displayEnd.y - displayStart.y,\n    };\n\n    const scale = Math.min(width / displaySize.x, height / displaySize.y);\n    const canvasOffset: Vector = {\n      x: (width - displaySize.x * scale) / 2,\n      y: (height - displaySize.y * scale) / 2,\n    };\n    this.transform = { scale, canvasOffset, paneOffset: displayStart };\n  }\n\n  private canvasFromPageCoords(pageX: number, pageY: number): Vector {\n    const { top, left } = this.canvas.getBoundingClientRect();\n    return {\n      x: pageX - left - window.pageXOffset,\n      y: pageY - top - window.pageYOffset,\n    };\n  }\n\n  render() {\n    const { width, height } = this.props;\n    const { expanded } = this.state;\n    return (\n      <div\n        className={`${CLASS_NAME} ${CLASS_NAME}--${expanded ? 'expanded' : 'collapsed'}`}\n        style={expanded ? { width, height } : undefined}\n      >\n        <canvas\n          ref={(canvas) => (this.canvas = canvas)}\n          width={width}\n          height={height}\n          onMouseDown={(e) => {\n            this.startDragginViewport();\n            this.onDragViewport(e);\n          }}\n          onWheel={this.onWheel}\n        />\n        <button\n          className={`${CLASS_NAME}__toggle`}\n          title={expanded ? 'Collapse navigator' : 'Expand navigator'}\n          onClick={this.onToggleClick}\n        >\n          <div className={`${CLASS_NAME}__toggle-icon`} />\n        </button>\n      </div>\n    );\n  }\n\n  private startDragginViewport() {\n    if (!this.isDraggingViewport) {\n      this.isDraggingViewport = true;\n      document.addEventListener('mousemove', this.onDragViewport);\n      document.addEventListener('mouseup', this.onMouseUp);\n    }\n  }\n\n  private stopDraggingViewport() {\n    if (this.isDraggingViewport) {\n      this.isDraggingViewport = false;\n      document.removeEventListener('mousemove', this.onDragViewport);\n      document.removeEventListener('mouseup', this.onMouseUp);\n    }\n  }\n\n  private onDragViewport = (e: MouseEvent | React.MouseEvent<{}>) => {\n    e.preventDefault();\n    if (this.isDraggingViewport) {\n      const canvas = this.canvasFromPageCoords(e.pageX, e.pageY);\n      const paper = paperFromCanvasCoords(canvas, this.props.paperTransform, this.transform);\n      this.props.paperArea.centerTo(paper);\n    }\n  };\n\n  private onMouseUp = () => {\n    this.stopDraggingViewport();\n  };\n\n  private onWheel = (e: React.WheelEvent<{}>) => {\n    e.preventDefault();\n    const delta = Math.max(-1, Math.min(1, e.deltaY || e.deltaX));\n    this.props.paperArea.zoomBy(-delta * 0.1);\n  };\n\n  private onToggleClick = () => {\n    this.setState((state): State => ({ expanded: !state.expanded }), this.scheduleRedraw);\n  };\n}\n\nfunction canvasFromPaneCoords(pane: Vector, pt: PaperTransform, nt: NavigatorTransform): Vector {\n  return {\n    x: nt.canvasOffset.x + (pane.x - nt.paneOffset.x) * nt.scale,\n    y: nt.canvasOffset.y + (pane.y - nt.paneOffset.y) * nt.scale,\n  };\n}\n\nfunction canvasFromPaperCoords(paper: Vector, pt: PaperTransform, nt: NavigatorTransform): Vector {\n  const pane = paneFromPaperCoords(paper, pt);\n  return canvasFromPaneCoords(pane, pt, nt);\n}\n\nfunction paperFromCanvasCoords(canvas: Vector, pt: PaperTransform, nt: NavigatorTransform): Vector {\n  const pane = {\n    x: nt.paneOffset.x + (canvas.x - nt.canvasOffset.x) / nt.scale,\n    y: nt.paneOffset.y + (canvas.y - nt.canvasOffset.y) / nt.scale,\n  };\n  return paperFromPaneCoords(pane, pt);\n}\n","import * as React from 'react';\n\nimport { ElementIri, ElementTypeIri } from '../data/model';\n\nimport { Element } from '../diagram/elements';\nimport { Vector } from '../diagram/geometry';\nimport { DiagramView, DropOnPaperEvent, WidgetAttachment } from '../diagram/view';\nimport { PaperArea, ZoomOptions } from '../diagram/paperArea';\n\nimport { ClassTree } from '../widgets/classTree';\nimport { InstancesSearch, SearchCriteria } from '../widgets/instancesSearch';\nimport { LinkTypesToolbox } from '../widgets/linksToolbox';\n\nimport { AsyncModel } from '../editor/asyncModel';\nimport { EditorController } from '../editor/editorController';\n\nimport {\n  WorkspaceContextWrapper,\n  WorkspaceContext,\n  WorkspaceContextTypes,\n  WorkspaceEventHandler,\n  WorkspaceEventKey,\n} from './workspaceContext';\n\nimport { MetadataApi } from '../data/metadataApi';\nimport { Cancellation, CancellationToken } from '../viewUtils/async';\n\nimport { WorkspaceLayout, WorkspaceLayoutType, WorkspaceLayoutNode } from './layout/layout';\n\nexport interface WorkspaceMarkupProps {\n  toolbar: React.ReactElement<any>;\n  model: AsyncModel;\n  view: DiagramView;\n  editor: EditorController;\n  metadataApi?: MetadataApi;\n  hidePanels?: boolean;\n  hideToolbar?: boolean;\n  hideScrollBars?: boolean;\n  searchCriteria?: SearchCriteria;\n  onSearchCriteriaChanged: (criteria: SearchCriteria) => void;\n  zoomOptions?: ZoomOptions;\n  onZoom?: (scaleX: number, scaleY: number) => void;\n  isLeftPanelOpen?: boolean;\n  isRightPanelOpen?: boolean;\n  onWorkspaceEvent?: WorkspaceEventHandler;\n  elementsSearchPanel?: React.ReactElement<any>;\n}\n\nexport class WorkspaceMarkup extends React.Component<WorkspaceMarkupProps, {}> {\n  static childContextTypes = WorkspaceContextTypes;\n\n  element: HTMLElement;\n  paperArea: PaperArea;\n\n  private untilMouseUpClasses: string[] = [];\n  private readonly cancellation = new Cancellation();\n\n  getChildContext(): WorkspaceContextWrapper {\n    const { editor } = this.props;\n    const ontodiaWorkspace: WorkspaceContext = { editor, triggerWorkspaceEvent: this.triggerWorkspaceEvent };\n    return { ontodiaWorkspace };\n  }\n\n  private triggerWorkspaceEvent = (key: WorkspaceEventKey) => {\n    const { onWorkspaceEvent } = this.props;\n    if (onWorkspaceEvent) {\n      onWorkspaceEvent(key);\n    }\n  };\n\n  private addToolbarWidgetToPaper() {\n    const { hideToolbar, view, toolbar } = this.props;\n    if (!hideToolbar) {\n      view.setPaperWidget({\n        key: 'toolbar',\n        widget: <ToolbarWidget>{toolbar}</ToolbarWidget>,\n        attachment: WidgetAttachment.Viewport,\n      });\n    }\n  }\n\n  private onCreateInstance = async (classId: ElementTypeIri, position?: Vector) => {\n    const { editor, view, model, metadataApi } = this.props;\n    await forceNonReactExecutionContext();\n    const batch = model.history.startBatch();\n\n    const signal = this.cancellation.signal;\n    const elementModel = await CancellationToken.mapCancelledToNull(\n      signal,\n      metadataApi.generateNewElement([classId], signal)\n    );\n    if (elementModel === null) {\n      return;\n    }\n\n    const element = editor.createNewEntity({ elementModel, position });\n    if (position) {\n      const targetPosition = position;\n      element.setPosition(targetPosition);\n\n      view.performSyncUpdate();\n      centerElementToPosition(element, targetPosition);\n    }\n\n    batch.store();\n    editor.setSelection([element]);\n    editor.showEditEntityForm(element);\n  };\n\n  private getLeftPanelLayout(): WorkspaceLayoutNode {\n    const { view, editor, model, searchCriteria, onSearchCriteriaChanged } = this.props;\n    const classTree = (\n      <ClassTree\n        view={view}\n        editor={editor}\n        onClassSelected={(classId) => {\n          const elementType = model.createClass(classId);\n          onSearchCriteriaChanged({ elementType });\n        }}\n        onCreateInstance={this.onCreateInstance}\n      />\n    );\n    const instancesSearch = (\n      <InstancesSearch\n        view={view}\n        model={model}\n        criteria={searchCriteria || {}}\n        onCriteriaChanged={onSearchCriteriaChanged}\n      />\n    );\n    return {\n      type: WorkspaceLayoutType.Column,\n      children: [\n        {\n          id: 'classes',\n          type: WorkspaceLayoutType.Component,\n          content: classTree,\n          heading: 'Classes',\n        },\n        {\n          id: 'instances',\n          type: WorkspaceLayoutType.Component,\n          content: instancesSearch,\n          heading: 'Instances',\n        },\n      ],\n      defaultSize: 275,\n      defaultCollapsed: !this.props.isLeftPanelOpen,\n    };\n  }\n\n  private getRightPanelLayout(): WorkspaceLayoutNode {\n    const { view, editor, elementsSearchPanel } = this.props;\n    const rightPanel: WorkspaceLayoutNode = {\n      type: WorkspaceLayoutType.Column,\n      children: [\n        {\n          id: 'connections',\n          type: WorkspaceLayoutType.Component,\n          content: <LinkTypesToolbox view={view} editor={editor} />,\n          heading: 'Connections',\n        },\n      ],\n      defaultSize: 275,\n      defaultCollapsed: !this.props.isRightPanelOpen,\n    };\n    if (elementsSearchPanel) {\n      rightPanel.children = [\n        ...rightPanel.children,\n        {\n          id: 'search',\n          type: WorkspaceLayoutType.Component,\n          content: React.cloneElement(elementsSearchPanel, { view, editor }),\n          heading: 'Search in diagram',\n        },\n      ];\n    }\n    return rightPanel;\n  }\n\n  render() {\n    const paper: WorkspaceLayoutNode = {\n      id: 'paper',\n      type: WorkspaceLayoutType.Component,\n      content: (\n        <div className=\"ontodia__main-panel\" style={{ flex: '1 1 0px', width: '100%' }}>\n          <PaperArea\n            ref={(el) => (this.paperArea = el)}\n            view={this.props.view}\n            zoomOptions={this.props.zoomOptions}\n            hideScrollBars={this.props.hideScrollBars}\n            onDragDrop={this.onDropOnPaper}\n            onZoom={this.props.onZoom}\n          ></PaperArea>\n        </div>\n      ),\n    };\n    const workspaceLayout: WorkspaceLayoutNode = this.props.hidePanels\n      ? paper\n      : {\n          type: WorkspaceLayoutType.Row,\n          children: [this.getLeftPanelLayout(), paper, this.getRightPanelLayout()],\n        };\n    return (\n      <div ref={(e) => (this.element = e)} className=\"ontodia\">\n        <div className=\"ontodia__workspace\">\n          <WorkspaceLayout\n            layout={workspaceLayout}\n            _onStartResize={(direction) =>\n              this.untilMouseUp({\n                preventTextSelection: true,\n                verticalResizing: direction === 'vertical',\n                horizontalResizing: direction === 'horizontal',\n              })\n            }\n          />\n        </div>\n      </div>\n    );\n  }\n\n  componentDidMount() {\n    document.addEventListener('mouseup', this.onDocumentMouseUp);\n    this.addToolbarWidgetToPaper();\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('mouseup', this.onDocumentMouseUp);\n    this.cancellation.abort();\n  }\n\n  preventTextSelection() {\n    this.untilMouseUp({ preventTextSelection: true });\n  }\n\n  private untilMouseUp(params: {\n    preventTextSelection?: boolean;\n    horizontalResizing?: boolean;\n    verticalResizing?: boolean;\n  }) {\n    this.untilMouseUpClasses = [];\n    if (params.preventTextSelection) {\n      this.untilMouseUpClasses.push('ontodia--unselectable');\n    }\n    if (params.horizontalResizing) {\n      this.untilMouseUpClasses.push('ontodia--horizontal-resizing');\n    }\n    if (params.verticalResizing) {\n      this.untilMouseUpClasses.push('ontodia--vertical-resizing');\n    }\n\n    for (const className of this.untilMouseUpClasses) {\n      this.element.classList.add(className);\n    }\n  }\n\n  private onDocumentMouseUp = () => {\n    for (const className of this.untilMouseUpClasses) {\n      this.element.classList.remove(className);\n    }\n    this.untilMouseUpClasses = [];\n  };\n\n  private onDropOnPaper = (e: DragEvent, paperPosition: Vector) => {\n    e.preventDefault();\n\n    const event: DropOnPaperEvent = { dragEvent: e, paperPosition };\n    if (this.props.view._tryHandleDropOnPaper(event)) {\n      return;\n    }\n\n    const iris = tryParseDefaultDragAndDropData(e);\n    if (iris.length > 0) {\n      this.props.editor.onDragDrop(iris, paperPosition);\n    }\n  };\n}\n\nclass ToolbarWidget extends React.Component<{ children: JSX.Element }> {\n  render() {\n    return <div className=\"ontodia__toolbar-widget\">{this.props.children}</div>;\n  }\n}\n\nfunction forceNonReactExecutionContext(): Promise<void> {\n  // force non-React executing context to resolve forceUpdate() synchronously\n  return Promise.resolve();\n}\n\nfunction getViewportCenterInPaperCoords(paperArea: PaperArea): Vector {\n  const viewport = paperArea.getAreaMetrics();\n  return paperArea.clientToPaperCoords(viewport.clientWidth / 2, viewport.clientHeight / 2);\n}\n\nfunction centerElementToPosition(element: Element, center: Vector) {\n  const position = {\n    x: center.x - element.size.width / 2,\n    y: center.y - element.size.height / 2,\n  };\n  element.setPosition(position);\n}\n\nfunction tryParseDefaultDragAndDropData(e: DragEvent): ElementIri[] {\n  const tryGetIri = (type: string) => {\n    try {\n      const iriString = e.dataTransfer.getData(type);\n      if (!iriString) {\n        return undefined;\n      }\n      let iris: ElementIri[];\n      try {\n        iris = JSON.parse(iriString);\n      } catch (e) {\n        iris = [iriString as ElementIri];\n      }\n      return iris.length === 0 ? undefined : iris;\n    } catch (e) {\n      return undefined;\n    }\n  };\n\n  return (\n    tryGetIri('application/x-ontodia-elements') ||\n    tryGetIri('text/uri-list') ||\n    tryGetIri('text') || // Edge\n    []\n  );\n}\n","export { ClassTree, ClassTreeProps } from './classTree';\n","import * as React from 'react';\n\nimport { ElementTypeIri, ClassModel } from '../../data/model';\nimport { DataProvider } from '../../data/provider';\nimport { FatClassModel } from '../../diagram/elements';\nimport { Vector } from '../../diagram/geometry';\nimport { DiagramView } from '../../diagram/view';\nimport { EditorController } from '../../editor/editorController';\nimport { Cancellation, CancellationToken, Debouncer } from '../../viewUtils/async';\nimport { cloneMap } from '../../viewUtils/collections';\nimport { EventObserver } from '../../viewUtils/events';\nimport { HtmlSpinner } from '../../viewUtils/spinner';\nimport { ProgressBar, ProgressState } from '../../widgets/progressBar';\n\nimport { TreeNode } from './treeModel';\nimport { Forest } from './leaf';\n\nexport interface ClassTreeProps {\n  view: DiagramView;\n  editor: EditorController;\n  onClassSelected: (classId: ElementTypeIri) => void;\n  onCreateInstance: (classId: ElementTypeIri, position?: Vector) => void;\n}\n\nexport interface State {\n  refreshingState?: ProgressState;\n  roots?: ReadonlyArray<TreeNode>;\n  filteredRoots?: ReadonlyArray<TreeNode>;\n  requestedSearchText?: string;\n  appliedSearchText?: string;\n  selectedNode?: TreeNode;\n  constructibleClasses?: ReadonlyMap<ElementTypeIri, boolean>;\n  showOnlyConstructible?: boolean;\n}\n\nconst CLASS_NAME = 'ontodia-class-tree';\nconst MIN_TERM_LENGTH = 3;\n\nexport class ClassTree extends React.Component<ClassTreeProps, State> {\n  private readonly listener = new EventObserver();\n  private readonly delayedClassUpdate = new Debouncer();\n  private readonly delayedSearch = new Debouncer(200 /* ms */);\n  private classTree: ReadonlyArray<ClassModel> | undefined;\n  private dataProvider: DataProvider | undefined;\n\n  private loadClassesOperation = new Cancellation();\n  private refreshOperation = new Cancellation();\n\n  constructor(props: ClassTreeProps) {\n    super(props);\n    this.state = {\n      refreshingState: ProgressState.none,\n      roots: [],\n      filteredRoots: [],\n      requestedSearchText: '',\n      appliedSearchText: '',\n      constructibleClasses: new Map(),\n      showOnlyConstructible: false,\n    };\n  }\n\n  render() {\n    const { view, editor } = this.props;\n    const {\n      refreshingState,\n      requestedSearchText,\n      appliedSearchText,\n      filteredRoots,\n      selectedNode,\n      constructibleClasses,\n      showOnlyConstructible,\n    } = this.state;\n    const normalizedSearchText = normalizeSearchText(requestedSearchText);\n    // highlight search term only if actual tree is already filtered by current or previous term:\n    //  - this immediately highlights typed characters thus making it look more responsive,\n    //  - prevents expanding non-filtered tree (which can be too large) just to highlight the term\n    const searchText = appliedSearchText ? normalizedSearchText : undefined;\n\n    return (\n      <div className={CLASS_NAME}>\n        <div className={`${CLASS_NAME}__filter`}>\n          <div className={`${CLASS_NAME}__filter-group`}>\n            <input\n              type=\"text\"\n              className=\"search-input ontodia-form-control\"\n              placeholder=\"Search for...\"\n              value={this.state.requestedSearchText}\n              onChange={this.onSearchTextChange}\n            />\n            {editor.inAuthoringMode ? (\n              <label className={`${CLASS_NAME}__only-creatable`}>\n                <input type=\"checkbox\" checked={showOnlyConstructible} onChange={this.onShowOnlyCreatableChange} /> Show\n                only constructible\n              </label>\n            ) : null}\n          </div>\n        </div>\n        <ProgressBar state={refreshingState} />\n        {this.classTree ? (\n          <Forest\n            className={`${CLASS_NAME}__tree ontodia-scrollable`}\n            view={view}\n            nodes={filteredRoots}\n            searchText={searchText}\n            selectedNode={selectedNode}\n            onSelect={this.onSelectNode}\n            creatableClasses={constructibleClasses}\n            onClickCreate={this.onCreateInstance}\n            onDragCreate={this.onDragCreate}\n          />\n        ) : (\n          <div className={`${CLASS_NAME}__spinner`}>\n            <HtmlSpinner width={30} height={30} />\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  componentDidMount() {\n    const { view, editor } = this.props;\n    this.listener.listen(view.events, 'changeLanguage', () => this.refreshClassTree());\n    this.listener.listen(editor.model.events, 'loadingStart', () => {\n      this.initClassTree();\n    });\n    this.listener.listen(editor.model.events, 'classEvent', ({ data }) => {\n      if (data.changeLabel || data.changeCount) {\n        this.delayedClassUpdate.call(this.refreshClassTree);\n      }\n    });\n    this.initClassTree();\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n    this.delayedClassUpdate.dispose();\n    this.delayedSearch.dispose();\n    this.loadClassesOperation.abort();\n    this.refreshOperation.abort();\n  }\n\n  private async initClassTree() {\n    if (this.dataProvider !== this.props.editor.model.dataProvider) {\n      this.dataProvider = this.props.editor.model.dataProvider;\n      this.classTree = undefined;\n\n      const cancellation = new Cancellation();\n      this.loadClassesOperation.abort();\n      this.loadClassesOperation = cancellation;\n\n      const classes = await this.dataProvider.classTree();\n      if (cancellation.signal.aborted) {\n        return;\n      }\n      this.setClassTree(classes);\n    }\n    this.refreshClassTree();\n  }\n\n  private onSearchTextChange = (e: React.FormEvent<HTMLInputElement>) => {\n    const requestedSearchText = e.currentTarget.value;\n    this.setState({ requestedSearchText });\n    this.delayedSearch.call(this.performSearch);\n  };\n\n  private performSearch = () => {\n    const { requestedSearchText } = this.state;\n    const requested = normalizeSearchText(requestedSearchText);\n    if (requested === this.state.appliedSearchText) {\n      return;\n    }\n\n    const appliedSearchText = requested.length < MIN_TERM_LENGTH ? undefined : requested;\n    this.setState((state): State => applyFilters({ ...state, appliedSearchText }));\n  };\n\n  private onShowOnlyCreatableChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    this.setState((state): State => applyFilters({ ...state, showOnlyConstructible: !state.showOnlyConstructible }));\n  };\n\n  private onSelectNode = (node: TreeNode) => {\n    const { onClassSelected } = this.props;\n    this.setState({ selectedNode: node });\n    onClassSelected(node.model.id);\n  };\n\n  private onCreateInstance = (node: TreeNode) => {\n    const { onCreateInstance } = this.props;\n    onCreateInstance(node.model.id);\n  };\n\n  private onDragCreate = (node: TreeNode) => {\n    const { view, onCreateInstance } = this.props;\n    view.setHandlerForNextDropOnPaper((e) => {\n      onCreateInstance(node.model.id, e.paperPosition);\n    });\n  };\n\n  private refreshClassTree = () => {\n    const cancellation = new Cancellation();\n    const { editor } = this.props;\n    this.refreshOperation.abort();\n    this.refreshOperation = cancellation;\n\n    this.setState(\n      (state, props): State => {\n        if (!this.classTree) {\n          return { refreshingState: ProgressState.none };\n        }\n\n        let refreshingState = ProgressState.none;\n        if (editor.inAuthoringMode) {\n          const newIris = getNewClassIris(state.constructibleClasses, this.classTree);\n\n          if (newIris.size > 0) {\n            refreshingState = ProgressState.loading;\n            this.queryCreatableTypes(newIris, cancellation.signal);\n          }\n        }\n\n        const roots = createRoots(this.classTree, props.view);\n        return applyFilters({ ...state, roots: sortTree(roots), refreshingState });\n      }\n    );\n  };\n\n  private setClassTree(roots: ClassModel[]) {\n    const diagramModel = this.props.editor.model;\n    const visiting = new Set<ElementTypeIri>();\n    const reduceNonCycle = (acc: ClassModel[], model: ClassModel) => {\n      if (!visiting.has(model.id)) {\n        visiting.add(model.id);\n        const children = model.children.reduce(reduceNonCycle, []);\n        acc.push({ ...model, children });\n        visiting.delete(model.id);\n      }\n      return acc;\n    };\n    this.classTree = roots.reduce(reduceNonCycle, []);\n\n    const addClass = (model: ClassModel) => {\n      const existing = diagramModel.getClass(model.id);\n      if (!existing) {\n        const { id, label, count, children } = model;\n        const richClass = new FatClassModel({ id, label: label.values, count });\n        diagramModel.addClass(richClass);\n        children.forEach(addClass);\n      }\n    };\n    this.classTree.forEach(addClass);\n\n    this.refreshClassTree();\n  }\n\n  private async queryCreatableTypes(typeIris: Set<ElementTypeIri>, ct: CancellationToken) {\n    try {\n      const result = await CancellationToken.mapCancelledToNull(\n        ct,\n        this.props.editor.metadataApi.filterConstructibleTypes(typeIris, ct)\n      );\n      if (result === null) {\n        return;\n      }\n      this.setState(\n        (state): State => {\n          const constructibleClasses = cloneMap(state.constructibleClasses);\n          typeIris.forEach((type) => {\n            constructibleClasses.set(type, result.has(type));\n          });\n          return applyFilters({ ...state, constructibleClasses, refreshingState: ProgressState.completed });\n        }\n      );\n    } catch (err) {\n      // tslint:disable-next-line:no-console\n      console.error(err);\n      if (ct.aborted) {\n        return;\n      }\n      this.setState((state): State => applyFilters({ ...state, refreshingState: ProgressState.error }));\n    }\n  }\n}\n\nfunction createRoots(classTree: ReadonlyArray<ClassModel>, view: DiagramView) {\n  const mapClass = (model: ClassModel): TreeNode => {\n    const richClass = view.model.createClass(model.id);\n    return {\n      model: richClass,\n      label: view.formatLabel(richClass.label, richClass.id),\n      derived: model.children.map(mapClass),\n    };\n  };\n  return classTree.map(mapClass);\n}\n\nfunction getNewClassIris(existingClasses: ReadonlyMap<ElementTypeIri, boolean>, classTree: ReadonlyArray<ClassModel>) {\n  const classIris = new Set<ElementTypeIri>();\n  const visitClass = (model: ClassModel) => {\n    if (!existingClasses.has(model.id)) {\n      classIris.add(model.id);\n    }\n    model.children.forEach(visitClass);\n  };\n  classTree.forEach(visitClass);\n  return classIris;\n}\n\nfunction normalizeSearchText(text: string) {\n  return text.trim().toLowerCase();\n}\n\nfunction sortTree(roots: ReadonlyArray<TreeNode>): ReadonlyArray<TreeNode> {\n  function mapNodes(nodes: ReadonlyArray<TreeNode>): ReadonlyArray<TreeNode> {\n    if (nodes.length === 0) {\n      return nodes;\n    }\n    const mapped = nodes.map(mapNode);\n    mapped.sort(compareByLabel);\n    return mapped;\n  }\n  function mapNode(node: TreeNode): TreeNode {\n    return TreeNode.setDerived(node, mapNodes(node.derived));\n  }\n  function compareByLabel(left: TreeNode, right: TreeNode) {\n    return left.label.localeCompare(right.label);\n  }\n  return mapNodes(roots);\n}\n\nfunction applyFilters(state: State): State {\n  let filteredRoots = state.roots;\n  if (state.appliedSearchText) {\n    filteredRoots = filterByKeyword(filteredRoots, state.appliedSearchText);\n  }\n  if (state.showOnlyConstructible) {\n    filteredRoots = filterOnlyCreatable(filteredRoots, state.constructibleClasses);\n  }\n  return { ...state, filteredRoots };\n}\n\nfunction filterByKeyword(roots: ReadonlyArray<TreeNode>, searchText: string): ReadonlyArray<TreeNode> {\n  if (roots.length === 0) {\n    return roots;\n  }\n  function collectByKeyword(acc: TreeNode[], node: TreeNode) {\n    const derived = node.derived.reduce(collectByKeyword, []);\n    // keep parent if children is included or label contains keyword\n    if (derived.length > 0 || node.label.toLowerCase().indexOf(searchText) >= 0) {\n      acc.push(TreeNode.setDerived(node, derived));\n    }\n    return acc;\n  }\n  return roots.reduce(collectByKeyword, []);\n}\n\nfunction filterOnlyCreatable(\n  roots: ReadonlyArray<TreeNode>,\n  creatableClasses: ReadonlyMap<ElementTypeIri, boolean>\n): ReadonlyArray<TreeNode> {\n  function collectOnlyCreatable(acc: TreeNode[], node: TreeNode) {\n    const derived = node.derived.reduce(collectOnlyCreatable, []);\n    if (derived.length > 0 || creatableClasses.get(node.model.id)) {\n      acc.push(TreeNode.setDerived(node, derived));\n    }\n    return acc;\n  }\n  return roots.reduce(collectOnlyCreatable, []);\n}\n","import { FatClassModel } from '../../diagram/elements';\n\nexport interface TreeNode {\n  model: FatClassModel;\n  label: string;\n  derived: ReadonlyArray<TreeNode>;\n}\n\nexport const TreeNode = {\n  setDerived: (node: TreeNode, derived: ReadonlyArray<TreeNode>): TreeNode => ({ ...node, derived }),\n};\n","import * as React from 'react';\n\nimport { ElementTypeIri } from '../../data/model';\nimport { DiagramView } from '../../diagram/view';\nimport { highlightSubstring } from '../listElementView';\n\nimport { TreeNode } from './treeModel';\n\nconst EXPAND_ICON = require('../../../../images/tree/expand-toggle.svg').default;\nconst COLLAPSE_ICON = require('../../../../images/tree/collapse-toggle.svg').default;\nconst DEFAULT_LEAF_ICON = require('../../../../images/tree/leaf-default.svg').default;\nconst DEFAULT_PARENT_ICON = require('../../../../images/tree/leaf-folder.svg').default;\n\ninterface CommonProps {\n  view: DiagramView;\n  searchText?: string;\n  selectedNode?: TreeNode;\n  onSelect: (node: TreeNode) => void;\n  creatableClasses: ReadonlyMap<ElementTypeIri, boolean>;\n  onClickCreate: (node: TreeNode) => void;\n  onDragCreate: (node: TreeNode) => void;\n}\n\nexport interface LeafProps extends CommonProps {\n  node: TreeNode;\n}\n\ninterface State {\n  expanded?: boolean;\n}\n\nconst LEAF_CLASS = 'ontodia-class-leaf';\n\nexport class Leaf extends React.Component<LeafProps, State> {\n  constructor(props: LeafProps) {\n    super(props);\n    this.state = {\n      expanded: Boolean(this.props.searchText),\n    };\n  }\n\n  componentWillReceiveProps(nextProps: LeafProps) {\n    if (this.props.searchText !== nextProps.searchText) {\n      this.setState({\n        expanded: Boolean(nextProps.searchText),\n      });\n    }\n  }\n\n  render() {\n    const { node, ...otherProps } = this.props;\n    const { view, selectedNode, searchText, creatableClasses } = otherProps;\n    const { expanded } = this.state;\n\n    let toggleIcon: string | undefined;\n    if (node.derived.length > 0) {\n      toggleIcon = expanded ? COLLAPSE_ICON : EXPAND_ICON;\n    }\n\n    let { icon } = view.getTypeStyle([node.model.id]);\n    if (!icon) {\n      icon = node.derived.length === 0 ? DEFAULT_LEAF_ICON : DEFAULT_PARENT_ICON;\n    }\n\n    let bodyClass = `${LEAF_CLASS}__body`;\n    if (selectedNode && selectedNode.model === node.model) {\n      bodyClass += ` ${LEAF_CLASS}__body--selected`;\n    }\n\n    const label = highlightSubstring(node.label, searchText, { className: `${LEAF_CLASS}__highlighted-term` });\n\n    return (\n      <div className={LEAF_CLASS} role=\"tree-item\">\n        <div className={`${LEAF_CLASS}__row`}>\n          <div className={`${LEAF_CLASS}__toggle`} onClick={this.toggle} role=\"button\">\n            {toggleIcon ? <img className={`${LEAF_CLASS}__toggle-icon`} src={toggleIcon} /> : null}\n          </div>\n          <a className={bodyClass} href={node.model.id} onClick={this.onClick}>\n            <div className={`${LEAF_CLASS}__icon-container`}>\n              <img className={`${LEAF_CLASS}__icon`} src={icon} />\n            </div>\n            <span className={`${LEAF_CLASS}__label`}>{label}</span>\n            {node.model.count ? <span className={`${LEAF_CLASS}__count ontodia-badge`}>{node.model.count}</span> : null}\n          </a>\n          {creatableClasses.get(node.model.id) ? (\n            <div className={`${LEAF_CLASS}__create ontodia-btn-group ontodia-btn-group-xs`}>\n              <button\n                className=\"ontodia-btn ontodia-btn-default\"\n                title={'Click or drag to create new entity of this type'}\n                draggable={true}\n                onClick={this.onClickCreate}\n                onDragStart={this.onDragCreate}\n              >\n                +\n              </button>\n            </div>\n          ) : null}\n        </div>\n        {expanded && node.derived.length > 0 ? (\n          <Forest className={`${LEAF_CLASS}__children`} nodes={node.derived} {...otherProps} />\n        ) : null}\n      </div>\n    );\n  }\n\n  private onClick = (e: React.MouseEvent<{}>) => {\n    e.preventDefault();\n    const { node, onSelect } = this.props;\n    onSelect(node);\n  };\n\n  private toggle = () => {\n    this.setState((state): State => ({ expanded: !state.expanded }));\n  };\n\n  private onClickCreate = () => {\n    this.props.onClickCreate(this.props.node);\n  };\n\n  private onDragCreate = (e: React.DragEvent<any>) => {\n    // sets the drag data to support drag-n-drop in Firefox\n    // see https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/Drag_operations for more details\n    // IE supports only 'text' and 'URL' formats, see https://msdn.microsoft.com/en-us/ie/ms536744(v=vs.94)\n    e.dataTransfer.setData('text', '');\n\n    this.props.onDragCreate(this.props.node);\n  };\n}\n\nexport interface ForestProps extends CommonProps {\n  className?: string;\n  nodes: ReadonlyArray<TreeNode>;\n}\n\nexport class Forest extends React.Component<ForestProps, {}> {\n  render() {\n    const { nodes, className, ...otherProps } = this.props;\n    return (\n      <div className={className} role=\"tree\">\n        {nodes.map((node) => (\n          <Leaf key={`node-${node.model.id}`} node={node} {...otherProps} />\n        ))}\n      </div>\n    );\n  }\n}\n","export default __webpack_public_path__ + \"99c80b666605548c69d369d82b52aa5f.svg\";","export default __webpack_public_path__ + \"b433bf51d8ebd994a3541bfb50d80f40.svg\";","export default __webpack_public_path__ + \"50c3223c98643b7a0c36f492103b55ea.svg\";","export default __webpack_public_path__ + \"c7b15270f3d3c03a05a17a173732c951.svg\";","import * as React from 'react';\n\nimport { LinkCount } from '../data/model';\nimport { changeLinkTypeVisibility } from '../diagram/commands';\nimport { Element, FatLinkType } from '../diagram/elements';\nimport { CommandHistory } from '../diagram/history';\nimport { DiagramView } from '../diagram/view';\n\nimport { EditorController } from '../editor/editorController';\n\nimport { Debouncer } from '../viewUtils/async';\nimport { EventObserver } from '../viewUtils/events';\nimport { highlightSubstring } from '../widgets/listElementView';\nimport { ProgressBar, ProgressState } from '../widgets/progressBar';\n\ninterface LinkInToolBoxProps {\n  view: DiagramView;\n  link: FatLinkType;\n  count: number;\n  onPressFilter?: (type: FatLinkType) => void;\n  filterKey?: string;\n}\n\ntype LinkTypeVisibility = 'invisible' | 'withoutLabels' | 'allVisible';\n\nclass LinkInToolBox extends React.Component<LinkInToolBoxProps, {}> {\n  private onPressFilter = () => {\n    if (this.props.onPressFilter) {\n      this.props.onPressFilter(this.props.link);\n    }\n  };\n\n  private changeState = (state: LinkTypeVisibility) => {\n    const history = this.props.view.model.history;\n    changeLinkTypeState(history, state, [this.props.link]);\n  };\n\n  private isChecked = (stateName: LinkTypeVisibility): boolean => {\n    let curState: LinkTypeVisibility;\n    if (!this.props.link.visible) {\n      curState = 'invisible';\n    } else if (!this.props.link.showLabel) {\n      curState = 'withoutLabels';\n    } else {\n      curState = 'allVisible';\n    }\n    return stateName === curState;\n  };\n\n  private getText = () => {\n    const { link: linkType, view, filterKey } = this.props;\n    const fullText = view.formatLabel(linkType.label, linkType.id);\n    return highlightSubstring(fullText, filterKey);\n  };\n\n  render() {\n    const newIcon = this.props.link.isNew ? <span className=\"linkInToolBox__new-tag\">new</span> : '';\n    const countIcon = this.props.count > 0 ? <span className=\"ontodia-badge\">{this.props.count}</span> : '';\n    const badgeContainer =\n      newIcon || countIcon ? (\n        <div>\n          {newIcon}\n          {countIcon}\n        </div>\n      ) : (\n        ''\n      );\n\n    return (\n      <li data-linktypeid={this.props.link.id} className=\"ontodia-list-group-item linkInToolBox clearfix\">\n        <span className=\"ontodia-btn-group ontodia-btn-group-xs\" data-toggle=\"buttons\">\n          <label\n            className={'ontodia-btn ontodia-btn-default' + (this.isChecked('invisible') ? ' active' : '')}\n            id=\"invisible\"\n            title=\"Hide links and labels\"\n            onClick={() => this.changeState('invisible')}\n          >\n            <span className=\"fa fa-times\" aria-hidden=\"true\" />\n          </label>\n          <label\n            className={'ontodia-btn ontodia-btn-default' + (this.isChecked('withoutLabels') ? ' active' : '')}\n            id=\"withoutLabels\"\n            title=\"Show links without labels\"\n            onClick={() => this.changeState('withoutLabels')}\n          >\n            <span className=\"fa fa-arrows-h\" aria-hidden=\"true\" />\n          </label>\n          <label\n            className={'ontodia-btn ontodia-btn-default' + (this.isChecked('allVisible') ? ' active' : '')}\n            id=\"allVisible\"\n            title=\"Show links with labels\"\n            onClick={() => this.changeState('allVisible')}\n          >\n            <span className=\"fa fa-text-width\" aria-hidden=\"true\" />\n          </label>\n        </span>\n        <div className=\"link-title\">{this.getText()}</div>\n        {badgeContainer}\n        <div className=\"linkInToolBox__filter-button\" onClick={this.onPressFilter} />\n      </li>\n    );\n  }\n}\n\ninterface LinkTypesToolboxViewProps {\n  view: DiagramView;\n  links: ReadonlyArray<FatLinkType>;\n  countMap: { readonly [linkTypeId: string]: number };\n  selectedElement: Element;\n  dataState: ProgressState;\n  filterCallback: (type: FatLinkType) => void;\n}\n\nclass LinkTypesToolboxView extends React.Component<LinkTypesToolboxViewProps, { filterKey: string }> {\n  constructor(props: LinkTypesToolboxViewProps) {\n    super(props);\n    this.state = { filterKey: '' };\n  }\n\n  private compareLinks = (a: FatLinkType, b: FatLinkType) => {\n    const { view } = this.props;\n    const aText = view.formatLabel(a.label, a.id);\n    const bText = view.formatLabel(b.label, b.id);\n    return aText.localeCompare(bText);\n  };\n\n  private onChangeInput = (e: React.SyntheticEvent<HTMLInputElement>) => {\n    this.setState({ filterKey: e.currentTarget.value });\n  };\n\n  private onDropFilter = () => {\n    this.setState({ filterKey: '' });\n  };\n\n  private getLinks = () => {\n    const { view, links = [] } = this.props;\n    return links\n      .filter((linkType) => {\n        const text = view.formatLabel(linkType.label, linkType.id).toLowerCase();\n        return !this.state.filterKey || text.indexOf(this.state.filterKey.toLowerCase()) >= 0;\n      })\n      .sort(this.compareLinks);\n  };\n\n  private getViews = (links: FatLinkType[]) => {\n    const countMap = this.props.countMap || {};\n    const views: React.ReactElement<any>[] = [];\n    for (const link of links) {\n      views.push(\n        <LinkInToolBox\n          key={link.id}\n          view={this.props.view}\n          link={link}\n          onPressFilter={this.props.filterCallback}\n          count={countMap[link.id] || 0}\n          filterKey={this.state.filterKey}\n        />\n      );\n    }\n    return views;\n  };\n\n  render() {\n    const className = 'link-types-toolbox';\n    const { view, dataState, selectedElement } = this.props;\n    const history = view.model.history;\n\n    const links = this.getLinks();\n    const views = this.getViews(links);\n\n    let connectedTo: JSX.Element | null = null;\n    if (selectedElement) {\n      const selectedElementLabel = view.formatLabel(selectedElement.data.label.values, selectedElement.iri);\n      connectedTo = (\n        <h4 className=\"links-heading\" style={{ display: 'block' }}>\n          Connected to{'\\u00A0'}\n          <span>{selectedElementLabel}</span>\n        </h4>\n      );\n    }\n\n    let dropButton: JSX.Element | null = null;\n    if (this.state.filterKey) {\n      dropButton = (\n        <button type=\"button\" className={`${className}__clearSearch`} onClick={this.onDropFilter}>\n          <span className=\"fa fa-times\" aria-hidden=\"true\"></span>\n        </button>\n      );\n    }\n\n    return (\n      <div className={className}>\n        <div className={`${className}__heading`}>\n          <div className={`${className}__searching-box`}>\n            <input\n              className=\"search-input ontodia-form-control\"\n              type=\"text\"\n              value={this.state.filterKey}\n              onChange={this.onChangeInput}\n              placeholder=\"Search for...\"\n            />\n            {dropButton}\n          </div>\n          <div className={`${className}__switch-all`}>\n            <div className=\"ontodia-btn-group ontodia-btn-group-xs\">\n              <label\n                className=\"ontodia-btn ontodia-btn-default\"\n                title=\"Hide links and labels\"\n                onClick={() => changeLinkTypeState(history, 'invisible', links)}\n              >\n                <span className=\"fa fa-times\" aria-hidden=\"true\" />\n              </label>\n              <label\n                className=\"ontodia-btn ontodia-btn-default\"\n                title=\"Show links without labels\"\n                onClick={() => changeLinkTypeState(history, 'withoutLabels', links)}\n              >\n                <span className=\"fa fa-arrows-h\" aria-hidden=\"true\" />\n              </label>\n              <label\n                className=\"ontodia-btn ontodia-btn-default\"\n                title=\"Show links with labels\"\n                onClick={() => changeLinkTypeState(history, 'allVisible', links)}\n              >\n                <span className=\"fa fa-text-width\" aria-hidden=\"true\" />\n              </label>\n            </div>\n            <span>&nbsp;Switch all</span>\n          </div>\n        </div>\n        <ProgressBar state={dataState} />\n        <div className={`${className}__rest`}>\n          {connectedTo}\n          <div className=\"ontodia-scrollable\">\n            <ul className=\"ontodia-list-group connected-links\">{views}</ul>\n          </div>\n        </div>\n      </div>\n    );\n  }\n}\n\nexport interface LinkTypesToolboxProps {\n  view: DiagramView;\n  editor: EditorController;\n}\n\nexport interface LinkTypesToolboxState {\n  readonly dataState?: ProgressState;\n  readonly selectedElement?: Element;\n  readonly linksOfElement?: ReadonlyArray<FatLinkType>;\n  readonly countMap?: { readonly [linkTypeId: string]: number };\n}\n\nexport class LinkTypesToolbox extends React.Component<LinkTypesToolboxProps, LinkTypesToolboxState> {\n  private readonly listener = new EventObserver();\n  private readonly linkListener = new EventObserver();\n  private readonly debounceSelection = new Debouncer(50 /* ms */);\n\n  private currentRequest: { elementId: string } | undefined;\n\n  constructor(props: LinkTypesToolboxProps, context: any) {\n    super(props, context);\n\n    const { view, editor } = this.props;\n\n    this.listener.listen(view.events, 'changeLanguage', () => this.updateOnCurrentSelection());\n    this.listener.listen(editor.model.events, 'loadingSuccess', () => this.updateOnCurrentSelection());\n    this.listener.listen(editor.events, 'changeSelection', () => {\n      this.debounceSelection.call(this.updateOnCurrentSelection);\n    });\n\n    this.state = { dataState: ProgressState.none };\n  }\n\n  componentDidMount() {\n    this.updateOnCurrentSelection();\n  }\n\n  componentWillUnmount() {\n    this.listener.stopListening();\n    this.linkListener.stopListening();\n    this.debounceSelection.dispose();\n  }\n\n  private updateOnCurrentSelection = () => {\n    const { editor } = this.props;\n    const single = editor.selection.length === 1 ? editor.selection[0] : null;\n    if (single !== this.state.selectedElement && single instanceof Element) {\n      this.requestLinksOf(single);\n    }\n  };\n\n  private requestLinksOf(selectedElement: Element) {\n    if (selectedElement) {\n      const request = { elementId: selectedElement.iri };\n      this.currentRequest = request;\n      this.setState({ dataState: ProgressState.loading, selectedElement });\n      this.props.editor.model.dataProvider\n        .linkTypesOf(request)\n        .then((linkTypes) => {\n          if (this.currentRequest !== request) {\n            return;\n          }\n          const { linksOfElement, countMap } = this.computeStateFromRequestResult(linkTypes);\n          this.subscribeOnLinksEvents(linksOfElement);\n          this.setState({ dataState: ProgressState.completed, linksOfElement, countMap });\n        })\n        .catch((error) => {\n          if (this.currentRequest !== request) {\n            return;\n          }\n          // tslint:disable-next-line:no-console\n          console.error(error);\n          this.setState({ dataState: ProgressState.error, linksOfElement: undefined, countMap: {} });\n        });\n    } else {\n      this.currentRequest = null;\n      this.setState({\n        dataState: ProgressState.completed,\n        selectedElement,\n        linksOfElement: undefined,\n        countMap: {},\n      });\n    }\n  }\n\n  private computeStateFromRequestResult(linkTypes: ReadonlyArray<LinkCount>) {\n    const linksOfElement: FatLinkType[] = [];\n    const countMap: { [linkTypeId: string]: number } = {};\n\n    const model = this.props.editor.model;\n    for (const linkType of linkTypes) {\n      const type = model.createLinkType(linkType.id);\n      linksOfElement.push(type);\n      countMap[linkType.id] = linkType.inCount + linkType.outCount;\n    }\n\n    return { linksOfElement, countMap };\n  }\n\n  private subscribeOnLinksEvents(linksOfElement: FatLinkType[]) {\n    this.linkListener.stopListening();\n\n    const listener = this.linkListener;\n    for (const link of linksOfElement) {\n      listener.listen(link.events, 'changeLabel', this.onLinkChanged);\n      listener.listen(link.events, 'changeVisibility', this.onLinkChanged);\n    }\n  }\n\n  private onLinkChanged = () => {\n    this.forceUpdate();\n  };\n\n  render() {\n    const { view } = this.props;\n    const { selectedElement, dataState, linksOfElement, countMap } = this.state;\n    return (\n      <LinkTypesToolboxView\n        view={view}\n        dataState={dataState}\n        links={linksOfElement}\n        countMap={countMap}\n        filterCallback={this.onAddToFilter}\n        selectedElement={selectedElement}\n      />\n    );\n  }\n\n  private onAddToFilter = (linkType: FatLinkType) => {\n    const { selectedElement } = this.state;\n    selectedElement.addToFilter(linkType);\n  };\n}\n\nfunction changeLinkTypeState(history: CommandHistory, state: LinkTypeVisibility, links: ReadonlyArray<FatLinkType>) {\n  const batch = history.startBatch();\n  const { visible, showLabel } =\n    state === 'invisible'\n      ? { visible: false, showLabel: false }\n      : state === 'withoutLabels'\n      ? { visible: true, showLabel: false }\n      : state === 'allVisible'\n      ? { visible: true, showLabel: true }\n      : undefined;\n  for (const linkType of links) {\n    history.execute(changeLinkTypeVisibility({ linkType, visible, showLabel }));\n  }\n  batch.store();\n}\n","import * as React from 'react';\n\nimport { AccordionItem, Props as ItemProps } from './accordionItem';\n\nexport interface Props {\n  onStartResize?: (direction: 'vertical' | 'horizontal') => void;\n  onResize?: (direction: 'vertical' | 'horizontal') => void;\n  /** AccordionItem[] */\n  children?: React.ReactElement<ItemProps> | ReadonlyArray<React.ReactElement<ItemProps>>;\n  direction?: 'vertical' | 'horizontal';\n  animationDuration?: number;\n}\n\nexport interface DefaultProps {\n  defaultSize?: number;\n  defaultCollapsed?: boolean;\n  collapsedSize?: number;\n  minSize?: number;\n}\n\nexport interface State {\n  /**\n   * Items' sizes in pixels.\n   * Undefined until first resize or toggle initiated by user.\n   */\n  readonly sizes?: number[];\n  /**\n   * Items' sizes in percent.\n   */\n  readonly percents?: string[];\n  /**\n   * Per-item collapsed state: true if corresponding item is collapsed;\n   * otherwise false.\n   */\n  readonly collapsed?: boolean[];\n  readonly resizing?: boolean;\n}\n\nconst CLASS_NAME = 'ontodia-accordion';\n\nexport class Accordion extends React.Component<Props, State> {\n  static defaultProps: Partial<Props> = {\n    direction: 'vertical',\n    animationDuration: 300,\n  };\n\n  private element: HTMLDivElement;\n\n  private items: AccordionItem[] = [];\n  private originSizes: ReadonlyArray<number>;\n  private originCollapsed: ReadonlyArray<boolean>;\n  private originTotalSize: number;\n\n  private defaultProps?: ReadonlyMap<number, DefaultProps>;\n\n  private isScrollable = false;\n\n  constructor(props: Props) {\n    super(props);\n    const childCount = React.Children.count(this.props.children);\n    this.state = {\n      collapsed: [],\n      resizing: false,\n      percents: React.Children.map(this.props.children, () => `${100 / childCount}%`),\n    };\n  }\n\n  componentDidMount() {\n    this.updateSizes();\n  }\n\n  componentDidUpdate(prevProps: Props, prevState: State) {\n    const { direction, children, onResize, animationDuration } = this.props;\n    if (React.Children.count(children) !== React.Children.count(prevProps.children)) {\n      this.updateSizes();\n    }\n    const { sizes, resizing } = this.state;\n    if (sizes !== prevState.sizes && onResize) {\n      if (resizing) {\n        onResize(direction);\n      } else {\n        // triggers the callback after finishing CSS animation\n        setTimeout(() => onResize(direction), animationDuration);\n      }\n    }\n  }\n\n  private get isVertical() {\n    return this.props.direction === 'vertical';\n  }\n\n  private clientSize(element: HTMLElement) {\n    const { clientWidth, clientHeight } = element;\n    return this.isVertical ? clientHeight : clientWidth;\n  }\n\n  private offsetSize(element: HTMLElement) {\n    const { offsetWidth, offsetHeight } = element;\n    return this.isVertical ? offsetHeight : offsetWidth;\n  }\n\n  private updateSizes = () => {\n    const { children } = this.props;\n    const defaultProps = new Map<number, DefaultProps>();\n    React.Children.forEach(children, (child, index) => {\n      if (typeof child !== 'object') {\n        return;\n      }\n      const { defaultSize, defaultCollapsed, collapsedSize, minSize } = (child as React.ReactElement).props;\n      // enables the scrollbar in the accordion if at least one item has min size\n      if (minSize !== undefined) {\n        this.isScrollable = true;\n      }\n      defaultProps.set(index, { defaultSize, defaultCollapsed, collapsedSize, minSize });\n    });\n    this.defaultProps = defaultProps;\n    this.setState(\n      ({ collapsed }): State => {\n        const totalSize = this.clientSize(this.element.parentElement);\n        let leftSize = totalSize;\n        let leftChildCount = React.Children.count(children);\n        const newCollapsed: Array<boolean> = [];\n        this.defaultProps.forEach(({ defaultSize, defaultCollapsed = false }, index) => {\n          // preserves items collapsed by user\n          let itemCollapsed = collapsed[index] === undefined ? defaultCollapsed : collapsed[index];\n          // if no expanded items, expands the last one\n          const isLastItem = index === this.defaultProps.size - 1;\n          const noExpandedItems = newCollapsed.findIndex((c) => !c) < 0;\n          if (isLastItem && noExpandedItems) {\n            itemCollapsed = false;\n          }\n          const size = itemCollapsed ? this.sizeWhenCollapsed(index) : defaultSize;\n          if (size) {\n            leftSize = leftSize - size;\n            leftChildCount = leftChildCount - 1;\n          }\n          newCollapsed.push(itemCollapsed);\n        });\n        const newSizes: Array<number> = [];\n        const newPercents: Array<string> = [];\n        this.defaultProps.forEach(({ defaultSize, minSize }, index) => {\n          let size = leftSize / leftChildCount;\n          const collapsedSize = this.sizeWhenCollapsed(index);\n          if (newCollapsed[index]) {\n            size = collapsedSize;\n          } else if (defaultSize !== undefined) {\n            size = defaultSize;\n          } else if (size < minSize) {\n            size = collapsedSize + minSize;\n          }\n          if (size < collapsedSize) {\n            size = collapsedSize;\n            newCollapsed[index] = true;\n          }\n          const percent = `${(100 * size) / totalSize}%`;\n          newSizes.push(size);\n          newPercents.push(percent);\n        });\n        return {\n          sizes: newSizes,\n          percents: newPercents,\n          collapsed: newCollapsed,\n        };\n      }\n    );\n  };\n\n  render() {\n    const { direction } = this.props;\n    const { resizing } = this.state;\n    const resizingClassName = resizing ? `${CLASS_NAME}--resizing` : '';\n    const scrollableClassName = this.isScrollable ? `${CLASS_NAME}--scrollable` : '';\n    return (\n      <div\n        className={`${CLASS_NAME} ${CLASS_NAME}--${direction} ${resizingClassName} ${scrollableClassName}`}\n        ref={(element) => (this.element = element)}\n      >\n        {this.renderItems()}\n      </div>\n    );\n  }\n\n  private renderItems() {\n    const { sizes, percents, collapsed } = this.state;\n    const { children, direction } = this.props;\n\n    return React.Children.map(children, (child, index) => {\n      if (typeof child !== 'object') {\n        throw new Error('Accordion should have only AccordionItem elements as children');\n      }\n      const lastChild = index === React.Children.count(children) - 1;\n      const size = collapsed[index] ? sizes[index] : percents[index];\n\n      const additionalProps: Partial<ItemProps> & React.Props<AccordionItem> = {\n        ref: (element) => (this.items[index] = element),\n        collapsed: collapsed[index],\n        size,\n        direction,\n        onChangeCollapsed: (itemCollapsed) => this.onItemChangeCollapsed({ itemIndex: index, itemCollapsed }),\n        onBeginDragHandle: lastChild ? undefined : () => this.onBeginDragHandle(index),\n        onDragHandle: lastChild ? undefined : (dx, dy) => this.onDragHandle(index, dx, dy),\n        onEndDragHandle: this.onEndDragHandle,\n      };\n      return React.cloneElement(child as React.ReactElement, additionalProps);\n    });\n  }\n\n  private onBeginDragHandle = (itemIndex: number) => {\n    this.originTotalSize = this.clientSize(this.element);\n    this.originSizes = this.computeEffectiveItemSizes();\n    this.originCollapsed = [...this.state.collapsed];\n    this.setState({ resizing: true }, () => {\n      const { direction, onStartResize } = this.props;\n      if (onStartResize) {\n        onStartResize(direction);\n      }\n    });\n  };\n\n  private onEndDragHandle = () => {\n    this.setState({ resizing: false });\n  };\n\n  private computeEffectiveItemSizes(): number[] {\n    const sizes: Array<number> = [];\n    this.items.forEach((item, index) => {\n      if (!item) {\n        return;\n      }\n      if (this.state.collapsed[index]) {\n        const collapsedSize = this.sizeWhenCollapsed(index);\n        sizes.push(collapsedSize);\n      } else {\n        sizes.push(this.offsetSize(item.element));\n      }\n    });\n    return sizes;\n  }\n\n  private sizeWhenCollapsed = (index: number) => {\n    const item = this.items[index];\n    const { collapsedSize } = this.defaultProps.get(index);\n    if (collapsedSize !== undefined) {\n      return collapsedSize;\n    }\n    const headerSize = item.header ? this.clientSize(item.header) : 0;\n    return headerSize + (this.offsetSize(item.element) - this.clientSize(item.element));\n  };\n\n  private onDragHandle = (itemIndex: number, dx: number, dy: number) => {\n    const sizes = [...this.originSizes];\n    const collapsed = [...this.originCollapsed];\n\n    new SizeDistributor(sizes, collapsed, this.originTotalSize, this.sizeWhenCollapsed).distribute(\n      itemIndex + 1,\n      this.isVertical ? dy : dx\n    );\n\n    const percents = sizes.map((size) => `${(100 * size) / this.originTotalSize}%`);\n\n    this.setState({ sizes, percents, collapsed });\n  };\n\n  private onItemChangeCollapsed({ itemIndex, itemCollapsed }: { itemIndex: number; itemCollapsed: boolean }) {\n    const totalSize = this.clientSize(this.element);\n    const sizes = this.computeEffectiveItemSizes();\n\n    if (sizes.length === 1) {\n      return;\n    }\n\n    const collapsed = [...this.state.collapsed];\n\n    const effectiveSize = sizes[itemIndex];\n\n    const collapsedSize = this.sizeWhenCollapsed(itemIndex);\n    const distributor = new SizeDistributor(sizes, collapsed, totalSize, this.sizeWhenCollapsed);\n\n    if (itemCollapsed) {\n      const splitShift = Math.max(effectiveSize - collapsedSize, 0);\n      sizes[itemIndex] = collapsedSize;\n      if (itemIndex === sizes.length - 1) {\n        distributor.expand(splitShift, itemIndex - 1);\n      } else {\n        distributor.expand(splitShift, itemIndex + 1);\n      }\n    } else {\n      const { defaultSize, minSize } = this.defaultProps.get(itemIndex);\n      const shift = (defaultSize || totalSize / sizes.length) - collapsedSize;\n      let freeSize = 0;\n      if (itemIndex === sizes.length - 1) {\n        freeSize = distributor.collapseForward({ shift, from: itemIndex - 1, to: itemIndex });\n      } else {\n        freeSize = distributor.collapseForward({ shift, from: itemIndex + 1, to: sizes.length });\n      }\n      freeSize = Math.max(freeSize, distributor.leftoverSize());\n      if (freeSize < shift) {\n        freeSize += distributor.collapseForward({ shift: shift - freeSize, from: 0, to: itemIndex });\n      }\n      if (freeSize < minSize) {\n        freeSize = minSize;\n      }\n      sizes[itemIndex] = Math.round(collapsedSize + freeSize);\n    }\n\n    collapsed[itemIndex] = itemCollapsed;\n\n    const percents = sizes.map((size) => `${(100 * size) / totalSize}%`);\n\n    this.setState({ sizes, percents, collapsed });\n  }\n}\n\nclass SizeDistributor {\n  constructor(\n    readonly sizes: number[],\n    readonly collapsed: boolean[],\n    readonly totalSize: number,\n    readonly sizeWhenCollapsed: (index: number) => number\n  ) {}\n\n  distribute(splitIndex: number, splitShift: number) {\n    if (splitShift > 0) {\n      let freeSize = this.collapseForward({ shift: splitShift, from: splitIndex, to: this.sizes.length });\n      freeSize = Math.max(freeSize, this.leftoverSize());\n      this.expand(freeSize, splitIndex - 1);\n    } else {\n      let freeSize = this.collapseBackward({ shift: -splitShift, from: 0, to: splitIndex });\n      freeSize = Math.max(freeSize, this.leftoverSize());\n      this.expand(freeSize, splitIndex);\n    }\n  }\n\n  collapseForward({ shift, from, to }: { shift: number; from: number; to: number }) {\n    if (shift <= 0) {\n      return 0;\n    }\n    let shiftLeft = shift;\n    for (let i = from; i < to; i++) {\n      shiftLeft = this.collapse(shiftLeft, i);\n    }\n    return shift - shiftLeft;\n  }\n\n  collapseBackward({ shift, from, to }: { shift: number; from: number; to: number }) {\n    if (shift <= 0) {\n      return 0;\n    }\n    let shiftLeft = shift;\n    for (let i = to - 1; i >= from; i--) {\n      shiftLeft = this.collapse(shiftLeft, i);\n    }\n    return shift - shiftLeft;\n  }\n\n  private collapse(shift: number, index: number) {\n    if (this.collapsed[index]) {\n      return shift;\n    }\n    const size = this.sizes[index];\n    const collapsedSize = this.sizeWhenCollapsed(index);\n    const newSize = Math.round(Math.max(size - shift, collapsedSize));\n    this.sizes[index] = newSize;\n    this.collapsed[index] = newSize <= collapsedSize;\n    return shift - (size - newSize);\n  }\n\n  expand(shift: number, index: number) {\n    if (shift <= 0) {\n      return 0;\n    }\n    const oldSize = this.sizes[index];\n    const newSize = Math.round(oldSize + shift);\n    this.sizes[index] = newSize;\n    this.collapsed[index] = newSize <= this.sizeWhenCollapsed(index);\n    return newSize - oldSize;\n  }\n\n  leftoverSize() {\n    const sizeSum = this.sizes.reduce((sum, size) => sum + size, 0);\n    return Math.max(this.totalSize - sizeSum, 0);\n  }\n}\n","import * as React from 'react';\n\nimport { DraggableHandle } from './draggableHandle';\n\nexport enum DockSide {\n  Left = 1,\n  Right,\n}\n\nexport interface Props {\n  heading?: React.ReactNode;\n  bodyClassName?: string;\n  className?: string;\n  bodyRef?: (body: HTMLDivElement) => void;\n  children?: React.ReactNode;\n  defaultSize?: number;\n  defaultCollapsed?: boolean;\n  collapsedSize?: number;\n  minSize?: number;\n\n  // props provided by Accordion\n  collapsed?: boolean;\n  size?: number | string;\n  direction?: 'vertical' | 'horizontal';\n  dockSide?: DockSide;\n  onChangeCollapsed?: (collapsed: boolean) => void;\n  onBeginDragHandle?: () => void;\n  onDragHandle?: (dx: number, dy: number) => void;\n  onEndDragHandle?: () => void;\n}\n\nconst CLASS_NAME = 'ontodia-accordion-item';\n\nexport interface State {\n  resizing?: boolean;\n}\n\nexport class AccordionItem extends React.Component<Props, State> {\n  static defaultProps: Partial<Props> = {\n    direction: 'vertical',\n  };\n\n  private _element: HTMLDivElement;\n  private _header: HTMLDivElement;\n\n  constructor(props: Props) {\n    super(props);\n    this.state = {\n      resizing: false,\n    };\n  }\n\n  get element() {\n    return this._element;\n  }\n  get header() {\n    return this._header;\n  }\n\n  private get isVertical() {\n    return this.props.direction === 'vertical';\n  }\n\n  private renderToggleButton() {\n    const { collapsed, dockSide, onChangeCollapsed } = this.props;\n    if (!dockSide) {\n      return null;\n    }\n    const side = dockSide === DockSide.Left ? 'left' : 'right';\n    return (\n      <div\n        className={`${CLASS_NAME}__handle-btn ${CLASS_NAME}__handle-btn-${side}`}\n        onClick={() => onChangeCollapsed(!collapsed)}\n      />\n    );\n  }\n\n  render() {\n    const {\n      heading,\n      bodyClassName,\n      children,\n      bodyRef,\n      collapsed,\n      size,\n      direction,\n      onBeginDragHandle,\n      onDragHandle,\n      onEndDragHandle,\n      dockSide,\n      className = '',\n    } = this.props;\n    const { resizing } = this.state;\n    const shouldRenderHandle = onBeginDragHandle && onDragHandle && onEndDragHandle;\n    const style: React.CSSProperties = this.isVertical ? { height: size } : { width: size };\n\n    // unmount child component when the accordion item is collapsed and has dockSide\n    const isMounted = !(collapsed && dockSide);\n\n    return (\n      <div\n        className={`${CLASS_NAME} ${CLASS_NAME}--${collapsed ? 'collapsed' : 'expanded'} ${CLASS_NAME}--${direction}\n                ${resizing ? `${CLASS_NAME}--resizing` : ''}`}\n        ref={(element) => (this._element = element)}\n        style={style}\n      >\n        <div className={`${CLASS_NAME}__inner ${className}`}>\n          {heading ? (\n            <div\n              className={`${CLASS_NAME}__header`}\n              ref={(header) => (this._header = header)}\n              onClick={() => this.props.onChangeCollapsed(!collapsed)}\n            >\n              {heading}\n            </div>\n          ) : null}\n          <div className={`${CLASS_NAME}__body`}>\n            {children && isMounted ? children : <div ref={bodyRef} className={`${bodyClassName || ''}`} />}\n          </div>\n        </div>\n        {shouldRenderHandle ? (\n          <DraggableHandle\n            className={`${CLASS_NAME}__handle ${CLASS_NAME}__handle-${direction}`}\n            onBeginDragHandle={(e) => {\n              this.setState({ resizing: true });\n              onBeginDragHandle();\n            }}\n            onDragHandle={(e, x, y) => onDragHandle(x, y)}\n            onEndDragHandle={(e) => {\n              this.setState({ resizing: false });\n              onEndDragHandle();\n            }}\n          />\n        ) : null}\n        {this.renderToggleButton()}\n      </div>\n    );\n  }\n}\n","export { LINK_SHOW_IRI } from './customization/defaultLinkStyles';\n\nexport { TemplateProperties } from './data/schema';\n\nexport * from './diagram/paper';\nexport * from './diagram/paperArea';\n\nexport * from './viewUtils/async';\nexport * from './viewUtils/collections';\nexport * from './viewUtils/keyedObserver';\nexport * from './viewUtils/spinner';\n\nexport * from './widgets/listElementView';\nexport * from './widgets/searchResults';\n\nexport { WorkspaceContext, WorkspaceContextWrapper, WorkspaceContextTypes } from './workspace/workspaceContext';\n\nexport {\n  groupForceLayout,\n  groupRemoveOverlaps,\n  padded,\n  biasFreePadded,\n  getContentFittingBoxForLayout,\n} from './viewUtils/layout';\n"],"sourceRoot":""}